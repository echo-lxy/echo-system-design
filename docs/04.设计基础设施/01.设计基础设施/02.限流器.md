---
title: 限流器
date: 2024-09-14 02:09:39
permalink: /pages/57d5a5/
---

## 概述

![img](https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409141642628.png)

- **我们需要编写一个可扩展以处理高负载的软件吗？**
- **负载均衡器中已经实现了最大连接数和服务端点上的最大线程数呢。我们还需要节流吗？**

- - 这种机制是不加区别的，有些操作快，有些操作慢，负载均衡器不了解每个操作的成本，如果我们想对某个操作实现特定的限流，负载均衡器就不好使了

- **我们如何单独控制每个主机呢？**

- - 主机间相互通信！

## 需求

**功能性**

- allowRequest(request)

**非功能性**

- 低延迟（尽快做出决定）
- 准确性（尽可能准确）
- 可扩展（支持集群中任意数量的主机）
- 高可用
- 高可靠

## 前置知识

- 令牌桶算法
- 速率限制解决方案的面向对象设计
- 负载均衡器最大连接数，自动扩展
- 消息广播：全网状网络拓扑、gossip 通信、分布式缓存、协调服务
- 通信协议：TCP、UDP
- 嵌入式速率限制器与守护进程
- 存储桶管理、同步

## 组件架构

![img](https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409141642790.png)

## 接口和类

![img](https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409141642812.png)

## 消息广播

![img](https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409141642594.png)



## 如何集成

![img](https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409141642704.png)

## 答疑解惑

- **我的服务非常受欢迎，有数百万用户。这是否意味着内存中存储了数百万个桶？**

- - 可以瞬间增加很多桶，但是当桶没用的时候，可以删除桶

- **有哪些失败的场景？**

- - 守护线程失败
  - 网络分区，无法传播消息，每个主机将允许更多的请求

- **我们是否需要一个自动配置管理服务？**
- **我有点担心同步问题。这不是瓶颈吗？**

- - 原则上来说 我们要重视并发安全
  - 但是我们没有必要实现，会对性能造成影响

- **当客户的请求被拒绝时，他们应该做什么？**

- - 重试（指数退避、抖动）

## 总结

![img](https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409141642651.png)
