<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>KafkaConsumer ç±»ä»£ç åˆ†æ | EchoDesign</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="ç³»ç»Ÿè®¾è®¡ä¹‹ã€Œæ•™å­¦ + é¢è¯•æŒ‡å—ã€ä¼ æ’­ç³»ç»Ÿè®¾è®¡ä¹‹ç¾">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.d5131fc0.css" as="style"><link rel="preload" href="/assets/js/app.a56e5838.js" as="script"><link rel="preload" href="/assets/js/2.933750c6.js" as="script"><link rel="preload" href="/assets/js/26.96f3c12e.js" as="script"><link rel="preload" href="/assets/js/7.7eb70372.js" as="script"><link rel="prefetch" href="/assets/js/10.7b3b5100.js"><link rel="prefetch" href="/assets/js/11.71fe9642.js"><link rel="prefetch" href="/assets/js/12.c0ea1b08.js"><link rel="prefetch" href="/assets/js/13.d9d26d25.js"><link rel="prefetch" href="/assets/js/14.49edf693.js"><link rel="prefetch" href="/assets/js/15.b3c76984.js"><link rel="prefetch" href="/assets/js/16.831e5a24.js"><link rel="prefetch" href="/assets/js/17.acb3bf3d.js"><link rel="prefetch" href="/assets/js/18.e491edb6.js"><link rel="prefetch" href="/assets/js/19.daf31819.js"><link rel="prefetch" href="/assets/js/20.cb4a5c13.js"><link rel="prefetch" href="/assets/js/21.24c0f101.js"><link rel="prefetch" href="/assets/js/22.1ccaa6f3.js"><link rel="prefetch" href="/assets/js/23.623f0b5d.js"><link rel="prefetch" href="/assets/js/24.615412d4.js"><link rel="prefetch" href="/assets/js/25.1d172890.js"><link rel="prefetch" href="/assets/js/27.90323e82.js"><link rel="prefetch" href="/assets/js/28.d4ca2c30.js"><link rel="prefetch" href="/assets/js/29.7325b5ce.js"><link rel="prefetch" href="/assets/js/3.d0e8ba67.js"><link rel="prefetch" href="/assets/js/30.892b2994.js"><link rel="prefetch" href="/assets/js/31.a532917f.js"><link rel="prefetch" href="/assets/js/32.13b70e91.js"><link rel="prefetch" href="/assets/js/33.64ab8d0c.js"><link rel="prefetch" href="/assets/js/34.6d3cc288.js"><link rel="prefetch" href="/assets/js/35.98e20e9a.js"><link rel="prefetch" href="/assets/js/36.be98cc35.js"><link rel="prefetch" href="/assets/js/37.58f66be7.js"><link rel="prefetch" href="/assets/js/38.859eef17.js"><link rel="prefetch" href="/assets/js/39.6068f14a.js"><link rel="prefetch" href="/assets/js/4.73518a0f.js"><link rel="prefetch" href="/assets/js/40.ed269b47.js"><link rel="prefetch" href="/assets/js/41.0c4f654a.js"><link rel="prefetch" href="/assets/js/42.4ded3b10.js"><link rel="prefetch" href="/assets/js/43.5b535f7c.js"><link rel="prefetch" href="/assets/js/44.2a3a944a.js"><link rel="prefetch" href="/assets/js/45.1eb9e05b.js"><link rel="prefetch" href="/assets/js/46.e45aa14c.js"><link rel="prefetch" href="/assets/js/47.34f7c00f.js"><link rel="prefetch" href="/assets/js/48.350cdd27.js"><link rel="prefetch" href="/assets/js/49.05978612.js"><link rel="prefetch" href="/assets/js/5.0b7cfb1d.js"><link rel="prefetch" href="/assets/js/50.f9eab72f.js"><link rel="prefetch" href="/assets/js/51.68dc59e8.js"><link rel="prefetch" href="/assets/js/52.16980f1d.js"><link rel="prefetch" href="/assets/js/53.ab2d07fb.js"><link rel="prefetch" href="/assets/js/54.169a9713.js"><link rel="prefetch" href="/assets/js/55.022cf036.js"><link rel="prefetch" href="/assets/js/56.0756fe1d.js"><link rel="prefetch" href="/assets/js/57.a7a66fe4.js"><link rel="prefetch" href="/assets/js/58.0ab0b71f.js"><link rel="prefetch" href="/assets/js/59.476cfa38.js"><link rel="prefetch" href="/assets/js/6.0b558b79.js"><link rel="prefetch" href="/assets/js/60.4e9d2e27.js"><link rel="prefetch" href="/assets/js/61.0ffe912e.js"><link rel="prefetch" href="/assets/js/62.fb8b1ab9.js"><link rel="prefetch" href="/assets/js/63.fcfcf4c7.js"><link rel="prefetch" href="/assets/js/64.99818643.js"><link rel="prefetch" href="/assets/js/65.7ec46cc9.js"><link rel="prefetch" href="/assets/js/66.c3984fa4.js"><link rel="prefetch" href="/assets/js/67.8a83d3de.js"><link rel="prefetch" href="/assets/js/68.3357e4bc.js"><link rel="prefetch" href="/assets/js/69.b6848fcb.js"><link rel="prefetch" href="/assets/js/70.d605ae12.js"><link rel="prefetch" href="/assets/js/71.3e2d318e.js"><link rel="prefetch" href="/assets/js/72.458f5d94.js"><link rel="prefetch" href="/assets/js/73.a818b940.js"><link rel="prefetch" href="/assets/js/74.3a61d42b.js"><link rel="prefetch" href="/assets/js/75.c116fbb7.js"><link rel="prefetch" href="/assets/js/76.697623dc.js"><link rel="prefetch" href="/assets/js/77.bc764a0e.js"><link rel="prefetch" href="/assets/js/78.eac3cb5e.js"><link rel="prefetch" href="/assets/js/79.0f3d5a29.js"><link rel="prefetch" href="/assets/js/8.0ec7f6e8.js"><link rel="prefetch" href="/assets/js/9.6e274fca.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d5131fc0.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="ç›®å½•" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="EchoDesign" class="logo"> <span class="site-name can-hide">EchoDesign</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">ğŸ é¦–é¡µ</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">âœ’ï¸çƒ­é—¨ç®—æ³•</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ğŸ–ï¸èµæç»å…¸è®¾è®¡" class="dropdown-title"><!----> <span class="title" style="display:;">ğŸ–ï¸èµæç»å…¸è®¾è®¡</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ç³»ç»Ÿè®¾è®¡</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ğŸ§‘â€ğŸ’»å®æˆ˜ç³»ç»Ÿè®¾è®¡</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">â“é—®ç­”</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ğŸ‘€åŠ¨æ€</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">ğŸ é¦–é¡µ</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">âœ’ï¸çƒ­é—¨ç®—æ³•</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ğŸ–ï¸èµæç»å…¸è®¾è®¡" class="dropdown-title"><!----> <span class="title" style="display:;">ğŸ–ï¸èµæç»å…¸è®¾è®¡</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ç³»ç»Ÿè®¾è®¡</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ğŸ§‘â€ğŸ’»å®æˆ˜ç³»ç»Ÿè®¾è®¡</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">â“é—®ç­”</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ğŸ‘€åŠ¨æ€</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ä¸€ã€å‰è¨€</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>ä¸‰ã€ä¸»çº¿ä»»åŠ¡</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/46a58a/" class="sidebar-link">Kafka æ•´ä½“æ¶æ„</a></li><li><a href="/pages/bb1005/" class="sidebar-link">ç”Ÿäº§è€…</a></li><li><a href="/pages/aa0392/" class="sidebar-link">Broker</a></li><li><a href="/pages/ca141b/" class="sidebar-link">æ¶ˆè´¹è€…</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>ã€Œç”Ÿäº§è€…ã€æºç åˆ†æ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>ã€Œæ¶ˆè´¹è€…ã€æºç åˆ†æ</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/6c0fd7/" aria-current="page" class="active sidebar-link">KafkaConsumer ç±»ä»£ç åˆ†æ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/6c0fd7/#å‰è¨€" class="sidebar-link">å‰è¨€</a></li><li class="sidebar-sub-header level2"><a href="/pages/6c0fd7/#poll-æ–¹æ³•" class="sidebar-link">poll()æ–¹æ³•</a></li><li class="sidebar-sub-header level2"><a href="/pages/6c0fd7/#pollforfetches-æ–¹æ³•" class="sidebar-link">pollForFetches()æ–¹æ³•</a></li><li class="sidebar-sub-header level2"><a href="/pages/6c0fd7/#æ€»ç»“" class="sidebar-link">æ€»ç»“</a></li><li class="sidebar-sub-header level2"><a href="/pages/6c0fd7/#å‚è€ƒèµ„æ–™" class="sidebar-link">å‚è€ƒèµ„æ–™</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>ã€ŒBrokerã€åŸç†åˆ†æ</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>å››ã€è®¾è®¡ç›®æ ‡</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="é¦–é¡µ" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>Kafka  ç³»ç»Ÿè®¾è®¡</span></li><li data-v-06225672><span data-v-06225672>ä¸‰ã€ä¸»çº¿ä»»åŠ¡</span></li><li data-v-06225672><span data-v-06225672>ã€Œæ¶ˆè´¹è€…ã€æºç åˆ†æ</span></li></ul> <div class="info" data-v-06225672><div title="ä½œè€…" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/brother-one" target="_blank" title="ä½œè€…" class="beLink" data-v-06225672>echo</a></div> <div title="åˆ›å»ºæ—¶é—´" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-09-18</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">ç›®å½•</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">KafkaConsumer ç±»ä»£ç åˆ†æ<!----></h1> <div class="page-slot page-slot-top">
    <div class="wwads-cn wwads-horizontal page-wwads" data-id="136"></div>
    <style>
      .page-wwads{
        width:100%!important;
        min-height: 0;
        margin: 0;
      }
      .page-wwads .wwads-img img{
        width:80px!important;
      }
      .page-wwads .wwads-poweredby{
        width: 40px;
        position: absolute;
        right: 25px;
        bottom: 3px;
      }
      .wwads-content .wwads-text, .page-wwads .wwads-text{
        height: 100%;
        padding-top: 5px;
        display: block;
      }
  </style>
  </div> <div class="theme-vdoing-content content__default"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="header-anchor">#</a> å‰è¨€</h2> <p>å‰æ–‡æˆ‘ä»¬åˆ†æäº† Kafka ç”Ÿäº§è€…ç«¯çš„æºä»£ç ï¼Œäº†è§£äº†ç”Ÿäº§è€…äº§ç”Ÿæ¶ˆæ¯çš„è¿‡ç¨‹ã€‚æ¶ˆæ¯ç”±ç”Ÿäº§è€…å‘å¸ƒåˆ°æŸä¸ªä¸»é¢˜çš„æŸä¸ªåˆ†åŒºä¸Šï¼Œå…¶å®æœ€ç»ˆæ˜¯è¢«å­˜å‚¨åœ¨æœåŠ¡ç«¯çš„æŸä¸ªbrokerä¸Šã€‚è€Œæ¶ˆè´¹è€…ç”±è®¢é˜…è¡Œä¸ºæ¥å†³å®šå®ƒæ‰€è¦æ¶ˆè´¹çš„ä¸»é¢˜å’Œåˆ†åŒºã€‚æ¶ˆè´¹è€…é€šè¿‡pollæ“ä½œï¼Œä¸æ–­çš„ä»æœåŠ¡ç«¯æ‹‰å–è¯¥ä¸»é¢˜åˆ†åŒºä¸Šäº§ç”Ÿçš„æ¶ˆæ¯ã€‚</p> <p>ç›¸ä¿¡æœ‰å…´è¶£çœ‹kafkaæºä»£ç çš„åŒå­¦ï¼Œè‚¯å®šå¯¹kafkaçš„åŸºæœ¬æ¦‚å¿µå’ŒåŸç†æœ‰æ‰€äº†è§£ã€‚å…³äºæ¶ˆè´¹è€…ï¼Œæˆ‘ä»¬çŸ¥é“åœ¨æœåŠ¡ç«¯ä¼šæœ‰GroupCoordinatorï¼ˆç»„åè°ƒå™¨ï¼‰ï¼Œè´Ÿè´£æ¯ä¸ªconsumer groupçš„leaderçš„é€‰ä¸¾ï¼Œä»¥åŠåˆ†å‘åˆ†åŒºåˆ†é…ç»“æœï¼Œè€Œcoumerçš„leaderåˆ™ä¼šæ ¹æ®åˆ†åŒºåˆ†é…ç­–ç•¥è¿›è¡Œåˆ†åŒºåˆ†é…ã€‚è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œåˆ†åŒºåˆ†é…ç»“æœå¹¶ä¸æ˜¯ç”±leaderåˆ†å‘ç»™åŒç»„çš„consumerï¼Œè€Œæ˜¯leaderè¿”å›ç»™GroupCoordinatorï¼Œå†æœ‰GroupCoordinatorè¿›è¡Œåˆ†å‘ã€‚</p> <p>æ¯å½“Brokeræœ‰å˜åŒ–ï¼Œæˆ–è€…Consumer Groupæœ‰å‡ºå…¥ç»„çš„å˜åŒ–æ—¶ï¼Œä¼šè§¦å‘ConsumerGroupçš„rebalanceã€‚ä¹Ÿå°±æ˜¯ä¸Šè¿°çš„åˆ†åŒºåˆ†é…å·¥ä½œã€‚</p> <p>å¦å¤–æ¶ˆè´¹è€…æœ¬åœ°ä¿å­˜äº†å®ƒæ‰€è´Ÿè´£ä¸»é¢˜åˆ†åŒºçš„æ¶ˆè´¹çŠ¶æ€ï¼Œé€šè¿‡æ‰‹åŠ¨å’Œè‡ªåŠ¨çš„æ–¹å¼æäº¤åˆ°æœåŠ¡ç«¯çš„å†…éƒ¨ä¸»é¢˜ä¸­ã€‚rebalanceè¿‡åï¼Œæ¶ˆè´¹è€…é‡æ–°ä»å†…éƒ¨ä¸»é¢˜è·å–å¯¹åº”ä¸»é¢˜åˆ†åŒºçš„æ¶ˆè´¹ä½ç½®ã€‚</p> <p>ä¸Šé¢æˆ‘ä»¬å›é¡¾äº†Consumerçš„è®¾è®¡å’Œæµç¨‹ï¼Œä¸ºæˆ‘ä»¬è¿›å…¥æºä»£ç åˆ†æåšå¥½é“ºå«ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°†ä»KafkaConsumerå…¥æ‰‹ï¼Œè¿›è¡Œä»£ç åˆ†æã€‚</p> <p>æˆ‘ä»¬å…ˆçœ‹ä¸‹ä½¿ç”¨KafkaConsumerè¿›è¡Œæ¶ˆè´¹çš„éƒ¨åˆ†ä»£ç ï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumer<span class="token punctuation">;</span>
 
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 
consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>topic<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">:</span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Received message: (&quot;</span> <span class="token operator">+</span> record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;) at offset &quot;</span> <span class="token operator">+</span> record<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><p>ä»¥ä¸Šä»£ç æ¥è‡ªäºæºä»£ç åŒ…ä¸­çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°KafkaConsumerå…ˆè®¢é˜…topicï¼Œç„¶åé€šè¿‡pollæ–¹æ³•è¿›è¡Œæ¶ˆæ¯æ‹‰å–ã€‚</p> <p>å¯ä»¥çœ‹åˆ°KafkaConsumeré€šè¿‡pollæ–¹æ³•è¿›è¡Œæ¶ˆè´¹ï¼Œè¿™ä¹Ÿæ˜¯KafkaConsumeræœ€ä¸»è¦çš„æ–¹æ³•ã€‚</p> <p>æˆ‘ä»¬å…ˆçœ‹çœ‹KafkaConsumerå†…éƒ¨çš„å…¶ä»–ç»„ä»¶æœ‰å“ªäº›ï¼Œè§ä¸‹å›¾ï¼š</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409181728769.png" alt="image-20240918172820691"></p> <p>ä¸Šå›¾ä»‹ç»äº†KafkaConsumerå†…éƒ¨çš„å‡ ä¸ªé‡è¦ç»„ä»¶ï¼š</p> <ol><li>å‰æ–‡è¯´è¿‡æ¶ˆè´¹è€…è¦è‡ªå·±è®°å½•æ¶ˆè´¹çš„ä½ç½®ï¼ˆä½†ä¹Ÿéœ€è¦æäº¤åˆ°æœåŠ¡ç«¯ä¿å­˜ï¼Œä¸ºäº†rebalanceåçš„æ¶ˆè´¹èƒ½è¡”æ¥ä¸Šï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦SubScriptionStateæ¥ä¿å­˜æ¶ˆè´¹çš„çŠ¶æ€ã€‚</li> <li>ConsumerCoordinator è´Ÿè´£å’Œ GroupCoordinator é€šè®¯ï¼Œä¾‹å¦‚åœ¨ leader é€‰ä¸¾ï¼Œå…¥ç»„ï¼Œåˆ†åŒºåˆ†é…ç­‰è¿‡ç¨‹ã€‚</li> <li>ConsumerNetworkClient æ˜¯å¯¹ NetworkClient çš„å°è£…ï¼Œå¦‚æœä½ æ˜¯ä» producer çœ‹è¿‡æ¥çš„ï¼Œæƒ³å¿…å¯¹ NetworkClient ååˆ†äº†è§£ï¼Œä»–å¯¹nioçš„ç»„ä»¶è¿›è¡Œå°è£…ï¼Œå®ç°ç½‘ç»œ IOã€‚</li> <li>PartitionAssignorï¼Œè¿™æ˜¯åˆ†åŒºåˆ†é…ç­–ç•¥ï¼Œåœ¨è¿›è¡Œåˆ†åŒºåˆ†é…çš„æ—¶å€™ä¼šç”¨åˆ°ã€‚</li> <li>Fetcher è´Ÿè´£ç»„ç»‡æ‹‰å–æ¶ˆæ¯çš„è¯·æ±‚ï¼Œä»¥åŠå¤„ç†è¿”å›ã€‚ä¸è¿‡éœ€è¦æ³¨æ„å®ƒå¹¶ä¸åšç½‘ç»œIOï¼Œç½‘ç»œIOè¿˜æ˜¯ç”±ConsumerNetworkClientå®Œæˆã€‚å®ƒå…¶å®å¯¹åº”ç”Ÿäº§è€…ä¸­çš„Senderã€‚</li></ol> <p>æˆ‘ä»¬æŠ›å¼€è®¢é˜…ã€rebalanceè¿™äº›æµç¨‹ï¼Œå…ˆä»¥kafkaæ¶ˆè´¹æµç¨‹ä¸ºä¸»ï¼Œè¿›è¡Œåˆ†æã€‚æœ‰äº›ç»„ä»¶åœ¨æ¶ˆè´¹æµç¨‹ä¸­æ˜¯æ¶‰åŠä¸åˆ°çš„ã€‚æ¶ˆè´¹æµç¨‹ä¸»è¦æ¶‰åŠåˆ°Fetcherã€SubScriptionStateå’ŒConsumerNetworkClientã€‚ç‰¹åˆ«æ˜¯ Fetcherï¼Œæ‰¿æ‹…äº†é‡è¦çš„å·¥ä½œã€‚ä¸è¿‡æˆ‘ä»¬è¿˜éœ€è¦ä¸€æ­¥æ­¥æ¥ï¼Œå…ˆè¿›å…¥pollæ–¹æ³•çš„åˆ†æã€‚</p> <h2 id="poll-æ–¹æ³•"><a href="#poll-æ–¹æ³•" class="header-anchor">#</a> poll()æ–¹æ³•</h2> <p>è¿™æ˜¯æ¶ˆæ¯æ‹‰å–çš„å…¥å£æ–¹æ³•ï¼Œä»–ä¼šä»ä¸Šæ¬¡æ¶ˆè´¹çš„ä½ç½®æ‹‰å–æ¶ˆæ¯ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨æŒ‡å®šæ¶ˆè´¹ä½ç½®ã€‚å…¥å‚æ˜¯é˜»å¡çš„æ—¶é•¿ï¼Œå¦‚æœæœ‰æ¶ˆæ¯å°†ä¼šç«‹å³è¿”å›ï¼Œå¦åˆ™ä¼šé˜»å¡åˆ°è¶…æ—¶ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®åˆ™è¿”å›ç©ºçš„æ•°æ®é›†åˆã€‚</p> <p>ä»£ç å¦‚ä¸‹ï¼š</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Timer</span> timer<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> includeMetadataInTimeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">acquireAndEnsureOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>subscriptions<span class="token punctuation">.</span><span class="token function">hasNoSubscriptionOrUserAssignment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Consumer is not subscribed to any topics or assigned any partitions&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
        <span class="token comment">// poll for new data until the timeout expires</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            client<span class="token punctuation">.</span><span class="token function">maybeTriggerWakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
            <span class="token keyword">if</span> <span class="token punctuation">(</span>includeMetadataInTimeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">updateAssignmentMetadataIfNeeded</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token class-name">ConsumerRecords</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">updateAssignmentMetadataIfNeeded</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">timer</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Still waiting for metadata&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
 
            <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ConsumerRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> <span class="token function">pollForFetches</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>records<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// before returning the fetched records, we can send off the next round of fetches</span>
                <span class="token comment">// and avoid block waiting for their responses to enable pipelining while the user</span>
                <span class="token comment">// is handling the fetched records.</span>
                <span class="token comment">//</span>
                <span class="token comment">// NOTE: since the consumed position has already been updated, we must not allow</span>
                <span class="token comment">// wakeups or any other errors to be triggered prior to returning the fetched records.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>fetcher<span class="token punctuation">.</span><span class="token function">sendFetches</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> client<span class="token punctuation">.</span><span class="token function">hasPendingRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    client<span class="token punctuation">.</span><span class="token function">pollNoWakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
 
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span><span class="token function">onConsume</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>records<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>timer<span class="token punctuation">.</span><span class="token function">notExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token keyword">return</span> <span class="token class-name">ConsumerRecords</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>é€»è¾‘è¯´æ˜ï¼š</p> <ol><li>é€šè¿‡ acquireAndEnsureOpen() ç¡®ä¿æœ¬å¯¹è±¡æ˜¯å•çº¿ç¨‹è¿›å…¥ï¼Œè¿™æ˜¯å› ä¸º KafkaConsumer éçº¿ç¨‹å®‰å…¨ã€‚</li> <li>æ£€æŸ¥æ˜¯å¦è®¢é˜…äº† topic</li> <li>è¿›å…¥ä¸»å¾ªç¯ï¼Œæ¡ä»¶æ˜¯æ²¡æœ‰è¶…æ—¶</li> <li>åœ¨ä¸»å¾ªç¯ä¸­é€šè¿‡ pollForFetches() æ‹‰å–ä¸€æ¬¡æ¶ˆæ¯ã€‚è¿™ä¸ªæ–¹æ³•ä¸­å…ˆæ£€æŸ¥æ˜¯å¦ç»å­˜åœ¨æ‹‰å–è¿‡çš„æœªåŠ å·¥æ¶ˆæ¯ï¼Œè¿™æ˜¯å› ä¸ºä¸Šä¸€è½®æ¬¡æ‹‰å–åšäº†æå‰æ‹‰å–å¤„ç†ã€‚æœ‰å¯èƒ½å·²ç»æ‹‰å–å›æ¶ˆæ¯ç­‰å¾…å¤„ç†ã€‚å¦‚æœæ²¡æœ‰å·²æ‹‰å–æœªåŠ å·¥æ•°æ®ï¼Œåˆ™å‡†å¤‡æ–°çš„æ‹‰å–è¯·æ±‚ï¼Œç½‘ç»œ IO æ‹‰å–æ¶ˆæ¯ï¼ŒåŠ å·¥æ‹‰å–å›æ¥çš„æ•°æ®ã€‚</li> <li>å¦‚æœä¸Šä¸€æ­¥æ‹‰å–åˆ°æ¶ˆæ¯ï¼Œå¹¶ä¸ä¼šç«‹å³è¿”å›ï¼Œè€Œæ˜¯å†ä¸€æ¬¡è§¦å‘æ¶ˆæ¯æ‹‰å–ï¼Œå¹¶ä¸”ä½¿ç”¨çš„æ˜¯éé˜»å¡æ–¹å¼ï¼Œè°ƒç”¨ client.pollNoWakeup()ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ï¼Œæå‰ç½‘ç»œ IOï¼ŒæŠŠæ¶ˆæ¯æ‹‰å–è¯·æ±‚å‘å‡ºå»ã€‚åœ¨ç½‘ç»œ IO çš„åŒæ—¶ï¼Œæ¶ˆæ¯æ•°æ®è¿”å›ç»™ consumer çš„è°ƒç”¨è€…è¿›è¡Œä¸šåŠ¡å¤„ç†ã€‚è¿™æ ·åšåˆ°äº†å¹¶è¡Œå¤„ç†ï¼Œæé«˜äº†æ•ˆç‡ã€‚ç­‰ä¸‹æ¬¡è°ƒç”¨ KafkaConsumer è¿›è¡Œ pollï¼Œå½“è¿›è¡Œåˆ°ç¬¬4æ­¥æ—¶ï¼Œæœ‰å¯èƒ½ç›´æ¥è¿”å›äº†ä¸Šè½®æ¬¡æå‰æ‹‰å–åˆ°çš„æ¶ˆæ¯ï¼Œä»è€Œçœå»äº†ç½‘ç»œ IO æ—¶é—´ã€‚</li></ol> <p>æˆ‘ä»¬é€šè¿‡ä¸‹å›¾å¸®åŠ©ç†è§£ä¸Šé¢4ã€5æ­¥çš„è®¾è®¡ï¼š</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409181731792.png" alt="image-20240918173142716"></p> <p>å›¾ä¸­å¸¦é¢œè‰²çš„æ–¹æ¡†ä»£è¡¨åœ¨æ•´ä¸ªæ‹‰å–æ¶ˆæ¯çš„æµç¨‹ä¸­ï¼Œä¸åŒçš„å¤„ç†è¿‡ç¨‹ï¼Œåˆ†å¸ƒäºä¸åŒçš„å¯¹è±¡ä¸­ã€‚å›¾ä¸­ä¸‹åŠéƒ¨åˆ†å±•ç¤ºçš„æ˜¯Kafkaå¤„ç†é€»è¾‘ã€‚å¯ä»¥çœ‹åˆ°åœ¨ç¬¬ä¸€è½®æ¬¡è°ƒç”¨äº†ä¸¤æ¬¡ConusmerNetworkClientè¿›è¡ŒIOå¤„ç†ï¼Œç¬¬äºŒæ¬¡IOçš„åŒæ—¶ï¼Œè°ƒç”¨è€…å·²ç»å¼€å§‹æ‹¿åˆ°è¿”å›çš„æ¶ˆæ¯è¿›è¡Œä¸šåŠ¡å¤„ç†ï¼Œè¿™é‡Œå®ç°äº†å¹¶è¡Œå¤„ç†ã€‚è¿›å…¥ç¬¬äºŒè½®æ¬¡ï¼Œæˆ‘ä»¬å‘ç° kafkaConsumerå¯ä»¥ç›´æ¥å–åˆ°ä¸Šè½®ç¬¬äºŒæ¬¡IOå›æ¥çš„æ¶ˆæ¯è¿›è¡ŒåŠ å·¥ï¼ŒåŠ å·¥åè¿”å›è°ƒç”¨è€…ï¼Œè¿›è¡Œä¸šåŠ¡å¤„ç†ï¼ŒåŒæ—¶ä¸‹ä¸€è½®æ¬¡çš„æ¶ˆæ¯æ‹‰å–å¼‚æ­¥è¿›è¡Œä¸­ã€‚å¯ä»¥çœ‹åˆ°ç¬¬äºŒè½®æ¬¡çš„æ€»æ—¶é•¿å·²ç»æ²¡æœ‰äº†ç½‘ç»œIOçš„æ—¶é•¿ï¼Œå› ä¸ºè¿™éƒ¨åˆ†å·¥ä½œåœ¨ä¸Šä¸€è½®æ¬¡å·²ç»<strong>å¼‚æ­¥</strong>è¿›è¡Œå®Œæˆã€‚</p> <p>å¦‚æœä¸è¿™æ ·åšï¼Œä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿæˆ‘ä»¬çœ‹å›¾ä¸­ä¸ŠåŠéƒ¨åˆ†ï¼Œæˆ‘ä»¬å‘ç°æ¯ä¸ªè½®æ¬¡éƒ½æ˜¯ä¸€æ ·çš„ï¼Œç½‘ç»œIOéƒ½éœ€è¦åŒæ­¥ç­‰å¾…ï¼Œä»ç¬¬äºŒè½®å¼€å§‹ï¼Œæ•´ä¸ªæ¶ˆæ¯æ‹‰å–å¤„ç†çš„æ—¶é•¿æ˜æ˜¾å¢åŠ äº†IOéƒ¨åˆ†ï¼Œä¼šæ›´é•¿ã€‚</p> <p>ä»¥ä¸Šæƒ…å†µæ¯”è¾ƒæç«¯ï¼Œæ¯æ¬¡æå‰IOéƒ½ä¼šè¿”å›æ•°æ®ï¼Œå¹¶ä¸”æ¶ˆæ¯çš„ä¸šåŠ¡å¤„ç†æ—¶é•¿å¤§äºç½‘ç»œIOã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œèƒ½æœ€å¤§å‘æŒ¥å‡ºå¼‚æ­¥IOçš„ä¼˜åŠ¿ã€‚</p> <p>ä»¥ä¸Šè¿™ç§è®¾è®¡çš„å°ç»†èŠ‚çœŸçš„å€¼å¾—æˆ‘ä»¬æ¥å­¦ä¹ ã€‚è¯»æºä»£ç åœ¨äº†è§£åŸç†çš„åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿè¦å¤šæ€»ç»“ä¼˜ç§€çš„è®¾è®¡æ€æƒ³ï¼Œå¯¹æˆ‘ä»¬çš„å·¥ä½œå¾ˆæœ‰å¸®åŠ©ã€‚</p> <p>ä»ä¸Šé¢çš„åˆ†æçœ‹åˆ°ï¼ŒçœŸæ­£æ¶ˆæ¯æ‹‰å–çš„ä»£ç æ˜¯ï¼š</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ConsumerRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> <span class="token function">pollForFetches</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ä¸‹é¢æˆ‘ä»¬ç»§ç»­åˆ†æpollForFetchesæ–¹æ³•</p> <h2 id="pollforfetches-æ–¹æ³•"><a href="#pollforfetches-æ–¹æ³•" class="header-anchor">#</a> pollForFetches()æ–¹æ³•</h2> <p>è¿™ä¸ªæ–¹æ³•å®Œæˆäº†ä»æœåŠ¡ç«¯æ‹‰å–æ¶ˆæ¯çš„åŠ¨ä½œï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸»è¦ä½¿ç”¨äº†Fetcherå’ŒConsumerNetworkClientä¸¤ä¸ªç»„ä»¶ã€‚</p> <ol><li>Fetcherè´Ÿè´£å‡†å¤‡å¥½æ‹‰å–æ¶ˆæ¯çš„requestã€å¤„ç†responseã€å¹¶ä¸”æŠŠæ¶ˆæ¯è½¬åŒ–ä¸ºå¯¹è°ƒç”¨è€…å‹å¥½çš„æ ¼å¼</li> <li>ConsumerNetworkClientè´Ÿè´£æŠŠè¯·æ±‚å‘é€å‡ºå»ï¼Œæ¥æ”¶è¿”å›ï¼Œä¹Ÿå°±æ˜¯ç½‘ç»œIOå·¥ä½œ</li></ol> <p>å®ƒçš„ä¸»è¦æµç¨‹æ˜¯å¦‚ä¸‹å››æ­¥ï¼š</p> <ol><li><p>æŸ¥çœ‹æ˜¯å¦å·²ç»å­˜åœ¨æ‹‰å–å›æ¥æœªåŠ å·¥çš„æ¶ˆæ¯åŸå§‹æ•°æ®ï¼Œæœ‰çš„è¯ç«‹å³è°ƒç”¨fetcher.fetchedRecords()åŠ å·¥ï¼Œç„¶åè¿”å›ã€‚</p></li> <li><p>å¦‚æœæ²¡æœ‰æœªåŠ å·¥çš„åŸå§‹æ•°æ®ï¼Œé‚£ä¹ˆè°ƒç”¨fetcher.sendFetches()å‡†å¤‡æ‹‰å–è¯·æ±‚ã€‚</p></li> <li><p>é€šè¿‡ConsumerNetworkClientå‘é€æ‹‰å–è¯·æ±‚ã€‚</p></li> <li><p>åŠ å·¥æ‹‰å–å›çš„åŸå§‹æ•°æ®ï¼Œè¿”å›ã€‚</p></li></ol> <p>å…¶å®æ­£å¸¸æ¥è¯´2ï¼Œ3ï¼Œ4æ­¥æµç¨‹å°±è¶³å¤Ÿäº†ã€‚ä¸ºä»€ä¹ˆä¼šæœ‰ç¬¬1æ­¥å‘¢ï¼Ÿé‚£äº›å·²ç»å­˜åœ¨çš„æœªåŠ å·¥çš„æ•°æ®å“ªé‡Œæ¥çš„ï¼Ÿå¦‚æœä½ ç†è§£äº†å‰é¢æ‰€è®²çš„å¼‚æ­¥æ‹‰å–è®¾è®¡ï¼Œé‚£ä¹ˆä½ åº”è¯¥çŸ¥é“ç­”æ¡ˆã€‚è¿™äº›å·²ç»å­˜åœ¨çš„æœªåŠ å·¥æ•°æ®æ¥è‡ªäºä¸Šä¸€è½®æ¬¡çš„å¼‚æ­¥IOã€‚æ­£æ˜¯å› ä¸ºæœ‰äº†å¼‚æ­¥çš„IOæ‹‰å–ï¼Œæ‰ä¼šæœ‰ç¬¬ä¸€æ­¥çš„å¤„ç†å¯èƒ½ã€‚</p> <p>å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ConsumerRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">pollForFetches</span><span class="token punctuation">(</span><span class="token class-name">Timer</span> timer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> pollTimeout <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>coordinator<span class="token punctuation">.</span><span class="token function">timeToNextPoll</span><span class="token punctuation">(</span>timer<span class="token punctuation">.</span><span class="token function">currentTimeMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> timer<span class="token punctuation">.</span><span class="token function">remainingMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">// if data is available already, return it immediately</span>
    <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ConsumerRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> fetcher<span class="token punctuation">.</span><span class="token function">fetchedRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>records<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> records<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// send any new fetches (won't resend pending fetches)</span>
    fetcher<span class="token punctuation">.</span><span class="token function">sendFetches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">// We do not want to be stuck blocking in poll if we are missing some positions</span>
    <span class="token comment">// since the offset lookup may be backing off after a failure</span>
 
    <span class="token comment">// NOTE: the use of cachedSubscriptionHashAllFetchPositions means we MUST call</span>
    <span class="token comment">// updateAssignmentMetadataIfNeeded before this method.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cachedSubscriptionHashAllFetchPositions <span class="token operator">&amp;&amp;</span> pollTimeout <span class="token operator">&gt;</span> retryBackoffMs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pollTimeout <span class="token operator">=</span> retryBackoffMs<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token class-name">Timer</span> pollTimer <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">timer</span><span class="token punctuation">(</span>pollTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>pollTimer<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// since a fetch might be completed by the background thread, we need this poll condition</span>
        <span class="token comment">// to ensure that we do not block unnecessarily in poll()</span>
        <span class="token keyword">return</span> <span class="token operator">!</span>fetcher<span class="token punctuation">.</span><span class="token function">hasCompletedFetches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    timer<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>pollTimer<span class="token punctuation">.</span><span class="token function">currentTimeMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">// after the long poll, we should check whether the group needs to rebalance</span>
    <span class="token comment">// prior to returning data so that the group can stabilize faster</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>coordinator<span class="token punctuation">.</span><span class="token function">rejoinNeededOrPending</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">return</span> fetcher<span class="token punctuation">.</span><span class="token function">fetchedRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¯ä»¥çœ‹åˆ°ä»¥ä¸Šè¿‡ç¨‹é™¤äº†IOæ“ä½œå¤–ï¼Œéƒ½æ˜¯é€šè¿‡Fetcherå®Œæˆçš„ï¼Œè¶³ä»¥ä½“ç°ä»–çš„é‡è¦ã€‚æ¥ä¸‹æ¥çš„ç« èŠ‚å°†ä¼šé‡ç‚¹åˆ†æFetcherã€‚</p> <h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="header-anchor">#</a> æ€»ç»“</h2> <p>æœ¬ç¯‡å…ˆæ˜¯å›é¡¾äº†Kafkaæ¶ˆè´¹è€…çš„è®¾è®¡ï¼Œç„¶åä»KafkaConsumerçš„Pollæ–¹æ³•å…¥æ‰‹å¯¹æ‹‰å–çš„é€»è¾‘è¿›è¡Œåˆ†æã€‚Kafkaå¾ˆå·§å¦™çš„é‡‡ç”¨å¼‚æ­¥IOæ–¹å¼ï¼Œç¼©çŸ­æ•´ä¸ªæµç¨‹çš„æ—¶é•¿ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°†ä¼šè¿›å…¥Fetcherçš„åˆ†æï¼Œçœ‹å…¶å¦‚ä½•å‡†å¤‡æ‹‰å–æ¶ˆæ¯çš„è¯·æ±‚ï¼Œå¹¶å®Œæˆæ¶ˆæ¯çš„è½¬åŒ–å¤„ç†ã€‚</p> <h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="header-anchor">#</a> å‚è€ƒèµ„æ–™</h2> <ul><li><a href="https://blog.csdn.net/liyiming2017/article/details/89187474" target="_blank" rel="noopener noreferrer">ä½ ç»å¯¹èƒ½çœ‹æ‡‚çš„Kafkaæºä»£ç åˆ†æ-KafkaConsumerç±»ä»£ç åˆ†æ_consumer is not subscribed to any topics or assign-CSDNåšå®¢<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/echo-lxy/echo-system-design/edit/master/docs/02.Kafka  ç³»ç»Ÿè®¾è®¡/06.ä¸‰ã€ä¸»çº¿ä»»åŠ¡/600.ã€Œæ¶ˆè´¹è€…ã€æºç åˆ†æ/05.KafkaConsumer ç±»ä»£ç åˆ†æ.md" target="_blank" rel="noopener noreferrer">ç¼–è¾‘</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°äº:</span> <span class="time">2024/09/18, 11:29:27</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        â†
        <a href="/pages/b2caf1/" class="prev">NetworkClient ç±»ä»£ç åˆ†æ</a></span> <span class="next"><a href="/pages/d9df7d/">æ§åˆ¶å™¨</a>â†’
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:lixinyang2002@163.com" title="å‘é‚®ä»¶" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/echo-lxy" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="å¬éŸ³ä¹" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="æœ¬ç«™ä¸»é¢˜">Vdoing</a> 
    | Copyright Â© 2024-2024
    <span>Xinyang Li | MIT License</span></div> <div class="buttons"><div title="è¿”å›é¡¶éƒ¨" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="å»è¯„è®º" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ä¸»é¢˜æ¨¡å¼" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          è·Ÿéšç³»ç»Ÿ
        </li><li class="iconfont icon-rijianmoshi">
          æµ…è‰²æ¨¡å¼
        </li><li class="iconfont icon-yejianmoshi">
          æ·±è‰²æ¨¡å¼
        </li><li class="iconfont icon-yuedu">
          é˜…è¯»æ¨¡å¼
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.a56e5838.js" defer></script><script src="/assets/js/2.933750c6.js" defer></script><script src="/assets/js/26.96f3c12e.js" defer></script><script src="/assets/js/7.7eb70372.js" defer></script>
  </body>
</html>
