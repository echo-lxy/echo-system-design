<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>чммф║Фшп╛я╝ЪNetty хжВф╜ХщлШцХИцОецФ╢ч╜Сч╗ЬцХ░цНо | EchoDesign</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="ч│╗ч╗Яшо╛шобф╣ЛуАМшо▓шзг + щЭвшпХцМЗхНЧуАНя╝Мц░┤ц╗┤чЯ│чй┐я╝Мшо╛шобцЧащУ╢х╝╣я╝Б">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.c76c3453.css" as="style"><link rel="preload" href="/assets/js/app.a0e02413.js" as="script"><link rel="preload" href="/assets/js/2.933750c6.js" as="script"><link rel="preload" href="/assets/js/55.2b9fbb7f.js" as="script"><link rel="preload" href="/assets/js/7.7eb70372.js" as="script"><link rel="prefetch" href="/assets/js/10.b313d17c.js"><link rel="prefetch" href="/assets/js/100.2b21dce5.js"><link rel="prefetch" href="/assets/js/101.96ca71f6.js"><link rel="prefetch" href="/assets/js/11.71fe9642.js"><link rel="prefetch" href="/assets/js/12.38d1989d.js"><link rel="prefetch" href="/assets/js/13.850793b0.js"><link rel="prefetch" href="/assets/js/14.1141ec27.js"><link rel="prefetch" href="/assets/js/15.12d1dea8.js"><link rel="prefetch" href="/assets/js/16.5a9b32ee.js"><link rel="prefetch" href="/assets/js/17.acb3bf3d.js"><link rel="prefetch" href="/assets/js/18.e491edb6.js"><link rel="prefetch" href="/assets/js/19.daf31819.js"><link rel="prefetch" href="/assets/js/20.d70e5281.js"><link rel="prefetch" href="/assets/js/21.0e0ed140.js"><link rel="prefetch" href="/assets/js/22.dd779f94.js"><link rel="prefetch" href="/assets/js/23.4d814163.js"><link rel="prefetch" href="/assets/js/24.891fe6fb.js"><link rel="prefetch" href="/assets/js/25.41dca26b.js"><link rel="prefetch" href="/assets/js/26.6337eac0.js"><link rel="prefetch" href="/assets/js/27.de80589e.js"><link rel="prefetch" href="/assets/js/28.95a1fb6b.js"><link rel="prefetch" href="/assets/js/29.371a40e1.js"><link rel="prefetch" href="/assets/js/3.0393001c.js"><link rel="prefetch" href="/assets/js/30.e32f6b31.js"><link rel="prefetch" href="/assets/js/31.a532917f.js"><link rel="prefetch" href="/assets/js/32.13b70e91.js"><link rel="prefetch" href="/assets/js/33.64ab8d0c.js"><link rel="prefetch" href="/assets/js/34.6d3cc288.js"><link rel="prefetch" href="/assets/js/35.2760ed8d.js"><link rel="prefetch" href="/assets/js/36.4fd54c47.js"><link rel="prefetch" href="/assets/js/37.51145580.js"><link rel="prefetch" href="/assets/js/38.40fe2658.js"><link rel="prefetch" href="/assets/js/39.84b6e82e.js"><link rel="prefetch" href="/assets/js/4.73518a0f.js"><link rel="prefetch" href="/assets/js/40.591baf2a.js"><link rel="prefetch" href="/assets/js/41.f961e422.js"><link rel="prefetch" href="/assets/js/42.b34f1599.js"><link rel="prefetch" href="/assets/js/43.5a509601.js"><link rel="prefetch" href="/assets/js/44.64fd3383.js"><link rel="prefetch" href="/assets/js/45.685623ac.js"><link rel="prefetch" href="/assets/js/46.7624d38c.js"><link rel="prefetch" href="/assets/js/47.5646b068.js"><link rel="prefetch" href="/assets/js/48.a1b270df.js"><link rel="prefetch" href="/assets/js/49.ee9681bc.js"><link rel="prefetch" href="/assets/js/5.94727770.js"><link rel="prefetch" href="/assets/js/50.b424b2c0.js"><link rel="prefetch" href="/assets/js/51.ef213b56.js"><link rel="prefetch" href="/assets/js/52.18c75eba.js"><link rel="prefetch" href="/assets/js/53.a4f1720a.js"><link rel="prefetch" href="/assets/js/54.8604fc24.js"><link rel="prefetch" href="/assets/js/56.13fd4db7.js"><link rel="prefetch" href="/assets/js/57.be37bfce.js"><link rel="prefetch" href="/assets/js/58.ca1aa081.js"><link rel="prefetch" href="/assets/js/59.7b7e3faf.js"><link rel="prefetch" href="/assets/js/6.0b558b79.js"><link rel="prefetch" href="/assets/js/60.96815912.js"><link rel="prefetch" href="/assets/js/61.08b4acf0.js"><link rel="prefetch" href="/assets/js/62.d5f3cb0d.js"><link rel="prefetch" href="/assets/js/63.392eea42.js"><link rel="prefetch" href="/assets/js/64.9b3def35.js"><link rel="prefetch" href="/assets/js/65.0b2ab47d.js"><link rel="prefetch" href="/assets/js/66.b54930de.js"><link rel="prefetch" href="/assets/js/67.b666ce97.js"><link rel="prefetch" href="/assets/js/68.1b76c178.js"><link rel="prefetch" href="/assets/js/69.32609e29.js"><link rel="prefetch" href="/assets/js/70.b920a5f7.js"><link rel="prefetch" href="/assets/js/71.37ec984a.js"><link rel="prefetch" href="/assets/js/72.d0b495b4.js"><link rel="prefetch" href="/assets/js/73.caa8364a.js"><link rel="prefetch" href="/assets/js/74.26f8d9a5.js"><link rel="prefetch" href="/assets/js/75.dc7fdd0f.js"><link rel="prefetch" href="/assets/js/76.32858593.js"><link rel="prefetch" href="/assets/js/77.7b3f6980.js"><link rel="prefetch" href="/assets/js/78.746b48c5.js"><link rel="prefetch" href="/assets/js/79.173bbc8c.js"><link rel="prefetch" href="/assets/js/8.0ec7f6e8.js"><link rel="prefetch" href="/assets/js/80.78a31e84.js"><link rel="prefetch" href="/assets/js/81.35661fac.js"><link rel="prefetch" href="/assets/js/82.e54c087e.js"><link rel="prefetch" href="/assets/js/83.fff2e0cc.js"><link rel="prefetch" href="/assets/js/84.27dda1ee.js"><link rel="prefetch" href="/assets/js/85.f69467b2.js"><link rel="prefetch" href="/assets/js/86.931cbb70.js"><link rel="prefetch" href="/assets/js/87.78b2eebd.js"><link rel="prefetch" href="/assets/js/88.03774161.js"><link rel="prefetch" href="/assets/js/89.e6cb2516.js"><link rel="prefetch" href="/assets/js/9.2ac86403.js"><link rel="prefetch" href="/assets/js/90.f99f7813.js"><link rel="prefetch" href="/assets/js/91.2b9bd4e6.js"><link rel="prefetch" href="/assets/js/92.6b777d4b.js"><link rel="prefetch" href="/assets/js/93.f8975bc4.js"><link rel="prefetch" href="/assets/js/94.0b55855d.js"><link rel="prefetch" href="/assets/js/95.342f5a9b.js"><link rel="prefetch" href="/assets/js/96.15d8e4f1.js"><link rel="prefetch" href="/assets/js/97.0a9a6187.js"><link rel="prefetch" href="/assets/js/98.b46fd254.js"><link rel="prefetch" href="/assets/js/99.d1ca4fc0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c76c3453.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="чЫох╜Х" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="EchoDesign" class="logo"> <span class="site-name can-hide">EchoDesign</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">ЁЯПащжЦщб╡</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">тЬТя╕ПчГнщЧичоЧц│Х</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕шо╛шоб" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕шо╛шоб</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ч│╗ч╗Яшо╛шоб</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">тЭУщЧочнФ</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ЁЯСАхКицАБ</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">ЁЯПащжЦщб╡</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">тЬТя╕ПчГнщЧичоЧц│Х</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕шо╛шоб" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕шо╛шоб</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ч│╗ч╗Яшо╛шоб</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">тЭУщЧочнФ</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ЁЯСАхКицАБ</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ф╕АуАБхЙНшиА</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ф║МуАБхЯ║чбАчЯешпЖ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ф╕ЙуАБф╕╗ч║┐ф╗╗хКб</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>хЫЫуАБц╖▒хЕе Netty ца╕х┐Г</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/65674f/" class="sidebar-link">чммф╕Ашп╛я╝ЪщАПш┐З Netty чЬЛ IO цибхЮЛ</a></li><li><a href="/pages/440035/" class="sidebar-link">чммф║Мшп╛я╝ЪReactorхЬи Netty ф╕нчЪДхоЮчО░я╝ИхИЫх╗║чпЗя╝Й</a></li><li><a href="/pages/bb668a/" class="sidebar-link">чммф╕Йшп╛я╝ЪNetty ца╕х┐Гх╝ХцУО Reactor чЪДш┐Рш╜мцЮ╢цЮД</a></li><li><a href="/pages/be98dc/" class="sidebar-link">чммхЫЫшп╛я╝ЪNetty хжВф╜ХщлШцХИцОецФ╢ч╜Сч╗Ьш┐ЮцОе</a></li><li><a href="/pages/0938c1/" aria-current="page" class="active sidebar-link">чммф║Фшп╛я╝ЪNetty хжВф╜ХщлШцХИцОецФ╢ч╜Сч╗ЬцХ░цНо</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/0938c1/#хЙНшиА" class="sidebar-link">хЙНшиА</a></li><li class="sidebar-sub-header level2"><a href="/pages/0938c1/#_1-sub-reactor-хдДчРЖ-op-read-ф║Лф╗╢ц╡БчиЛцА╗шзИ" class="sidebar-link">1. Sub Reactor хдДчРЖ OP_READ ф║Лф╗╢ц╡БчиЛцА╗шзИ</a></li><li class="sidebar-sub-header level2"><a href="/pages/0938c1/#_2-netty-цОецФ╢ч╜Сч╗ЬцХ░цНоц╡БчиЛцА╗шзИ" class="sidebar-link">2. Netty цОецФ╢ч╜Сч╗ЬцХ░цНоц╡БчиЛцА╗шзИ</a></li><li class="sidebar-sub-header level2"><a href="/pages/0938c1/#_3-ц║РчаБца╕х┐ГцбЖцЮ╢цА╗шзИ" class="sidebar-link">3. ц║РчаБца╕х┐ГцбЖцЮ╢цА╗шзИ</a></li><li class="sidebar-sub-header level2"><a href="/pages/0938c1/#_4-bytebuffer-хКицАБшЗкщАВх║ФцЙйч╝йхо╣цЬ║хИ╢" class="sidebar-link">4. ByteBuffer хКицАБшЗкщАВх║ФцЙйч╝йхо╣цЬ║хИ╢</a></li><li class="sidebar-sub-header level2"><a href="/pages/0938c1/#_5-ф╜┐чФихаЖхдЦхЖЕхнШф╕║-bytebuffer-хИЖщЕНхЖЕхнШ" class="sidebar-link">5. ф╜┐чФихаЖхдЦхЖЕхнШф╕║ ByteBuffer хИЖщЕНхЖЕхнШ</a></li><li class="sidebar-sub-header level2"><a href="/pages/0938c1/#цА╗ч╗У" class="sidebar-link">цА╗ч╗У</a></li><li class="sidebar-sub-header level2"><a href="/pages/0938c1/#хПВшАГш╡ДцЦЩ" class="sidebar-link">хПВшАГш╡ДцЦЩ</a></li></ul></li><li><a href="/pages/a73206/" class="sidebar-link">чммхЕншп╛я╝ЪNetty хжВф╜ХщлШцХИхПСщАБч╜Сч╗ЬцХ░цНо</a></li><li><a href="/pages/a1b0fe/" class="sidebar-link">чммф╕Гшп╛я╝ЪNetty ф╕нIOф║Лф╗╢чЪДшзжхПСцЧ╢цЬ║хТМф╝ацТнц╡БчиЛ</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ф║ФуАБц╖▒хЕе Netty хЖЕхнШчобчРЖ</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="щжЦщб╡" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>Netty ч│╗ч╗Яшо╛шоб</span></li><li data-v-06225672><span data-v-06225672>хЫЫуАБц╖▒хЕе Netty ца╕х┐Г</span></li></ul> <div class="info" data-v-06225672><div title="ф╜ЬшАЕ" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/brother-one" target="_blank" title="ф╜ЬшАЕ" class="beLink" data-v-06225672>echo</a></div> <div title="хИЫх╗║цЧ╢щЧ┤" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-09-19</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">чЫох╜Х</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">чммф║Фшп╛я╝ЪNetty хжВф╜ХщлШцХИцОецФ╢ч╜Сч╗ЬцХ░цНо<!----></h1> <div class="page-slot page-slot-top">
    <div class="wwads-cn wwads-horizontal page-wwads" data-id="136"></div>
    <style>
      .page-wwads{
        width:100%!important;
        min-height: 0;
        margin: 0;
      }
      .page-wwads .wwads-img img{
        width:80px!important;
      }
      .page-wwads .wwads-poweredby{
        width: 40px;
        position: absolute;
        right: 25px;
        bottom: 3px;
      }
      .wwads-content .wwads-text, .page-wwads .wwads-text{
        height: 100%;
        padding-top: 5px;
        display: block;
      }
  </style>
  </div> <div class="theme-vdoing-content content__default"><h2 id="хЙНшиА"><a href="#хЙНшиА" class="header-anchor">#</a> хЙНшиА</h2> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191130021.png" alt="хЫ╛чЙЗ"></p> <h3 id="хЙНцЦЗхЫЮщб╛"><a href="#хЙНцЦЗхЫЮщб╛" class="header-anchor">#</a> хЙНцЦЗхЫЮщб╛</h3> <p>хЬихЙНш╛╣чЪДч│╗хИЧцЦЗчлаф╕ня╝МцИСф╗мф╗ОхЖЕца╕хжВф╜ХцФ╢хПСч╜Сч╗ЬцХ░цНох╝АхзЛф╗еф╕Аф╕к C10K чЪДщЧощвШф╜Ьф╕║ф╕╗ч║┐шпжч╗Жф╗ОхЖЕца╕шзТх║жщШРш┐░ф║Жч╜Сч╗Ь IO цибхЮЛчЪДц╝ФхПШя╝МцЬАч╗ИхЬицндхЯ║чбАф╕Кх╝ХхЗ║ф║Ж Netty чЪДч╜Сч╗Ь IO цибхЮЛхжВф╕ЛхЫ╛цЙАчд║я╝Ъ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191130408.png" alt="хЫ╛чЙЗ"></p> <blockquote><p>шпжч╗ЖхЖЕхо╣хПпхЫЮчЬЛ<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247483737&amp;idx=1&amp;sn=7ef3afbb54289c6e839eed724bb8a9d6&amp;chksm=ce77c71ef9004e08e3d164561e3a2708fc210c05408fa41f7fe338d8e85f39c1ad57519b614e&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКф╗ОхЖЕца╕шзТх║жчЬЛ IO цибхЮЛчЪДц╝ФхПШуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>хРОч╗нцИСф╗мхПИхЫ┤ч╗ХчЭА Netty чЪДф╕╗ф╗О Reactor ч╜Сч╗Ь IO ч║┐чиЛцибхЮЛя╝МхЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247483907&amp;idx=1&amp;sn=084c470a8fe6234c2c9461b5f713ff30&amp;chksm=ce77c444f9004d52e7c6244bee83479070effb0bc59236df071f4d62e91e25f01715fca53696&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКReactor цибхЮЛхЬи Netty ф╕нчЪДхоЮчО░уАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕АцЦЗф╕ншпжч╗ЖщШРш┐░ф║Ж Netty чЪДф╕╗ф╗О Reactor цибхЮЛчЪДхИЫх╗║я╝Мф╗ехПКф╗Лч╗Нф║Ж Reactor цибхЮЛчЪДхЕ│щФоч╗Дф╗╢уАВцРнх╗║ф║Ж Netty чЪДца╕х┐ГщкицЮ╢хжВф╕ЛхЫ╛цЙАчд║я╝Ъ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191130297.png" alt="хЫ╛чЙЗ"></p> <p>хЬица╕х┐ГщкицЮ╢цРнх╗║хоМцпХф╣ЛхРОя╝МцИСф╗мщЪПхРОхПИхЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484005&amp;idx=1&amp;sn=52f51269902a58f40d33208421109bc3&amp;chksm=ce77c422f9004d340e5b385ef6ba24dfba1f802076ace80ad6390e934173a10401e64e13eaeb&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКшпжч╗ЖхЫ╛шзг Reactor хРпхКихЕиц╡БчиЛуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕АцЦЗф╕нщШРш┐░ф║Ж Reactor хРпхКичЪДхЕиц╡БчиЛя╝Мф╕Аф╕кщЭЮх╕╕щЗНшжБчЪДца╕х┐Гч╗Дф╗╢ NioServerSocketChannel х╝АхзЛхЬиш┐ЩщЗМхИЭцмбф║очЫ╕я╝МцЙ┐цЛЕчЭАф╕Аф╕кч╜Сч╗ЬцбЖцЮ╢цЬАщЗНшжБчЪДф╗╗хКб--щлШцХИцОецФ╢ч╜Сч╗Ьш┐ЮцОеуАВцИСф╗мф╗Лч╗Нф║Ж NioServerSocketChannel чЪДхИЫх╗║я╝МхИЭхзЛхМЦя╝МхРС Main Reactor ц│ихЖМх╣╢чЫСхРм OP_ACCEPT ф║Лф╗╢чЪДцХ┤ф╕кц╡БчиЛуАВхЬицндхЯ║чбАф╕Кя╝МNetty х╛Чф╗ецХ┤шгЕх╛ЕхПСя╝МцЮХцИИх╛ЕцЧжх╝АхзЛш┐ОцОец╡╖щЗПчЪДховцИ╖члпш┐ЮцОеуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191130695.png" alt="хЫ╛чЙЗ"></p> <p>щЪПхРОч┤зцОечЭАцИСф╗мхЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484184&amp;idx=1&amp;sn=726877ce28cf6e5d2ac3225fae687f19&amp;chksm=ce77c55ff9004c493b592288819dc4d4664b5949ee97fed977b6558bc517dad0e1f73fab0f46&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКNetty хжВф╜ХщлШцХИцОецФ╢ч╜Сч╗Ьш┐ЮцОеуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕АцЦЗф╕ншпжч╗Жф╗Лч╗Нф║Ж Netty щлШцХИцОецФ╢ховцИ╖члпч╜Сч╗Ьш┐ЮцОечЪДхЕиц╡БчиЛя╝МхЬиш┐ЩщЗМ Netty чЪДца╕х┐ГщЗНшжБч╗Дф╗╢ NioServerSocketChannel х╝АхзЛцнгцШпчЩ╗хЬ║я╝МхЬи NioServerSocketChannel ф╕нцИСф╗мхИЫх╗║ф║ЖховцИ╖члпш┐ЮцОе NioSocketChannelя╝Мх╣╢шпжч╗Жф╗Лч╗Нф║Ж NioSocketChannel чЪДхИЭхзЛхМЦш┐ЗчиЛя╝МщЪПхРОщАЪш┐ЗхЬи NioServerSocketChannel чЪД pipeline ф╕ншзжхПС ChannelRead ф║Лф╗╢я╝Мх╣╢цЬАч╗ИхЬи ServerBootstrapAcceptor ф╕нх░ЖховцИ╖члпш┐ЮцОе NioSocketChannel ц│ихЖМхИ░ Sub Reactor ф╕нх╝АхзЛчЫСхРмховцИ╖члпш┐ЮцОеф╕КчЪД OP_READ ф║Лф╗╢я╝МхЗЖхдЗцОецФ╢ховцИ╖члпхПСщАБчЪДч╜Сч╗ЬцХ░цНоф╣Ях░▒цШпцЬмцЦЗчЪДф╕╗щвШхЖЕхо╣уАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191130550.png" alt="хЫ╛чЙЗ"></p> <p>шЗкцнд Netty чЪДца╕х┐Гч╗Дф╗╢хЕищГих░▒ч╗кх╣╢хРпхКихоМцпХя╝Мх╝АхзЛш╡╖щгЮ~~~</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191130148.png" alt="хЫ╛чЙЗ"></p> <p>ф╣ЛхЙНцЦЗчлаф╕нчЪДф╕╗шзТцШп Netty ф╕нф╕╗ Reactor ч╗Дф╕нчЪД Main Reactor ф╗ехПКц│ихЖМхЬи Main Reactor ф╕Кш╛╣чЪД NioServerSocketChannelя╝МщВгф╣Иф╗ОцЬмцЦЗх╝АхзЛя╝МцИСф╗мцЦЗчлаф╕нчЪДф╕╗шзТх░▒хИЗцНвф╕║ Sub Reactor ф╗ехПКц│ихЖМхЬи SubReactor ф╕КчЪД NioSocketChannel ф║ЖуАВ</p> <p>ф╕ЛщЭвх░▒шойцИСф╗мцнгх╝Пш┐ЫхЕеф╗КхдйчЪДф╕╗щвШя╝МчЬЛф╕Аф╕Л Netty цШпхжВф╜ХхдДчРЖ OP_READ ф║Лф╗╢ф╗ехПКхжВф╜ХщлШцХИцОецФ╢ч╜Сч╗ЬцХ░цНочЪДуАВ</p> <h2 id="_1-sub-reactor-хдДчРЖ-op-read-ф║Лф╗╢ц╡БчиЛцА╗шзИ"><a href="#_1-sub-reactor-хдДчРЖ-op-read-ф║Лф╗╢ц╡БчиЛцА╗шзИ" class="header-anchor">#</a> 1. Sub Reactor хдДчРЖ OP_READ ф║Лф╗╢ц╡БчиЛцА╗шзИ</h2> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191543052.webp" alt="хЫ╛чЙЗ"></p> <p>ховцИ╖члпхПСш╡╖ч│╗ч╗Я IO ш░ГчФихРСцЬНхКбчлпхПСщАБцХ░цНоф╣ЛхРОя╝Мх╜Уч╜Сч╗ЬцХ░цНохИ░ш╛╛цЬНхКбчлпчЪДч╜СхНбх╣╢ч╗Пш┐ЗхЖЕца╕хНПшооцаИчЪДхдДчРЖя╝МцЬАч╗ИцХ░цНохИ░ш╛╛ Socket чЪДцОецФ╢ч╝УхЖ▓хМ║ф╣ЛхРОя╝МSub Reactor ш╜ошпвхИ░ NioSocketChannel ф╕КчЪД <code>OP_READф║Лф╗╢</code> х░▒ч╗кя╝МщЪПхРО Sub Reactor ч║┐чиЛх░▒ф╝Ъф╗О JDK Selector ф╕КчЪДщШ╗хбЮш╜ошпв API<code>selector.select(timeoutMillis)</code>ш░ГчФиф╕нш┐ФхЫЮуАВш╜мшАМхО╗хдДчРЖ NioSocketChannel ф╕КчЪД<code>OP_READф║Лф╗╢</code>уАВ</p> <blockquote><p>ц│ицДПш┐ЩщЗМчЪД Reactor ф╕║ш┤Яш┤гхдДчРЖховцИ╖члпш┐ЮцОечЪД Sub ReactorуАВш┐ЮцОечЪДч▒╗хЮЛф╕║ NioSocketChannelя╝МхдДчРЖчЪДф║Лф╗╢ф╕║ OP_READ ф║Лф╗╢уАВ</p></blockquote> <p>хЬиф╣ЛхЙНчЪДцЦЗчлаф╕нчмФшАЕх╖▓ч╗ПхдЪцмбх╝║ш░Гш┐Зф║Жя╝МReactor хЬихдДчРЖ Channel ф╕КчЪД IO ф║Лф╗╢хЕехПгхЗ╜цХ░ф╕║<code>NioEventLoop#processSelectedKey</code>уАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">NioEventLoop</span> <span class="token keyword">extends</span> <span class="token class-name">SingleThreadEventLoop</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processSelectedKey</span><span class="token punctuation">(</span><span class="token class-name">SelectionKey</span> k<span class="token punctuation">,</span> <span class="token class-name">AbstractNioChannel</span> ch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">AbstractNioChannel<span class="token punctuation">.</span>NioUnsafe</span> unsafe <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> readyOps <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">readyOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readyOps <span class="token operator">&amp;</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_CONNECT</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>хдДчРЖ<span class="token constant">OP_CONNECT</span>ф║Лф╗╢<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>


            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readyOps <span class="token operator">&amp;</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_WRITE</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>хдДчРЖ<span class="token constant">OP_WRITE</span>ф║Лф╗╢<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>


            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readyOps <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_READ</span> <span class="token operator">|</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_ACCEPT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> readyOps <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//цЬмцЦЗщЗНчВ╣хдДчРЖOP_ACCEPTф║Лф╗╢</span>
                unsafe<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CancelledKeyException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            unsafe<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">voidPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>ш┐ЩщЗМщЬАшжБщЗНчВ╣х╝║ш░ГчЪДцШпя╝Мх╜УхЙНчЪДцЙзшбМч║┐чиЛчО░хЬих╖▓ч╗ПхПШцИРф║Ж Sub Reactorя╝МшАМ Sub Reactor ф╕Кц│ихЖМчЪДцнгцШп netty ховцИ╖члп NioSocketChannel ш┤Яш┤гхдДчРЖш┐ЮцОеф╕КчЪДшп╗хЖЩф║Лф╗╢уАВ</p> <p>цЙАф╗еш┐ЩщЗМхЕехПгхЗ╜цХ░чЪДхПВцХ░<code>AbstractNioChannel ch</code>хИЩцШп IO х░▒ч╗кчЪДховцИ╖члпш┐ЮцОе<code>NioSocketChannel</code>уАВ</p> <p>х╝Ахд┤щАЪш┐З<code>ch.unsafe()</code>шО╖хПЦхИ░чЪД NioUnsafe цУНф╜Ьч▒╗цнгцШп NioSocketChannel ф╕нхп╣х║Хх▒В JDK NIO SocketChannel чЪД Unsafe х║Хх▒ВцУНф╜Ьч▒╗уАВхоЮчО░ч▒╗хЮЛф╕║<code>NioByteUnsafe</code>хоЪф╣ЙхЬиф╕ЛхЫ╛ч╗зцЙ┐ч╗УцЮДф╕нчЪД<code>AbstractNioByteChannel</code>чИ╢ч▒╗ф╕нуАВ</p> <p>![хЫ╛чЙЗ](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>ф╕ЛщЭвцИСф╗мхИ░<code>NioByteUnsafe#read</code>цЦ╣ц│Хф╕нцЭечЬЛф╕Л Netty хп╣<code>OP_READф║Лф╗╢</code>чЪДхЕ╖ф╜УхдДчРЖш┐ЗчиЛя╝Ъ</p> <h2 id="_2-netty-цОецФ╢ч╜Сч╗ЬцХ░цНоц╡БчиЛцА╗шзИ"><a href="#_2-netty-цОецФ╢ч╜Сч╗ЬцХ░цНоц╡БчиЛцА╗шзИ" class="header-anchor">#</a> 2. Netty цОецФ╢ч╜Сч╗ЬцХ░цНоц╡БчиЛцА╗шзИ</h2> <p>цИСф╗мчЫ┤цОецМЙчЕзшАБшзДчЯйя╝МхЕИф╗ОцХ┤ф╜Уф╕КцККцХ┤ф╕к OP_READ ф║Лф╗╢чЪДщА╗ш╛СхдДчРЖцбЖцЮ╢цПРхПЦхЗ║цЭея╝Мшойхдзхо╢хЕИцА╗ф╜Уф┐пшзЖф╕Лц╡БчиЛхЕиш▓Мя╝МчД╢хРОхЬищТИхп╣цпПф╕кца╕х┐ГчВ╣ф╜Нш┐ЫшбМхРДф╕кхЗ╗ча┤уАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191131609.png" alt="хЫ╛чЙЗ"></p> <blockquote><p>ц╡БчиЛф╕нчЫ╕хЕ│ч╜очБ░чЪДцнещкдф╕║ Netty хдДчРЖш┐ЮцОехЕ│щЧнцЧ╢чЪДщА╗ш╛Ся╝МхТМцЬмцЦЗф╕╗цЧицЧахЕ│я╝МцИСф╗мш┐ЩщЗМцЪВцЧ╢х┐╜чХея╝МчнЙхРОч╗нчмФшАЕф╗Лч╗Нш┐ЮцОехЕ│щЧнцЧ╢я╝Мф╝ЪхНХчЛмх╝Аф╕АчпЗцЦЗчлашпжч╗Жф╕║хдзхо╢ф╗Лч╗НуАВ</p></blockquote> <p>ф╗Оф╕КщЭвш┐Щх╝а Netty цОецФ╢ч╜Сч╗ЬцХ░цНоцА╗ф╜Уц╡БчиЛхЫ╛хПпф╗ечЬЛхЗ║ NioSocketChannel хЬицОецФ╢ч╜Сч╗ЬцХ░цНочЪДцХ┤ф╕кц╡БчиЛхТМцИСф╗мхЬиф╕КчпЗцЦЗчла<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484184&amp;idx=1&amp;sn=726877ce28cf6e5d2ac3225fae687f19&amp;chksm=ce77c55ff9004c493b592288819dc4d4664b5949ee97fed977b6558bc517dad0e1f73fab0f46&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКNetty хжВф╜ХщлШцХИцОецФ╢ч╜Сч╗Ьш┐ЮцОеуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕нф╗Лч╗НчЪД NioServerSocketChannel хЬицОецФ╢ховцИ╖члпш┐ЮцОецЧ╢чЪДц╡БчиЛхЬицА╗ф╜УцбЖцЮ╢ф╕КцШпф╕Аца╖чЪДуАВ</p> <p>NioSocketChannel хЬицОецФ╢ч╜Сч╗ЬцХ░цНочЪДш┐ЗчиЛхдДчРЖф╕ня╝Мф╣ЯцШпщАЪш┐ЗхЬиф╕Аф╕к<code>do{....}while(...)</code>х╛кчОп read loop ф╕нф╕НцЦнчЪДх╛кчОпшп╗хПЦш┐ЮцОе NioSocketChannel ф╕КчЪДцХ░цНоуАВ</p> <p>хРМца╖хЬи NioSocketChannel шп╗хПЦш┐ЮцОецХ░цНочЪД read loop ф╕нф╣ЯцШпхПЧцЬАхдзшп╗хПЦцмбцХ░чЪДщЩРхИ╢уАВщ╗ШшодщЕНч╜оцЬАхдЪхПкшГ╜шп╗хПЦ 16 цмбя╝Мш╢Еш┐З 16 цмбцЧашо║цндцЧ╢ NioSocketChannel ф╕нцШпхРжш┐ШцЬЙцХ░цНохПпшп╗щГ╜ф╕НшГ╜хЬиш┐ЫшбМшп╗хПЦф║ЖуАВ</p> <p>ш┐ЩщЗМ read loop х╛кчОпцЬАхдзшп╗хПЦцмбцХ░хПпхЬихРпхКищЕНч╜оч▒╗ ServerBootstrap ф╕нщАЪш┐З<code>ChannelOption.MAX_MESSAGES_PER_READ</code>щАЙщб╣шо╛ч╜оя╝Мщ╗Шшодф╕║ 16уАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">MAX_MESSAGES_PER_READ</span><span class="token punctuation">,</span> шЗкхоЪф╣ЙцмбцХ░<span class="token punctuation">)</span>
</code></pre></div><p>**Netty ш┐ЩщЗМф╕║ф╗Аф╣ИщЭЮх╛ЧщЩРхИ╢ read loop чЪДцЬАхдзшп╗хПЦцмбцХ░хСвя╝Я**ф╕║ф╗Аф╣Иф╕НхЬи read loop ф╕нф╕АцмбцАзцККцХ░цНошп╗хПЦхоМхСвя╝Я</p> <p>ш┐ЩцЧ╢хАЩх░▒цШпшАГщкМцИСф╗мхдзх▒АшзВчЪДцЧ╢хАЩф║Жя╝МхЬихЙНш╛╣чЪДцЦЗчлаф╗Лч╗Нф╕нцИСф╗мцПРхИ░ Netty чЪД IO цибхЮЛф╕║ф╕╗ф╗О Reactor ч║┐чиЛч╗ДцибхЮЛя╝МхЬи Sub Reactor Group ф╕нхМЕхРлф║ЖхдЪф╕к Sub Reactor ф╕УщЧичФиф║ОчЫСхРмхдДчРЖховцИ╖члпш┐ЮцОеф╕КчЪД IO ф║Лф╗╢уАВ</p> <p>ф╕║ф║ЖшГ╜хдЯщлШцХИцЬЙх║ПчЪДхдДчРЖхЕищЗПховцИ╖члпш┐ЮцОеф╕КчЪДшп╗хЖЩф║Лф╗╢я╝МNetty х░ЖцЬНхКбчлпцЙ┐ш╜╜чЪДхЕищЗПховцИ╖члпш┐ЮцОехИЖцСКхИ░хдЪф╕к Sub Reactor ф╕нхдДчРЖя╝МхРМцЧ╢ф╣ЯшГ╜ф┐ЭшпБ<code>Channelф╕КIOхдДчРЖчЪДч║┐чиЛхоЙхЕицАз</code>уАВ</p> <p>хЕ╢ф╕нф╕Аф╕к Channel хПкшГ╜хИЖщЕНч╗Щф╕Аф╕кхЫ║хоЪчЪД ReactorуАВф╕Аф╕к Reactor ш┤Яш┤гхдДчРЖхдЪф╕к Channel ф╕КчЪД IO х░▒ч╗кф║Лф╗╢я╝МReactor ф╕О Channel ф╣ЛщЧ┤чЪДхп╣х║ФхЕ│ч│╗хжВф╕ЛхЫ╛цЙАчд║я╝Ъ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191544903.webp" alt="хЫ╛чЙЗ"></p> <p>шАМф╕Аф╕к Sub Reactor ф╕Кц│ихЖМф║ЖхдЪф╕к NioSocketChannelя╝МNetty ф╕НхПпшГ╜хЬиф╕Аф╕к NioSocketChannel ф╕КцЧащЩРхИ╢чЪДхдДчРЖф╕ЛхО╗я╝МшжБх░Жшп╗хПЦцХ░цНочЪДцЬ║ф╝ЪхЭЗхМАхИЖцСКч╗ЩхЕ╢ф╗Ц NioSocketChannelя╝МцЙАф╗ещЬАшжБщЩРхоЪцпПф╕к NioSocketChannel ф╕КчЪДцЬАхдзшп╗хПЦцмбцХ░уАВ</p> <p>цндхдЦя╝МSub Reactor щЩдф║ЖщЬАшжБчЫСхРмхдДчРЖцЙАцЬЙц│ихЖМхЬихоГф╕Кш╛╣чЪД NioSocketChannel ф╕нчЪД IO х░▒ч╗кф║Лф╗╢ф╣ЛхдЦя╝Мш┐ШщЬАшжБшЕ╛хЗ║ф║Лф╗╢цЭехдДчРЖцЬЙчФицИ╖ч║┐чиЛцПРф║дш┐ЗцЭечЪДх╝Вцнеф╗╗хКбуАВф╗Ош┐Щф╕АчВ╣чЬЛя╝МNetty ф╣Яф╕Нф╝Ъф╕АчЫ┤хБЬчХЩхЬи NioSocketChannel чЪД IO хдДчРЖф╕КуАВцЙАф╗ещЩРхИ╢ read loop чЪДцЬАхдзшп╗хПЦцмбцХ░цШпщЭЮх╕╕х┐ЕшжБчЪДуАВ</p> <blockquote><p>хЕ│ф║О Reactor чЪДцХ┤ф╜Уш┐Рш╜мцЮ╢цЮДя╝Мхп╣ч╗ЖшКВщГихИЖцДЯхЕ┤ш╢гчЪДхРМхнжхПпф╗ехЫЮчЬЛф╕ЛчмФшАЕчЪД<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484087&amp;idx=1&amp;sn=0c065780e0f05c23c8e6465ede86cba0&amp;chksm=ce77c4f0f9004de63be369a664105708bc5975b52993f4a6df223caed34cc1ef6185a16acd75&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКф╕АцЦЗшБКщАП Netty ца╕х┐Гх╝ХцУО Reactor чЪДш┐Рш╜мцЮ╢цЮДуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ш┐ЩчпЗцЦЗчлауАВ</p></blockquote> <p>цЙАф╗ехЯ║ф║Ош┐Щф╕кхОЯхЫая╝МцИСф╗мщЬАшжБхЬи read loop х╛кчОпф╕ня╝МцпПх╜УщАЪш┐З<code>doReadBytes</code>цЦ╣ц│Хф╗О NioSocketChannel ф╕ншп╗хПЦхИ░цХ░цНоцЧ╢я╝ИцЦ╣ц│Хш┐ФхЫЮхА╝ф╝Ъхдзф║О 0я╝Мх╣╢шо░х╜ХхЬи allocHandle.lastBytesRead ф╕ня╝Йя╝МщГ╜щЬАшжБщАЪш┐З<code>allocHandle.incMessagesRead(1)</code>цЦ╣ц│Хч╗Яшобх╖▓ч╗Пшп╗хПЦчЪДцмбцХ░уАВх╜Уш╛╛хИ░ 16 цмбцЧ╢ф╕Нчоб NioSocketChannel цШпхРжш┐ШцЬЙцХ░цНохПпшп╗я╝МщГ╜щЬАшжБхЬи read loop цЬлх░╛щААхЗ║х╛кчОпуАВш╜мхО╗цЙзшбМ Sub Reactor ф╕КчЪДх╝Вцнеф╗╗хКбуАВф╗ехПКхЕ╢ф╗Ц NioSocketChannel ф╕КчЪД IO х░▒ч╗кф║Лф╗╢уАВх╣│хЭЗхИЖщЕНя╝МщЫищЬ▓хЭЗц▓╛я╝Бя╝Б</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">MaxMessageHandle</span> <span class="token keyword">implements</span> <span class="token class-name">ExtendedHandle</span> <span class="token punctuation">{</span>

        <span class="token comment">//read loopцА╗хЕ▒шп╗хПЦф║ЖхдЪх░Сцмб</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> totalMessages<span class="token punctuation">;</span>

       <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">incMessagesRead</span><span class="token punctuation">(</span><span class="token keyword">int</span> amt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            totalMessages <span class="token operator">+=</span> amt<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>цЬмцмб read loop шп╗хПЦхИ░чЪДцХ░цНохдзх░Пф╝Ъшо░х╜ХхЬи<code>allocHandle.lastBytesRead</code>ф╕н</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">MaxMessageHandle</span> <span class="token keyword">implements</span> <span class="token class-name">ExtendedHandle</span> <span class="token punctuation">{</span>

         <span class="token comment">//цЬмцмбread loopшп╗хПЦхИ░чЪДхнЧшКВцХ░</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> lastBytesRead<span class="token punctuation">;</span>
        <span class="token comment">//цХ┤ф╕кread loopх╛кчОпцА╗хЕ▒шп╗хПЦчЪДхнЧшКВцХ░</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> totalBytesRead<span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lastBytesRead</span><span class="token punctuation">(</span><span class="token keyword">int</span> bytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            lastBytesRead <span class="token operator">=</span> bytes<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                totalBytesRead <span class="token operator">+=</span> bytes<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>lastBytesRead &lt; 0</code>я╝Ъшбичд║ховцИ╖члпф╕╗хКихПСш╡╖ф║Жш┐ЮцОехЕ│щЧнц╡БчиЛя╝МNetty х╝АхзЛш┐ЮцОехЕ│щЧнхдДчРЖц╡БчиЛуАВш┐Щф╕кхТМцЬмцЦЗчЪДф╕╗цЧицЧахЕ│я╝МцИСф╗мхЕИф╕НчФичобуАВхРОщЭвчмФшАЕф╝Ъф╕УщЧичФиф╕АчпЗцЦЗчлацЭешпжшзгхЕ│щЧнц╡БчиЛуАВ</li> <li><code>lastBytesRead = 0</code>я╝Ъшбичд║х╜УхЙН NioSocketChannel ф╕КчЪДцХ░цНох╖▓ч╗ПхЕищГишп╗хПЦхоМцпХя╝Мц▓бцЬЙцХ░цНохПпшп╗ф║ЖуАВцЬмцмб OP_READ ф║Лф╗╢хЬЖц╗бхдДчРЖхоМцпХя╝МхПпф╗ех╝Ах╝Ах┐Гх┐ГчЪДщААхЗ║ read loopуАВ</li> <li>х╜У<code>lastBytesRead &gt; 0</code>я╝Ъшбичд║хЬицЬмцмб read loop ф╕нф╗О NioSocketChannel ф╕ншп╗хПЦхИ░ф║ЖцХ░цНоя╝Мф╝ЪхЬи NioSocketChannel чЪД pipeline ф╕ншзжхПС ChannelRead ф║Лф╗╢уАВш┐ЫшАМхЬи pipeline ф╕нш┤Яш┤г IO хдДчРЖчЪД ChannelHandelr ф╕нхУНх║Фя╝МхдДчРЖч╜Сч╗Ьшп╖ц▒ВуАВ</li></ul> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191131926.png" alt="хЫ╛чЙЗ">fir</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>хдДчРЖч╜Сч╗Ьшп╖ц▒Вя╝МцпФхжВшзгчаБ<span class="token punctuation">,</span>хПНх║ПхИЧхМЦчнЙцУНф╜Ь<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цЬАхРОф╝ЪхЬи read loop х╛кчОпчЪДцЬлх░╛ш░ГчФи<code>allocHandle.continueReading()</code>хИдцЦнцШпхРжч╗УцЭЯцЬмцмб read loop х╛кчОпуАВш┐ЩщЗМчЪДч╗УцЭЯх╛кчОпцЭбф╗╢чЪДхИдцЦнф╝ЪцпФцИСф╗мхЬиф╗Лч╗Н NioServerSocketChannel цОецФ╢ш┐ЮцОецЧ╢чЪДхИдцЦнцЭбф╗╢хдНцЭВх╛ИхдЪя╝МчмФшАЕф╝Ъх░Жш┐Щф╕кхИдцЦнцЭбф╗╢чЪДшпжч╗ЖшзгцЮРцФ╛хЬицЦЗчлахРОщЭвч╗ЖшКВщГихИЖф╕║хдзхо╢шзгшп╗я╝Мш┐ЩщЗМхдзхо╢хПкщЬАшжБцККцПбцА╗ф╜Уца╕х┐Гц╡БчиЛя╝Мф╕НщЬАшжБхЕ│ц│ихдкхдЪч╗ЖшКВуАВ</p> <p>цА╗ф╜Уф╕КхЬи NioSocketChannel ф╕ншп╗хПЦч╜Сч╗ЬцХ░цНочЪД read loop х╛кчОпч╗УцЭЯцЭбф╗╢щЬАшжБц╗бш╢│ф╗еф╕ЛхЗачВ╣я╝Ъ</p> <ul><li>х╜УхЙН NioSocketChannel ф╕нчЪДцХ░цНох╖▓ч╗ПхЕищГишп╗хПЦхоМцпХя╝МхИЩщААхЗ║х╛кчОпуАВ</li> <li>цЬмш╜о read loop хжВцЮЬц▓бцЬЙшп╗хИ░ф╗╗ф╜ХцХ░цНоя╝МхИЩщААхЗ║х╛кчОпуАВ</li> <li>read loop чЪДшп╗хПЦцмбцХ░ш╛╛хИ░ 16 цмбя╝МщААхЗ║х╛кчОпуАВ</li></ul> <p>х╜Уц╗бш╢│ш┐ЩщЗМчЪД read loop щААхЗ║цЭбф╗╢ф╣ЛхРОя╝МSub Reactor ч║┐чиЛх░▒ф╝ЪщААхЗ║х╛кчОпя╝МщЪПхРОф╝Ъш░ГчФи<code>allocHandle.readComplete()</code>цЦ╣ц│Хца╣цНоцЬмш╜о read loop цА╗хЕ▒шп╗хПЦхИ░чЪДхнЧшКВцХ░<code>totalBytesRead</code>цЭехЖ│хоЪцШпхРжхп╣чФиф║ОцОецФ╢ф╕Лф╕Аш╜о OP_READ ф║Лф╗╢цХ░цНочЪД ByteBuffer ш┐ЫшбМцЙйхо╣цИЦшАЕч╝йхо╣уАВ</p> <p>цЬАхРОхЬи NioSocketChannel чЪД pipeline ф╕ншзжхПС<code>ChannelReadCompleteф║Лф╗╢</code>я╝МщАЪчЯе ChannelHandler цЬмцмб OP_READ ф║Лф╗╢х╖▓ч╗ПхдДчРЖхоМцпХуАВ</p> <p>![хЫ╛чЙЗ](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)fireChannelReadComplete.png</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>хдДчРЖч╜Сч╗Ьшп╖ц▒Вя╝МцпФхжВшзгчаБ<span class="token punctuation">,</span>хПНх║ПхИЧхМЦчнЙцУНф╜Ь<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelReadComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>цЬмцмб<span class="token constant">OP_READ</span>ф║Лф╗╢хдДчРЖхоМцпХ<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>хЖ│хоЪцШпхРжхРСховцИ╖члпхУНх║ФхдДчРЖч╗УцЮЬ<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-1-channelread-ф╕О-channelreadcomplete-ф║Лф╗╢чЪДхМ║хИл"><a href="#_2-1-channelread-ф╕О-channelreadcomplete-ф║Лф╗╢чЪДхМ║хИл" class="header-anchor">#</a> 2.1 ChannelRead ф╕О ChannelReadComplete ф║Лф╗╢чЪДхМ║хИл</h3> <blockquote><p>цЬЙф║Ых░Пф╝Щф╝┤хПпшГ╜хп╣ Netty ф╕нчЪДф╕Аф║Ыф╝ацТнф║Лф╗╢шзжхПСчЪДцЧ╢цЬ║я╝МцИЦшАЕф║Лф╗╢ф╣ЛщЧ┤чЪДхМ║хИлчРЖшзгчЪДф╕НцШпх╛Иц╕ЕцеЪя╝МцжВх┐╡хо╣цШУц╖╖ц╖ЖуАВхЬихРОщЭвчЪДцЦЗчлаф╕нчмФшАЕф╣Яф╝Ъф╗Оц║РчаБчЪДшзТх║жхЗ║хПСч╗Щхдзхо╢шп┤ц╕ЕцеЪ Netty ф╕нхоЪф╣ЙчЪДцЙАцЬЙх╝Вцнеф║Лф╗╢я╝Мф╗ехПКш┐Щф║Ыф║Лф╗╢ф╣ЛщЧ┤чЪДхМ║хИлхТМшБФч│╗хТМшзжхПСцЧ╢цЬ║я╝Мф╝ацТнцЬ║хИ╢уАВ</p></blockquote> <p>ш┐ЩщЗМцИСф╗мф╕╗шжБцОвшоицЬмцЦЗф╕╗щвШф╕нц╢ЙхПКхИ░чЪДф╕дф╕кф║Лф╗╢я╝ЪChannelRead ф║Лф╗╢ф╕О ChannelReadComplete ф║Лф╗╢уАВ</p> <p>ф╗Оф╕Кш┐░ф╗Лч╗НчЪД Netty цОецФ╢ч╜Сч╗ЬцХ░цНоц╡БчиЛцА╗шзИф╕нцИСф╗мхПпф╗ечЬЛхЗ║<code>ChannelReadф║Лф╗╢</code>хТМ<code>ChannelReadCompleteф║Лф╗╢</code>цШпф╕Нф╕Аца╖чЪДя╝Мф╜ЖцШпхп╣ф║ОхИЪцОешзж Netty чЪДх░Пф╝Щф╝┤цЭешп┤ф╗ОхС╜хРНф╕Кф╣Нф╕АчЬЛцДЯшзЙхПИх╖оф╕НхдЪуАВ</p> <p>ф╕ЛщЭвцИСф╗мцЭечЬЛш┐Щф╕дф╕кф║Лф╗╢ф╣ЛщЧ┤чЪДх╖охИля╝Ъ</p> <p>Netty цЬНхКбчлпхп╣ф║Оф╕Ацмб OP_READ ф║Лф╗╢чЪДхдДчРЖя╝Мф╝ЪхЬиф╕Аф╕к<code>do{}while()</code>х╛кчОп read loop ф╕нхИЖхдЪцмбф╗ОховцИ╖члп NioSocketChannel ф╕ншп╗хПЦч╜Сч╗ЬцХ░цНоуАВцпПцмбшп╗хПЦцИСф╗мхИЖщЕНчЪД ByteBuffer хо╣щЗПхдзх░Пя╝МхИЭхзЛхо╣щЗПф╕║ 2048уАВ</p> <ul><li><code>ChanneReadф║Лф╗╢</code>я╝Ъф╕Ацмбх╛кчОпшп╗хПЦф╕АцмбцХ░цНоя╝Мх░▒шзжхПСф╕Ацмб<code>ChannelReadф║Лф╗╢</code>уАВцЬмцмбцЬАхдЪшп╗хПЦхЬи read loop х╛кчОпх╝АхзЛхИЖщЕНчЪД DirectByteBuffer хо╣щЗПхдзх░ПуАВш┐Щф╕кхо╣щЗПф╝ЪхКицАБш░ГцХ┤я╝МцЦЗчлахРОч╗нчмФшАЕф╝Ъшпжч╗Жф╗Лч╗НуАВ</li> <li><code>ChannelReadCompleteф║Лф╗╢</code>я╝Ъх╜Ушп╗хПЦф╕НхИ░цХ░цНоцИЦшАЕф╕Нц╗бш╢│<code>continueReading</code>чЪДф╗╗цДПф╕Аф╕кцЭбф╗╢х░▒ф╝ЪщААхЗ║ read loopя╝Мш┐ЩцЧ╢х░▒ф╝ЪшзжхПС<code>ChannelReadCompleteф║Лф╗╢</code>уАВшбичд║цЬмцмб<code>OP_READф║Лф╗╢</code>хдДчРЖхоМцпХуАВ</li></ul> <blockquote><p><strong>ш┐ЩщЗМщЬАшжБчЙ╣хИлц│ицДПф╕Л</strong>шзжхПС<code>ChannelReadCompleteф║Лф╗╢</code>х╣╢ф╕Нф╗гшби NioSocketChannel ф╕нчЪДцХ░цНох╖▓ч╗Пшп╗хПЦхоМф║Жя╝МхПкшГ╜шп┤цШОцЬмцмб<code>OP_READф║Лф╗╢</code>хдДчРЖхоМцпХуАВхЫаф╕║цЬЙхПпшГ╜цШпховцИ╖члпхПСщАБчЪДцХ░цНохдкхдЪя╝МNetty шп╗ф║Ж<code>16цмб</code>ш┐Шц▓бшп╗хоМя╝МщВгх░▒хПкшГ╜чнЙхИ░ф╕Лцмб<code>OP_READф║Лф╗╢</code>хИ░цЭечЪДцЧ╢хАЩхЬиш┐ЫшбМшп╗хПЦф║ЖуАВ</p></blockquote> <hr> <p>ф╗еф╕КхЖЕхо╣х░▒цШп Netty хЬицОецФ╢ховцИ╖члпхПСщАБч╜Сч╗ЬцХ░цНочЪДхЕищГица╕х┐ГщА╗ш╛СуАВчЫохЙНф╕║цнвцИСф╗мш┐ШцЬкц╢ЙхПКхИ░ш┐ЩщГихИЖчЪДф╕╗х╣▓ца╕х┐Гц║РчаБя╝МчмФшАЕцГ│чЪДцШпхЕИч╗Щхдзхо╢цККца╕х┐ГщА╗ш╛Сшо▓шзгц╕ЕцеЪф╣ЛхРОя╝Мш┐Щца╖чРЖшзгш╡╖цЭеца╕х┐Гф╕╗х╣▓ц║РчаБф╝ЪцЫ┤хКац╕ЕцЩ░щАПх╜╗уАВ</p> <p>ч╗Пш┐ЗхЙНш╛╣хп╣ч╜Сч╗ЬцХ░цНоцОецФ╢чЪДца╕х┐ГщА╗ш╛Сф╗Лч╗Ня╝МчмФшАЕхЬицККш┐Щх╝ац╡БчиЛхЫ╛цФ╛хЗ║цЭея╝Мхдзхо╢хПпф╗еч╗УхРИш┐Щх╝ахЫ╛хЬицЭехЫЮцГ│ф╕Лф╕╗х╣▓ца╕х┐ГщА╗ш╛СуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191131609.png" alt="хЫ╛чЙЗ"></p> <p>ф╕ЛщЭвчмФшАЕф╝Ъч╗УхРИш┐Щх╝ац╡БчиЛхЫ╛я╝Мч╗Щхдзхо╢цККш┐ЩщГихИЖчЪДца╕х┐Гф╕╗х╣▓ц║РчаБцбЖцЮ╢х▒ХчО░хЗ║цЭея╝Мхдзхо╢хПпф╗ех░ЖцИСф╗мф╗Лч╗Нш┐ЗчЪДца╕х┐ГщА╗ш╛Сф╕Оф╕╗х╣▓ц║РчаБхБЪф╕кф╕Аф╕Ахп╣х║Фя╝Мш┐ШцШпщВгхПешАБшпЭя╝МцИСф╗мшжБф╗Оф╕╗х╣▓цбЖцЮ╢х▒ВщЭвцККцПбцХ┤ф╜УхдДчРЖц╡БчиЛя╝Мф╕НщЬАшжБшп╗цЗВцпПф╕АшбМф╗гчаБя╝МцЦЗчлахРОч╗нчмФшАЕф╝Ъх░Жш┐Щф╕кш┐ЗчиЛф╕нц╢ЙхПКхИ░чЪДца╕х┐ГчВ╣ф╜Нч╗Щхдзхо╢цЛЖх╝АцЭехРДф╕кхЗ╗ча┤я╝Бя╝Б</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191131492.png" alt="хЫ╛чЙЗ"></p> <h2 id="_3-ц║РчаБца╕х┐ГцбЖцЮ╢цА╗шзИ"><a href="#_3-ц║РчаБца╕х┐ГцбЖцЮ╢цА╗шзИ" class="header-anchor">#</a> 3. ц║РчаБца╕х┐ГцбЖцЮ╢цА╗шзИ</h2> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">ChannelConfig</span> config <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>хдДчРЖхНКхЕ│щЧнчЫ╕хЕ│ф╗гчаБчЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//шО╖хПЦNioSocketChannelчЪДpipeline</span>
        <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> <span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//PooledByteBufAllocator хЕ╖ф╜УчФиф║ОхоЮщЩЕхИЖщЕНByteBufчЪДхИЖщЕНхЩи</span>
    <span class="token keyword">final</span> <span class="token class-name">ByteBufAllocator</span> allocator <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//шЗкщАВх║ФByteBufхИЖщЕНхЩи AdaptiveRecvByteBufAllocator ,чФиф║ОхКицАБш░ГшКВByteBufхо╣щЗП</span>
    <span class="token comment">//щЬАшжБф╕ОхЕ╖ф╜УчЪДByteBufхИЖщЕНхЩищЕНхРИф╜┐чФи цпФхжВш┐ЩщЗМчЪДPooledByteBufAllocator</span>
    <span class="token keyword">final</span> <span class="token class-name">RecvByteBufAllocator<span class="token punctuation">.</span>Handle</span> allocHandle <span class="token operator">=</span> <span class="token function">recvBufAllocHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//allocHandlerчФиф║Оч╗ЯшобцпПцмбшп╗хПЦцХ░цНочЪДхдзх░Пя╝МцЦ╣ф╛┐ф╕ЛцмбхИЖщЕНхРИщАВхдзх░ПчЪДByteBuf</span>
    <span class="token comment">//щЗНч╜оц╕ЕщЩдф╕КцмбчЪДч╗ЯшобцМЗцаЗ</span>
    allocHandle<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ByteBuf</span> byteBuf <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> close <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token comment">//хИйчФиPooledByteBufAllocatorхИЖщЕНхРИщАВхдзх░ПчЪДbyteBuf хИЭхзЛхдзх░Пф╕║2048</span>
            byteBuf <span class="token operator">=</span> allocHandle<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>allocator<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//шо░х╜ХцЬмцмбшп╗хПЦф║ЖхдЪх░СхнЧшКВцХ░</span>
            allocHandle<span class="token punctuation">.</span><span class="token function">lastBytesRead</span><span class="token punctuation">(</span><span class="token function">doReadBytes</span><span class="token punctuation">(</span>byteBuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//хжВцЮЬцЬмцмбц▓бцЬЙшп╗хПЦхИ░ф╗╗ф╜ХхнЧшКВя╝МхИЩщААхЗ║х╛кчОп ш┐ЫшбМф╕Лф╕Аш╜оф║Лф╗╢ш╜ошпв</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>allocHandle<span class="token punctuation">.</span><span class="token function">lastBytesRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// nothing was read. release the buffer.</span>
                byteBuf<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                byteBuf <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                close <span class="token operator">=</span> allocHandle<span class="token punctuation">.</span><span class="token function">lastBytesRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>close<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>шбичд║ховцИ╖члпхПСш╡╖ш┐ЮцОехЕ│щЧн<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//read loopшп╗хПЦцХ░цНоцмбцХ░+1</span>
            allocHandle<span class="token punctuation">.</span><span class="token function">incMessagesRead</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//ховцИ╖члпNioSocketChannelчЪДpipelineф╕ншзжхПСChannelReadф║Лф╗╢</span>
            pipeline<span class="token punctuation">.</span><span class="token function">fireChannelRead</span><span class="token punctuation">(</span>byteBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//шзгщЩдцЬмцмбшп╗хПЦцХ░цНохИЖщЕНчЪДByteBufferх╝ХчФия╝МцЦ╣ф╛┐ф╕Лф╕Аш╜оread loopхИЖщЕН</span>
            byteBuf <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>allocHandle<span class="token punctuation">.</span><span class="token function">continueReading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//хИдцЦнцШпхРжх║Фшпеч╗зч╗нread loop</span>

        <span class="token comment">//ца╣цНоцЬмцмбread loopцА╗хЕ▒шп╗хПЦчЪДхнЧшКВцХ░я╝МхЖ│хоЪф╕ЛцмбцШпхРжцЙйхо╣цИЦшАЕч╝йхо╣</span>
        allocHandle<span class="token punctuation">.</span><span class="token function">readComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//хЬиNioSocketChannelчЪДpipelineф╕ншзжхПСChannelReadCompleteф║Лф╗╢я╝Мшбичд║ф╕Ацмбreadф║Лф╗╢хдДчРЖхоМцпХ</span>
        <span class="token comment">//ф╜Жш┐Щх╣╢ф╕Ншбичд║ ховцИ╖члпхПСщАБцЭечЪДцХ░цНох╖▓ч╗ПхЕищГишп╗хоМя╝МхЫаф╕║хжВцЮЬцХ░цНохдкхдЪчЪДшпЭя╝Мш┐ЩщЗМхПкф╝Ъшп╗хПЦ16цмбя╝МхЙйф╕ЛчЪДф╝ЪчнЙхИ░ф╕Лцмбreadф║Лф╗╢хИ░цЭехРОхЬихдДчРЖ</span>
        pipeline<span class="token punctuation">.</span><span class="token function">fireChannelReadComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХеш┐ЮцОехЕ│щЧнц╡БчиЛхдДчРЖ<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>ш┐ЩщЗМхЖНцмбх╝║ш░Гф╕Лх╜УхЙНцЙзшбМч║┐чиЛф╕║ Sub Reactor ч║┐чиЛя╝МхдДчРЖш┐ЮцОецХ░цНошп╗хПЦщА╗ш╛СцШпхЬи NioSocketChannel ф╕нуАВ</p></blockquote> <p>щжЦхЕИщАЪш┐З<code>config()</code>шО╖хПЦховцИ╖члп NioSocketChannel чЪД Channel щЕНч╜оч▒╗ NioSocketChannelConfigуАВ</p> <p>щАЪш┐З<code>pipeline()</code>шО╖хПЦ NioSocketChannel чЪД pipelineуАВцИСф╗мхЬи <a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484005&amp;idx=1&amp;sn=52f51269902a58f40d33208421109bc3&amp;chksm=ce77c422f9004d340e5b385ef6ba24dfba1f802076ace80ad6390e934173a10401e64e13eaeb&amp;token=1943348780&amp;lang=zh_CN&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКшпжч╗ЖхЫ╛шзг Netty Reactor хРпхКихЕиц╡БчиЛуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕АцЦЗф╕нцПРхИ░чЪД Netty цЬНхКбчлпцибцЭ┐цЙАф╕╛чЪДчд║ф╛Лф╕ня╝МNioSocketChannelde pipeline ф╕нхПкцЬЙф╕Аф╕к EchoChannelHandlerуАВ</p> <p>![хЫ╛чЙЗ](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)ховцИ╖члп channel pipeline ч╗УцЮД.png</p> <h3 id="_3-1-хИЖщЕН-directbytebuffer-цОецФ╢ч╜Сч╗ЬцХ░цНо"><a href="#_3-1-хИЖщЕН-directbytebuffer-цОецФ╢ч╜Сч╗ЬцХ░цНо" class="header-anchor">#</a> 3.1 хИЖщЕН DirectByteBuffer цОецФ╢ч╜Сч╗ЬцХ░цНо</h3> <p>Sub Reactor хЬицОецФ╢ NioSocketChannel ф╕КчЪД IO цХ░цНоцЧ╢я╝МщГ╜ф╝ЪхИЖщЕНф╕Аф╕к ByteBuffer чФицЭехнШцФ╛цОецФ╢хИ░чЪД IO цХ░цНоуАВ</p> <p>ш┐ЩщЗМхдзхо╢хПпшГ╜шзЙх╛ЧцпФш╛ГхеЗцАкя╝Мф╕║ф╗Аф╣ИхЬи NioSocketChannel цОецФ╢цХ░цНош┐ЩщЗМф╝ЪцЬЙф╕дф╕к ByteBuffer хИЖщЕНхЩихСвя╝Яф╕Аф╕кцШп ByteBufAllocatorя╝МхПжф╕Аф╕кцШп RecvByteBufAllocatorуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">ByteBufAllocator</span> allocator <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token class-name">RecvByteBufAllocator<span class="token punctuation">.</span>Handle</span> allocHandle <span class="token operator">=</span> <span class="token function">recvBufAllocHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>ш┐Щф╕дф╕к ByteBuffer хПИцЬЙф╗Аф╣ИхМ║хИлхТМшБФч│╗хСвя╝Я</strong></p> <p>хЬиф╕КчпЗцЦЗчла<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484184&amp;idx=1&amp;sn=726877ce28cf6e5d2ac3225fae687f19&amp;chksm=ce77c55ff9004c493b592288819dc4d4664b5949ee97fed977b6558bc517dad0e1f73fab0f46&amp;scene=21&amp;cur_album_id=2217816582418956300#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКцКУхИ░ Netty ф╕Аф╕к Bugя╝Мщб║х╕жцЭещАПх╜╗хЬ░шБКф╕Аф╕Л Netty цШпхжВф╜ХщлШцХИцОецФ╢ч╜Сч╗Ьш┐ЮцОеуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕ня╝МчмФшАЕф╕║ф║ЖщШРш┐░ф╕КчпЗцЦЗчлаф╕нцПРхИ░чЪД Netty хЬицОецФ╢ч╜Сч╗Ьш┐ЮцОецЧ╢чЪД Bug цЧ╢я╝МчоАхНХхТМхдзхо╢ф╗Лч╗Нф║Жф╕Лш┐Щф╕к RecvByteBufAllocatorуАВ</p> <p>хЬиф╕КчпЗцЦЗчлацПРхИ░чЪД NioServerSocketChannelConfig ф╕ня╝Мш┐ЩщЗМчЪД RecvByteBufAllocator ч▒╗хЮЛф╕║ ServerChannelRecvByteBufAllocatorуАВ</p> <p>![хЫ╛чЙЗ](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <blockquote><p>ш┐Шшо░х╛Чш┐Щф╕к ServerChannelRecvByteBufAllocator ч▒╗хЮЛхЬи<strong>4.1.69.final</strong>чЙИцЬмх╝ХхЕецШпф╕║ф║ЖшзгхЖ│чмФшАЕхЬиф╕КчпЗцЦЗчлаф╕нцПРхИ░чЪДщВгф╕к Bug хРЧя╝ЯхЬи<strong>4.1.69.final</strong>чЙИцЬмф╣ЛхЙНя╝МNioServerSocketChannelConfig ф╕нчЪД RecvByteBufAllocator ч▒╗хЮЛф╕║ AdaptiveRecvByteBufAllocatorуАВ</p></blockquote> <p>шАМхЬицЬмцЦЗф╕н NioSocketChannelConfig ф╕нчЪД RecvByteBufAllocator ч▒╗хЮЛф╕║ AdaptiveRecvByteBufAllocatorуАВ</p> <p>![хЫ╛чЙЗ](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>цЙАф╗еш┐ЩщЗМ<code>recvBufAllocHandle()</code>шО╖х╛ЧхИ░чЪД RecvByteBufAllocator ф╕║ AdaptiveRecvByteBufAllocatorуАВщб╛хРНцАЭф╣Йя╝Мш┐Щф╕кч▒╗хЮЛчЪД RecvByteBufAllocator хПпф╗еца╣цНо NioSocketChannel ф╕КцпПцмбхИ░цЭечЪД IO цХ░цНохдзх░ПцЭешЗкщАВх║ФхКицАБш░ГцХ┤ ByteBuffer чЪДхо╣щЗПуАВ</p> <p>хп╣ф║ОховцИ╖члп NioSocketChannel цЭешп┤я╝МхоГщЗМш╛╣хМЕхРлчЪД IO цХ░цНоцЧ╢ховцИ╖члпхПСщАБцЭечЪДч╜Сч╗ЬцХ░цНоя╝МщХ┐х║жцШпф╕НхоЪчЪДя╝МцЙАф╗ецЙНф╝ЪщЬАшжБш┐Щца╖ф╕Аф╕кхПпф╗еца╣цНоцпПцмб IO цХ░цНочЪДхдзх░ПцЭешЗкщАВх║ФхКицАБш░ГцХ┤хо╣щЗПчЪД ByteBuffer цЭецОецФ╢уАВ</p> <p>хжВцЮЬцИСф╗мцККчФиф║ОцОецФ╢цХ░цНочФичЪД ByteBuffer чЬЛхБЪф╕Аф╕кцб╢чЪДшпЭя╝МщВгф╣Их░ПцХ░цНочФихдзцб╢шгЕцИЦшАЕхдзцХ░цНочФих░Пцб╢шгЕшВпхоЪцШпф╕НхРИщАВчЪДя╝МцЙАф╗ецИСф╗мщЬАшжБца╣цНоцОецФ╢цХ░цНочЪДхдзх░ПцЭехКицАБш░ГцХ┤цб╢чЪДхо╣щЗПуАВшАМ AdaptiveRecvByteBufAllocator чЪДф╜ЬчФицнгцШпчФицЭеца╣цНоцпПцмбцОецФ╢цХ░цНочЪДхо╣щЗПхдзх░ПцЭехКицАБш░ГцХ┤ ByteBuffer чЪДхо╣щЗПчЪДуАВ</p> <p>чО░хЬи RecvByteBufAllocator чмФшАЕф╕║хдзхо╢шзгщЗКц╕ЕцеЪф║Жя╝МцОеф╕ЛцЭецИСф╗мч╗зч╗нчЬЛ ByteBufAllocatorуАВ</p> <blockquote><p>хдзхо╢ш┐ЩщЗМщЬАшжБц│ицДПчЪДцШп AdaptiveRecvByteBufAllocator х╣╢ф╕Нф╝ЪчЬЯцнгчЪДхО╗хИЖщЕН ByteBufferя╝МхоГхПкцШпш┤Яш┤гхКицАБш░ГцХ┤хИЖщЕН ByteBuffer чЪДхдзх░ПуАВ</p></blockquote> <p>шАМчЬЯцнгхЕ╖ф╜УцЙзшбМхЖЕхнШхИЖщЕНхКиф╜ЬчЪДцШпш┐ЩщЗМчЪД ByteBufAllocator ч▒╗хЮЛф╕║ PooledByteBufAllocatorуАВхоГф╝Ъца╣цНо AdaptiveRecvByteBufAllocator хКицАБш░ГцХ┤хЗ║цЭечЪДхдзх░ПхО╗чЬЯцнгчЪДчФ│шп╖хЖЕхнШхИЖщЕН ByteBufferуАВ</p> <blockquote><p>PooledByteBufAllocator ф╕║ Netty ф╕нчЪДхЖЕхнШц▒ая╝МчФицЭечобчРЖхаЖхдЦхЖЕхнШ DirectByteBufferуАВ</p></blockquote> <p>AdaptiveRecvByteBufAllocator ф╕нчЪД allocHandle хЬиф╕КчпЗцЦЗчлаф╕нцИСф╗мф╣Яф╗Лч╗Нш┐Зф║Жя╝МхоГчЪДхоЮщЩЕч▒╗хЮЛф╕║ MaxMessageHandleуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AdaptiveRecvByteBufAllocator</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultMaxMessagesRecvByteBufAllocator</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Handle</span> <span class="token function">newHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HandleImpl</span><span class="token punctuation">(</span>minIndex<span class="token punctuation">,</span> maxIndex<span class="token punctuation">,</span> initial<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HandleImpl</span> <span class="token keyword">extends</span> <span class="token class-name">MaxMessageHandle</span> <span class="token punctuation">{</span>
                  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хЬи MaxMessageHandle ф╕нхМЕхРлф║ЖчФиф║ОхКицАБш░ГцХ┤ ByteBuffer хо╣щЗПчЪДч╗ЯшобцМЗцаЗуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code>   <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">MaxMessageHandle</span> <span class="token keyword">implements</span> <span class="token class-name">ExtendedHandle</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">ChannelConfig</span> config<span class="token punctuation">;</span>

        <span class="token comment">//чФиф║ОцОзхИ╢цпПцмбread loopщЗМцЬАхдзхПпф╗ех╛кчОпшп╗хПЦчЪДцмбцХ░я╝Мщ╗Шшодф╕║16цмб</span>
        <span class="token comment">//хПпхЬихРпхКищЕНч╜оч▒╗ServerBootstrapф╕нщАЪш┐ЗChannelOption.MAX_MESSAGES_PER_READщАЙщб╣шо╛ч╜оуАВ</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> maxMessagePerRead<span class="token punctuation">;</span>

        <span class="token comment">//чФиф║Оч╗Яшобread loopф╕нцА╗хЕ▒цОецФ╢чЪДш┐ЮцОеф╕кцХ░я╝МNioSocketChannelф╕ншбичд║шп╗хПЦцХ░цНочЪДцмбцХ░</span>
        <span class="token comment">//цпПцмбread loopх╛кчОпхРОф╝Ъш░ГчФиallocHandle.incMessagesReadхвЮхКашо░х╜ХцОецФ╢хИ░чЪДш┐ЮцОеф╕кцХ░</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> totalMessages<span class="token punctuation">;</span>

        <span class="token comment">//чФиф║Оч╗ЯшобхЬиread loopф╕нцА╗хЕ▒цОецФ╢хИ░ховцИ╖члпш┐ЮцОеф╕КчЪДцХ░цНохдзх░П</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> totalBytesRead<span class="token punctuation">;</span>

        <span class="token comment">//шбичд║цЬмцмбread loop х░ЭшпХшп╗хПЦхдЪх░СхнЧшКВя╝МbyteBufferхЙйф╜ЩхПпхЖЩчЪДхнЧшКВцХ░</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> attemptedBytesRead<span class="token punctuation">;</span>

        <span class="token comment">//цЬмцмбread loopшп╗хПЦхИ░чЪДхнЧшКВцХ░</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> lastBytesRead<span class="token punctuation">;</span>

        <span class="token comment">//щвДшобф╕Лф╕АцмбхИЖщЕНbufferчЪДхо╣щЗПя╝МхИЭхзЛя╝Ъ2048</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> nextReceiveBufferSize<span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хЬицпПш╜о read loop х╝АхзЛф╣ЛхЙНя╝МщГ╜ф╝Ъш░ГчФи<code>allocHandle.reset(config)</code>щЗНч╜оц╕Ечй║ф╕Кф╕Аш╜о read loop чЪДч╗ЯшобцМЗцаЗуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token class-name">ChannelConfig</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>config <span class="token operator">=</span> config<span class="token punctuation">;</span>
    <span class="token comment">//щ╗ШшодцпПцмбцЬАхдЪшп╗хПЦ16цмб</span>
    maxMessagePerRead <span class="token operator">=</span> <span class="token function">maxMessagesPerRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    totalMessages <span class="token operator">=</span> totalBytesRead <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хЬицпПцмбх╝АхзЛф╗О NioSocketChannel ф╕ншп╗хПЦцХ░цНоф╣ЛхЙНя╝МщЬАшжБхИйчФи<code>PooledByteBufAllocator</code>хЬихЖЕхнШц▒аф╕нф╕║ ByteBuffer хИЖщЕНхЖЕхнШя╝Мщ╗ШшодхИЭхзЛхМЦхдзх░Пф╕║<code>2048</code>я╝Мш┐Щф╕кхо╣щЗПчФ▒<code>guess()цЦ╣ц│Х</code>хЖ│хоЪуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code>byteBuf <span class="token operator">=</span> allocHandle<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>allocator<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ByteBuf</span> <span class="token function">allocate</span><span class="token punctuation">(</span><span class="token class-name">ByteBufAllocator</span> alloc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> alloc<span class="token punctuation">.</span><span class="token function">ioBuffer</span><span class="token punctuation">(</span><span class="token function">guess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">guess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//щвДшобф╕Лф╕АцмбхИЖщЕНbufferчЪДхо╣щЗПя╝Мф╕Ах╝АхзЛф╕║2048</span>
    <span class="token keyword">return</span> nextReceiveBufferSize<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хЬицпПцмбщАЪш┐З<code>doReadBytes</code>ф╗О NioSocketChannel ф╕ншп╗хПЦхИ░цХ░цНохРОя╝МщГ╜ф╝Ъш░ГчФи<code>allocHandle.lastBytesRead(doReadBytes(byteBuf))</code>шо░х╜ХцЬмцмбшп╗хПЦф║ЖхдЪх░СхнЧшКВцХ░цНоя╝Мх╣╢ч╗ЯшобцЬмш╜о read loop чЫохЙНцА╗хЕ▒шп╗хПЦф║ЖхдЪх░СхнЧшКВуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lastBytesRead</span><span class="token punctuation">(</span><span class="token keyword">int</span> bytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    lastBytesRead <span class="token operator">=</span> bytes<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        totalBytesRead <span class="token operator">+=</span> bytes<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цпПцмбх╛кчОпф╗О NioSocketChannel ф╕ншп╗хПЦцХ░цНоф╣ЛхРОя╝МщГ╜ф╝Ъш░ГчФи<code>allocHandle.incMessagesRead(1)</code>уАВч╗Яшобх╜УхЙНх╖▓ч╗Пшп╗хПЦф║ЖхдЪх░СцмбуАВхжВцЮЬш╢Еш┐Зф║ЖцЬАхдзшп╗хПЦщЩРхИ╢цндцЧ╢ 16 цмбя╝Мх░▒щЬАшжБщААхЗ║ read loopуАВхО╗хдДчРЖхЕ╢ф╗Ц NioSocketChannel ф╕КчЪД IO ф║Лф╗╢уАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">incMessagesRead</span><span class="token punctuation">(</span><span class="token keyword">int</span> amt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    totalMessages <span class="token operator">+=</span> amt<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хЬицпПцмб read loop х╛кчОпчЪДцЬлх░╛щГ╜щЬАшжБщАЪш┐Зш░ГчФи<code>allocHandle.continueReading()</code>цЭехИдцЦнцШпхРжч╗зч╗н read loop х╛кчОпшп╗хПЦ NioSocketChannel ф╕нчЪДцХ░цНоуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">continueReading</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">continueReading</span><span class="token punctuation">(</span>defaultMaybeMoreSupplier<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">UncheckedBooleanSupplier</span> defaultMaybeMoreSupplier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UncheckedBooleanSupplier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//хИдцЦнцЬмцмбшп╗хПЦbyteBufferцШпхРжц╗бш╜╜шАМх╜Т</span>
        <span class="token keyword">return</span> attemptedBytesRead <span class="token operator">==</span> lastBytesRead<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">continueReading</span><span class="token punctuation">(</span><span class="token class-name">UncheckedBooleanSupplier</span> maybeMoreDataSupplier<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> config<span class="token punctuation">.</span><span class="token function">isAutoRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span><span class="token operator">!</span>respectMaybeMoreData <span class="token operator">||</span> maybeMoreDataSupplier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        totalMessages <span class="token operator">&lt;</span> maxMessagePerRead <span class="token operator">&amp;&amp;</span>
        totalBytesRead <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>attemptedBytesRead :</code>шбичд║х╜УхЙН ByteBuffer щвДшобх░ЭшпХшжБхЖЩхЕечЪДхнЧшКВцХ░уАВ</li> <li><code>lastBytesRead :</code>шбичд║цЬмцмб read loop чЬЯхоЮшп╗хПЦхИ░ф║ЖхдЪх░Сф╕кхнЧшКВуАВ</li></ul> <p><code>defaultMaybeMoreSupplier</code>чФиф║ОхИдцЦнч╗Пш┐ЗцЬмцмб read loop шп╗хПЦцХ░цНохРОя╝МByteBuffer цШпхРжц╗бш╜╜шАМх╜ТуАВхжВцЮЬцШпц╗бш╜╜шАМх╜ТчЪДшпЭя╝ИattemptedBytesRead == lastBytesReadя╝Йя╝МшбицШОхПпшГ╜ NioSocketChannel щЗМш┐ШцЬЙцХ░цНоуАВхжВцЮЬф╕НцШпц╗бш╜╜шАМх╜Тя╝МшбицШО NioSocketChannel щЗМц▓бцЬЙцХ░цНоф║Жх╖▓ч╗ПуАВ</p> <p>цШпхРжч╗зч╗нш┐ЫшбМ read loop щЬАшжБ<strong>хРМцЧ╢</strong>ц╗бш╢│ф╗еф╕ЛхЗаф╕кцЭбф╗╢я╝Ъ</p> <ul><li><p><code>totalMessages &lt; maxMessagePerRead</code> х╜УхЙНшп╗хПЦцмбцХ░цШпхРжх╖▓ч╗Пш╢Еш┐З<code>16цмб</code>я╝МхжВцЮЬш╢Еш┐Зя╝Мх░▒щААхЗ║<code>do(...)while()</code>х╛кчОпуАВш┐ЫшбМф╕Лф╕Аш╜о<code>OP_READф║Лф╗╢</code>чЪДш╜ошпвуАВхЫаф╕║цпПф╕к Sub Reactor чобчРЖф║ЖхдЪф╕к NioSocketChannelя╝Мф╕НшГ╜хЬиф╕Аф╕к NioSocketChannel ф╕КхНачФихдкхдЪцЧ╢щЧ┤я╝МшжБх░ЖцЬ║ф╝ЪхЭЗхМАхЬ░хИЖщЕНч╗Щ Sub Reactor цЙАчобчРЖчЪДцЙАцЬЙ NioSocketChannelуАВ</p></li> <li><p><code>totalBytesRead &gt; 0</code> цЬмцмб<code>OP_READф║Лф╗╢</code>хдДчРЖцШпхРжшп╗хПЦхИ░ф║ЖцХ░цНоя╝МхжВцЮЬх╖▓ч╗Пц▓бцЬЙцХ░цНохПпшп╗ф║Жя╝МщВгф╣Их░▒чЫ┤цОещААхЗ║ read loopуАВ</p></li> <li><p><code>!respectMaybeMoreData || maybeMoreDataSupplier.get()</code> ш┐Щф╕кцЭбф╗╢цпФш╛ГхдНцЭВя╝МхоГхЕ╢хоЮх░▒цШпщАЪш┐З<code>respectMaybeMoreData</code>хнЧцо╡цЭецОзхИ╢ NioSocketChannel ф╕нхПпшГ╜ш┐ШцЬЙцХ░цНохПпшп╗чЪДцГЕхЖ╡ф╕ЛшпехжВф╜ХхдДчРЖуАВ</p></li> <li><ul><li><code>maybeMoreDataSupplier.get()</code>я╝Ъtrue шбичд║цЬмцмбшп╗хПЦф╗О NioSocketChannel ф╕ншп╗хПЦцХ░цНоя╝МByteBuffer ц╗бш╜╜шАМх╜ТуАВшп┤цШОхПпшГ╜ NioSocketChannel ф╕нш┐ШцЬЙцХ░цНоц▓бшп╗хоМуАВfasle шбичд║ ByteBuffer ш┐Шц▓бцЬЙшгЕц╗бя╝Мшп┤цШО NioSocketChannel ф╕нх╖▓ч╗Пц▓бцЬЙцХ░цНохПпшп╗ф║ЖуАВ</li> <li><code>respectMaybeMoreData = true</code>шбичд║шжБхп╣хПпшГ╜ш┐ШцЬЙцЫ┤хдЪцХ░цНош┐ЫшбМхдДчРЖчЪДш┐ЩчзНцГЕхЖ╡шжБ<code>respect</code>шодчЬЯхп╣х╛Е,хжВцЮЬцЬмцмбх╛кчОпшп╗хПЦхИ░чЪДцХ░цНох╖▓ч╗ПшгЕц╗б<code>ByteBuffer</code>я╝Мшбичд║хРОщЭвхПпшГ╜ш┐ШцЬЙцХ░цНоя╝МщВгф╣Их░▒шжБш┐ЫшбМшп╗хПЦуАВхжВцЮЬ<code>ByteBuffer</code>ш┐Шц▓бшгЕц╗бшбичд║х╖▓ч╗Пц▓бцЬЙцХ░цНохПпшп╗ф║ЖщВгф╣Их░▒щААхЗ║х╛кчОпуАВ![хЫ╛чЙЗ](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)</li> <li><code>respectMaybeMoreData = false</code>шбичд║хп╣хПпшГ╜ш┐ШцЬЙцЫ┤хдЪцХ░цНочЪДш┐ЩчзНцГЕхЖ╡ф╕НшодчЬЯхп╣х╛Е <code>not respect</code>уАВф╕НчобцЬмцмбх╛кчОпшп╗хПЦцХ░цНо<code>ByteBuffer</code>цШпхРжц╗бш╜╜шАМх╜Тя╝МщГ╜шжБч╗зч╗нш┐ЫшбМшп╗хПЦя╝МчЫ┤хИ░шп╗хПЦф╕НхИ░цХ░цНохЬищААхЗ║х╛кчОпя╝Мх▒Юф║ОцЧашДСшп╗хПЦуАВ</li></ul></li></ul> <p>хРМцЧ╢ц╗бш╢│ф╗еф╕Кф╕Йф╕кцЭбф╗╢я╝МщВгф╣И read loop ч╗зч╗нш┐ЫшбМуАВч╗зч╗нф╗О NioSocketChannel ф╕ншп╗хПЦцХ░цНоя╝МчЫ┤хИ░шп╗хПЦф╕НхИ░цИЦшАЕф╕Нц╗бш╢│ф╕Йф╕кцЭбф╗╢ф╕нчЪДф╗╗цДПф╕Аф╕кф╕║цнвуАВ</p> <h3 id="_3-2-ф╗О-niosocketchannel-ф╕ншп╗хПЦцХ░цНо"><a href="#_3-2-ф╗О-niosocketchannel-ф╕ншп╗хПЦцХ░цНо" class="header-anchor">#</a> 3.2 ф╗О NioSocketChannel ф╕ншп╗хПЦцХ░цНо</h3> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NioSocketChannel</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractNioByteChannel</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>socket<span class="token punctuation">.</span></span>SocketChannel</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">doReadBytes</span><span class="token punctuation">(</span><span class="token class-name">ByteBuf</span> byteBuf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">RecvByteBufAllocator<span class="token punctuation">.</span>Handle</span> allocHandle <span class="token operator">=</span> <span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">recvBufAllocHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        allocHandle<span class="token punctuation">.</span><span class="token function">attemptedBytesRead</span><span class="token punctuation">(</span>byteBuf<span class="token punctuation">.</span><span class="token function">writableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> byteBuf<span class="token punctuation">.</span><span class="token function">writeBytes</span><span class="token punctuation">(</span><span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> allocHandle<span class="token punctuation">.</span><span class="token function">attemptedBytesRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ш┐ЩщЗМф╝ЪчЫ┤цОеш░ГчФих║Хх▒В JDK NIO чЪД<code>SocketChannel#read</code>цЦ╣ц│Хх░ЖцХ░цНошп╗хПЦхИ░ DirectByteBuffer ф╕нуАВшп╗хПЦцХ░цНохдзх░Пф╕║цЬмцмбхИЖщЕНчЪД DirectByteBuffer хо╣щЗПя╝МхИЭхзЛф╕║ 2048уАВ</p> <h2 id="_4-bytebuffer-хКицАБшЗкщАВх║ФцЙйч╝йхо╣цЬ║хИ╢"><a href="#_4-bytebuffer-хКицАБшЗкщАВх║ФцЙйч╝йхо╣цЬ║хИ╢" class="header-anchor">#</a> 4. ByteBuffer хКицАБшЗкщАВх║ФцЙйч╝йхо╣цЬ║хИ╢</h2> <p>чФ▒ф║ОцИСф╗мф╕Ах╝АхзЛх╣╢ф╕НчЯещБУховцИ╖члпф╝ЪхПСщАБхдЪхдзчЪДч╜Сч╗ЬцХ░цНоя╝МцЙАф╗еш┐ЩщЗМхЕИхИйчФи<code>PooledByteBufAllocator</code>хИЖщЕНф╕Аф╕кхИЭхзЛхо╣щЗПф╕║<code>2048</code>чЪД DirectByteBuffer чФиф║ОцОецФ╢цХ░цНоуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code>byteBuf <span class="token operator">=</span> allocHandle<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>allocator<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ш┐Щх░▒хе╜цпФцИСф╗мщЬАшжБцЛ┐чЭАф╕Аф╕кцб╢хО╗цОТщШЯшгЕц░┤я╝Мф╜ЖцШпчммф╕АцмбхО╗шгЕчЪДцЧ╢хАЩя╝МцИСф╗мх╣╢ф╕НчЯещБУчобчРЖхСШф╝Ъч╗ЩцИСф╗мхИЖщЕНхдЪх░Сц░┤я╝Мцб╢цЛ┐хдзф║Жф╣Яф╕НхРИщАВцЛ┐х░Пф║Жф╣Яф╕НхРИщАВя╝Мф║ОцШпцИСф╗мх░▒хЕИщвДф╝░ф╕Аф╕кх╖оф╕НхдЪхо╣щЗПхдзх░ПчЪДцб╢я╝МхжВцЮЬхИЖщЕНчЪДхдЪф║Жя╝МцИСф╗мф╕Лцмбх░▒цЛ┐цЫ┤хдзф╕АчВ╣чЪДцб╢я╝МхжВцЮЬхИЖщЕНх░Сф║Жя╝Мф╕ЛцмбцИСф╗мх░▒цЛ┐ф╕Аф╕кх░ПчВ╣чЪДцб╢уАВ</p> <p>хЬиш┐ЩчзНхЬ║цЩпф╕Ля╝МцИСф╗мщЬАшжБ ByteBuffer хПпф╗ешЗкхКица╣цНоцпПцмбч╜Сч╗ЬцХ░цНочЪДхдзх░ПцЭехКицАБшЗкщАВх║Фш░ГцХ┤шЗкх╖▒чЪДхо╣щЗПуАВ</p> <p>шАМ ByteBuffer хКицАБшЗкщАВх║ФцЙйч╝йхо╣цЬ║хИ╢ф╛Эш╡Цф║О AdaptiveRecvByteBufAllocator ч▒╗чЪДхоЮчО░уАВшойцИСф╗мхЕИхЫЮхИ░ AdaptiveRecvByteBufAllocator ч▒╗чЪДхИЫх╗║ш╡╖чВ╣х╝АхзЛшп┤ш╡╖~~</p> <h3 id="_4-1-adaptiverecvbytebufallocator-чЪДхИЫх╗║"><a href="#_4-1-adaptiverecvbytebufallocator-чЪДхИЫх╗║" class="header-anchor">#</a> 4.1 AdaptiveRecvByteBufAllocator чЪДхИЫх╗║</h3> <p>хЬихЙНцЦЗ<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484184&amp;idx=1&amp;sn=726877ce28cf6e5d2ac3225fae687f19&amp;chksm=ce77c55ff9004c493b592288819dc4d4664b5949ee97fed977b6558bc517dad0e1f73fab0f46&amp;scene=21&amp;cur_album_id=2217816582418956300#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКNetty цШпхжВф╜ХщлШцХИцОецФ╢ч╜Сч╗Ьш┐ЮцОеуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕нцИСф╗мцПРхИ░я╝Мх╜У Main Reactor чЫСхРмхИ░ OP_ACCPET ф║Лф╗╢ц┤╗ш╖ГхРОя╝Мф╝ЪхЬи NioServerSocketChannel ф╕н accept хоМцИРф╕ЙцмбцПбцЙЛчЪДховцИ╖члпш┐ЮцОеуАВх╣╢хИЫх╗║ NioSocketChannelя╝Мф╝┤щЪПчЭА NioSocketChannel чЪДхИЫх╗║хЕ╢хп╣х║ФчЪДщЕНч╜оч▒╗ NioSocketChannelConfig ч▒╗ф╣Яф╝ЪщЪПф╣ЛхИЫх╗║уАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">NioSocketChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> parent<span class="token punctuation">,</span> <span class="token class-name">SocketChannel</span> socket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
    config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioSocketChannelConfig</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> socket<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цЬАч╗Иф╝ЪхЬи NioSocketChannelConfig чЪДчИ╢ч▒╗<code>DefaultChannelConfig</code>чЪДцЮДщАахЩиф╕нхИЫх╗║<code>AdaptiveRecvByteBufAllocator</code>уАВх╣╢ф┐ЭхнШхЬи<code>RecvByteBufAllocator rcvBufAllocator</code>хнЧцо╡ф╕нуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultChannelConfig</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelConfig</span> <span class="token punctuation">{</span>

    <span class="token comment">//чФиф║ОChannelцОецФ╢цХ░цНочФичЪДbufferхИЖщЕНхЩи  AdaptiveRecvByteBufAllocator</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">RecvByteBufAllocator</span> rcvBufAllocator<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">DefaultChannelConfig</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AdaptiveRecvByteBufAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>хЬи<code>new AdaptiveRecvByteBufAllocator()</code>хИЫх╗║ AdaptiveRecvByteBufAllocator ч▒╗хоЮф╛ЛчЪДцЧ╢хАЩф╝ЪхЕИшзжхПС AdaptiveRecvByteBufAllocator ч▒╗чЪДхИЭхзЛхМЦуАВ</p> <p>цИСф╗мхЕИцЭечЬЛф╕Л AdaptiveRecvByteBufAllocator ч▒╗чЪДхИЭхзЛхМЦщГ╜хБЪф║Жф║Ыф╗Аф╣Иф║ЛцГЕя╝Ъ</p> <h3 id="_4-2-adaptiverecvbytebufallocator-ч▒╗чЪДхИЭхзЛхМЦ"><a href="#_4-2-adaptiverecvbytebufallocator-ч▒╗чЪДхИЭхзЛхМЦ" class="header-anchor">#</a> 4.2 AdaptiveRecvByteBufAllocator ч▒╗чЪДхИЭхзЛхМЦ</h3> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AdaptiveRecvByteBufAllocator</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultMaxMessagesRecvByteBufAllocator</span> <span class="token punctuation">{</span>

    <span class="token comment">//цЙйхо╣цнещХ┐</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">INDEX_INCREMENT</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token comment">//ч╝йхо╣цнещХ┐</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">INDEX_DECREMENT</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">//RecvBufхИЖщЕНхо╣щЗПшбия╝ИцЙйч╝йхо╣ч┤вх╝Хшбия╝ЙцМЙчЕзшбиф╕ншо░х╜ХчЪДхо╣щЗПхдзх░Пш┐ЫшбМцЙйч╝йхо╣</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">SIZE_TABLE</span><span class="token punctuation">;</span>

   <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token comment">//хИЭхзЛхМЦRecvBufхо╣щЗПхИЖщЕНшби</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> sizeTable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//х╜УхИЖщЕНхо╣щЗПх░Пф║О512цЧ╢я╝МцЙйхо╣хНХф╜Нф╕║16щАТхвЮ</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">512</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sizeTable<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//х╜УхИЖщЕНхо╣щЗПхдзф║О512цЧ╢я╝МцЙйхо╣хНХф╜Нф╕║ф╕АхАН</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">512</span><span class="token punctuation">;</span> i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sizeTable<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//хИЭхзЛхМЦRecbBufцЙйч╝йхо╣ч┤вх╝Хшби</span>
        <span class="token constant">SIZE_TABLE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>sizeTable<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">SIZE_TABLE</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">SIZE_TABLE</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> sizeTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>AdaptiveRecvByteBufAllocator ф╕╗шжБчЪДф╜ЬчФих░▒цШпф╕║цОецФ╢цХ░цНочЪД<code>ByteBuffer</code>ш┐ЫшбМцЙйхо╣ч╝йхо╣я╝МщВгф╣ИцпПцмбцАОф╣ИцЙйхо╣я╝ЯцЙйхо╣хдЪх░Ся╝ЯцАОф╣Ич╝йхо╣я╝Яч╝йхо╣хдЪх░СхСвя╝Я</p> <p>ш┐ЩхЫЫф╕кщЧощвШх░ЖцШпцЬмх░ПшКВчмФшАЕшжБф╕║хдзхо╢шзгчнФчЪДхЖЕхо╣~~~</p> <p>Netty ф╕нхоЪф╣Йф║Жф╕Аф╕к<code>intхЮЛ</code>чЪДцХ░ч╗Д<code>SIZE_TABLE</code>цЭехнШхВицпПф╕кцЙйхо╣хНХф╜Нхп╣х║ФчЪДхо╣щЗПхдзх░ПуАВх╗║члЛш╡╖цЙйч╝йхо╣чЪДхо╣щЗПч┤вх╝ХшбиуАВцпПцмбцЙйхо╣хдЪх░Ся╝Мч╝йхо╣хдЪх░СхЕищГишо░х╜ХхЬиш┐Щф╕кхо╣щЗПч┤вх╝Хшбиф╕нуАВ</p> <p>хЬи AdaptiveRecvByteBufAllocatorl ч▒╗хИЭхзЛхМЦчЪДцЧ╢хАЩф╝ЪхЬи<code>static{}</code>щЭЩцАБф╗гчаБхЭЧф╕нхп╣цЙйч╝йхо╣ч┤вх╝Хшби<code>SIZE_TABLE</code>ш┐ЫшбМхИЭхзЛхМЦуАВ</p> <p>ф╗Оц║РчаБф╕нцИСф╗мхПпф╗ечЬЛхЗ║<code>SIZE_TABLE</code>чЪДхИЭхзЛхМЦхИЖф╕║ф╕дф╕кщГихИЖя╝Ъ</p> <ul><li>х╜Уч┤вх╝Ххо╣щЗПх░Пф║О<code>512</code>цЧ╢я╝М<code>SIZE_TABLE</code>ф╕нхоЪф╣ЙчЪДхо╣щЗПч┤вх╝ХцШпф╗О<code>16х╝АхзЛ</code>цМЙ<code>16</code>щАТхвЮуАВ</li></ul> <p>![хЫ╛чЙЗ](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <ul><li>х╜Уч┤вх╝Ххо╣щЗПхдзф║О<code>512</code>цЧ╢я╝М<code>SIZE_TABLE</code>ф╕нхоЪф╣ЙчЪДхо╣щЗПч┤вх╝ХцШпцМЙхЙНф╕Аф╕кч┤вх╝Ххо╣щЗПчЪД 2 хАНщАТхвЮуАВ</li></ul> <p>![хЫ╛чЙЗ](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <h3 id="_4-3-цЙйч╝йхо╣щА╗ш╛С"><a href="#_4-3-цЙйч╝йхо╣щА╗ш╛С" class="header-anchor">#</a> 4.3 цЙйч╝йхо╣щА╗ш╛С</h3> <p>чО░хЬицЙйч╝йхо╣ч┤вх╝Хшби<code>SIZE_TABLE</code>х╖▓ч╗ПхИЭхзЛхМЦхоМцпХф║Жя╝МщВгф╣Их╜УцИСф╗мщЬАшжБхп╣<code>ByteBuffer</code>ш┐ЫшбМцЙйхо╣цИЦшАЕч╝йхо╣чЪДцЧ╢хАЩхжВф╜Хца╣цНо<code>SIZE_TABLE</code>хЖ│хоЪцЙйхо╣хдЪх░СцИЦшАЕч╝йхо╣хдЪх░СхСвя╝Яя╝Я</p> <p>ш┐Щх░▒чФихИ░ф║ЖхЬи AdaptiveRecvByteBufAllocator ч▒╗ф╕нхоЪф╣ЙчЪДцЙйхо╣цнещХ┐<code>INDEX_INCREMENT = 4</code>я╝Мч╝йхо╣цнещХ┐<code>INDEX_DECREMENT = 1</code>ф║ЖуАВ</p> <p>цИСф╗мх░▒ф╗еф╕КщЭвф╕дхЙпцЙйч╝йхо╣хо╣щЗПч┤вх╝Хшби<code>SIZE_TABLE</code>ф╕нчЪДхо╣щЗПч┤вх╝Хх▒Хчд║цИкхЫ╛ф╕║ф╛Ля╝МцЭеф╗Лч╗Нф╕ЛцЙйч╝йхо╣щА╗ш╛Ся╝МхБЗшо╛цИСф╗мх╜УхЙН<code>ByteBuffer</code>чЪДхо╣щЗПч┤вх╝Хф╕║<code>33</code>я╝Мхп╣х║ФчЪДхо╣щЗПф╕║<code>2048</code>уАВ</p> <h4 id="_4-3-1-цЙйхо╣"><a href="#_4-3-1-цЙйхо╣" class="header-anchor">#</a> 4.3.1 цЙйхо╣</h4> <p>х╜Ухп╣хо╣щЗПф╕║<code>2048</code>чЪД ByteBuffer ш┐ЫшбМцЙйхо╣цЧ╢я╝Мца╣цНох╜УхЙНчЪДхо╣щЗПч┤вх╝Х<code>index = 33</code> <strong>хКаф╕К</strong> цЙйхо╣цнещХ┐<code>INDEX_INCREMENT = 4</code>шобчоЧхЗ║цЙйхо╣хРОчЪДхо╣щЗПч┤вх╝Хф╕║<code>37</code>я╝МщВгф╣ИцЙйч╝йхо╣ч┤вх╝Хшби<code>SIZE_TABLE</code>ф╕ЛцаЗ<code>37</code>хп╣х║ФчЪДхо╣щЗПх░▒цШпцЬмцмб ByteBuffer цЙйхо╣хРОчЪДхо╣щЗП<code>SIZE_TABLE[37] = 32768</code></p> <h4 id="_4-3-1-ч╝йхо╣"><a href="#_4-3-1-ч╝йхо╣" class="header-anchor">#</a> 4.3.1 ч╝йхо╣</h4> <p>хРМчРЖхп╣хо╣щЗПф╕║<code>2048</code>чЪД ByteBuffer ш┐ЫшбМч╝йхо╣цЧ╢я╝МцИСф╗мх░▒щЬАшжБчФих╜УхЙНхо╣щЗПч┤вх╝Х<code>index = 33</code> <strong>хЗПхО╗</strong> ч╝йхо╣цнещХ┐<code>INDEX_DECREMENT = 1</code>шобчоЧхЗ║ч╝йхо╣хРОчЪДхо╣щЗПч┤вх╝Х<code>32</code>я╝МщВгф╣ИцЙйч╝йхо╣ч┤вх╝Хшби<code>SIZE_TABLE</code>ф╕ЛцаЗ<code>32</code>хп╣х║ФчЪДхо╣щЗПх░▒цШпцЬмцмб ByteBuffer ч╝йхо╣хРОчЪДхо╣щЗП<code>SIZE_TABLE[32] = 1024</code></p> <h3 id="_4-4-цЙйч╝йхо╣цЧ╢цЬ║"><a href="#_4-4-цЙйч╝йхо╣цЧ╢цЬ║" class="header-anchor">#</a> 4.4 цЙйч╝йхо╣цЧ╢цЬ║</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractNioByteChannel</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractNioChannel</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">do</span> <span class="token punctuation">{</span>
                      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>allocHandle<span class="token punctuation">.</span><span class="token function">continueReading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//ца╣цНоцЬмцмбread loopцА╗хЕ▒шп╗хПЦчЪДхнЧшКВцХ░я╝МхЖ│хоЪф╕ЛцмбцШпхРжцЙйхо╣цИЦшАЕч╝йхо╣</span>
                allocHandle<span class="token punctuation">.</span><span class="token function">readComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
               <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хЬицпПш╜о read loop ч╗УцЭЯф╣ЛхРОя╝МцИСф╗мщГ╜ф╝Ъш░ГчФи<code>allocHandle.readComplete()</code>цЭеца╣цНохЬи allocHandle ф╕нч╗ЯшобчЪДхЬицЬмш╜о read loop ф╕ншп╗хПЦхнЧшКВцА╗хдзх░Пя╝МцЭехЖ│хоЪхЬиф╕Лф╕Аш╜о read loop ф╕нцШпхРжхп╣ DirectByteBuffer ш┐ЫшбМцЙйхо╣цИЦшАЕч╝йхо╣уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">MaxMessageHandle</span> <span class="token keyword">implements</span> <span class="token class-name">ExtendedHandle</span> <span class="token punctuation">{</span>

       <span class="token annotation punctuation">@Override</span>
       <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">readComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//цШпхРжхп╣recvbufш┐ЫшбМцЙйхо╣ч╝йхо╣</span>
                <span class="token function">record</span><span class="token punctuation">(</span><span class="token function">totalBytesRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

       <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">record</span><span class="token punctuation">(</span><span class="token keyword">int</span> actualReadBytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>actualReadBytes <span class="token operator">&lt;=</span> <span class="token constant">SIZE_TABLE</span><span class="token punctuation">[</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> index <span class="token operator">-</span> <span class="token constant">INDEX_DECREMENT</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>decreaseNow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    index <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>index <span class="token operator">-</span> <span class="token constant">INDEX_DECREMENT</span><span class="token punctuation">,</span> minIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    nextReceiveBufferSize <span class="token operator">=</span> <span class="token constant">SIZE_TABLE</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    decreaseNow <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    decreaseNow <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>actualReadBytes <span class="token operator">&gt;=</span> nextReceiveBufferSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                index <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token constant">INDEX_INCREMENT</span><span class="token punctuation">,</span> maxIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                nextReceiveBufferSize <span class="token operator">=</span> <span class="token constant">SIZE_TABLE</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
                decreaseNow <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цИСф╗мф╗ех╜УхЙН ByteBuffer хо╣щЗПф╕║<code>2048</code>я╝Мхо╣щЗПч┤вх╝Х<code>index = 33</code>ф╕║ф╛Ля╝Мхп╣<code>allocHandle</code>чЪДцЙйхо╣ч╝йхо╣шзДхИЩш┐ЫшбМшп┤цШОуАВ</p> <blockquote><p>цЙйхо╣цнещХ┐<code>INDEX_INCREMENT = 4</code>я╝Мч╝йхо╣цнещХ┐<code>INDEX_DECREMENT = 1</code>уАВ</p></blockquote> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191131842.png" alt="хЫ╛чЙЗ">image.png</p> <h4 id="_4-4-1-ч╝йхо╣"><a href="#_4-4-1-ч╝йхо╣" class="header-anchor">#</a> 4.4.1 ч╝йхо╣</h4> <ul><li>хжВцЮЬцЬмцмб<code>OP_READф║Лф╗╢</code>хоЮщЩЕшп╗хПЦхИ░чЪДцА╗хнЧшКВцХ░<code>actualReadBytes</code>хЬи SIZE_TABLE[index - INDEX_DECREMENT]ф╕О SIZE_TABLE[index]ф╣ЛщЧ┤чЪДшпЭя╝Мф╣Ях░▒цШпхжВцЮЬцЬмш╜о read loop ч╗УцЭЯф╣ЛхРОцА╗хЕ▒шп╗хПЦчЪДхнЧшКВцХ░хЬи<code>[1024,2048]</code>ф╣ЛщЧ┤уАВшп┤цШОцндцЧ╢хИЖщЕНчЪД<code>ByteBuffer</code>хо╣щЗПцнгхе╜я╝Мф╕НщЬАшжБш┐ЫшбМч╝йхо╣ф╣Яф╕НщЬАшжБш┐ЫшбМцЙйхо╣уАВцпФхжВцЬмцмб<code>actualReadBytes = 2000</code>я╝Мцнгхе╜хдДхЬи<code>1024</code>ф╕О<code>2048</code>ф╣ЛщЧ┤уАВшп┤цШО<code>2048</code>чЪДхо╣щЗПцнгхе╜уАВ</li> <li>хжВцЮЬ<code>actualReadBytes</code> х░Пф║ОчнЙф║О SIZE_TABLE[index - INDEX_DECREMENT]я╝Мф╣Ях░▒цШпхжВцЮЬцЬмш╜о read loop ч╗УцЭЯф╣ЛхРОцА╗хЕ▒шп╗хПЦчЪДхнЧшКВцХ░х░Пф║ОчнЙф║О<code>1024</code>уАВшбичд║цЬмцмбшп╗хПЦхИ░чЪДхнЧшКВцХ░цпФх╜УхЙН ByteBuffer хо╣щЗПчЪДф╕Лф╕Ач║зхо╣щЗПш┐ШшжБх░Пя╝Мшп┤цШОх╜УхЙН ByteBuffer чЪДхо╣щЗПхИЖщЕНчЪДцЬЙф║Ыхдзф║Жя╝Мшо╛ч╜оч╝йхо╣цаЗшпЖ<code>decreaseNow = true</code>уАВх╜Уф╕Лцмб<code>OP_READф║Лф╗╢</code>ч╗зч╗нц╗бш╢│ч╝йхо╣цЭбф╗╢чЪДцЧ╢хАЩя╝Мх╝АхзЛчЬЯцнгчЪДш┐ЫшбМч╝йхо╣уАВч╝йхо╣хРОчЪДхо╣щЗПф╕║ SIZE_TABLE[index - INDEX_DECREMENT]я╝Мф╜Жф╕НшГ╜х░Пф║О SIZE_TABLE[minIndex]уАВ</li></ul> <blockquote><p>ц│ицДПщЬАшжБц╗бш╢│ф╕дцмбч╝йхо╣цЭбф╗╢цЙНф╝Ъш┐ЫшбМч╝йхо╣я╝Мф╕Фч╝йхо╣цнещХ┐ф╕║ 1я╝Мч╝йхо╣цпФш╛Гш░ицЕО</p></blockquote> <h4 id="_4-4-2-цЙйхо╣"><a href="#_4-4-2-цЙйхо╣" class="header-anchor">#</a> 4.4.2 цЙйхо╣</h4> <p>хжВцЮЬцЬмцмб<code>OP_READф║Лф╗╢</code>хдДчРЖцА╗хЕ▒шп╗хПЦчЪДхнЧшКВцХ░<code>actualReadBytes</code> хдзф║ОчнЙф║О х╜УхЙН ByteBuffer хо╣щЗП(nextReceiveBufferSize)цЧ╢я╝Мшп┤цШО ByteBuffer хИЖщЕНчЪДхо╣щЗПцЬЙчВ╣х░Пф║Жя╝МщЬАшжБш┐ЫшбМцЙйхо╣уАВцЙйхо╣хРОчЪДхо╣щЗПф╕║ SIZE_TABLE[index + INDEX_INCREMENT]я╝Мф╜Жф╕НшГ╜ш╢Еш┐З SIZE_TABLE[maxIndex]уАВ</p> <blockquote><p>ц╗бш╢│ф╕АцмбцЙйхо╣цЭбф╗╢х░▒ш┐ЫшбМцЙйхо╣я╝Мх╣╢ф╕ФцЙйхо╣цнещХ┐ф╕║ 4я╝М цЙйхо╣цпФш╛ГхеФцФ╛</p></blockquote> <h3 id="_4-5-adaptiverecvbytebufallocator-ч▒╗чЪДхоЮф╛ЛхМЦ"><a href="#_4-5-adaptiverecvbytebufallocator-ч▒╗чЪДхоЮф╛ЛхМЦ" class="header-anchor">#</a> 4.5 AdaptiveRecvByteBufAllocator ч▒╗чЪДхоЮф╛ЛхМЦ</h3> <p>AdaptiveRecvByteBufAllocator ч▒╗чЪДхоЮф╛ЛхМЦф╕╗шжБцШпчбохоЪ ByteBuffer чЪДхИЭхзЛхо╣щЗПя╝Мф╗ехПКцЬАх░Пхо╣щЗПхТМцЬАхдзхо╣щЗПхЬицЙйч╝йхо╣ч┤вх╝Хшби<code>SIZE_TABLE</code>ф╕нчЪДф╕ЛцаЗя╝Ъ<code>minIndex</code>хТМ<code>maxIndex</code>уАВ</p> <p>AdaptiveRecvByteBufAllocator хоЪф╣Йф║Жф╕Йф╕кхЕ│ф║О ByteBuffer хо╣щЗПчЪДхнЧцо╡я╝Ъ</p> <ul><li><code>DEFAULT_MINIMUM</code> я╝Ъшбичд║ ByteBuffer цЬАх░ПчЪДхо╣щЗПя╝Мщ╗Шшодф╕║<code>64</code>я╝Мф╣Ях░▒цШпцЧашо║ ByteBuffer хЬицАОф╣Ич╝йхо╣я╝Мхо╣щЗПф╣Яф╕Нф╝Ъф╜Оф║О<code>64</code>уАВ</li> <li><code>DEFAULT_INITIAL</code>я╝Ъшбичд║ ByteBuffer чЪДхИЭхзЛхМЦхо╣щЗПуАВщ╗Шшодф╕║<code>2048</code>уАВ</li> <li><code>DEFAULT_MAXIMUM</code> я╝Ъшбичд║ ByteBuffer чЪДцЬАхдзхо╣щЗПя╝Мщ╗Шшодф╕║<code>65536</code>я╝Мф╣Ях░▒цШпцЧашо║ ByteBuffer хЬицАОф╣ИцЙйхо╣я╝Мхо╣щЗПф╣Яф╕Нф╝Ъш╢Еш┐З<code>65536</code>уАВ</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AdaptiveRecvByteBufAllocator</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultMaxMessagesRecvByteBufAllocator</span> <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_MINIMUM</span> <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_INITIAL</span> <span class="token operator">=</span> <span class="token number">2048</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_MAXIMUM</span> <span class="token operator">=</span> <span class="token number">65536</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">AdaptiveRecvByteBufAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_MINIMUM</span><span class="token punctuation">,</span> <span class="token constant">DEFAULT_INITIAL</span><span class="token punctuation">,</span> <span class="token constant">DEFAULT_MAXIMUM</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">AdaptiveRecvByteBufAllocator</span><span class="token punctuation">(</span><span class="token keyword">int</span> minimum<span class="token punctuation">,</span> <span class="token keyword">int</span> initial<span class="token punctuation">,</span> <span class="token keyword">int</span> maximum<span class="token punctuation">)</span> <span class="token punctuation">{</span>

         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХех╝Вх╕╕цгАцЯещА╗ш╛С<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment">//шобчоЧminIndex maxIndex</span>
        <span class="token comment">//хЬиSIZE_TABLEф╕нф║МхИЖцЯецЙ╛цЬАх░П &gt;= minimumчЪДхо╣щЗПч┤вх╝Х я╝Ъ3</span>
        <span class="token keyword">int</span> minIndex <span class="token operator">=</span> <span class="token function">getSizeTableIndex</span><span class="token punctuation">(</span>minimum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">SIZE_TABLE</span><span class="token punctuation">[</span>minIndex<span class="token punctuation">]</span> <span class="token operator">&lt;</span> minimum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>minIndex <span class="token operator">=</span> minIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>minIndex <span class="token operator">=</span> minIndex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//хЬиSIZE_TABLEф╕нф║МхИЖцЯецЙ╛цЬАхдз &lt;= maximumчЪДхо╣щЗПч┤вх╝Х я╝Ъ38</span>
        <span class="token keyword">int</span> maxIndex <span class="token operator">=</span> <span class="token function">getSizeTableIndex</span><span class="token punctuation">(</span>maximum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">SIZE_TABLE</span><span class="token punctuation">[</span>maxIndex<span class="token punctuation">]</span> <span class="token operator">&gt;</span> maximum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>maxIndex <span class="token operator">=</span> maxIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>maxIndex <span class="token operator">=</span> maxIndex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>initial <span class="token operator">=</span> initial<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цОеф╕ЛцЭечЪДф║ЛцГЕх░▒цШпчбохоЪцЬАх░Пхо╣щЗП DEFAULT_MINIMUM хЬи SIZE_TABLE ф╕нчЪДф╕ЛцаЗ<code>minIndex</code>я╝Мф╗ехПКцЬАхдзхо╣щЗП DEFAULT_MAXIMUM хЬи SIZE_TABLE ф╕нчЪДф╕ЛцаЗ<code>maxIndex</code>уАВ</p> <p>ф╗О AdaptiveRecvByteBufAllocator ч▒╗хИЭхзЛхМЦчЪДш┐ЗчиЛф╕ня╝МцИСф╗мхПпф╗ечЬЛхЗ║ SIZE_TABLE ф╕нхнШхВичЪДцХ░цНочЙ╣х╛БцШпф╕Аф╕кцЬЙх║ПчЪДщЫЖхРИуАВ</p> <p>цИСф╗мхПпф╗ещАЪш┐З<strong>ф║МхИЖцЯецЙ╛</strong>хЬи SIZE_TABLE ф╕нцЙ╛хЗ║<code>чммф╕Аф╕к</code>хо╣щЗПхдзф║ОчнЙф║О DEFAULT_MINIMUM чЪДхо╣щЗПч┤вх╝Х<code>minIndex</code>уАВ</p> <p>хРМчРЖщАЪш┐З<strong>ф║МхИЖцЯецЙ╛</strong>хЬи SIZE_TABLE ф╕нцЙ╛хЗ║<code>цЬАхРОф╕Аф╕к</code>хо╣щЗПх░Пф║ОчнЙф║О DEFAULT_MAXIMUM чЪДхо╣щЗПч┤вх╝Х<code>maxIndex</code>уАВ</p> <p>ца╣цНоф╕Кф╕Ах░ПшКВхЕ│ф║О<code>SIZE_TABLE</code>ф╕нхо╣щЗПцХ░цНохИЖх╕ГчЪДцИкхЫ╛я╝МцИСф╗мхПпф╗ечЬЛхЗ║<code>minIndex = 3</code>я╝М<code>maxIndex = 38</code></p> <h4 id="_4-5-1-ф║МхИЖцЯецЙ╛хо╣щЗПч┤вх╝Хф╕ЛцаЗ"><a href="#_4-5-1-ф║МхИЖцЯецЙ╛хо╣щЗПч┤вх╝Хф╕ЛцаЗ" class="header-anchor">#</a> 4.5.1 ф║МхИЖцЯецЙ╛хо╣щЗПч┤вх╝Хф╕ЛцаЗ</h4> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">getSizeTableIndex</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> low <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> high <span class="token operator">=</span> <span class="token constant">SIZE_TABLE</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>high <span class="token operator">&lt;</span> low<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> low<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>high <span class="token operator">==</span> low<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> high<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">int</span> mid <span class="token operator">=</span> low <span class="token operator">+</span> high <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//цЧачмжхП╖хП│чз╗я╝МщлШф╜НхзЛч╗Ишбе0</span>
            <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token constant">SIZE_TABLE</span><span class="token punctuation">[</span>mid<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token constant">SIZE_TABLE</span><span class="token punctuation">[</span>mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                low <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                high <span class="token operator">=</span> mid <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> mid<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><blockquote><p>ч╗Пх╕╕хИ╖ LeetCode чЪДх░Пф╝Щф╝┤шВпхоЪф╕АчЬ╝х░▒чЬЛхЗ║ш┐Щф╕кцШп<strong>ф║МхИЖцЯецЙ╛чЪДцибцЭ┐</strong>ф║ЖуАВ</p></blockquote> <p>хоГчЪДчЫочЪДх░▒цШпца╣цНоч╗ЩхоЪхо╣щЗПя╝МхЬицЙйч╝йхо╣ч┤вх╝Хшби<code>SIZE_TABLE</code>ф╕ня╝МщАЪш┐З<strong>ф║МхИЖцЯецЙ╛</strong>цЙ╛хИ░<code>цЬАш┤┤ш┐С</code>ч╗ЩхоЪ size чЪДхо╣щЗПчЪДч┤вх╝Хф╕ЛцаЗя╝Ичммф╕Аф╕кхдзф║ОчнЙф║О size чЪДхо╣щЗПя╝Й</p> <h3 id="_4-6-recvbytebufallocator-handle"><a href="#_4-6-recvbytebufallocator-handle" class="header-anchor">#</a> 4.6 RecvByteBufAllocator.Handle</h3> <p>хЙНш╛╣цИСф╗мцПРхИ░цЬАч╗ИхКицАБш░ГцХ┤ ByteBuffer хо╣щЗПчЪДцШпчФ▒ AdaptiveRecvByteBufAllocator ф╕нчЪД<code>Handler</code>ш┤Яш┤гчЪДя╝МцИСф╗мцЭечЬЛф╕Лш┐Щф╕к<code>allocHandle</code>чЪДхИЫх╗║ш┐ЗчиЛуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractUnsafe</span> <span class="token keyword">implements</span> <span class="token class-name">Unsafe</span> <span class="token punctuation">{</span>

        <span class="token keyword">private</span> <span class="token class-name">RecvByteBufAllocator<span class="token punctuation">.</span>Handle</span> recvHandle<span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">RecvByteBufAllocator<span class="token punctuation">.</span>Handle</span> <span class="token function">recvBufAllocHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>recvHandle <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                recvHandle <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRecvByteBufAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> recvHandle<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>ф╗О allocHandle чЪДшО╖хПЦш┐ЗчиЛцИСф╗мчЬЛхИ░цЬА allocHandle чЪДхИЫх╗║цШпчФ▒<code>AdaptiveRecvByteBufAllocator#newHandle</code>цЦ╣ц│ХцЙзшбМчЪДуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AdaptiveRecvByteBufAllocator</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultMaxMessagesRecvByteBufAllocator</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Handle</span> <span class="token function">newHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HandleImpl</span><span class="token punctuation">(</span>minIndex<span class="token punctuation">,</span> maxIndex<span class="token punctuation">,</span> initial<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HandleImpl</span> <span class="token keyword">extends</span> <span class="token class-name">MaxMessageHandle</span> <span class="token punctuation">{</span>
        <span class="token comment">//цЬАх░Пхо╣щЗПхЬицЙйч╝йхо╣ч┤вх╝Хшбиф╕нчЪДindex</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> minIndex<span class="token punctuation">;</span>
        <span class="token comment">//цЬАхдзхо╣щЗПхЬицЙйч╝йхо╣ч┤вх╝Хшбиф╕нчЪДindex</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> maxIndex<span class="token punctuation">;</span>
        <span class="token comment">//х╜УхЙНхо╣щЗПхЬицЙйч╝йхо╣ч┤вх╝Хшбиф╕нчЪДindex хИЭхзЛ33 хп╣х║Фхо╣щЗП2048</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> index<span class="token punctuation">;</span>
        <span class="token comment">//щвДшобф╕Лф╕АцмбхИЖщЕНbufferчЪДхо╣щЗПя╝МхИЭхзЛя╝Ъ2048</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> nextReceiveBufferSize<span class="token punctuation">;</span>
        <span class="token comment">//цШпхРжч╝йхо╣</span>
        <span class="token keyword">private</span> <span class="token keyword">boolean</span> decreaseNow<span class="token punctuation">;</span>

        <span class="token class-name">HandleImpl</span><span class="token punctuation">(</span><span class="token keyword">int</span> minIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> maxIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> initial<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>minIndex <span class="token operator">=</span> minIndex<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>maxIndex <span class="token operator">=</span> maxIndex<span class="token punctuation">;</span>

            <span class="token comment">//хЬицЙйч╝йхо╣ч┤вх╝Хшбиф╕нф║МхИЖцЯецЙ╛хИ░цЬАх░Пхдзф║ОчнЙф║Оinitial чЪДхо╣щЗП</span>
            index <span class="token operator">=</span> <span class="token function">getSizeTableIndex</span><span class="token punctuation">(</span>initial<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//2048</span>
            nextReceiveBufferSize <span class="token operator">=</span> <span class="token constant">SIZE_TABLE</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>ш┐ЩщЗМцИСф╗мчЬЛхИ░ Netty ф╕нчФиф║ОхКицАБш░ГцХ┤ ByteBuffer хо╣щЗПчЪД<code>allocHandle</code>чЪДхоЮщЩЕч▒╗хЮЛф╕║<code>MaxMessageHandle</code>уАВ</p> <p>ф╕ЛщЭвцИСф╗мцЭеф╗Лч╗Нф╕Л<code>HandleImpl</code>ф╕нчЪДца╕х┐ГхнЧцо╡я╝МхоГф╗мщГ╜хТМ ByteBuffer чЪДхо╣щЗПцЬЙхЕ│я╝Ъ</p> <ul><li><code>minIndex</code> я╝ЪцЬАх░Пхо╣щЗПхЬицЙйч╝йхо╣ч┤вх╝Хшби<code>SIZE_TABE</code>ф╕нчЪД indexуАВщ╗ШшодцШп<code>3</code>уАВ</li> <li><code>maxIndex</code> я╝ЪцЬАхдзхо╣щЗПхЬицЙйч╝йхо╣ч┤вх╝Хшби<code>SIZE_TABE</code>ф╕нчЪД indexуАВщ╗ШшодцШп<code>38</code>уАВ</li> <li><code>index</code> я╝Ъх╜УхЙНхо╣щЗПхЬицЙйч╝йхо╣ч┤вх╝Хшби<code>SIZE_TABE</code>ф╕нчЪД indexуАВхИЭхзЛцШп<code>33</code>уАВ</li> <li><code>nextReceiveBufferSize</code> я╝ЪщвДшобф╕Лф╕АцмбхИЖщЕН buffer чЪДхо╣щЗПя╝МхИЭхзЛф╕║<code>2048</code>уАВхЬицпПцмбчФ│шп╖хЖЕхнШхИЖщЕН ByteBuffer чЪДцЧ╢хАЩя╝МщЗЗчФи<code>nextReceiveBufferSize</code>чЪДхА╝цМЗхоЪхо╣щЗПуАВ</li> <li><code>decreaseNow я╝Ъ</code> цШпхРжщЬАшжБш┐ЫшбМч╝йхо╣уАВ</li></ul> <h2 id="_5-ф╜┐чФихаЖхдЦхЖЕхнШф╕║-bytebuffer-хИЖщЕНхЖЕхнШ"><a href="#_5-ф╜┐чФихаЖхдЦхЖЕхнШф╕║-bytebuffer-хИЖщЕНхЖЕхнШ" class="header-anchor">#</a> 5. ф╜┐чФихаЖхдЦхЖЕхнШф╕║ ByteBuffer хИЖщЕНхЖЕхнШ</h2> <p>AdaptiveRecvByteBufAllocator ч▒╗хПкцШпш┤Яш┤гхКицАБш░ГцХ┤ ByteBuffer чЪДхо╣щЗПя╝МшАМхЕ╖ф╜Уф╕║ ByteBuffer чФ│шп╖хЖЕхнШчй║щЧ┤чЪДцШпчФ▒<code>PooledByteBufAllocator</code>ш┤Яш┤гуАВ</p> <h3 id="_5-1-ч▒╗хРНхЙНч╝А-pooled-чЪДцЭехОЖ"><a href="#_5-1-ч▒╗хРНхЙНч╝А-pooled-чЪДцЭехОЖ" class="header-anchor">#</a> 5.1 ч▒╗хРНхЙНч╝А Pooled чЪДцЭехОЖ</h3> <p>хЬицИСф╗мф╜┐чФи Java ш┐ЫшбМцЧех╕╕х╝АхПСш┐ЗчиЛф╕ня╝МхЬиф╕║хп╣ш▒бхИЖщЕНхЖЕхнШчй║щЧ┤чЪДцЧ╢хАЩцИСф╗мщГ╜ф╝ЪщАЙцЛйхЬи JVM хаЖф╕нф╕║хп╣ш▒бхИЖщЕНхЖЕхнШя╝Мш┐Щца╖хБЪхп╣цИСф╗м Java х╝АхПСшАЕчЙ╣хИлчЪДхПЛхе╜я╝МцИСф╗мхПкчобф╜┐чФих░▒хе╜шАМф╕Нх┐Еш┐ЗхдЪхЕ│х┐Гш┐ЩхЭЧчФ│шп╖чЪДхЖЕхнШхжВф╜ХхЫЮцФ╢я╝МхЫаф╕║ JVM хаЖхоМхЕихПЧ Java шЩЪцЛЯцЬ║цОзхИ╢чобчРЖя╝МJava шЩЪцЛЯцЬ║ф╝Ъх╕охКйцИСф╗мхЫЮцФ╢ф╕НхЖНф╜┐чФичЪДхЖЕхнШуАВ</p> <p>ф╜ЖцШп JVM хЬиш┐ЫшбМхЮГхЬ╛хЫЮцФ╢цЧ╢хАЩчЪД <code>stop the world</code> ф╝Ъхп╣цИСф╗мх║ФчФичиЛх║ПчЪДцАзшГ╜щАацИРф╕АхоЪчЪДх╜▒хУН</p> <p>щЩдцндф╣ЛхдЦцИСф╗мхЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247483737&amp;idx=1&amp;sn=7ef3afbb54289c6e839eed724bb8a9d6&amp;chksm=ce77c71ef9004e08e3d164561e3a2708fc210c05408fa41f7fe338d8e85f39c1ad57519b614e&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКшБКшБК Netty щВгф║Ыф║ЛхД┐ф╣Лф╗ОхЖЕца╕шзТх║жчЬЛ IO цибхЮЛуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕АцЦЗф╕нф╗Лч╗Н IO цибхЮЛчЪДцЧ╢хАЩцПРхИ░я╝Мх╜УцХ░цНош╛╛хИ░ч╜СхНбцЧ╢я╝Мч╜СхНбф╝ЪщАЪш┐З DMA чЪДцЦ╣х╝Пх░ЖцХ░цНоцЛ╖ш┤ЭхИ░хЖЕца╕чй║щЧ┤ф╕ня╝Мш┐ЩцШп<code>чммф╕АцмбцЛ╖ш┤Э</code>уАВх╜УчФицИ╖ч║┐чиЛхЬичФицИ╖чй║щЧ┤хПСш╡╖ч│╗ч╗Я IO ш░ГчФицЧ╢я╝МCPU ф╝Ъх░ЖхЖЕца╕чй║щЧ┤чЪДцХ░цНохЖНцмбцЛ╖ш┤ЭхИ░чФицИ╖чй║щЧ┤уАВш┐ЩцШп<code>чммф║МцмбцЛ╖ш┤Э</code>уАВ</p> <p>ф║Оцндф╕НхРМчЪДцШпх╜УцИСф╗мхЬи JVM ф╕нхПСш╡╖ IO ш░ГчФицЧ╢я╝МцпФхжВцИСф╗мф╜┐чФи JVM хаЖхЖЕхнШшп╗хПЦ <code>SocketцОецФ╢ч╝УхЖ▓хМ║</code> ф╕нчЪДцХ░цНоцЧ╢я╝М<strong>ф╝ЪхдЪф╕АцмбхЖЕхнШцЛ╖ш┤Э</strong>я╝МCPU хЬи<code>чммф║МцмбцЛ╖ш┤Э</code>ф╕нх░ЖцХ░цНоф╗ОхЖЕца╕чй║щЧ┤цЛ╖ш┤ЭхИ░чФицИ╖чй║щЧ┤цЧ╢я╝МцндцЧ╢чЪДчФицИ╖чй║щЧ┤члЩхЬи JVM шзТх║жцШп<code>хаЖхдЦхЖЕхнШ</code>я╝МцЙАф╗еш┐ШщЬАшжБх░ЖхаЖхдЦхЖЕхнШф╕нчЪДцХ░цНоцЛ╖ш┤ЭхИ░ <code>хаЖхЖЕхЖЕхнШ</code> ф╕нуАВш┐Щх░▒цШп <code>чммф╕ЙцмбхЖЕхнШцЛ╖ш┤Э</code></p> <p>хРМчРЖх╜УцИСф╗мхЬи JVM ф╕нхПСш╡╖ IO ш░ГчФихРС<code>SocketхПСщАБч╝УхЖ▓хМ║</code>хЖЩхЕецХ░цНоцЧ╢я╝МJVM ф╝Ъх░Ж IO цХ░цНохЕИ<code>цЛ╖ш┤Э</code>хИ░<code>хаЖхдЦхЖЕхнШ</code>я╝МчД╢хРОцЙНшГ╜хПСш╡╖ч│╗ч╗Я IO ш░ГчФиуАВ</p> <p><strong>щВгф╕║ф╗Аф╣ИцУНф╜Ьч│╗ч╗Яф╕НчЫ┤цОеф╜┐чФи JVM чЪД<code>хаЖхЖЕхЖЕхнШ</code>ш┐ЫшбМ<code>IOцУНф╜Ь</code>хСвя╝Я</strong></p> <p>хЫаф╕║ JVM чЪДхЖЕхнШх╕Гх▒АхТМцУНф╜Ьч│╗ч╗ЯхИЖщЕНчЪДхЖЕхнШцШпф╕Нф╕Аца╖чЪДя╝МцУНф╜Ьч│╗ч╗Яф╕НхПпшГ╜цМЙчЕз JVM шзДшМГцЭешп╗хЖЩцХ░цНоя╝МцЙАф╗ех░▒щЬАшжБ <code>чммф╕ЙцмбцЛ╖ш┤Э</code> ф╕нщЧ┤хБЪф╕кш╜мцНвх░ЖхаЖхдЦхЖЕхнШф╕нчЪДцХ░цНоцЛ╖ш┤ЭхИ░ JVM хаЖф╕нуАВ</p> <hr> <p>цЙАф╗ехЯ║ф║Оф╕Кш┐░хЖЕхо╣я╝МхЬиф╜┐чФи JVM хаЖхЖЕхЖЕхнШцЧ╢ф╝Ъф║зчФЯф╗еф╕Лф╕дчВ╣цАзшГ╜х╜▒хУНя╝Ъ</p> <ol><li>JVM хЬихЮГхЬ╛хЫЮцФ╢хаЖхЖЕхЖЕхнШцЧ╢я╝Мф╝ЪхПСчФЯ <code>stop the world</code> хп╝шЗ┤х║ФчФичиЛх║ПхНбщб┐уАВ</li> <li>хЬиш┐ЫшбМ IO цУНф╜ЬчЪДцЧ╢хАЩя╝Мф╝ЪхдЪф║зчФЯф╕АцмбчФ▒хаЖхдЦхЖЕхнШхИ░хаЖхЖЕхЖЕхнШчЪДцЛ╖ш┤ЭуАВ</li></ol> <p><strong>хЯ║ф║Оф╗еф╕Кф╕дчВ╣ф╜┐чФи<code>JVMхаЖхЖЕхЖЕхнШ</code>хп╣цАзшГ╜щАацИРчЪДх╜▒хУН</strong>я╝Мф║ОцШпхп╣цАзшГ╜цЬЙхНУш╢Кш┐╜ц▒ВчЪД Netty щЗЗчФи<code>хаЖхдЦхЖЕхнШ</code>ф╣Ях░▒цШп<code>DirectBuffer</code>цЭеф╕║ ByteBuffer хИЖщЕНхЖЕхнШчй║щЧ┤уАВ</p> <p>щЗЗчФихаЖхдЦхЖЕхнШф╕║ ByteBuffer хИЖщЕНхЖЕхнШчЪДхе╜хдДх░▒цШпя╝Ъ</p> <ul><li>хаЖхдЦхЖЕхнШчЫ┤цОехПЧцУНф╜Ьч│╗ч╗ЯчЪДчобчРЖя╝Мф╕Нф╝ЪхПЧ JVM чЪДчобчРЖя╝МцЙАф╗е JVM хЮГхЬ╛хЫЮцФ╢хп╣х║ФчФичиЛх║ПчЪДцАзшГ╜х╜▒хУНх░▒ц▓бцЬЙф║ЖуАВ</li> <li>ч╜Сч╗ЬцХ░цНохИ░ш╛╛ф╣ЛхРОчЫ┤цОехЬи<code>хаЖхдЦхЖЕхнШ</code>ф╕КцОецФ╢я╝Мш┐ЫчиЛшп╗хПЦч╜Сч╗ЬцХ░цНоцЧ╢чЫ┤цОехЬихаЖхдЦхЖЕхнШф╕ншп╗хПЦя╝МцЙАф╗ех░▒щБ┐хЕНф║Ж<code>чммф╕ЙцмбхЖЕхнШцЛ╖ш┤Э</code>уАВ</li></ul> <p>цЙАф╗е Netty хЬиш┐ЫшбМ I/O цУНф╜ЬцЧ╢щГ╜цШпф╜┐чФичЪДхаЖхдЦхЖЕхнШя╝МхПпф╗ещБ┐хЕНцХ░цНоф╗О JVM хаЖхЖЕхнШхИ░хаЖхдЦхЖЕхнШчЪДцЛ╖ш┤ЭуАВф╜ЖцШпчФ▒ф║ОхаЖхдЦхЖЕхнШф╕НхПЧ JVM чЪДчобчРЖя╝МцЙАф╗ех░▒щЬАшжБщвЭхдЦхЕ│ц│ихп╣хЖЕхнШчЪДф╜┐чФихТМщЗКцФ╛я╝МчиНцЬЙф╕НцЕОх░▒ф╝ЪщАацИРхЖЕхнШц│ДщЬ▓я╝Мф║ОцШп Netty х░▒х╝ХхЕеф║Ж<strong>хЖЕхнШц▒а</strong>хп╣<code>хаЖхдЦхЖЕхнШ</code>ш┐ЫшбМч╗Яф╕АчобчРЖуАВ</p> <p><strong>PooledByteBufAllocator ч▒╗чЪДш┐Щф╕кхЙНч╝А<code>Pooled</code>х░▒цШп<code>хЖЕхнШц▒а</code>чЪДцДПцАЭя╝Мш┐Щф╕кч▒╗ф╝Ъф╜┐чФи Netty чЪДхЖЕхнШц▒аф╕║ ByteBuffer хИЖщЕН<code>хаЖхдЦхЖЕхнШ</code>уАВ</strong></p> <h3 id="_5-2-pooledbytebufallocator-чЪДхИЫх╗║"><a href="#_5-2-pooledbytebufallocator-чЪДхИЫх╗║" class="header-anchor">#</a> 5.2 PooledByteBufAllocator чЪДхИЫх╗║</h3> <h4 id="хИЫх╗║цЧ╢цЬ║"><a href="#хИЫх╗║цЧ╢цЬ║" class="header-anchor">#</a> хИЫх╗║цЧ╢цЬ║</h4> <p>хЬицЬНхКбчлп NioServerSocketChannel чЪДщЕНч╜оч▒╗ NioServerSocketChannelConfig ф╗ехПКховцИ╖члп NioSocketChannel чЪДщЕНч╜оч▒╗ NioSocketChannelConfig<strong>хоЮф╛ЛхМЦчЪДцЧ╢хАЩф╝ЪшзжхПС</strong>PooledByteBufAllocator чЪДхИЫх╗║уАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultChannelConfig</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelConfig</span> <span class="token punctuation">{</span>
    <span class="token comment">//PooledByteBufAllocator</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">ByteBufAllocator</span> allocator <span class="token operator">=</span> <span class="token class-name">ByteBufAllocator</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хИЫх╗║хЗ║цЭечЪД PooledByteBufAllocator хоЮф╛Лф┐ЭхнШхЬи<code>DefaultChannelConfigч▒╗</code>ф╕нчЪД<code>ByteBufAllocator allocator</code>хнЧцо╡ф╕нуАВ</p> <h4 id="хИЫх╗║ш┐ЗчиЛ"><a href="#хИЫх╗║ш┐ЗчиЛ" class="header-anchor">#</a> хИЫх╗║ш┐ЗчиЛ</h4> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ByteBufAllocator</span> <span class="token punctuation">{</span>

    <span class="token class-name">ByteBufAllocator</span> <span class="token constant">DEFAULT</span> <span class="token operator">=</span> <span class="token class-name">ByteBufUtil</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_ALLOCATOR</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ByteBufUtil</span> <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ByteBufAllocator</span> <span class="token constant">DEFAULT_ALLOCATOR</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> allocType <span class="token operator">=</span> <span class="token class-name">SystemPropertyUtil</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
                <span class="token string">&quot;io.netty.allocator.type&quot;</span><span class="token punctuation">,</span> <span class="token class-name">PlatformDependent</span><span class="token punctuation">.</span><span class="token function">isAndroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&quot;unpooled&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;pooled&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        allocType <span class="token operator">=</span> allocType<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span><span class="token constant">US</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ByteBufAllocator</span> alloc<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;unpooled&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>allocType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            alloc <span class="token operator">=</span> <span class="token class-name">UnpooledByteBufAllocator</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;-Dio.netty.allocator.type: {}&quot;</span><span class="token punctuation">,</span> allocType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;pooled&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>allocType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            alloc <span class="token operator">=</span> <span class="token class-name">PooledByteBufAllocator</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;-Dio.netty.allocator.type: {}&quot;</span><span class="token punctuation">,</span> allocType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            alloc <span class="token operator">=</span> <span class="token class-name">PooledByteBufAllocator</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;-Dio.netty.allocator.type: pooled (unknown: {})&quot;</span><span class="token punctuation">,</span> allocType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token constant">DEFAULT_ALLOCATOR</span> <span class="token operator">=</span> alloc<span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ф╗О ByteBufUtil ч▒╗чЪДхИЭхзЛхМЦш┐ЗчиЛцИСф╗мхПпф╗ечЬЛхЗ║я╝МхЬиф╕║ ByteBuffer хИЖщЕНхЖЕхнШчЪДцЧ╢хАЩцШпхРжф╜┐чФихЖЕхнШц▒ахЬи Netty ф╕нцШпхПпф╗ещЕНч╜очЪДуАВ</p> <ul><li>щАЪш┐Зч│╗ч╗ЯхПШщЗП<code>-D io.netty.allocator.type</code> хПпф╗ещЕНч╜оцШпхРжф╜┐чФихЖЕхнШц▒аф╕║ ByteBuffer хИЖщЕНхЖЕхнШуАВщ╗ШшодцГЕхЖ╡ф╕ЛцШпщЬАшжБф╜┐чФихЖЕхнШц▒ачЪДуАВф╜ЖцШпхЬихоЙхНУч│╗ч╗Яф╕нщ╗ШшодцШпф╕Нф╜┐чФихЖЕхнШц▒ачЪДуАВ</li> <li>щАЪш┐З<code>PooledByteBufAllocator.DEFAULT</code>шО╖хПЦ<strong>хЖЕхнШц▒а ByteBuffer хИЖщЕНхЩи</strong>уАВ</li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">PooledByteBufAllocator</span> <span class="token constant">DEFAULT</span> <span class="token operator">=</span>
    <span class="token keyword">new</span> <span class="token class-name">PooledByteBufAllocator</span><span class="token punctuation">(</span><span class="token class-name">PlatformDependent</span><span class="token punctuation">.</span><span class="token function">directBufferPreferred</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>чФ▒ф║ОцЬмцЦЗчЪДф╕╗ч║┐цШпф╗Лч╗Н Sub Reactor хдДчРЖ<code>OP_READф║Лф╗╢</code>чЪДхоМцХ┤ш┐ЗчиЛя╝МцЙАф╗еш┐ЩщЗМхПкф╗Лч╗Нф╕╗ч║┐чЫ╕хЕ│чЪДхЖЕхо╣я╝Мш┐ЩщЗМхПкцШпчоАхНХф╗Лч╗Нф╕ЛхЬицОецФ╢цХ░цНочЪДцЧ╢хАЩф╕║ф╗Аф╣Иф╝ЪчФи<code>PooledByteBufAllocator</code>цЭеф╕║<code>ByteBuffer</code>хИЖщЕНхЖЕхнШуАВшАМхЖЕхнШц▒ачЪДцЮ╢цЮДшо╛шобцпФш╛ГхдНцЭВя╝МцЙАф╗ечмФшАЕхРОщЭвф╝ЪхНХчЛмхЖЩф╕АчпЗхЕ│ф║О Netty хЖЕхнШчобчРЖчЪДцЦЗчлауАВ</p></blockquote> <hr> <h2 id="цА╗ч╗У"><a href="#цА╗ч╗У" class="header-anchor">#</a> цА╗ч╗У</h2> <p>цЬмцЦЗф╗Лч╗Нф║Ж Sub Reactor ч║┐чиЛхЬихдДчРЖ OP_READ ф║Лф╗╢чЪДцХ┤ф╕кш┐ЗчиЛуАВх╣╢ц╖▒хЕехЙЦцЮРф║Ж AdaptiveRecvByteBufAllocator ч▒╗хКицАБш░ГцХ┤ ByteBuffer хо╣щЗПчЪДхОЯчРЖуАВ</p> <p>хРМцЧ╢ф╣Яф╗Лч╗Нф║Ж Netty ф╕║ф╗Аф╣Иф╝Ъф╜┐чФихаЖхдЦхЖЕхнШцЭеф╕║ ByteBuffer хИЖщЕНхЖЕхнШя╝Мх╣╢чФ▒цндх╝ХхЗ║ф║Ж Netty чЪДхЖЕхнШц▒ахИЖщЕНхЩи PooledByteBufAllocator уАВ</p> <p>хЬиф╗Лч╗Н AdaptiveRecvByteBufAllocator ч▒╗хТМ PooledByteBufAllocator ф╕Аш╡╖ч╗ДхРИхоЮчО░хКицАБхЬ░ф╕║ ByteBuffer хИЖщЕНхо╣щЗПчЪДцЧ╢хАЩя╝МчмФшАЕф╕НчжБцГ│ш╡╖ф║ЖхдЪх╣┤хЙНчЬЛш┐ЗчЪДуАКEffective JavaуАЛф╕нчмм 16 цЭб <code>хдНхРИф╝ШхЕИф║Оч╗зцЙ┐</code>уАВ</p> <p>Netty хЬиш┐ЩщЗМф╣ЯщБ╡х╛кф║Жш┐ЩцЭбхЖЫшзДя╝МщжЦхЕИф╕дф╕кч▒╗шо╛шобчЪДщГ╜цШпхНХф╕АчЪДхКЯшГ╜уАВ</p> <ul><li>AdaptiveRecvByteBufAllocator ч▒╗хПкш┤Яш┤гхКицАБчЪДш░ГцХ┤ ByteBuffer хо╣щЗПя╝Мх╣╢ф╕НчобхЕ╖ф╜УчЪДхЖЕхнШхИЖщЕНуАВ</li> <li>PooledByteBufAllocator ч▒╗ш┤Яш┤гхЕ╖ф╜УчЪДхЖЕхнШхИЖщЕНя╝МчФихЖЕхнШц▒ачЪДцЦ╣х╝ПуАВ</li></ul> <p>ш┐Щца╖шо╛шобчЪДх░▒цпФш╛ГчБ╡ц┤╗я╝МхЕ╖ф╜УхЖЕхнШхИЖщЕНчЪДх╖еф╜Ьф║дч╗ЩхЕ╖ф╜УчЪД<code>ByteBufAllocator</code>,хПпф╗еф╜┐чФихЖЕхнШц▒ачЪДхИЖщЕНцЦ╣х╝П<code>PooledByteBufAllocator</code>я╝Мф╣ЯхПпф╗еф╕Нф╜┐чФихЖЕхнШц▒ачЪДхИЖщЕНцЦ╣х╝П<code>UnpooledByteBufAllocator</code>уАВхЕ╖ф╜УчЪДхЖЕхнШхПпф╗ещЗЗчФи JVM хаЖхЖЕхЖЕхнШя╝ИHeapBufferя╝Йя╝Мф╣ЯхПпф╗еф╜┐чФихаЖхдЦхЖЕхнШя╝ИDirectBufferя╝ЙуАВ</p> <p>шАМ<code>AdaptiveRecvByteBufAllocator</code>хПкщЬАшжБхЕ│ц│иш░ГцХ┤хоГф╗мчЪДхо╣щЗПх╖еф╜Ьх░▒хПпф╗еф║Жя╝МшАМх╣╢ф╕НщЬАшжБхЕ│ц│ихоГф╗мхЕ╖ф╜УчЪДхЖЕхнШхИЖщЕНцЦ╣х╝ПуАВ</p> <p>цЬАхРОщАЪш┐З<code>io.netty.channel.RecvByteBufAllocator.Handle#allocate</code>цЦ╣ц│ХчБ╡ц┤╗ч╗ДхРИф╕НхРМчЪДхЖЕхнШхИЖщЕНцЦ╣х╝ПуАВш┐Щф╣ЯцШп<code>шгЕще░цибх╝П</code>чЪДф╕АчзНх║ФчФиуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code>byteBuf <span class="token operator">=</span> allocHandle<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>allocator<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>хе╜ф║Жя╝Мф╗КхдйчЪДхЖЕхо╣х░▒хИ░ш┐ЩщЗМя╝МцИСф╗мф╕ЛчпЗцЦЗчлашзБ~~~~</p> <h2 id="хПВшАГш╡ДцЦЩ"><a href="#хПВшАГш╡ДцЦЩ" class="header-anchor">#</a> хПВшАГш╡ДцЦЩ</h2> <p><a href="https://mp.weixin.qq.com/s/KhpNjA8vDQSBipoDMILvOQ" target="_blank" rel="noopener noreferrer">Netty хжВф╜ХщлШцХИцОецФ╢ч╜Сч╗ЬцХ░цНоя╝Яф╕АцЦЗшБКщАП ByteBuffer хКицАБшЗкщАВх║ФцЙйч╝йхо╣цЬ║хИ╢ (qq.com)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/echo-lxy/echo-system-design/edit/master/docs/Netty ч│╗ч╗Яшо╛шоб/25.хЫЫуАБц╖▒хЕе Netty ца╕х┐Г/18.чммф║Фшп╛я╝ЪNetty хжВф╜ХщлШцХИцОецФ╢ч╜Сч╗ЬцХ░цНо.md" target="_blank" rel="noopener noreferrer">ч╝Цш╛С</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">ф╕КцмбцЫ┤цЦ░ф║О:</span> <span class="time">2024/09/19, 09:39:02</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        тЖР
        <a href="/pages/be98dc/" class="prev">чммхЫЫшп╛я╝ЪNetty хжВф╜ХщлШцХИцОецФ╢ч╜Сч╗Ьш┐ЮцОе</a></span> <span class="next"><a href="/pages/a73206/">чммхЕншп╛я╝ЪNetty хжВф╜ХщлШцХИхПСщАБч╜Сч╗ЬцХ░цНо</a>тЖТ
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:lixinyang2002@163.com" title="хПСщВоф╗╢" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/echo-lxy" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="хРмщЯ│ф╣Р" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="цЬмчлЩф╕╗щвШ">Vdoing</a> 
    | Copyright ┬й 2024-2024
    <span>Xinyang Li | MIT License</span></div> <div class="buttons"><div title="ш┐ФхЫЮщб╢щГи" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="хО╗шпДшо║" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ф╕╗щвШцибх╝П" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          ш╖ЯщЪПч│╗ч╗Я
        </li><li class="iconfont icon-rijianmoshi">
          ц╡ЕшЙ▓цибх╝П
        </li><li class="iconfont icon-yejianmoshi">
          ц╖▒шЙ▓цибх╝П
        </li><li class="iconfont icon-yuedu">
          щШЕшп╗цибх╝П
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.a0e02413.js" defer></script><script src="/assets/js/2.933750c6.js" defer></script><script src="/assets/js/55.2b9fbb7f.js" defer></script><script src="/assets/js/7.7eb70372.js" defer></script>
  </body>
</html>
