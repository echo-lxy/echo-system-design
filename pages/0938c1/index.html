<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ç¬¬äº”è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œæ•°æ® | EchoDesign</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="ç³»ç»Ÿè®¾è®¡ä¹‹ã€Œè®²è§£ + é¢è¯•æŒ‡å—ã€ï¼Œæ°´æ»´çŸ³ç©¿ï¼Œè®¾è®¡æ— é“¶å¼¹ï¼">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.c76c3453.css" as="style"><link rel="preload" href="/assets/js/app.a0e02413.js" as="script"><link rel="preload" href="/assets/js/2.933750c6.js" as="script"><link rel="preload" href="/assets/js/55.2b9fbb7f.js" as="script"><link rel="preload" href="/assets/js/7.7eb70372.js" as="script"><link rel="prefetch" href="/assets/js/10.b313d17c.js"><link rel="prefetch" href="/assets/js/100.2b21dce5.js"><link rel="prefetch" href="/assets/js/101.96ca71f6.js"><link rel="prefetch" href="/assets/js/11.71fe9642.js"><link rel="prefetch" href="/assets/js/12.38d1989d.js"><link rel="prefetch" href="/assets/js/13.850793b0.js"><link rel="prefetch" href="/assets/js/14.1141ec27.js"><link rel="prefetch" href="/assets/js/15.12d1dea8.js"><link rel="prefetch" href="/assets/js/16.5a9b32ee.js"><link rel="prefetch" href="/assets/js/17.acb3bf3d.js"><link rel="prefetch" href="/assets/js/18.e491edb6.js"><link rel="prefetch" href="/assets/js/19.daf31819.js"><link rel="prefetch" href="/assets/js/20.d70e5281.js"><link rel="prefetch" href="/assets/js/21.0e0ed140.js"><link rel="prefetch" href="/assets/js/22.dd779f94.js"><link rel="prefetch" href="/assets/js/23.4d814163.js"><link rel="prefetch" href="/assets/js/24.891fe6fb.js"><link rel="prefetch" href="/assets/js/25.41dca26b.js"><link rel="prefetch" href="/assets/js/26.6337eac0.js"><link rel="prefetch" href="/assets/js/27.de80589e.js"><link rel="prefetch" href="/assets/js/28.95a1fb6b.js"><link rel="prefetch" href="/assets/js/29.371a40e1.js"><link rel="prefetch" href="/assets/js/3.0393001c.js"><link rel="prefetch" href="/assets/js/30.e32f6b31.js"><link rel="prefetch" href="/assets/js/31.a532917f.js"><link rel="prefetch" href="/assets/js/32.13b70e91.js"><link rel="prefetch" href="/assets/js/33.64ab8d0c.js"><link rel="prefetch" href="/assets/js/34.6d3cc288.js"><link rel="prefetch" href="/assets/js/35.2760ed8d.js"><link rel="prefetch" href="/assets/js/36.4fd54c47.js"><link rel="prefetch" href="/assets/js/37.51145580.js"><link rel="prefetch" href="/assets/js/38.40fe2658.js"><link rel="prefetch" href="/assets/js/39.84b6e82e.js"><link rel="prefetch" href="/assets/js/4.73518a0f.js"><link rel="prefetch" href="/assets/js/40.591baf2a.js"><link rel="prefetch" href="/assets/js/41.f961e422.js"><link rel="prefetch" href="/assets/js/42.b34f1599.js"><link rel="prefetch" href="/assets/js/43.5a509601.js"><link rel="prefetch" href="/assets/js/44.64fd3383.js"><link rel="prefetch" href="/assets/js/45.685623ac.js"><link rel="prefetch" href="/assets/js/46.7624d38c.js"><link rel="prefetch" href="/assets/js/47.5646b068.js"><link rel="prefetch" href="/assets/js/48.a1b270df.js"><link rel="prefetch" href="/assets/js/49.ee9681bc.js"><link rel="prefetch" href="/assets/js/5.94727770.js"><link rel="prefetch" href="/assets/js/50.b424b2c0.js"><link rel="prefetch" href="/assets/js/51.ef213b56.js"><link rel="prefetch" href="/assets/js/52.18c75eba.js"><link rel="prefetch" href="/assets/js/53.a4f1720a.js"><link rel="prefetch" href="/assets/js/54.8604fc24.js"><link rel="prefetch" href="/assets/js/56.13fd4db7.js"><link rel="prefetch" href="/assets/js/57.be37bfce.js"><link rel="prefetch" href="/assets/js/58.ca1aa081.js"><link rel="prefetch" href="/assets/js/59.7b7e3faf.js"><link rel="prefetch" href="/assets/js/6.0b558b79.js"><link rel="prefetch" href="/assets/js/60.96815912.js"><link rel="prefetch" href="/assets/js/61.08b4acf0.js"><link rel="prefetch" href="/assets/js/62.d5f3cb0d.js"><link rel="prefetch" href="/assets/js/63.392eea42.js"><link rel="prefetch" href="/assets/js/64.9b3def35.js"><link rel="prefetch" href="/assets/js/65.0b2ab47d.js"><link rel="prefetch" href="/assets/js/66.b54930de.js"><link rel="prefetch" href="/assets/js/67.b666ce97.js"><link rel="prefetch" href="/assets/js/68.1b76c178.js"><link rel="prefetch" href="/assets/js/69.32609e29.js"><link rel="prefetch" href="/assets/js/70.b920a5f7.js"><link rel="prefetch" href="/assets/js/71.37ec984a.js"><link rel="prefetch" href="/assets/js/72.d0b495b4.js"><link rel="prefetch" href="/assets/js/73.caa8364a.js"><link rel="prefetch" href="/assets/js/74.26f8d9a5.js"><link rel="prefetch" href="/assets/js/75.dc7fdd0f.js"><link rel="prefetch" href="/assets/js/76.32858593.js"><link rel="prefetch" href="/assets/js/77.7b3f6980.js"><link rel="prefetch" href="/assets/js/78.746b48c5.js"><link rel="prefetch" href="/assets/js/79.173bbc8c.js"><link rel="prefetch" href="/assets/js/8.0ec7f6e8.js"><link rel="prefetch" href="/assets/js/80.78a31e84.js"><link rel="prefetch" href="/assets/js/81.35661fac.js"><link rel="prefetch" href="/assets/js/82.e54c087e.js"><link rel="prefetch" href="/assets/js/83.fff2e0cc.js"><link rel="prefetch" href="/assets/js/84.27dda1ee.js"><link rel="prefetch" href="/assets/js/85.f69467b2.js"><link rel="prefetch" href="/assets/js/86.931cbb70.js"><link rel="prefetch" href="/assets/js/87.78b2eebd.js"><link rel="prefetch" href="/assets/js/88.03774161.js"><link rel="prefetch" href="/assets/js/89.e6cb2516.js"><link rel="prefetch" href="/assets/js/9.2ac86403.js"><link rel="prefetch" href="/assets/js/90.f99f7813.js"><link rel="prefetch" href="/assets/js/91.2b9bd4e6.js"><link rel="prefetch" href="/assets/js/92.6b777d4b.js"><link rel="prefetch" href="/assets/js/93.f8975bc4.js"><link rel="prefetch" href="/assets/js/94.0b55855d.js"><link rel="prefetch" href="/assets/js/95.342f5a9b.js"><link rel="prefetch" href="/assets/js/96.15d8e4f1.js"><link rel="prefetch" href="/assets/js/97.0a9a6187.js"><link rel="prefetch" href="/assets/js/98.b46fd254.js"><link rel="prefetch" href="/assets/js/99.d1ca4fc0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c76c3453.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="ç›®å½•" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="EchoDesign" class="logo"> <span class="site-name can-hide">EchoDesign</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">ğŸ é¦–é¡µ</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">âœ’ï¸çƒ­é—¨ç®—æ³•</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ğŸ–ï¸èµæç»å…¸è®¾è®¡" class="dropdown-title"><!----> <span class="title" style="display:;">ğŸ–ï¸èµæç»å…¸è®¾è®¡</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ç³»ç»Ÿè®¾è®¡</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ğŸ§‘â€ğŸ’»å®æˆ˜ç³»ç»Ÿè®¾è®¡</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">â“é—®ç­”</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ğŸ‘€åŠ¨æ€</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">ğŸ é¦–é¡µ</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">âœ’ï¸çƒ­é—¨ç®—æ³•</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ğŸ–ï¸èµæç»å…¸è®¾è®¡" class="dropdown-title"><!----> <span class="title" style="display:;">ğŸ–ï¸èµæç»å…¸è®¾è®¡</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ç³»ç»Ÿè®¾è®¡</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ğŸ§‘â€ğŸ’»å®æˆ˜ç³»ç»Ÿè®¾è®¡</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">â“é—®ç­”</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ğŸ‘€åŠ¨æ€</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ä¸€ã€å‰è¨€</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>äºŒã€åŸºç¡€çŸ¥è¯†</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ä¸‰ã€ä¸»çº¿ä»»åŠ¡</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>å››ã€æ·±å…¥ Netty æ ¸å¿ƒ</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/65674f/" class="sidebar-link">ç¬¬ä¸€è¯¾ï¼šé€è¿‡ Netty çœ‹ IO æ¨¡å‹</a></li><li><a href="/pages/440035/" class="sidebar-link">ç¬¬äºŒè¯¾ï¼šReactoråœ¨ Netty ä¸­çš„å®ç°ï¼ˆåˆ›å»ºç¯‡ï¼‰</a></li><li><a href="/pages/bb668a/" class="sidebar-link">ç¬¬ä¸‰è¯¾ï¼šNetty æ ¸å¿ƒå¼•æ“ Reactor çš„è¿è½¬æ¶æ„</a></li><li><a href="/pages/be98dc/" class="sidebar-link">ç¬¬å››è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œè¿æ¥</a></li><li><a href="/pages/0938c1/" aria-current="page" class="active sidebar-link">ç¬¬äº”è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œæ•°æ®</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/0938c1/#å‰è¨€" class="sidebar-link">å‰è¨€</a></li><li class="sidebar-sub-header level2"><a href="/pages/0938c1/#_1-sub-reactor-å¤„ç†-op-read-äº‹ä»¶æµç¨‹æ€»è§ˆ" class="sidebar-link">1. Sub Reactor å¤„ç† OP_READ äº‹ä»¶æµç¨‹æ€»è§ˆ</a></li><li class="sidebar-sub-header level2"><a href="/pages/0938c1/#_2-netty-æ¥æ”¶ç½‘ç»œæ•°æ®æµç¨‹æ€»è§ˆ" class="sidebar-link">2. Netty æ¥æ”¶ç½‘ç»œæ•°æ®æµç¨‹æ€»è§ˆ</a></li><li class="sidebar-sub-header level2"><a href="/pages/0938c1/#_3-æºç æ ¸å¿ƒæ¡†æ¶æ€»è§ˆ" class="sidebar-link">3. æºç æ ¸å¿ƒæ¡†æ¶æ€»è§ˆ</a></li><li class="sidebar-sub-header level2"><a href="/pages/0938c1/#_4-bytebuffer-åŠ¨æ€è‡ªé€‚åº”æ‰©ç¼©å®¹æœºåˆ¶" class="sidebar-link">4. ByteBuffer åŠ¨æ€è‡ªé€‚åº”æ‰©ç¼©å®¹æœºåˆ¶</a></li><li class="sidebar-sub-header level2"><a href="/pages/0938c1/#_5-ä½¿ç”¨å †å¤–å†…å­˜ä¸º-bytebuffer-åˆ†é…å†…å­˜" class="sidebar-link">5. ä½¿ç”¨å †å¤–å†…å­˜ä¸º ByteBuffer åˆ†é…å†…å­˜</a></li><li class="sidebar-sub-header level2"><a href="/pages/0938c1/#æ€»ç»“" class="sidebar-link">æ€»ç»“</a></li><li class="sidebar-sub-header level2"><a href="/pages/0938c1/#å‚è€ƒèµ„æ–™" class="sidebar-link">å‚è€ƒèµ„æ–™</a></li></ul></li><li><a href="/pages/a73206/" class="sidebar-link">ç¬¬å…­è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆå‘é€ç½‘ç»œæ•°æ®</a></li><li><a href="/pages/a1b0fe/" class="sidebar-link">ç¬¬ä¸ƒè¯¾ï¼šNetty ä¸­IOäº‹ä»¶çš„è§¦å‘æ—¶æœºå’Œä¼ æ’­æµç¨‹</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>äº”ã€æ·±å…¥ Netty å†…å­˜ç®¡ç†</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="é¦–é¡µ" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>Netty ç³»ç»Ÿè®¾è®¡</span></li><li data-v-06225672><span data-v-06225672>å››ã€æ·±å…¥ Netty æ ¸å¿ƒ</span></li></ul> <div class="info" data-v-06225672><div title="ä½œè€…" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/brother-one" target="_blank" title="ä½œè€…" class="beLink" data-v-06225672>echo</a></div> <div title="åˆ›å»ºæ—¶é—´" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-09-19</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">ç›®å½•</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">ç¬¬äº”è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œæ•°æ®<!----></h1> <div class="page-slot page-slot-top">
    <div class="wwads-cn wwads-horizontal page-wwads" data-id="136"></div>
    <style>
      .page-wwads{
        width:100%!important;
        min-height: 0;
        margin: 0;
      }
      .page-wwads .wwads-img img{
        width:80px!important;
      }
      .page-wwads .wwads-poweredby{
        width: 40px;
        position: absolute;
        right: 25px;
        bottom: 3px;
      }
      .wwads-content .wwads-text, .page-wwads .wwads-text{
        height: 100%;
        padding-top: 5px;
        display: block;
      }
  </style>
  </div> <div class="theme-vdoing-content content__default"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="header-anchor">#</a> å‰è¨€</h2> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191130021.png" alt="å›¾ç‰‡"></p> <h3 id="å‰æ–‡å›é¡¾"><a href="#å‰æ–‡å›é¡¾" class="header-anchor">#</a> å‰æ–‡å›é¡¾</h3> <p>åœ¨å‰è¾¹çš„ç³»åˆ—æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä»å†…æ ¸å¦‚ä½•æ”¶å‘ç½‘ç»œæ•°æ®å¼€å§‹ä»¥ä¸€ä¸ª C10K çš„é—®é¢˜ä½œä¸ºä¸»çº¿è¯¦ç»†ä»å†…æ ¸è§’åº¦é˜è¿°äº†ç½‘ç»œ IO æ¨¡å‹çš„æ¼”å˜ï¼Œæœ€ç»ˆåœ¨æ­¤åŸºç¡€ä¸Šå¼•å‡ºäº† Netty çš„ç½‘ç»œ IO æ¨¡å‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191130408.png" alt="å›¾ç‰‡"></p> <blockquote><p>è¯¦ç»†å†…å®¹å¯å›çœ‹<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247483737&amp;idx=1&amp;sn=7ef3afbb54289c6e839eed724bb8a9d6&amp;chksm=ce77c71ef9004e08e3d164561e3a2708fc210c05408fa41f7fe338d8e85f39c1ad57519b614e&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€Šä»å†…æ ¸è§’åº¦çœ‹ IO æ¨¡å‹çš„æ¼”å˜ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>åç»­æˆ‘ä»¬åˆå›´ç»•ç€ Netty çš„ä¸»ä» Reactor ç½‘ç»œ IO çº¿ç¨‹æ¨¡å‹ï¼Œåœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247483907&amp;idx=1&amp;sn=084c470a8fe6234c2c9461b5f713ff30&amp;chksm=ce77c444f9004d52e7c6244bee83479070effb0bc59236df071f4d62e91e25f01715fca53696&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€ŠReactor æ¨¡å‹åœ¨ Netty ä¸­çš„å®ç°ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸€æ–‡ä¸­è¯¦ç»†é˜è¿°äº† Netty çš„ä¸»ä» Reactor æ¨¡å‹çš„åˆ›å»ºï¼Œä»¥åŠä»‹ç»äº† Reactor æ¨¡å‹çš„å…³é”®ç»„ä»¶ã€‚æ­å»ºäº† Netty çš„æ ¸å¿ƒéª¨æ¶å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191130297.png" alt="å›¾ç‰‡"></p> <p>åœ¨æ ¸å¿ƒéª¨æ¶æ­å»ºå®Œæ¯•ä¹‹åï¼Œæˆ‘ä»¬éšååˆåœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484005&amp;idx=1&amp;sn=52f51269902a58f40d33208421109bc3&amp;chksm=ce77c422f9004d340e5b385ef6ba24dfba1f802076ace80ad6390e934173a10401e64e13eaeb&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€Šè¯¦ç»†å›¾è§£ Reactor å¯åŠ¨å…¨æµç¨‹ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸€æ–‡ä¸­é˜è¿°äº† Reactor å¯åŠ¨çš„å…¨æµç¨‹ï¼Œä¸€ä¸ªéå¸¸é‡è¦çš„æ ¸å¿ƒç»„ä»¶ NioServerSocketChannel å¼€å§‹åœ¨è¿™é‡Œåˆæ¬¡äº®ç›¸ï¼Œæ‰¿æ‹…ç€ä¸€ä¸ªç½‘ç»œæ¡†æ¶æœ€é‡è¦çš„ä»»åŠ¡--é«˜æ•ˆæ¥æ”¶ç½‘ç»œè¿æ¥ã€‚æˆ‘ä»¬ä»‹ç»äº† NioServerSocketChannel çš„åˆ›å»ºï¼Œåˆå§‹åŒ–ï¼Œå‘ Main Reactor æ³¨å†Œå¹¶ç›‘å¬ OP_ACCEPT äº‹ä»¶çš„æ•´ä¸ªæµç¨‹ã€‚åœ¨æ­¤åŸºç¡€ä¸Šï¼ŒNetty å¾—ä»¥æ•´è£…å¾…å‘ï¼Œæ•æˆˆå¾…æ—¦å¼€å§‹è¿æ¥æµ·é‡çš„å®¢æˆ·ç«¯è¿æ¥ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191130695.png" alt="å›¾ç‰‡"></p> <p>éšåç´§æ¥ç€æˆ‘ä»¬åœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484184&amp;idx=1&amp;sn=726877ce28cf6e5d2ac3225fae687f19&amp;chksm=ce77c55ff9004c493b592288819dc4d4664b5949ee97fed977b6558bc517dad0e1f73fab0f46&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€ŠNetty å¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œè¿æ¥ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸€æ–‡ä¸­è¯¦ç»†ä»‹ç»äº† Netty é«˜æ•ˆæ¥æ”¶å®¢æˆ·ç«¯ç½‘ç»œè¿æ¥çš„å…¨æµç¨‹ï¼Œåœ¨è¿™é‡Œ Netty çš„æ ¸å¿ƒé‡è¦ç»„ä»¶ NioServerSocketChannel å¼€å§‹æ­£æ˜¯ç™»åœºï¼Œåœ¨ NioServerSocketChannel ä¸­æˆ‘ä»¬åˆ›å»ºäº†å®¢æˆ·ç«¯è¿æ¥ NioSocketChannelï¼Œå¹¶è¯¦ç»†ä»‹ç»äº† NioSocketChannel çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œéšåé€šè¿‡åœ¨ NioServerSocketChannel çš„ pipeline ä¸­è§¦å‘ ChannelRead äº‹ä»¶ï¼Œå¹¶æœ€ç»ˆåœ¨ ServerBootstrapAcceptor ä¸­å°†å®¢æˆ·ç«¯è¿æ¥ NioSocketChannel æ³¨å†Œåˆ° Sub Reactor ä¸­å¼€å§‹ç›‘å¬å®¢æˆ·ç«¯è¿æ¥ä¸Šçš„ OP_READ äº‹ä»¶ï¼Œå‡†å¤‡æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„ç½‘ç»œæ•°æ®ä¹Ÿå°±æ˜¯æœ¬æ–‡çš„ä¸»é¢˜å†…å®¹ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191130550.png" alt="å›¾ç‰‡"></p> <p>è‡ªæ­¤ Netty çš„æ ¸å¿ƒç»„ä»¶å…¨éƒ¨å°±ç»ªå¹¶å¯åŠ¨å®Œæ¯•ï¼Œå¼€å§‹èµ·é£~~~</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191130148.png" alt="å›¾ç‰‡"></p> <p>ä¹‹å‰æ–‡ç« ä¸­çš„ä¸»è§’æ˜¯ Netty ä¸­ä¸» Reactor ç»„ä¸­çš„ Main Reactor ä»¥åŠæ³¨å†Œåœ¨ Main Reactor ä¸Šè¾¹çš„ NioServerSocketChannelï¼Œé‚£ä¹ˆä»æœ¬æ–‡å¼€å§‹ï¼Œæˆ‘ä»¬æ–‡ç« ä¸­çš„ä¸»è§’å°±åˆ‡æ¢ä¸º Sub Reactor ä»¥åŠæ³¨å†Œåœ¨ SubReactor ä¸Šçš„ NioSocketChannel äº†ã€‚</p> <p>ä¸‹é¢å°±è®©æˆ‘ä»¬æ­£å¼è¿›å…¥ä»Šå¤©çš„ä¸»é¢˜ï¼Œçœ‹ä¸€ä¸‹ Netty æ˜¯å¦‚ä½•å¤„ç† OP_READ äº‹ä»¶ä»¥åŠå¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œæ•°æ®çš„ã€‚</p> <h2 id="_1-sub-reactor-å¤„ç†-op-read-äº‹ä»¶æµç¨‹æ€»è§ˆ"><a href="#_1-sub-reactor-å¤„ç†-op-read-äº‹ä»¶æµç¨‹æ€»è§ˆ" class="header-anchor">#</a> 1. Sub Reactor å¤„ç† OP_READ äº‹ä»¶æµç¨‹æ€»è§ˆ</h2> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191543052.webp" alt="å›¾ç‰‡"></p> <p>å®¢æˆ·ç«¯å‘èµ·ç³»ç»Ÿ IO è°ƒç”¨å‘æœåŠ¡ç«¯å‘é€æ•°æ®ä¹‹åï¼Œå½“ç½‘ç»œæ•°æ®åˆ°è¾¾æœåŠ¡ç«¯çš„ç½‘å¡å¹¶ç»è¿‡å†…æ ¸åè®®æ ˆçš„å¤„ç†ï¼Œæœ€ç»ˆæ•°æ®åˆ°è¾¾ Socket çš„æ¥æ”¶ç¼“å†²åŒºä¹‹åï¼ŒSub Reactor è½®è¯¢åˆ° NioSocketChannel ä¸Šçš„ <code>OP_READäº‹ä»¶</code> å°±ç»ªï¼Œéšå Sub Reactor çº¿ç¨‹å°±ä¼šä» JDK Selector ä¸Šçš„é˜»å¡è½®è¯¢ API<code>selector.select(timeoutMillis)</code>è°ƒç”¨ä¸­è¿”å›ã€‚è½¬è€Œå»å¤„ç† NioSocketChannel ä¸Šçš„<code>OP_READäº‹ä»¶</code>ã€‚</p> <blockquote><p>æ³¨æ„è¿™é‡Œçš„ Reactor ä¸ºè´Ÿè´£å¤„ç†å®¢æˆ·ç«¯è¿æ¥çš„ Sub Reactorã€‚è¿æ¥çš„ç±»å‹ä¸º NioSocketChannelï¼Œå¤„ç†çš„äº‹ä»¶ä¸º OP_READ äº‹ä»¶ã€‚</p></blockquote> <p>åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­ç¬”è€…å·²ç»å¤šæ¬¡å¼ºè°ƒè¿‡äº†ï¼ŒReactor åœ¨å¤„ç† Channel ä¸Šçš„ IO äº‹ä»¶å…¥å£å‡½æ•°ä¸º<code>NioEventLoop#processSelectedKey</code>ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">NioEventLoop</span> <span class="token keyword">extends</span> <span class="token class-name">SingleThreadEventLoop</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processSelectedKey</span><span class="token punctuation">(</span><span class="token class-name">SelectionKey</span> k<span class="token punctuation">,</span> <span class="token class-name">AbstractNioChannel</span> ch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">AbstractNioChannel<span class="token punctuation">.</span>NioUnsafe</span> unsafe <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> readyOps <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">readyOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readyOps <span class="token operator">&amp;</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_CONNECT</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>å¤„ç†<span class="token constant">OP_CONNECT</span>äº‹ä»¶<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>


            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readyOps <span class="token operator">&amp;</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_WRITE</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>å¤„ç†<span class="token constant">OP_WRITE</span>äº‹ä»¶<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>


            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readyOps <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_READ</span> <span class="token operator">|</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_ACCEPT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> readyOps <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//æœ¬æ–‡é‡ç‚¹å¤„ç†OP_ACCEPTäº‹ä»¶</span>
                unsafe<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CancelledKeyException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            unsafe<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">voidPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>è¿™é‡Œéœ€è¦é‡ç‚¹å¼ºè°ƒçš„æ˜¯ï¼Œå½“å‰çš„æ‰§è¡Œçº¿ç¨‹ç°åœ¨å·²ç»å˜æˆäº† Sub Reactorï¼Œè€Œ Sub Reactor ä¸Šæ³¨å†Œçš„æ­£æ˜¯ netty å®¢æˆ·ç«¯ NioSocketChannel è´Ÿè´£å¤„ç†è¿æ¥ä¸Šçš„è¯»å†™äº‹ä»¶ã€‚</p> <p>æ‰€ä»¥è¿™é‡Œå…¥å£å‡½æ•°çš„å‚æ•°<code>AbstractNioChannel ch</code>åˆ™æ˜¯ IO å°±ç»ªçš„å®¢æˆ·ç«¯è¿æ¥<code>NioSocketChannel</code>ã€‚</p> <p>å¼€å¤´é€šè¿‡<code>ch.unsafe()</code>è·å–åˆ°çš„ NioUnsafe æ“ä½œç±»æ­£æ˜¯ NioSocketChannel ä¸­å¯¹åº•å±‚ JDK NIO SocketChannel çš„ Unsafe åº•å±‚æ“ä½œç±»ã€‚å®ç°ç±»å‹ä¸º<code>NioByteUnsafe</code>å®šä¹‰åœ¨ä¸‹å›¾ç»§æ‰¿ç»“æ„ä¸­çš„<code>AbstractNioByteChannel</code>çˆ¶ç±»ä¸­ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>ä¸‹é¢æˆ‘ä»¬åˆ°<code>NioByteUnsafe#read</code>æ–¹æ³•ä¸­æ¥çœ‹ä¸‹ Netty å¯¹<code>OP_READäº‹ä»¶</code>çš„å…·ä½“å¤„ç†è¿‡ç¨‹ï¼š</p> <h2 id="_2-netty-æ¥æ”¶ç½‘ç»œæ•°æ®æµç¨‹æ€»è§ˆ"><a href="#_2-netty-æ¥æ”¶ç½‘ç»œæ•°æ®æµç¨‹æ€»è§ˆ" class="header-anchor">#</a> 2. Netty æ¥æ”¶ç½‘ç»œæ•°æ®æµç¨‹æ€»è§ˆ</h2> <p>æˆ‘ä»¬ç›´æ¥æŒ‰ç…§è€è§„çŸ©ï¼Œå…ˆä»æ•´ä½“ä¸ŠæŠŠæ•´ä¸ª OP_READ äº‹ä»¶çš„é€»è¾‘å¤„ç†æ¡†æ¶æå–å‡ºæ¥ï¼Œè®©å¤§å®¶å…ˆæ€»ä½“ä¿¯è§†ä¸‹æµç¨‹å…¨è²Œï¼Œç„¶ååœ¨é’ˆå¯¹æ¯ä¸ªæ ¸å¿ƒç‚¹ä½è¿›è¡Œå„ä¸ªå‡»ç ´ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191131609.png" alt="å›¾ç‰‡"></p> <blockquote><p>æµç¨‹ä¸­ç›¸å…³ç½®ç°çš„æ­¥éª¤ä¸º Netty å¤„ç†è¿æ¥å…³é—­æ—¶çš„é€»è¾‘ï¼Œå’Œæœ¬æ–‡ä¸»æ—¨æ— å…³ï¼Œæˆ‘ä»¬è¿™é‡Œæš‚æ—¶å¿½ç•¥ï¼Œç­‰åç»­ç¬”è€…ä»‹ç»è¿æ¥å…³é—­æ—¶ï¼Œä¼šå•ç‹¬å¼€ä¸€ç¯‡æ–‡ç« è¯¦ç»†ä¸ºå¤§å®¶ä»‹ç»ã€‚</p></blockquote> <p>ä»ä¸Šé¢è¿™å¼  Netty æ¥æ”¶ç½‘ç»œæ•°æ®æ€»ä½“æµç¨‹å›¾å¯ä»¥çœ‹å‡º NioSocketChannel åœ¨æ¥æ”¶ç½‘ç»œæ•°æ®çš„æ•´ä¸ªæµç¨‹å’Œæˆ‘ä»¬åœ¨ä¸Šç¯‡æ–‡ç« <a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484184&amp;idx=1&amp;sn=726877ce28cf6e5d2ac3225fae687f19&amp;chksm=ce77c55ff9004c493b592288819dc4d4664b5949ee97fed977b6558bc517dad0e1f73fab0f46&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€ŠNetty å¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œè¿æ¥ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸­ä»‹ç»çš„ NioServerSocketChannel åœ¨æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥æ—¶çš„æµç¨‹åœ¨æ€»ä½“æ¡†æ¶ä¸Šæ˜¯ä¸€æ ·çš„ã€‚</p> <p>NioSocketChannel åœ¨æ¥æ”¶ç½‘ç»œæ•°æ®çš„è¿‡ç¨‹å¤„ç†ä¸­ï¼Œä¹Ÿæ˜¯é€šè¿‡åœ¨ä¸€ä¸ª<code>do{....}while(...)</code>å¾ªç¯ read loop ä¸­ä¸æ–­çš„å¾ªç¯è¯»å–è¿æ¥ NioSocketChannel ä¸Šçš„æ•°æ®ã€‚</p> <p>åŒæ ·åœ¨ NioSocketChannel è¯»å–è¿æ¥æ•°æ®çš„ read loop ä¸­ä¹Ÿæ˜¯å—æœ€å¤§è¯»å–æ¬¡æ•°çš„é™åˆ¶ã€‚é»˜è®¤é…ç½®æœ€å¤šåªèƒ½è¯»å– 16 æ¬¡ï¼Œè¶…è¿‡ 16 æ¬¡æ— è®ºæ­¤æ—¶ NioSocketChannel ä¸­æ˜¯å¦è¿˜æœ‰æ•°æ®å¯è¯»éƒ½ä¸èƒ½åœ¨è¿›è¡Œè¯»å–äº†ã€‚</p> <p>è¿™é‡Œ read loop å¾ªç¯æœ€å¤§è¯»å–æ¬¡æ•°å¯åœ¨å¯åŠ¨é…ç½®ç±» ServerBootstrap ä¸­é€šè¿‡<code>ChannelOption.MAX_MESSAGES_PER_READ</code>é€‰é¡¹è®¾ç½®ï¼Œé»˜è®¤ä¸º 16ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">MAX_MESSAGES_PER_READ</span><span class="token punctuation">,</span> è‡ªå®šä¹‰æ¬¡æ•°<span class="token punctuation">)</span>
</code></pre></div><p>**Netty è¿™é‡Œä¸ºä»€ä¹ˆéå¾—é™åˆ¶ read loop çš„æœ€å¤§è¯»å–æ¬¡æ•°å‘¢ï¼Ÿ**ä¸ºä»€ä¹ˆä¸åœ¨ read loop ä¸­ä¸€æ¬¡æ€§æŠŠæ•°æ®è¯»å–å®Œå‘¢ï¼Ÿ</p> <p>è¿™æ—¶å€™å°±æ˜¯è€ƒéªŒæˆ‘ä»¬å¤§å±€è§‚çš„æ—¶å€™äº†ï¼Œåœ¨å‰è¾¹çš„æ–‡ç« ä»‹ç»ä¸­æˆ‘ä»¬æåˆ° Netty çš„ IO æ¨¡å‹ä¸ºä¸»ä» Reactor çº¿ç¨‹ç»„æ¨¡å‹ï¼Œåœ¨ Sub Reactor Group ä¸­åŒ…å«äº†å¤šä¸ª Sub Reactor ä¸“é—¨ç”¨äºç›‘å¬å¤„ç†å®¢æˆ·ç«¯è¿æ¥ä¸Šçš„ IO äº‹ä»¶ã€‚</p> <p>ä¸ºäº†èƒ½å¤Ÿé«˜æ•ˆæœ‰åºçš„å¤„ç†å…¨é‡å®¢æˆ·ç«¯è¿æ¥ä¸Šçš„è¯»å†™äº‹ä»¶ï¼ŒNetty å°†æœåŠ¡ç«¯æ‰¿è½½çš„å…¨é‡å®¢æˆ·ç«¯è¿æ¥åˆ†æ‘Šåˆ°å¤šä¸ª Sub Reactor ä¸­å¤„ç†ï¼ŒåŒæ—¶ä¹Ÿèƒ½ä¿è¯<code>Channelä¸ŠIOå¤„ç†çš„çº¿ç¨‹å®‰å…¨æ€§</code>ã€‚</p> <p>å…¶ä¸­ä¸€ä¸ª Channel åªèƒ½åˆ†é…ç»™ä¸€ä¸ªå›ºå®šçš„ Reactorã€‚ä¸€ä¸ª Reactor è´Ÿè´£å¤„ç†å¤šä¸ª Channel ä¸Šçš„ IO å°±ç»ªäº‹ä»¶ï¼ŒReactor ä¸ Channel ä¹‹é—´çš„å¯¹åº”å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191544903.webp" alt="å›¾ç‰‡"></p> <p>è€Œä¸€ä¸ª Sub Reactor ä¸Šæ³¨å†Œäº†å¤šä¸ª NioSocketChannelï¼ŒNetty ä¸å¯èƒ½åœ¨ä¸€ä¸ª NioSocketChannel ä¸Šæ— é™åˆ¶çš„å¤„ç†ä¸‹å»ï¼Œè¦å°†è¯»å–æ•°æ®çš„æœºä¼šå‡åŒ€åˆ†æ‘Šç»™å…¶ä»– NioSocketChannelï¼Œæ‰€ä»¥éœ€è¦é™å®šæ¯ä¸ª NioSocketChannel ä¸Šçš„æœ€å¤§è¯»å–æ¬¡æ•°ã€‚</p> <p>æ­¤å¤–ï¼ŒSub Reactor é™¤äº†éœ€è¦ç›‘å¬å¤„ç†æ‰€æœ‰æ³¨å†Œåœ¨å®ƒä¸Šè¾¹çš„ NioSocketChannel ä¸­çš„ IO å°±ç»ªäº‹ä»¶ä¹‹å¤–ï¼Œè¿˜éœ€è¦è…¾å‡ºäº‹ä»¶æ¥å¤„ç†æœ‰ç”¨æˆ·çº¿ç¨‹æäº¤è¿‡æ¥çš„å¼‚æ­¥ä»»åŠ¡ã€‚ä»è¿™ä¸€ç‚¹çœ‹ï¼ŒNetty ä¹Ÿä¸ä¼šä¸€ç›´åœç•™åœ¨ NioSocketChannel çš„ IO å¤„ç†ä¸Šã€‚æ‰€ä»¥é™åˆ¶ read loop çš„æœ€å¤§è¯»å–æ¬¡æ•°æ˜¯éå¸¸å¿…è¦çš„ã€‚</p> <blockquote><p>å…³äº Reactor çš„æ•´ä½“è¿è½¬æ¶æ„ï¼Œå¯¹ç»†èŠ‚éƒ¨åˆ†æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å›çœ‹ä¸‹ç¬”è€…çš„<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484087&amp;idx=1&amp;sn=0c065780e0f05c23c8e6465ede86cba0&amp;chksm=ce77c4f0f9004de63be369a664105708bc5975b52993f4a6df223caed34cc1ef6185a16acd75&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€Šä¸€æ–‡èŠé€ Netty æ ¸å¿ƒå¼•æ“ Reactor çš„è¿è½¬æ¶æ„ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>è¿™ç¯‡æ–‡ç« ã€‚</p></blockquote> <p>æ‰€ä»¥åŸºäºè¿™ä¸ªåŸå› ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ read loop å¾ªç¯ä¸­ï¼Œæ¯å½“é€šè¿‡<code>doReadBytes</code>æ–¹æ³•ä» NioSocketChannel ä¸­è¯»å–åˆ°æ•°æ®æ—¶ï¼ˆæ–¹æ³•è¿”å›å€¼ä¼šå¤§äº 0ï¼Œå¹¶è®°å½•åœ¨ allocHandle.lastBytesRead ä¸­ï¼‰ï¼Œéƒ½éœ€è¦é€šè¿‡<code>allocHandle.incMessagesRead(1)</code>æ–¹æ³•ç»Ÿè®¡å·²ç»è¯»å–çš„æ¬¡æ•°ã€‚å½“è¾¾åˆ° 16 æ¬¡æ—¶ä¸ç®¡ NioSocketChannel æ˜¯å¦è¿˜æœ‰æ•°æ®å¯è¯»ï¼Œéƒ½éœ€è¦åœ¨ read loop æœ«å°¾é€€å‡ºå¾ªç¯ã€‚è½¬å»æ‰§è¡Œ Sub Reactor ä¸Šçš„å¼‚æ­¥ä»»åŠ¡ã€‚ä»¥åŠå…¶ä»– NioSocketChannel ä¸Šçš„ IO å°±ç»ªäº‹ä»¶ã€‚å¹³å‡åˆ†é…ï¼Œé›¨éœ²å‡æ²¾ï¼ï¼</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">MaxMessageHandle</span> <span class="token keyword">implements</span> <span class="token class-name">ExtendedHandle</span> <span class="token punctuation">{</span>

        <span class="token comment">//read loopæ€»å…±è¯»å–äº†å¤šå°‘æ¬¡</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> totalMessages<span class="token punctuation">;</span>

       <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">incMessagesRead</span><span class="token punctuation">(</span><span class="token keyword">int</span> amt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            totalMessages <span class="token operator">+=</span> amt<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>æœ¬æ¬¡ read loop è¯»å–åˆ°çš„æ•°æ®å¤§å°ä¼šè®°å½•åœ¨<code>allocHandle.lastBytesRead</code>ä¸­</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">MaxMessageHandle</span> <span class="token keyword">implements</span> <span class="token class-name">ExtendedHandle</span> <span class="token punctuation">{</span>

         <span class="token comment">//æœ¬æ¬¡read loopè¯»å–åˆ°çš„å­—èŠ‚æ•°</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> lastBytesRead<span class="token punctuation">;</span>
        <span class="token comment">//æ•´ä¸ªread loopå¾ªç¯æ€»å…±è¯»å–çš„å­—èŠ‚æ•°</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> totalBytesRead<span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lastBytesRead</span><span class="token punctuation">(</span><span class="token keyword">int</span> bytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            lastBytesRead <span class="token operator">=</span> bytes<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                totalBytesRead <span class="token operator">+=</span> bytes<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>lastBytesRead &lt; 0</code>ï¼šè¡¨ç¤ºå®¢æˆ·ç«¯ä¸»åŠ¨å‘èµ·äº†è¿æ¥å…³é—­æµç¨‹ï¼ŒNetty å¼€å§‹è¿æ¥å…³é—­å¤„ç†æµç¨‹ã€‚è¿™ä¸ªå’Œæœ¬æ–‡çš„ä¸»æ—¨æ— å…³ï¼Œæˆ‘ä»¬å…ˆä¸ç”¨ç®¡ã€‚åé¢ç¬”è€…ä¼šä¸“é—¨ç”¨ä¸€ç¯‡æ–‡ç« æ¥è¯¦è§£å…³é—­æµç¨‹ã€‚</li> <li><code>lastBytesRead = 0</code>ï¼šè¡¨ç¤ºå½“å‰ NioSocketChannel ä¸Šçš„æ•°æ®å·²ç»å…¨éƒ¨è¯»å–å®Œæ¯•ï¼Œæ²¡æœ‰æ•°æ®å¯è¯»äº†ã€‚æœ¬æ¬¡ OP_READ äº‹ä»¶åœ†æ»¡å¤„ç†å®Œæ¯•ï¼Œå¯ä»¥å¼€å¼€å¿ƒå¿ƒçš„é€€å‡º read loopã€‚</li> <li>å½“<code>lastBytesRead &gt; 0</code>ï¼šè¡¨ç¤ºåœ¨æœ¬æ¬¡ read loop ä¸­ä» NioSocketChannel ä¸­è¯»å–åˆ°äº†æ•°æ®ï¼Œä¼šåœ¨ NioSocketChannel çš„ pipeline ä¸­è§¦å‘ ChannelRead äº‹ä»¶ã€‚è¿›è€Œåœ¨ pipeline ä¸­è´Ÿè´£ IO å¤„ç†çš„ ChannelHandelr ä¸­å“åº”ï¼Œå¤„ç†ç½‘ç»œè¯·æ±‚ã€‚</li></ul> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191131926.png" alt="å›¾ç‰‡">fir</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>å¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œæ¯”å¦‚è§£ç <span class="token punctuation">,</span>ååºåˆ—åŒ–ç­‰æ“ä½œ<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æœ€åä¼šåœ¨ read loop å¾ªç¯çš„æœ«å°¾è°ƒç”¨<code>allocHandle.continueReading()</code>åˆ¤æ–­æ˜¯å¦ç»“æŸæœ¬æ¬¡ read loop å¾ªç¯ã€‚è¿™é‡Œçš„ç»“æŸå¾ªç¯æ¡ä»¶çš„åˆ¤æ–­ä¼šæ¯”æˆ‘ä»¬åœ¨ä»‹ç» NioServerSocketChannel æ¥æ”¶è¿æ¥æ—¶çš„åˆ¤æ–­æ¡ä»¶å¤æ‚å¾ˆå¤šï¼Œç¬”è€…ä¼šå°†è¿™ä¸ªåˆ¤æ–­æ¡ä»¶çš„è¯¦ç»†è§£ææ”¾åœ¨æ–‡ç« åé¢ç»†èŠ‚éƒ¨åˆ†ä¸ºå¤§å®¶è§£è¯»ï¼Œè¿™é‡Œå¤§å®¶åªéœ€è¦æŠŠæ¡æ€»ä½“æ ¸å¿ƒæµç¨‹ï¼Œä¸éœ€è¦å…³æ³¨å¤ªå¤šç»†èŠ‚ã€‚</p> <p>æ€»ä½“ä¸Šåœ¨ NioSocketChannel ä¸­è¯»å–ç½‘ç»œæ•°æ®çš„ read loop å¾ªç¯ç»“æŸæ¡ä»¶éœ€è¦æ»¡è¶³ä»¥ä¸‹å‡ ç‚¹ï¼š</p> <ul><li>å½“å‰ NioSocketChannel ä¸­çš„æ•°æ®å·²ç»å…¨éƒ¨è¯»å–å®Œæ¯•ï¼Œåˆ™é€€å‡ºå¾ªç¯ã€‚</li> <li>æœ¬è½® read loop å¦‚æœæ²¡æœ‰è¯»åˆ°ä»»ä½•æ•°æ®ï¼Œåˆ™é€€å‡ºå¾ªç¯ã€‚</li> <li>read loop çš„è¯»å–æ¬¡æ•°è¾¾åˆ° 16 æ¬¡ï¼Œé€€å‡ºå¾ªç¯ã€‚</li></ul> <p>å½“æ»¡è¶³è¿™é‡Œçš„ read loop é€€å‡ºæ¡ä»¶ä¹‹åï¼ŒSub Reactor çº¿ç¨‹å°±ä¼šé€€å‡ºå¾ªç¯ï¼Œéšåä¼šè°ƒç”¨<code>allocHandle.readComplete()</code>æ–¹æ³•æ ¹æ®æœ¬è½® read loop æ€»å…±è¯»å–åˆ°çš„å­—èŠ‚æ•°<code>totalBytesRead</code>æ¥å†³å®šæ˜¯å¦å¯¹ç”¨äºæ¥æ”¶ä¸‹ä¸€è½® OP_READ äº‹ä»¶æ•°æ®çš„ ByteBuffer è¿›è¡Œæ‰©å®¹æˆ–è€…ç¼©å®¹ã€‚</p> <p>æœ€ååœ¨ NioSocketChannel çš„ pipeline ä¸­è§¦å‘<code>ChannelReadCompleteäº‹ä»¶</code>ï¼Œé€šçŸ¥ ChannelHandler æœ¬æ¬¡ OP_READ äº‹ä»¶å·²ç»å¤„ç†å®Œæ¯•ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)fireChannelReadComplete.png</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>å¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œæ¯”å¦‚è§£ç <span class="token punctuation">,</span>ååºåˆ—åŒ–ç­‰æ“ä½œ<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelReadComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>æœ¬æ¬¡<span class="token constant">OP_READ</span>äº‹ä»¶å¤„ç†å®Œæ¯•<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>å†³å®šæ˜¯å¦å‘å®¢æˆ·ç«¯å“åº”å¤„ç†ç»“æœ<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-1-channelread-ä¸-channelreadcomplete-äº‹ä»¶çš„åŒºåˆ«"><a href="#_2-1-channelread-ä¸-channelreadcomplete-äº‹ä»¶çš„åŒºåˆ«" class="header-anchor">#</a> 2.1 ChannelRead ä¸ ChannelReadComplete äº‹ä»¶çš„åŒºåˆ«</h3> <blockquote><p>æœ‰äº›å°ä¼™ä¼´å¯èƒ½å¯¹ Netty ä¸­çš„ä¸€äº›ä¼ æ’­äº‹ä»¶è§¦å‘çš„æ—¶æœºï¼Œæˆ–è€…äº‹ä»¶ä¹‹é—´çš„åŒºåˆ«ç†è§£çš„ä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œæ¦‚å¿µå®¹æ˜“æ··æ·†ã€‚åœ¨åé¢çš„æ–‡ç« ä¸­ç¬”è€…ä¹Ÿä¼šä»æºç çš„è§’åº¦å‡ºå‘ç»™å¤§å®¶è¯´æ¸…æ¥š Netty ä¸­å®šä¹‰çš„æ‰€æœ‰å¼‚æ­¥äº‹ä»¶ï¼Œä»¥åŠè¿™äº›äº‹ä»¶ä¹‹é—´çš„åŒºåˆ«å’Œè”ç³»å’Œè§¦å‘æ—¶æœºï¼Œä¼ æ’­æœºåˆ¶ã€‚</p></blockquote> <p>è¿™é‡Œæˆ‘ä»¬ä¸»è¦æ¢è®¨æœ¬æ–‡ä¸»é¢˜ä¸­æ¶‰åŠåˆ°çš„ä¸¤ä¸ªäº‹ä»¶ï¼šChannelRead äº‹ä»¶ä¸ ChannelReadComplete äº‹ä»¶ã€‚</p> <p>ä»ä¸Šè¿°ä»‹ç»çš„ Netty æ¥æ”¶ç½‘ç»œæ•°æ®æµç¨‹æ€»è§ˆä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡º<code>ChannelReadäº‹ä»¶</code>å’Œ<code>ChannelReadCompleteäº‹ä»¶</code>æ˜¯ä¸ä¸€æ ·çš„ï¼Œä½†æ˜¯å¯¹äºåˆšæ¥è§¦ Netty çš„å°ä¼™ä¼´æ¥è¯´ä»å‘½åä¸Šä¹ä¸€çœ‹æ„Ÿè§‰åˆå·®ä¸å¤šã€‚</p> <p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹è¿™ä¸¤ä¸ªäº‹ä»¶ä¹‹é—´çš„å·®åˆ«ï¼š</p> <p>Netty æœåŠ¡ç«¯å¯¹äºä¸€æ¬¡ OP_READ äº‹ä»¶çš„å¤„ç†ï¼Œä¼šåœ¨ä¸€ä¸ª<code>do{}while()</code>å¾ªç¯ read loop ä¸­åˆ†å¤šæ¬¡ä»å®¢æˆ·ç«¯ NioSocketChannel ä¸­è¯»å–ç½‘ç»œæ•°æ®ã€‚æ¯æ¬¡è¯»å–æˆ‘ä»¬åˆ†é…çš„ ByteBuffer å®¹é‡å¤§å°ï¼Œåˆå§‹å®¹é‡ä¸º 2048ã€‚</p> <ul><li><code>ChanneReadäº‹ä»¶</code>ï¼šä¸€æ¬¡å¾ªç¯è¯»å–ä¸€æ¬¡æ•°æ®ï¼Œå°±è§¦å‘ä¸€æ¬¡<code>ChannelReadäº‹ä»¶</code>ã€‚æœ¬æ¬¡æœ€å¤šè¯»å–åœ¨ read loop å¾ªç¯å¼€å§‹åˆ†é…çš„ DirectByteBuffer å®¹é‡å¤§å°ã€‚è¿™ä¸ªå®¹é‡ä¼šåŠ¨æ€è°ƒæ•´ï¼Œæ–‡ç« åç»­ç¬”è€…ä¼šè¯¦ç»†ä»‹ç»ã€‚</li> <li><code>ChannelReadCompleteäº‹ä»¶</code>ï¼šå½“è¯»å–ä¸åˆ°æ•°æ®æˆ–è€…ä¸æ»¡è¶³<code>continueReading</code>çš„ä»»æ„ä¸€ä¸ªæ¡ä»¶å°±ä¼šé€€å‡º read loopï¼Œè¿™æ—¶å°±ä¼šè§¦å‘<code>ChannelReadCompleteäº‹ä»¶</code>ã€‚è¡¨ç¤ºæœ¬æ¬¡<code>OP_READäº‹ä»¶</code>å¤„ç†å®Œæ¯•ã€‚</li></ul> <blockquote><p><strong>è¿™é‡Œéœ€è¦ç‰¹åˆ«æ³¨æ„ä¸‹</strong>è§¦å‘<code>ChannelReadCompleteäº‹ä»¶</code>å¹¶ä¸ä»£è¡¨ NioSocketChannel ä¸­çš„æ•°æ®å·²ç»è¯»å–å®Œäº†ï¼Œåªèƒ½è¯´æ˜æœ¬æ¬¡<code>OP_READäº‹ä»¶</code>å¤„ç†å®Œæ¯•ã€‚å› ä¸ºæœ‰å¯èƒ½æ˜¯å®¢æˆ·ç«¯å‘é€çš„æ•°æ®å¤ªå¤šï¼ŒNetty è¯»äº†<code>16æ¬¡</code>è¿˜æ²¡è¯»å®Œï¼Œé‚£å°±åªèƒ½ç­‰åˆ°ä¸‹æ¬¡<code>OP_READäº‹ä»¶</code>åˆ°æ¥çš„æ—¶å€™åœ¨è¿›è¡Œè¯»å–äº†ã€‚</p></blockquote> <hr> <p>ä»¥ä¸Šå†…å®¹å°±æ˜¯ Netty åœ¨æ¥æ”¶å®¢æˆ·ç«¯å‘é€ç½‘ç»œæ•°æ®çš„å…¨éƒ¨æ ¸å¿ƒé€»è¾‘ã€‚ç›®å‰ä¸ºæ­¢æˆ‘ä»¬è¿˜æœªæ¶‰åŠåˆ°è¿™éƒ¨åˆ†çš„ä¸»å¹²æ ¸å¿ƒæºç ï¼Œç¬”è€…æƒ³çš„æ˜¯å…ˆç»™å¤§å®¶æŠŠæ ¸å¿ƒé€»è¾‘è®²è§£æ¸…æ¥šä¹‹åï¼Œè¿™æ ·ç†è§£èµ·æ¥æ ¸å¿ƒä¸»å¹²æºç ä¼šæ›´åŠ æ¸…æ™°é€å½»ã€‚</p> <p>ç»è¿‡å‰è¾¹å¯¹ç½‘ç»œæ•°æ®æ¥æ”¶çš„æ ¸å¿ƒé€»è¾‘ä»‹ç»ï¼Œç¬”è€…åœ¨æŠŠè¿™å¼ æµç¨‹å›¾æ”¾å‡ºæ¥ï¼Œå¤§å®¶å¯ä»¥ç»“åˆè¿™å¼ å›¾åœ¨æ¥å›æƒ³ä¸‹ä¸»å¹²æ ¸å¿ƒé€»è¾‘ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191131609.png" alt="å›¾ç‰‡"></p> <p>ä¸‹é¢ç¬”è€…ä¼šç»“åˆè¿™å¼ æµç¨‹å›¾ï¼Œç»™å¤§å®¶æŠŠè¿™éƒ¨åˆ†çš„æ ¸å¿ƒä¸»å¹²æºç æ¡†æ¶å±•ç°å‡ºæ¥ï¼Œå¤§å®¶å¯ä»¥å°†æˆ‘ä»¬ä»‹ç»è¿‡çš„æ ¸å¿ƒé€»è¾‘ä¸ä¸»å¹²æºç åšä¸ªä¸€ä¸€å¯¹åº”ï¼Œè¿˜æ˜¯é‚£å¥è€è¯ï¼Œæˆ‘ä»¬è¦ä»ä¸»å¹²æ¡†æ¶å±‚é¢æŠŠæ¡æ•´ä½“å¤„ç†æµç¨‹ï¼Œä¸éœ€è¦è¯»æ‡‚æ¯ä¸€è¡Œä»£ç ï¼Œæ–‡ç« åç»­ç¬”è€…ä¼šå°†è¿™ä¸ªè¿‡ç¨‹ä¸­æ¶‰åŠåˆ°çš„æ ¸å¿ƒç‚¹ä½ç»™å¤§å®¶æ‹†å¼€æ¥å„ä¸ªå‡»ç ´ï¼ï¼</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191131492.png" alt="å›¾ç‰‡"></p> <h2 id="_3-æºç æ ¸å¿ƒæ¡†æ¶æ€»è§ˆ"><a href="#_3-æºç æ ¸å¿ƒæ¡†æ¶æ€»è§ˆ" class="header-anchor">#</a> 3. æºç æ ¸å¿ƒæ¡†æ¶æ€»è§ˆ</h2> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">ChannelConfig</span> config <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>å¤„ç†åŠå…³é—­ç›¸å…³ä»£ç çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//è·å–NioSocketChannelçš„pipeline</span>
        <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> <span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//PooledByteBufAllocator å…·ä½“ç”¨äºå®é™…åˆ†é…ByteBufçš„åˆ†é…å™¨</span>
    <span class="token keyword">final</span> <span class="token class-name">ByteBufAllocator</span> allocator <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//è‡ªé€‚åº”ByteBufåˆ†é…å™¨ AdaptiveRecvByteBufAllocator ,ç”¨äºåŠ¨æ€è°ƒèŠ‚ByteBufå®¹é‡</span>
    <span class="token comment">//éœ€è¦ä¸å…·ä½“çš„ByteBufåˆ†é…å™¨é…åˆä½¿ç”¨ æ¯”å¦‚è¿™é‡Œçš„PooledByteBufAllocator</span>
    <span class="token keyword">final</span> <span class="token class-name">RecvByteBufAllocator<span class="token punctuation">.</span>Handle</span> allocHandle <span class="token operator">=</span> <span class="token function">recvBufAllocHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//allocHandlerç”¨äºç»Ÿè®¡æ¯æ¬¡è¯»å–æ•°æ®çš„å¤§å°ï¼Œæ–¹ä¾¿ä¸‹æ¬¡åˆ†é…åˆé€‚å¤§å°çš„ByteBuf</span>
    <span class="token comment">//é‡ç½®æ¸…é™¤ä¸Šæ¬¡çš„ç»Ÿè®¡æŒ‡æ ‡</span>
    allocHandle<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ByteBuf</span> byteBuf <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> close <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token comment">//åˆ©ç”¨PooledByteBufAllocatoråˆ†é…åˆé€‚å¤§å°çš„byteBuf åˆå§‹å¤§å°ä¸º2048</span>
            byteBuf <span class="token operator">=</span> allocHandle<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>allocator<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//è®°å½•æœ¬æ¬¡è¯»å–äº†å¤šå°‘å­—èŠ‚æ•°</span>
            allocHandle<span class="token punctuation">.</span><span class="token function">lastBytesRead</span><span class="token punctuation">(</span><span class="token function">doReadBytes</span><span class="token punctuation">(</span>byteBuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//å¦‚æœæœ¬æ¬¡æ²¡æœ‰è¯»å–åˆ°ä»»ä½•å­—èŠ‚ï¼Œåˆ™é€€å‡ºå¾ªç¯ è¿›è¡Œä¸‹ä¸€è½®äº‹ä»¶è½®è¯¢</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>allocHandle<span class="token punctuation">.</span><span class="token function">lastBytesRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// nothing was read. release the buffer.</span>
                byteBuf<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                byteBuf <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                close <span class="token operator">=</span> allocHandle<span class="token punctuation">.</span><span class="token function">lastBytesRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>close<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>è¡¨ç¤ºå®¢æˆ·ç«¯å‘èµ·è¿æ¥å…³é—­<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//read loopè¯»å–æ•°æ®æ¬¡æ•°+1</span>
            allocHandle<span class="token punctuation">.</span><span class="token function">incMessagesRead</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//å®¢æˆ·ç«¯NioSocketChannelçš„pipelineä¸­è§¦å‘ChannelReadäº‹ä»¶</span>
            pipeline<span class="token punctuation">.</span><span class="token function">fireChannelRead</span><span class="token punctuation">(</span>byteBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//è§£é™¤æœ¬æ¬¡è¯»å–æ•°æ®åˆ†é…çš„ByteBufferå¼•ç”¨ï¼Œæ–¹ä¾¿ä¸‹ä¸€è½®read loopåˆ†é…</span>
            byteBuf <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>allocHandle<span class="token punctuation">.</span><span class="token function">continueReading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆ¤æ–­æ˜¯å¦åº”è¯¥ç»§ç»­read loop</span>

        <span class="token comment">//æ ¹æ®æœ¬æ¬¡read loopæ€»å…±è¯»å–çš„å­—èŠ‚æ•°ï¼Œå†³å®šä¸‹æ¬¡æ˜¯å¦æ‰©å®¹æˆ–è€…ç¼©å®¹</span>
        allocHandle<span class="token punctuation">.</span><span class="token function">readComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//åœ¨NioSocketChannelçš„pipelineä¸­è§¦å‘ChannelReadCompleteäº‹ä»¶ï¼Œè¡¨ç¤ºä¸€æ¬¡readäº‹ä»¶å¤„ç†å®Œæ¯•</span>
        <span class="token comment">//ä½†è¿™å¹¶ä¸è¡¨ç¤º å®¢æˆ·ç«¯å‘é€æ¥çš„æ•°æ®å·²ç»å…¨éƒ¨è¯»å®Œï¼Œå› ä¸ºå¦‚æœæ•°æ®å¤ªå¤šçš„è¯ï¼Œè¿™é‡Œåªä¼šè¯»å–16æ¬¡ï¼Œå‰©ä¸‹çš„ä¼šç­‰åˆ°ä¸‹æ¬¡readäº‹ä»¶åˆ°æ¥ååœ¨å¤„ç†</span>
        pipeline<span class="token punctuation">.</span><span class="token function">fireChannelReadComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥è¿æ¥å…³é—­æµç¨‹å¤„ç†<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>è¿™é‡Œå†æ¬¡å¼ºè°ƒä¸‹å½“å‰æ‰§è¡Œçº¿ç¨‹ä¸º Sub Reactor çº¿ç¨‹ï¼Œå¤„ç†è¿æ¥æ•°æ®è¯»å–é€»è¾‘æ˜¯åœ¨ NioSocketChannel ä¸­ã€‚</p></blockquote> <p>é¦–å…ˆé€šè¿‡<code>config()</code>è·å–å®¢æˆ·ç«¯ NioSocketChannel çš„ Channel é…ç½®ç±» NioSocketChannelConfigã€‚</p> <p>é€šè¿‡<code>pipeline()</code>è·å– NioSocketChannel çš„ pipelineã€‚æˆ‘ä»¬åœ¨ <a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484005&amp;idx=1&amp;sn=52f51269902a58f40d33208421109bc3&amp;chksm=ce77c422f9004d340e5b385ef6ba24dfba1f802076ace80ad6390e934173a10401e64e13eaeb&amp;token=1943348780&amp;lang=zh_CN&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€Šè¯¦ç»†å›¾è§£ Netty Reactor å¯åŠ¨å…¨æµç¨‹ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸€æ–‡ä¸­æåˆ°çš„ Netty æœåŠ¡ç«¯æ¨¡æ¿æ‰€ä¸¾çš„ç¤ºä¾‹ä¸­ï¼ŒNioSocketChannelde pipeline ä¸­åªæœ‰ä¸€ä¸ª EchoChannelHandlerã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)å®¢æˆ·ç«¯ channel pipeline ç»“æ„.png</p> <h3 id="_3-1-åˆ†é…-directbytebuffer-æ¥æ”¶ç½‘ç»œæ•°æ®"><a href="#_3-1-åˆ†é…-directbytebuffer-æ¥æ”¶ç½‘ç»œæ•°æ®" class="header-anchor">#</a> 3.1 åˆ†é… DirectByteBuffer æ¥æ”¶ç½‘ç»œæ•°æ®</h3> <p>Sub Reactor åœ¨æ¥æ”¶ NioSocketChannel ä¸Šçš„ IO æ•°æ®æ—¶ï¼Œéƒ½ä¼šåˆ†é…ä¸€ä¸ª ByteBuffer ç”¨æ¥å­˜æ”¾æ¥æ”¶åˆ°çš„ IO æ•°æ®ã€‚</p> <p>è¿™é‡Œå¤§å®¶å¯èƒ½è§‰å¾—æ¯”è¾ƒå¥‡æ€ªï¼Œä¸ºä»€ä¹ˆåœ¨ NioSocketChannel æ¥æ”¶æ•°æ®è¿™é‡Œä¼šæœ‰ä¸¤ä¸ª ByteBuffer åˆ†é…å™¨å‘¢ï¼Ÿä¸€ä¸ªæ˜¯ ByteBufAllocatorï¼Œå¦ä¸€ä¸ªæ˜¯ RecvByteBufAllocatorã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">ByteBufAllocator</span> allocator <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token class-name">RecvByteBufAllocator<span class="token punctuation">.</span>Handle</span> allocHandle <span class="token operator">=</span> <span class="token function">recvBufAllocHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>è¿™ä¸¤ä¸ª ByteBuffer åˆæœ‰ä»€ä¹ˆåŒºåˆ«å’Œè”ç³»å‘¢ï¼Ÿ</strong></p> <p>åœ¨ä¸Šç¯‡æ–‡ç« <a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484184&amp;idx=1&amp;sn=726877ce28cf6e5d2ac3225fae687f19&amp;chksm=ce77c55ff9004c493b592288819dc4d4664b5949ee97fed977b6558bc517dad0e1f73fab0f46&amp;scene=21&amp;cur_album_id=2217816582418956300#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€ŠæŠ“åˆ° Netty ä¸€ä¸ª Bugï¼Œé¡ºå¸¦æ¥é€å½»åœ°èŠä¸€ä¸‹ Netty æ˜¯å¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œè¿æ¥ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸­ï¼Œç¬”è€…ä¸ºäº†é˜è¿°ä¸Šç¯‡æ–‡ç« ä¸­æåˆ°çš„ Netty åœ¨æ¥æ”¶ç½‘ç»œè¿æ¥æ—¶çš„ Bug æ—¶ï¼Œç®€å•å’Œå¤§å®¶ä»‹ç»äº†ä¸‹è¿™ä¸ª RecvByteBufAllocatorã€‚</p> <p>åœ¨ä¸Šç¯‡æ–‡ç« æåˆ°çš„ NioServerSocketChannelConfig ä¸­ï¼Œè¿™é‡Œçš„ RecvByteBufAllocator ç±»å‹ä¸º ServerChannelRecvByteBufAllocatorã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <blockquote><p>è¿˜è®°å¾—è¿™ä¸ª ServerChannelRecvByteBufAllocator ç±»å‹åœ¨<strong>4.1.69.final</strong>ç‰ˆæœ¬å¼•å…¥æ˜¯ä¸ºäº†è§£å†³ç¬”è€…åœ¨ä¸Šç¯‡æ–‡ç« ä¸­æåˆ°çš„é‚£ä¸ª Bug å—ï¼Ÿåœ¨<strong>4.1.69.final</strong>ç‰ˆæœ¬ä¹‹å‰ï¼ŒNioServerSocketChannelConfig ä¸­çš„ RecvByteBufAllocator ç±»å‹ä¸º AdaptiveRecvByteBufAllocatorã€‚</p></blockquote> <p>è€Œåœ¨æœ¬æ–‡ä¸­ NioSocketChannelConfig ä¸­çš„ RecvByteBufAllocator ç±»å‹ä¸º AdaptiveRecvByteBufAllocatorã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>æ‰€ä»¥è¿™é‡Œ<code>recvBufAllocHandle()</code>è·å¾—åˆ°çš„ RecvByteBufAllocator ä¸º AdaptiveRecvByteBufAllocatorã€‚é¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªç±»å‹çš„ RecvByteBufAllocator å¯ä»¥æ ¹æ® NioSocketChannel ä¸Šæ¯æ¬¡åˆ°æ¥çš„ IO æ•°æ®å¤§å°æ¥è‡ªé€‚åº”åŠ¨æ€è°ƒæ•´ ByteBuffer çš„å®¹é‡ã€‚</p> <p>å¯¹äºå®¢æˆ·ç«¯ NioSocketChannel æ¥è¯´ï¼Œå®ƒé‡Œè¾¹åŒ…å«çš„ IO æ•°æ®æ—¶å®¢æˆ·ç«¯å‘é€æ¥çš„ç½‘ç»œæ•°æ®ï¼Œé•¿åº¦æ˜¯ä¸å®šçš„ï¼Œæ‰€ä»¥æ‰ä¼šéœ€è¦è¿™æ ·ä¸€ä¸ªå¯ä»¥æ ¹æ®æ¯æ¬¡ IO æ•°æ®çš„å¤§å°æ¥è‡ªé€‚åº”åŠ¨æ€è°ƒæ•´å®¹é‡çš„ ByteBuffer æ¥æ¥æ”¶ã€‚</p> <p>å¦‚æœæˆ‘ä»¬æŠŠç”¨äºæ¥æ”¶æ•°æ®ç”¨çš„ ByteBuffer çœ‹åšä¸€ä¸ªæ¡¶çš„è¯ï¼Œé‚£ä¹ˆå°æ•°æ®ç”¨å¤§æ¡¶è£…æˆ–è€…å¤§æ•°æ®ç”¨å°æ¡¶è£…è‚¯å®šæ˜¯ä¸åˆé€‚çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ ¹æ®æ¥æ”¶æ•°æ®çš„å¤§å°æ¥åŠ¨æ€è°ƒæ•´æ¡¶çš„å®¹é‡ã€‚è€Œ AdaptiveRecvByteBufAllocator çš„ä½œç”¨æ­£æ˜¯ç”¨æ¥æ ¹æ®æ¯æ¬¡æ¥æ”¶æ•°æ®çš„å®¹é‡å¤§å°æ¥åŠ¨æ€è°ƒæ•´ ByteBuffer çš„å®¹é‡çš„ã€‚</p> <p>ç°åœ¨ RecvByteBufAllocator ç¬”è€…ä¸ºå¤§å®¶è§£é‡Šæ¸…æ¥šäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­çœ‹ ByteBufAllocatorã€‚</p> <blockquote><p>å¤§å®¶è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ AdaptiveRecvByteBufAllocator å¹¶ä¸ä¼šçœŸæ­£çš„å»åˆ†é… ByteBufferï¼Œå®ƒåªæ˜¯è´Ÿè´£åŠ¨æ€è°ƒæ•´åˆ†é… ByteBuffer çš„å¤§å°ã€‚</p></blockquote> <p>è€ŒçœŸæ­£å…·ä½“æ‰§è¡Œå†…å­˜åˆ†é…åŠ¨ä½œçš„æ˜¯è¿™é‡Œçš„ ByteBufAllocator ç±»å‹ä¸º PooledByteBufAllocatorã€‚å®ƒä¼šæ ¹æ® AdaptiveRecvByteBufAllocator åŠ¨æ€è°ƒæ•´å‡ºæ¥çš„å¤§å°å»çœŸæ­£çš„ç”³è¯·å†…å­˜åˆ†é… ByteBufferã€‚</p> <blockquote><p>PooledByteBufAllocator ä¸º Netty ä¸­çš„å†…å­˜æ± ï¼Œç”¨æ¥ç®¡ç†å †å¤–å†…å­˜ DirectByteBufferã€‚</p></blockquote> <p>AdaptiveRecvByteBufAllocator ä¸­çš„ allocHandle åœ¨ä¸Šç¯‡æ–‡ç« ä¸­æˆ‘ä»¬ä¹Ÿä»‹ç»è¿‡äº†ï¼Œå®ƒçš„å®é™…ç±»å‹ä¸º MaxMessageHandleã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AdaptiveRecvByteBufAllocator</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultMaxMessagesRecvByteBufAllocator</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Handle</span> <span class="token function">newHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HandleImpl</span><span class="token punctuation">(</span>minIndex<span class="token punctuation">,</span> maxIndex<span class="token punctuation">,</span> initial<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HandleImpl</span> <span class="token keyword">extends</span> <span class="token class-name">MaxMessageHandle</span> <span class="token punctuation">{</span>
                  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨ MaxMessageHandle ä¸­åŒ…å«äº†ç”¨äºåŠ¨æ€è°ƒæ•´ ByteBuffer å®¹é‡çš„ç»Ÿè®¡æŒ‡æ ‡ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code>   <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">MaxMessageHandle</span> <span class="token keyword">implements</span> <span class="token class-name">ExtendedHandle</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">ChannelConfig</span> config<span class="token punctuation">;</span>

        <span class="token comment">//ç”¨äºæ§åˆ¶æ¯æ¬¡read loopé‡Œæœ€å¤§å¯ä»¥å¾ªç¯è¯»å–çš„æ¬¡æ•°ï¼Œé»˜è®¤ä¸º16æ¬¡</span>
        <span class="token comment">//å¯åœ¨å¯åŠ¨é…ç½®ç±»ServerBootstrapä¸­é€šè¿‡ChannelOption.MAX_MESSAGES_PER_READé€‰é¡¹è®¾ç½®ã€‚</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> maxMessagePerRead<span class="token punctuation">;</span>

        <span class="token comment">//ç”¨äºç»Ÿè®¡read loopä¸­æ€»å…±æ¥æ”¶çš„è¿æ¥ä¸ªæ•°ï¼ŒNioSocketChannelä¸­è¡¨ç¤ºè¯»å–æ•°æ®çš„æ¬¡æ•°</span>
        <span class="token comment">//æ¯æ¬¡read loopå¾ªç¯åä¼šè°ƒç”¨allocHandle.incMessagesReadå¢åŠ è®°å½•æ¥æ”¶åˆ°çš„è¿æ¥ä¸ªæ•°</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> totalMessages<span class="token punctuation">;</span>

        <span class="token comment">//ç”¨äºç»Ÿè®¡åœ¨read loopä¸­æ€»å…±æ¥æ”¶åˆ°å®¢æˆ·ç«¯è¿æ¥ä¸Šçš„æ•°æ®å¤§å°</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> totalBytesRead<span class="token punctuation">;</span>

        <span class="token comment">//è¡¨ç¤ºæœ¬æ¬¡read loop å°è¯•è¯»å–å¤šå°‘å­—èŠ‚ï¼ŒbyteBufferå‰©ä½™å¯å†™çš„å­—èŠ‚æ•°</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> attemptedBytesRead<span class="token punctuation">;</span>

        <span class="token comment">//æœ¬æ¬¡read loopè¯»å–åˆ°çš„å­—èŠ‚æ•°</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> lastBytesRead<span class="token punctuation">;</span>

        <span class="token comment">//é¢„è®¡ä¸‹ä¸€æ¬¡åˆ†é…bufferçš„å®¹é‡ï¼Œåˆå§‹ï¼š2048</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> nextReceiveBufferSize<span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨æ¯è½® read loop å¼€å§‹ä¹‹å‰ï¼Œéƒ½ä¼šè°ƒç”¨<code>allocHandle.reset(config)</code>é‡ç½®æ¸…ç©ºä¸Šä¸€è½® read loop çš„ç»Ÿè®¡æŒ‡æ ‡ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token class-name">ChannelConfig</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>config <span class="token operator">=</span> config<span class="token punctuation">;</span>
    <span class="token comment">//é»˜è®¤æ¯æ¬¡æœ€å¤šè¯»å–16æ¬¡</span>
    maxMessagePerRead <span class="token operator">=</span> <span class="token function">maxMessagesPerRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    totalMessages <span class="token operator">=</span> totalBytesRead <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨æ¯æ¬¡å¼€å§‹ä» NioSocketChannel ä¸­è¯»å–æ•°æ®ä¹‹å‰ï¼Œéœ€è¦åˆ©ç”¨<code>PooledByteBufAllocator</code>åœ¨å†…å­˜æ± ä¸­ä¸º ByteBuffer åˆ†é…å†…å­˜ï¼Œé»˜è®¤åˆå§‹åŒ–å¤§å°ä¸º<code>2048</code>ï¼Œè¿™ä¸ªå®¹é‡ç”±<code>guess()æ–¹æ³•</code>å†³å®šã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code>byteBuf <span class="token operator">=</span> allocHandle<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>allocator<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ByteBuf</span> <span class="token function">allocate</span><span class="token punctuation">(</span><span class="token class-name">ByteBufAllocator</span> alloc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> alloc<span class="token punctuation">.</span><span class="token function">ioBuffer</span><span class="token punctuation">(</span><span class="token function">guess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">guess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//é¢„è®¡ä¸‹ä¸€æ¬¡åˆ†é…bufferçš„å®¹é‡ï¼Œä¸€å¼€å§‹ä¸º2048</span>
    <span class="token keyword">return</span> nextReceiveBufferSize<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨æ¯æ¬¡é€šè¿‡<code>doReadBytes</code>ä» NioSocketChannel ä¸­è¯»å–åˆ°æ•°æ®åï¼Œéƒ½ä¼šè°ƒç”¨<code>allocHandle.lastBytesRead(doReadBytes(byteBuf))</code>è®°å½•æœ¬æ¬¡è¯»å–äº†å¤šå°‘å­—èŠ‚æ•°æ®ï¼Œå¹¶ç»Ÿè®¡æœ¬è½® read loop ç›®å‰æ€»å…±è¯»å–äº†å¤šå°‘å­—èŠ‚ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lastBytesRead</span><span class="token punctuation">(</span><span class="token keyword">int</span> bytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    lastBytesRead <span class="token operator">=</span> bytes<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        totalBytesRead <span class="token operator">+=</span> bytes<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ¯æ¬¡å¾ªç¯ä» NioSocketChannel ä¸­è¯»å–æ•°æ®ä¹‹åï¼Œéƒ½ä¼šè°ƒç”¨<code>allocHandle.incMessagesRead(1)</code>ã€‚ç»Ÿè®¡å½“å‰å·²ç»è¯»å–äº†å¤šå°‘æ¬¡ã€‚å¦‚æœè¶…è¿‡äº†æœ€å¤§è¯»å–é™åˆ¶æ­¤æ—¶ 16 æ¬¡ï¼Œå°±éœ€è¦é€€å‡º read loopã€‚å»å¤„ç†å…¶ä»– NioSocketChannel ä¸Šçš„ IO äº‹ä»¶ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">incMessagesRead</span><span class="token punctuation">(</span><span class="token keyword">int</span> amt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    totalMessages <span class="token operator">+=</span> amt<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨æ¯æ¬¡ read loop å¾ªç¯çš„æœ«å°¾éƒ½éœ€è¦é€šè¿‡è°ƒç”¨<code>allocHandle.continueReading()</code>æ¥åˆ¤æ–­æ˜¯å¦ç»§ç»­ read loop å¾ªç¯è¯»å– NioSocketChannel ä¸­çš„æ•°æ®ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">continueReading</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">continueReading</span><span class="token punctuation">(</span>defaultMaybeMoreSupplier<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">UncheckedBooleanSupplier</span> defaultMaybeMoreSupplier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UncheckedBooleanSupplier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//åˆ¤æ–­æœ¬æ¬¡è¯»å–byteBufferæ˜¯å¦æ»¡è½½è€Œå½’</span>
        <span class="token keyword">return</span> attemptedBytesRead <span class="token operator">==</span> lastBytesRead<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">continueReading</span><span class="token punctuation">(</span><span class="token class-name">UncheckedBooleanSupplier</span> maybeMoreDataSupplier<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> config<span class="token punctuation">.</span><span class="token function">isAutoRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span><span class="token operator">!</span>respectMaybeMoreData <span class="token operator">||</span> maybeMoreDataSupplier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        totalMessages <span class="token operator">&lt;</span> maxMessagePerRead <span class="token operator">&amp;&amp;</span>
        totalBytesRead <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>attemptedBytesRead :</code>è¡¨ç¤ºå½“å‰ ByteBuffer é¢„è®¡å°è¯•è¦å†™å…¥çš„å­—èŠ‚æ•°ã€‚</li> <li><code>lastBytesRead :</code>è¡¨ç¤ºæœ¬æ¬¡ read loop çœŸå®è¯»å–åˆ°äº†å¤šå°‘ä¸ªå­—èŠ‚ã€‚</li></ul> <p><code>defaultMaybeMoreSupplier</code>ç”¨äºåˆ¤æ–­ç»è¿‡æœ¬æ¬¡ read loop è¯»å–æ•°æ®åï¼ŒByteBuffer æ˜¯å¦æ»¡è½½è€Œå½’ã€‚å¦‚æœæ˜¯æ»¡è½½è€Œå½’çš„è¯ï¼ˆattemptedBytesRead == lastBytesReadï¼‰ï¼Œè¡¨æ˜å¯èƒ½ NioSocketChannel é‡Œè¿˜æœ‰æ•°æ®ã€‚å¦‚æœä¸æ˜¯æ»¡è½½è€Œå½’ï¼Œè¡¨æ˜ NioSocketChannel é‡Œæ²¡æœ‰æ•°æ®äº†å·²ç»ã€‚</p> <p>æ˜¯å¦ç»§ç»­è¿›è¡Œ read loop éœ€è¦<strong>åŒæ—¶</strong>æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶ï¼š</p> <ul><li><p><code>totalMessages &lt; maxMessagePerRead</code> å½“å‰è¯»å–æ¬¡æ•°æ˜¯å¦å·²ç»è¶…è¿‡<code>16æ¬¡</code>ï¼Œå¦‚æœè¶…è¿‡ï¼Œå°±é€€å‡º<code>do(...)while()</code>å¾ªç¯ã€‚è¿›è¡Œä¸‹ä¸€è½®<code>OP_READäº‹ä»¶</code>çš„è½®è¯¢ã€‚å› ä¸ºæ¯ä¸ª Sub Reactor ç®¡ç†äº†å¤šä¸ª NioSocketChannelï¼Œä¸èƒ½åœ¨ä¸€ä¸ª NioSocketChannel ä¸Šå ç”¨å¤ªå¤šæ—¶é—´ï¼Œè¦å°†æœºä¼šå‡åŒ€åœ°åˆ†é…ç»™ Sub Reactor æ‰€ç®¡ç†çš„æ‰€æœ‰ NioSocketChannelã€‚</p></li> <li><p><code>totalBytesRead &gt; 0</code> æœ¬æ¬¡<code>OP_READäº‹ä»¶</code>å¤„ç†æ˜¯å¦è¯»å–åˆ°äº†æ•°æ®ï¼Œå¦‚æœå·²ç»æ²¡æœ‰æ•°æ®å¯è¯»äº†ï¼Œé‚£ä¹ˆå°±ç›´æ¥é€€å‡º read loopã€‚</p></li> <li><p><code>!respectMaybeMoreData || maybeMoreDataSupplier.get()</code> è¿™ä¸ªæ¡ä»¶æ¯”è¾ƒå¤æ‚ï¼Œå®ƒå…¶å®å°±æ˜¯é€šè¿‡<code>respectMaybeMoreData</code>å­—æ®µæ¥æ§åˆ¶ NioSocketChannel ä¸­å¯èƒ½è¿˜æœ‰æ•°æ®å¯è¯»çš„æƒ…å†µä¸‹è¯¥å¦‚ä½•å¤„ç†ã€‚</p></li> <li><ul><li><code>maybeMoreDataSupplier.get()</code>ï¼štrue è¡¨ç¤ºæœ¬æ¬¡è¯»å–ä» NioSocketChannel ä¸­è¯»å–æ•°æ®ï¼ŒByteBuffer æ»¡è½½è€Œå½’ã€‚è¯´æ˜å¯èƒ½ NioSocketChannel ä¸­è¿˜æœ‰æ•°æ®æ²¡è¯»å®Œã€‚fasle è¡¨ç¤º ByteBuffer è¿˜æ²¡æœ‰è£…æ»¡ï¼Œè¯´æ˜ NioSocketChannel ä¸­å·²ç»æ²¡æœ‰æ•°æ®å¯è¯»äº†ã€‚</li> <li><code>respectMaybeMoreData = true</code>è¡¨ç¤ºè¦å¯¹å¯èƒ½è¿˜æœ‰æ›´å¤šæ•°æ®è¿›è¡Œå¤„ç†çš„è¿™ç§æƒ…å†µè¦<code>respect</code>è®¤çœŸå¯¹å¾…,å¦‚æœæœ¬æ¬¡å¾ªç¯è¯»å–åˆ°çš„æ•°æ®å·²ç»è£…æ»¡<code>ByteBuffer</code>ï¼Œè¡¨ç¤ºåé¢å¯èƒ½è¿˜æœ‰æ•°æ®ï¼Œé‚£ä¹ˆå°±è¦è¿›è¡Œè¯»å–ã€‚å¦‚æœ<code>ByteBuffer</code>è¿˜æ²¡è£…æ»¡è¡¨ç¤ºå·²ç»æ²¡æœ‰æ•°æ®å¯è¯»äº†é‚£ä¹ˆå°±é€€å‡ºå¾ªç¯ã€‚![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)</li> <li><code>respectMaybeMoreData = false</code>è¡¨ç¤ºå¯¹å¯èƒ½è¿˜æœ‰æ›´å¤šæ•°æ®çš„è¿™ç§æƒ…å†µä¸è®¤çœŸå¯¹å¾… <code>not respect</code>ã€‚ä¸ç®¡æœ¬æ¬¡å¾ªç¯è¯»å–æ•°æ®<code>ByteBuffer</code>æ˜¯å¦æ»¡è½½è€Œå½’ï¼Œéƒ½è¦ç»§ç»­è¿›è¡Œè¯»å–ï¼Œç›´åˆ°è¯»å–ä¸åˆ°æ•°æ®åœ¨é€€å‡ºå¾ªç¯ï¼Œå±äºæ— è„‘è¯»å–ã€‚</li></ul></li></ul> <p>åŒæ—¶æ»¡è¶³ä»¥ä¸Šä¸‰ä¸ªæ¡ä»¶ï¼Œé‚£ä¹ˆ read loop ç»§ç»­è¿›è¡Œã€‚ç»§ç»­ä» NioSocketChannel ä¸­è¯»å–æ•°æ®ï¼Œç›´åˆ°è¯»å–ä¸åˆ°æˆ–è€…ä¸æ»¡è¶³ä¸‰ä¸ªæ¡ä»¶ä¸­çš„ä»»æ„ä¸€ä¸ªä¸ºæ­¢ã€‚</p> <h3 id="_3-2-ä»-niosocketchannel-ä¸­è¯»å–æ•°æ®"><a href="#_3-2-ä»-niosocketchannel-ä¸­è¯»å–æ•°æ®" class="header-anchor">#</a> 3.2 ä» NioSocketChannel ä¸­è¯»å–æ•°æ®</h3> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NioSocketChannel</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractNioByteChannel</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>socket<span class="token punctuation">.</span></span>SocketChannel</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">doReadBytes</span><span class="token punctuation">(</span><span class="token class-name">ByteBuf</span> byteBuf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">RecvByteBufAllocator<span class="token punctuation">.</span>Handle</span> allocHandle <span class="token operator">=</span> <span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">recvBufAllocHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        allocHandle<span class="token punctuation">.</span><span class="token function">attemptedBytesRead</span><span class="token punctuation">(</span>byteBuf<span class="token punctuation">.</span><span class="token function">writableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> byteBuf<span class="token punctuation">.</span><span class="token function">writeBytes</span><span class="token punctuation">(</span><span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> allocHandle<span class="token punctuation">.</span><span class="token function">attemptedBytesRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¿™é‡Œä¼šç›´æ¥è°ƒç”¨åº•å±‚ JDK NIO çš„<code>SocketChannel#read</code>æ–¹æ³•å°†æ•°æ®è¯»å–åˆ° DirectByteBuffer ä¸­ã€‚è¯»å–æ•°æ®å¤§å°ä¸ºæœ¬æ¬¡åˆ†é…çš„ DirectByteBuffer å®¹é‡ï¼Œåˆå§‹ä¸º 2048ã€‚</p> <h2 id="_4-bytebuffer-åŠ¨æ€è‡ªé€‚åº”æ‰©ç¼©å®¹æœºåˆ¶"><a href="#_4-bytebuffer-åŠ¨æ€è‡ªé€‚åº”æ‰©ç¼©å®¹æœºåˆ¶" class="header-anchor">#</a> 4. ByteBuffer åŠ¨æ€è‡ªé€‚åº”æ‰©ç¼©å®¹æœºåˆ¶</h2> <p>ç”±äºæˆ‘ä»¬ä¸€å¼€å§‹å¹¶ä¸çŸ¥é“å®¢æˆ·ç«¯ä¼šå‘é€å¤šå¤§çš„ç½‘ç»œæ•°æ®ï¼Œæ‰€ä»¥è¿™é‡Œå…ˆåˆ©ç”¨<code>PooledByteBufAllocator</code>åˆ†é…ä¸€ä¸ªåˆå§‹å®¹é‡ä¸º<code>2048</code>çš„ DirectByteBuffer ç”¨äºæ¥æ”¶æ•°æ®ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code>byteBuf <span class="token operator">=</span> allocHandle<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>allocator<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>è¿™å°±å¥½æ¯”æˆ‘ä»¬éœ€è¦æ‹¿ç€ä¸€ä¸ªæ¡¶å»æ’é˜Ÿè£…æ°´ï¼Œä½†æ˜¯ç¬¬ä¸€æ¬¡å»è£…çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“ç®¡ç†å‘˜ä¼šç»™æˆ‘ä»¬åˆ†é…å¤šå°‘æ°´ï¼Œæ¡¶æ‹¿å¤§äº†ä¹Ÿä¸åˆé€‚æ‹¿å°äº†ä¹Ÿä¸åˆé€‚ï¼Œäºæ˜¯æˆ‘ä»¬å°±å…ˆé¢„ä¼°ä¸€ä¸ªå·®ä¸å¤šå®¹é‡å¤§å°çš„æ¡¶ï¼Œå¦‚æœåˆ†é…çš„å¤šäº†ï¼Œæˆ‘ä»¬ä¸‹æ¬¡å°±æ‹¿æ›´å¤§ä¸€ç‚¹çš„æ¡¶ï¼Œå¦‚æœåˆ†é…å°‘äº†ï¼Œä¸‹æ¬¡æˆ‘ä»¬å°±æ‹¿ä¸€ä¸ªå°ç‚¹çš„æ¡¶ã€‚</p> <p>åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ ByteBuffer å¯ä»¥è‡ªåŠ¨æ ¹æ®æ¯æ¬¡ç½‘ç»œæ•°æ®çš„å¤§å°æ¥åŠ¨æ€è‡ªé€‚åº”è°ƒæ•´è‡ªå·±çš„å®¹é‡ã€‚</p> <p>è€Œ ByteBuffer åŠ¨æ€è‡ªé€‚åº”æ‰©ç¼©å®¹æœºåˆ¶ä¾èµ–äº AdaptiveRecvByteBufAllocator ç±»çš„å®ç°ã€‚è®©æˆ‘ä»¬å…ˆå›åˆ° AdaptiveRecvByteBufAllocator ç±»çš„åˆ›å»ºèµ·ç‚¹å¼€å§‹è¯´èµ·~~</p> <h3 id="_4-1-adaptiverecvbytebufallocator-çš„åˆ›å»º"><a href="#_4-1-adaptiverecvbytebufallocator-çš„åˆ›å»º" class="header-anchor">#</a> 4.1 AdaptiveRecvByteBufAllocator çš„åˆ›å»º</h3> <p>åœ¨å‰æ–‡<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484184&amp;idx=1&amp;sn=726877ce28cf6e5d2ac3225fae687f19&amp;chksm=ce77c55ff9004c493b592288819dc4d4664b5949ee97fed977b6558bc517dad0e1f73fab0f46&amp;scene=21&amp;cur_album_id=2217816582418956300#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€ŠNetty æ˜¯å¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œè¿æ¥ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸­æˆ‘ä»¬æåˆ°ï¼Œå½“ Main Reactor ç›‘å¬åˆ° OP_ACCPET äº‹ä»¶æ´»è·ƒåï¼Œä¼šåœ¨ NioServerSocketChannel ä¸­ accept å®Œæˆä¸‰æ¬¡æ¡æ‰‹çš„å®¢æˆ·ç«¯è¿æ¥ã€‚å¹¶åˆ›å»º NioSocketChannelï¼Œä¼´éšç€ NioSocketChannel çš„åˆ›å»ºå…¶å¯¹åº”çš„é…ç½®ç±» NioSocketChannelConfig ç±»ä¹Ÿä¼šéšä¹‹åˆ›å»ºã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">NioSocketChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> parent<span class="token punctuation">,</span> <span class="token class-name">SocketChannel</span> socket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
    config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioSocketChannelConfig</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> socket<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æœ€ç»ˆä¼šåœ¨ NioSocketChannelConfig çš„çˆ¶ç±»<code>DefaultChannelConfig</code>çš„æ„é€ å™¨ä¸­åˆ›å»º<code>AdaptiveRecvByteBufAllocator</code>ã€‚å¹¶ä¿å­˜åœ¨<code>RecvByteBufAllocator rcvBufAllocator</code>å­—æ®µä¸­ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultChannelConfig</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelConfig</span> <span class="token punctuation">{</span>

    <span class="token comment">//ç”¨äºChannelæ¥æ”¶æ•°æ®ç”¨çš„bufferåˆ†é…å™¨  AdaptiveRecvByteBufAllocator</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">RecvByteBufAllocator</span> rcvBufAllocator<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">DefaultChannelConfig</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AdaptiveRecvByteBufAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨<code>new AdaptiveRecvByteBufAllocator()</code>åˆ›å»º AdaptiveRecvByteBufAllocator ç±»å®ä¾‹çš„æ—¶å€™ä¼šå…ˆè§¦å‘ AdaptiveRecvByteBufAllocator ç±»çš„åˆå§‹åŒ–ã€‚</p> <p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ AdaptiveRecvByteBufAllocator ç±»çš„åˆå§‹åŒ–éƒ½åšäº†äº›ä»€ä¹ˆäº‹æƒ…ï¼š</p> <h3 id="_4-2-adaptiverecvbytebufallocator-ç±»çš„åˆå§‹åŒ–"><a href="#_4-2-adaptiverecvbytebufallocator-ç±»çš„åˆå§‹åŒ–" class="header-anchor">#</a> 4.2 AdaptiveRecvByteBufAllocator ç±»çš„åˆå§‹åŒ–</h3> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AdaptiveRecvByteBufAllocator</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultMaxMessagesRecvByteBufAllocator</span> <span class="token punctuation">{</span>

    <span class="token comment">//æ‰©å®¹æ­¥é•¿</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">INDEX_INCREMENT</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token comment">//ç¼©å®¹æ­¥é•¿</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">INDEX_DECREMENT</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">//RecvBufåˆ†é…å®¹é‡è¡¨ï¼ˆæ‰©ç¼©å®¹ç´¢å¼•è¡¨ï¼‰æŒ‰ç…§è¡¨ä¸­è®°å½•çš„å®¹é‡å¤§å°è¿›è¡Œæ‰©ç¼©å®¹</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">SIZE_TABLE</span><span class="token punctuation">;</span>

   <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token comment">//åˆå§‹åŒ–RecvBufå®¹é‡åˆ†é…è¡¨</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> sizeTable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//å½“åˆ†é…å®¹é‡å°äº512æ—¶ï¼Œæ‰©å®¹å•ä½ä¸º16é€’å¢</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">512</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sizeTable<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//å½“åˆ†é…å®¹é‡å¤§äº512æ—¶ï¼Œæ‰©å®¹å•ä½ä¸ºä¸€å€</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">512</span><span class="token punctuation">;</span> i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sizeTable<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//åˆå§‹åŒ–RecbBufæ‰©ç¼©å®¹ç´¢å¼•è¡¨</span>
        <span class="token constant">SIZE_TABLE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>sizeTable<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">SIZE_TABLE</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">SIZE_TABLE</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> sizeTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>AdaptiveRecvByteBufAllocator ä¸»è¦çš„ä½œç”¨å°±æ˜¯ä¸ºæ¥æ”¶æ•°æ®çš„<code>ByteBuffer</code>è¿›è¡Œæ‰©å®¹ç¼©å®¹ï¼Œé‚£ä¹ˆæ¯æ¬¡æ€ä¹ˆæ‰©å®¹ï¼Ÿæ‰©å®¹å¤šå°‘ï¼Ÿæ€ä¹ˆç¼©å®¹ï¼Ÿç¼©å®¹å¤šå°‘å‘¢ï¼Ÿ</p> <p>è¿™å››ä¸ªé—®é¢˜å°†æ˜¯æœ¬å°èŠ‚ç¬”è€…è¦ä¸ºå¤§å®¶è§£ç­”çš„å†…å®¹~~~</p> <p>Netty ä¸­å®šä¹‰äº†ä¸€ä¸ª<code>intå‹</code>çš„æ•°ç»„<code>SIZE_TABLE</code>æ¥å­˜å‚¨æ¯ä¸ªæ‰©å®¹å•ä½å¯¹åº”çš„å®¹é‡å¤§å°ã€‚å»ºç«‹èµ·æ‰©ç¼©å®¹çš„å®¹é‡ç´¢å¼•è¡¨ã€‚æ¯æ¬¡æ‰©å®¹å¤šå°‘ï¼Œç¼©å®¹å¤šå°‘å…¨éƒ¨è®°å½•åœ¨è¿™ä¸ªå®¹é‡ç´¢å¼•è¡¨ä¸­ã€‚</p> <p>åœ¨ AdaptiveRecvByteBufAllocatorl ç±»åˆå§‹åŒ–çš„æ—¶å€™ä¼šåœ¨<code>static{}</code>é™æ€ä»£ç å—ä¸­å¯¹æ‰©ç¼©å®¹ç´¢å¼•è¡¨<code>SIZE_TABLE</code>è¿›è¡Œåˆå§‹åŒ–ã€‚</p> <p>ä»æºç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡º<code>SIZE_TABLE</code>çš„åˆå§‹åŒ–åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š</p> <ul><li>å½“ç´¢å¼•å®¹é‡å°äº<code>512</code>æ—¶ï¼Œ<code>SIZE_TABLE</code>ä¸­å®šä¹‰çš„å®¹é‡ç´¢å¼•æ˜¯ä»<code>16å¼€å§‹</code>æŒ‰<code>16</code>é€’å¢ã€‚</li></ul> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <ul><li>å½“ç´¢å¼•å®¹é‡å¤§äº<code>512</code>æ—¶ï¼Œ<code>SIZE_TABLE</code>ä¸­å®šä¹‰çš„å®¹é‡ç´¢å¼•æ˜¯æŒ‰å‰ä¸€ä¸ªç´¢å¼•å®¹é‡çš„ 2 å€é€’å¢ã€‚</li></ul> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <h3 id="_4-3-æ‰©ç¼©å®¹é€»è¾‘"><a href="#_4-3-æ‰©ç¼©å®¹é€»è¾‘" class="header-anchor">#</a> 4.3 æ‰©ç¼©å®¹é€»è¾‘</h3> <p>ç°åœ¨æ‰©ç¼©å®¹ç´¢å¼•è¡¨<code>SIZE_TABLE</code>å·²ç»åˆå§‹åŒ–å®Œæ¯•äº†ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬éœ€è¦å¯¹<code>ByteBuffer</code>è¿›è¡Œæ‰©å®¹æˆ–è€…ç¼©å®¹çš„æ—¶å€™å¦‚ä½•æ ¹æ®<code>SIZE_TABLE</code>å†³å®šæ‰©å®¹å¤šå°‘æˆ–è€…ç¼©å®¹å¤šå°‘å‘¢ï¼Ÿï¼Ÿ</p> <p>è¿™å°±ç”¨åˆ°äº†åœ¨ AdaptiveRecvByteBufAllocator ç±»ä¸­å®šä¹‰çš„æ‰©å®¹æ­¥é•¿<code>INDEX_INCREMENT = 4</code>ï¼Œç¼©å®¹æ­¥é•¿<code>INDEX_DECREMENT = 1</code>äº†ã€‚</p> <p>æˆ‘ä»¬å°±ä»¥ä¸Šé¢ä¸¤å‰¯æ‰©ç¼©å®¹å®¹é‡ç´¢å¼•è¡¨<code>SIZE_TABLE</code>ä¸­çš„å®¹é‡ç´¢å¼•å±•ç¤ºæˆªå›¾ä¸ºä¾‹ï¼Œæ¥ä»‹ç»ä¸‹æ‰©ç¼©å®¹é€»è¾‘ï¼Œå‡è®¾æˆ‘ä»¬å½“å‰<code>ByteBuffer</code>çš„å®¹é‡ç´¢å¼•ä¸º<code>33</code>ï¼Œå¯¹åº”çš„å®¹é‡ä¸º<code>2048</code>ã€‚</p> <h4 id="_4-3-1-æ‰©å®¹"><a href="#_4-3-1-æ‰©å®¹" class="header-anchor">#</a> 4.3.1 æ‰©å®¹</h4> <p>å½“å¯¹å®¹é‡ä¸º<code>2048</code>çš„ ByteBuffer è¿›è¡Œæ‰©å®¹æ—¶ï¼Œæ ¹æ®å½“å‰çš„å®¹é‡ç´¢å¼•<code>index = 33</code> <strong>åŠ ä¸Š</strong> æ‰©å®¹æ­¥é•¿<code>INDEX_INCREMENT = 4</code>è®¡ç®—å‡ºæ‰©å®¹åçš„å®¹é‡ç´¢å¼•ä¸º<code>37</code>ï¼Œé‚£ä¹ˆæ‰©ç¼©å®¹ç´¢å¼•è¡¨<code>SIZE_TABLE</code>ä¸‹æ ‡<code>37</code>å¯¹åº”çš„å®¹é‡å°±æ˜¯æœ¬æ¬¡ ByteBuffer æ‰©å®¹åçš„å®¹é‡<code>SIZE_TABLE[37] = 32768</code></p> <h4 id="_4-3-1-ç¼©å®¹"><a href="#_4-3-1-ç¼©å®¹" class="header-anchor">#</a> 4.3.1 ç¼©å®¹</h4> <p>åŒç†å¯¹å®¹é‡ä¸º<code>2048</code>çš„ ByteBuffer è¿›è¡Œç¼©å®¹æ—¶ï¼Œæˆ‘ä»¬å°±éœ€è¦ç”¨å½“å‰å®¹é‡ç´¢å¼•<code>index = 33</code> <strong>å‡å»</strong> ç¼©å®¹æ­¥é•¿<code>INDEX_DECREMENT = 1</code>è®¡ç®—å‡ºç¼©å®¹åçš„å®¹é‡ç´¢å¼•<code>32</code>ï¼Œé‚£ä¹ˆæ‰©ç¼©å®¹ç´¢å¼•è¡¨<code>SIZE_TABLE</code>ä¸‹æ ‡<code>32</code>å¯¹åº”çš„å®¹é‡å°±æ˜¯æœ¬æ¬¡ ByteBuffer ç¼©å®¹åçš„å®¹é‡<code>SIZE_TABLE[32] = 1024</code></p> <h3 id="_4-4-æ‰©ç¼©å®¹æ—¶æœº"><a href="#_4-4-æ‰©ç¼©å®¹æ—¶æœº" class="header-anchor">#</a> 4.4 æ‰©ç¼©å®¹æ—¶æœº</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractNioByteChannel</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractNioChannel</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">do</span> <span class="token punctuation">{</span>
                      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>allocHandle<span class="token punctuation">.</span><span class="token function">continueReading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//æ ¹æ®æœ¬æ¬¡read loopæ€»å…±è¯»å–çš„å­—èŠ‚æ•°ï¼Œå†³å®šä¸‹æ¬¡æ˜¯å¦æ‰©å®¹æˆ–è€…ç¼©å®¹</span>
                allocHandle<span class="token punctuation">.</span><span class="token function">readComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
               <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨æ¯è½® read loop ç»“æŸä¹‹åï¼Œæˆ‘ä»¬éƒ½ä¼šè°ƒç”¨<code>allocHandle.readComplete()</code>æ¥æ ¹æ®åœ¨ allocHandle ä¸­ç»Ÿè®¡çš„åœ¨æœ¬è½® read loop ä¸­è¯»å–å­—èŠ‚æ€»å¤§å°ï¼Œæ¥å†³å®šåœ¨ä¸‹ä¸€è½® read loop ä¸­æ˜¯å¦å¯¹ DirectByteBuffer è¿›è¡Œæ‰©å®¹æˆ–è€…ç¼©å®¹ã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">MaxMessageHandle</span> <span class="token keyword">implements</span> <span class="token class-name">ExtendedHandle</span> <span class="token punctuation">{</span>

       <span class="token annotation punctuation">@Override</span>
       <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">readComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//æ˜¯å¦å¯¹recvbufè¿›è¡Œæ‰©å®¹ç¼©å®¹</span>
                <span class="token function">record</span><span class="token punctuation">(</span><span class="token function">totalBytesRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

       <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">record</span><span class="token punctuation">(</span><span class="token keyword">int</span> actualReadBytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>actualReadBytes <span class="token operator">&lt;=</span> <span class="token constant">SIZE_TABLE</span><span class="token punctuation">[</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> index <span class="token operator">-</span> <span class="token constant">INDEX_DECREMENT</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>decreaseNow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    index <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>index <span class="token operator">-</span> <span class="token constant">INDEX_DECREMENT</span><span class="token punctuation">,</span> minIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    nextReceiveBufferSize <span class="token operator">=</span> <span class="token constant">SIZE_TABLE</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    decreaseNow <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    decreaseNow <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>actualReadBytes <span class="token operator">&gt;=</span> nextReceiveBufferSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                index <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token constant">INDEX_INCREMENT</span><span class="token punctuation">,</span> maxIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                nextReceiveBufferSize <span class="token operator">=</span> <span class="token constant">SIZE_TABLE</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
                decreaseNow <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æˆ‘ä»¬ä»¥å½“å‰ ByteBuffer å®¹é‡ä¸º<code>2048</code>ï¼Œå®¹é‡ç´¢å¼•<code>index = 33</code>ä¸ºä¾‹ï¼Œå¯¹<code>allocHandle</code>çš„æ‰©å®¹ç¼©å®¹è§„åˆ™è¿›è¡Œè¯´æ˜ã€‚</p> <blockquote><p>æ‰©å®¹æ­¥é•¿<code>INDEX_INCREMENT = 4</code>ï¼Œç¼©å®¹æ­¥é•¿<code>INDEX_DECREMENT = 1</code>ã€‚</p></blockquote> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191131842.png" alt="å›¾ç‰‡">image.png</p> <h4 id="_4-4-1-ç¼©å®¹"><a href="#_4-4-1-ç¼©å®¹" class="header-anchor">#</a> 4.4.1 ç¼©å®¹</h4> <ul><li>å¦‚æœæœ¬æ¬¡<code>OP_READäº‹ä»¶</code>å®é™…è¯»å–åˆ°çš„æ€»å­—èŠ‚æ•°<code>actualReadBytes</code>åœ¨ SIZE_TABLE[index - INDEX_DECREMENT]ä¸ SIZE_TABLE[index]ä¹‹é—´çš„è¯ï¼Œä¹Ÿå°±æ˜¯å¦‚æœæœ¬è½® read loop ç»“æŸä¹‹åæ€»å…±è¯»å–çš„å­—èŠ‚æ•°åœ¨<code>[1024,2048]</code>ä¹‹é—´ã€‚è¯´æ˜æ­¤æ—¶åˆ†é…çš„<code>ByteBuffer</code>å®¹é‡æ­£å¥½ï¼Œä¸éœ€è¦è¿›è¡Œç¼©å®¹ä¹Ÿä¸éœ€è¦è¿›è¡Œæ‰©å®¹ã€‚æ¯”å¦‚æœ¬æ¬¡<code>actualReadBytes = 2000</code>ï¼Œæ­£å¥½å¤„åœ¨<code>1024</code>ä¸<code>2048</code>ä¹‹é—´ã€‚è¯´æ˜<code>2048</code>çš„å®¹é‡æ­£å¥½ã€‚</li> <li>å¦‚æœ<code>actualReadBytes</code> å°äºç­‰äº SIZE_TABLE[index - INDEX_DECREMENT]ï¼Œä¹Ÿå°±æ˜¯å¦‚æœæœ¬è½® read loop ç»“æŸä¹‹åæ€»å…±è¯»å–çš„å­—èŠ‚æ•°å°äºç­‰äº<code>1024</code>ã€‚è¡¨ç¤ºæœ¬æ¬¡è¯»å–åˆ°çš„å­—èŠ‚æ•°æ¯”å½“å‰ ByteBuffer å®¹é‡çš„ä¸‹ä¸€çº§å®¹é‡è¿˜è¦å°ï¼Œè¯´æ˜å½“å‰ ByteBuffer çš„å®¹é‡åˆ†é…çš„æœ‰äº›å¤§äº†ï¼Œè®¾ç½®ç¼©å®¹æ ‡è¯†<code>decreaseNow = true</code>ã€‚å½“ä¸‹æ¬¡<code>OP_READäº‹ä»¶</code>ç»§ç»­æ»¡è¶³ç¼©å®¹æ¡ä»¶çš„æ—¶å€™ï¼Œå¼€å§‹çœŸæ­£çš„è¿›è¡Œç¼©å®¹ã€‚ç¼©å®¹åçš„å®¹é‡ä¸º SIZE_TABLE[index - INDEX_DECREMENT]ï¼Œä½†ä¸èƒ½å°äº SIZE_TABLE[minIndex]ã€‚</li></ul> <blockquote><p>æ³¨æ„éœ€è¦æ»¡è¶³ä¸¤æ¬¡ç¼©å®¹æ¡ä»¶æ‰ä¼šè¿›è¡Œç¼©å®¹ï¼Œä¸”ç¼©å®¹æ­¥é•¿ä¸º 1ï¼Œç¼©å®¹æ¯”è¾ƒè°¨æ…</p></blockquote> <h4 id="_4-4-2-æ‰©å®¹"><a href="#_4-4-2-æ‰©å®¹" class="header-anchor">#</a> 4.4.2 æ‰©å®¹</h4> <p>å¦‚æœæœ¬æ¬¡<code>OP_READäº‹ä»¶</code>å¤„ç†æ€»å…±è¯»å–çš„å­—èŠ‚æ•°<code>actualReadBytes</code> å¤§äºç­‰äº å½“å‰ ByteBuffer å®¹é‡(nextReceiveBufferSize)æ—¶ï¼Œè¯´æ˜ ByteBuffer åˆ†é…çš„å®¹é‡æœ‰ç‚¹å°äº†ï¼Œéœ€è¦è¿›è¡Œæ‰©å®¹ã€‚æ‰©å®¹åçš„å®¹é‡ä¸º SIZE_TABLE[index + INDEX_INCREMENT]ï¼Œä½†ä¸èƒ½è¶…è¿‡ SIZE_TABLE[maxIndex]ã€‚</p> <blockquote><p>æ»¡è¶³ä¸€æ¬¡æ‰©å®¹æ¡ä»¶å°±è¿›è¡Œæ‰©å®¹ï¼Œå¹¶ä¸”æ‰©å®¹æ­¥é•¿ä¸º 4ï¼Œ æ‰©å®¹æ¯”è¾ƒå¥”æ”¾</p></blockquote> <h3 id="_4-5-adaptiverecvbytebufallocator-ç±»çš„å®ä¾‹åŒ–"><a href="#_4-5-adaptiverecvbytebufallocator-ç±»çš„å®ä¾‹åŒ–" class="header-anchor">#</a> 4.5 AdaptiveRecvByteBufAllocator ç±»çš„å®ä¾‹åŒ–</h3> <p>AdaptiveRecvByteBufAllocator ç±»çš„å®ä¾‹åŒ–ä¸»è¦æ˜¯ç¡®å®š ByteBuffer çš„åˆå§‹å®¹é‡ï¼Œä»¥åŠæœ€å°å®¹é‡å’Œæœ€å¤§å®¹é‡åœ¨æ‰©ç¼©å®¹ç´¢å¼•è¡¨<code>SIZE_TABLE</code>ä¸­çš„ä¸‹æ ‡ï¼š<code>minIndex</code>å’Œ<code>maxIndex</code>ã€‚</p> <p>AdaptiveRecvByteBufAllocator å®šä¹‰äº†ä¸‰ä¸ªå…³äº ByteBuffer å®¹é‡çš„å­—æ®µï¼š</p> <ul><li><code>DEFAULT_MINIMUM</code> ï¼šè¡¨ç¤º ByteBuffer æœ€å°çš„å®¹é‡ï¼Œé»˜è®¤ä¸º<code>64</code>ï¼Œä¹Ÿå°±æ˜¯æ— è®º ByteBuffer åœ¨æ€ä¹ˆç¼©å®¹ï¼Œå®¹é‡ä¹Ÿä¸ä¼šä½äº<code>64</code>ã€‚</li> <li><code>DEFAULT_INITIAL</code>ï¼šè¡¨ç¤º ByteBuffer çš„åˆå§‹åŒ–å®¹é‡ã€‚é»˜è®¤ä¸º<code>2048</code>ã€‚</li> <li><code>DEFAULT_MAXIMUM</code> ï¼šè¡¨ç¤º ByteBuffer çš„æœ€å¤§å®¹é‡ï¼Œé»˜è®¤ä¸º<code>65536</code>ï¼Œä¹Ÿå°±æ˜¯æ— è®º ByteBuffer åœ¨æ€ä¹ˆæ‰©å®¹ï¼Œå®¹é‡ä¹Ÿä¸ä¼šè¶…è¿‡<code>65536</code>ã€‚</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AdaptiveRecvByteBufAllocator</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultMaxMessagesRecvByteBufAllocator</span> <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_MINIMUM</span> <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_INITIAL</span> <span class="token operator">=</span> <span class="token number">2048</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_MAXIMUM</span> <span class="token operator">=</span> <span class="token number">65536</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">AdaptiveRecvByteBufAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_MINIMUM</span><span class="token punctuation">,</span> <span class="token constant">DEFAULT_INITIAL</span><span class="token punctuation">,</span> <span class="token constant">DEFAULT_MAXIMUM</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">AdaptiveRecvByteBufAllocator</span><span class="token punctuation">(</span><span class="token keyword">int</span> minimum<span class="token punctuation">,</span> <span class="token keyword">int</span> initial<span class="token punctuation">,</span> <span class="token keyword">int</span> maximum<span class="token punctuation">)</span> <span class="token punctuation">{</span>

         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥å¼‚å¸¸æ£€æŸ¥é€»è¾‘<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment">//è®¡ç®—minIndex maxIndex</span>
        <span class="token comment">//åœ¨SIZE_TABLEä¸­äºŒåˆ†æŸ¥æ‰¾æœ€å° &gt;= minimumçš„å®¹é‡ç´¢å¼• ï¼š3</span>
        <span class="token keyword">int</span> minIndex <span class="token operator">=</span> <span class="token function">getSizeTableIndex</span><span class="token punctuation">(</span>minimum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">SIZE_TABLE</span><span class="token punctuation">[</span>minIndex<span class="token punctuation">]</span> <span class="token operator">&lt;</span> minimum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>minIndex <span class="token operator">=</span> minIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>minIndex <span class="token operator">=</span> minIndex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//åœ¨SIZE_TABLEä¸­äºŒåˆ†æŸ¥æ‰¾æœ€å¤§ &lt;= maximumçš„å®¹é‡ç´¢å¼• ï¼š38</span>
        <span class="token keyword">int</span> maxIndex <span class="token operator">=</span> <span class="token function">getSizeTableIndex</span><span class="token punctuation">(</span>maximum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">SIZE_TABLE</span><span class="token punctuation">[</span>maxIndex<span class="token punctuation">]</span> <span class="token operator">&gt;</span> maximum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>maxIndex <span class="token operator">=</span> maxIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>maxIndex <span class="token operator">=</span> maxIndex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>initial <span class="token operator">=</span> initial<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ¥ä¸‹æ¥çš„äº‹æƒ…å°±æ˜¯ç¡®å®šæœ€å°å®¹é‡ DEFAULT_MINIMUM åœ¨ SIZE_TABLE ä¸­çš„ä¸‹æ ‡<code>minIndex</code>ï¼Œä»¥åŠæœ€å¤§å®¹é‡ DEFAULT_MAXIMUM åœ¨ SIZE_TABLE ä¸­çš„ä¸‹æ ‡<code>maxIndex</code>ã€‚</p> <p>ä» AdaptiveRecvByteBufAllocator ç±»åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡º SIZE_TABLE ä¸­å­˜å‚¨çš„æ•°æ®ç‰¹å¾æ˜¯ä¸€ä¸ªæœ‰åºçš„é›†åˆã€‚</p> <p>æˆ‘ä»¬å¯ä»¥é€šè¿‡<strong>äºŒåˆ†æŸ¥æ‰¾</strong>åœ¨ SIZE_TABLE ä¸­æ‰¾å‡º<code>ç¬¬ä¸€ä¸ª</code>å®¹é‡å¤§äºç­‰äº DEFAULT_MINIMUM çš„å®¹é‡ç´¢å¼•<code>minIndex</code>ã€‚</p> <p>åŒç†é€šè¿‡<strong>äºŒåˆ†æŸ¥æ‰¾</strong>åœ¨ SIZE_TABLE ä¸­æ‰¾å‡º<code>æœ€åä¸€ä¸ª</code>å®¹é‡å°äºç­‰äº DEFAULT_MAXIMUM çš„å®¹é‡ç´¢å¼•<code>maxIndex</code>ã€‚</p> <p>æ ¹æ®ä¸Šä¸€å°èŠ‚å…³äº<code>SIZE_TABLE</code>ä¸­å®¹é‡æ•°æ®åˆ†å¸ƒçš„æˆªå›¾ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡º<code>minIndex = 3</code>ï¼Œ<code>maxIndex = 38</code></p> <h4 id="_4-5-1-äºŒåˆ†æŸ¥æ‰¾å®¹é‡ç´¢å¼•ä¸‹æ ‡"><a href="#_4-5-1-äºŒåˆ†æŸ¥æ‰¾å®¹é‡ç´¢å¼•ä¸‹æ ‡" class="header-anchor">#</a> 4.5.1 äºŒåˆ†æŸ¥æ‰¾å®¹é‡ç´¢å¼•ä¸‹æ ‡</h4> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">getSizeTableIndex</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> low <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> high <span class="token operator">=</span> <span class="token constant">SIZE_TABLE</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>high <span class="token operator">&lt;</span> low<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> low<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>high <span class="token operator">==</span> low<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> high<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">int</span> mid <span class="token operator">=</span> low <span class="token operator">+</span> high <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//æ— ç¬¦å·å³ç§»ï¼Œé«˜ä½å§‹ç»ˆè¡¥0</span>
            <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token constant">SIZE_TABLE</span><span class="token punctuation">[</span>mid<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token constant">SIZE_TABLE</span><span class="token punctuation">[</span>mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                low <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                high <span class="token operator">=</span> mid <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> mid<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><blockquote><p>ç»å¸¸åˆ· LeetCode çš„å°ä¼™ä¼´è‚¯å®šä¸€çœ¼å°±çœ‹å‡ºè¿™ä¸ªæ˜¯<strong>äºŒåˆ†æŸ¥æ‰¾çš„æ¨¡æ¿</strong>äº†ã€‚</p></blockquote> <p>å®ƒçš„ç›®çš„å°±æ˜¯æ ¹æ®ç»™å®šå®¹é‡ï¼Œåœ¨æ‰©ç¼©å®¹ç´¢å¼•è¡¨<code>SIZE_TABLE</code>ä¸­ï¼Œé€šè¿‡<strong>äºŒåˆ†æŸ¥æ‰¾</strong>æ‰¾åˆ°<code>æœ€è´´è¿‘</code>ç»™å®š size çš„å®¹é‡çš„ç´¢å¼•ä¸‹æ ‡ï¼ˆç¬¬ä¸€ä¸ªå¤§äºç­‰äº size çš„å®¹é‡ï¼‰</p> <h3 id="_4-6-recvbytebufallocator-handle"><a href="#_4-6-recvbytebufallocator-handle" class="header-anchor">#</a> 4.6 RecvByteBufAllocator.Handle</h3> <p>å‰è¾¹æˆ‘ä»¬æåˆ°æœ€ç»ˆåŠ¨æ€è°ƒæ•´ ByteBuffer å®¹é‡çš„æ˜¯ç”± AdaptiveRecvByteBufAllocator ä¸­çš„<code>Handler</code>è´Ÿè´£çš„ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹è¿™ä¸ª<code>allocHandle</code>çš„åˆ›å»ºè¿‡ç¨‹ã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractUnsafe</span> <span class="token keyword">implements</span> <span class="token class-name">Unsafe</span> <span class="token punctuation">{</span>

        <span class="token keyword">private</span> <span class="token class-name">RecvByteBufAllocator<span class="token punctuation">.</span>Handle</span> recvHandle<span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">RecvByteBufAllocator<span class="token punctuation">.</span>Handle</span> <span class="token function">recvBufAllocHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>recvHandle <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                recvHandle <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRecvByteBufAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> recvHandle<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>ä» allocHandle çš„è·å–è¿‡ç¨‹æˆ‘ä»¬çœ‹åˆ°æœ€ allocHandle çš„åˆ›å»ºæ˜¯ç”±<code>AdaptiveRecvByteBufAllocator#newHandle</code>æ–¹æ³•æ‰§è¡Œçš„ã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AdaptiveRecvByteBufAllocator</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultMaxMessagesRecvByteBufAllocator</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Handle</span> <span class="token function">newHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HandleImpl</span><span class="token punctuation">(</span>minIndex<span class="token punctuation">,</span> maxIndex<span class="token punctuation">,</span> initial<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HandleImpl</span> <span class="token keyword">extends</span> <span class="token class-name">MaxMessageHandle</span> <span class="token punctuation">{</span>
        <span class="token comment">//æœ€å°å®¹é‡åœ¨æ‰©ç¼©å®¹ç´¢å¼•è¡¨ä¸­çš„index</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> minIndex<span class="token punctuation">;</span>
        <span class="token comment">//æœ€å¤§å®¹é‡åœ¨æ‰©ç¼©å®¹ç´¢å¼•è¡¨ä¸­çš„index</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> maxIndex<span class="token punctuation">;</span>
        <span class="token comment">//å½“å‰å®¹é‡åœ¨æ‰©ç¼©å®¹ç´¢å¼•è¡¨ä¸­çš„index åˆå§‹33 å¯¹åº”å®¹é‡2048</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> index<span class="token punctuation">;</span>
        <span class="token comment">//é¢„è®¡ä¸‹ä¸€æ¬¡åˆ†é…bufferçš„å®¹é‡ï¼Œåˆå§‹ï¼š2048</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> nextReceiveBufferSize<span class="token punctuation">;</span>
        <span class="token comment">//æ˜¯å¦ç¼©å®¹</span>
        <span class="token keyword">private</span> <span class="token keyword">boolean</span> decreaseNow<span class="token punctuation">;</span>

        <span class="token class-name">HandleImpl</span><span class="token punctuation">(</span><span class="token keyword">int</span> minIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> maxIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> initial<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>minIndex <span class="token operator">=</span> minIndex<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>maxIndex <span class="token operator">=</span> maxIndex<span class="token punctuation">;</span>

            <span class="token comment">//åœ¨æ‰©ç¼©å®¹ç´¢å¼•è¡¨ä¸­äºŒåˆ†æŸ¥æ‰¾åˆ°æœ€å°å¤§äºç­‰äºinitial çš„å®¹é‡</span>
            index <span class="token operator">=</span> <span class="token function">getSizeTableIndex</span><span class="token punctuation">(</span>initial<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//2048</span>
            nextReceiveBufferSize <span class="token operator">=</span> <span class="token constant">SIZE_TABLE</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>è¿™é‡Œæˆ‘ä»¬çœ‹åˆ° Netty ä¸­ç”¨äºåŠ¨æ€è°ƒæ•´ ByteBuffer å®¹é‡çš„<code>allocHandle</code>çš„å®é™…ç±»å‹ä¸º<code>MaxMessageHandle</code>ã€‚</p> <p>ä¸‹é¢æˆ‘ä»¬æ¥ä»‹ç»ä¸‹<code>HandleImpl</code>ä¸­çš„æ ¸å¿ƒå­—æ®µï¼Œå®ƒä»¬éƒ½å’Œ ByteBuffer çš„å®¹é‡æœ‰å…³ï¼š</p> <ul><li><code>minIndex</code> ï¼šæœ€å°å®¹é‡åœ¨æ‰©ç¼©å®¹ç´¢å¼•è¡¨<code>SIZE_TABE</code>ä¸­çš„ indexã€‚é»˜è®¤æ˜¯<code>3</code>ã€‚</li> <li><code>maxIndex</code> ï¼šæœ€å¤§å®¹é‡åœ¨æ‰©ç¼©å®¹ç´¢å¼•è¡¨<code>SIZE_TABE</code>ä¸­çš„ indexã€‚é»˜è®¤æ˜¯<code>38</code>ã€‚</li> <li><code>index</code> ï¼šå½“å‰å®¹é‡åœ¨æ‰©ç¼©å®¹ç´¢å¼•è¡¨<code>SIZE_TABE</code>ä¸­çš„ indexã€‚åˆå§‹æ˜¯<code>33</code>ã€‚</li> <li><code>nextReceiveBufferSize</code> ï¼šé¢„è®¡ä¸‹ä¸€æ¬¡åˆ†é… buffer çš„å®¹é‡ï¼Œåˆå§‹ä¸º<code>2048</code>ã€‚åœ¨æ¯æ¬¡ç”³è¯·å†…å­˜åˆ†é… ByteBuffer çš„æ—¶å€™ï¼Œé‡‡ç”¨<code>nextReceiveBufferSize</code>çš„å€¼æŒ‡å®šå®¹é‡ã€‚</li> <li><code>decreaseNow ï¼š</code> æ˜¯å¦éœ€è¦è¿›è¡Œç¼©å®¹ã€‚</li></ul> <h2 id="_5-ä½¿ç”¨å †å¤–å†…å­˜ä¸º-bytebuffer-åˆ†é…å†…å­˜"><a href="#_5-ä½¿ç”¨å †å¤–å†…å­˜ä¸º-bytebuffer-åˆ†é…å†…å­˜" class="header-anchor">#</a> 5. ä½¿ç”¨å †å¤–å†…å­˜ä¸º ByteBuffer åˆ†é…å†…å­˜</h2> <p>AdaptiveRecvByteBufAllocator ç±»åªæ˜¯è´Ÿè´£åŠ¨æ€è°ƒæ•´ ByteBuffer çš„å®¹é‡ï¼Œè€Œå…·ä½“ä¸º ByteBuffer ç”³è¯·å†…å­˜ç©ºé—´çš„æ˜¯ç”±<code>PooledByteBufAllocator</code>è´Ÿè´£ã€‚</p> <h3 id="_5-1-ç±»åå‰ç¼€-pooled-çš„æ¥å†"><a href="#_5-1-ç±»åå‰ç¼€-pooled-çš„æ¥å†" class="header-anchor">#</a> 5.1 ç±»åå‰ç¼€ Pooled çš„æ¥å†</h3> <p>åœ¨æˆ‘ä»¬ä½¿ç”¨ Java è¿›è¡Œæ—¥å¸¸å¼€å‘è¿‡ç¨‹ä¸­ï¼Œåœ¨ä¸ºå¯¹è±¡åˆ†é…å†…å­˜ç©ºé—´çš„æ—¶å€™æˆ‘ä»¬éƒ½ä¼šé€‰æ‹©åœ¨ JVM å †ä¸­ä¸ºå¯¹è±¡åˆ†é…å†…å­˜ï¼Œè¿™æ ·åšå¯¹æˆ‘ä»¬ Java å¼€å‘è€…ç‰¹åˆ«çš„å‹å¥½ï¼Œæˆ‘ä»¬åªç®¡ä½¿ç”¨å°±å¥½è€Œä¸å¿…è¿‡å¤šå…³å¿ƒè¿™å—ç”³è¯·çš„å†…å­˜å¦‚ä½•å›æ”¶ï¼Œå› ä¸º JVM å †å®Œå…¨å— Java è™šæ‹Ÿæœºæ§åˆ¶ç®¡ç†ï¼ŒJava è™šæ‹Ÿæœºä¼šå¸®åŠ©æˆ‘ä»¬å›æ”¶ä¸å†ä½¿ç”¨çš„å†…å­˜ã€‚</p> <p>ä½†æ˜¯ JVM åœ¨è¿›è¡Œåƒåœ¾å›æ”¶æ—¶å€™çš„ <code>stop the world</code> ä¼šå¯¹æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„æ€§èƒ½é€ æˆä¸€å®šçš„å½±å“</p> <p>é™¤æ­¤ä¹‹å¤–æˆ‘ä»¬åœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247483737&amp;idx=1&amp;sn=7ef3afbb54289c6e839eed724bb8a9d6&amp;chksm=ce77c71ef9004e08e3d164561e3a2708fc210c05408fa41f7fe338d8e85f39c1ad57519b614e&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€ŠèŠèŠ Netty é‚£äº›äº‹å„¿ä¹‹ä»å†…æ ¸è§’åº¦çœ‹ IO æ¨¡å‹ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸€æ–‡ä¸­ä»‹ç» IO æ¨¡å‹çš„æ—¶å€™æåˆ°ï¼Œå½“æ•°æ®è¾¾åˆ°ç½‘å¡æ—¶ï¼Œç½‘å¡ä¼šé€šè¿‡ DMA çš„æ–¹å¼å°†æ•°æ®æ‹·è´åˆ°å†…æ ¸ç©ºé—´ä¸­ï¼Œè¿™æ˜¯<code>ç¬¬ä¸€æ¬¡æ‹·è´</code>ã€‚å½“ç”¨æˆ·çº¿ç¨‹åœ¨ç”¨æˆ·ç©ºé—´å‘èµ·ç³»ç»Ÿ IO è°ƒç”¨æ—¶ï¼ŒCPU ä¼šå°†å†…æ ¸ç©ºé—´çš„æ•°æ®å†æ¬¡æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ã€‚è¿™æ˜¯<code>ç¬¬äºŒæ¬¡æ‹·è´</code>ã€‚</p> <p>äºæ­¤ä¸åŒçš„æ˜¯å½“æˆ‘ä»¬åœ¨ JVM ä¸­å‘èµ· IO è°ƒç”¨æ—¶ï¼Œæ¯”å¦‚æˆ‘ä»¬ä½¿ç”¨ JVM å †å†…å­˜è¯»å– <code>Socketæ¥æ”¶ç¼“å†²åŒº</code> ä¸­çš„æ•°æ®æ—¶ï¼Œ<strong>ä¼šå¤šä¸€æ¬¡å†…å­˜æ‹·è´</strong>ï¼ŒCPU åœ¨<code>ç¬¬äºŒæ¬¡æ‹·è´</code>ä¸­å°†æ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´æ—¶ï¼Œæ­¤æ—¶çš„ç”¨æˆ·ç©ºé—´ç«™åœ¨ JVM è§’åº¦æ˜¯<code>å †å¤–å†…å­˜</code>ï¼Œæ‰€ä»¥è¿˜éœ€è¦å°†å †å¤–å†…å­˜ä¸­çš„æ•°æ®æ‹·è´åˆ° <code>å †å†…å†…å­˜</code> ä¸­ã€‚è¿™å°±æ˜¯ <code>ç¬¬ä¸‰æ¬¡å†…å­˜æ‹·è´</code></p> <p>åŒç†å½“æˆ‘ä»¬åœ¨ JVM ä¸­å‘èµ· IO è°ƒç”¨å‘<code>Socketå‘é€ç¼“å†²åŒº</code>å†™å…¥æ•°æ®æ—¶ï¼ŒJVM ä¼šå°† IO æ•°æ®å…ˆ<code>æ‹·è´</code>åˆ°<code>å †å¤–å†…å­˜</code>ï¼Œç„¶åæ‰èƒ½å‘èµ·ç³»ç»Ÿ IO è°ƒç”¨ã€‚</p> <p><strong>é‚£ä¸ºä»€ä¹ˆæ“ä½œç³»ç»Ÿä¸ç›´æ¥ä½¿ç”¨ JVM çš„<code>å †å†…å†…å­˜</code>è¿›è¡Œ<code>IOæ“ä½œ</code>å‘¢ï¼Ÿ</strong></p> <p>å› ä¸º JVM çš„å†…å­˜å¸ƒå±€å’Œæ“ä½œç³»ç»Ÿåˆ†é…çš„å†…å­˜æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ“ä½œç³»ç»Ÿä¸å¯èƒ½æŒ‰ç…§ JVM è§„èŒƒæ¥è¯»å†™æ•°æ®ï¼Œæ‰€ä»¥å°±éœ€è¦ <code>ç¬¬ä¸‰æ¬¡æ‹·è´</code> ä¸­é—´åšä¸ªè½¬æ¢å°†å †å¤–å†…å­˜ä¸­çš„æ•°æ®æ‹·è´åˆ° JVM å †ä¸­ã€‚</p> <hr> <p>æ‰€ä»¥åŸºäºä¸Šè¿°å†…å®¹ï¼Œåœ¨ä½¿ç”¨ JVM å †å†…å†…å­˜æ—¶ä¼šäº§ç”Ÿä»¥ä¸‹ä¸¤ç‚¹æ€§èƒ½å½±å“ï¼š</p> <ol><li>JVM åœ¨åƒåœ¾å›æ”¶å †å†…å†…å­˜æ—¶ï¼Œä¼šå‘ç”Ÿ <code>stop the world</code> å¯¼è‡´åº”ç”¨ç¨‹åºå¡é¡¿ã€‚</li> <li>åœ¨è¿›è¡Œ IO æ“ä½œçš„æ—¶å€™ï¼Œä¼šå¤šäº§ç”Ÿä¸€æ¬¡ç”±å †å¤–å†…å­˜åˆ°å †å†…å†…å­˜çš„æ‹·è´ã€‚</li></ol> <p><strong>åŸºäºä»¥ä¸Šä¸¤ç‚¹ä½¿ç”¨<code>JVMå †å†…å†…å­˜</code>å¯¹æ€§èƒ½é€ æˆçš„å½±å“</strong>ï¼Œäºæ˜¯å¯¹æ€§èƒ½æœ‰å“è¶Šè¿½æ±‚çš„ Netty é‡‡ç”¨<code>å †å¤–å†…å­˜</code>ä¹Ÿå°±æ˜¯<code>DirectBuffer</code>æ¥ä¸º ByteBuffer åˆ†é…å†…å­˜ç©ºé—´ã€‚</p> <p>é‡‡ç”¨å †å¤–å†…å­˜ä¸º ByteBuffer åˆ†é…å†…å­˜çš„å¥½å¤„å°±æ˜¯ï¼š</p> <ul><li>å †å¤–å†…å­˜ç›´æ¥å—æ“ä½œç³»ç»Ÿçš„ç®¡ç†ï¼Œä¸ä¼šå— JVM çš„ç®¡ç†ï¼Œæ‰€ä»¥ JVM åƒåœ¾å›æ”¶å¯¹åº”ç”¨ç¨‹åºçš„æ€§èƒ½å½±å“å°±æ²¡æœ‰äº†ã€‚</li> <li>ç½‘ç»œæ•°æ®åˆ°è¾¾ä¹‹åç›´æ¥åœ¨<code>å †å¤–å†…å­˜</code>ä¸Šæ¥æ”¶ï¼Œè¿›ç¨‹è¯»å–ç½‘ç»œæ•°æ®æ—¶ç›´æ¥åœ¨å †å¤–å†…å­˜ä¸­è¯»å–ï¼Œæ‰€ä»¥å°±é¿å…äº†<code>ç¬¬ä¸‰æ¬¡å†…å­˜æ‹·è´</code>ã€‚</li></ul> <p>æ‰€ä»¥ Netty åœ¨è¿›è¡Œ I/O æ“ä½œæ—¶éƒ½æ˜¯ä½¿ç”¨çš„å †å¤–å†…å­˜ï¼Œå¯ä»¥é¿å…æ•°æ®ä» JVM å †å†…å­˜åˆ°å †å¤–å†…å­˜çš„æ‹·è´ã€‚ä½†æ˜¯ç”±äºå †å¤–å†…å­˜ä¸å— JVM çš„ç®¡ç†ï¼Œæ‰€ä»¥å°±éœ€è¦é¢å¤–å…³æ³¨å¯¹å†…å­˜çš„ä½¿ç”¨å’Œé‡Šæ”¾ï¼Œç¨æœ‰ä¸æ…å°±ä¼šé€ æˆå†…å­˜æ³„éœ²ï¼Œäºæ˜¯ Netty å°±å¼•å…¥äº†<strong>å†…å­˜æ± </strong>å¯¹<code>å †å¤–å†…å­˜</code>è¿›è¡Œç»Ÿä¸€ç®¡ç†ã€‚</p> <p><strong>PooledByteBufAllocator ç±»çš„è¿™ä¸ªå‰ç¼€<code>Pooled</code>å°±æ˜¯<code>å†…å­˜æ± </code>çš„æ„æ€ï¼Œè¿™ä¸ªç±»ä¼šä½¿ç”¨ Netty çš„å†…å­˜æ± ä¸º ByteBuffer åˆ†é…<code>å †å¤–å†…å­˜</code>ã€‚</strong></p> <h3 id="_5-2-pooledbytebufallocator-çš„åˆ›å»º"><a href="#_5-2-pooledbytebufallocator-çš„åˆ›å»º" class="header-anchor">#</a> 5.2 PooledByteBufAllocator çš„åˆ›å»º</h3> <h4 id="åˆ›å»ºæ—¶æœº"><a href="#åˆ›å»ºæ—¶æœº" class="header-anchor">#</a> åˆ›å»ºæ—¶æœº</h4> <p>åœ¨æœåŠ¡ç«¯ NioServerSocketChannel çš„é…ç½®ç±» NioServerSocketChannelConfig ä»¥åŠå®¢æˆ·ç«¯ NioSocketChannel çš„é…ç½®ç±» NioSocketChannelConfig<strong>å®ä¾‹åŒ–çš„æ—¶å€™ä¼šè§¦å‘</strong>PooledByteBufAllocator çš„åˆ›å»ºã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultChannelConfig</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelConfig</span> <span class="token punctuation">{</span>
    <span class="token comment">//PooledByteBufAllocator</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">ByteBufAllocator</span> allocator <span class="token operator">=</span> <span class="token class-name">ByteBufAllocator</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åˆ›å»ºå‡ºæ¥çš„ PooledByteBufAllocator å®ä¾‹ä¿å­˜åœ¨<code>DefaultChannelConfigç±»</code>ä¸­çš„<code>ByteBufAllocator allocator</code>å­—æ®µä¸­ã€‚</p> <h4 id="åˆ›å»ºè¿‡ç¨‹"><a href="#åˆ›å»ºè¿‡ç¨‹" class="header-anchor">#</a> åˆ›å»ºè¿‡ç¨‹</h4> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ByteBufAllocator</span> <span class="token punctuation">{</span>

    <span class="token class-name">ByteBufAllocator</span> <span class="token constant">DEFAULT</span> <span class="token operator">=</span> <span class="token class-name">ByteBufUtil</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_ALLOCATOR</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ByteBufUtil</span> <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ByteBufAllocator</span> <span class="token constant">DEFAULT_ALLOCATOR</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> allocType <span class="token operator">=</span> <span class="token class-name">SystemPropertyUtil</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
                <span class="token string">&quot;io.netty.allocator.type&quot;</span><span class="token punctuation">,</span> <span class="token class-name">PlatformDependent</span><span class="token punctuation">.</span><span class="token function">isAndroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&quot;unpooled&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;pooled&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        allocType <span class="token operator">=</span> allocType<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span><span class="token constant">US</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ByteBufAllocator</span> alloc<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;unpooled&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>allocType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            alloc <span class="token operator">=</span> <span class="token class-name">UnpooledByteBufAllocator</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;-Dio.netty.allocator.type: {}&quot;</span><span class="token punctuation">,</span> allocType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;pooled&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>allocType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            alloc <span class="token operator">=</span> <span class="token class-name">PooledByteBufAllocator</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;-Dio.netty.allocator.type: {}&quot;</span><span class="token punctuation">,</span> allocType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            alloc <span class="token operator">=</span> <span class="token class-name">PooledByteBufAllocator</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;-Dio.netty.allocator.type: pooled (unknown: {})&quot;</span><span class="token punctuation">,</span> allocType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token constant">DEFAULT_ALLOCATOR</span> <span class="token operator">=</span> alloc<span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä» ByteBufUtil ç±»çš„åˆå§‹åŒ–è¿‡ç¨‹æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œåœ¨ä¸º ByteBuffer åˆ†é…å†…å­˜çš„æ—¶å€™æ˜¯å¦ä½¿ç”¨å†…å­˜æ± åœ¨ Netty ä¸­æ˜¯å¯ä»¥é…ç½®çš„ã€‚</p> <ul><li>é€šè¿‡ç³»ç»Ÿå˜é‡<code>-D io.netty.allocator.type</code> å¯ä»¥é…ç½®æ˜¯å¦ä½¿ç”¨å†…å­˜æ± ä¸º ByteBuffer åˆ†é…å†…å­˜ã€‚é»˜è®¤æƒ…å†µä¸‹æ˜¯éœ€è¦ä½¿ç”¨å†…å­˜æ± çš„ã€‚ä½†æ˜¯åœ¨å®‰å“ç³»ç»Ÿä¸­é»˜è®¤æ˜¯ä¸ä½¿ç”¨å†…å­˜æ± çš„ã€‚</li> <li>é€šè¿‡<code>PooledByteBufAllocator.DEFAULT</code>è·å–<strong>å†…å­˜æ±  ByteBuffer åˆ†é…å™¨</strong>ã€‚</li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">PooledByteBufAllocator</span> <span class="token constant">DEFAULT</span> <span class="token operator">=</span>
    <span class="token keyword">new</span> <span class="token class-name">PooledByteBufAllocator</span><span class="token punctuation">(</span><span class="token class-name">PlatformDependent</span><span class="token punctuation">.</span><span class="token function">directBufferPreferred</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>ç”±äºæœ¬æ–‡çš„ä¸»çº¿æ˜¯ä»‹ç» Sub Reactor å¤„ç†<code>OP_READäº‹ä»¶</code>çš„å®Œæ•´è¿‡ç¨‹ï¼Œæ‰€ä»¥è¿™é‡Œåªä»‹ç»ä¸»çº¿ç›¸å…³çš„å†…å®¹ï¼Œè¿™é‡Œåªæ˜¯ç®€å•ä»‹ç»ä¸‹åœ¨æ¥æ”¶æ•°æ®çš„æ—¶å€™ä¸ºä»€ä¹ˆä¼šç”¨<code>PooledByteBufAllocator</code>æ¥ä¸º<code>ByteBuffer</code>åˆ†é…å†…å­˜ã€‚è€Œå†…å­˜æ± çš„æ¶æ„è®¾è®¡æ¯”è¾ƒå¤æ‚ï¼Œæ‰€ä»¥ç¬”è€…åé¢ä¼šå•ç‹¬å†™ä¸€ç¯‡å…³äº Netty å†…å­˜ç®¡ç†çš„æ–‡ç« ã€‚</p></blockquote> <hr> <h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="header-anchor">#</a> æ€»ç»“</h2> <p>æœ¬æ–‡ä»‹ç»äº† Sub Reactor çº¿ç¨‹åœ¨å¤„ç† OP_READ äº‹ä»¶çš„æ•´ä¸ªè¿‡ç¨‹ã€‚å¹¶æ·±å…¥å‰–æäº† AdaptiveRecvByteBufAllocator ç±»åŠ¨æ€è°ƒæ•´ ByteBuffer å®¹é‡çš„åŸç†ã€‚</p> <p>åŒæ—¶ä¹Ÿä»‹ç»äº† Netty ä¸ºä»€ä¹ˆä¼šä½¿ç”¨å †å¤–å†…å­˜æ¥ä¸º ByteBuffer åˆ†é…å†…å­˜ï¼Œå¹¶ç”±æ­¤å¼•å‡ºäº† Netty çš„å†…å­˜æ± åˆ†é…å™¨ PooledByteBufAllocator ã€‚</p> <p>åœ¨ä»‹ç» AdaptiveRecvByteBufAllocator ç±»å’Œ PooledByteBufAllocator ä¸€èµ·ç»„åˆå®ç°åŠ¨æ€åœ°ä¸º ByteBuffer åˆ†é…å®¹é‡çš„æ—¶å€™ï¼Œç¬”è€…ä¸ç¦æƒ³èµ·äº†å¤šå¹´å‰çœ‹è¿‡çš„ã€ŠEffective Javaã€‹ä¸­ç¬¬ 16 æ¡ <code>å¤åˆä¼˜å…ˆäºç»§æ‰¿</code>ã€‚</p> <p>Netty åœ¨è¿™é‡Œä¹Ÿéµå¾ªäº†è¿™æ¡å†›è§„ï¼Œé¦–å…ˆä¸¤ä¸ªç±»è®¾è®¡çš„éƒ½æ˜¯å•ä¸€çš„åŠŸèƒ½ã€‚</p> <ul><li>AdaptiveRecvByteBufAllocator ç±»åªè´Ÿè´£åŠ¨æ€çš„è°ƒæ•´ ByteBuffer å®¹é‡ï¼Œå¹¶ä¸ç®¡å…·ä½“çš„å†…å­˜åˆ†é…ã€‚</li> <li>PooledByteBufAllocator ç±»è´Ÿè´£å…·ä½“çš„å†…å­˜åˆ†é…ï¼Œç”¨å†…å­˜æ± çš„æ–¹å¼ã€‚</li></ul> <p>è¿™æ ·è®¾è®¡çš„å°±æ¯”è¾ƒçµæ´»ï¼Œå…·ä½“å†…å­˜åˆ†é…çš„å·¥ä½œäº¤ç»™å…·ä½“çš„<code>ByteBufAllocator</code>,å¯ä»¥ä½¿ç”¨å†…å­˜æ± çš„åˆ†é…æ–¹å¼<code>PooledByteBufAllocator</code>ï¼Œä¹Ÿå¯ä»¥ä¸ä½¿ç”¨å†…å­˜æ± çš„åˆ†é…æ–¹å¼<code>UnpooledByteBufAllocator</code>ã€‚å…·ä½“çš„å†…å­˜å¯ä»¥é‡‡ç”¨ JVM å †å†…å†…å­˜ï¼ˆHeapBufferï¼‰ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å †å¤–å†…å­˜ï¼ˆDirectBufferï¼‰ã€‚</p> <p>è€Œ<code>AdaptiveRecvByteBufAllocator</code>åªéœ€è¦å…³æ³¨è°ƒæ•´å®ƒä»¬çš„å®¹é‡å·¥ä½œå°±å¯ä»¥äº†ï¼Œè€Œå¹¶ä¸éœ€è¦å…³æ³¨å®ƒä»¬å…·ä½“çš„å†…å­˜åˆ†é…æ–¹å¼ã€‚</p> <p>æœ€åé€šè¿‡<code>io.netty.channel.RecvByteBufAllocator.Handle#allocate</code>æ–¹æ³•çµæ´»ç»„åˆä¸åŒçš„å†…å­˜åˆ†é…æ–¹å¼ã€‚è¿™ä¹Ÿæ˜¯<code>è£…é¥°æ¨¡å¼</code>çš„ä¸€ç§åº”ç”¨ã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code>byteBuf <span class="token operator">=</span> allocHandle<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>allocator<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>å¥½äº†ï¼Œä»Šå¤©çš„å†…å®¹å°±åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ä¸‹ç¯‡æ–‡ç« è§~~~~</p> <h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="header-anchor">#</a> å‚è€ƒèµ„æ–™</h2> <p><a href="https://mp.weixin.qq.com/s/KhpNjA8vDQSBipoDMILvOQ" target="_blank" rel="noopener noreferrer">Netty å¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œæ•°æ®ï¼Ÿä¸€æ–‡èŠé€ ByteBuffer åŠ¨æ€è‡ªé€‚åº”æ‰©ç¼©å®¹æœºåˆ¶ (qq.com)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/echo-lxy/echo-system-design/edit/master/docs/Netty ç³»ç»Ÿè®¾è®¡/25.å››ã€æ·±å…¥ Netty æ ¸å¿ƒ/18.ç¬¬äº”è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œæ•°æ®.md" target="_blank" rel="noopener noreferrer">ç¼–è¾‘</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°äº:</span> <span class="time">2024/09/19, 09:39:02</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        â†
        <a href="/pages/be98dc/" class="prev">ç¬¬å››è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œè¿æ¥</a></span> <span class="next"><a href="/pages/a73206/">ç¬¬å…­è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆå‘é€ç½‘ç»œæ•°æ®</a>â†’
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:lixinyang2002@163.com" title="å‘é‚®ä»¶" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/echo-lxy" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="å¬éŸ³ä¹" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="æœ¬ç«™ä¸»é¢˜">Vdoing</a> 
    | Copyright Â© 2024-2024
    <span>Xinyang Li | MIT License</span></div> <div class="buttons"><div title="è¿”å›é¡¶éƒ¨" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="å»è¯„è®º" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ä¸»é¢˜æ¨¡å¼" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          è·Ÿéšç³»ç»Ÿ
        </li><li class="iconfont icon-rijianmoshi">
          æµ…è‰²æ¨¡å¼
        </li><li class="iconfont icon-yejianmoshi">
          æ·±è‰²æ¨¡å¼
        </li><li class="iconfont icon-yuedu">
          é˜…è¯»æ¨¡å¼
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.a0e02413.js" defer></script><script src="/assets/js/2.933750c6.js" defer></script><script src="/assets/js/55.2b9fbb7f.js" defer></script><script src="/assets/js/7.7eb70372.js" defer></script>
  </body>
</html>
