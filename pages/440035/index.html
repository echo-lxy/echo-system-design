<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ç¬¬äºŒè¯¾ï¼šReactoråœ¨ Netty ä¸­çš„å®ç°ï¼ˆåˆ›å»ºç¯‡ï¼‰ | EchoDesign</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="ç³»ç»Ÿè®¾è®¡ä¹‹ã€Œè®²è§£ + é¢è¯•æŒ‡å—ã€ï¼Œæ°´æ»´çŸ³ç©¿ï¼Œè®¾è®¡æ— é“¶å¼¹ï¼">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.c76c3453.css" as="style"><link rel="preload" href="/assets/js/app.bdcc6820.js" as="script"><link rel="preload" href="/assets/js/2.933750c6.js" as="script"><link rel="preload" href="/assets/js/52.24cc5c91.js" as="script"><link rel="preload" href="/assets/js/7.7eb70372.js" as="script"><link rel="prefetch" href="/assets/js/10.2cc95be8.js"><link rel="prefetch" href="/assets/js/100.152e23f6.js"><link rel="prefetch" href="/assets/js/101.99b73fec.js"><link rel="prefetch" href="/assets/js/11.c7521a10.js"><link rel="prefetch" href="/assets/js/12.38d1989d.js"><link rel="prefetch" href="/assets/js/13.850793b0.js"><link rel="prefetch" href="/assets/js/14.1141ec27.js"><link rel="prefetch" href="/assets/js/15.8f1b4081.js"><link rel="prefetch" href="/assets/js/16.e52ba8b4.js"><link rel="prefetch" href="/assets/js/17.acb3bf3d.js"><link rel="prefetch" href="/assets/js/18.5df2a013.js"><link rel="prefetch" href="/assets/js/19.571eaed1.js"><link rel="prefetch" href="/assets/js/20.fe7d08c7.js"><link rel="prefetch" href="/assets/js/21.0e0ed140.js"><link rel="prefetch" href="/assets/js/22.dd779f94.js"><link rel="prefetch" href="/assets/js/23.4d814163.js"><link rel="prefetch" href="/assets/js/24.e94253bb.js"><link rel="prefetch" href="/assets/js/25.1d172890.js"><link rel="prefetch" href="/assets/js/26.6337eac0.js"><link rel="prefetch" href="/assets/js/27.eeee1d20.js"><link rel="prefetch" href="/assets/js/28.6fa848cf.js"><link rel="prefetch" href="/assets/js/29.4ff6fa35.js"><link rel="prefetch" href="/assets/js/3.08ee786a.js"><link rel="prefetch" href="/assets/js/30.892b2994.js"><link rel="prefetch" href="/assets/js/31.df4cc39d.js"><link rel="prefetch" href="/assets/js/32.f1174703.js"><link rel="prefetch" href="/assets/js/33.64ab8d0c.js"><link rel="prefetch" href="/assets/js/34.405ab364.js"><link rel="prefetch" href="/assets/js/35.8287c9dc.js"><link rel="prefetch" href="/assets/js/36.be98cc35.js"><link rel="prefetch" href="/assets/js/37.82be3556.js"><link rel="prefetch" href="/assets/js/38.40fe2658.js"><link rel="prefetch" href="/assets/js/39.6e2f31a6.js"><link rel="prefetch" href="/assets/js/4.73518a0f.js"><link rel="prefetch" href="/assets/js/40.0ada49bd.js"><link rel="prefetch" href="/assets/js/41.fcee3e0f.js"><link rel="prefetch" href="/assets/js/42.f5fdb401.js"><link rel="prefetch" href="/assets/js/43.5a509601.js"><link rel="prefetch" href="/assets/js/44.64fd3383.js"><link rel="prefetch" href="/assets/js/45.685623ac.js"><link rel="prefetch" href="/assets/js/46.7624d38c.js"><link rel="prefetch" href="/assets/js/47.cc86aae6.js"><link rel="prefetch" href="/assets/js/48.ba7dfd47.js"><link rel="prefetch" href="/assets/js/49.15d8e916.js"><link rel="prefetch" href="/assets/js/5.94727770.js"><link rel="prefetch" href="/assets/js/50.b424b2c0.js"><link rel="prefetch" href="/assets/js/51.ef213b56.js"><link rel="prefetch" href="/assets/js/53.16def11d.js"><link rel="prefetch" href="/assets/js/54.8604fc24.js"><link rel="prefetch" href="/assets/js/55.78a9171b.js"><link rel="prefetch" href="/assets/js/56.94e28708.js"><link rel="prefetch" href="/assets/js/57.9f8a974b.js"><link rel="prefetch" href="/assets/js/58.24008d78.js"><link rel="prefetch" href="/assets/js/59.28ca51b4.js"><link rel="prefetch" href="/assets/js/6.0b558b79.js"><link rel="prefetch" href="/assets/js/60.1714dba8.js"><link rel="prefetch" href="/assets/js/61.08b4acf0.js"><link rel="prefetch" href="/assets/js/62.cc8fdced.js"><link rel="prefetch" href="/assets/js/63.41ff19e4.js"><link rel="prefetch" href="/assets/js/64.9b3def35.js"><link rel="prefetch" href="/assets/js/65.0b2ab47d.js"><link rel="prefetch" href="/assets/js/66.2ae7a107.js"><link rel="prefetch" href="/assets/js/67.79dd6daf.js"><link rel="prefetch" href="/assets/js/68.c27f5109.js"><link rel="prefetch" href="/assets/js/69.5f61d937.js"><link rel="prefetch" href="/assets/js/70.b920a5f7.js"><link rel="prefetch" href="/assets/js/71.f44644ed.js"><link rel="prefetch" href="/assets/js/72.9a370df8.js"><link rel="prefetch" href="/assets/js/73.bc16a468.js"><link rel="prefetch" href="/assets/js/74.d9ad1a67.js"><link rel="prefetch" href="/assets/js/75.7c86d41a.js"><link rel="prefetch" href="/assets/js/76.15a7bb60.js"><link rel="prefetch" href="/assets/js/77.c89b4964.js"><link rel="prefetch" href="/assets/js/78.c0a4ffae.js"><link rel="prefetch" href="/assets/js/79.0906d2fb.js"><link rel="prefetch" href="/assets/js/8.0ec7f6e8.js"><link rel="prefetch" href="/assets/js/80.fdcb5fa1.js"><link rel="prefetch" href="/assets/js/81.711911b1.js"><link rel="prefetch" href="/assets/js/82.e54c087e.js"><link rel="prefetch" href="/assets/js/83.65db62ac.js"><link rel="prefetch" href="/assets/js/84.e5207e82.js"><link rel="prefetch" href="/assets/js/85.4cd3a775.js"><link rel="prefetch" href="/assets/js/86.931cbb70.js"><link rel="prefetch" href="/assets/js/87.47ba635a.js"><link rel="prefetch" href="/assets/js/88.93192130.js"><link rel="prefetch" href="/assets/js/89.e05e3a70.js"><link rel="prefetch" href="/assets/js/9.6e274fca.js"><link rel="prefetch" href="/assets/js/90.ca1ff100.js"><link rel="prefetch" href="/assets/js/91.8ad18b18.js"><link rel="prefetch" href="/assets/js/92.ec3a28ed.js"><link rel="prefetch" href="/assets/js/93.f8975bc4.js"><link rel="prefetch" href="/assets/js/94.1eade7f0.js"><link rel="prefetch" href="/assets/js/95.96f5db04.js"><link rel="prefetch" href="/assets/js/96.5ed2d348.js"><link rel="prefetch" href="/assets/js/97.4d4bfff5.js"><link rel="prefetch" href="/assets/js/98.18f62eb7.js"><link rel="prefetch" href="/assets/js/99.7d84cc97.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c76c3453.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="ç›®å½•" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="EchoDesign" class="logo"> <span class="site-name can-hide">EchoDesign</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">ğŸ é¦–é¡µ</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">âœ’ï¸çƒ­é—¨ç®—æ³•</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ğŸ–ï¸èµæç»å…¸è®¾è®¡" class="dropdown-title"><!----> <span class="title" style="display:;">ğŸ–ï¸èµæç»å…¸è®¾è®¡</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ç³»ç»Ÿè®¾è®¡</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ğŸ§‘â€ğŸ’»å®æˆ˜ç³»ç»Ÿè®¾è®¡</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">â“é—®ç­”</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ğŸ‘€åŠ¨æ€</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">ğŸ é¦–é¡µ</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">âœ’ï¸çƒ­é—¨ç®—æ³•</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ğŸ–ï¸èµæç»å…¸è®¾è®¡" class="dropdown-title"><!----> <span class="title" style="display:;">ğŸ–ï¸èµæç»å…¸è®¾è®¡</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ç³»ç»Ÿè®¾è®¡</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ğŸ§‘â€ğŸ’»å®æˆ˜ç³»ç»Ÿè®¾è®¡</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">â“é—®ç­”</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ğŸ‘€åŠ¨æ€</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ä¸€ã€å‰è¨€</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>äºŒã€åŸºç¡€çŸ¥è¯†</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ä¸‰ã€ä¸»çº¿ä»»åŠ¡</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>å››ã€æ·±å…¥ Netty æ ¸å¿ƒ</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/65674f/" class="sidebar-link">ç¬¬ä¸€è¯¾ï¼šé€è¿‡ Netty çœ‹ IO æ¨¡å‹</a></li><li><a href="/pages/440035/" aria-current="page" class="active sidebar-link">ç¬¬äºŒè¯¾ï¼šReactoråœ¨ Netty ä¸­çš„å®ç°ï¼ˆåˆ›å»ºç¯‡ï¼‰</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/440035/#å‰è¨€" class="sidebar-link">å‰è¨€</a></li><li class="sidebar-sub-header level2"><a href="/pages/440035/#netty-å¯¹-io-æ¨¡å‹çš„æ”¯æŒ" class="sidebar-link">Netty å¯¹ IO æ¨¡å‹çš„æ”¯æŒ</a></li><li class="sidebar-sub-header level2"><a href="/pages/440035/#åˆ›å»ºä¸»ä»reactorçº¿ç¨‹ç»„" class="sidebar-link">åˆ›å»ºä¸»ä»Reactorçº¿ç¨‹ç»„</a></li><li class="sidebar-sub-header level2"><a href="/pages/440035/#æ€»ç»“" class="sidebar-link">æ€»ç»“</a></li><li class="sidebar-sub-header level2"><a href="/pages/440035/#å‚è€ƒèµ„æ–™" class="sidebar-link">å‚è€ƒèµ„æ–™</a></li></ul></li><li><a href="/pages/bb668a/" class="sidebar-link">ç¬¬ä¸‰è¯¾ï¼šNetty æ ¸å¿ƒå¼•æ“ Reactor çš„è¿è½¬æ¶æ„</a></li><li><a href="/pages/be98dc/" class="sidebar-link">ç¬¬å››è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œè¿æ¥</a></li><li><a href="/pages/0938c1/" class="sidebar-link">ç¬¬äº”è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œæ•°æ®</a></li><li><a href="/pages/8ed7b8/" class="sidebar-link">ç¬¬å…­è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆå‘é€ç½‘ç»œæ•°æ®</a></li><li><a href="/pages/a1b0fe/" class="sidebar-link">ç¬¬ä¸ƒè¯¾ï¼šNetty ä¸­IOäº‹ä»¶çš„è§¦å‘æ—¶æœºå’Œä¼ æ’­æµç¨‹</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>äº”ã€æ·±å…¥ Netty å†…å­˜ç®¡ç†</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="é¦–é¡µ" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>Netty ç³»ç»Ÿè®¾è®¡</span></li><li data-v-06225672><span data-v-06225672>å››ã€æ·±å…¥ Netty æ ¸å¿ƒ</span></li></ul> <div class="info" data-v-06225672><div title="ä½œè€…" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/brother-one" target="_blank" title="ä½œè€…" class="beLink" data-v-06225672>echo</a></div> <div title="åˆ›å»ºæ—¶é—´" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-09-19</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">ç›®å½•</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">ç¬¬äºŒè¯¾ï¼šReactoråœ¨ Netty ä¸­çš„å®ç°ï¼ˆåˆ›å»ºç¯‡ï¼‰<!----></h1> <div class="page-slot page-slot-top">
    <div class="wwads-cn wwads-horizontal page-wwads" data-id="136"></div>
    <style>
      .page-wwads{
        width:100%!important;
        min-height: 0;
        margin: 0;
      }
      .page-wwads .wwads-img img{
        width:80px!important;
      }
      .page-wwads .wwads-poweredby{
        width: 40px;
        position: absolute;
        right: 25px;
        bottom: 3px;
      }
      .wwads-content .wwads-text, .page-wwads .wwads-text{
        height: 100%;
        padding-top: 5px;
        display: block;
      }
  </style>
  </div> <div class="theme-vdoing-content content__default"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="header-anchor">#</a> å‰è¨€</h2> <p>åœ¨ä¸Šç¯‡æ–‡ç« <a href="/pages/647c06/">ã€Šé€è¿‡ Netty çœ‹ IO æ¨¡å‹ã€‹</a>ä¸­æˆ‘ä»¬èŠ±äº†å¤§é‡çš„ç¯‡å¹…æ¥ä»å†…æ ¸è§’åº¦è¯¦ç»†è®²è¿°äº†äº”ç§<code>IOæ¨¡å‹</code>çš„æ¼”è¿›è¿‡ç¨‹ä»¥åŠ<code>ReactorIOçº¿ç¨‹æ¨¡å‹</code>çš„åº•å±‚åŸºçŸ³IOå¤šè·¯å¤ç”¨æŠ€æœ¯åœ¨å†…æ ¸ä¸­çš„å®ç°åŸç†ã€‚</p> <p>æœ€åæˆ‘ä»¬å¼•å‡ºäº†nettyä¸­ä½¿ç”¨çš„ä¸»ä»Reactor IOçº¿ç¨‹æ¨¡å‹ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409190956559.png" alt="å›¾ç‰‡"></p> <p>é€šè¿‡ä¸Šç¯‡æ–‡ç« çš„ä»‹ç»ï¼Œæˆ‘ä»¬å·²ç»æ¸…æ¥šäº†åœ¨IOè°ƒç”¨çš„è¿‡ç¨‹ä¸­å†…æ ¸å¸®æˆ‘ä»¬æäº†å“ªäº›äº‹æƒ…ï¼Œé‚£ä¹ˆä¿—è¯è¯´çš„å¥½<code>å†…æ ¸é¢†è¿›é—¨ï¼Œä¿®è¡Œåœ¨netty</code>ï¼Œnettyåœ¨ç”¨æˆ·ç©ºé—´åˆå¸®æˆ‘ä»¬æäº†å“ªäº›äº‹æƒ…?</p> <p>é‚£ä¹ˆä»æœ¬æ–‡å¼€å§‹ï¼Œç¬”è€…å°†ä»æºç è§’åº¦æ¥å¸¦å¤§å®¶çœ‹ä¸‹ä¸Šå›¾ä¸­çš„<code>Reactor IOçº¿ç¨‹æ¨¡å‹</code>åœ¨Nettyä¸­æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p> <p>æœ¬æ–‡ä½œä¸ºReactoråœ¨Nettyä¸­å®ç°ç³»åˆ—æ–‡ç« ä¸­çš„å¼€ç¯‡æ–‡ç« ï¼Œç¬”è€…å…ˆæ¥ä¸ºå¤§å®¶ä»‹ç»Reactorçš„éª¨æ¶æ˜¯å¦‚ä½•åˆ›å»ºå‡ºæ¥çš„ã€‚</p> <p>åœ¨ä¸Šç¯‡æ–‡ç« ä¸­æˆ‘ä»¬æåˆ°Nettyé‡‡ç”¨çš„æ˜¯<code>ä¸»ä»Reactorå¤šçº¿ç¨‹</code>çš„æ¨¡å‹ï¼Œä½†æ˜¯å®ƒåœ¨å®ç°ä¸Šåˆä¸<strong>Doug Lea</strong>åœ¨Scalable IO in Javaè®ºæ–‡ä¸­æåˆ°çš„ç»å…¸<code>ä¸»ä»Reactorå¤šçº¿ç¨‹æ¨¡å‹</code>æœ‰æ‰€å·®å¼‚ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409190958640.png" alt="å›¾ç‰‡"></p> <p>Nettyä¸­çš„<code>Reactor</code>æ˜¯ä»¥<code>Group</code>çš„å½¢å¼å‡ºç°çš„ï¼Œ<code>ä¸»ä»Reactor</code>åœ¨Nettyä¸­å°±æ˜¯<code>ä¸»ä»Reactorç»„</code>ï¼Œæ¯ä¸ª<code>Reactor Group</code>ä¸­ä¼šæœ‰å¤šä¸ª<code>Reactor</code>ç”¨æ¥æ‰§è¡Œå…·ä½“çš„<code>IOä»»åŠ¡</code>ã€‚å½“ç„¶åœ¨nettyä¸­<code>Reactor</code>ä¸åªç”¨æ¥æ‰§è¡Œ<code>IOä»»åŠ¡</code>ï¼Œè¿™ä¸ªæˆ‘ä»¬åé¢å†è¯´ã€‚</p> <ul><li><code>Main Reactor Group</code>ä¸­çš„<code>Reactor</code>æ•°é‡å–å†³äºæœåŠ¡ç«¯è¦ç›‘å¬çš„ç«¯å£ä¸ªæ•°ï¼Œé€šå¸¸æˆ‘ä»¬çš„æœåŠ¡ç«¯ç¨‹åºåªä¼šç›‘å¬ä¸€ä¸ªç«¯å£ï¼Œæ‰€ä»¥<code>Main Reactor Group</code>åªä¼šæœ‰ä¸€ä¸ª<code>Main Reactor</code>çº¿ç¨‹æ¥å¤„ç†æœ€é‡è¦çš„äº‹æƒ…ï¼š<code>ç»‘å®šç«¯å£åœ°å€</code>ï¼Œ<code>æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥</code>ï¼Œ<code>ä¸ºå®¢æˆ·ç«¯åˆ›å»ºå¯¹åº”çš„SocketChannel</code>ï¼Œ<code>å°†å®¢æˆ·ç«¯SocketChannelåˆ†é…ç»™ä¸€ä¸ªå›ºå®šçš„Sub Reactor</code>ã€‚ä¹Ÿå°±æ˜¯ä¸Šç¯‡æ–‡ç« ç¬”è€…ä¸ºå¤§å®¶ä¸¾çš„ä¾‹å­ï¼Œé¥­åº—æœ€é‡è¦çš„å·¥ä½œå°±æ˜¯å…ˆæŠŠå®¢äººè¿æ¥è¿›æ¥ã€‚<strong>â€œæˆ‘å®¶å¤§é—¨å¸¸æ‰“å¼€ï¼Œå¼€æ”¾æ€€æŠ±ç­‰ä½ ï¼Œæ‹¥æŠ±è¿‡å°±æœ‰äº†é»˜å¥‘ä½ ä¼šçˆ±ä¸Šè¿™é‡Œ......â€</strong></li> <li><code>Sub Reactor Group</code>é‡Œæœ‰å¤šä¸ª<code>Reactor</code>çº¿ç¨‹ï¼Œ<code>Reactor</code>çº¿ç¨‹çš„ä¸ªæ•°å¯ä»¥é€šè¿‡ç³»ç»Ÿå‚æ•°<code>-D io.netty.eventLoopThreads</code>æŒ‡å®šã€‚é»˜è®¤çš„<code>Reactor</code>çš„ä¸ªæ•°ä¸º<code>CPUæ ¸æ•° * 2</code>ã€‚<code>Sub Reactor</code>çº¿ç¨‹ä¸»è¦ç”¨æ¥<code>è½®è¯¢å®¢æˆ·ç«¯SocketChannelä¸Šçš„IOå°±ç»ªäº‹ä»¶</code>ï¼Œ<code>å¤„ç†IOå°±ç»ªäº‹ä»¶</code>ï¼Œ<code>æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡</code>ã€‚<code>Sub Reactor Group</code>åšçš„äº‹æƒ…å°±æ˜¯ä¸Šç¯‡é¥­åº—ä¾‹å­ä¸­æœåŠ¡å‘˜çš„å·¥ä½œï¼Œå®¢äººè¿›æ¥äº†è¦ä¸ºå®¢äººåˆ†é…åº§ä½ï¼Œç«¯èŒ¶é€æ°´ï¼Œåšèœä¸Šèœã€‚<strong>â€œä¸ç®¡è¿œè¿‘éƒ½æ˜¯å®¢äººï¼Œè¯·ä¸ç”¨å®¢æ°”ï¼Œç›¸çº¦å¥½äº†åœ¨ä¸€èµ·ï¼Œæˆ‘ä»¬æ¬¢è¿æ‚¨......â€</strong></li></ul> <blockquote><p>ä¸€ä¸ª<code>å®¢æˆ·ç«¯SocketChannel</code>åªèƒ½åˆ†é…ç»™ä¸€ä¸ªå›ºå®šçš„<code>Sub Reactor</code>ã€‚ä¸€ä¸ª<code>Sub Reactor</code>è´Ÿè´£å¤„ç†å¤šä¸ª<code>å®¢æˆ·ç«¯SocketChannel</code>ï¼Œè¿™æ ·å¯ä»¥å°†æœåŠ¡ç«¯æ‰¿è½½çš„<code>å…¨é‡å®¢æˆ·ç«¯è¿æ¥</code>åˆ†æ‘Šåˆ°å¤šä¸ª<code>Sub Reactor</code>ä¸­å¤„ç†ï¼ŒåŒæ—¶ä¹Ÿèƒ½ä¿è¯<code>å®¢æˆ·ç«¯SocketChannelä¸Šçš„IOå¤„ç†çš„çº¿ç¨‹å®‰å…¨æ€§</code>ã€‚</p></blockquote> <p>ç”±äºæ–‡ç« ç¯‡å¹…çš„å…³ç³»ï¼Œä½œä¸ºReactoråœ¨nettyä¸­å®ç°çš„ç¬¬ä¸€ç¯‡æˆ‘ä»¬ä¸»è¦æ¥ä»‹ç»<code>ä¸»ä»Reactor Group</code>çš„åˆ›å»ºæµç¨‹ï¼Œéª¨æ¶è„‰ç»œå…ˆæ­å¥½ã€‚</p> <p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€æ®µNettyæœåŠ¡ç«¯ä»£ç çš„ç¼–å†™æ¨¡æ¿ï¼Œä»ä»£ç æ¨¡æ¿çš„æµç¨‹ä¸­æˆ‘ä»¬æ¥è§£æä¸‹ä¸»ä»Reactorçš„åˆ›å»ºæµç¨‹ä»¥åŠåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ‰€æ¶‰åŠåˆ°çš„Nettyæ ¸å¿ƒç±»ã€‚</p> <h3 id="netty-æœåŠ¡ç«¯ä»£ç æ¨¡æ¿"><a href="#netty-æœåŠ¡ç«¯ä»£ç æ¨¡æ¿" class="header-anchor">#</a> Netty æœåŠ¡ç«¯ä»£ç æ¨¡æ¿</h3> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * Echoes back any received data from a client.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">EchoServer</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">PORT</span> <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;port&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;8007&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// Configure the server.</span>
        <span class="token comment">//åˆ›å»ºä¸»ä»Reactorçº¿ç¨‹ç»„</span>
        <span class="token class-name">EventLoopGroup</span> bossGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EventLoopGroup</span> workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">EchoServerHandler</span> serverHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EchoServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span><span class="token comment">//é…ç½®ä¸»ä»Reactor</span>
             <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token comment">//é…ç½®ä¸»Reactorä¸­çš„channelç±»å‹</span>
             <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_BACKLOG</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token comment">//è®¾ç½®ä¸»Reactorä¸­channelçš„optioné€‰é¡¹</span>
             <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoggingHandler</span><span class="token punctuation">(</span><span class="token class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">INFO</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//è®¾ç½®ä¸»Reactorä¸­Channel-&gt;pipline-&gt;handler</span>
             <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//è®¾ç½®ä»Reactorä¸­æ³¨å†Œchannelçš„pipeline</span>
                 <span class="token annotation punctuation">@Override</span>
                 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                     <span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token comment">//p.addLast(new LoggingHandler(LogLevel.INFO));</span>
                     p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>serverHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token punctuation">}</span>
             <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Start the server. ç»‘å®šç«¯å£å¯åŠ¨æœåŠ¡ï¼Œå¼€å§‹ç›‘å¬acceptäº‹ä»¶</span>
            <span class="token class-name">ChannelFuture</span> f <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Wait until the server socket is closed.</span>
            f<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// Shut down all event loops to terminate all threads.</span>
            bossGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            workerGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li><p>é¦–å…ˆæˆ‘ä»¬è¦åˆ›å»ºNettyæœ€æ ¸å¿ƒçš„éƒ¨åˆ† -&gt; <code>åˆ›å»ºä¸»ä»Reactor Group</code>ï¼Œåœ¨Nettyä¸­<code>EventLoopGroup</code>å°±æ˜¯<code>Reactor Group</code>çš„å®ç°ç±»ã€‚å¯¹åº”çš„<code>EventLoop</code>å°±æ˜¯<code>Reactor</code>çš„å®ç°ç±»ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code>  <span class="token comment">//åˆ›å»ºä¸»ä»Reactorçº¿ç¨‹ç»„</span>
  <span class="token class-name">EventLoopGroup</span> bossGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">EventLoopGroup</span> workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>åˆ›å»ºç”¨äº<code>IOå¤„ç†</code>çš„<code>ChannelHandler</code>ï¼Œå®ç°ç›¸åº”<code>IOäº‹ä»¶</code>çš„å›è°ƒå‡½æ•°ï¼Œç¼–å†™å¯¹åº”çš„<code>IOå¤„ç†</code>é€»è¾‘ã€‚æ³¨æ„è¿™é‡Œåªæ˜¯ç®€å•ç¤ºä¾‹å“ˆï¼Œè¯¦ç»†çš„IOäº‹ä»¶å¤„ç†ï¼Œç¬”è€…ä¼šå•ç‹¬å¼€ä¸€ç¯‡æ–‡ç« ä¸“é—¨è®²è¿°ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">EchoServerHandler</span> serverHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EchoServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Handler implementation for the echo server.
 */</span>
<span class="token annotation punctuation">@Sharable</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token constant">IO</span>å¤„ç†é€»è¾‘<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        ctx<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelReadComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
        ctx<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exceptionCaught</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Close the connection when an exception is raised.</span>
        cause<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>åˆ›å»º<code>ServerBootstrap</code>NettyæœåŠ¡ç«¯å¯åŠ¨ç±»ï¼Œå¹¶åœ¨å¯åŠ¨ç±»ä¸­é…ç½®å¯åŠ¨NettyæœåŠ¡ç«¯æ‰€éœ€è¦çš„ä¸€äº›å¿…å¤‡ä¿¡æ¯ã€‚</p> <blockquote><p>åœ¨ä¸Šç¯‡æ–‡ç« ä»‹ç»<code>Socketå†…æ ¸ç»“æ„</code>å°èŠ‚ä¸­æˆ‘ä»¬æåˆ°ï¼Œåœ¨ç¼–å†™æœåŠ¡ç«¯ç½‘ç»œç¨‹åºæ—¶ï¼Œæˆ‘ä»¬é¦–å…ˆè¦åˆ›å»ºä¸€ä¸ª<code>Socket</code>ç”¨äº<code>listenå’Œbind</code>ç«¯å£åœ°å€ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªå«åš<code>ç›‘å¬Socket</code>,è¿™é‡Œå¯¹åº”çš„å°±æ˜¯<code>NioServerSocketChannel.class</code>ã€‚å½“å®¢æˆ·ç«¯è¿æ¥å®Œæˆä¸‰æ¬¡æ¡æ‰‹ï¼Œç³»ç»Ÿè°ƒç”¨<code>accept</code>å‡½æ•°ä¼šåŸºäº<code>ç›‘å¬Socket</code>åˆ›å»ºå‡ºæ¥ä¸€ä¸ª<code>æ–°çš„Socket</code>ä¸“é—¨ç”¨äºä¸å®¢æˆ·ç«¯ä¹‹é—´çš„ç½‘ç»œé€šä¿¡æˆ‘ä»¬ç§°ä¸º<code>å®¢æˆ·ç«¯è¿æ¥Socket</code>,è¿™é‡Œå¯¹åº”çš„å°±æ˜¯<code>NioSocketChannel.class</code></p></blockquote> <blockquote><p>nettyæœ‰ä¸¤ç§<code>Channelç±»å‹</code>ï¼šä¸€ç§æ˜¯æœåŠ¡ç«¯ç”¨äºç›‘å¬ç»‘å®šç«¯å£åœ°å€çš„<code>NioServerSocketChannel</code>,ä¸€ç§æ˜¯ç”¨äºå®¢æˆ·ç«¯é€šä¿¡çš„<code>NioSocketChannel</code>ã€‚æ¯ç§<code>Channelç±»å‹å®ä¾‹</code>éƒ½ä¼šå¯¹åº”ä¸€ä¸ª<code>PipeLine</code>ç”¨äºç¼–æ’<code>å¯¹åº”channelå®ä¾‹</code>ä¸Šçš„IOäº‹ä»¶å¤„ç†é€»è¾‘ã€‚<code>PipeLine</code>ä¸­ç»„ç»‡çš„å°±æ˜¯<code>ChannelHandler</code>ç”¨äºç¼–å†™ç‰¹å®šçš„IOå¤„ç†é€»è¾‘ã€‚</p></blockquote> <blockquote><p><strong>æ³¨æ„</strong><code>serverBootstrap.handler</code>è®¾ç½®çš„æ˜¯æœåŠ¡ç«¯<code>NioServerSocketChannel PipeLine</code>ä¸­çš„<code>ChannelHandler</code>ã€‚</p></blockquote> <blockquote><p><code>ServerBootstrap</code>å¯åŠ¨ç±»æ–¹æ³•å¸¦æœ‰<code>child</code>å‰ç¼€çš„å‡æ˜¯è®¾ç½®å®¢æˆ·ç«¯<code>NioSocketChannel</code>å±æ€§çš„ã€‚</p></blockquote> <blockquote><p><code>ChannelInitializer</code>æ˜¯ç”¨äºå½“<code>SocketChannel</code>æˆåŠŸæ³¨å†Œåˆ°ç»‘å®šçš„<code>Reactor</code>ä¸Šåï¼Œç”¨äºåˆå§‹åŒ–è¯¥<code>SocketChannel</code>çš„<code>Pipeline</code>ã€‚å®ƒçš„<code>initChannel</code>æ–¹æ³•ä¼šåœ¨æ³¨å†ŒæˆåŠŸåæ‰§è¡Œã€‚è¿™é‡Œåªæ˜¯æå¸¦æä¸€ä¸‹ï¼Œè®©å¤§å®¶æœ‰ä¸ªåˆæ­¥å°è±¡ï¼Œåé¢æˆ‘ä¼šä¸“é—¨ä»‹ç»ã€‚</p></blockquote> <ul><li><code>serverBootstrap.childHandler(ChannelHandler childHandler)</code>ç”¨äºè®¾ç½®å®¢æˆ·ç«¯<code>NioSocketChannel</code>ä¸­å¯¹åº”<code>Pipieline</code>ä¸­çš„<code>ChannelHandler</code>ã€‚æˆ‘ä»¬é€šå¸¸é…ç½®çš„ç¼–ç è§£ç å™¨å°±æ˜¯åœ¨è¿™é‡Œã€‚</li> <li><code>serverBootstrap.option(ChannelOption.SO_BACKLOG, 100)</code>è®¾ç½®æœåŠ¡ç«¯<code>ServerSocketChannel</code>ä¸­çš„<code>SocketOption</code>ã€‚å…³äº<code>SocketOption</code>çš„é€‰é¡¹æˆ‘ä»¬åè¾¹çš„æ–‡ç« å†èŠï¼Œæœ¬æ–‡ä¸»è¦èšç„¦åœ¨Netty <code>Main Reactor Group</code>çš„åˆ›å»ºåŠå·¥ä½œæµç¨‹ã€‚</li> <li><code>serverBootstrap.handler(....)</code>è®¾ç½®æœåŠ¡ç«¯<code>NioServerSocketChannel</code>ä¸­å¯¹åº”<code>Pipieline</code>ä¸­çš„<code>ChannelHandler</code>ã€‚</li> <li>é€šè¿‡<code>serverBootstrap.group(bossGroup, workerGroup)</code>ä¸ºNettyæœåŠ¡ç«¯é…ç½®<code>ä¸»ä»Reactor Group</code>å®ä¾‹ã€‚</li> <li>é€šè¿‡<code>serverBootstrap.channel(NioServerSocketChannel.class)</code>é…ç½®NettyæœåŠ¡ç«¯çš„<code>ServerSocketChannel</code>ç”¨äº<code>ç»‘å®šç«¯å£åœ°å€</code>ä»¥åŠ<code>åˆ›å»ºå®¢æˆ·ç«¯SocketChannel</code>ã€‚Nettyä¸­çš„<code>NioServerSocketChannel.class</code>å°±æ˜¯å¯¹JDK NIOä¸­<code>ServerSocketChannel</code>çš„å°è£…ã€‚è€Œç”¨äºè¡¨ç¤º<code>å®¢æˆ·ç«¯è¿æ¥</code>çš„<code>NioSocketChannel</code>æ˜¯å¯¹JDK NIO <code>SocketChannel</code>å°è£…ã€‚</li></ul></li> <li><p><code>ChannelFuture f = serverBootstrap.bind(PORT).sync()</code>è¿™ä¸€æ­¥ä¼šæ˜¯ä¸‹ç¯‡æ–‡ç« è¦é‡ç‚¹åˆ†æçš„ä¸»é¢˜<code>Main Reactor Group</code>çš„å¯åŠ¨ï¼Œç»‘å®šç«¯å£åœ°å€ï¼Œå¼€å§‹ç›‘å¬å®¢æˆ·ç«¯è¿æ¥äº‹ä»¶ï¼ˆ<code>OP_ACCEPT</code>ï¼‰ã€‚æœ¬æ–‡æˆ‘ä»¬åªå…³æ³¨åˆ›å»ºæµç¨‹</p></li> <li><p><code>f.channel().closeFuture().sync()</code>ç­‰å¾…æœåŠ¡ç«¯<code>NioServerSocketChannel</code>å…³é—­ã€‚NettyæœåŠ¡ç«¯åˆ°è¿™é‡Œæ­£å¼å¯åŠ¨ï¼Œå¹¶å‡†å¤‡å¥½æ¥å—å®¢æˆ·ç«¯è¿æ¥çš„å‡†å¤‡ã€‚</p></li> <li><p><code>shutdownGracefully</code>ä¼˜é›…å…³é—­<code>ä¸»ä»Reactorçº¿ç¨‹ç»„</code>é‡Œçš„æ‰€æœ‰<code>Reactorçº¿ç¨‹</code>ã€‚</p></li></ol> <h2 id="netty-å¯¹-io-æ¨¡å‹çš„æ”¯æŒ"><a href="#netty-å¯¹-io-æ¨¡å‹çš„æ”¯æŒ" class="header-anchor">#</a> Netty å¯¹ IO æ¨¡å‹çš„æ”¯æŒ</h2> <p>åœ¨ä¸Šç¯‡æ–‡ç« ä¸­æˆ‘ä»¬ä»‹ç»äº†äº”ç§<code>IOæ¨¡å‹</code>ï¼ŒNettyä¸­æ”¯æŒ<code>BIO</code>,<code>NIO</code>,<code>AIO</code>ä»¥åŠå¤šç§æ“ä½œç³»ç»Ÿä¸‹çš„<code>IOå¤šè·¯å¤ç”¨æŠ€æœ¯</code>å®ç°ã€‚</p> <p>åœ¨Nettyä¸­åˆ‡æ¢è¿™å‡ ç§<code>IOæ¨¡å‹</code>ä¹Ÿæ˜¯éå¸¸çš„æ–¹ä¾¿ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹Nettyå¦‚ä½•å¯¹è¿™å‡ ç§IOæ¨¡å‹è¿›è¡Œæ”¯æŒçš„ã€‚</p> <p>é¦–å…ˆæˆ‘ä»¬ä»‹ç»ä¸‹å‡ ä¸ªä¸<code>IOæ¨¡å‹</code>ç›¸å…³çš„é‡è¦æ¥å£ï¼š</p> <h3 id="eventloop"><a href="#eventloop" class="header-anchor">#</a> EventLoop</h3> <p><code>EventLoop</code>å°±æ˜¯Nettyä¸­çš„<code>Reactor</code>ï¼Œå¯ä»¥è¯´å®ƒå°±æ˜¯Nettyçš„å¼•æ“ï¼Œè´Ÿè´£Channelä¸Š<code>IOå°±ç»ªäº‹ä»¶çš„ç›‘å¬</code>ï¼Œ<code>IOå°±ç»ªäº‹ä»¶çš„å¤„ç†</code>ï¼Œ<code>å¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œ</code>é©±åŠ¨ç€æ•´ä¸ªNettyçš„è¿è½¬ã€‚</p> <p>ä¸åŒ<code>IOæ¨¡å‹</code>ä¸‹ï¼Œ<code>EventLoop</code>æœ‰ç€ä¸åŒçš„å®ç°ï¼Œæˆ‘ä»¬åªéœ€è¦åˆ‡æ¢ä¸åŒçš„å®ç°ç±»å°±å¯ä»¥å®Œæˆå¯¹Netty<code>IOæ¨¡å‹</code>çš„åˆ‡æ¢ã€‚</p> <table><thead><tr><th style="text-align:center;">BIO</th> <th style="text-align:center;">NIO</th> <th style="text-align:center;">AIO</th></tr></thead> <tbody><tr><td style="text-align:center;">ThreadPerChannelEventLoop</td> <td style="text-align:center;">NioEventLoop</td> <td style="text-align:center;">AioEventLoop</td></tr></tbody></table> <p>åœ¨<code>NIOæ¨¡å‹</code>ä¸‹Nettyä¼š<code>è‡ªåŠ¨</code>æ ¹æ®æ“ä½œç³»ç»Ÿä»¥åŠç‰ˆæœ¬çš„ä¸åŒé€‰æ‹©å¯¹åº”çš„<code>IOå¤šè·¯å¤ç”¨æŠ€æœ¯å®ç°</code>ã€‚æ¯”å¦‚Linux 2.6ç‰ˆæœ¬ä»¥ä¸Šç”¨çš„æ˜¯<code>Epoll</code>ï¼Œ2.6ç‰ˆæœ¬ä»¥ä¸‹ç”¨çš„æ˜¯<code>Poll</code>ï¼ŒMacä¸‹é‡‡ç”¨çš„æ˜¯<code>Kqueue</code>ã€‚</p> <h3 id="eventloopgroup"><a href="#eventloopgroup" class="header-anchor">#</a> EventLoopGroup</h3> <p>Nettyä¸­çš„<code>Reactor</code>æ˜¯ä»¥<code>Group</code>çš„å½¢å¼å‡ºç°çš„ï¼Œ<code>EventLoopGroup</code>æ­£æ˜¯<code>Reactorç»„</code>çš„æ¥å£å®šä¹‰ï¼Œè´Ÿè´£ç®¡ç†<code>Reactor</code>ï¼ŒNettyä¸­çš„<code>Channel</code>å°±æ˜¯é€šè¿‡<code>EventLoopGroup</code>æ³¨å†Œåˆ°å…·ä½“çš„<code>Reactor</code>ä¸Šçš„ã€‚</p> <p>Nettyçš„IOçº¿ç¨‹æ¨¡å‹æ˜¯<code>ä¸»ä»Reactorå¤šçº¿ç¨‹æ¨¡å‹</code>ï¼Œ<code>ä¸»ä»Reactorçº¿ç¨‹ç»„</code>åœ¨Nettyæºç ä¸­å¯¹åº”çš„å…¶å®å°±æ˜¯ä¸¤ä¸ª<code>EventLoopGroup</code>å®ä¾‹ã€‚</p> <p>ä¸åŒçš„<code>IOæ¨¡å‹</code>ä¹Ÿæœ‰å¯¹åº”çš„å®ç°ï¼š</p> <table><thead><tr><th style="text-align:center;">BIO</th> <th style="text-align:center;">NIO</th> <th style="text-align:center;">AIO</th></tr></thead> <tbody><tr><td style="text-align:center;">ThreadPerChannelEventLoopGroup</td> <td style="text-align:center;">NioEventLoopGroup</td> <td style="text-align:center;">AioEventLoopGroup</td></tr></tbody></table> <h3 id="serversocketchannel"><a href="#serversocketchannel" class="header-anchor">#</a> ServerSocketChannel</h3> <p>ç”¨äºNettyæœåŠ¡ç«¯ä½¿ç”¨çš„<code>ServerSocketChannel</code>ï¼Œå¯¹åº”äºä¸Šç¯‡æ–‡ç« æåˆ°çš„<code>ç›‘å¬Socket</code>ï¼Œè´Ÿè´£ç»‘å®šç›‘å¬ç«¯å£åœ°å€ï¼Œæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥å¹¶åˆ›å»ºç”¨äºä¸å®¢æˆ·ç«¯é€šä¿¡çš„<code>SocketChannel</code>ã€‚</p> <p>ä¸åŒçš„<code>IOæ¨¡å‹</code>ä¸‹çš„å®ç°ï¼š</p> <table><thead><tr><th style="text-align:center;">BIO</th> <th style="text-align:center;">NIO</th> <th style="text-align:center;">AIO</th></tr></thead> <tbody><tr><td style="text-align:center;">OioServerSocketChannel</td> <td style="text-align:center;">NioServerSocketChannel</td> <td style="text-align:center;">AioServerSocketChannel</td></tr></tbody></table> <h3 id="socketchannel"><a href="#socketchannel" class="header-anchor">#</a> SocketChannel</h3> <p>ç”¨äºä¸å®¢æˆ·ç«¯é€šä¿¡çš„<code>SocketChannel</code>ï¼Œå¯¹åº”äºä¸Šç¯‡æ–‡ç« æåˆ°çš„<code>å®¢æˆ·ç«¯è¿æ¥Socket</code>ï¼Œå½“å®¢æˆ·ç«¯å®Œæˆä¸‰æ¬¡æ¡æ‰‹åï¼Œç”±ç³»ç»Ÿè°ƒç”¨<code>accept</code>å‡½æ•°æ ¹æ®<code>ç›‘å¬Socket</code>åˆ›å»ºã€‚</p> <p>ä¸åŒçš„<code>IOæ¨¡å‹</code>ä¸‹çš„å®ç°ï¼š</p> <table><thead><tr><th style="text-align:center;">BIO</th> <th style="text-align:center;">NIO</th> <th style="text-align:center;">AIO</th></tr></thead> <tbody><tr><td style="text-align:center;">OioSocketChannel</td> <td style="text-align:center;">NioSocketChannel</td> <td style="text-align:center;">AioSocketChannel</td></tr></tbody></table> <p>æˆ‘ä»¬çœ‹åˆ°åœ¨<code>ä¸åŒIOæ¨¡å‹</code>çš„å®ç°ä¸­ï¼ŒNettyè¿™äº›å›´ç»•<code>IOæ¨¡å‹</code>çš„æ ¸å¿ƒç±»åªæ˜¯å‰ç¼€çš„ä¸åŒï¼š</p> <ul><li>BIOå¯¹åº”çš„å‰ç¼€ä¸º<code>Oio</code>ï¼Œè¡¨ç¤º<code>old io</code>ï¼Œç°åœ¨å·²ç»åºŸå¼ƒä¸æ¨èä½¿ç”¨ã€‚</li> <li>NIOå¯¹åº”çš„å‰ç¼€ä¸º<code>Nio</code>ï¼Œæ­£æ˜¯Nettyæ¨èä¹Ÿæ˜¯æˆ‘ä»¬å¸¸ç”¨çš„<code>éé˜»å¡IOæ¨¡å‹</code>ã€‚</li> <li>AIOå¯¹åº”çš„å‰ç¼€ä¸º<code>Aio</code>ï¼Œç”±äºLinuxä¸‹çš„<code>å¼‚æ­¥IO</code>æœºåˆ¶å®ç°çš„å¹¶ä¸æˆç†Ÿï¼Œæ€§èƒ½æå‡è¡¨ç°ä¸Šä¹Ÿä¸æ˜æ˜¾ï¼Œç°å·²è¢«åˆ é™¤ã€‚</li></ul> <p>æˆ‘ä»¬åªéœ€è¦å°†<code>IOæ¨¡å‹</code>çš„è¿™äº›æ ¸å¿ƒæ¥å£å¯¹åº”çš„å®ç°ç±»<code>å‰ç¼€</code>æ”¹ä¸ºå¯¹åº”<code>IOæ¨¡å‹</code>çš„å‰ç¼€ï¼Œå°±å¯ä»¥è½»æ¾åœ¨Nettyä¸­å®Œæˆå¯¹<code>IOæ¨¡å‹</code>çš„åˆ‡æ¢ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191007627.png" alt="å›¾ç‰‡"></p> <h3 id="å¤šç§nioçš„å®ç°"><a href="#å¤šç§nioçš„å®ç°" class="header-anchor">#</a> å¤šç§NIOçš„å®ç°</h3> <table><thead><tr><th style="text-align:center;">Common</th> <th style="text-align:center;">Linux</th> <th style="text-align:center;">Mac</th></tr></thead> <tbody><tr><td style="text-align:center;">NioEventLoopGroup</td> <td style="text-align:center;">EpollEventLoopGroup</td> <td style="text-align:center;">KQueueEventLoopGroup</td></tr> <tr><td style="text-align:center;">NioEventLoop</td> <td style="text-align:center;">EpollEventLoop</td> <td style="text-align:center;">KQueueEventLoop</td></tr> <tr><td style="text-align:center;">NioServerSocketChannel</td> <td style="text-align:center;">EpollServerSocketChannel</td> <td style="text-align:center;">KQueueServerSocketChannel</td></tr> <tr><td style="text-align:center;">NioSocketChannel</td> <td style="text-align:center;">EpollSocketChannel</td> <td style="text-align:center;">KQueueSocketChannel</td></tr></tbody></table> <p>æˆ‘ä»¬é€šå¸¸åœ¨ä½¿ç”¨<code>NIOæ¨¡å‹</code>çš„æ—¶å€™ä¼šä½¿ç”¨<code>Commonåˆ—</code>ä¸‹çš„è¿™äº›<code>IOæ¨¡å‹</code>æ ¸å¿ƒç±»ï¼Œ<code>Commonç±»</code>ä¹Ÿä¼šæ ¹æ®æ“ä½œç³»ç»Ÿçš„ä¸åŒè‡ªåŠ¨é€‰æ‹©<code>JDK</code>åœ¨å¯¹åº”å¹³å°ä¸‹çš„<code>IOå¤šè·¯å¤ç”¨æŠ€æœ¯</code>çš„å®ç°ã€‚</p> <p>è€ŒNettyè‡ªèº«ä¹Ÿæ ¹æ®æ“ä½œç³»ç»Ÿçš„ä¸åŒæä¾›äº†è‡ªå·±å¯¹<code>IOå¤šè·¯å¤ç”¨æŠ€æœ¯</code>çš„å®ç°ï¼Œæ¯”<code>JDK</code>çš„å®ç°æ€§èƒ½æ›´ä¼˜ã€‚æ¯”å¦‚ï¼š</p> <ul><li><code>JDK</code>çš„ NIO <code>é»˜è®¤</code>å®ç°æ˜¯<code>æ°´å¹³è§¦å‘</code>ï¼ŒNetty æ˜¯<code>è¾¹ç¼˜è§¦å‘(é»˜è®¤)</code>å’Œæ°´å¹³è§¦å‘å¯åˆ‡æ¢ã€‚ã€‚</li> <li>Netty å®ç°çš„åƒåœ¾å›æ”¶æ›´å°‘ã€æ€§èƒ½æ›´å¥½ã€‚</li></ul> <p>æˆ‘ä»¬ç¼–å†™NettyæœåŠ¡ç«¯ç¨‹åºçš„æ—¶å€™ä¹Ÿå¯ä»¥æ ¹æ®æ“ä½œç³»ç»Ÿçš„ä¸åŒï¼Œé‡‡ç”¨Nettyè‡ªèº«çš„å®ç°æ¥è¿›ä¸€æ­¥ä¼˜åŒ–ç¨‹åºã€‚åšæ³•ä¹Ÿå¾ˆç®€å•ï¼Œç›´æ¥å°†ä¸Šå›¾ä¸­çº¢æ¡†é‡Œçš„å®ç°ç±»æ›¿æ¢æˆNettyçš„è‡ªèº«å®ç°ç±»å³å¯å®Œæˆåˆ‡æ¢ã€‚</p> <hr> <p>ç»è¿‡ä»¥ä¸Šå¯¹NettyæœåŠ¡ç«¯ä»£ç ç¼–å†™æ¨¡æ¿ä»¥åŠ<code>IOæ¨¡å‹</code>ç›¸å…³æ ¸å¿ƒç±»çš„ç®€å•ä»‹ç»ï¼Œæˆ‘ä»¬å¯¹Nettyçš„åˆ›å»ºæµç¨‹æœ‰äº†ä¸€ä¸ªç®€å•ç²—ç•¥çš„æ€»ä½“è®¤è¯†ï¼Œä¸‹é¢æˆ‘ä»¬æ¥æ·±å…¥å‰–æä¸‹åˆ›å»ºæµç¨‹è¿‡ç¨‹ä¸­çš„æ¯ä¸€ä¸ªæ­¥éª¤ä»¥åŠè¿™ä¸ªè¿‡ç¨‹ä¸­æ¶‰åŠåˆ°çš„æ ¸å¿ƒç±»å®ç°ã€‚</p> <p><strong>ä»¥ä¸‹æºç è§£æéƒ¨åˆ†æˆ‘ä»¬å‡é‡‡ç”¨<code>Commonåˆ—</code>ä¸‹<code>NIO</code>ç›¸å…³çš„å®ç°è¿›è¡Œè§£æã€‚</strong></p> <h2 id="åˆ›å»ºä¸»ä»reactorçº¿ç¨‹ç»„"><a href="#åˆ›å»ºä¸»ä»reactorçº¿ç¨‹ç»„" class="header-anchor">#</a> åˆ›å»ºä¸»ä»Reactorçº¿ç¨‹ç»„</h2> <p>åœ¨ Netty æœåŠ¡ç«¯ç¨‹åºç¼–å†™æ¨¡æ¿çš„å¼€å§‹ï¼Œæˆ‘ä»¬é¦–å…ˆä¼šåˆ›å»ºä¸¤ä¸ªReactorçº¿ç¨‹ç»„ï¼š</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191009527.png" alt="å›¾ç‰‡"></p> <ul><li>ä¸€ä¸ªæ˜¯ä¸»Reactorçº¿ç¨‹ç»„<code>bossGroup</code>ç”¨äºç›‘å¬å®¢æˆ·ç«¯è¿æ¥ï¼Œåˆ›å»ºå®¢æˆ·ç«¯è¿æ¥<code>NioSocketChannel</code>ï¼Œå¹¶å°†åˆ›å»ºå¥½çš„å®¢æˆ·ç«¯è¿æ¥<code>NioSocketChannel</code>æ³¨å†Œåˆ°ä»Reactorçº¿ç¨‹ç»„ä¸­ä¸€ä¸ªå›ºå®šçš„<code>Reactor</code>ä¸Šã€‚</li> <li>ä¸€ä¸ªæ˜¯ä»Reactorçº¿ç¨‹ç»„<code>workerGroup</code>ï¼Œ<code>workerGroup</code>ä¸­çš„<code>Reactor</code>è´Ÿè´£ç›‘å¬ç»‘å®šåœ¨å…¶ä¸Šçš„å®¢æˆ·ç«¯è¿æ¥<code>NioSocketChannel</code>ä¸Šçš„<code>IOå°±ç»ªäº‹ä»¶</code>ï¼Œå¹¶å¤„ç†<code>IOå°±ç»ªäº‹ä»¶</code>ï¼Œ<code>æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡</code>ã€‚</li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">//åˆ›å»ºä¸»ä»Reactorçº¿ç¨‹ç»„</span>
<span class="token class-name">EventLoopGroup</span> bossGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">EventLoopGroup</span> workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Nettyä¸­Reactorçº¿ç¨‹ç»„çš„å®ç°ç±»ä¸º<code>NioEventLoopGroup</code>ï¼Œåœ¨åˆ›å»º<code>bossGroup</code>å’Œ<code>workerGroup</code>çš„æ—¶å€™ç”¨åˆ°äº†<code>NioEventLoopGroup</code>çš„ä¸¤ä¸ªæ„é€ å‡½æ•°ï¼š</p> <ul><li>å¸¦<code>nThreads</code>å‚æ•°çš„æ„é€ å‡½æ•°<code>public NioEventLoopGroup(int nThreads)</code>ã€‚</li> <li>ä¸å¸¦<code>nThreads</code>å‚æ•°çš„<code>é»˜è®¤</code>æ„é€ å‡½æ•°<code>public NioEventLoopGroup()</code></li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NioEventLoopGroup</span> <span class="token keyword">extends</span> <span class="token class-name">MultithreadEventLoopGroup</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * Create a new instance using the default number of threads, the default {@link ThreadFactory} and
     * the {@link SelectorProvider} which is returned by {@link SelectorProvider#provider()}.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Create a new instance using the specified number of threads, {@link ThreadFactory} and the
     * {@link SelectorProvider} which is returned by {@link SelectorProvider#provider()}.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token keyword">int</span> nThreads<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>nThreads<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Executor</span><span class="token punctuation">)</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p><code>nThreads</code>å‚æ•°è¡¨ç¤ºå½“å‰è¦åˆ›å»ºçš„<code>Reactorçº¿ç¨‹ç»„</code>å†…åŒ…å«å¤šå°‘ä¸ª<code>Reactorçº¿ç¨‹</code>ã€‚ä¸æŒ‡å®š<code>nThreads</code>å‚æ•°çš„è¯é‡‡ç”¨é»˜è®¤çš„<code>Reactorçº¿ç¨‹</code>ä¸ªæ•°ï¼Œç”¨<code>0</code>è¡¨ç¤ºã€‚</p></blockquote> <p>æœ€ç»ˆä¼šè°ƒç”¨åˆ°æ„é€ å‡½æ•°</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token keyword">int</span> nThreads<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">SelectorProvider</span> selectorProvider<span class="token punctuation">,</span>
<span class="token keyword">final</span> <span class="token class-name">SelectStrategyFactory</span> selectStrategyFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">super</span><span class="token punctuation">(</span>nThreads<span class="token punctuation">,</span> executor<span class="token punctuation">,</span> selectorProvider<span class="token punctuation">,</span> selectStrategyFactory<span class="token punctuation">,</span> <span class="token class-name">RejectedExecutionHandlers</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸‹é¢ç®€å•ä»‹ç»ä¸‹æ„é€ å‡½æ•°ä¸­è¿™å‡ ä¸ªå‚æ•°çš„ä½œç”¨ï¼Œåé¢æˆ‘ä»¬åœ¨è®²è§£æœ¬æ–‡ä¸»çº¿çš„è¿‡ç¨‹ä¸­è¿˜ä¼šæåŠè¿™å‡ ä¸ªå‚æ•°ï¼Œåˆ°æ—¶åœ¨è¯¦ç»†ä»‹ç»ï¼Œè¿™é‡Œåªæ˜¯è®©å¤§å®¶æœ‰ä¸ªåˆæ­¥å°è±¡ï¼Œä¸å¿…åšè¿‡å¤šçš„çº ç¼ ã€‚</p> <ul><li><code>Executor executorï¼š</code>è´Ÿè´£å¯åŠ¨<code>Reactorçº¿ç¨‹</code>è¿›è€ŒReactoræ‰å¯ä»¥å¼€å§‹å·¥ä½œã€‚</li></ul> <blockquote><p>Reactorçº¿ç¨‹ç»„<code>NioEventLoopGroup</code>è´Ÿè´£åˆ›å»º<code>Reactorçº¿ç¨‹</code>ï¼Œåœ¨åˆ›å»ºçš„æ—¶å€™ä¼šå°†<code>executor</code>ä¼ å…¥ã€‚</p></blockquote> <ul><li><code>RejectedExecutionHandlerï¼š</code> å½“å‘<code>Reactor</code>æ·»åŠ å¼‚æ­¥ä»»åŠ¡æ·»åŠ å¤±è´¥æ—¶ï¼Œé‡‡ç”¨çš„æ‹’ç»ç­–ç•¥ã€‚Reactorçš„ä»»åŠ¡ä¸åªæ˜¯ç›‘å¬IOæ´»è·ƒäº‹ä»¶å’ŒIOä»»åŠ¡çš„å¤„ç†ï¼Œè¿˜åŒ…æ‹¬å¯¹å¼‚æ­¥ä»»åŠ¡çš„å¤„ç†ã€‚è¿™é‡Œå¤§å®¶åªéœ€æœ‰ä¸ªè¿™æ ·çš„æ¦‚å¿µï¼Œåé¢ç¬”è€…ä¼šä¸“é—¨è¯¦ç»†ä»‹ç»ã€‚</li> <li><code>SelectorProvider selectorProviderï¼š</code> Reactorä¸­çš„IOæ¨¡å‹ä¸º<code>IOå¤šè·¯å¤ç”¨æ¨¡å‹</code>ï¼Œå¯¹åº”äºJDK NIOä¸­çš„å®ç°ä¸º<code>java.nio.channels.Selector</code>ï¼ˆå°±æ˜¯æˆ‘ä»¬ä¸Šç¯‡æ–‡ç« ä¸­æåˆ°çš„<code>select,poll,epoll</code>ï¼‰ï¼Œæ¯ä¸ªReatorä¸­éƒ½åŒ…å«ä¸€ä¸ª<code>Selector</code>ï¼Œç”¨äº<code>è½®è¯¢</code>æ³¨å†Œåœ¨è¯¥Reactorä¸Šçš„æ‰€æœ‰<code>Channel</code>ä¸Šçš„<code>IOäº‹ä»¶</code>ã€‚<code>SelectorProvider</code>å°±æ˜¯ç”¨æ¥åˆ›å»º<code>Selector</code>çš„ã€‚</li> <li><code>SelectStrategyFactory selectStrategyFactoryï¼š</code> Reactoræœ€é‡è¦çš„äº‹æƒ…å°±æ˜¯<code>è½®è¯¢</code>æ³¨å†Œå…¶ä¸Šçš„<code>Channel</code>ä¸Šçš„<code>IOå°±ç»ªäº‹ä»¶</code>ï¼Œè¿™é‡Œçš„<code>SelectStrategyFactory</code>ç”¨äºæŒ‡å®š<code>è½®è¯¢ç­–ç•¥</code>ï¼Œé»˜è®¤ä¸º<code>DefaultSelectStrategyFactory.INSTANCE</code>ã€‚</li></ul> <p>æœ€ç»ˆä¼šå°†è¿™äº›å‚æ•°äº¤ç»™<code>NioEventLoopGroup</code>çš„çˆ¶ç±»æ„é€ å™¨ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹<code>NioEventLoopGroupç±»</code>çš„ç»§æ‰¿ç»“æ„ï¼š</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191013482.png" alt="å›¾ç‰‡"></p> <p><code>NioEventLoopGroupç±»</code>çš„ç»§æ‰¿ç»“æ„ä¹ä¸€çœ‹æ¯”è¾ƒå¤æ‚ï¼Œå¤§å®¶ä¸è¦æ…Œï¼Œç¬”è€…ä¼šéšç€ä¸»çº¿çš„æ·±å…¥æ…¢æ…¢åœ°ä»‹ç»è¿™äº›çˆ¶ç±»æ¥å£ï¼Œæˆ‘ä»¬ç°åœ¨é‡ç‚¹å…³æ³¨<code>Mutithread</code>å‰ç¼€çš„ç±»ã€‚</p> <p>æˆ‘ä»¬çŸ¥é“<code>NioEventLoopGroup</code>æ˜¯Nettyä¸­çš„<code>Reactorçº¿ç¨‹ç»„</code>çš„å®ç°ï¼Œæ—¢ç„¶æ˜¯çº¿ç¨‹ç»„é‚£ä¹ˆè‚¯å®šæ˜¯è´Ÿè´£ç®¡ç†å’Œåˆ›å»º<code>å¤šä¸ªReactorçº¿ç¨‹çš„</code>ï¼Œæ‰€ä»¥<code>Mutithread</code>å‰ç¼€çš„ç±»å®šä¹‰çš„è¡Œä¸ºè‡ªç„¶æ˜¯å¯¹<code>Reactorçº¿ç¨‹ç»„</code>å†…å¤šä¸ª<code>Reactorçº¿ç¨‹</code>çš„åˆ›å»ºå’Œç®¡ç†å·¥ä½œã€‚</p> <h3 id="multithreadeventloopgroup"><a href="#multithreadeventloopgroup" class="header-anchor">#</a> MultithreadEventLoopGroup</h3> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">MultithreadEventLoopGroup</span> <span class="token keyword">extends</span> <span class="token class-name">MultithreadEventExecutorGroup</span> <span class="token keyword">implements</span> <span class="token class-name">EventLoopGroup</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">InternalLogger</span> logger <span class="token operator">=</span> <span class="token class-name">InternalLoggerFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">MultithreadEventLoopGroup</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//é»˜è®¤Reactorä¸ªæ•°</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_EVENT_LOOP_THREADS</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token constant">DEFAULT_EVENT_LOOP_THREADS</span> <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">SystemPropertyUtil</span><span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>
                <span class="token string">&quot;io.netty.eventLoopThreads&quot;</span><span class="token punctuation">,</span> <span class="token class-name">NettyRuntime</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;-Dio.netty.eventLoopThreads: {}&quot;</span><span class="token punctuation">,</span> <span class="token constant">DEFAULT_EVENT_LOOP_THREADS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @see MultithreadEventExecutorGroup#MultithreadEventExecutorGroup(int, Executor, Object...)
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">MultithreadEventLoopGroup</span><span class="token punctuation">(</span><span class="token keyword">int</span> nThreads<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>nThreads <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token constant">DEFAULT_EVENT_LOOP_THREADS</span> <span class="token operator">:</span> nThreads<span class="token punctuation">,</span> executor<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>MultithreadEventLoopGroupç±»</code>ä¸»è¦çš„åŠŸèƒ½å°±æ˜¯ç”¨æ¥ç¡®å®š<code>Reactorçº¿ç¨‹ç»„</code>å†…<code>Reactor</code>çš„ä¸ªæ•°ã€‚</p> <p>é»˜è®¤çš„<code>Reactor</code>çš„ä¸ªæ•°å­˜æ”¾äºå­—æ®µ<code>DEFAULT_EVENT_LOOP_THREADS</code>ä¸­ã€‚</p> <p>ä»<code>static {}</code>é™æ€ä»£ç å—ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºé»˜è®¤<code>Reactor</code>çš„ä¸ªæ•°çš„è·å–é€»è¾‘ï¼š</p> <ul><li>å¯ä»¥é€šè¿‡ç³»ç»Ÿå˜é‡ <code>-D io.netty.eventLoopThreads&quot;</code>æŒ‡å®šã€‚</li> <li>å¦‚æœä¸æŒ‡å®šï¼Œé‚£ä¹ˆé»˜è®¤çš„å°±æ˜¯<code>NettyRuntime.availableProcessors() * 2</code></li></ul> <p>å½“<code>nThread</code>å‚æ•°è®¾ç½®ä¸º<code>0</code>é‡‡ç”¨é»˜è®¤è®¾ç½®æ—¶ï¼Œ<code>Reactorçº¿ç¨‹ç»„</code>å†…çš„<code>Reactor</code>ä¸ªæ•°åˆ™è®¾ç½®ä¸º<code>DEFAULT_EVENT_LOOP_THREADS</code>ã€‚</p> <h3 id="multithreadeventexecutorgroup"><a href="#multithreadeventexecutorgroup" class="header-anchor">#</a> MultithreadEventExecutorGroup</h3> <p><code>MultithreadEventExecutorGroup</code>è¿™é‡Œå°±æ˜¯æœ¬å°èŠ‚çš„æ ¸å¿ƒï¼Œä¸»è¦ç”¨æ¥å®šä¹‰åˆ›å»ºå’Œç®¡ç†<code>Reactor</code>çš„è¡Œä¸ºã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">MultithreadEventExecutorGroup</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractEventExecutorGroup</span> <span class="token punctuation">{</span>

    <span class="token comment">//Reactorçº¿ç¨‹ç»„ä¸­çš„Reactoré›†åˆ</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">EventExecutor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> children<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EventExecutor</span><span class="token punctuation">&gt;</span></span> readonlyChildren<span class="token punctuation">;</span>
    <span class="token comment">//ä»Reactor groupä¸­é€‰æ‹©ä¸€ä¸ªç‰¹å®šçš„Reactorçš„é€‰æ‹©ç­–ç•¥ ç”¨äºchannelæ³¨å†Œç»‘å®šåˆ°ä¸€ä¸ªå›ºå®šçš„Reactorä¸Š</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">EventExecutorChooserFactory<span class="token punctuation">.</span>EventExecutorChooser</span> chooser<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Create a new instance.
     *
     * @param nThreads          the number of threads that will be used by this instance.
     * @param executor          the Executor to use, or {@code null} if the default should be used.
     * @param args              arguments which will passed to each {@link #newChild(Executor, Object...)} call
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">MultithreadEventExecutorGroup</span><span class="token punctuation">(</span><span class="token keyword">int</span> nThreads<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>nThreads<span class="token punctuation">,</span> executor<span class="token punctuation">,</span> <span class="token class-name">DefaultEventExecutorChooserFactory</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>é¦–å…ˆä»‹ç»ä¸€ä¸ªæ–°çš„æ„é€ å™¨å‚æ•°<code>EventExecutorChooserFactory chooserFactory</code>ã€‚å½“å®¢æˆ·ç«¯è¿æ¥å®Œæˆä¸‰æ¬¡æ¡æ‰‹åï¼Œ<code>Main Reactor</code>ä¼šåˆ›å»ºå®¢æˆ·ç«¯è¿æ¥<code>NioSocketChannel</code>ï¼Œå¹¶å°†å…¶ç»‘å®šåˆ°<code>Sub Reactor Group</code>ä¸­çš„ä¸€ä¸ªå›ºå®š<code>Reactor</code>ï¼Œé‚£ä¹ˆå…·ä½“è¦ç»‘å®šåˆ°å“ªä¸ªå…·ä½“çš„<code>Sub Reactor</code>ä¸Šå‘¢ï¼Ÿè¿™ä¸ªç»‘å®šç­–ç•¥å°±æ˜¯ç”±<code>chooserFactory</code>æ¥åˆ›å»ºçš„ã€‚é»˜è®¤ä¸º<code>DefaultEventExecutorChooserFactory</code>ã€‚</p> <p><strong>ä¸‹é¢å°±æ˜¯æœ¬å°èŠ‚çš„ä¸»é¢˜<code>Reactorçº¿ç¨‹ç»„</code>çš„åˆ›å»ºè¿‡ç¨‹ï¼š</strong></p> <div class="language-Java extra-class"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token class-name">MultithreadEventExecutorGroup</span><span class="token punctuation">(</span><span class="token keyword">int</span> nThreads<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">,</span>
                                            <span class="token class-name">EventExecutorChooserFactory</span> chooserFactory<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nThreads <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;nThreads: %d (expected: &gt; 0)&quot;</span><span class="token punctuation">,</span> nThreads<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>executor <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//ç”¨äºåˆ›å»ºReactorçº¿ç¨‹</span>
            executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPerTaskExecutor</span><span class="token punctuation">(</span><span class="token function">newDefaultThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        children <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventExecutor</span><span class="token punctuation">[</span>nThreads<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//å¾ªç¯åˆ›å»ºreaactor group ä¸­çš„ Reactor</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nThreads<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> success <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//åˆ›å»ºreactor</span>
                children<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">newChild</span><span class="token punctuation">(</span>executor<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                success <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;failed to create a child event loop&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//åˆ›å»ºchannelåˆ°Reactorçš„ç»‘å®šç­–ç•¥</span>
        chooser <span class="token operator">=</span> chooserFactory<span class="token punctuation">.</span><span class="token function">newChooser</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EventExecutor</span><span class="token punctuation">&gt;</span></span> childrenSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EventExecutor</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>children<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>childrenSet<span class="token punctuation">,</span> children<span class="token punctuation">)</span><span class="token punctuation">;</span>
        readonlyChildren <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableSet</span><span class="token punctuation">(</span>childrenSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h4 id="_1-åˆ›å»ºç”¨äºå¯åŠ¨reactorçº¿ç¨‹çš„executor"><a href="#_1-åˆ›å»ºç”¨äºå¯åŠ¨reactorçº¿ç¨‹çš„executor" class="header-anchor">#</a> 1. åˆ›å»ºç”¨äºå¯åŠ¨Reactorçº¿ç¨‹çš„executor</h4> <p>åœ¨Netty Reactor Groupä¸­çš„å•ä¸ª<code>Reactor</code>çš„<code>IOçº¿ç¨‹æ¨¡å‹</code>ä¸ºä¸Šç¯‡æ–‡ç« æåˆ°çš„<code>å•Reactorå•çº¿ç¨‹æ¨¡å‹</code>ï¼Œä¸€ä¸ª<code>Reactorçº¿ç¨‹</code>è´Ÿè´£<code>è½®è¯¢</code>æ³¨å†Œå…¶ä¸Šçš„æ‰€æœ‰<code>Channel</code>ä¸­çš„<code>IOå°±ç»ªäº‹ä»¶</code>ï¼Œå¤„ç†IOäº‹ä»¶ï¼Œæ‰§è¡ŒNettyä¸­çš„å¼‚æ­¥ä»»åŠ¡ç­‰å·¥ä½œã€‚æ­£æ˜¯è¿™ä¸ª<code>Reactorçº¿ç¨‹</code>é©±åŠ¨ç€æ•´ä¸ªNettyçš„è¿è½¬ï¼Œå¯è°“æ˜¯Nettyçš„æ ¸å¿ƒå¼•æ“ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191020098.png" alt="å›¾ç‰‡"></p> <p>è€Œè¿™é‡Œçš„<code>executor</code>å°±æ˜¯è´Ÿè´£å¯åŠ¨<code>Reactorçº¿ç¨‹</code>çš„ï¼Œä»åˆ›å»ºæºç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°<code>executor</code>çš„ç±»å‹ä¸º<code>ThreadPerTaskExecutor</code>ã€‚</p> <h5 id="threadpertaskexecutor"><a href="#threadpertaskexecutor" class="header-anchor">#</a> ThreadPerTaskExecutor</h5> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPerTaskExecutor</span> <span class="token keyword">implements</span> <span class="token class-name">Executor</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ThreadPerTaskExecutor</span><span class="token punctuation">(</span><span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>threadFactory <span class="token operator">=</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>threadFactory<span class="token punctuation">,</span> <span class="token string">&quot;threadFactory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        threadFactory<span class="token punctuation">.</span><span class="token function">newThread</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æˆ‘ä»¬çœ‹åˆ°<code>ThreadPerTaskExecutor</code>åšçš„äº‹æƒ…å¾ˆç®€å•ï¼Œä»å®ƒçš„å‘½åå‰ç¼€<code>ThreadPerTask</code>æˆ‘ä»¬å°±å¯ä»¥çŒœå‡ºå®ƒçš„å·¥ä½œæ–¹å¼ï¼Œå°±æ˜¯æ¥ä¸€ä¸ªä»»åŠ¡å°±åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚è€Œåˆ›å»ºçš„è¿™ä¸ªçº¿ç¨‹æ­£æ˜¯nettyçš„æ ¸å¿ƒå¼•æ“Reactorçº¿ç¨‹ã€‚</p> <p>åœ¨<code>Reactorçº¿ç¨‹</code>å¯åŠ¨çš„æ—¶å€™ï¼ŒNettyä¼šå°†<code>Reactorçº¿ç¨‹</code>è¦åšçš„äº‹æƒ…å°è£…æˆ<code>Runnable</code>ï¼Œä¸¢ç»™<code>exexutor</code>å¯åŠ¨ã€‚</p> <p>è€Œ<code>Reactorçº¿ç¨‹</code>çš„æ ¸å¿ƒå°±æ˜¯ä¸€ä¸ª<code>æ­»å¾ªç¯</code>ä¸åœçš„<code>è½®è¯¢</code>IOå°±ç»ªäº‹ä»¶ï¼Œå¤„ç†IOäº‹ä»¶ï¼Œæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ã€‚ä¸€åˆ»ä¹Ÿä¸åœæ­‡ï¼Œå ªç§°<code>996å…¸èŒƒ</code>ã€‚</p> <p>è¿™é‡Œå‘å¤§å®¶å…ˆå–ä¸ªå…³å­ï¼Œ<code>&quot;Reactorçº¿ç¨‹æ˜¯ä½•æ—¶å¯åŠ¨çš„å‘¢ï¼Ÿï¼Ÿ&quot;</code></p> <h4 id="_2-åˆ›å»ºreactor"><a href="#_2-åˆ›å»ºreactor" class="header-anchor">#</a> 2. åˆ›å»ºReactor</h4> <p><code>Reactorçº¿ç¨‹ç»„NioEventLoopGroup</code>åŒ…å«å¤šä¸ª<code>Reactor</code>ï¼Œå­˜æ”¾äº<code>private final EventExecutor[] children</code>æ•°ç»„ä¸­ã€‚</p> <p>æ‰€ä»¥ä¸‹é¢çš„äº‹æƒ…å°±æ˜¯åˆ›å»º<code>nThread</code>ä¸ª<code>Reactor</code>ï¼Œå¹¶å­˜æ”¾äº<code>EventExecutor[] children</code>å­—æ®µä¸­ï¼Œ</p> <p>æˆ‘ä»¬æ¥çœ‹ä¸‹ç”¨äºåˆ›å»º<code>Reactor</code>çš„<code>newChild(executor, args)</code>æ–¹æ³•ï¼š</p> <h5 id="newchild"><a href="#newchild" class="header-anchor">#</a> newChild</h5> <p><code>newChild</code>æ–¹æ³•æ˜¯<code>MultithreadEventExecutorGroup</code>ä¸­çš„ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œæä¾›ç»™å…·ä½“å­ç±»å®ç°ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">EventExecutor</span> <span class="token function">newChild</span><span class="token punctuation">(</span><span class="token class-name">Executor</span> executor<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
</code></pre></div><p>è¿™é‡Œæˆ‘ä»¬è§£æçš„æ˜¯<code>NioEventLoopGroup</code>ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹<code>newChild</code>åœ¨è¯¥ç±»ä¸­çš„å®ç°ï¼š</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NioEventLoopGroup</span> <span class="token keyword">extends</span> <span class="token class-name">MultithreadEventLoopGroup</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">EventLoop</span> <span class="token function">newChild</span><span class="token punctuation">(</span><span class="token class-name">Executor</span> executor<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">EventLoopTaskQueueFactory</span> queueFactory <span class="token operator">=</span> args<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token class-name">EventLoopTaskQueueFactory</span><span class="token punctuation">)</span> args<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoop</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> executor<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">SelectorProvider</span><span class="token punctuation">)</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">SelectStrategyFactory</span><span class="token punctuation">)</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newSelectStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">RejectedExecutionHandler</span><span class="token punctuation">)</span> args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å‰è¾¹æåˆ°çš„ä¼—å¤šæ„é€ å™¨å‚æ•°ï¼Œè¿™é‡Œä¼šé€šè¿‡å¯å˜å‚æ•°<code>Object... args</code>ä¼ å…¥åˆ°Reactorç±»<code>NioEventLoop</code>çš„æ„é€ å™¨ä¸­ã€‚</p> <p>è¿™é‡Œä»‹ç»ä¸‹æ–°çš„å‚æ•°<code>EventLoopTaskQueueFactory queueFactory</code>ï¼Œå‰è¾¹æåˆ°Nettyä¸­çš„<code>Reactor</code>ä¸»è¦å·¥ä½œæ˜¯<code>è½®è¯¢</code>æ³¨å†Œå…¶ä¸Šçš„æ‰€æœ‰<code>Channel</code>ä¸Šçš„<code>IOå°±ç»ªäº‹ä»¶</code>ï¼Œå¤„ç†<code>IOå°±ç»ªäº‹ä»¶</code>ã€‚é™¤äº†è¿™äº›ä¸»è¦çš„å·¥ä½œå¤–ï¼ŒNettyä¸ºäº†æè‡´çš„å‹æ¦¨<code>Reactor</code>çš„æ€§èƒ½ï¼Œè¿˜ä¼šè®©å®ƒåšä¸€äº›å¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œå·¥ä½œã€‚æ—¢ç„¶è¦æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œé‚£ä¹ˆ<code>Reactor</code>ä¸­å°±éœ€è¦ä¸€ä¸ª<code>é˜Ÿåˆ—</code>æ¥ä¿å­˜ä»»åŠ¡ã€‚</p> <p>è¿™é‡Œçš„<code>EventLoopTaskQueueFactory</code>å°±æ˜¯ç”¨æ¥åˆ›å»ºè¿™æ ·çš„ä¸€ä¸ªé˜Ÿåˆ—æ¥ä¿å­˜<code>Reactor</code>ä¸­å¾…æ‰§è¡Œçš„å¼‚æ­¥ä»»åŠ¡ã€‚</p> <p><strong>å¯ä»¥æŠŠ<code>Reactor</code>ç†è§£æˆä¸ºä¸€ä¸ª<code>å•çº¿ç¨‹çš„çº¿ç¨‹æ± </code>ï¼Œ<code>ç±»ä¼¼</code>äº<code>JDK</code>ä¸­çš„<code>SingleThreadExecutor</code>ï¼Œä»…ç”¨ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œ<code>è½®è¯¢IOå°±ç»ªäº‹ä»¶</code>ï¼Œ<code>å¤„ç†IOå°±ç»ªäº‹ä»¶</code>ï¼Œ<code>æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡</code>ã€‚åŒæ—¶å¾…æ‰§è¡Œçš„å¼‚æ­¥ä»»åŠ¡ä¿å­˜åœ¨<code>Reactor</code>é‡Œçš„<code>taskQueue</code>ä¸­ã€‚</strong></p> <h5 id="nioeventloop"><a href="#nioeventloop" class="header-anchor">#</a> NioEventLoop</h5> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">NioEventLoop</span> <span class="token keyword">extends</span> <span class="token class-name">SingleThreadEventLoop</span> <span class="token punctuation">{</span>
    <span class="token comment">//ç”¨äºåˆ›å»ºJDK NIO Selector,ServerSocketChannel</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SelectorProvider</span> provider<span class="token punctuation">;</span>
    <span class="token comment">//Selectorè½®è¯¢ç­–ç•¥ å†³å®šä»€ä¹ˆæ—¶å€™è½®è¯¢ï¼Œä»€ä¹ˆæ—¶å€™å¤„ç†IOäº‹ä»¶ï¼Œä»€ä¹ˆæ—¶å€™æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SelectStrategy</span> selectStrategy<span class="token punctuation">;</span>
    <span class="token comment">/**
     * The NIO {@link Selector}.
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Selector</span> selector<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Selector</span> unwrappedSelector<span class="token punctuation">;</span>

    <span class="token class-name">NioEventLoop</span><span class="token punctuation">(</span><span class="token class-name">NioEventLoopGroup</span> parent<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">,</span> <span class="token class-name">SelectorProvider</span> selectorProvider<span class="token punctuation">,</span>
                 <span class="token class-name">SelectStrategy</span> strategy<span class="token punctuation">,</span> <span class="token class-name">RejectedExecutionHandler</span> rejectedExecutionHandler<span class="token punctuation">,</span>
                 <span class="token class-name">EventLoopTaskQueueFactory</span> queueFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> executor<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token function">newTaskQueue</span><span class="token punctuation">(</span>queueFactory<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">newTaskQueue</span><span class="token punctuation">(</span>queueFactory<span class="token punctuation">)</span><span class="token punctuation">,</span>
                rejectedExecutionHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>provider <span class="token operator">=</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>selectorProvider<span class="token punctuation">,</span> <span class="token string">&quot;selectorProvider&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>selectStrategy <span class="token operator">=</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>strategy<span class="token punctuation">,</span> <span class="token string">&quot;selectStrategy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">SelectorTuple</span> selectorTuple <span class="token operator">=</span> <span class="token function">openSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>selector <span class="token operator">=</span> selectorTuple<span class="token punctuation">.</span>selector<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>unwrappedSelector <span class="token operator">=</span> selectorTuple<span class="token punctuation">.</span>unwrappedSelector<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¿™é‡Œå°±æ­£å¼å¼€å§‹äº†<code>Reactor</code>çš„åˆ›å»ºè¿‡ç¨‹ï¼Œæˆ‘ä»¬çŸ¥é“<code>Reactor</code>çš„æ ¸å¿ƒæ˜¯é‡‡ç”¨çš„<code>IOå¤šè·¯å¤ç”¨æ¨¡å‹</code>æ¥å¯¹å®¢æˆ·ç«¯è¿æ¥ä¸Šçš„<code>IOäº‹ä»¶</code>è¿›è¡Œ<code>ç›‘å¬</code>ï¼Œæ‰€ä»¥æœ€é‡è¦çš„äº‹æƒ…æ˜¯åˆ›å»º<code>Selector</code>(<code>JDK NIO ä¸­IOå¤šè·¯å¤ç”¨æŠ€æœ¯çš„å®ç°</code>)ã€‚</p> <blockquote><p>å¯ä»¥æŠŠ<code>Selector</code>ç†è§£ä¸ºæˆ‘ä»¬ä¸Šç¯‡æ–‡ç« ä»‹ç»çš„<code>Select,poll,epoll</code>ï¼Œå®ƒæ˜¯<code>JDK NIO</code>å¯¹æ“ä½œç³»ç»Ÿå†…æ ¸æä¾›çš„è¿™äº›<code>IOå¤šè·¯å¤ç”¨æŠ€æœ¯</code>çš„å°è£…ã€‚</p></blockquote> <h5 id="openselector"><a href="#openselector" class="header-anchor">#</a> openSelector</h5> <p><code>openSelector</code>æ˜¯<code>NioEventLoopç±»</code>ä¸­ç”¨äºåˆ›å»º<code>IOå¤šè·¯å¤ç”¨</code>çš„<code>Selector</code>ï¼Œå¹¶å¯¹åˆ›å»ºå‡ºæ¥çš„<code>JDK NIO</code> åŸç”Ÿçš„<code>Selector</code>è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ã€‚</p> <p>é¦–å…ˆä¼šé€šè¿‡<code>SelectorProvider#openSelector</code>åˆ›å»ºJDK NIOåŸç”Ÿçš„<code>Selector</code>ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">SelectorTuple</span> <span class="token function">openSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Selector</span> unwrappedSelector<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//é€šè¿‡JDK NIO SelectorProvideråˆ›å»ºSelector</span>
        unwrappedSelector <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">openSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ChannelException</span><span class="token punctuation">(</span><span class="token string">&quot;failed to open a new selector&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>SelectorProvider</code>ä¼šæ ¹æ®æ“ä½œç³»ç»Ÿçš„ä¸åŒé€‰æ‹©JDKåœ¨ä¸åŒæ“ä½œç³»ç»Ÿç‰ˆæœ¬ä¸‹çš„å¯¹åº”<code>Selector</code>çš„å®ç°ã€‚Linuxä¸‹ä¼šé€‰æ‹©<code>Epoll</code>ï¼ŒMacä¸‹ä¼šé€‰æ‹©<code>Kqueue</code>ã€‚</p> <p>ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹ä¸‹<code>SelectorProvider</code>æ˜¯å¦‚ä½•åšåˆ°è‡ªåŠ¨é€‚é…ä¸åŒæ“ä½œç³»ç»Ÿä¸‹<code>IOå¤šè·¯å¤ç”¨</code>å®ç°çš„</p> <h5 id="selectorprovider"><a href="#selectorprovider" class="header-anchor">#</a> SelectorProvider</h5> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">this</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> threadFactory<span class="token punctuation">,</span> <span class="token class-name">SelectorProvider</span><span class="token punctuation">.</span><span class="token function">provider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>SelectorProvider</code>æ˜¯åœ¨å‰é¢ä»‹ç»çš„<code>NioEventLoopGroupç±»</code>æ„é€ å‡½æ•°ä¸­é€šè¿‡è°ƒç”¨<code>SelectorProvider.provider()</code>è¢«åŠ è½½ï¼Œå¹¶é€šè¿‡<code>NioEventLoopGroup#newChild</code>æ–¹æ³•ä¸­çš„å¯å˜é•¿å‚æ•°<code>Object... args</code>ä¼ é€’åˆ°<code>NioEventLoop</code>ä¸­çš„<code>private final SelectorProvider provider</code>å­—æ®µä¸­ã€‚</p> <p><strong>SelectorProviderçš„åŠ è½½è¿‡ç¨‹ï¼š</strong></p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SelectorProvider</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">SelectorProvider</span> <span class="token function">provider</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>provider <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> provider<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectorProvider</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">public</span> <span class="token class-name">SelectorProvider</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">loadProviderFromProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token keyword">return</span> provider<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">loadProviderAsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token keyword">return</span> provider<span class="token punctuation">;</span>
                            provider <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>ch<span class="token punctuation">.</span></span>DefaultSelectorProvider</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span> provider<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä»<code>SelectorProvider</code>åŠ è½½æºç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œ<code>SelectorProvider</code>çš„åŠ è½½æ–¹å¼æœ‰ä¸‰ç§ï¼Œä¼˜å…ˆçº§å¦‚ä¸‹ï¼š</p> <ol><li>é€šè¿‡ç³»ç»Ÿå˜é‡<code>-D java.nio.channels.spi.SelectorProvider</code>æŒ‡å®š<code>SelectorProvider</code>çš„è‡ªå®šä¹‰å®ç°ç±»<code>å…¨é™å®šå</code>ã€‚é€šè¿‡<code>åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨(Application Classloader)</code>åŠ è½½ã€‚</li></ol> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">loadProviderFromProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> cn <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;java.nio.channels.spi.SelectorProvider&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cn <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    	<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> c <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>cn<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        provider <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SelectorProvider</span><span class="token punctuation">)</span>c<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>é€šè¿‡<code>SPI</code>æ–¹å¼åŠ è½½ã€‚åœ¨å·¥ç¨‹ç›®å½•<code>META-INF/services</code>ä¸‹å®šä¹‰åä¸º<code>java.nio.channels.spi.SelectorProvider</code>çš„<code>SPIæ–‡ä»¶</code>ï¼Œæ–‡ä»¶ä¸­ç¬¬ä¸€ä¸ªå®šä¹‰çš„<code>SelectorProvider</code>å®ç°ç±»å…¨é™å®šåå°±ä¼šè¢«åŠ è½½ã€‚</li></ol> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">loadProviderAsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">ServiceLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectorProvider</span><span class="token punctuation">&gt;</span></span> sl <span class="token operator">=</span>
            <span class="token class-name">ServiceLoader</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">SelectorProvider</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                               <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectorProvider</span><span class="token punctuation">&gt;</span></span> i <span class="token operator">=</span> sl<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>i<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                provider <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ServiceConfigurationError</span> sce<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sce<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">SecurityException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Ignore the security exception, try the next provider</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">throw</span> sce<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>å¦‚æœä»¥ä¸Šä¸¤ç§æ–¹å¼å‡æœªè¢«å®šä¹‰ï¼Œé‚£ä¹ˆå°±é‡‡ç”¨<code>SelectorProvider</code>ç³»ç»Ÿé»˜è®¤å®ç°<code>sun.nio.ch.DefaultSelectorProvider</code>ã€‚ç¬”è€…å½“å‰ä½¿ç”¨çš„æ“ä½œç³»ç»Ÿæ˜¯<code>MacOS</code>ï¼Œä»æºç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è‡ªåŠ¨é€‚é…äº†<code>KQueue</code>å®ç°ã€‚</li></ol> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultSelectorProvider</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">DefaultSelectorProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">SelectorProvider</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">KQueueSelectorProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸‹é¢æˆ‘ä»¬æ¥ç€å›åˆ°<code>io.netty.channel.nio.NioEventLoop#openSelector</code>çš„ä¸»çº¿ä¸Šæ¥ã€‚</p> <h5 id="nettyå¯¹jdk-nio-åŸç”Ÿselectorçš„ä¼˜åŒ–"><a href="#nettyå¯¹jdk-nio-åŸç”Ÿselectorçš„ä¼˜åŒ–" class="header-anchor">#</a> Nettyå¯¹JDK NIO åŸç”ŸSelectorçš„ä¼˜åŒ–</h5> <p>å»ºè®®æŸ¥çœ‹ https://mp.weixin.qq.com/s/IuIsUtpiye13L8ZyHWvzXA</p> <h5 id="newtaskqueue"><a href="#newtaskqueue" class="header-anchor">#</a> newTaskQueue</h5> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">NioEventLoop</span><span class="token punctuation">(</span><span class="token class-name">NioEventLoopGroup</span> parent<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">,</span> <span class="token class-name">SelectorProvider</span> selectorProvider<span class="token punctuation">,</span><span class="token class-name">SelectStrategy</span> strategy<span class="token punctuation">,</span> <span class="token class-name">RejectedExecutionHandler</span> rejectedExecutionHandler<span class="token punctuation">,</span><span class="token class-name">EventLoopTaskQueueFactory</span> queueFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>		  	<span class="token keyword">super</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> executor<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token function">newTaskQueue</span><span class="token punctuation">(</span>queueFactory<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">newTaskQueue</span><span class="token punctuation">(</span>queueFactory<span class="token punctuation">)</span><span class="token punctuation">,</span>rejectedExecutionHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>provider <span class="token operator">=</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>selectorProvider<span class="token punctuation">,</span> <span class="token string">&quot;selectorProvider&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>selectStrategy <span class="token operator">=</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>strategy<span class="token punctuation">,</span> <span class="token string">&quot;selectStrategy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">SelectorTuple</span> selectorTuple <span class="token operator">=</span> <span class="token function">openSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//é€šè¿‡ç”¨SelectedSelectionKeySetè£…é¥°åçš„unwrappedSelector</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>selector <span class="token operator">=</span> selectorTuple<span class="token punctuation">.</span>selector<span class="token punctuation">;</span>
    <span class="token comment">//Nettyä¼˜åŒ–è¿‡çš„JDK NIOè¿œç¨‹Selector</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>unwrappedSelector <span class="token operator">=</span> selectorTuple<span class="token punctuation">.</span>unwrappedSelector<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æˆ‘ä»¬ç»§ç»­å›åˆ°åˆ›å»º<code>Reactor</code>çš„ä¸»çº¿ä¸Šï¼Œåˆ°ç›®å‰ä¸ºæ­¢<code>Reactor</code>çš„æ ¸å¿ƒ<code>Selector</code>å°±åˆ›å»ºå¥½äº†ï¼Œå‰è¾¹æˆ‘ä»¬æåˆ°<code>Reactor</code>é™¤äº†éœ€è¦<code>ç›‘å¬IOå°±ç»ªäº‹ä»¶</code>ä»¥åŠå¤„ç†<code>IOå°±ç»ªäº‹ä»¶</code>å¤–ï¼Œè¿˜éœ€è¦æ‰§è¡Œä¸€äº›å¼‚æ­¥ä»»åŠ¡ï¼Œå½“å¤–éƒ¨çº¿ç¨‹å‘<code>Reactor</code>æäº¤å¼‚æ­¥ä»»åŠ¡åï¼Œ<code>Reactor</code>å°±éœ€è¦ä¸€ä¸ªé˜Ÿåˆ—æ¥ä¿å­˜è¿™äº›å¼‚æ­¥ä»»åŠ¡ï¼Œç­‰å¾…<code>Reactorçº¿ç¨‹</code>æ‰§è¡Œã€‚</p> <p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹<code>Reactor</code>ä¸­ä»»åŠ¡é˜Ÿåˆ—çš„åˆ›å»ºè¿‡ç¨‹ï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token comment">//ä»»åŠ¡é˜Ÿåˆ—å¤§å°ï¼Œé»˜è®¤æ˜¯æ— ç•Œé˜Ÿåˆ—</span>
    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_MAX_PENDING_TASKS</span> <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span>
            <span class="token class-name">SystemPropertyUtil</span><span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">&quot;io.netty.eventLoop.maxPendingTasks&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> <span class="token function">newTaskQueue</span><span class="token punctuation">(</span>
            <span class="token class-name">EventLoopTaskQueueFactory</span> queueFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>queueFactory <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">newTaskQueue0</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_MAX_PENDING_TASKS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> queueFactory<span class="token punctuation">.</span><span class="token function">newTaskQueue</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_MAX_PENDING_TASKS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> <span class="token function">newTaskQueue0</span><span class="token punctuation">(</span><span class="token keyword">int</span> maxPendingTasks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// This event loop never calls takeTask()</span>
        <span class="token keyword">return</span> maxPendingTasks <span class="token operator">==</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span> <span class="token operator">?</span> <span class="token class-name">PlatformDependent</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token function">newMpscQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">:</span> <span class="token class-name">PlatformDependent</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token function">newMpscQueue</span><span class="token punctuation">(</span>maxPendingTasks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>  
</code></pre></div><ul><li><p>åœ¨<code>NioEventLoop</code>çš„çˆ¶ç±»<code>SingleThreadEventLoop</code>ä¸­æä¾›äº†ä¸€ä¸ªé™æ€å˜é‡<code>DEFAULT_MAX_PENDING_TASKS</code>ç”¨æ¥æŒ‡å®š<code>Reactor</code>ä»»åŠ¡é˜Ÿåˆ—çš„å¤§å°ã€‚å¯ä»¥é€šè¿‡ç³»ç»Ÿå˜é‡<code>-D io.netty.eventLoop.maxPendingTasks</code>è¿›è¡Œè®¾ç½®ï¼Œé»˜è®¤ä¸º<code>Integer.MAX_VALUE</code>ï¼Œè¡¨ç¤ºä»»åŠ¡é˜Ÿåˆ—é»˜è®¤ä¸º<code>æ— ç•Œé˜Ÿåˆ—</code>ã€‚</p></li> <li><p>æ ¹æ®<code>DEFAULT_MAX_PENDING_TASKS</code>å˜é‡çš„è®¾å®šï¼Œæ¥å†³å®šåˆ›å»ºæ— ç•Œä»»åŠ¡é˜Ÿåˆ—è¿˜æ˜¯æœ‰ç•Œä»»åŠ¡é˜Ÿåˆ—ã€‚</p></li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">//åˆ›å»ºæ— ç•Œä»»åŠ¡é˜Ÿåˆ—</span>
<span class="token class-name">PlatformDependent</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token function">newMpscQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//åˆ›å»ºæœ‰ç•Œä»»åŠ¡é˜Ÿåˆ—</span>
<span class="token class-name">PlatformDependent</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token function">newMpscQueue</span><span class="token punctuation">(</span>maxPendingTasks<span class="token punctuation">)</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">newMpscQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token class-name">Mpsc</span><span class="token punctuation">.</span><span class="token function">newMpscQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">newMpscQueue</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> maxCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token class-name">Mpsc</span><span class="token punctuation">.</span><span class="token function">newMpscQueue</span><span class="token punctuation">(</span>maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p><code>Reactor</code>å†…çš„å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—çš„ç±»å‹ä¸º<code>MpscQueue</code>,å®ƒæ˜¯ç”±<code>JCTools</code>æä¾›çš„ä¸€ä¸ªé«˜æ€§èƒ½æ— é”é˜Ÿåˆ—ï¼Œä»å‘½åå‰ç¼€<code>Mpsc</code>å¯ä»¥çœ‹å‡ºï¼Œå®ƒé€‚ç”¨äº<code>å¤šç”Ÿäº§è€…å•æ¶ˆè´¹è€…</code>çš„åœºæ™¯ï¼Œå®ƒæ”¯æŒå¤šä¸ªç”Ÿäº§è€…çº¿ç¨‹å®‰å…¨çš„è®¿é—®é˜Ÿåˆ—ï¼ŒåŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹è¯»å–é˜Ÿåˆ—ä¸­çš„å…ƒç´ ã€‚</p></blockquote> <blockquote><p>æˆ‘ä»¬çŸ¥é“Nettyä¸­çš„<code>Reactor</code>å¯ä»¥<code>çº¿ç¨‹å®‰å…¨</code>çš„å¤„ç†æ³¨å†Œå…¶ä¸Šçš„å¤šä¸ª<code>SocketChannel</code>ä¸Šçš„<code>IOæ•°æ®</code>ï¼Œä¿è¯<code>Reactorçº¿ç¨‹å®‰å…¨</code>çš„æ ¸å¿ƒåŸå› æ­£æ˜¯å› ä¸ºè¿™ä¸ª<code>MpscQueue</code>ï¼Œå®ƒå¯ä»¥æ”¯æŒå¤šä¸ªä¸šåŠ¡çº¿ç¨‹åœ¨å¤„ç†å®Œä¸šåŠ¡é€»è¾‘åï¼Œçº¿ç¨‹å®‰å…¨çš„å‘<code>MpscQueue</code>æ·»åŠ <code>å¼‚æ­¥å†™ä»»åŠ¡</code>ï¼Œç„¶åç”±å•ä¸ª<code>Reactorçº¿ç¨‹</code>æ¥æ‰§è¡Œè¿™äº›<code>å†™ä»»åŠ¡</code>ã€‚æ—¢ç„¶æ˜¯å•çº¿ç¨‹æ‰§è¡Œï¼Œé‚£è‚¯å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„äº†ã€‚</p></blockquote> <h5 id="reactorå¯¹åº”çš„nioeventloopç±»å‹ç»§æ‰¿ç»“æ„"><a href="#reactorå¯¹åº”çš„nioeventloopç±»å‹ç»§æ‰¿ç»“æ„" class="header-anchor">#</a> Reactorå¯¹åº”çš„NioEventLoopç±»å‹ç»§æ‰¿ç»“æ„</h5> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191039019.png" alt="å›¾ç‰‡"></p> <p><code>NioEventLoop</code>çš„ç»§æ‰¿ç»“æ„ä¹Ÿæ˜¯æ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œæˆ‘ä»¬åªå…³æ³¨åœ¨<code>Reactor</code>åˆ›å»ºè¿‡ç¨‹ä¸­æ¶‰åŠçš„åˆ°ä¸¤ä¸ªçˆ¶ç±»<code>SingleThreadEventLoop</code>,<code>SingleThreadEventExecutor</code>ã€‚</p> <p>å‰©ä¸‹çš„ç»§æ‰¿ä½“ç³»ï¼Œæˆ‘ä»¬åœ¨åè¾¹éšç€<code>Netty</code>æºç çš„æ·±å…¥åœ¨æ…¢æ…¢ä»‹ç»ã€‚</p> <p>å‰è¾¹æˆ‘ä»¬æåˆ°ï¼Œå…¶å®<code>Reactor</code>æˆ‘ä»¬å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„çº¿ç¨‹æ± ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ç”¨æ¥æ‰§è¡Œ<code>IOå°±ç»ªäº‹ä»¶çš„ç›‘å¬</code>ï¼Œ<code>IOäº‹ä»¶çš„å¤„ç†</code>ï¼Œ<code>å¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œ</code>ã€‚ç”¨<code>MpscQueue</code>æ¥å­˜å‚¨å¾…æ‰§è¡Œçš„å¼‚æ­¥ä»»åŠ¡ã€‚</p> <p>å‘½åå‰ç¼€ä¸º<code>SingleThread</code>çš„çˆ¶ç±»éƒ½æ˜¯å¯¹<code>Reactor</code>è¿™äº›è¡Œä¸ºçš„åˆ†å±‚å®šä¹‰ã€‚ä¹Ÿæ˜¯æœ¬å°èŠ‚è¦ä»‹ç»çš„å¯¹è±¡</p> <h6 id="singlethreadeventloop"><a href="#singlethreadeventloop" class="header-anchor">#</a> SingleThreadEventLoop</h6> <p><code>Reactor</code>è´Ÿè´£æ‰§è¡Œçš„å¼‚æ­¥ä»»åŠ¡åˆ†ä¸ºä¸‰ç±»ï¼š</p> <ul><li><code>æ™®é€šä»»åŠ¡ï¼š</code>è¿™æ˜¯Nettyæœ€ä¸»è¦æ‰§è¡Œçš„å¼‚æ­¥ä»»åŠ¡ï¼Œå­˜æ”¾åœ¨æ™®é€šä»»åŠ¡é˜Ÿåˆ—<code>taskQueue</code>ä¸­ã€‚åœ¨<code>NioEventLoop</code>æ„é€ å‡½æ•°ä¸­åˆ›å»ºã€‚</li> <li><code>å®šæ—¶ä»»åŠ¡ï¼š</code> å­˜æ”¾åœ¨ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­ã€‚åç»­æˆ‘ä»¬ä»‹ç»ã€‚</li> <li><code>å°¾éƒ¨ä»»åŠ¡ï¼š</code> å­˜æ”¾äºå°¾éƒ¨ä»»åŠ¡é˜Ÿåˆ—<code>tailTasks</code>ä¸­ï¼Œå°¾éƒ¨ä»»åŠ¡ä¸€èˆ¬ä¸å¸¸ç”¨ï¼Œåœ¨æ™®é€šä»»åŠ¡æ‰§è¡Œå®Œå Reactorçº¿ç¨‹ä¼šæ‰§è¡Œå°¾éƒ¨ä»»åŠ¡ã€‚**ä½¿ç”¨åœºæ™¯ï¼š**æ¯”å¦‚å¯¹Netty çš„è¿è¡ŒçŠ¶æ€åšä¸€äº›ç»Ÿè®¡æ•°æ®ï¼Œä¾‹å¦‚ä»»åŠ¡å¾ªç¯çš„è€—æ—¶ã€å ç”¨ç‰©ç†å†…å­˜çš„å¤§å°ç­‰ç­‰éƒ½å¯ä»¥å‘å°¾éƒ¨é˜Ÿåˆ—æ·»åŠ ä¸€ä¸ªæ”¶å°¾ä»»åŠ¡å®Œæˆç»Ÿè®¡æ•°æ®çš„å®æ—¶æ›´æ–°ã€‚</li></ul> <p><code>SingleThreadEventLoop</code>è´Ÿè´£å¯¹<code>å°¾éƒ¨ä»»åŠ¡é˜Ÿåˆ—tailTasks</code>è¿›è¡Œç®¡ç†ã€‚å¹¶ä¸”æä¾›<code>Channel</code>å‘<code>Reactor</code>æ³¨å†Œçš„è¡Œä¸ºã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SingleThreadEventLoop</span> <span class="token keyword">extends</span> <span class="token class-name">SingleThreadEventExecutor</span> <span class="token keyword">implements</span> <span class="token class-name">EventLoop</span> <span class="token punctuation">{</span>

    <span class="token comment">//ä»»åŠ¡é˜Ÿåˆ—å¤§å°ï¼Œé»˜è®¤æ˜¯æ— ç•Œé˜Ÿåˆ—</span>
    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_MAX_PENDING_TASKS</span> <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span>
            <span class="token class-name">SystemPropertyUtil</span><span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">&quot;io.netty.eventLoop.maxPendingTasks&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//å°¾éƒ¨ä»»åŠ¡é˜Ÿåˆ—</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> tailTasks<span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token class-name">SingleThreadEventLoop</span><span class="token punctuation">(</span><span class="token class-name">EventLoopGroup</span> parent<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">,</span>
                                    <span class="token keyword">boolean</span> addTaskWakesUp<span class="token punctuation">,</span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> taskQueue<span class="token punctuation">,</span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> tailTaskQueue<span class="token punctuation">,</span>
                                    <span class="token class-name">RejectedExecutionHandler</span> rejectedExecutionHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> executor<span class="token punctuation">,</span> addTaskWakesUp<span class="token punctuation">,</span> taskQueue<span class="token punctuation">,</span> rejectedExecutionHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//å°¾éƒ¨é˜Ÿåˆ— æ‰§è¡Œä¸€äº›ç»Ÿè®¡ä»»åŠ¡ ä¸å¸¸ç”¨</span>
        tailTasks <span class="token operator">=</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>tailTaskQueue<span class="token punctuation">,</span> <span class="token string">&quot;tailTaskQueue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//æ³¨å†Œchannelåˆ°ç»‘å®šçš„Reactorä¸Š</span>
        <span class="token keyword">return</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultChannelPromise</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h6 id="singlethreadeventexecutor"><a href="#singlethreadeventexecutor" class="header-anchor">#</a> SingleThreadEventExecutor</h6> <p><code>SingleThreadEventExecutor</code>ä¸»è¦è´Ÿè´£å¯¹<code>æ™®é€šä»»åŠ¡é˜Ÿåˆ—</code>çš„ç®¡ç†ï¼Œä»¥åŠ<code>å¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œ</code>ï¼Œ<code>Reactorçº¿ç¨‹çš„å¯åœ</code>ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SingleThreadEventExecutor</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractScheduledEventExecutor</span> <span class="token keyword">implements</span> <span class="token class-name">OrderedEventExecutor</span> <span class="token punctuation">{</span>

    <span class="token keyword">protected</span> <span class="token class-name">SingleThreadEventExecutor</span><span class="token punctuation">(</span><span class="token class-name">EventExecutorGroup</span> parent<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">,</span>
                                        <span class="token keyword">boolean</span> addTaskWakesUp<span class="token punctuation">,</span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> taskQueue<span class="token punctuation">,</span> <span class="token class-name">RejectedExecutionHandler</span> rejectedHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//parentä¸ºReactoræ‰€å±çš„NioEventLoopGroup Reactorçº¿ç¨‹ç»„</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//å‘Reactoræ·»åŠ ä»»åŠ¡æ—¶ï¼Œæ˜¯å¦å”¤é†’Selectoråœæ­¢è½®è¯¢IOå°±ç»ªäº‹ä»¶ï¼Œé©¬ä¸Šæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>addTaskWakesUp <span class="token operator">=</span> addTaskWakesUp<span class="token punctuation">;</span>
        <span class="token comment">//Reactorå¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—çš„å¤§å°</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maxPendingTasks <span class="token operator">=</span> <span class="token constant">DEFAULT_MAX_PENDING_EXECUTOR_TASKS</span><span class="token punctuation">;</span>
        <span class="token comment">//ç”¨äºå¯åŠ¨Reactorçº¿ç¨‹çš„executor -&gt; ThreadPerTaskExecutor</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>executor <span class="token operator">=</span> <span class="token class-name">ThreadExecutorMap</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>executor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//æ™®é€šä»»åŠ¡é˜Ÿåˆ—</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>taskQueue <span class="token operator">=</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">,</span> <span class="token string">&quot;taskQueue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//ä»»åŠ¡é˜Ÿåˆ—æ»¡æ—¶çš„æ‹’ç»ç­–ç•¥</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rejectedExecutionHandler <span class="token operator">=</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>rejectedHandler<span class="token punctuation">,</span> <span class="token string">&quot;rejectedHandler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œä¸€ä¸ªå®Œæ•´çš„<code>Reactoræ¶æ„</code>å°±è¢«åˆ›å»ºå‡ºæ¥äº†ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191043689.png" alt="å›¾ç‰‡"></p> <h4 id="_3-åˆ›å»ºchannelåˆ°reactorçš„ç»‘å®šç­–ç•¥"><a href="#_3-åˆ›å»ºchannelåˆ°reactorçš„ç»‘å®šç­–ç•¥" class="header-anchor">#</a> 3. åˆ›å»ºChannelåˆ°Reactorçš„ç»‘å®šç­–ç•¥</h4> <p>åˆ°è¿™ä¸€æ­¥ï¼ŒReactorçº¿ç¨‹ç»„<code>NioEventLoopGroup</code>é‡Œè¾¹çš„æ‰€æœ‰<code>Reactor</code>å°±å·²ç»å…¨éƒ¨åˆ›å»ºå®Œæ¯•ã€‚</p> <p>æ— è®ºæ˜¯NettyæœåŠ¡ç«¯<code>NioServerSocketChannel</code>å…³æ³¨çš„<code>OP_ACCEPT</code>äº‹ä»¶ä¹Ÿå¥½ï¼Œè¿˜æ˜¯Nettyå®¢æˆ·ç«¯<code>NioSocketChannel</code>å…³æ³¨çš„<code>OP_READ</code>å’Œ<code>OP_WRITE</code>äº‹ä»¶ä¹Ÿå¥½ï¼Œéƒ½éœ€è¦å…ˆæ³¨å†Œåˆ°<code>Reactor</code>ä¸Šï¼Œ<code>Reactor</code>æ‰èƒ½ç›‘å¬<code>Channel</code>ä¸Šå…³æ³¨çš„<code>IOäº‹ä»¶</code>å®ç°<code>IOå¤šè·¯å¤ç”¨</code>ã€‚</p> <p><code>NioEventLoopGroup</code>ï¼ˆReactorçº¿ç¨‹ç»„ï¼‰é‡Œè¾¹æœ‰ä¼—å¤šçš„<code>Reactor</code>ï¼Œé‚£ä¹ˆä»¥ä¸Šæåˆ°çš„è¿™äº›<code>Channel</code>ç©¶ç«Ÿåº”è¯¥æ³¨å†Œåˆ°å“ªä¸ª<code>Reactor</code>ä¸Šå‘¢ï¼Ÿè¿™å°±éœ€è¦ä¸€ä¸ªç»‘å®šçš„ç­–ç•¥æ¥å¹³å‡åˆ†é…ã€‚</p> <p>è¿˜è®°å¾—æˆ‘ä»¬å‰è¾¹ä»‹ç»<code>MultithreadEventExecutorGroupç±»</code>çš„æ—¶å€™æåˆ°çš„æ„é€ å™¨å‚æ•°<code>EventExecutorChooserFactory</code>å—ï¼Ÿ</p> <p>è¿™æ—¶å€™å®ƒå°±æ´¾ä¸Šç”¨åœºäº†ï¼Œå®ƒä¸»è¦ç”¨æ¥åˆ›å»º<code>Channel</code>åˆ°<code>Reactor</code>çš„ç»‘å®šç­–ç•¥ã€‚é»˜è®¤ä¸º<code>DefaultEventExecutorChooserFactory.INSTANCE</code>ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">MultithreadEventExecutorGroup</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractEventExecutorGroup</span> <span class="token punctuation">{</span>
   <span class="token comment">//ä»Reactoré›†åˆä¸­é€‰æ‹©ä¸€ä¸ªç‰¹å®šçš„Reactorçš„ç»‘å®šç­–ç•¥ ç”¨äºchannelæ³¨å†Œç»‘å®šåˆ°ä¸€ä¸ªå›ºå®šçš„Reactorä¸Š</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">EventExecutorChooserFactory<span class="token punctuation">.</span>EventExecutorChooser</span> chooser<span class="token punctuation">;</span>

    chooser <span class="token operator">=</span> chooserFactory<span class="token punctuation">.</span><span class="token function">newChooser</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹å…·ä½“çš„ç»‘å®šç­–ç•¥ï¼š</p> <h5 id="defaulteventexecutorchooserfactory"><a href="#defaulteventexecutorchooserfactory" class="header-anchor">#</a> DefaultEventExecutorChooserFactory</h5> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">DefaultEventExecutorChooserFactory</span> <span class="token keyword">implements</span> <span class="token class-name">EventExecutorChooserFactory</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">DefaultEventExecutorChooserFactory</span> <span class="token constant">INSTANCE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultEventExecutorChooserFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">DefaultEventExecutorChooserFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">EventExecutorChooser</span> <span class="token function">newChooser</span><span class="token punctuation">(</span><span class="token class-name">EventExecutor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> executors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPowerOfTwo</span><span class="token punctuation">(</span>executors<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PowerOfTwoEventExecutorChooser</span><span class="token punctuation">(</span>executors<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">GenericEventExecutorChooser</span><span class="token punctuation">(</span>executors<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isPowerOfTwo</span><span class="token punctuation">(</span><span class="token keyword">int</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>val <span class="token operator">&amp;</span> <span class="token operator">-</span>val<span class="token punctuation">)</span> <span class="token operator">==</span> val<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æˆ‘ä»¬çœ‹åˆ°åœ¨<code>newChooser</code>æ–¹æ³•ç»‘å®šç­–ç•¥æœ‰ä¸¤ä¸ªåˆ†æ”¯ï¼Œä¸åŒä¹‹å¤„åœ¨äºéœ€è¦åˆ¤æ–­Reactorçº¿ç¨‹ç»„ä¸­çš„<code>Reactor</code>ä¸ªæ•°æ˜¯å¦ä¸º<code>2çš„æ¬¡å¹‚</code>ã€‚</p> <p>Nettyä¸­çš„ç»‘å®šç­–ç•¥å°±æ˜¯é‡‡ç”¨<code>round-robin</code>è½®è¯¢çš„æ–¹å¼æ¥æŒ¨ä¸ªé€‰æ‹©<code>Reactor</code>è¿›è¡Œç»‘å®šã€‚</p> <p>é‡‡ç”¨<code>round-robin</code>çš„æ–¹å¼è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šç”¨<code>round % reactor.length</code>å–ä½™çš„æ–¹å¼æ¥æŒ¨ä¸ªå¹³å‡çš„å®šä½åˆ°å¯¹åº”çš„<code>Reactor</code>ä¸Šã€‚</p> <p>å¦‚æœ<code>Reactor</code>çš„ä¸ªæ•°<code>reactor.length</code>æ°å¥½æ˜¯<code>2çš„æ¬¡å¹‚</code>ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç”¨ä½æ“ä½œ<code>&amp;</code>è¿ç®—<code>round &amp; reactor.length -1</code>æ¥ä»£æ›¿<code>%</code>è¿ç®—<code>round % reactor.length</code>ï¼Œå› ä¸ºä½è¿ç®—çš„æ€§èƒ½æ›´é«˜ã€‚å…·ä½“ä¸ºä»€ä¹ˆ<code>&amp;</code>è¿ç®—èƒ½å¤Ÿä»£æ›¿<code>%</code>è¿ç®—ï¼Œç¬”è€…ä¼šåœ¨åé¢è®²è¿°æ—¶é—´è½®çš„æ—¶å€™ä¸ºå¤§å®¶è¯¦ç»†è¯æ˜ï¼Œè¿™é‡Œå¤§å®¶åªéœ€è®°ä½è¿™ä¸ªå…¬å¼ï¼Œæˆ‘ä»¬è¿˜æ˜¯èšç„¦æœ¬æ–‡çš„ä¸»çº¿ã€‚</p> <p>äº†è§£äº†ä¼˜åŒ–åŸç†ï¼Œæˆ‘ä»¬åœ¨çœ‹ä»£ç å®ç°å°±å¾ˆå®¹æ˜“ç†è§£äº†ã€‚</p> <p><strong>åˆ©ç”¨<code>%</code>è¿ç®—çš„æ–¹å¼<code>Math.abs(idx.getAndIncrement() % executors.length)</code>æ¥è¿›è¡Œç»‘å®šã€‚</strong></p> <div class="language-Java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">GenericEventExecutorChooser</span> <span class="token keyword">implements</span> <span class="token class-name">EventExecutorChooser</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicLong</span> idx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">EventExecutor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> executors<span class="token punctuation">;</span>

        <span class="token class-name">GenericEventExecutorChooser</span><span class="token punctuation">(</span><span class="token class-name">EventExecutor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> executors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>executors <span class="token operator">=</span> executors<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">EventExecutor</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> executors<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>idx<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> executors<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><strong>åˆ©ç”¨<code>&amp;</code>è¿ç®—çš„æ–¹å¼<code>idx.getAndIncrement() &amp; executors.length - 1</code>æ¥è¿›è¡Œç»‘å®šã€‚</strong></p> <div class="language-Java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">PowerOfTwoEventExecutorChooser</span> <span class="token keyword">implements</span> <span class="token class-name">EventExecutorChooser</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> idx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">EventExecutor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> executors<span class="token punctuation">;</span>

        <span class="token class-name">PowerOfTwoEventExecutorChooser</span><span class="token punctuation">(</span><span class="token class-name">EventExecutor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> executors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>executors <span class="token operator">=</span> executors<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">EventExecutor</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> executors<span class="token punctuation">[</span>idx<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> executors<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><blockquote><p>åˆä¸€æ¬¡è¢«Nettyå¯¹æ€§èƒ½çš„æè‡´è¿½æ±‚æ‰€æŠ˜æœ~~~~</p></blockquote> <h4 id="_4-å‘reactorçº¿ç¨‹ç»„ä¸­æ‰€æœ‰çš„reactoræ³¨å†Œterminatedå›è°ƒå‡½æ•°"><a href="#_4-å‘reactorçº¿ç¨‹ç»„ä¸­æ‰€æœ‰çš„reactoræ³¨å†Œterminatedå›è°ƒå‡½æ•°" class="header-anchor">#</a> 4. å‘Reactorçº¿ç¨‹ç»„ä¸­æ‰€æœ‰çš„Reactoræ³¨å†Œterminatedå›è°ƒå‡½æ•°</h4> <p>å½“Reactorçº¿ç¨‹ç»„<code>NioEventLoopGroup</code>ä¸­æ‰€æœ‰çš„<code>Reactor</code>å·²ç»åˆ›å»ºå®Œæ¯•ï¼Œ<code>Channel</code>åˆ°<code>Reactor</code>çš„ç»‘å®šç­–ç•¥ä¹Ÿåˆ›å»ºå®Œæ¯•åï¼Œæˆ‘ä»¬å°±æ¥åˆ°äº†åˆ›å»º<code>NioEventGroup</code>çš„æœ€åä¸€æ­¥ã€‚</p> <p>ä¿—è¯è¯´çš„å¥½ï¼Œæœ‰åˆ›å»ºå°±æœ‰å¯åŠ¨ï¼Œæœ‰å¯åŠ¨å°±æœ‰å…³é—­ï¼Œè¿™é‡Œä¼šåˆ›å»º<code>Reactorå…³é—­</code>çš„å›è°ƒå‡½æ•°<code>terminationListener</code>ï¼Œåœ¨<code>Reactor</code>å…³é—­æ—¶å›è°ƒã€‚</p> <p><code>terminationListener</code>å›è°ƒçš„é€»è¾‘å¾ˆç®€å•ï¼š</p> <ul><li>é€šè¿‡<code>AtomicInteger terminatedChildren</code>å˜é‡è®°å½•å·²ç»å…³é—­çš„<code>Reactor</code>ä¸ªæ•°ï¼Œç”¨æ¥åˆ¤æ–­<code>NioEventLoopGroup</code>ä¸­çš„<code>Reactor</code>æ˜¯å¦å·²ç»å…¨éƒ¨å…³é—­ã€‚</li> <li>å¦‚æœæ‰€æœ‰<code>Reactor</code>å‡å·²å…³é—­ï¼Œè®¾ç½®<code>NioEventLoopGroup</code>ä¸­çš„<code>terminationFuture</code>ä¸º<code>success</code>ã€‚è¡¨ç¤º<code>Reactorçº¿ç¨‹ç»„</code>å…³é—­æˆåŠŸã€‚</li></ul> <div class="language-Java extra-class"><pre class="language-java"><code>       <span class="token comment">//è®°å½•å…³é—­çš„Reactorä¸ªæ•°ï¼Œå½“Reactorå…¨éƒ¨å…³é—­åï¼Œæ‰å¯ä»¥è®¤ä¸ºå…³é—­æˆåŠŸ</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> terminatedChildren <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//å…³é—­future</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Promise</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> terminationFuture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultPromise</span><span class="token punctuation">(</span><span class="token class-name">GlobalEventExecutor</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token class-name">FutureListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> terminationListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span><span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> future<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>terminatedChildren<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> children<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//å½“æ‰€æœ‰Reactorå…³é—­å æ‰è®¤ä¸ºæ˜¯å…³é—­æˆåŠŸ</span>
                    terminationFuture<span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        
        <span class="token comment">//ä¸ºæ‰€æœ‰Reactoræ·»åŠ terminationListener</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">EventExecutor</span> e<span class="token operator">:</span> children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">terminationFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>terminationListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre></div><hr> <p>æˆ‘ä»¬åœ¨å›åˆ°æ–‡ç« å¼€å¤´<code>NettyæœåŠ¡ç«¯ä»£ç æ¨¡æ¿</code></p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">EchoServer</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">PORT</span> <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;port&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;8007&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// Configure the server.</span>
        <span class="token comment">//åˆ›å»ºä¸»ä»Reactorçº¿ç¨‹ç»„</span>
        <span class="token class-name">EventLoopGroup</span> bossGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EventLoopGroup</span> workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ç°åœ¨Nettyçš„<code>ä¸»ä»Reactorçº¿ç¨‹ç»„</code>å°±å·²ç»åˆ›å»ºå®Œæ¯•ï¼Œæ­¤æ—¶NettyæœåŠ¡ç«¯çš„éª¨æ¶å·²ç»æ­å»ºå®Œæ¯•ï¼Œéª¨æ¶å¦‚ä¸‹ï¼š</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191048915.png" alt="å›¾ç‰‡"></p> <h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="header-anchor">#</a> æ€»ç»“</h2> <p>æœ¬æ–‡ä»‹ç»äº†é¦–å…ˆä»‹ç»äº†Nettyå¯¹å„ç§<code>IOæ¨¡å‹</code>çš„æ”¯æŒä»¥åŠå¦‚ä½•è½»æ¾åˆ‡æ¢å„ç§<code>IOæ¨¡å‹</code>ã€‚</p> <p>è¿˜èŠ±äº†å¤§é‡çš„ç¯‡å¹…ä»‹ç»NettyæœåŠ¡ç«¯çš„æ ¸å¿ƒå¼•æ“<code>ä¸»ä»Reactorçº¿ç¨‹ç»„</code>çš„åˆ›å»ºè¿‡ç¨‹ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è¿˜æåˆ°äº†Nettyå¯¹å„ç§ç»†èŠ‚è¿›è¡Œçš„ä¼˜åŒ–ï¼Œå±•ç°äº†Nettyå¯¹æ€§èƒ½æè‡´çš„è¿½æ±‚ã€‚</p> <p>å¥½äº†ï¼ŒNettyæœåŠ¡ç«¯çš„éª¨æ¶å·²ç»æ­å¥½ï¼Œå‰©ä¸‹çš„äº‹æƒ…å°±è¯¥ç»‘å®šç«¯å£åœ°å€ç„¶åæ¥æ”¶è¿æ¥äº†ï¼Œæˆ‘ä»¬ä¸‹ç¯‡æ–‡ç« å†è§~~~</p> <h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="header-anchor">#</a> å‚è€ƒèµ„æ–™</h2> <p>https://mp.weixin.qq.com/s/IuIsUtpiye13L8ZyHWvzXA</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/echo-lxy/echo-system-design/edit/master/docs/Netty ç³»ç»Ÿè®¾è®¡/25.å››ã€æ·±å…¥ Netty æ ¸å¿ƒ/10.ç¬¬äºŒè¯¾ï¼šReactoråœ¨Nettyä¸­çš„å®ç°ï¼ˆåˆ›å»ºç¯‡ï¼‰.md" target="_blank" rel="noopener noreferrer">ç¼–è¾‘</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°äº:</span> <span class="time">2024/09/19, 08:16:36</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        â†
        <a href="/pages/65674f/" class="prev">ç¬¬ä¸€è¯¾ï¼šé€è¿‡ Netty çœ‹ IO æ¨¡å‹</a></span> <span class="next"><a href="/pages/bb668a/">ç¬¬ä¸‰è¯¾ï¼šNetty æ ¸å¿ƒå¼•æ“ Reactor çš„è¿è½¬æ¶æ„</a>â†’
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:lixinyang2002@163.com" title="å‘é‚®ä»¶" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/echo-lxy" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="å¬éŸ³ä¹" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="æœ¬ç«™ä¸»é¢˜">Vdoing</a> 
    | Copyright Â© 2024-2024
    <span>Xinyang Li | MIT License</span></div> <div class="buttons"><div title="è¿”å›é¡¶éƒ¨" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="å»è¯„è®º" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ä¸»é¢˜æ¨¡å¼" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          è·Ÿéšç³»ç»Ÿ
        </li><li class="iconfont icon-rijianmoshi">
          æµ…è‰²æ¨¡å¼
        </li><li class="iconfont icon-yejianmoshi">
          æ·±è‰²æ¨¡å¼
        </li><li class="iconfont icon-yuedu">
          é˜…è¯»æ¨¡å¼
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.bdcc6820.js" defer></script><script src="/assets/js/2.933750c6.js" defer></script><script src="/assets/js/52.24cc5c91.js" defer></script><script src="/assets/js/7.7eb70372.js" defer></script>
  </body>
</html>
