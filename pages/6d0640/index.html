<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ç¬¬å››è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œè¿æ¥ | EchoDesign</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="ç³»ç»Ÿè®¾è®¡ä¹‹ã€Œè®²è§£ + é¢è¯•æŒ‡å—ã€ï¼Œæ°´æ»´çŸ³ç©¿ï¼Œè®¾è®¡æ— é“¶å¼¹ï¼">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.c76c3453.css" as="style"><link rel="preload" href="/assets/js/app.6c7acbd0.js" as="script"><link rel="preload" href="/assets/js/2.933750c6.js" as="script"><link rel="preload" href="/assets/js/54.0bbf2ba5.js" as="script"><link rel="preload" href="/assets/js/7.7eb70372.js" as="script"><link rel="prefetch" href="/assets/js/10.2cc95be8.js"><link rel="prefetch" href="/assets/js/100.2b21dce5.js"><link rel="prefetch" href="/assets/js/101.09d5e594.js"><link rel="prefetch" href="/assets/js/11.c7521a10.js"><link rel="prefetch" href="/assets/js/12.38d1989d.js"><link rel="prefetch" href="/assets/js/13.8ddd597e.js"><link rel="prefetch" href="/assets/js/14.397b7600.js"><link rel="prefetch" href="/assets/js/15.b3c76984.js"><link rel="prefetch" href="/assets/js/16.831e5a24.js"><link rel="prefetch" href="/assets/js/17.acb3bf3d.js"><link rel="prefetch" href="/assets/js/18.e491edb6.js"><link rel="prefetch" href="/assets/js/19.daf31819.js"><link rel="prefetch" href="/assets/js/20.cb4a5c13.js"><link rel="prefetch" href="/assets/js/21.24c0f101.js"><link rel="prefetch" href="/assets/js/22.7d106f59.js"><link rel="prefetch" href="/assets/js/23.623f0b5d.js"><link rel="prefetch" href="/assets/js/24.6ba53300.js"><link rel="prefetch" href="/assets/js/25.1fb855d9.js"><link rel="prefetch" href="/assets/js/26.0146252c.js"><link rel="prefetch" href="/assets/js/27.de80589e.js"><link rel="prefetch" href="/assets/js/28.d4ca2c30.js"><link rel="prefetch" href="/assets/js/29.7325b5ce.js"><link rel="prefetch" href="/assets/js/3.5c09ac9d.js"><link rel="prefetch" href="/assets/js/30.892b2994.js"><link rel="prefetch" href="/assets/js/31.a532917f.js"><link rel="prefetch" href="/assets/js/32.13b70e91.js"><link rel="prefetch" href="/assets/js/33.64ab8d0c.js"><link rel="prefetch" href="/assets/js/34.6d3cc288.js"><link rel="prefetch" href="/assets/js/35.5b49d706.js"><link rel="prefetch" href="/assets/js/36.be98cc35.js"><link rel="prefetch" href="/assets/js/37.ead210df.js"><link rel="prefetch" href="/assets/js/38.9f396b5a.js"><link rel="prefetch" href="/assets/js/39.8409097b.js"><link rel="prefetch" href="/assets/js/4.73518a0f.js"><link rel="prefetch" href="/assets/js/40.0ada49bd.js"><link rel="prefetch" href="/assets/js/41.fcee3e0f.js"><link rel="prefetch" href="/assets/js/42.b34f1599.js"><link rel="prefetch" href="/assets/js/43.5a509601.js"><link rel="prefetch" href="/assets/js/44.64fd3383.js"><link rel="prefetch" href="/assets/js/45.685623ac.js"><link rel="prefetch" href="/assets/js/46.7624d38c.js"><link rel="prefetch" href="/assets/js/47.86be3d8d.js"><link rel="prefetch" href="/assets/js/48.ba7dfd47.js"><link rel="prefetch" href="/assets/js/49.ee9681bc.js"><link rel="prefetch" href="/assets/js/5.94727770.js"><link rel="prefetch" href="/assets/js/50.3e91aa07.js"><link rel="prefetch" href="/assets/js/51.ad7a3e32.js"><link rel="prefetch" href="/assets/js/52.08ad747c.js"><link rel="prefetch" href="/assets/js/53.5ee4652a.js"><link rel="prefetch" href="/assets/js/55.0edcba5d.js"><link rel="prefetch" href="/assets/js/56.5ecf867d.js"><link rel="prefetch" href="/assets/js/57.72ba41a6.js"><link rel="prefetch" href="/assets/js/58.7144aef6.js"><link rel="prefetch" href="/assets/js/59.f96f0065.js"><link rel="prefetch" href="/assets/js/6.0b558b79.js"><link rel="prefetch" href="/assets/js/60.66a7f41d.js"><link rel="prefetch" href="/assets/js/61.08b4acf0.js"><link rel="prefetch" href="/assets/js/62.cc8fdced.js"><link rel="prefetch" href="/assets/js/63.41ff19e4.js"><link rel="prefetch" href="/assets/js/64.9b3def35.js"><link rel="prefetch" href="/assets/js/65.0b2ab47d.js"><link rel="prefetch" href="/assets/js/66.2ae7a107.js"><link rel="prefetch" href="/assets/js/67.79dd6daf.js"><link rel="prefetch" href="/assets/js/68.1b76c178.js"><link rel="prefetch" href="/assets/js/69.7ac52a2f.js"><link rel="prefetch" href="/assets/js/70.7279b1df.js"><link rel="prefetch" href="/assets/js/71.f44644ed.js"><link rel="prefetch" href="/assets/js/72.c8cf2fab.js"><link rel="prefetch" href="/assets/js/73.526febf1.js"><link rel="prefetch" href="/assets/js/74.d9ad1a67.js"><link rel="prefetch" href="/assets/js/75.90fd56c9.js"><link rel="prefetch" href="/assets/js/76.32858593.js"><link rel="prefetch" href="/assets/js/77.7b3f6980.js"><link rel="prefetch" href="/assets/js/78.31a353ef.js"><link rel="prefetch" href="/assets/js/79.173bbc8c.js"><link rel="prefetch" href="/assets/js/8.0ec7f6e8.js"><link rel="prefetch" href="/assets/js/80.d8713e74.js"><link rel="prefetch" href="/assets/js/81.d124398a.js"><link rel="prefetch" href="/assets/js/82.3b90a7cc.js"><link rel="prefetch" href="/assets/js/83.f3a9ee0c.js"><link rel="prefetch" href="/assets/js/84.1fd412a9.js"><link rel="prefetch" href="/assets/js/85.f69467b2.js"><link rel="prefetch" href="/assets/js/86.931cbb70.js"><link rel="prefetch" href="/assets/js/87.78b2eebd.js"><link rel="prefetch" href="/assets/js/88.605444aa.js"><link rel="prefetch" href="/assets/js/89.e05e3a70.js"><link rel="prefetch" href="/assets/js/9.6e274fca.js"><link rel="prefetch" href="/assets/js/90.ca1ff100.js"><link rel="prefetch" href="/assets/js/91.8ad18b18.js"><link rel="prefetch" href="/assets/js/92.b554f1c7.js"><link rel="prefetch" href="/assets/js/93.fb2397b7.js"><link rel="prefetch" href="/assets/js/94.1eade7f0.js"><link rel="prefetch" href="/assets/js/95.96f5db04.js"><link rel="prefetch" href="/assets/js/96.5ed2d348.js"><link rel="prefetch" href="/assets/js/97.0154143f.js"><link rel="prefetch" href="/assets/js/98.8d8d41db.js"><link rel="prefetch" href="/assets/js/99.690e4395.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c76c3453.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="ç›®å½•" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="EchoDesign" class="logo"> <span class="site-name can-hide">EchoDesign</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">ğŸ é¦–é¡µ</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">âœ’ï¸çƒ­é—¨ç®—æ³•</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ğŸ–ï¸èµæç»å…¸è®¾è®¡" class="dropdown-title"><!----> <span class="title" style="display:;">ğŸ–ï¸èµæç»å…¸è®¾è®¡</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ç³»ç»Ÿè®¾è®¡</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ğŸ§‘â€ğŸ’»å®æˆ˜ç³»ç»Ÿè®¾è®¡</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">â“é—®ç­”</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ğŸ‘€åŠ¨æ€</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">ğŸ é¦–é¡µ</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">âœ’ï¸çƒ­é—¨ç®—æ³•</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ğŸ–ï¸èµæç»å…¸è®¾è®¡" class="dropdown-title"><!----> <span class="title" style="display:;">ğŸ–ï¸èµæç»å…¸è®¾è®¡</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ç³»ç»Ÿè®¾è®¡</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ğŸ§‘â€ğŸ’»å®æˆ˜ç³»ç»Ÿè®¾è®¡</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">â“é—®ç­”</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ğŸ‘€åŠ¨æ€</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ä¸€ã€å‰è¨€</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>äºŒã€åŸºç¡€çŸ¥è¯†</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ä¸‰ã€ä¸»çº¿ä»»åŠ¡</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>å››ã€æ·±å…¥ Netty æ ¸å¿ƒ</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/c3d4a6/" class="sidebar-link">ç¬¬ä¸€è¯¾ï¼šé€è¿‡ Netty çœ‹ IO æ¨¡å‹</a></li><li><a href="/pages/70bb50/" class="sidebar-link">ç¬¬äºŒè¯¾ï¼šReactoråœ¨Nettyä¸­çš„å®ç°</a></li><li><a href="/pages/830f05/" class="sidebar-link">ç¬¬ä¸‰è¯¾ï¼šNettyæ ¸å¿ƒå¼•æ“Reactorçš„è¿è½¬æ¶æ„</a></li><li><a href="/pages/6d0640/" aria-current="page" class="active sidebar-link">ç¬¬å››è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œè¿æ¥</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/6d0640/#å‰æ–‡å›é¡¾" class="sidebar-link">å‰æ–‡å›é¡¾</a></li><li class="sidebar-sub-header level2"><a href="/pages/6d0640/#_1-main-reactorå¤„ç†op-acceptäº‹ä»¶" class="sidebar-link">1. Main Reactorå¤„ç†OP_ACCEPTäº‹ä»¶</a></li><li class="sidebar-sub-header level2"><a href="/pages/6d0640/#_2-æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥æ ¸å¿ƒæµç¨‹æ¡†æ¶æ€»è§ˆ" class="sidebar-link">2. æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥æ ¸å¿ƒæµç¨‹æ¡†æ¶æ€»è§ˆ</a></li><li class="sidebar-sub-header level2"><a href="/pages/6d0640/#_3-recvbytebufallocatorç®€ä»‹" class="sidebar-link">3. RecvByteBufAllocatorç®€ä»‹</a></li><li class="sidebar-sub-header level2"><a href="/pages/6d0640/#_4-å•Šå“ˆ-bug" class="sidebar-link">4. å•Šå“ˆï¼ï¼Bug ! !</a></li><li class="sidebar-sub-header level2"><a href="/pages/6d0640/#_5-doreadmessagesæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥" class="sidebar-link">5. doReadMessagesæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥</a></li><li class="sidebar-sub-header level2"><a href="/pages/6d0640/#_6-channelreadäº‹ä»¶çš„å“åº”" class="sidebar-link">6. ChannelReadäº‹ä»¶çš„å“åº”</a></li><li class="sidebar-sub-header level2"><a href="/pages/6d0640/#_7-å‘subreactorgroupä¸­æ³¨å†Œniosocketchannel" class="sidebar-link">7. å‘SubReactorGroupä¸­æ³¨å†ŒNioSocketChannel</a></li><li class="sidebar-sub-header level2"><a href="/pages/6d0640/#æ€»ç»“" class="sidebar-link">æ€»ç»“</a></li></ul></li><li><a href="/pages/9cb8c1/" class="sidebar-link">ç¬¬äº”è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œæ•°æ®</a></li><li><a href="/pages/cfe9ff/" class="sidebar-link">ç¬¬å…­è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆå‘é€ç½‘ç»œæ•°æ®.md</a></li><li><a href="/pages/ed2e85/" class="sidebar-link">ç¬¬ä¸ƒè¯¾ï¼šè¯¦è§£ Netty ä¸­æ‰€æœ‰IOäº‹ä»¶çš„è§¦å‘æ—¶æœºå’Œä¼ æ’­æµç¨‹</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>äº”ã€æ·±å…¥ Netty å†…å­˜ç®¡ç†</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="é¦–é¡µ" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>Netty ç³»ç»Ÿè®¾è®¡</span></li><li data-v-06225672><span data-v-06225672>å››ã€æ·±å…¥ Netty æ ¸å¿ƒ</span></li></ul> <div class="info" data-v-06225672><div title="ä½œè€…" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/brother-one" target="_blank" title="ä½œè€…" class="beLink" data-v-06225672>echo</a></div> <div title="åˆ›å»ºæ—¶é—´" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-09-19</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">ç›®å½•</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">ç¬¬å››è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œè¿æ¥<!----></h1> <div class="page-slot page-slot-top">
    <div class="wwads-cn wwads-horizontal page-wwads" data-id="136"></div>
    <style>
      .page-wwads{
        width:100%!important;
        min-height: 0;
        margin: 0;
      }
      .page-wwads .wwads-img img{
        width:80px!important;
      }
      .page-wwads .wwads-poweredby{
        width: 40px;
        position: absolute;
        right: 25px;
        bottom: 3px;
      }
      .wwads-content .wwads-text, .page-wwads .wwads-text{
        height: 100%;
        padding-top: 5px;
        display: block;
      }
  </style>
  </div> <div class="theme-vdoing-content content__default"><p>å¯¹äºä¸€ä¸ªé«˜æ€§èƒ½ç½‘ç»œé€šè®¯æ¡†æ¶æ¥è¯´ï¼Œæœ€æœ€é‡è¦ä¹Ÿæ˜¯æœ€æ ¸å¿ƒçš„å·¥ä½œå°±æ˜¯å¦‚ä½•é«˜æ•ˆçš„æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ï¼Œè¿™å°±å¥½æ¯”æˆ‘ä»¬å¼€äº†ä¸€ä¸ªé¥­åº—ï¼Œé‚£ä¹ˆè¿æ¥å®¢äººå°±æ˜¯é¥­åº—æœ€é‡è¦çš„å·¥ä½œï¼Œæˆ‘ä»¬è¦å…ˆæŠŠå®¢äººè¿æ¥è¿›æ¥ï¼Œä¸èƒ½è®©å®¢äººä¸€çœ‹äººå¤šå°±èµ°æ‰ï¼Œåªè¦å®¢äººè¿›æ¥äº†ï¼Œå“ªæ€•èœåšçš„æ…¢ä¸€ç‚¹ä¹Ÿæ²¡å…³ç³»ã€‚</p> <p>æœ¬æ–‡ç¬”è€…å°±æ¥ä¸ºå¤§å®¶ä»‹ç»ä¸‹nettyè¿™å—æœ€æ ¸å¿ƒçš„å†…å®¹ï¼Œçœ‹çœ‹nettyæ˜¯å¦‚ä½•é«˜æ•ˆçš„æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥çš„ã€‚</p> <p>ä¸‹å›¾ä¸ºç¬”è€…åœ¨ä¸€ä¸ªæœˆé»‘é£é«˜å¤©ç©ºæ˜¾å¾—é‚£ä¹ˆæ·±é‚ƒé¥è¿œçš„å¤œæ™šï¼Œé—²æ¥æ— äº‹ï¼Œäºæ˜¯æ§èµ·Nettyå…³äºå¦‚ä½•æ¥æ”¶è¿æ¥è¿™éƒ¨åˆ†æºç ç»†ç»†å“è¯»çš„æ—¶å€™ï¼Œæ„å¤–çš„å‘ç°äº†ä¸€ä¸ªå½±å“Nettyæ¥æ”¶è¿æ¥ååçš„ä¸€ä¸ªBugã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191110731.webp" alt="å›¾ç‰‡">issueè®¨è®º.png</p> <p>äºæ˜¯ç¬”è€…å°±åœ¨Githubæäº†ä¸€ä¸ª?Issue#11708ï¼Œé˜è¿°äº†ä¸‹è¿™ä¸ªBugäº§ç”Ÿçš„åŸå› ä»¥åŠå¯¼è‡´çš„ç»“æœå¹¶å’ŒNettyçš„ä½œè€…ä¸€èµ·è®¨è®ºäº†ä¸‹ä¿®å¤æªæ–½ã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚</p> <blockquote><p>Issue#11708ï¼šhttps://github.com/netty/netty/issues/11708</p></blockquote> <p>è¿™é‡Œå…ˆä¸è¯¦ç»†è§£é‡Šè¿™ä¸ªIssueï¼Œä¹Ÿä¸å»ºè®®å¤§å®¶ç°åœ¨å°±æ‰“å¼€è¿™ä¸ªIssueæŸ¥çœ‹ï¼Œç¬”è€…ä¼šåœ¨æœ¬æ–‡çš„ä»‹ç»ä¸­éšç€æºç æ·±å…¥çš„è§£è¯»æ…¢æ…¢çš„ä¸ºå¤§å®¶ä¸€å±‚ä¸€å±‚åœ°æ‹¨å¼€è¿·é›¾ã€‚</p> <p>ä¹‹æ‰€ä»¥åœ¨æ–‡ç« çš„å¼€å¤´æŠŠè¿™ä¸ªæ‹å‡ºæ¥ï¼Œç¬”è€…æ˜¯æƒ³è®©å¤§å®¶å¸¦ç€æ€€ç–‘ï¼Œå®¡è§†ï¼Œæ¬£èµï¼Œå´‡æ•¬ï¼Œæ•¬ç•çš„æ€åº¦æ¥ä¸€èµ·å“è¯»ä¸–ç•Œé¡¶çº§ç¨‹åºå‘˜ç¼–å†™çš„ä»£ç ã€‚ç”±è¡·çš„æ„Ÿè°¢ä»–ä»¬åœ¨è¿™ä¸€é¢†åŸŸåšå‡ºçš„è´¡çŒ®ã€‚</p> <p>å¥½äº†ï¼Œé—®é¢˜æŠ›å‡ºæ¥åï¼Œæˆ‘ä»¬å°±å¸¦ç€è¿™ä¸ªç–‘é—®æ¥å¼€å§‹æœ¬æ–‡çš„å†…å®¹å§~~~</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191110723.webp" alt="å›¾ç‰‡">æ–‡ç« æ¦‚è¦.png</p> <h2 id="å‰æ–‡å›é¡¾"><a href="#å‰æ–‡å›é¡¾" class="header-anchor">#</a> å‰æ–‡å›é¡¾</h2> <p>æŒ‰ç…§è€è§„çŸ©ï¼Œå†å¼€å§‹æœ¬æ–‡çš„å†…å®¹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸‹å‰è¾¹å‡ ç¯‡æ–‡ç« çš„æ¦‚è¦å†…å®¹å¸®åŠ©å¤§å®¶æ¢³ç†ä¸€ä¸ªæ¡†æ¶å…¨è²Œå‡ºæ¥ã€‚</p> <blockquote><p>ç¬”è€…è¿™é‡Œå†æ¬¡æƒ³å’Œè¯»è€…æœ‹å‹ä»¬å¼ºè°ƒçš„æ˜¯æœ¬æ–‡å¯ä»¥ç‹¬ç«‹è§‚çœ‹ï¼Œå¹¶ä¸ä¾èµ–å‰è¾¹ç³»åˆ—æ–‡ç« çš„å†…å®¹ï¼Œåªæ˜¯å¤§å®¶å¦‚æœå¯¹ç›¸å…³ç»†èŠ‚éƒ¨åˆ†æ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥åœ¨é˜…è¯»å®Œæœ¬æ–‡ä¹‹ååœ¨å»å›çœ‹ç›¸å…³æ–‡ç« ã€‚</p></blockquote> <p>åœ¨å‰è¾¹çš„ç³»åˆ—æ–‡ç« ä¸­ï¼Œç¬”è€…ä¸ºå¤§å®¶ä»‹ç»äº†é©±åŠ¨Nettyæ•´ä¸ªæ¡†æ¶è¿è½¬çš„æ ¸å¿ƒå¼•æ“Reactorçš„åˆ›å»ºï¼Œå¯åŠ¨ï¼Œè¿è¡Œçš„å…¨æµç¨‹ã€‚ä»ç°åœ¨å¼€å§‹Nettyçš„æ•´ä¸ªæ ¸å¿ƒæ¡†æ¶å°±å¼€å§‹è¿è½¬èµ·æ¥å¼€å§‹å·¥ä½œäº†ï¼Œæœ¬æ–‡è¦ä»‹ç»çš„ä¸»è¦å†…å®¹å°±æ˜¯Nettyåœ¨å¯åŠ¨ä¹‹åè¦åšçš„ç¬¬ä¸€ä»¶äº‹ä»¶ï¼šç›‘å¬ç«¯å£åœ°å€ï¼Œé«˜æ•ˆæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ã€‚</p> <p>åœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247483737&amp;idx=1&amp;sn=7ef3afbb54289c6e839eed724bb8a9d6&amp;chksm=ce77c71ef9004e08e3d164561e3a2708fc210c05408fa41f7fe338d8e85f39c1ad57519b614e&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€ŠèŠèŠNettyé‚£äº›äº‹å„¿ä¹‹ä»å†…æ ¸è§’åº¦çœ‹IOæ¨¡å‹ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬æ˜¯ä»æ•´ä¸ªç½‘ç»œæ¡†æ¶çš„åŸºçŸ³IOæ¨¡å‹çš„è§’åº¦æ•´ä½“é˜è¿°äº†ä¸‹Nettyçš„IOçº¿ç¨‹æ¨¡å‹ã€‚</p> <p>è€ŒNettyä¸­çš„Reactoræ­£æ˜¯IOçº¿ç¨‹åœ¨Nettyä¸­çš„æ¨¡å‹å®šä¹‰ã€‚Reactoråœ¨Nettyä¸­æ˜¯ä»¥Groupçš„å½¢å¼å‡ºç°çš„ï¼Œåˆ†ä¸º:</p> <ul><li>ä¸»Reactorçº¿ç¨‹ç»„ä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨å¯åŠ¨ä»£ç ä¸­é…ç½®çš„<code>EventLoopGroup bossGroup</code>,main reactor groupä¸­çš„reactorä¸»è¦è´Ÿè´£ç›‘å¬å®¢æˆ·ç«¯è¿æ¥äº‹ä»¶ï¼Œé«˜æ•ˆçš„å¤„ç†å®¢æˆ·ç«¯è¿æ¥ã€‚ä¹Ÿæ˜¯æœ¬æ–‡æˆ‘ä»¬è¦ä»‹ç»çš„é‡ç‚¹ã€‚</li> <li>ä»Reactorçº¿ç¨‹ç»„ä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨å¯åŠ¨ä»£ç ä¸­é…ç½®çš„<code>EventLoopGroup workerGroup</code>ï¼Œsub reactor groupä¸­çš„reactorä¸»è¦è´Ÿè´£å¤„ç†å®¢æˆ·ç«¯è¿æ¥ä¸Šçš„IOäº‹ä»¶ï¼Œä»¥åŠå¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œã€‚</li></ul> <p>æœ€åæˆ‘ä»¬å¾—å‡ºNettyçš„æ•´ä¸ªIOæ¨¡å‹å¦‚ä¸‹ï¼š</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNialDtXCOD5vvVGh56FT2yKauwTch6oYbrn1icPuYKaqY8nPibicWv66sQfw/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">nettyä¸­çš„reactor.png</p> <p>æœ¬æ–‡æˆ‘ä»¬è®¨è®ºçš„é‡ç‚¹å°±æ˜¯MainReactorGroupçš„æ ¸å¿ƒå·¥ä½œä¸Šå›¾ä¸­æ‰€ç¤ºçš„æ­¥éª¤1ï¼Œæ­¥éª¤2ï¼Œæ­¥éª¤3ã€‚</p> <p>åœ¨ä»æ•´ä½“ä¸Šä»‹ç»å®ŒNettyçš„IOæ¨¡å‹ä¹‹åï¼Œæˆ‘ä»¬åˆåœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247483907&amp;idx=1&amp;sn=084c470a8fe6234c2c9461b5f713ff30&amp;chksm=ce77c444f9004d52e7c6244bee83479070effb0bc59236df071f4d62e91e25f01715fca53696&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€ŠReactoråœ¨Nettyä¸­çš„å®ç°(åˆ›å»ºç¯‡)ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸­å®Œæ•´çš„ä»‹ç»äº†Nettyæ¡†æ¶çš„éª¨æ¶ä¸»ä»Reactorç»„çš„æ­å»ºè¿‡ç¨‹ï¼Œé˜è¿°äº†Reactoræ˜¯å¦‚ä½•è¢«åˆ›å»ºå‡ºæ¥çš„ï¼Œå¹¶ä»‹ç»äº†å®ƒçš„æ ¸å¿ƒç»„ä»¶å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiaRn9ZX4dJLJdyxSEEXojs5lEmPNiaBfstFOG95KMGibJed4vo3xMhnE6g/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">image.png</p> <ul><li><code>thread</code>å³ä¸ºReactorä¸­çš„IOçº¿ç¨‹ï¼Œä¸»è¦è´Ÿè´£ç›‘å¬IOäº‹ä»¶ï¼Œå¤„ç†IOä»»åŠ¡ï¼Œæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ã€‚</li> <li><code>selector</code>åˆ™æ˜¯JDK NIOå¯¹æ“ä½œç³»ç»Ÿåº•å±‚IOå¤šè·¯å¤ç”¨æŠ€æœ¯å®ç°çš„å°è£…ã€‚ç”¨äºç›‘å¬IOå°±ç»ªäº‹ä»¶ã€‚</li> <li><code>taskQueue</code>ç”¨äºä¿å­˜Reactoréœ€è¦æ‰§è¡Œçš„å¼‚æ­¥ä»»åŠ¡ï¼Œè¿™äº›å¼‚æ­¥ä»»åŠ¡å¯ä»¥ç”±ç”¨æˆ·åœ¨ä¸šåŠ¡çº¿ç¨‹ä¸­å‘Reactoræäº¤ï¼Œä¹Ÿå¯ä»¥æ˜¯Nettyæ¡†æ¶æäº¤çš„ä¸€äº›è‡ªèº«æ ¸å¿ƒçš„ä»»åŠ¡ã€‚</li> <li><code>scheduledTaskQueue</code>åˆ™æ˜¯ä¿å­˜Reactorä¸­æ‰§è¡Œçš„å®šæ—¶ä»»åŠ¡ã€‚ä»£æ›¿äº†åŸæœ‰çš„æ—¶é—´è½®æ¥æ‰§è¡Œå»¶æ—¶ä»»åŠ¡ã€‚</li> <li><code>tailQueue</code>ä¿å­˜äº†åœ¨Reactoréœ€è¦æ‰§è¡Œçš„ä¸€äº›å°¾éƒ¨æ”¶å°¾ä»»åŠ¡ï¼Œåœ¨æ™®é€šä»»åŠ¡æ‰§è¡Œå®Œå Reactorçº¿ç¨‹ä¼šæ‰§è¡Œå°¾éƒ¨ä»»åŠ¡ï¼Œæ¯”å¦‚å¯¹Netty çš„è¿è¡ŒçŠ¶æ€åšä¸€äº›ç»Ÿè®¡æ•°æ®ï¼Œä¾‹å¦‚ä»»åŠ¡å¾ªç¯çš„è€—æ—¶ã€å ç”¨ç‰©ç†å†…å­˜çš„å¤§å°ç­‰ç­‰</li></ul> <p>åœ¨éª¨æ¶æ­å»ºå®Œæ¯•ä¹‹åï¼Œæˆ‘ä»¬éšååˆåœ¨åœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484005&amp;idx=1&amp;sn=52f51269902a58f40d33208421109bc3&amp;chksm=ce77c422f9004d340e5b385ef6ba24dfba1f802076ace80ad6390e934173a10401e64e13eaeb&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€Šè¯¦ç»†å›¾è§£Netty Reactorå¯åŠ¨å…¨æµç¨‹ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ã€‹ä¸€æ–‡ä¸­ä»‹ç»äº†<strong>æœ¬æ–‡çš„ä¸»è§’æœåŠ¡ç«¯NioServerSocketChannelçš„åˆ›å»ºï¼Œåˆå§‹åŒ–ï¼Œç»‘å®šç«¯å£åœ°å€ï¼Œå‘main reactoræ³¨å†Œç›‘å¬<code>OP_ACCEPTäº‹ä»¶</code>çš„å®Œæ•´è¿‡ç¨‹</strong>ã€‚</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiaMNnpeQav9HykpMEYenDPdshUtLBMicYHd5F9HwloOsE6FfLVtGW0XRA/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">Reactorå¯åŠ¨åçš„ç»“æ„.png</p> <p>main reactorå¦‚ä½•å¤„ç†OP_ACCEPTäº‹ä»¶å°†ä¼šæ˜¯æœ¬æ–‡çš„ä¸»è¦å†…å®¹ã€‚</p> <p>è‡ªæ­¤Nettyæ¡†æ¶çš„main reactor groupå·²ç»å¯åŠ¨å®Œæ¯•ï¼Œå¼€å§‹å‡†å¤‡ç›‘å¬OP_acceptäº‹ä»¶ï¼Œå½“å®¢æˆ·ç«¯è¿æ¥ä¸Šæ¥ä¹‹åï¼ŒOP_ACCEPTäº‹ä»¶æ´»è·ƒï¼Œmain reactorå¼€å§‹å¤„ç†OP_ACCEPTäº‹ä»¶æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥äº†ã€‚</p> <p>è€Œnettyä¸­çš„IOäº‹ä»¶åˆ†ä¸ºï¼šOP_ACCEPTäº‹ä»¶ï¼ŒOP_READäº‹ä»¶ï¼ŒOP_WRITEäº‹ä»¶å’ŒOP_CONNECTäº‹ä»¶ï¼Œnettyå¯¹äºIOäº‹ä»¶çš„ç›‘å¬å’Œå¤„ç†ç»Ÿä¸€å°è£…åœ¨Reactoræ¨¡å‹ä¸­ï¼Œè¿™å››ä¸ªIOäº‹ä»¶çš„å¤„ç†è¿‡ç¨‹ä¹Ÿæ˜¯æˆ‘ä»¬åç»­æ–‡ç« ä¸­è¦å•ç‹¬æ‹¿å‡ºæ¥ä»‹ç»çš„ï¼Œæœ¬æ–‡æˆ‘ä»¬èšç„¦OP_ACCEPTäº‹ä»¶çš„å¤„ç†ã€‚</p> <p>è€Œä¸ºäº†è®©å¤§å®¶èƒ½å¤Ÿå¯¹IOäº‹ä»¶çš„å¤„ç†æœ‰ä¸€ä¸ªå®Œæ•´æ€§çš„è®¤è¯†ï¼Œç¬”è€…å†™äº†<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484087&amp;idx=1&amp;sn=0c065780e0f05c23c8e6465ede86cba0&amp;chksm=ce77c4f0f9004de63be369a664105708bc5975b52993f4a6df223caed34cc1ef6185a16acd75&amp;token=997171731&amp;lang=zh_CN&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€Šä¸€æ–‡èŠé€Nettyæ ¸å¿ƒå¼•æ“Reactorçš„è¿è½¬æ¶æ„ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>è¿™ç¯‡æ–‡ç« ï¼Œåœ¨æ–‡ç« ä¸­è¯¦ç»†ä»‹ç»äº†Reactorçº¿ç¨‹çš„æ•´ä½“è¿è¡Œæ¡†æ¶ã€‚</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiavrDh48SPMAM6BFPzvme6iceQT8aibcKY54GLfSOm2F7yCqynlkI9HkOg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">Reactorçº¿ç¨‹è¿è¡Œæ—¶ç»“æ„.png</p> <p>Reactorçº¿ç¨‹ä¼šåœ¨ä¸€ä¸ªæ­»å¾ªç¯ä¸­996ä¸åœçš„è¿è½¬ï¼Œåœ¨å¾ªç¯ä¸­ä¼šä¸æ–­çš„è½®è¯¢ç›‘å¬Selectorä¸Šçš„IOäº‹ä»¶ï¼Œå½“IOäº‹ä»¶æ´»è·ƒåï¼ŒReactorä»Selectorä¸Šè¢«å”¤é†’è½¬å»æ‰§è¡ŒIOå°±ç»ªäº‹ä»¶çš„å¤„ç†ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æˆ‘ä»¬å¼•å‡ºäº†ä¸Šè¿°å››ç§IOäº‹ä»¶çš„å¤„ç†å…¥å£å‡½æ•°ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private void processSelectedKey(SelectionKey k, AbstractNioChannel ch) {
        //è·å–Channelçš„åº•å±‚æ“ä½œç±»Unsafe
        final AbstractNioChannel.NioUnsafe unsafe = ch.unsafe();
        if (!k.isValid()) {
            ......å¦‚æœSelectionKeyå·²ç»å¤±æ•ˆåˆ™å…³é—­å¯¹åº”çš„Channel......
        }

        try {
            //è·å–IOå°±ç»ªäº‹ä»¶
            int readyOps = k.readyOps();
            //å¤„ç†Connectäº‹ä»¶
            if ((readyOps &amp; SelectionKey.OP_CONNECT) != 0) {
                int ops = k.interestOps();
                //ç§»é™¤å¯¹Connectäº‹ä»¶çš„ç›‘å¬ï¼Œå¦åˆ™Selectorä¼šä¸€ç›´é€šçŸ¥
                ops &amp;= ~SelectionKey.OP_CONNECT;
                k.interestOps(ops);
                //è§¦å‘channelActiveäº‹ä»¶å¤„ç†Connectäº‹ä»¶
                unsafe.finishConnect();
            }

            //å¤„ç†Writeäº‹ä»¶
            if ((readyOps &amp; SelectionKey.OP_WRITE) != 0) {
                ch.unsafe().forceFlush();
            }

             //å¤„ç†Readäº‹ä»¶æˆ–è€…Acceptäº‹ä»¶
            if ((readyOps &amp; (SelectionKey.OP_READ | SelectionKey.OP_ACCEPT)) != 0 || readyOps == 0) {
                unsafe.read();
            }
        } catch (CancelledKeyException ignored) {
            unsafe.close(unsafe.voidPromise());
        }
    }
</code></pre></div><p>æœ¬æ–‡ç¬”è€…å°†ä¼šä¸ºå¤§å®¶é‡ç‚¹ä»‹ç»<code>OP_ACCEPTäº‹ä»¶</code>çš„å¤„ç†å…¥å£å‡½æ•°<code>unsafe.read()</code>çš„æ•´ä¸ªæºç å®ç°ã€‚</p> <p>å½“å®¢æˆ·ç«¯è¿æ¥å®Œæˆä¸‰æ¬¡æ¡æ‰‹ä¹‹åï¼Œmain reactorä¸­çš„selectoräº§ç”Ÿ<code>OP_ACCEPTäº‹ä»¶</code>æ´»è·ƒï¼Œmain reactoréšå³è¢«å”¤é†’ï¼Œæ¥åˆ°äº†<code>OP_ACCEPTäº‹ä»¶</code>çš„å¤„ç†å…¥å£å‡½æ•°å¼€å§‹æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ã€‚</p> <h2 id="_1-main-reactorå¤„ç†op-acceptäº‹ä»¶"><a href="#_1-main-reactorå¤„ç†op-acceptäº‹ä»¶" class="header-anchor">#</a> 1. Main Reactorå¤„ç†OP_ACCEPTäº‹ä»¶</h2> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiaWfVAUiaQYd2Sebxwzf9VCWLhcbIISY1nBSug2YiaVEPewXhib8D8EUk2A/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">OP_ACCEPTäº‹ä»¶æ´»è·ƒ.png</p> <p>å½“<code>Main Reactor</code>è½®è¯¢åˆ°<code>NioServerSocketChannel</code>ä¸Šçš„<code>OP_ACCEPTäº‹ä»¶</code>å°±ç»ªæ—¶ï¼ŒMain Reactorçº¿ç¨‹å°±ä¼šä»<code>JDK Selector</code>ä¸Šçš„é˜»å¡è½®è¯¢API<code>selector.select(timeoutMillis)</code>è°ƒç”¨ä¸­è¿”å›ã€‚è½¬è€Œå»å¤„ç†<code>NioServerSocketChannel</code>ä¸Šçš„<code>OP_ACCEPTäº‹ä»¶</code>ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public final class NioEventLoop extends SingleThreadEventLoop {

    private void processSelectedKey(SelectionKey k, AbstractNioChannel ch) {
        final AbstractNioChannel.NioUnsafe unsafe = ch.unsafe();
        ..............çœç•¥.................

        try {
            int readyOps = k.readyOps();

            if ((readyOps &amp; SelectionKey.OP_CONNECT) != 0) {
               ..............å¤„ç†OP_CONNECTäº‹ä»¶.................
            }


            if ((readyOps &amp; SelectionKey.OP_WRITE) != 0) {
              ..............å¤„ç†OP_WRITEäº‹ä»¶.................
            }


            if ((readyOps &amp; (SelectionKey.OP_READ | SelectionKey.OP_ACCEPT)) != 0 || readyOps == 0) {
                //æœ¬æ–‡é‡ç‚¹å¤„ç†OP_ACCEPTäº‹ä»¶
                unsafe.read();
            }
        } catch (CancelledKeyException ignored) {
            unsafe.close(unsafe.voidPromise());
        }
    }

}
</code></pre></div><ul><li>å¤„ç†IOå°±ç»ªäº‹ä»¶çš„å…¥å£å‡½æ•°<code>processSelectedKey</code>ä¸­çš„å‚æ•°<code>AbstractNioChannel ch</code>æ­£æ˜¯NettyæœåŠ¡ç«¯<code>NioServerSocketChannel</code>ã€‚å› ä¸ºæ­¤æ—¶çš„æ‰§è¡Œçº¿ç¨‹ä¸ºmain reactorçº¿ç¨‹ï¼Œè€Œmain reactorä¸Šæ³¨å†Œçš„æ­£æ˜¯nettyæœåŠ¡ç«¯NioServerSocketChannelè´Ÿè´£ç›‘å¬ç«¯å£åœ°å€ï¼Œæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ã€‚</li> <li>é€šè¿‡<code>ch.unsafe()</code>è·å–åˆ°çš„NioUnsafeæ“ä½œç±»æ­£æ˜¯NioServerSocketChannelä¸­å¯¹åº•å±‚JDK NIO ServerSocketChannelçš„Unsafeåº•å±‚æ“ä½œç±»ã€‚</li></ul> <blockquote><p><code>Unsafeæ¥å£</code>æ˜¯Nettyå¯¹Channelåº•å±‚æ“ä½œè¡Œä¸ºçš„å°è£…ï¼Œæ¯”å¦‚NioServerSocketChannelçš„åº•å±‚Unsafeæ“ä½œç±»å¹²çš„äº‹æƒ…å°±æ˜¯<code>ç»‘å®šç«¯å£åœ°å€</code>ï¼Œ<code>å¤„ç†OP_ACCEPTäº‹ä»¶</code>ã€‚</p></blockquote> <p>è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°ï¼ŒNettyå°†<code>OP_ACCEPTäº‹ä»¶</code>å¤„ç†çš„å…¥å£å‡½æ•°å°è£…åœ¨<code>NioServerSocketChannel</code>é‡Œçš„åº•å±‚æ“ä½œç±»Unsafeçš„<code>read</code>æ–¹æ³•ä¸­ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>è€ŒNioServerSocketChannelä¸­çš„Unsafeæ“ä½œç±»å®ç°ç±»å‹ä¸º<code>NioMessageUnsafe</code>å®šä¹‰åœ¨ä¸Šå›¾ç»§æ‰¿ç»“æ„ä¸­çš„<code>AbstractNioMessageChannelçˆ¶ç±»ä¸­</code>ã€‚</p> <p>ä¸‹é¢æˆ‘ä»¬åˆ°<code>NioMessageUnsafe#read</code>æ–¹æ³•ä¸­æ¥çœ‹ä¸‹Nettyå¯¹<code>OP_ACCPETäº‹ä»¶</code>çš„å…·ä½“å¤„ç†è¿‡ç¨‹ï¼š</p> <h2 id="_2-æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥æ ¸å¿ƒæµç¨‹æ¡†æ¶æ€»è§ˆ"><a href="#_2-æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥æ ¸å¿ƒæµç¨‹æ¡†æ¶æ€»è§ˆ" class="header-anchor">#</a> 2. æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥æ ¸å¿ƒæµç¨‹æ¡†æ¶æ€»è§ˆ</h2> <p>æˆ‘ä»¬è¿˜æ˜¯æŒ‰ç…§è€è§„çŸ©ï¼Œå…ˆä»æ•´ä½“ä¸ŠæŠŠæ•´ä¸ªOP_ACCEPTäº‹ä»¶çš„é€»è¾‘å¤„ç†æ¡†æ¶æå–å‡ºæ¥ï¼Œè®©å¤§å®¶å…ˆæ€»ä½“ä¿¯è§†ä¸‹æµç¨‹å…¨è²Œï¼Œç„¶ååœ¨é’ˆå¯¹æ¯ä¸ªæ ¸å¿ƒç‚¹ä½è¿›è¡Œå„ä¸ªå‡»ç ´ã€‚</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiaDjWPOibC4yyvicZOQROz0VprRQdxN0scINPgOrCAVGxL1bUoV6ia4YJXQ/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥.png</p> <p>main reactorçº¿ç¨‹æ˜¯åœ¨ä¸€ä¸ª<code>do...while{...}</code>å¾ªç¯read loopä¸­ä¸æ–­çš„è°ƒç”¨JDK NIO <code>serverSocketChannel.accept()</code>æ–¹æ³•æ¥æ¥æ”¶å®Œæˆä¸‰æ¬¡æ¡æ‰‹çš„å®¢æˆ·ç«¯è¿æ¥<code>NioSocketChannel</code>çš„ï¼Œå¹¶å°†æ¥æ”¶åˆ°çš„å®¢æˆ·ç«¯è¿æ¥NioSocketChannelä¸´æ—¶ä¿å­˜åœ¨<code>List&lt;Object&gt; readBuf</code>é›†åˆä¸­ï¼Œåç»­ä¼šæœåŠ¡ç«¯NioServerSocketChannelçš„pipelineä¸­é€šè¿‡ChannelReadäº‹ä»¶æ¥ä¼ é€’ï¼Œæœ€ç»ˆä¼šåœ¨ServerBootstrapAcceptorè¿™ä¸ªChannelHandlerä¸­è¢«å¤„ç†åˆå§‹åŒ–ï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ°Sub Reator Groupä¸­ã€‚</p> <p>è¿™é‡Œçš„read loopå¾ªç¯ä¼šè¢«é™å®šåªèƒ½è¯»å–<strong>16æ¬¡</strong>ï¼Œå½“main reactorä»NioServerSocketChannelä¸­è¯»å–å®¢æˆ·ç«¯è¿æ¥NioSocketChannelçš„æ¬¡æ•°è¾¾åˆ°<strong>16æ¬¡</strong>ä¹‹åï¼Œæ— è®ºæ­¤æ—¶æ˜¯å¦è¿˜æœ‰å®¢æˆ·ç«¯è¿æ¥éƒ½ä¸èƒ½åœ¨ç»§ç»­è¯»å–äº†ã€‚</p> <p>å› ä¸ºæˆ‘ä»¬åœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484087&amp;idx=1&amp;sn=0c065780e0f05c23c8e6465ede86cba0&amp;chksm=ce77c4f0f9004de63be369a664105708bc5975b52993f4a6df223caed34cc1ef6185a16acd75&amp;token=997171731&amp;lang=zh_CN&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€Šä¸€æ–‡èŠé€Nettyæ ¸å¿ƒå¼•æ“Reactorçš„è¿è½¬æ¶æ„ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸€æ–‡ä¸­æåˆ°ï¼Œnettyå¯¹reactorçº¿ç¨‹å‹æ¦¨çš„æ¯”è¾ƒç‹ ï¼Œè¦å¹²çš„äº‹æƒ…å¾ˆå¤šï¼Œé™¤äº†è¦ç›‘å¬è½®è¯¢IOå°±ç»ªäº‹ä»¶ï¼Œå¤„ç†IOå°±ç»ªäº‹ä»¶ï¼Œè¿˜éœ€è¦æ‰§è¡Œç”¨æˆ·å’Œnettyæ¡†æ¶æœ¬çœæäº¤çš„å¼‚æ­¥ä»»åŠ¡å’Œå®šæ—¶ä»»åŠ¡ã€‚</p> <p>æ‰€ä»¥è¿™é‡Œçš„main reactorçº¿ç¨‹ä¸èƒ½åœ¨read loopä¸­æ— é™åˆ¶çš„æ‰§è¡Œä¸‹å»ï¼Œå› ä¸ºè¿˜éœ€è¦åˆ†é…æ—¶é—´å»æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œä¸èƒ½å› ä¸ºæ— é™åˆ¶çš„æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥è€Œè€½è¯¯äº†å¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œã€‚æ‰€ä»¥è¿™é‡Œå°†read loopçš„å¾ªç¯æ¬¡æ•°é™å®šä¸º16æ¬¡ã€‚</p> <p>å¦‚æœmain reactorçº¿ç¨‹åœ¨read loopä¸­è¯»å–å®¢æˆ·ç«¯è¿æ¥NioSocketChannelçš„æ¬¡æ•°å·²ç»æ»¡äº†16æ¬¡ï¼Œå³ä½¿æ­¤æ—¶è¿˜æœ‰å®¢æˆ·ç«¯è¿æ¥æœªæ¥æ”¶ï¼Œé‚£ä¹ˆmain reactorçº¿ç¨‹ä¹Ÿä¸ä¼šå†å»æ¥æ”¶äº†ï¼Œè€Œæ˜¯è½¬å»æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œå½“å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œè¿˜ä¼šåœ¨å›æ¥æ‰§è¡Œå‰©ä½™æ¥æ”¶è¿æ¥çš„ä»»åŠ¡ã€‚</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiavrDh48SPMAM6BFPzvme6iceQT8aibcKY54GLfSOm2F7yCqynlkI9HkOg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">Reactorçº¿ç¨‹è¿è¡Œæ—¶ç»“æ„.png</p> <p>main reactorçº¿ç¨‹é€€å‡ºread loopå¾ªç¯çš„æ¡ä»¶æœ‰ä¸¤ä¸ªï¼š</p> <ol><li>åœ¨é™å®šçš„16æ¬¡è¯»å–ä¸­ï¼Œå·²ç»æ²¡æœ‰æ–°çš„å®¢æˆ·ç«¯è¿æ¥è¦æ¥æ”¶äº†ã€‚é€€å‡ºå¾ªç¯ã€‚</li> <li>ä»NioServerSocketChannelä¸­è¯»å–å®¢æˆ·ç«¯è¿æ¥çš„æ¬¡æ•°è¾¾åˆ°äº†16æ¬¡ï¼Œæ— è®ºæ­¤æ—¶æ˜¯å¦è¿˜æœ‰å®¢æˆ·ç«¯è¿æ¥éƒ½éœ€è¦é€€å‡ºå¾ªç¯ã€‚</li></ol> <p>ä»¥ä¸Šå°±æ˜¯Nettyåœ¨æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥æ—¶çš„æ•´ä½“æ ¸å¿ƒé€»è¾‘ï¼Œä¸‹é¢ç¬”è€…å°†è¿™éƒ¨åˆ†é€»è¾‘çš„æ ¸å¿ƒæºç å®ç°æ¡†æ¶æå–å‡ºæ¥ï¼Œæ–¹ä¾¿å¤§å®¶æ ¹æ®ä¸Šè¿°æ ¸å¿ƒé€»è¾‘ä¸æºç ä¸­çš„å¤„ç†æ¨¡å—å¯¹åº”èµ·æ¥ï¼Œè¿˜æ˜¯é‚£å¥è¯ï¼Œè¿™é‡Œåªéœ€è¦æ€»ä½“æŠŠæ¡æ ¸å¿ƒå¤„ç†æµç¨‹ï¼Œä¸éœ€è¦è¯»æ‡‚æ¯ä¸€è¡Œä»£ç ï¼Œç¬”è€…ä¼šåœ¨æ–‡ç« çš„åè¾¹åˆ†æ¨¡å—æ¥å„ä¸ªå‡»ç ´å®ƒä»¬ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public abstract class AbstractNioMessageChannel extends AbstractNioChannel {

  private final class NioMessageUnsafe extends AbstractNioUnsafe {

        //å­˜æ”¾è¿æ¥å»ºç«‹åï¼Œåˆ›å»ºçš„å®¢æˆ·ç«¯SocketChannel
        private final List&lt;Object&gt; readBuf = new ArrayList&lt;Object&gt;();

        @Override
        public void read() {
            //å¿…é¡»åœ¨Main Reactorçº¿ç¨‹ä¸­æ‰§è¡Œ
            assert eventLoop().inEventLoop();
            //æ³¨æ„ä¸‹é¢çš„configå’Œpipelineéƒ½æ˜¯æœåŠ¡ç«¯ServerSocketChannelä¸­çš„
            final ChannelConfig config = config();
            final ChannelPipeline pipeline = pipeline();
            //åˆ›å»ºæ¥æ”¶æ•°æ®Bufferåˆ†é…å™¨ï¼ˆç”¨äºåˆ†é…å®¹é‡å¤§å°åˆé€‚çš„byteBufferç”¨æ¥å®¹çº³æ¥æ”¶æ•°æ®ï¼‰
            //åœ¨æ¥æ”¶è¿æ¥çš„åœºæ™¯ä¸­ï¼Œè¿™é‡Œçš„allocHandleåªæ˜¯ç”¨äºæ§åˆ¶read loopçš„å¾ªç¯è¯»å–åˆ›å»ºè¿æ¥çš„æ¬¡æ•°ã€‚
            final RecvByteBufAllocator.Handle allocHandle = unsafe().recvBufAllocHandle();
            allocHandle.reset(config);

            boolean closed = false;
            Throwable exception = null;
            try {
                try {
                    do {
                        //åº•å±‚è°ƒç”¨NioServerSocketChannel-&gt;doReadMessages åˆ›å»ºå®¢æˆ·ç«¯SocketChannel
                        int localRead = doReadMessages(readBuf);

                        //å·²æ— æ–°çš„è¿æ¥å¯æ¥æ”¶åˆ™é€€å‡ºread loop
                        if (localRead == 0) {
                            break;
                        }
                        if (localRead &lt; 0) {
                            closed = true;
                            break;
                        }
                        //ç»Ÿè®¡åœ¨å½“å‰äº‹ä»¶å¾ªç¯ä¸­å·²ç»è¯»å–åˆ°å¾—Messageæ•°é‡ï¼ˆåˆ›å»ºè¿æ¥çš„ä¸ªæ•°ï¼‰
                        allocHandle.incMessagesRead(localRead);
                    } while (allocHandle.continueReading());//åˆ¤æ–­æ˜¯å¦å·²ç»è¯»æ»¡16æ¬¡
                } catch (Throwable t) {
                    exception = t;
                }

                int size = readBuf.size();
                for (int i = 0; i &lt; size; i ++) {
                    readPending = false;
                    //åœ¨NioServerSocketChannelå¯¹åº”çš„pipelineä¸­ä¼ æ’­ChannelReadäº‹ä»¶
                    //åˆå§‹åŒ–å®¢æˆ·ç«¯SocketChannelï¼Œå¹¶å°†å…¶ç»‘å®šåˆ°Sub Reactorçº¿ç¨‹ç»„ä¸­çš„ä¸€ä¸ªReactorä¸Š
                    pipeline.fireChannelRead(readBuf.get(i));
                }
                //æ¸…é™¤æœ¬æ¬¡accept åˆ›å»ºçš„å®¢æˆ·ç«¯SocketChannelé›†åˆ
                readBuf.clear();
                allocHandle.readComplete();
                //è§¦å‘readCompleteäº‹ä»¶ä¼ æ’­
                pipeline.fireChannelReadComplete();
                ....................çœç•¥............
            } finally {
                ....................çœç•¥............
            }
        }
    }
  }
}
</code></pre></div><p>è¿™é‡Œé¦–å…ˆè¦é€šè¿‡æ–­è¨€<code>assert eventLoop().inEventLoop()</code>ç¡®ä¿å¤„ç†æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥çš„çº¿ç¨‹å¿…é¡»ä¸ºMain Reactor çº¿ç¨‹ã€‚</p> <p>è€Œmain reactorä¸­ä¸»è¦æ³¨å†Œçš„æ˜¯æœåŠ¡ç«¯NioServerSocketChannelï¼Œä¸»è¦è´Ÿè´£å¤„ç†<code>OP_ACCEPTäº‹ä»¶</code>ï¼Œæ‰€ä»¥å½“å‰main reactorçº¿ç¨‹æ˜¯åœ¨NioServerSocketChannelä¸­æ‰§è¡Œæ¥æ”¶è¿æ¥çš„å·¥ä½œã€‚</p> <p>æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬é€šè¿‡<code>config()</code>è·å–åˆ°çš„æ˜¯NioServerSocketChannelçš„å±æ€§é…ç½®ç±»<code>NioServerSocketChannelConfig</code>,å®ƒæ˜¯åœ¨Reactorçš„å¯åŠ¨é˜¶æ®µè¢«åˆ›å»ºå‡ºæ¥çš„ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    public NioServerSocketChannel(ServerSocketChannel channel) {
        //çˆ¶ç±»AbstractNioChannelä¸­ä¿å­˜JDK NIOåŸç”ŸServerSocketChannelä»¥åŠè¦ç›‘å¬çš„äº‹ä»¶OP_ACCEPT
        super(null, channel, SelectionKey.OP_ACCEPT);
        //DefaultChannelConfigä¸­è®¾ç½®ç”¨äºChannelæ¥æ”¶æ•°æ®ç”¨çš„buffer-&gt;AdaptiveRecvByteBufAllocator
        config = new NioServerSocketChannelConfig(this, javaChannel().socket());
    }
</code></pre></div><p>åŒç†è¿™é‡Œé€šè¿‡<code>pipeline()</code>è·å–åˆ°çš„ä¹Ÿæ˜¯NioServerSocketChannelä¸­çš„<code>pipeline</code>ã€‚å®ƒä¼šåœ¨NioServerSocketChannelå‘main reactoræ³¨å†ŒæˆåŠŸä¹‹åè¢«åˆå§‹åŒ–ã€‚</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiaLCnvGuX5Vnkyf8vov0T9bwuSrXAQAKQWoCQjzhgBbkfQ52iaDe6282Q/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">ServerChannelPipelineå®Œæ•´ç»“æ„.png</p> <p>å‰è¾¹æåˆ°main reactorçº¿ç¨‹ä¼šè¢«é™å®šåªèƒ½åœ¨read loopä¸­å‘NioServerSocketChannelè¯»å–16æ¬¡å®¢æˆ·ç«¯è¿æ¥ï¼Œæ‰€ä»¥åœ¨å¼€å§‹read loopä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªèƒ½å¤Ÿä¿å­˜è®°å½•è¯»å–æ¬¡æ•°çš„å¯¹è±¡ï¼Œåœ¨æ¯æ¬¡read loopå¾ªç¯ä¹‹åï¼Œå¯ä»¥æ ¹æ®è¿™ä¸ªå¯¹è±¡æ¥åˆ¤æ–­æ˜¯å¦ç»“æŸread loopã€‚</p> <p>è¿™ä¸ªå¯¹è±¡å°±æ˜¯è¿™é‡Œçš„ <code>RecvByteBufAllocator.Handle allocHandle</code>ä¸“é—¨ç”¨äºç»Ÿè®¡read loopä¸­æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥çš„æ¬¡æ•°ï¼Œä»¥åŠåˆ¤æ–­æ˜¯å¦è¯¥ç»“æŸread loopè½¬å»æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ã€‚</p> <p>å½“è¿™ä¸€åˆ‡å‡†å¤‡å°±ç»ªä¹‹åï¼Œmain reactorçº¿ç¨‹å°±å¼€å§‹åœ¨<code>do{....}while(...)</code>å¾ªç¯ä¸­æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥äº†ã€‚</p> <p>åœ¨ read loopä¸­é€šè¿‡è°ƒç”¨<code>doReadMessageså‡½æ•°</code>æ¥æ”¶å®Œæˆä¸‰æ¬¡æ¡æ‰‹çš„å®¢æˆ·ç«¯è¿æ¥ï¼Œåº•å±‚ä¼šè°ƒç”¨åˆ°JDK NIO ServerSocketChannelçš„acceptæ–¹æ³•ï¼Œä»å†…æ ¸å…¨è¿æ¥é˜Ÿåˆ—ä¸­å–å‡ºå®¢æˆ·ç«¯è¿æ¥ã€‚</p> <p>è¿”å›å€¼<code>localRead</code>è¡¨ç¤ºæ¥æ”¶åˆ°äº†å¤šå°‘å®¢æˆ·ç«¯è¿æ¥ï¼Œå®¢æˆ·ç«¯è¿æ¥é€šè¿‡acceptæ–¹æ³•åªä¼šä¸€ä¸ªä¸€ä¸ªçš„æ¥æ”¶ï¼Œæ‰€ä»¥è¿™é‡Œçš„<code>localRead</code>æ­£å¸¸æƒ…å†µä¸‹éƒ½ä¼šè¿”å›<code>1</code>ï¼Œå½“<code>localRead &lt;= 0</code>æ—¶æ„å‘³ç€å·²ç»æ²¡æœ‰æ–°çš„å®¢æˆ·ç«¯è¿æ¥å¯ä»¥æ¥æ”¶äº†ï¼Œæœ¬æ¬¡main reactoræ¥æ”¶å®¢æˆ·ç«¯çš„ä»»åŠ¡åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œè·³å‡ºread loopã€‚å¼€å§‹æ–°çš„ä¸€è½®IOäº‹ä»¶çš„ç›‘å¬å¤„ç†ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    public static SocketChannel accept(final ServerSocketChannel serverSocketChannel) throws IOException {
        try {
            return AccessController.doPrivileged(new PrivilegedExceptionAction&lt;SocketChannel&gt;() {
                @Override
                public SocketChannel run() throws IOException {
                    return serverSocketChannel.accept();
                }
            });
        } catch (PrivilegedActionException e) {
            throw (IOException) e.getCause();
        }
    }
</code></pre></div><p>éšåä¼šå°†æ¥æ”¶åˆ°çš„å®¢æˆ·ç«¯è¿æ¥å æ—¶å­˜æ”¾åˆ°<code>List&lt;Object&gt; readBuf</code>é›†åˆä¸­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>  private final class NioMessageUnsafe extends AbstractNioUnsafe {

        //å­˜æ”¾è¿æ¥å»ºç«‹åï¼Œåˆ›å»ºçš„å®¢æˆ·ç«¯SocketChannel
        private final List&lt;Object&gt; readBuf = new ArrayList&lt;Object&gt;();
}
</code></pre></div><p>è°ƒç”¨<code>allocHandle.incMessagesRead</code>ç»Ÿè®¡æœ¬æ¬¡äº‹ä»¶å¾ªç¯ä¸­æ¥æ”¶åˆ°çš„å®¢æˆ·ç«¯è¿æ¥ä¸ªæ•°ï¼Œæœ€ååœ¨read loopæœ«å°¾é€šè¿‡<code>allocHandle.continueReading</code>åˆ¤æ–­æ˜¯å¦è¾¾åˆ°äº†é™å®šçš„16æ¬¡ã€‚ä»è€Œå†³å®šmain reactorçº¿ç¨‹æ˜¯ç»§ç»­æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥è¿˜æ˜¯è½¬å»æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ã€‚</p> <p>main reactorçº¿ç¨‹é€€å‡ºread loopçš„ä¸¤ä¸ªæ¡ä»¶ï¼š</p> <ol><li>åœ¨é™å®šçš„16æ¬¡è¯»å–ä¸­ï¼Œå·²ç»æ²¡æœ‰æ–°çš„å®¢æˆ·ç«¯è¿æ¥è¦æ¥æ”¶äº†ã€‚é€€å‡ºå¾ªç¯ã€‚</li> <li>ä»NioServerSocketChannelä¸­è¯»å–å®¢æˆ·ç«¯è¿æ¥çš„æ¬¡æ•°è¾¾åˆ°äº†16æ¬¡ï¼Œæ— è®ºæ­¤æ—¶æ˜¯å¦è¿˜æœ‰å®¢æˆ·ç«¯è¿æ¥éƒ½éœ€è¦é€€å‡ºå¾ªç¯ã€‚</li></ol> <p>å½“æ»¡è¶³ä»¥ä¸Šä¸¤ä¸ªé€€å‡ºæ¡ä»¶æ—¶ï¼Œmain reactorçº¿ç¨‹å°±ä¼šé€€å‡ºread loopï¼Œç”±äºåœ¨read loopä¸­æ¥æ”¶åˆ°çš„å®¢æˆ·ç«¯è¿æ¥å…¨éƒ¨æš‚å­˜åœ¨<code>List&lt;Object&gt; readBuf</code>é›†åˆä¸­,éšåå¼€å§‹éå†readBufï¼Œåœ¨NioServerSocketChannelçš„pipelineä¸­ä¼ æ’­ChannelReadäº‹ä»¶ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>                int size = readBuf.size();
                for (int i = 0; i &lt; size; i ++) {
                    readPending = false;
                    //NioServerSocketChannelå¯¹åº”çš„pipelineä¸­ä¼ æ’­readäº‹ä»¶
                    //io.netty.bootstrap.ServerBootstrap.ServerBootstrapAcceptor.channelRead
                    //åˆå§‹åŒ–å®¢æˆ·ç«¯SocketChannelï¼Œå¹¶å°†å…¶ç»‘å®šåˆ°Sub Reactorçº¿ç¨‹ç»„ä¸­çš„ä¸€ä¸ªReactorä¸Š
                    pipeline.fireChannelRead(readBuf.get(i));
                }
</code></pre></div><p>æœ€ç»ˆpipelineä¸­çš„ChannelHandler(ServerBootstrapAcceptor)ä¼šå“åº”ChannelReadäº‹ä»¶ï¼Œå¹¶åœ¨ç›¸åº”å›è°ƒå‡½æ•°ä¸­åˆå§‹åŒ–å®¢æˆ·ç«¯NioSocketChannelï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ°Sub Reactor Groupä¸­ã€‚æ­¤åå®¢æˆ·ç«¯NioSocketChannelç»‘å®šåˆ°çš„sub reactorå°±å¼€å§‹ç›‘å¬å¤„ç†å®¢æˆ·ç«¯è¿æ¥ä¸Šçš„è¯»å†™äº‹ä»¶äº†ã€‚</p> <p>Nettyæ•´ä¸ªæ¥æ”¶å®¢æˆ·ç«¯çš„é€»è¾‘è¿‡ç¨‹å¦‚ä¸‹å›¾æ­¥éª¤1ï¼Œ2ï¼Œ3æ‰€ç¤ºã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)nettyä¸­çš„reactor.png</p> <p>ä»¥ä¸Šå†…å®¹å°±æ˜¯ç¬”è€…æå–å‡ºæ¥çš„æ•´ä½“æµç¨‹æ¡†æ¶ï¼Œä¸‹é¢æˆ‘ä»¬æ¥å°†å…¶ä¸­æ¶‰åŠåˆ°çš„é‡è¦æ ¸å¿ƒæ¨¡å—æ‹†å¼€ï¼Œä¸€ä¸ªä¸€ä¸ªè¯¦ç»†è§£è¯»ä¸‹ã€‚</p> <h2 id="_3-recvbytebufallocatorç®€ä»‹"><a href="#_3-recvbytebufallocatorç®€ä»‹" class="header-anchor">#</a> 3. RecvByteBufAllocatorç®€ä»‹</h2> <p>Reactoråœ¨å¤„ç†å¯¹åº”Channelä¸Šçš„IOæ•°æ®æ—¶ï¼Œéƒ½ä¼šé‡‡ç”¨ä¸€ä¸ª<code>ByteBuffer</code>æ¥æ¥æ”¶Channelä¸Šçš„IOæ•°æ®ã€‚è€Œæœ¬å°èŠ‚è¦ä»‹ç»çš„RecvByteBufAllocatoræ­£æ˜¯ç”¨æ¥åˆ†é…ByteBufferçš„ä¸€ä¸ªåˆ†é…å™¨ã€‚</p> <p>è¿˜è®°å¾—è¿™ä¸ª<code>RecvByteBufAllocator</code>åœ¨å“ªé‡Œè¢«åˆ›å»ºçš„å—ï¼Ÿï¼Ÿ</p> <p>åœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247483907&amp;idx=1&amp;sn=084c470a8fe6234c2c9461b5f713ff30&amp;chksm=ce77c444f9004d52e7c6244bee83479070effb0bc59236df071f4d62e91e25f01715fca53696&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€ŠèŠèŠNettyé‚£äº›äº‹å„¿ä¹‹Reactoråœ¨Nettyä¸­çš„å®ç°(åˆ›å»ºç¯‡)ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸€æ–‡ä¸­ï¼Œåœ¨ä»‹ç»<code>NioServerSocketChannel</code>çš„åˆ›å»ºè¿‡ç¨‹ä¸­æåˆ°ï¼Œå¯¹åº”Channelçš„é…ç½®ç±»NioServerSocketChannelConfigä¹Ÿä¼šéšç€NioServerSocketChannelçš„åˆ›å»ºè€Œåˆ›å»ºã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    public NioServerSocketChannel(ServerSocketChannel channel) {
        super(null, channel, SelectionKey.OP_ACCEPT);
        config = new NioServerSocketChannelConfig(this, javaChannel().socket());
    }
</code></pre></div><p>åœ¨åˆ›å»º<code>NioServerSocketChannelConfig</code>çš„è¿‡ç¨‹ä¸­ä¼šåˆ›å»º<code>RecvByteBufAllocator</code>ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>   public DefaultChannelConfig(Channel channel) {
            this(channel, new AdaptiveRecvByteBufAllocator());
    }
</code></pre></div><p>è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°NioServerSocketChannelä¸­çš„RecvByteBufAllocatorå®é™…ç±»å‹ä¸º<code>AdaptiveRecvByteBufAllocator</code>ï¼Œé¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªç±»å‹çš„RecvByteBufAllocatorå¯ä»¥æ ¹æ®Channelä¸Šæ¯æ¬¡åˆ°æ¥çš„IOæ•°æ®å¤§å°æ¥è‡ªé€‚åº”åŠ¨æ€è°ƒæ•´ByteBufferçš„å®¹é‡ã€‚</p> <p>å¯¹äºæœåŠ¡ç«¯NioServerSocketChannelæ¥è¯´ï¼Œå®ƒä¸Šè¾¹çš„IOæ•°æ®å°±æ˜¯å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œå®ƒçš„é•¿åº¦å’Œç±»å‹éƒ½æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥åœ¨æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥çš„æ—¶å€™å¹¶ä¸éœ€è¦è¿™æ ·çš„ä¸€ä¸ªByteBufferæ¥æ¥æ”¶ï¼Œæˆ‘ä»¬ä¼šå°†æ¥æ”¶åˆ°çš„å®¢æˆ·ç«¯è¿æ¥å­˜æ”¾åœ¨<code>List&lt;Object&gt; readBuf</code>é›†åˆä¸­</p> <p>å¯¹äºå®¢æˆ·ç«¯NioSocketChannelæ¥è¯´ï¼Œå®ƒä¸Šè¾¹çš„IOæ•°æ®æ—¶å®¢æˆ·ç«¯å‘é€æ¥çš„ç½‘ç»œæ•°æ®ï¼Œé•¿åº¦æ˜¯ä¸å®šçš„ï¼Œæ‰€ä»¥æ‰ä¼šéœ€è¦è¿™æ ·ä¸€ä¸ªå¯ä»¥æ ¹æ®æ¯æ¬¡IOæ•°æ®çš„å¤§å°æ¥è‡ªé€‚åº”åŠ¨æ€è°ƒæ•´å®¹é‡çš„ByteBufferæ¥æ¥æ”¶ã€‚</p> <p>é‚£ä¹ˆçœ‹èµ·æ¥è¿™ä¸ªRecvByteBufAllocatorå’Œæœ¬æ–‡çš„ä¸»é¢˜ä¸æ˜¯å¾ˆå…³è”ï¼Œå› ä¸ºåœ¨æ¥æ”¶è¿æ¥çš„è¿‡ç¨‹ä¸­å¹¶ä¸ä¼šæ€ä¹ˆç”¨åˆ°å®ƒï¼Œè¿™ä¸ªç±»ç¬”è€…è¿˜ä¼šåœ¨åé¢çš„æ–‡ç« ä¸­è¯¦ç»†ä»‹ç»ï¼Œä¹‹æ‰€ä»¥è¿™é‡ŒæŠŠå®ƒæ‹å‡ºæ¥å•ç‹¬ä»‹ç»æ˜¯å› ä¸ºå®ƒå’Œæœ¬æ–‡å¼€å¤´æåˆ°çš„Bugæœ‰å…³ç³»ï¼Œè¿™ä¸ªBugå°±æ˜¯ç”±è¿™ä¸ªç±»å¼•èµ·çš„ã€‚</p> <h3 id="_3-1-recvbytebufallocator-handleçš„è·å–"><a href="#_3-1-recvbytebufallocator-handleçš„è·å–" class="header-anchor">#</a> 3.1 RecvByteBufAllocator.Handleçš„è·å–</h3> <p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡NioServerSocketChannelä¸­çš„unsafeåº•å±‚æ“ä½œç±»æ¥è·å–RecvByteBufAllocator.Handleçš„</p> <div class="language- extra-class"><pre class="language-text"><code>final RecvByteBufAllocator.Handle allocHandle = unsafe().recvBufAllocHandle();
protected abstract class AbstractUnsafe implements Unsafe {
        @Override
        public RecvByteBufAllocator.Handle recvBufAllocHandle() {
            if (recvHandle == null) {
                recvHandle = config().getRecvByteBufAllocator().newHandle();
            }
            return recvHandle;
        }
}
</code></pre></div><p>æˆ‘ä»¬çœ‹åˆ°æœ€ç»ˆä¼šåœ¨NioServerSocketChannelçš„é…ç½®ç±»NioServerSocketChannelConfigä¸­è·å–åˆ°<code>AdaptiveRecvByteBufAllocator</code></p> <div class="language- extra-class"><pre class="language-text"><code>public class DefaultChannelConfig implements ChannelConfig {
    //ç”¨äºChannelæ¥æ”¶æ•°æ®ç”¨çš„bufferåˆ†é…å™¨  ç±»å‹ä¸ºAdaptiveRecvByteBufAllocator
    private volatile RecvByteBufAllocator rcvBufAllocator;
}
</code></pre></div><p><code>AdaptiveRecvByteBufAllocator</code>ä¸­ä¼šåˆ›å»ºè‡ªé€‚åº”åŠ¨æ€è°ƒæ•´å®¹é‡çš„ByteBufferåˆ†é…å™¨ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class AdaptiveRecvByteBufAllocator extends DefaultMaxMessagesRecvByteBufAllocator {

    @Override
    public Handle newHandle() {
        return new HandleImpl(minIndex, maxIndex, initial);
    }
    
    private final class HandleImpl extends MaxMessageHandle {
                  .................çœç•¥................
    }
}
</code></pre></div><p>è¿™é‡Œçš„<code>newHandle</code>æ–¹æ³•è¿”å›çš„å…·ä½“ç±»å‹ä¸º<code>MaxMessageHandle</code>ï¼Œè¿™ä¸ª<code>MaxMessageHandle</code>é‡Œè¾¹ä¿å­˜äº†æ¯æ¬¡ä»<code>Channel</code>ä¸­è¯»å–<code>IOæ•°æ®</code>çš„å®¹é‡æŒ‡æ ‡ï¼Œæ–¹ä¾¿ä¸‹æ¬¡è¯»å–æ—¶åˆ†é…åˆé€‚å¤§å°çš„<code>buffer</code>ã€‚</p> <p>æ¯æ¬¡åœ¨ä½¿ç”¨<code>allocHandle</code>å‰éœ€è¦è°ƒç”¨<code>allocHandle.reset(config);</code>é‡ç½®é‡Œè¾¹çš„ç»Ÿè®¡æŒ‡æ ‡ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    public abstract class MaxMessageHandle implements ExtendedHandle {
        private ChannelConfig config;
        //æ¯æ¬¡äº‹ä»¶è½®è¯¢æ—¶ï¼Œæœ€å¤šè¯»å–16æ¬¡
        private int maxMessagePerRead;
        //æœ¬æ¬¡äº‹ä»¶è½®è¯¢æ€»å…±è¯»å–çš„messageæ•°,è¿™é‡ŒæŒ‡çš„æ˜¯æ¥æ”¶è¿æ¥çš„æ•°é‡
        private int totalMessages;
        //æœ¬æ¬¡äº‹ä»¶è½®è¯¢æ€»å…±è¯»å–çš„å­—èŠ‚æ•°
        private int totalBytesRead;

       @Override
        public void reset(ChannelConfig config) {
            this.config = config;
            //é»˜è®¤æ¯æ¬¡æœ€å¤šè¯»å–16æ¬¡
            maxMessagePerRead = maxMessagesPerRead();
            totalMessages = totalBytesRead = 0;
        }
    }
</code></pre></div><ul><li><strong>maxMessagePerRead</strong>ï¼šç”¨äºæ§åˆ¶æ¯æ¬¡read loopé‡Œæœ€å¤§å¯ä»¥å¾ªç¯è¯»å–çš„æ¬¡æ•°ï¼Œé»˜è®¤ä¸º16æ¬¡ï¼Œå¯åœ¨å¯åŠ¨é…ç½®ç±»<code>ServerBootstrap</code>ä¸­é€šè¿‡<code>ChannelOption.MAX_MESSAGES_PER_READ</code>é€‰é¡¹è®¾ç½®ã€‚</li></ul> <div class="language- extra-class"><pre class="language-text"><code>ServerBootstrap b = new ServerBootstrap();
b.group(bossGroup, workerGroup)
  .channel(NioServerSocketChannel.class)
  .option(ChannelOption.MAX_MESSAGES_PER_READ, è‡ªå®šä¹‰æ¬¡æ•°)
</code></pre></div><ul><li><strong>totalMessages</strong>ï¼šç”¨äºç»Ÿè®¡read loopä¸­æ€»å…±æ¥æ”¶çš„è¿æ¥ä¸ªæ•°ï¼Œæ¯æ¬¡read loopå¾ªç¯åä¼šè°ƒç”¨<code>allocHandle.incMessagesRead</code>å¢åŠ è®°å½•æ¥æ”¶åˆ°çš„è¿æ¥ä¸ªæ•°ã€‚</li></ul> <div class="language- extra-class"><pre class="language-text"><code>        @Override
        public final void incMessagesRead(int amt) {
            totalMessages += amt;
        }
</code></pre></div><ul><li><strong>totalBytesRead</strong>ï¼šç”¨äºç»Ÿè®¡åœ¨read loopä¸­æ€»å…±æ¥æ”¶åˆ°å®¢æˆ·ç«¯è¿æ¥ä¸Šçš„æ•°æ®å¤§å°ï¼Œè¿™ä¸ªå­—æ®µä¸»è¦ç”¨äºsub reactoråœ¨æ¥æ”¶å®¢æˆ·ç«¯NioSocketChannelä¸Šçš„ç½‘ç»œæ•°æ®ç”¨çš„ï¼Œæœ¬æ–‡æˆ‘ä»¬ä»‹ç»çš„æ˜¯main reactoræ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ï¼Œæ‰€ä»¥è¿™é‡Œå¹¶ä¸ä¼šç”¨åˆ°è¿™ä¸ªå­—æ®µã€‚è¿™ä¸ªå­—æ®µä¼šåœ¨sub reactoræ¯æ¬¡è¯»å–å®ŒNioSocketChannelä¸Šçš„ç½‘ç»œæ•°æ®æ—¶å¢åŠ è®°å½•ã€‚</li></ul> <div class="language- extra-class"><pre class="language-text"><code>        @Override
        public void lastBytesRead(int bytes) {
            lastBytesRead = bytes;
            if (bytes &gt; 0) {
                totalBytesRead += bytes;
            }
        }
</code></pre></div><p>MaxMessageHandlerä¸­è¿˜æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„æ–¹æ³•å°±æ˜¯åœ¨æ¯æ¬¡read loopæœ«å°¾ä¼šè°ƒç”¨<code>allocHandle.continueReading()</code>æ–¹æ³•æ¥åˆ¤æ–­è¯»å–è¿æ¥æ¬¡æ•°æ˜¯å¦å·²æ»¡16æ¬¡ï¼Œæ¥å†³å®šmain reactorçº¿ç¨‹æ˜¯å¦é€€å‡ºå¾ªç¯ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>                  do {
                        //åº•å±‚è°ƒç”¨NioServerSocketChannel-&gt;doReadMessages åˆ›å»ºå®¢æˆ·ç«¯SocketChannel
                        int localRead = doReadMessages(readBuf);
                        if (localRead == 0) {
                            break;
                        }
                        if (localRead &lt; 0) {
                            closed = true;
                            break;
                        }
                        //ç»Ÿè®¡åœ¨å½“å‰äº‹ä»¶å¾ªç¯ä¸­å·²ç»è¯»å–åˆ°å¾—Messageæ•°é‡ï¼ˆåˆ›å»ºè¿æ¥çš„ä¸ªæ•°ï¼‰
                        allocHandle.incMessagesRead(localRead);
                    } while (allocHandle.continueReading());
</code></pre></div><p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiadlS4S4GAOnWGfc4cAFuhpziasUfsEWHxBfh3nKvLNvBAFAWEAP2sJibw/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">image.png</p> <p>çº¢æ¡†ä¸­åœˆå‡ºæ¥çš„ä¸¤ä¸ªåˆ¤æ–­æ¡ä»¶å’Œæœ¬æ–‡ä¸»é¢˜æ— å…³ï¼Œæˆ‘ä»¬è¿™é‡Œä¸éœ€è¦å…³æ³¨ï¼Œç¬”è€…ä¼šåœ¨åé¢çš„æ–‡ç« è¯¦ç»†ä»‹ç»ã€‚</p> <ul><li><code>totalMessages &lt; maxMessagePerRead</code>ï¼šåœ¨æœ¬æ–‡çš„æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥åœºæ™¯ä¸­ï¼Œè¿™ä¸ªæ¡ä»¶ç”¨äºåˆ¤æ–­main reactorçº¿ç¨‹åœ¨read loopä¸­çš„è¯»å–æ¬¡æ•°æ˜¯å¦è¶…è¿‡äº†16æ¬¡ã€‚å¦‚æœè¶…è¿‡16æ¬¡å°±ä¼šè¿”å›falseï¼Œmain reactorçº¿ç¨‹é€€å‡ºå¾ªç¯ã€‚</li> <li><code>totalBytesRead &gt; 0</code>ï¼šç”¨äºåˆ¤æ–­å½“å®¢æˆ·ç«¯NioSocketChannelä¸Šçš„OP_READäº‹ä»¶æ´»è·ƒæ—¶ï¼Œsub reactorçº¿ç¨‹åœ¨read loopä¸­æ˜¯å¦è¯»å–åˆ°äº†ç½‘ç»œæ•°æ®ã€‚</li></ul> <p>ä»¥ä¸Šå†…å®¹å°±æ˜¯RecvByteBufAllocator.Handleåœ¨æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥åœºæ™¯ä¸‹çš„ä½œç”¨ï¼Œå¤§å®¶è¿™é‡Œä»”ç»†çœ‹ä¸‹è¿™ä¸ª<code>allocHandle.continueReading()</code>æ–¹æ³•é€€å‡ºå¾ªç¯çš„åˆ¤æ–­æ¡ä»¶ï¼Œå†ç»“åˆæ•´ä¸ª<code>do{....}while(...)</code>æ¥æ”¶è¿æ¥å¾ªç¯ä½“ï¼Œæ„Ÿå—ä¸‹æ˜¯å¦å“ªé‡Œæœ‰äº›ä¸å¯¹åŠ²ï¼ŸBugå³å°†å‡ºç°~~~</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNia73S7DDn065yic2ibMIJ2CB70d9VuqkWqj9ydiaAk4yDaKbHZ5Z3rlfQfA/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">image.png</p> <h2 id="_4-å•Šå“ˆ-bug"><a href="#_4-å•Šå“ˆ-bug" class="header-anchor">#</a> 4. å•Šå“ˆï¼ï¼Bug ! !</h2> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNia1WWpXwfWKkgmhBW2wuBConIInzvqErmKhCjykxao8tPMQq4aMzRMWw/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">image.png</p> <p>nettyä¸è®ºæ˜¯åœ¨æœ¬æ–‡ä¸­å¤„ç†æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥çš„åœºæ™¯è¿˜æ˜¯åœ¨å¤„ç†æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ä¸Šçš„ç½‘ç»œæ•°æ®åœºæ™¯éƒ½ä¼šåœ¨ä¸€ä¸ª<code>do{....}while(...)</code>å¾ªç¯read loopä¸­ä¸æ–­çš„å¤„ç†ã€‚</p> <p>åŒæ—¶ä¹Ÿéƒ½ä¼šåˆ©ç”¨åœ¨ä¸Šä¸€å°èŠ‚ä¸­ä»‹ç»çš„<code>RecvByteBufAllocator.Handle</code>æ¥è®°å½•æ¯æ¬¡read loopæ¥æ”¶åˆ°çš„è¿æ¥ä¸ªæ•°å’Œä»è¿æ¥ä¸Šè¯»å–åˆ°çš„ç½‘ç»œæ•°æ®å¤§å°ã€‚</p> <p>ä»è€Œåœ¨read loopçš„æœ«å°¾éƒ½ä¼šé€šè¿‡<code>allocHandle.continueReading()</code>æ–¹æ³•åˆ¤æ–­æ˜¯å¦åº”è¯¥é€€å‡ºread loopå¾ªç¯ç»“æŸè¿æ¥çš„æ¥æ”¶æµç¨‹æˆ–è€…æ˜¯ç»“æŸè¿æ¥ä¸Šæ•°æ®çš„è¯»å–æµç¨‹ã€‚</p> <p>æ— è®ºæ˜¯ç”¨äºæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥çš„main reactorä¹Ÿå¥½è¿˜æ˜¯ç”¨äºæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ä¸Šçš„ç½‘ç»œæ•°æ®çš„sub reactorä¹Ÿå¥½ï¼Œå®ƒä»¬çš„è¿è¡Œæ¡†æ¶éƒ½æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡æ˜¯å…·ä½“åˆ†å·¥ä¸åŒã€‚</p> <p>æ‰€ä»¥nettyè¿™é‡Œæƒ³ç”¨ç»Ÿä¸€çš„<code>RecvByteBufAllocator.Handle</code>æ¥å¤„ç†ä»¥ä¸Šä¸¤ç§åœºæ™¯ã€‚</p> <p>è€Œ<code>RecvByteBufAllocator.Handle</code>ä¸­çš„<code>totalBytesRead</code>å­—æ®µä¸»è¦è®°å½•sub reactorçº¿ç¨‹åœ¨å¤„ç†å®¢æˆ·ç«¯NioSocketChannelä¸­OP_READäº‹ä»¶æ´»è·ƒæ—¶ï¼Œæ€»å…±åœ¨read loopä¸­è¯»å–åˆ°çš„ç½‘ç»œæ•°æ®ï¼Œè€Œè¿™é‡Œæ˜¯main reactorçº¿ç¨‹åœ¨æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥æ‰€ä»¥è¿™ä¸ªå­—æ®µå¹¶ä¸ä¼šè¢«è®¾ç½®ã€‚totalBytesReadå­—æ®µçš„å€¼åœ¨æœ¬æ–‡ä¸­æ°¸è¿œä¼šæ˜¯<code>0</code>ã€‚</p> <p>æ‰€ä»¥æ— è®ºåŒæ—¶æœ‰å¤šå°‘ä¸ªå®¢æˆ·ç«¯å¹¶å‘è¿æ¥åˆ°æœåŠ¡ç«¯ä¸Šï¼Œåœ¨æ¥æ”¶è¿æ¥çš„è¿™ä¸ªread loopä¸­æ°¸è¿œåªä¼šæ¥å—ä¸€ä¸ªè¿æ¥å°±ä¼šé€€å‡ºå¾ªç¯ï¼Œå› ä¸º<code>allocHandle.continueReading()æ–¹æ³•</code>ä¸­çš„åˆ¤æ–­æ¡ä»¶<code>totalBytesRead &gt; 0</code>æ°¸è¿œä¼šè¿”å›<code>false</code>ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>                  do {
                        //åº•å±‚è°ƒç”¨NioServerSocketChannel-&gt;doReadMessages åˆ›å»ºå®¢æˆ·ç«¯SocketChannel
                        int localRead = doReadMessages(readBuf);
                        if (localRead == 0) {
                            break;
                        }
                        if (localRead &lt; 0) {
                            closed = true;
                            break;
                        }
                        //ç»Ÿè®¡åœ¨å½“å‰äº‹ä»¶å¾ªç¯ä¸­å·²ç»è¯»å–åˆ°å¾—Messageæ•°é‡ï¼ˆåˆ›å»ºè¿æ¥çš„ä¸ªæ•°ï¼‰
                        allocHandle.incMessagesRead(localRead);
                    } while (allocHandle.continueReading());
</code></pre></div><p><strong>è€Œnettyçš„æœ¬æ„æ˜¯åœ¨è¿™ä¸ªread loopå¾ªç¯ä¸­å°½å¯èƒ½å¤šçš„å»æ¥æ”¶å®¢æˆ·ç«¯çš„å¹¶å‘è¿æ¥ï¼ŒåŒæ—¶åˆä¸å½±å“main reactorçº¿ç¨‹æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ã€‚ä½†æ˜¯ç”±äºè¿™ä¸ªBugï¼Œmain reactoråœ¨è¿™ä¸ªå¾ªç¯ä¸­åªæ‰§è¡Œä¸€æ¬¡å°±ç»“æŸäº†ã€‚è¿™ä¹Ÿä¸€å®šç¨‹åº¦ä¸Šå°±å½±å“äº†nettyçš„åå</strong>ã€‚</p> <p>è®©æˆ‘ä»¬æƒ³è±¡ä¸‹è¿™æ ·çš„ä¸€ä¸ªåœºæ™¯ï¼Œå½“æœ‰16ä¸ªå®¢æˆ·ç«¯åŒæ—¶å¹¶å‘è¿æ¥åˆ°äº†æœåŠ¡ç«¯ï¼Œè¿™æ—¶NioServerSocketChannelä¸Šçš„<code>OP_ACCEPTäº‹ä»¶</code>æ´»è·ƒï¼Œmain reactorä»Selectorä¸Šè¢«å”¤é†’ï¼Œéšåæ‰§è¡Œ<code>OP_ACCEPTäº‹ä»¶</code>çš„å¤„ç†ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public final class NioEventLoop extends SingleThreadEventLoop {
    @Override
    protected void run() {
        int selectCnt = 0;
        for (;;) {
            try { 
                int strategy;
                try {
                    strategy = selectStrategy.calculateStrategy(selectNowSupplier, hasTasks());
                    switch (strategy) {
                    case SelectStrategy.CONTINUE:                  
                          ............çœç•¥.........
                    case SelectStrategy.BUSY_WAIT:

                          ............çœç•¥.........
                    case SelectStrategy.SELECT:
                            ............ç›‘å¬è½®è¯¢IOäº‹ä»¶.........
                    default:
                    }
                } catch (IOException e) {
                    ............çœç•¥.........
                }

                ............å¤„ç†IOå°±ç»ªäº‹ä»¶.........
                ............æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡.........
    }
}
</code></pre></div><p>ä½†æ˜¯ç”±äºè¿™ä¸ªBugçš„å­˜åœ¨ï¼Œmain reactoråœ¨æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥çš„è¿™ä¸ªread loopä¸­åªæ¥æ”¶äº†ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥å°±åŒ†åŒ†è¿”å›äº†ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>      private final class NioMessageUnsafe extends AbstractNioUnsafe {
                    do {
                        int localRead = doReadMessages(readBuf);
                        .........çœç•¥...........
                    } while (allocHandle.continueReading());
     }
</code></pre></div><p>ç„¶åæ ¹æ®ä¸‹å›¾ä¸­è¿™ä¸ªReactorçš„è¿è¡Œç»“æ„å»æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œéšåç»•ä¸€å¤§åœˆåˆä¼šå›åˆ°<code>NioEventLoop#run</code>æ–¹æ³•ä¸­é‡æ–°å‘èµ·ä¸€è½®OP_ACCEPTäº‹ä»¶è½®è¯¢ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)Reactorçº¿ç¨‹è¿è¡Œæ—¶ç»“æ„.png</p> <p>ç”±äºç°åœ¨è¿˜æœ‰15ä¸ªå®¢æˆ·ç«¯å¹¶å‘è¿æ¥æ²¡æœ‰è¢«æ¥æ”¶ï¼Œæ‰€ä»¥æ­¤æ—¶Main Reactorçº¿ç¨‹å¹¶ä¸ä¼šåœ¨<code>selector.select()</code>ä¸Šé˜»å¡ï¼Œæœ€ç»ˆç»•ä¸€åœˆåˆä¼šå›åˆ°<code>NioMessageUnsafe#read</code>æ–¹æ³•çš„<code>do{.....}while()</code>å¾ªç¯ã€‚åœ¨æ¥æ”¶ä¸€ä¸ªè¿æ¥ä¹‹ååˆé€€å‡ºå¾ªç¯ã€‚</p> <p>æœ¬æ¥æˆ‘ä»¬å¯ä»¥åœ¨ä¸€æ¬¡read loopä¸­æŠŠè¿™16ä¸ªå¹¶å‘çš„å®¢æˆ·ç«¯è¿æ¥å…¨éƒ¨æ¥æ”¶å®Œæ¯•çš„ï¼Œå› ä¸ºè¿™ä¸ªBugï¼Œmain reactoréœ€è¦ä¸æ–­çš„å‘èµ·OP_ACCEPTäº‹ä»¶çš„è½®è¯¢ï¼Œç»•äº†å¾ˆå¤§ä¸€ä¸ªåœˆå­ã€‚<strong>åŒæ—¶ä¹Ÿå¢åŠ äº†è®¸å¤šä¸å¿…è¦çš„selector.select()ç³»ç»Ÿè°ƒç”¨å¼€é”€</strong></p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191110731.webp" alt="å›¾ç‰‡">issueè®¨è®º.png</p> <p>è¿™æ—¶å¤§å®¶åœ¨çœ‹è¿™ä¸ª?Issue#11708ä¸­çš„è®¨è®ºæ˜¯ä¸æ˜¯å°±æ¸…æ™°å¾ˆå¤šäº†~~</p> <blockquote><p>Issue#11708ï¼šhttps://github.com/netty/netty/issues/11708</p></blockquote> <h3 id="_4-1-bugçš„ä¿®å¤"><a href="#_4-1-bugçš„ä¿®å¤" class="header-anchor">#</a> 4.1 Bugçš„ä¿®å¤</h3> <blockquote><p>ç¬”è€…åœ¨å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ï¼ŒNettyæœ€æ–°ç‰ˆæœ¬æ˜¯4.1.68.finalï¼Œè¿™ä¸ªBugåœ¨4.1.69.finalä¸­è¢«ä¿®å¤ã€‚</p></blockquote> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiamkpfIdsVEQRQibNvxZYJJiaTQFHvmuiasd23LH4hjLazv0W1sibvr46nkA/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">image.png</p> <p>ç”±äºè¯¥Bugäº§ç”Ÿçš„åŸå› æ­£æ˜¯å› ä¸ºæœåŠ¡ç«¯NioServerSocketChannelï¼ˆç”¨äºç›‘å¬ç«¯å£åœ°å€å’Œæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ï¼‰å’Œ å®¢æˆ·ç«¯NioSocketChannelï¼ˆç”¨äºé€šä¿¡ï¼‰ä¸­çš„Configé…ç½®ç±»æ··ç”¨äº†åŒä¸€ä¸ªByteBufferåˆ†é…å™¨<code>AdaptiveRecvByteBufAllocator</code>è€Œå¯¼è‡´çš„ã€‚</p> <p>æ‰€ä»¥åœ¨æ–°ç‰ˆæœ¬ä¿®å¤ä¸­ä¸“é—¨ä¸ºæœåŠ¡ç«¯ServerSocketChannelä¸­çš„Configé…ç½®ç±»å¼•å…¥äº†ä¸€ä¸ªæ–°çš„ByteBufferåˆ†é…å™¨<code>ServerChannelRecvByteBufAllocator</code>ï¼Œä¸“é—¨ç”¨äºæœåŠ¡ç«¯ServerSocketChannelæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥çš„åœºæ™¯ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>åœ¨<code>ServerChannelRecvByteBufAllocator</code>çš„çˆ¶ç±»<code>DefaultMaxMessagesRecvByteBufAllocator</code>ä¸­å¼•å…¥äº†ä¸€ä¸ªæ–°çš„å­—æ®µ<code>ignoreBytesRead</code>ï¼Œç”¨äºè¡¨ç¤ºæ˜¯å¦å¿½ç•¥ç½‘ç»œå­—èŠ‚çš„è¯»å–ï¼Œåœ¨åˆ›å»ºæœåŠ¡ç«¯Channelé…ç½®ç±»NioServerSocketChannelConfigçš„æ—¶å€™ï¼Œè¿™ä¸ªå­—æ®µä¼šè¢«èµ‹å€¼ä¸º<code>true</code>ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>å½“main reactorçº¿ç¨‹åœ¨read loopå¾ªç¯ä¸­æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥çš„æ—¶å€™ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>      private final class NioMessageUnsafe extends AbstractNioUnsafe {

                    do {
                        int localRead = doReadMessages(readBuf);
                        .........çœç•¥...........
                    } while (allocHandle.continueReading());
     }
</code></pre></div><p>åœ¨read loopå¾ªç¯çš„æœ«å°¾å°±ä¼šé‡‡ç”¨ä»<code>ServerChannelRecvByteBufAllocator</code>ä¸­åˆ›å»ºçš„<code>MaxMessageHandle#continueReading</code>æ–¹æ³•æ¥åˆ¤æ–­è¯»å–è¿æ¥æ¬¡æ•°æ˜¯å¦è¶…è¿‡äº†16æ¬¡ã€‚ç”±äºè¿™é‡Œçš„<code>ignoreBytesRead == true</code>è¿™å›æˆ‘ä»¬å°±ä¼šå¿½ç•¥<code>totalBytesRead == 0</code>çš„æƒ…å†µï¼Œä»è€Œä½¿å¾—æ¥æ”¶è¿æ¥çš„read loopå¾—ä»¥ç»§ç»­åœ°æ‰§è¡Œä¸‹å»ã€‚åœ¨ä¸€ä¸ªread loopä¸­ä¸€æ¬¡æ€§æŠŠ16ä¸ªè¿æ¥å…¨éƒ¨æ¥æ”¶å®Œæ¯•ã€‚</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiabJdRFibbDhoULfxwyl3njuSGPmiaw9KwAtB7hicggEYHwcUbMZe4BibEDQ/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">image.png</p> <p>ä»¥ä¸Šå°±æ˜¯å¯¹è¿™ä¸ªBugäº§ç”Ÿçš„åŸå› ï¼Œä»¥åŠå‘ç°çš„è¿‡ç¨‹ï¼Œæœ€åä¿®å¤çš„æ–¹æ¡ˆä¸€ä¸ªå…¨é¢çš„ä»‹ç»ï¼Œå› æ­¤ç¬”è€…ä¹Ÿå‡ºç°åœ¨äº†netty 4.1.69.finalç‰ˆæœ¬å‘å¸ƒå…¬å‘Šé‡Œçš„thank-listä¸­ã€‚å“ˆå“ˆï¼ŒçœŸæ˜¯ä»¤äººå¼€å¿ƒçš„ä¸€ä»¶äº‹æƒ…~~~</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiaEtpEzZGwchbkWicibbjCuOujhoHFk1GrxibqAKnfVkticFu04DQX8XyWkw/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">image.png</p> <p>é€šè¿‡ä»¥ä¸Šå¯¹nettyæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥çš„å…¨æµç¨‹åˆ†æå’Œå¯¹è¿™ä¸ªBugæ¥é¾™å»è„‰ä»¥åŠä¿®å¤æ–¹æ¡ˆçš„ä»‹ç»ï¼Œå¤§å®¶ç°åœ¨ä¸€å®šå·²ç»ç†è§£äº†æ•´ä¸ªæ¥æ”¶è¿æ¥çš„æµç¨‹æ¡†æ¶ã€‚</p> <p>æ¥ä¸‹æ¥ç¬”è€…å°±æŠŠè¿™ä¸ªæµç¨‹ä¸­æ¶‰åŠåˆ°çš„ä¸€äº›æ ¸å¿ƒæ¨¡å—åœ¨å•ç‹¬æ‹å‡ºæ¥ä»ç»†èŠ‚å…¥æ‰‹ï¼Œä¸ºå¤§å®¶å„ä¸ªå‡»ç ´~~~</p> <h2 id="_5-doreadmessagesæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥"><a href="#_5-doreadmessagesæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥" class="header-anchor">#</a> 5. doReadMessagesæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥</h2> <div class="language- extra-class"><pre class="language-text"><code>public class NioServerSocketChannel extends AbstractNioMessageChannel
                             implements io.netty.channel.socket.ServerSocketChannel {

    @Override
    protected int doReadMessages(List&lt;Object&gt; buf) throws Exception {
        SocketChannel ch = SocketUtils.accept(javaChannel());

        try {
            if (ch != null) {
                buf.add(new NioSocketChannel(this, ch));
                return 1;
            }
        } catch (Throwable t) {
            logger.warn(&quot;Failed to create a new channel from an accepted socket.&quot;, t);

            try {
                ch.close();
            } catch (Throwable t2) {
                logger.warn(&quot;Failed to close a socket.&quot;, t2);
            }
        }

        return 0;
    }

}
</code></pre></div><ul><li>é€šè¿‡<code>javaChannel()</code>è·å–å°è£…åœ¨NettyæœåŠ¡ç«¯<code>NioServerSocketChannel</code>ä¸­çš„<code>JDK åŸç”Ÿ ServerSocketChannel</code>ã€‚</li></ul> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    protected ServerSocketChannel javaChannel() {
        return (ServerSocketChannel) super.javaChannel();
    }
</code></pre></div><ul><li>é€šè¿‡<code>JDK NIO åŸç”Ÿ</code>çš„<code>ServerSocketChannel</code>çš„<code>acceptæ–¹æ³•</code>è·å–<code>JDK NIO åŸç”Ÿ</code>å®¢æˆ·ç«¯è¿æ¥<code>SocketChannel</code>ã€‚</li></ul> <div class="language- extra-class"><pre class="language-text"><code>    public static SocketChannel accept(final ServerSocketChannel serverSocketChannel) throws IOException {
        try {
            return AccessController.doPrivileged(new PrivilegedExceptionAction&lt;SocketChannel&gt;() {
                @Override
                public SocketChannel run() throws IOException {
                    return serverSocketChannel.accept();
                }
            });
        } catch (PrivilegedActionException e) {
            throw (IOException) e.getCause();
        }
    }
</code></pre></div><p>è¿™ä¸€æ­¥å°±æ˜¯æˆ‘ä»¬åœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247483737&amp;idx=1&amp;sn=7ef3afbb54289c6e839eed724bb8a9d6&amp;chksm=ce77c71ef9004e08e3d164561e3a2708fc210c05408fa41f7fe338d8e85f39c1ad57519b614e&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€ŠèŠèŠNettyé‚£äº›äº‹å„¿ä¹‹ä»å†…æ ¸è§’åº¦çœ‹IOæ¨¡å‹ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä»‹ç»åˆ°çš„è°ƒç”¨<code>ç›‘å¬Socket</code>çš„<code>acceptæ–¹æ³•</code>ï¼Œå†…æ ¸ä¼šåŸºäº<code>ç›‘å¬Socket</code>åˆ›å»ºå‡ºæ¥ä¸€ä¸ªæ–°çš„<code>Socket</code>ä¸“é—¨ç”¨äºä¸å®¢æˆ·ç«¯ä¹‹é—´çš„ç½‘ç»œé€šä¿¡è¿™ä¸ªæˆ‘ä»¬ç§°ä¹‹ä¸º<code>å®¢æˆ·ç«¯è¿æ¥Socket</code>ã€‚è¿™é‡Œçš„<code>ServerSocketChannel</code>å°±ç±»ä¼¼äº<code>ç›‘å¬Socket</code>ã€‚<code>SocketChannel</code>å°±ç±»ä¼¼äº<code>å®¢æˆ·ç«¯è¿æ¥Socket</code>ã€‚</p> <p>ç”±äºæˆ‘ä»¬åœ¨åˆ›å»º<code>NioServerSocketChannel</code>çš„æ—¶å€™ï¼Œä¼šå°†<code>JDK NIO åŸç”Ÿ</code>çš„<code>ServerSocketChannel</code>è®¾ç½®ä¸º<code>éé˜»å¡</code>ï¼Œæ‰€ä»¥è¿™é‡Œå½“<code>ServerSocketChannel</code>ä¸Šæœ‰å®¢æˆ·ç«¯è¿æ¥æ—¶å°±ä¼šç›´æ¥åˆ›å»º<code>SocketChannel</code>ï¼Œå¦‚æœæ­¤æ—¶å¹¶æ²¡æœ‰å®¢æˆ·ç«¯è¿æ¥æ—¶<code>acceptè°ƒç”¨</code>å°±ä¼šç«‹åˆ»è¿”å›<code>null</code>å¹¶ä¸ä¼šé˜»å¡ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    protected AbstractNioChannel(Channel parent, SelectableChannel ch, int readInterestOp) {
        super(parent);
        this.ch = ch;
        this.readInterestOp = readInterestOp;
        try {
            //è®¾ç½®Channelä¸ºéé˜»å¡ é…åˆIOå¤šè·¯å¤ç”¨æ¨¡å‹
            ch.configureBlocking(false);
        } catch (IOException e) {
          ..........çœç•¥.............
        }
    }
</code></pre></div><h3 id="_5-1-åˆ›å»ºå®¢æˆ·ç«¯niosocketchannel"><a href="#_5-1-åˆ›å»ºå®¢æˆ·ç«¯niosocketchannel" class="header-anchor">#</a> 5.1 åˆ›å»ºå®¢æˆ·ç«¯NioSocketChannel</h3> <div class="language- extra-class"><pre class="language-text"><code>public class NioServerSocketChannel extends AbstractNioMessageChannel
                             implements io.netty.channel.socket.ServerSocketChannel {

    @Override
    protected int doReadMessages(List&lt;Object&gt; buf) throws Exception {
        SocketChannel ch = SocketUtils.accept(javaChannel());

        try {
            if (ch != null) {
                buf.add(new NioSocketChannel(this, ch));
                return 1;
            }
        } catch (Throwable t) {
          .........çœç•¥.......
        }

        return 0;
    }

}
</code></pre></div><p>è¿™é‡Œä¼šæ ¹æ®<code>ServerSocketChannel</code>çš„<code>accept</code>æ–¹æ³•è·å–åˆ°<code>JDK NIO åŸç”Ÿ</code>çš„<code>SocketChannel</code>ï¼ˆç”¨äºåº•å±‚çœŸæ­£ä¸å®¢æˆ·ç«¯é€šä¿¡çš„Channelï¼‰ï¼Œæ¥åˆ›å»ºNettyä¸­çš„<code>NioSocketChannel</code>ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class NioSocketChannel extends AbstractNioByteChannel implements io.netty.channel.socket.SocketChannel {

    public NioSocketChannel(Channel parent, SocketChannel socket) {
        super(parent, socket);
        config = new NioSocketChannelConfig(this, socket.socket());
    }

}
</code></pre></div><p>åˆ›å»ºå®¢æˆ·ç«¯<code>NioSocketChannel</code>çš„è¿‡ç¨‹å…¶å®å’Œä¹‹å‰è®²çš„åˆ›å»ºæœåŠ¡ç«¯<code>NioServerSocketChannel</code>å¤§ä½“æµç¨‹æ˜¯ä¸€æ ·çš„ï¼Œæˆ‘ä»¬è¿™é‡Œåªå¯¹å®¢æˆ·ç«¯<code>NioSocketChannel</code>å’ŒæœåŠ¡ç«¯<code>NioServerSocketChannel</code>åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­çš„ä¸åŒä¹‹å¤„åšä¸€ä¸ªå¯¹æ¯”ã€‚</p> <blockquote><p>å…·ä½“ç»†èŠ‚éƒ¨åˆ†å¤§å®¶å¯ä»¥åœ¨å›çœ‹ä¸‹<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484005&amp;idx=1&amp;sn=52f51269902a58f40d33208421109bc3&amp;chksm=ce77c422f9004d340e5b385ef6ba24dfba1f802076ace80ad6390e934173a10401e64e13eaeb&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€Šè¯¦ç»†å›¾è§£Netty Reactorå¯åŠ¨å…¨æµç¨‹ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸€æ–‡ä¸­å…³äº<code>NioServerSocketChannel</code>çš„åˆ›å»ºçš„è¯¦ç»†ç»†èŠ‚ã€‚</p></blockquote> <h3 id="_5-3-å¯¹æ¯”niosocketchannelä¸nioserversocketchannelçš„ä¸åŒ"><a href="#_5-3-å¯¹æ¯”niosocketchannelä¸nioserversocketchannelçš„ä¸åŒ" class="header-anchor">#</a> 5.3 å¯¹æ¯”NioSocketChannelä¸NioServerSocketChannelçš„ä¸åŒ</h3> <h4 id="_1-channelçš„å±‚æ¬¡ä¸åŒ"><a href="#_1-channelçš„å±‚æ¬¡ä¸åŒ" class="header-anchor">#</a> 1ï¼šChannelçš„å±‚æ¬¡ä¸åŒ</h4> <p>åœ¨æˆ‘ä»¬ä»‹ç»Reactorçš„åˆ›å»ºæ–‡ç« ä¸­ï¼Œæˆ‘ä»¬æåˆ°Nettyä¸­çš„<code>Channel</code>æ˜¯å…·æœ‰å±‚æ¬¡çš„ã€‚ç”±äºå®¢æˆ·ç«¯NioSocketChannelæ˜¯åœ¨main reactoræ¥æ”¶è¿æ¥æ—¶åœ¨æœåŠ¡ç«¯NioServerSocketChannelä¸­è¢«åˆ›å»ºçš„ï¼Œæ‰€ä»¥åœ¨åˆ›å»ºå®¢æˆ·ç«¯NioSocketChannelçš„æ—¶å€™ä¼šé€šè¿‡æ„é€ å‡½æ•°æŒ‡å®šäº†parentå±æ€§ä¸º<code>NioServerSocketChanel</code>ã€‚å¹¶å°†<code>JDK NIO åŸç”Ÿ</code>çš„<code>SocketChannel</code>å°è£…è¿›Nettyçš„å®¢æˆ·ç«¯<code>NioSocketChannel</code>ä¸­ã€‚</p> <p>è€Œåœ¨Reactorå¯åŠ¨è¿‡ç¨‹ä¸­åˆ›å»º<code>NioServerSocketChannel</code>çš„æ—¶å€™<code>parentå±æ€§</code>æŒ‡å®šæ˜¯<code>null</code>ã€‚å› ä¸ºå®ƒå°±æ˜¯é¡¶å±‚çš„<code>Channel</code>ï¼Œè´Ÿè´£åˆ›å»ºå®¢æˆ·ç«¯<code>NioSocketChannel</code>ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    public NioServerSocketChannel(ServerSocketChannel channel) {
        super(null, channel, SelectionKey.OP_ACCEPT);
        config = new NioServerSocketChannelConfig(this, javaChannel().socket());
    }
</code></pre></div><h4 id="_2-å‘reactoræ³¨å†Œçš„ioäº‹ä»¶ä¸åŒ"><a href="#_2-å‘reactoræ³¨å†Œçš„ioäº‹ä»¶ä¸åŒ" class="header-anchor">#</a> 2ï¼šå‘Reactoræ³¨å†Œçš„IOäº‹ä»¶ä¸åŒ</h4> <p>å®¢æˆ·ç«¯NioSocketChannelå‘Sub Reactoræ³¨å†Œçš„æ˜¯<code>SelectionKey.OP_READäº‹ä»¶</code>ï¼Œè€ŒæœåŠ¡ç«¯NioServerSocketChannelå‘Main Reactoræ³¨å†Œçš„æ˜¯<code>SelectionKey.OP_ACCEPTäº‹ä»¶</code>ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public abstract class AbstractNioByteChannel extends AbstractNioChannel {

    protected AbstractNioByteChannel(Channel parent, SelectableChannel ch) {
        super(parent, ch, SelectionKey.OP_READ);
    }

}

public class NioServerSocketChannel extends AbstractNioMessageChannel
                             implements io.netty.channel.socket.ServerSocketChannel {

   public NioServerSocketChannel(ServerSocketChannel channel) {
        //çˆ¶ç±»AbstractNioChannelä¸­ä¿å­˜JDK NIOåŸç”ŸServerSocketChannelä»¥åŠè¦ç›‘å¬çš„äº‹ä»¶OP_ACCEPT
        super(null, channel, SelectionKey.OP_ACCEPT);
        //DefaultChannelConfigä¸­è®¾ç½®ç”¨äºChannelæ¥æ”¶æ•°æ®ç”¨çš„buffer-&gt;AdaptiveRecvByteBufAllocator
        config = new NioServerSocketChannelConfig(this, javaChannel().socket());
    }
}
</code></pre></div><h4 id="_3-åŠŸèƒ½å±æ€§ä¸åŒé€ æˆç»§æ‰¿ç»“æ„çš„ä¸åŒ"><a href="#_3-åŠŸèƒ½å±æ€§ä¸åŒé€ æˆç»§æ‰¿ç»“æ„çš„ä¸åŒ" class="header-anchor">#</a> 3: åŠŸèƒ½å±æ€§ä¸åŒé€ æˆç»§æ‰¿ç»“æ„çš„ä¸åŒ</h4> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)NioSocketChannel.png</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiaJhrEYzibyhX4xH6g502Qobny1kJrRNvgo7j0duvaw9HC2f5eXQPqoTg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">NioServerSocketChannel.png</p> <p>å®¢æˆ·ç«¯<code>NioSocketChannel</code>ç»§æ‰¿çš„æ˜¯<code>AbstractNioByteChannel</code>ï¼Œè€ŒæœåŠ¡ç«¯<code>NioServerSocketChannel</code>ç»§æ‰¿çš„æ˜¯<code>AbstractNioMessageChannel</code>ã€‚å®ƒä»¬ç»§æ‰¿çš„è¿™ä¸¤ä¸ªæŠ½è±¡ç±»ä¸€ä¸ªå‰ç¼€æ˜¯<code>Byte</code>ï¼Œä¸€ä¸ªå‰ç¼€æ˜¯<code>Message</code>æœ‰ä»€ä¹ˆåŒºåˆ«å—ï¼Ÿï¼Ÿ</p> <blockquote><p>å®¢æˆ·ç«¯<code>NioSocketChannel</code>ä¸»è¦å¤„ç†çš„æ˜¯æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯çš„é€šä¿¡ï¼Œè¿™é‡Œæ¶‰åŠåˆ°æ¥æ”¶å®¢æˆ·ç«¯å‘é€æ¥çš„æ•°æ®ï¼Œè€Œ<code>Sub Reactorçº¿ç¨‹</code>ä»<code>NioSocketChannel</code>ä¸­è¯»å–çš„æ­£æ˜¯ç½‘ç»œé€šä¿¡æ•°æ®å•ä½ä¸º<code>Byte</code>ã€‚</p></blockquote> <blockquote><p>æœåŠ¡ç«¯<code>NioServerSocketChannel</code>ä¸»è¦è´Ÿè´£å¤„ç†<code>OP_ACCEPTäº‹ä»¶</code>ï¼Œåˆ›å»ºç”¨äºé€šä¿¡çš„å®¢æˆ·ç«¯<code>NioSocketChannel</code>ã€‚è¿™æ—¶å€™å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯è¿˜æ²¡å¼€å§‹é€šä¿¡ï¼Œæ‰€ä»¥<code>Main Reactorçº¿ç¨‹</code>ä»<code>NioServerSocketChannel</code>çš„è¯»å–å¯¹è±¡ä¸º<code>Message</code>ã€‚è¿™é‡Œçš„<code>Message</code>æŒ‡çš„å°±æ˜¯åº•å±‚çš„<code>SocketChannel</code>å®¢æˆ·ç«¯è¿æ¥ã€‚</p></blockquote> <hr> <p>ä»¥ä¸Šå°±æ˜¯<code>NioSocketChannel</code>ä¸<code>NioServerSocketChannel</code>åˆ›å»ºè¿‡ç¨‹ä¸­çš„ä¸åŒä¹‹å¤„ï¼Œåé¢çš„è¿‡ç¨‹å°±ä¸€æ ·äº†ã€‚</p> <ul><li>åœ¨AbstractNioChannel ç±»ä¸­å°è£…JDK NIO åŸç”Ÿçš„<code>SocketChannel</code>ï¼Œå¹¶å°†å…¶åº•å±‚çš„IOæ¨¡å‹è®¾ç½®ä¸º<code>éé˜»å¡</code>ï¼Œä¿å­˜éœ€è¦ç›‘å¬çš„IOäº‹ä»¶<code>OP_READ</code>ã€‚</li></ul> <div class="language- extra-class"><pre class="language-text"><code>    protected AbstractNioChannel(Channel parent, SelectableChannel ch, int readInterestOp) {
        super(parent);
        this.ch = ch;
        this.readInterestOp = readInterestOp;
        try {
            //è®¾ç½®Channelä¸ºéé˜»å¡ é…åˆIOå¤šè·¯å¤ç”¨æ¨¡å‹
            ch.configureBlocking(false);
        } catch (IOException e) {

        }
    }
</code></pre></div><ul><li>ä¸ºå®¢æˆ·ç«¯NioSocketChannelåˆ›å»ºå…¨å±€å”¯ä¸€çš„<code>channelId</code>ï¼Œåˆ›å»ºå®¢æˆ·ç«¯NioSocketChannelçš„åº•å±‚æ“ä½œç±»<code>NioByteUnsafe</code>ï¼Œåˆ›å»ºpipelineã€‚</li></ul> <div class="language- extra-class"><pre class="language-text"><code>    protected AbstractChannel(Channel parent) {
        this.parent = parent;
        //channelå…¨å±€å”¯ä¸€ID machineId+processId+sequence+timestamp+random
        id = newId();
        //unsafeç”¨äºåº•å±‚socketçš„è¯»å†™æ“ä½œ
        unsafe = newUnsafe();
        //ä¸ºchannelåˆ†é…ç‹¬ç«‹çš„pipelineç”¨äºIOäº‹ä»¶ç¼–æ’
        pipeline = newChannelPipeline();
    }
</code></pre></div><ul><li>åœ¨NioSocketChannelConfigçš„åˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œå°†NioSocketChannelçš„RecvByteBufAllocatorç±»å‹è®¾ç½®ä¸º<code>AdaptiveRecvByteBufAllocator</code>ã€‚</li></ul> <div class="language- extra-class"><pre class="language-text"><code>    public DefaultChannelConfig(Channel channel) {
            this(channel, new AdaptiveRecvByteBufAllocator());
    }
</code></pre></div><blockquote><p>åœ¨Bugä¿®å¤åçš„ç‰ˆæœ¬ä¸­æœåŠ¡ç«¯NioServerSocketChannelçš„RecvByteBufAllocatorç±»å‹è®¾ç½®ä¸º<code>ServerChannelRecvByteBufAllocator</code></p></blockquote> <p>æœ€ç»ˆæˆ‘ä»¬å¾—åˆ°çš„å®¢æˆ·ç«¯<code>NioSocketChannel</code>ç»“æ„å¦‚ä¸‹ï¼š</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiaW2k5wARibzQC47D0ricxafnVibibz8usyYO8DIiagJObUwYIu1vS6fGW08A/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">NioSocketChannel.png</p> <h2 id="_6-channelreadäº‹ä»¶çš„å“åº”"><a href="#_6-channelreadäº‹ä»¶çš„å“åº”" class="header-anchor">#</a> 6. ChannelReadäº‹ä»¶çš„å“åº”</h2> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiaDjWPOibC4yyvicZOQROz0VprRQdxN0scINPgOrCAVGxL1bUoV6ia4YJXQ/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥.png</p> <p>åœ¨å‰è¾¹ä»‹ç»æ¥æ”¶è¿æ¥çš„æ•´ä½“æ ¸å¿ƒæµç¨‹æ¡†æ¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬æåˆ°main reactorçº¿ç¨‹æ˜¯åœ¨ä¸€ä¸ª<code>do{.....}while(...)</code>å¾ªç¯read loopä¸­ä¸æ–­çš„è°ƒç”¨<code>ServerSocketChannel#accept</code>æ–¹æ³•æ¥æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥ã€‚</p> <p>å½“æ»¡è¶³é€€å‡ºread loopå¾ªç¯çš„æ¡ä»¶æœ‰ä¸¤ä¸ªï¼š</p> <ol><li>åœ¨é™å®šçš„16æ¬¡è¯»å–ä¸­ï¼Œå·²ç»æ²¡æœ‰æ–°çš„å®¢æˆ·ç«¯è¿æ¥è¦æ¥æ”¶äº†ã€‚é€€å‡ºå¾ªç¯ã€‚</li> <li>ä»NioServerSocketChannelä¸­è¯»å–å®¢æˆ·ç«¯è¿æ¥çš„æ¬¡æ•°è¾¾åˆ°äº†16æ¬¡ï¼Œæ— è®ºæ­¤æ—¶æ˜¯å¦è¿˜æœ‰å®¢æˆ·ç«¯è¿æ¥éƒ½éœ€è¦é€€å‡ºå¾ªç¯ã€‚</li></ol> <p>main reactorå°±ä¼šé€€å‡ºread loopå¾ªç¯ï¼Œæ­¤æ—¶æ¥æ”¶åˆ°çš„å®¢æˆ·ç«¯è¿æ¥NioSocketChannelæš‚å­˜ä¸<code>List&lt;Object&gt; readBuf</code>é›†åˆä¸­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private final class NioMessageUnsafe extends AbstractNioUnsafe {

        private final List&lt;Object&gt; readBuf = new ArrayList&lt;Object&gt;();

        @Override
        public void read() {
            try {
                try {
                    do {
                        ........çœç•¥.........
                        //åº•å±‚è°ƒç”¨NioServerSocketChannel-&gt;doReadMessages åˆ›å»ºå®¢æˆ·ç«¯SocketChannel
                        int localRead = doReadMessages(readBuf);
                        ........çœç•¥.........
                        allocHandle.incMessagesRead(localRead);
                    } while (allocHandle.continueReading());

                } catch (Throwable t) {
                    exception = t;
                }

                int size = readBuf.size();
                for (int i = 0; i &lt; size; i ++) {
                    readPending = false;
                    pipeline.fireChannelRead(readBuf.get(i));
                }
                
                  ........çœç•¥.........
            } finally {
                  ........çœç•¥.........
            }
        }
    }
</code></pre></div><p>éšåmain reactorçº¿ç¨‹ä¼šéå†<code>List&lt;Object&gt; readBuf</code>é›†åˆä¸­çš„NioSocketChannelï¼Œå¹¶åœ¨NioServerSocketChannelçš„pipelineä¸­ä¼ æ’­ChannelReadäº‹ä»¶ã€‚</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiaLcRXsic4tugeyCbo2ZjSLhNtU09WGLEicbhFmqJBY7BDibKss8j2BTKibg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">ä¼ æ’­ChannelReadäº‹ä»¶.png</p> <p>æœ€ç»ˆ<code>ChannelReadäº‹ä»¶</code>ä¼šä¼ æ’­åˆ°<code>ServerBootstrapAcceptor</code>ä¸­ï¼Œè¿™é‡Œæ­£æ˜¯Nettyå¤„ç†å®¢æˆ·ç«¯è¿æ¥çš„æ ¸å¿ƒé€»è¾‘æ‰€åœ¨ã€‚</p> <p><code>ServerBootstrapAcceptor</code>ä¸»è¦çš„ä½œç”¨å°±æ˜¯åˆå§‹åŒ–å®¢æˆ·ç«¯<code>NioSocketChannel</code>ï¼Œå¹¶å°†å®¢æˆ·ç«¯NioSocketChannelæ³¨å†Œåˆ°<code>Sub Reactor Group</code>ä¸­ï¼Œå¹¶ç›‘å¬<code>OP_READäº‹ä»¶</code>ã€‚</p> <p>åœ¨ServerBootstrapAcceptor ä¸­ä¼šåˆå§‹åŒ–å®¢æˆ·ç«¯NioSocketChannelçš„è¿™äº›å±æ€§ã€‚</p> <p>æ¯”å¦‚ï¼šä»Reactorç»„<code>EventLoopGroup childGroup</code>ï¼Œç”¨äºåˆå§‹åŒ–<code>NioSocketChannel</code>ä¸­çš„<code>pipeline</code>ç”¨åˆ°çš„<code>ChannelHandler childHandler</code>ï¼Œä»¥åŠ<code>NioSocketChannel</code>ä¸­çš„ä¸€äº›<code>childOptions</code>å’Œ<code>childAttrs</code>ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>private static class ServerBootstrapAcceptor extends ChannelInboundHandlerAdapter {

        private final EventLoopGroup childGroup;
        private final ChannelHandler childHandler;
        private final Entry&lt;ChannelOption&lt;?&gt;, Object&gt;[] childOptions;
        private final Entry&lt;AttributeKey&lt;?&gt;, Object&gt;[] childAttrs;

        @Override
        @SuppressWarnings(&quot;unchecked&quot;)
        public void channelRead(ChannelHandlerContext ctx, Object msg) {
            final Channel child = (Channel) msg;

            //å‘å®¢æˆ·ç«¯NioSocketChannelçš„pipelineä¸­
            //æ·»åŠ åœ¨å¯åŠ¨é…ç½®ç±»ServerBootstrapä¸­é…ç½®çš„ChannelHandler
            child.pipeline().addLast(childHandler);

            //åˆ©ç”¨é…ç½®çš„å±æ€§åˆå§‹åŒ–å®¢æˆ·ç«¯NioSocketChannel
            setChannelOptions(child, childOptions, logger);
            setAttributes(child, childAttrs);

            try {
                /**
                 * 1ï¼šåœ¨Sub Reactorçº¿ç¨‹ç»„ä¸­é€‰æ‹©ä¸€ä¸ªReactorç»‘å®š
                 * 2ï¼šå°†å®¢æˆ·ç«¯SocketChannelæ³¨å†Œåˆ°ç»‘å®šçš„Reactorä¸Š
                 * 3ï¼šSocketChannelæ³¨å†Œåˆ°sub reactorä¸­çš„selectorä¸Šï¼Œå¹¶ç›‘å¬OP_READäº‹ä»¶
                 * */
                childGroup.register(child).addListener(new ChannelFutureListener() {
                    @Override
                    public void operationComplete(ChannelFuture future) throws Exception {
                        if (!future.isSuccess()) {
                            forceClose(child, future.cause());
                        }
                    }
                });
            } catch (Throwable t) {
                forceClose(child, t);
            }
        }
}
</code></pre></div><p>æ­£æ˜¯åœ¨è¿™é‡Œï¼Œnettyä¼šå°†æˆ‘ä»¬åœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484005&amp;idx=1&amp;sn=52f51269902a58f40d33208421109bc3&amp;chksm=ce77c422f9004d340e5b385ef6ba24dfba1f802076ace80ad6390e934173a10401e64e13eaeb&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€Šè¯¦ç»†å›¾è§£Netty Reactorå¯åŠ¨å…¨æµç¨‹ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>çš„å¯åŠ¨ç¤ºä¾‹ç¨‹åºä¸­åœ¨ServerBootstrapä¸­é…ç½®çš„å®¢æˆ·ç«¯NioSocketChannelçš„æ‰€æœ‰å±æ€§ï¼ˆchildå‰ç¼€é…ç½®ï¼‰åˆå§‹åŒ–åˆ°NioSocketChannelä¸­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public final class EchoServer {
    static final int PORT = Integer.parseInt(System.getProperty(&quot;port&quot;, &quot;8007&quot;));

    public static void main(String[] args) throws Exception {
        // Configure the server.
        //åˆ›å»ºä¸»ä»Reactorçº¿ç¨‹ç»„
        EventLoopGroup bossGroup = new NioEventLoopGroup(1);
        EventLoopGroup workerGroup = new NioEventLoopGroup();
        final EchoServerHandler serverHandler = new EchoServerHandler();
        try {
            ServerBootstrap b = new ServerBootstrap();
            b.group(bossGroup, workerGroup)//é…ç½®ä¸»ä»Reactor
             .channel(NioServerSocketChannel.class)//é…ç½®ä¸»Reactorä¸­çš„channelç±»å‹
             .option(ChannelOption.SO_BACKLOG, 100)//è®¾ç½®ä¸»Reactorä¸­channelçš„optioné€‰é¡¹
             .handler(new LoggingHandler(LogLevel.INFO))//è®¾ç½®ä¸»Reactorä¸­Channel-&gt;pipline-&gt;handler
             .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() {//è®¾ç½®ä»Reactorä¸­æ³¨å†Œchannelçš„pipeline
                 @Override
                 public void initChannel(SocketChannel ch) throws Exception {
                     ChannelPipeline p = ch.pipeline();
                     //p.addLast(new LoggingHandler(LogLevel.INFO));
                     p.addLast(serverHandler);
                 }
             });

            // Start the server. ç»‘å®šç«¯å£å¯åŠ¨æœåŠ¡ï¼Œå¼€å§‹ç›‘å¬acceptäº‹ä»¶
            ChannelFuture f = b.bind(PORT).sync();
            // Wait until the server socket is closed.
            f.channel().closeFuture().sync();
        } finally {
            // Shut down all event loops to terminate all threads.
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }
}
</code></pre></div><p>ä»¥ä¸Šç¤ºä¾‹ä»£ç ä¸­é€šè¿‡ServerBootstrapé…ç½®çš„NioSocketChannelç›¸å…³å±æ€§ï¼Œä¼šåœ¨Nettyå¯åŠ¨å¹¶å¼€å§‹åˆå§‹åŒ–<code>NioServerSocketChannel</code>çš„æ—¶å€™å°†<code>ServerBootstrapAcceptor</code>çš„åˆ›å»ºåˆå§‹åŒ–å·¥ä½œå°è£…æˆ<code>å¼‚æ­¥ä»»åŠ¡</code>ï¼Œç„¶ååœ¨<code>NioServerSocketChannel</code>æ³¨å†Œåˆ°<code>Main Reactor</code>ä¸­æˆåŠŸåæ‰§è¡Œã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class ServerBootstrap extends AbstractBootstrap&lt;ServerBootstrap, ServerChannel&gt; {

    @Override
    void init(Channel channel) {
        ................çœç•¥................

        p.addLast(new ChannelInitializer&lt;Channel&gt;() {
            @Override
            public void initChannel(final Channel ch) {
                final ChannelPipeline pipeline = ch.pipeline();
                ................çœç•¥................
                ch.eventLoop().execute(new Runnable() {
                    @Override
                    public void run() {
                        pipeline.addLast(new ServerBootstrapAcceptor(
                                ch, currentChildGroup, currentChildHandler, currentChildOptions, currentChildAttrs));
                    }
                });
            }
        });
    }
}
</code></pre></div><p>åœ¨ç»è¿‡<code>ServerBootstrapAccptor#chanelReadå›è°ƒ</code>çš„å¤„ç†ä¹‹åï¼Œæ­¤æ—¶å®¢æˆ·ç«¯NioSocketChannelä¸­pipelineçš„ç»“æ„ä¸ºï¼š</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNia6cNkLIW571QH74LhkCfFpibJSm1cwDQTQBcxClKehQVGRR3ibdP9Ea5A/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">å®¢æˆ·ç«¯channel pipelineåˆå§‹ç»“æ„.png</p> <p>éšåä¼šå°†åˆå§‹åŒ–å¥½çš„å®¢æˆ·ç«¯NioSocketChannelå‘Sub Reactor Groupä¸­æ³¨å†Œï¼Œå¹¶ç›‘å¬<code>OP_READäº‹ä»¶</code>ã€‚</p> <p>å¦‚ä¸‹å›¾ä¸­çš„æ­¥éª¤3æ‰€ç¤ºï¼š</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNialDtXCOD5vvVGh56FT2yKauwTch6oYbrn1icPuYKaqY8nPibicWv66sQfw/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">nettyä¸­çš„reactor.png</p> <h2 id="_7-å‘subreactorgroupä¸­æ³¨å†Œniosocketchannel"><a href="#_7-å‘subreactorgroupä¸­æ³¨å†Œniosocketchannel" class="header-anchor">#</a> 7. å‘SubReactorGroupä¸­æ³¨å†ŒNioSocketChannel</h2> <div class="language- extra-class"><pre class="language-text"><code>                childGroup.register(child).addListener(new ChannelFutureListener() {
                    @Override
                    public void operationComplete(ChannelFuture future) throws Exception {
                        if (!future.isSuccess()) {
                            forceClose(child, future.cause());
                        }
                    }
                });
</code></pre></div><p>å®¢æˆ·ç«¯NioSocketChannelå‘Sub Reactor Groupæ³¨å†Œçš„æµç¨‹å®Œå…¨å’ŒæœåŠ¡ç«¯NioServerSocketChannelå‘Main Reactor Groupæ³¨å†Œæµç¨‹ä¸€æ ·ã€‚</p> <blockquote><p>å…³äºæœåŠ¡ç«¯NioServerSocketChannelçš„æ³¨å†Œæµç¨‹ï¼Œç¬”è€…å·²ç»åœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484005&amp;idx=1&amp;sn=52f51269902a58f40d33208421109bc3&amp;chksm=ce77c422f9004d340e5b385ef6ba24dfba1f802076ace80ad6390e934173a10401e64e13eaeb&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€Šè¯¦ç»†å›¾è§£Netty Reactorå¯åŠ¨å…¨æµç¨‹ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸€æ–‡ä¸­åšå‡ºäº†è¯¦ç»†çš„ä»‹ç»ï¼Œå¯¹ç›¸å…³ç»†èŠ‚æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥åœ¨å›çœ‹ä¸‹ã€‚</p></blockquote> <p>è¿™é‡Œç¬”è€…åœ¨å¸¦å¤§å®¶ç®€è¦å›é¡¾ä¸‹æ•´ä¸ªæ³¨å†Œè¿‡ç¨‹å¹¶ç€é‡åŒºåˆ«å¯¹æ¯”å®¢æˆ·ç«¯NioSocetChannelä¸æœåŠ¡ç«¯NioServerSocketChannelæ³¨å†Œè¿‡ç¨‹ä¸­ä¸åŒçš„åœ°æ–¹ã€‚</p> <h3 id="_7-1-ä»sub-reactor-groupä¸­é€‰å–ä¸€ä¸ªsub-reactorè¿›è¡Œç»‘å®š"><a href="#_7-1-ä»sub-reactor-groupä¸­é€‰å–ä¸€ä¸ªsub-reactorè¿›è¡Œç»‘å®š" class="header-anchor">#</a> 7.1 ä»Sub Reactor Groupä¸­é€‰å–ä¸€ä¸ªSub Reactorè¿›è¡Œç»‘å®š</h3> <div class="language- extra-class"><pre class="language-text"><code>public abstract class MultithreadEventLoopGroup extends MultithreadEventExecutorGroup implements EventLoopGroup {

   @Override
    public ChannelFuture register(Channel channel) {
        return next().register(channel);
    }

    @Override
    public EventExecutor next() {
        return chooser.next();
    }

}
</code></pre></div><h3 id="_7-2-å‘ç»‘å®šçš„sub-reactorä¸Šæ³¨å†Œniosocketchannel"><a href="#_7-2-å‘ç»‘å®šçš„sub-reactorä¸Šæ³¨å†Œniosocketchannel" class="header-anchor">#</a> 7.2 å‘ç»‘å®šçš„Sub Reactorä¸Šæ³¨å†ŒNioSocketChannel</h3> <div class="language- extra-class"><pre class="language-text"><code>public abstract class SingleThreadEventLoop extends SingleThreadEventExecutor implements EventLoop {

    @Override
    public ChannelFuture register(Channel channel) {
        //æ³¨å†Œchannelåˆ°ç»‘å®šçš„Reactorä¸Š
        return register(new DefaultChannelPromise(channel, this));
    }

    @Override
    public ChannelFuture register(final ChannelPromise promise) {
        ObjectUtil.checkNotNull(promise, &quot;promise&quot;);
        //unsafeè´Ÿè´£channelåº•å±‚çš„å„ç§æ“ä½œ
        promise.channel().unsafe().register(this, promise);
        return promise;
    }

}
</code></pre></div><ul><li>å½“æ—¶æˆ‘ä»¬åœ¨ä»‹ç»<code>NioServerSocketChannel</code>çš„æ³¨å†Œè¿‡ç¨‹æ—¶ï¼Œè¿™é‡Œçš„<code>promise.channel()</code>ä¸º<code>NioServerSocketChannel</code>ã€‚åº•å±‚çš„unsafeæ“ä½œç±»ä¸º<code>NioMessageUnsafe</code>ã€‚</li> <li>æ­¤æ—¶è¿™é‡Œçš„<code>promise.channel()</code>ä¸º<code>NioSocketChannel</code>ã€‚åº•å±‚çš„unsafeæ“ä½œç±»ä¸º<code>NioByteUnsafe</code>ã€‚</li></ul> <div class="language- extra-class"><pre class="language-text"><code>        @Override
        public final void register(EventLoop eventLoop, final ChannelPromise promise) {
            ..............çœç•¥....................
            //æ­¤æ—¶è¿™é‡Œçš„eventLoopä¸ºSub Reactor
            AbstractChannel.this.eventLoop = eventLoop;

            /**
             * æ‰§è¡Œchannelæ³¨å†Œçš„æ“ä½œå¿…é¡»æ˜¯Reactorçº¿ç¨‹æ¥å®Œæˆ
             *
             * 1: å¦‚æœå½“å‰æ‰§è¡Œçº¿ç¨‹æ˜¯Reactorçº¿ç¨‹ï¼Œåˆ™ç›´æ¥æ‰§è¡Œregister0è¿›è¡Œæ³¨å†Œ
             * 2ï¼šå¦‚æœå½“å‰æ‰§è¡Œçº¿ç¨‹æ˜¯å¤–éƒ¨çº¿ç¨‹ï¼Œåˆ™éœ€è¦å°†register0æ³¨å†Œæ“ä½œ å°è£…ç¨‹å¼‚æ­¥Task ç”±Reactorçº¿ç¨‹æ‰§è¡Œ
             * */
            if (eventLoop.inEventLoop()) {
                register0(promise);
            } else {
                try {
                    eventLoop.execute(new Runnable() {
                        @Override
                        public void run() {
                            register0(promise);
                        }
                    });
                } catch (Throwable t) {
                    ..............çœç•¥....................
                }
            }
        }
</code></pre></div><p><strong>æ³¨æ„æ­¤æ—¶ä¼ é€’è¿›æ¥çš„EventLoop eventLoopä¸ºSub Reactor</strong>ã€‚</p> <p><strong>ä½†æ­¤æ—¶çš„æ‰§è¡Œçº¿ç¨‹ä¸º<code>Main Reactorçº¿ç¨‹</code>ï¼Œå¹¶ä¸æ˜¯Sub Reactorçº¿ç¨‹ï¼ˆæ­¤æ—¶è¿˜æœªå¯åŠ¨ï¼‰</strong>ã€‚</p> <p>æ‰€ä»¥è¿™é‡Œçš„<code>eventLoop.inEventLoop()</code>è¿”å›çš„æ˜¯<code>false</code>ã€‚</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiazIA5weroZkxOLyqsUBrN8Q1XP3NM5vBsFVdZXIGz1Il7FPprdZ4TNg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">image.png</p> <p>åœ¨<code>elseåˆ†æ”¯</code>ä¸­å‘ç»‘å®šçš„Sub Reactoræäº¤æ³¨å†Œ<code>NioSocketChannel</code>çš„ä»»åŠ¡ã€‚</p> <blockquote><p>å½“æ³¨å†Œä»»åŠ¡æäº¤åï¼Œæ­¤æ—¶ç»‘å®šçš„<code>Sub Reactorçº¿ç¨‹</code>å¯åŠ¨ã€‚</p></blockquote> <h3 id="_7-3-register0"><a href="#_7-3-register0" class="header-anchor">#</a> 7.3 register0</h3> <p>æˆ‘ä»¬åˆæ¥åˆ°äº†Channelæ³¨å†Œçš„è€åœ°æ–¹<code>register0æ–¹æ³•</code>ã€‚åœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484005&amp;idx=1&amp;sn=52f51269902a58f40d33208421109bc3&amp;chksm=ce77c422f9004d340e5b385ef6ba24dfba1f802076ace80ad6390e934173a10401e64e13eaeb&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€Šè¯¦ç»†å›¾è§£Netty Reactorå¯åŠ¨å…¨æµç¨‹ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸­æˆ‘ä»¬èŠ±äº†å¤§é‡çš„ç¯‡å¹…ä»‹ç»äº†è¿™ä¸ªæ–¹æ³•ã€‚è¿™é‡Œæˆ‘ä»¬åªå¯¹æ¯”<code>NioSocketChannel</code>ä¸<code>NioServerSocketChannel</code>ä¸åŒçš„åœ°æ–¹ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code> private void register0(ChannelPromise promise) {
            try {
                ................çœç•¥..................
                boolean firstRegistration = neverRegistered;
                //æ‰§è¡ŒçœŸæ­£çš„æ³¨å†Œæ“ä½œ
                doRegister();
                //ä¿®æ”¹æ³¨å†ŒçŠ¶æ€
                neverRegistered = false;
                registered = true;

                pipeline.invokeHandlerAddedIfNeeded();

                if (isActive()) {
                    if (firstRegistration) {
                        //è§¦å‘channelActiveäº‹ä»¶
                        pipeline.fireChannelActive();
                    } else if (config().isAutoRead()) {
                        beginRead();
                    }
                }
            } catch (Throwable t) {
                 ................çœç•¥..................
            }
        }
</code></pre></div><p>è¿™é‡Œ <code>doRegister()æ–¹æ³•</code>å°†NioSocketChannelæ³¨å†Œåˆ°Sub Reactorä¸­çš„<code>Selector</code>ä¸Šã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public abstract class AbstractNioChannel extends AbstractChannel {

    @Override
    protected void doRegister() throws Exception {
        boolean selected = false;
        for (;;) {
            try {
                selectionKey = javaChannel().register(eventLoop().unwrappedSelector(), 0, this);
                return;
            } catch (CancelledKeyException e) {
                ...............çœç•¥...............
            }
        }
    }

}
</code></pre></div><p>è¿™é‡Œæ˜¯Nettyå®¢æˆ·ç«¯<code>NioSocketChannel</code>ä¸JDK NIO åŸç”Ÿ SocketChannelå…³è”çš„åœ°æ–¹ã€‚æ­¤æ—¶æ³¨å†Œçš„<code>IOäº‹ä»¶</code>ä¾ç„¶æ˜¯<code>0</code>ã€‚ç›®çš„ä¹Ÿæ˜¯åªæ˜¯ä¸ºäº†è·å–NioSocketChannelåœ¨Selectorä¸­çš„<code>SelectionKey</code>ã€‚</p> <p>åŒæ—¶é€šè¿‡<code>SelectableChannel#register</code>æ–¹æ³•å°†Nettyè‡ªå®šä¹‰çš„NioSocketChannelï¼ˆè¿™é‡Œçš„thisæŒ‡é’ˆï¼‰é™„ç€åœ¨SelectionKeyçš„attechmentå±æ€§ä¸Šï¼Œå®ŒæˆNettyè‡ªå®šä¹‰Channelä¸JDK NIO Channelçš„å…³ç³»ç»‘å®šã€‚è¿™æ ·åœ¨æ¯æ¬¡å¯¹Selectorè¿›è¡ŒIOå°±ç»ªäº‹ä»¶è½®è¯¢æ—¶ï¼ŒNetty éƒ½å¯ä»¥ä» JDK NIO Selectorè¿”å›çš„SelectionKeyä¸­è·å–åˆ°è‡ªå®šä¹‰çš„Channelå¯¹è±¡ï¼ˆè¿™é‡ŒæŒ‡çš„å°±æ˜¯NioSocketChannelï¼‰ã€‚</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiaBHZIoOsiaAmdqQxwtXvIIgHxoYrpp2AeUMs5qEla9BoHU4wkg4Sgjqg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">channelä¸SelectionKeyå¯¹åº”å…³ç³».png</p> <p>éšåè°ƒç”¨<code>pipeline.invokeHandlerAddedIfNeeded()</code>å›è°ƒå®¢æˆ·ç«¯NioSocketChannelä¸Špipelineä¸­çš„æ‰€æœ‰ChannelHandlerçš„<code>handlerAddedæ–¹æ³•</code>ï¼Œæ­¤æ—¶<code>pipeline</code>çš„ç»“æ„ä¸­åªæœ‰ä¸€ä¸ª<code>ChannelInitializer</code>ã€‚æœ€ç»ˆä¼šåœ¨<code>ChannelInitializer#handlerAdded</code>å›è°ƒæ–¹æ³•ä¸­åˆå§‹åŒ–å®¢æˆ·ç«¯<code>NioSocketChannel</code>çš„<code>pipeline</code>ã€‚</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNia6cNkLIW571QH74LhkCfFpibJSm1cwDQTQBcxClKehQVGRR3ibdP9Ea5A/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">å®¢æˆ·ç«¯channel pipelineåˆå§‹ç»“æ„.png</p> <div class="language- extra-class"><pre class="language-text"><code>public abstract class ChannelInitializer&lt;C extends Channel&gt; extends ChannelInboundHandlerAdapter {

    @Override
    public void handlerAdded(ChannelHandlerContext ctx) throws Exception {
        if (ctx.channel().isRegistered()) {
            if (initChannel(ctx)) {
                //åˆå§‹åŒ–å·¥ä½œå®Œæˆåï¼Œéœ€è¦å°†è‡ªèº«ä»pipelineä¸­ç§»é™¤
                removeState(ctx);
            }
        }
    }

    protected abstract void initChannel(C ch) throws Exception;
}
</code></pre></div><blockquote><p>å…³äºå¯¹Channelä¸­pipelineçš„è¯¦ç»†åˆå§‹åŒ–è¿‡ç¨‹ï¼Œå¯¹ç»†èŠ‚éƒ¨åˆ†æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å›çœ‹ä¸‹<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484005&amp;idx=1&amp;sn=52f51269902a58f40d33208421109bc3&amp;chksm=ce77c422f9004d340e5b385ef6ba24dfba1f802076ace80ad6390e934173a10401e64e13eaeb&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€Šè¯¦ç»†å›¾è§£Netty Reactorå¯åŠ¨å…¨æµç¨‹ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>æ­¤æ—¶å®¢æˆ·ç«¯NioSocketChannelä¸­çš„pipelineä¸­çš„ç»“æ„å°±å˜ä¸ºäº†æˆ‘ä»¬è‡ªå®šä¹‰çš„æ ·å­ï¼Œåœ¨ç¤ºä¾‹ä»£ç ä¸­æˆ‘ä»¬è‡ªå®šä¹‰çš„<code>ChannelHandler</code>ä¸º<code>EchoServerHandler</code>ã€‚</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiaTdUsySmibYW5g2lI0f8hN484CkfWrAjns8jib4vPJfrta5gpuxH5lyvQ/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">å®¢æˆ·ç«¯channel pipelineç»“æ„.png</p> <div class="language- extra-class"><pre class="language-text"><code>@Sharable
public class EchoServerHandler extends ChannelInboundHandlerAdapter {

    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) {
        ctx.write(msg);
    }

    @Override
    public void channelReadComplete(ChannelHandlerContext ctx) {

        ctx.flush();
    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) {
        // Close the connection when an exception is raised.
        cause.printStackTrace();
        ctx.close();
    }
}
</code></pre></div><p>å½“å®¢æˆ·ç«¯NioSocketChannelä¸­çš„pipelineåˆå§‹åŒ–å®Œæ¯•åï¼Œnettyå°±å¼€å§‹è°ƒç”¨<code>safeSetSuccess(promise)æ–¹æ³•</code>å›è°ƒ<code>regFuture</code>ä¸­æ³¨å†Œçš„<code>ChannelFutureListener</code>ï¼Œé€šçŸ¥å®¢æˆ·ç«¯NioSocketChannelå·²ç»æˆåŠŸæ³¨å†Œåˆ°Sub Reactorä¸Šäº†ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>               childGroup.register(child).addListener(new ChannelFutureListener() {
                    @Override
                    public void operationComplete(ChannelFuture future) throws Exception {
                        if (!future.isSuccess()) {
                            forceClose(child, future.cause());
                        }
                    }
                });
</code></pre></div><blockquote><p>åœ¨æœåŠ¡ç«¯NioServerSocketChannelæ³¨å†Œçš„æ—¶å€™æˆ‘ä»¬ä¼šåœ¨listenerä¸­å‘Main Reactoræäº¤<code>bindç»‘å®šç«¯å£åœ°å€ä»»åŠ¡</code>ã€‚ä½†æ˜¯åœ¨<code>NioSocketChannel</code>æ³¨å†Œçš„æ—¶å€™ï¼Œåªä¼šåœ¨<code>listener</code>ä¸­å¤„ç†ä¸€ä¸‹æ³¨å†Œå¤±è´¥çš„æƒ…å†µã€‚</p></blockquote> <p>å½“Sub Reactorçº¿ç¨‹é€šçŸ¥ChannelFutureListeneræ³¨å†ŒæˆåŠŸä¹‹åï¼Œéšåå°±ä¼šè°ƒç”¨<code>pipeline.fireChannelRegistered()</code>åœ¨å®¢æˆ·ç«¯NioSocketChannelçš„pipelineä¸­ä¼ æ’­<code>ChannelRegisteredäº‹ä»¶</code>ã€‚</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiaAGdSxbwsoLP3mhiaKahLtKrMRdE9IXvMOyxgInz5UweSSrv8H9HwNKQ/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">ä¼ æ’­ChannelRegisteräº‹ä»¶.png</p> <p><strong>è¿™é‡Œç¬”è€…é‡ç‚¹è¦å¼ºè°ƒä¸‹</strong>ï¼Œåœ¨ä¹‹å‰ä»‹ç»NioServerSocketChannelæ³¨å†Œçš„æ—¶å€™ï¼Œæˆ‘ä»¬æåˆ°å› ä¸ºæ­¤æ—¶NioServerSocketChannelå¹¶æœªç»‘å®šç«¯å£åœ°å€ï¼Œæ‰€ä»¥è¿™æ—¶çš„NioServerSocketChannelå¹¶æœªæ¿€æ´»ï¼Œè¿™é‡Œçš„<code>isActive()</code>è¿”å›<code>false</code>ã€‚<code>register0æ–¹æ³•</code>ç›´æ¥è¿”å›ã€‚</p> <blockquote><p>æœåŠ¡ç«¯NioServerSocketChannelåˆ¤æ–­æ˜¯å¦æ¿€æ´»çš„æ ‡å‡†ä¸ºç«¯å£æ˜¯å¦ç»‘å®šæˆåŠŸã€‚</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>public class NioServerSocketChannel extends AbstractNioMessageChannel
                             implements io.netty.channel.socket.ServerSocketChannel {
    @Override
    public boolean isActive() {
        return isOpen() &amp;&amp; javaChannel().socket().isBound();
    }
}
</code></pre></div><blockquote><p>å®¢æˆ·ç«¯<code>NioSocketChannel</code>åˆ¤æ–­æ˜¯å¦æ¿€æ´»çš„æ ‡å‡†ä¸ºæ˜¯å¦å¤„äº<code>ConnectedçŠ¶æ€</code>ã€‚é‚£ä¹ˆæ˜¾ç„¶è¿™é‡Œè‚¯å®šæ˜¯å¤„äº<code>connectedçŠ¶æ€</code>çš„ã€‚</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public boolean isActive() {
        SocketChannel ch = javaChannel();
        return ch.isOpen() &amp;&amp; ch.isConnected();
    }
</code></pre></div><p><code>NioSocketChannel</code>å·²ç»å¤„äº<code>connectedçŠ¶æ€</code>ï¼Œè¿™é‡Œå¹¶ä¸éœ€è¦ç»‘å®šç«¯å£ï¼Œæ‰€ä»¥è¿™é‡Œçš„<code>isActive()</code>è¿”å›<code>true</code>ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>           if (isActive()) {
                    /**
                     * å®¢æˆ·ç«¯SocketChannelæ³¨å†ŒæˆåŠŸåä¼šèµ°è¿™é‡Œï¼Œåœ¨channelActiveäº‹ä»¶å›è°ƒä¸­æ³¨å†ŒOP_READäº‹ä»¶
                     * */
                    if (firstRegistration) {
                        //è§¦å‘channelActiveäº‹ä»¶
                        pipeline.fireChannelActive();
                    } else if (config().isAutoRead()) {
                        .......çœç•¥..........
                    }
                }
            }
</code></pre></div><p>æœ€åè°ƒç”¨<code>pipeline.fireChannelActive()</code>åœ¨NioSocketChannelä¸­çš„pipelineä¼ æ’­<code>ChannelActiveäº‹ä»¶</code>ï¼Œæœ€ç»ˆåœ¨<code>pipeline</code>çš„å¤´ç»“ç‚¹<code>HeadContext</code>ä¸­å“åº”å¹¶æ³¨å†Œ<code>OP_READäº‹ä»¶</code>åˆ°<code>Sub Reactor</code>ä¸­çš„<code>Selector</code>ä¸Šã€‚</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiaaDWO56Rib0H2YViadZkbq3WErIBg6duwk22WMHcnt41ZWlS9WTtaYbcw/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">ä¼ æ’­ChannelActiveäº‹ä»¶.png</p> <div class="language- extra-class"><pre class="language-text"><code>public abstract class AbstractNioChannel extends AbstractChannel { {

    @Override
    protected void doBeginRead() throws Exception {
        ..............çœç•¥................

        final int interestOps = selectionKey.interestOps();
        /**
         * 1ï¼šServerSocketChannel åˆå§‹åŒ–æ—¶ readInterestOpè®¾ç½®çš„æ˜¯OP_ACCEPTäº‹ä»¶
         * 2ï¼šSocketChannel åˆå§‹åŒ–æ—¶ readInterestOpè®¾ç½®çš„æ˜¯OP_READäº‹ä»¶
         * */
        if ((interestOps &amp; readInterestOp) == 0) {
            //æ³¨å†Œç›‘å¬OP_ACCEPTæˆ–è€…OP_READäº‹ä»¶
            selectionKey.interestOps(interestOps | readInterestOp);
        }
    }

}
</code></pre></div><blockquote><p>æ³¨æ„è¿™é‡Œçš„<code>readInterestOp</code>ä¸ºå®¢æˆ·ç«¯<code>NioSocketChannel</code>åœ¨åˆå§‹åŒ–æ—¶è®¾ç½®çš„<code>OP_READäº‹ä»¶</code>ã€‚</p></blockquote> <hr> <p>åˆ°è¿™é‡Œï¼ŒNettyä¸­çš„<code>Main Reactor</code>æ¥æ”¶è¿æ¥çš„æ•´ä¸ªæµç¨‹ï¼Œæˆ‘ä»¬å°±ä»‹ç»å®Œäº†ï¼Œæ­¤æ—¶Nettyä¸­ä¸»ä»Reactorç»„çš„ç»“æ„å°±å˜ä¸ºï¼š</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiabSEUJ3uzXNIS7OGAbpeQ3ib7ZoCM6RlzjglPlzJ4Pud3L0oWSzN0iaAw/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">ä¸»ä»Reactorç»„å®Œæ•´ç»“æ„.png</p> <h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="header-anchor">#</a> æ€»ç»“</h2> <p>æœ¬æ–‡æˆ‘ä»¬ä»‹ç»äº†<code>NioServerSocketChannel</code>å¤„ç†å®¢æˆ·ç«¯è¿æ¥äº‹ä»¶çš„æ•´ä¸ªè¿‡ç¨‹ã€‚</p> <ul><li>æ¥æ”¶è¿æ¥çš„æ•´ä¸ªå¤„ç†æ¡†æ¶ã€‚</li> <li>å½±å“Nettyæ¥æ”¶è¿æ¥ååçš„Bugäº§ç”Ÿçš„åŸå› ï¼Œä»¥åŠä¿®å¤çš„æ–¹æ¡ˆã€‚</li> <li>åˆ›å»ºå¹¶åˆå§‹åŒ–å®¢æˆ·ç«¯<code>NioSocketChannel</code>ã€‚</li> <li>åˆå§‹åŒ–<code>NioSocketChannel</code>ä¸­çš„<code>pipeline</code>ã€‚</li> <li>å®¢æˆ·ç«¯<code>NioSocketChannel</code>å‘<code>Sub Reactor</code>æ³¨å†Œçš„è¿‡ç¨‹</li></ul> <p>å…¶ä¸­æˆ‘ä»¬ä¹Ÿå¯¹æ¯”äº†<code>NioServerSocketChannel</code>ä¸<code>NioSocketChannel</code>åœ¨åˆ›å»ºåˆå§‹åŒ–ä»¥åŠåé¢å‘<code>Reactor</code>æ³¨å†Œè¿‡ç¨‹ä¸­çš„å·®å¼‚ä¹‹å¤„ã€‚</p> <p>å½“å®¢æˆ·ç«¯<code>NioSocketChannel</code>æ¥æ”¶å®Œæ¯•å¹¶å‘<code>Sub Reactor</code>æ³¨å†ŒæˆåŠŸåï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥<code>Sub Reactor</code>å°±å¼€å§‹ç›‘å¬æ³¨å†Œå…¶ä¸Šçš„æ‰€æœ‰å®¢æˆ·ç«¯<code>NioSocketChannel</code>çš„<code>OP_READäº‹ä»¶</code>ï¼Œå¹¶ç­‰å¾…å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€ç½‘ç»œæ•°æ®ã€‚</p> <p>åé¢<code>Reactor</code>çš„ä¸»è§’å°±è¯¥å˜ä¸º<code>Sub Reactor</code>ä»¥åŠæ³¨å†Œåœ¨å…¶ä¸Šçš„å®¢æˆ·ç«¯<code>NioSocketChannel</code>äº†ã€‚</p> <p>ä¸‹ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬å°†ä¼šè®¨è®ºNettyæ˜¯å¦‚ä½•æ¥æ”¶ç½‘ç»œæ•°æ®çš„~~~~ æˆ‘ä»¬ä¸‹ç¯‡æ–‡ç« è§~~</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/echo-lxy/echo-system-design/edit/master/docs/Netty ç³»ç»Ÿè®¾è®¡/25.å››ã€æ·±å…¥ Netty æ ¸å¿ƒ/15.ç¬¬å››è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œè¿æ¥.md" target="_blank" rel="noopener noreferrer">ç¼–è¾‘</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°äº:</span> <span class="time">2024/09/19, 03:26:41</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        â†
        <a href="/pages/830f05/" class="prev">ç¬¬ä¸‰è¯¾ï¼šNettyæ ¸å¿ƒå¼•æ“Reactorçš„è¿è½¬æ¶æ„</a></span> <span class="next"><a href="/pages/9cb8c1/">ç¬¬äº”è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œæ•°æ®</a>â†’
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:lixinyang2002@163.com" title="å‘é‚®ä»¶" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/echo-lxy" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="å¬éŸ³ä¹" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="æœ¬ç«™ä¸»é¢˜">Vdoing</a> 
    | Copyright Â© 2024-2024
    <span>Xinyang Li | MIT License</span></div> <div class="buttons"><div title="è¿”å›é¡¶éƒ¨" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="å»è¯„è®º" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ä¸»é¢˜æ¨¡å¼" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          è·Ÿéšç³»ç»Ÿ
        </li><li class="iconfont icon-rijianmoshi">
          æµ…è‰²æ¨¡å¼
        </li><li class="iconfont icon-yejianmoshi">
          æ·±è‰²æ¨¡å¼
        </li><li class="iconfont icon-yuedu">
          é˜…è¯»æ¨¡å¼
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.6c7acbd0.js" defer></script><script src="/assets/js/2.933750c6.js" defer></script><script src="/assets/js/54.0bbf2ba5.js" defer></script><script src="/assets/js/7.7eb70372.js" defer></script>
  </body>
</html>
