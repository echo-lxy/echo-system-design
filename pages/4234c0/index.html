<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ChannelPipeline æºç è§£æ | EchoDesign</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="ç³»ç»Ÿè®¾è®¡ä¹‹ã€Œè®²è§£ + é¢è¯•æŒ‡å—ã€ï¼Œæ°´æ»´çŸ³ç©¿ï¼Œè®¾è®¡æ— é“¶å¼¹ï¼">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.c76c3453.css" as="style"><link rel="preload" href="/assets/js/app.2fa17da6.js" as="script"><link rel="preload" href="/assets/js/2.933750c6.js" as="script"><link rel="preload" href="/assets/js/49.15d8e916.js" as="script"><link rel="preload" href="/assets/js/7.7eb70372.js" as="script"><link rel="prefetch" href="/assets/js/10.7b3b5100.js"><link rel="prefetch" href="/assets/js/100.2b21dce5.js"><link rel="prefetch" href="/assets/js/101.96ca71f6.js"><link rel="prefetch" href="/assets/js/11.71fe9642.js"><link rel="prefetch" href="/assets/js/12.38d1989d.js"><link rel="prefetch" href="/assets/js/13.850793b0.js"><link rel="prefetch" href="/assets/js/14.1141ec27.js"><link rel="prefetch" href="/assets/js/15.12d1dea8.js"><link rel="prefetch" href="/assets/js/16.60cde607.js"><link rel="prefetch" href="/assets/js/17.acb3bf3d.js"><link rel="prefetch" href="/assets/js/18.e491edb6.js"><link rel="prefetch" href="/assets/js/19.daf31819.js"><link rel="prefetch" href="/assets/js/20.fe336bc3.js"><link rel="prefetch" href="/assets/js/21.0e0ed140.js"><link rel="prefetch" href="/assets/js/22.ff4c8ad5.js"><link rel="prefetch" href="/assets/js/23.4f896de4.js"><link rel="prefetch" href="/assets/js/24.6ba53300.js"><link rel="prefetch" href="/assets/js/25.41dca26b.js"><link rel="prefetch" href="/assets/js/26.6337eac0.js"><link rel="prefetch" href="/assets/js/27.de80589e.js"><link rel="prefetch" href="/assets/js/28.6922a65b.js"><link rel="prefetch" href="/assets/js/29.7325b5ce.js"><link rel="prefetch" href="/assets/js/3.e62a71e4.js"><link rel="prefetch" href="/assets/js/30.e32f6b31.js"><link rel="prefetch" href="/assets/js/31.a532917f.js"><link rel="prefetch" href="/assets/js/32.13b70e91.js"><link rel="prefetch" href="/assets/js/33.06627774.js"><link rel="prefetch" href="/assets/js/34.6671ead6.js"><link rel="prefetch" href="/assets/js/35.8287c9dc.js"><link rel="prefetch" href="/assets/js/36.4fd54c47.js"><link rel="prefetch" href="/assets/js/37.51145580.js"><link rel="prefetch" href="/assets/js/38.40fe2658.js"><link rel="prefetch" href="/assets/js/39.6e2f31a6.js"><link rel="prefetch" href="/assets/js/4.73518a0f.js"><link rel="prefetch" href="/assets/js/40.0ada49bd.js"><link rel="prefetch" href="/assets/js/41.f961e422.js"><link rel="prefetch" href="/assets/js/42.49589583.js"><link rel="prefetch" href="/assets/js/43.5a509601.js"><link rel="prefetch" href="/assets/js/44.64fd3383.js"><link rel="prefetch" href="/assets/js/45.685623ac.js"><link rel="prefetch" href="/assets/js/46.b7523f9c.js"><link rel="prefetch" href="/assets/js/47.9bed4c1b.js"><link rel="prefetch" href="/assets/js/48.599890ae.js"><link rel="prefetch" href="/assets/js/5.94727770.js"><link rel="prefetch" href="/assets/js/50.b424b2c0.js"><link rel="prefetch" href="/assets/js/51.ef213b56.js"><link rel="prefetch" href="/assets/js/52.18c75eba.js"><link rel="prefetch" href="/assets/js/53.f76e624c.js"><link rel="prefetch" href="/assets/js/54.3098ec9f.js"><link rel="prefetch" href="/assets/js/55.3854eb8a.js"><link rel="prefetch" href="/assets/js/56.67ae905d.js"><link rel="prefetch" href="/assets/js/57.36581a94.js"><link rel="prefetch" href="/assets/js/58.e5a83b70.js"><link rel="prefetch" href="/assets/js/59.d2d9d842.js"><link rel="prefetch" href="/assets/js/6.0b558b79.js"><link rel="prefetch" href="/assets/js/60.96815912.js"><link rel="prefetch" href="/assets/js/61.08b4acf0.js"><link rel="prefetch" href="/assets/js/62.cc8fdced.js"><link rel="prefetch" href="/assets/js/63.41ff19e4.js"><link rel="prefetch" href="/assets/js/64.9b3def35.js"><link rel="prefetch" href="/assets/js/65.0b2ab47d.js"><link rel="prefetch" href="/assets/js/66.2ae7a107.js"><link rel="prefetch" href="/assets/js/67.79dd6daf.js"><link rel="prefetch" href="/assets/js/68.1b76c178.js"><link rel="prefetch" href="/assets/js/69.32609e29.js"><link rel="prefetch" href="/assets/js/70.b920a5f7.js"><link rel="prefetch" href="/assets/js/71.c3c29d34.js"><link rel="prefetch" href="/assets/js/72.9a370df8.js"><link rel="prefetch" href="/assets/js/73.caa8364a.js"><link rel="prefetch" href="/assets/js/74.26f8d9a5.js"><link rel="prefetch" href="/assets/js/75.7c86d41a.js"><link rel="prefetch" href="/assets/js/76.c1a8b6dd.js"><link rel="prefetch" href="/assets/js/77.3504d204.js"><link rel="prefetch" href="/assets/js/78.c0a4ffae.js"><link rel="prefetch" href="/assets/js/79.5ef8a2fb.js"><link rel="prefetch" href="/assets/js/8.0ec7f6e8.js"><link rel="prefetch" href="/assets/js/80.fdcb5fa1.js"><link rel="prefetch" href="/assets/js/81.8d6c43d2.js"><link rel="prefetch" href="/assets/js/82.3b90a7cc.js"><link rel="prefetch" href="/assets/js/83.f3a9ee0c.js"><link rel="prefetch" href="/assets/js/84.1fd412a9.js"><link rel="prefetch" href="/assets/js/85.f69467b2.js"><link rel="prefetch" href="/assets/js/86.da0422f5.js"><link rel="prefetch" href="/assets/js/87.67fcabb9.js"><link rel="prefetch" href="/assets/js/88.605444aa.js"><link rel="prefetch" href="/assets/js/89.f6f19b19.js"><link rel="prefetch" href="/assets/js/9.6e274fca.js"><link rel="prefetch" href="/assets/js/90.ca1ff100.js"><link rel="prefetch" href="/assets/js/91.2b9bd4e6.js"><link rel="prefetch" href="/assets/js/92.6b777d4b.js"><link rel="prefetch" href="/assets/js/93.f8975bc4.js"><link rel="prefetch" href="/assets/js/94.0b55855d.js"><link rel="prefetch" href="/assets/js/95.342f5a9b.js"><link rel="prefetch" href="/assets/js/96.5ed2d348.js"><link rel="prefetch" href="/assets/js/97.4d4bfff5.js"><link rel="prefetch" href="/assets/js/98.10f4b27a.js"><link rel="prefetch" href="/assets/js/99.4a895015.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c76c3453.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="ç›®å½•" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="EchoDesign" class="logo"> <span class="site-name can-hide">EchoDesign</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">ğŸ é¦–é¡µ</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">âœ’ï¸çƒ­é—¨ç®—æ³•</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ğŸ–ï¸èµæç»å…¸è®¾è®¡" class="dropdown-title"><!----> <span class="title" style="display:;">ğŸ–ï¸èµæç»å…¸è®¾è®¡</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis æ·±åº¦å‰–æ</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka æ·±åº¦å‰–æ</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty æ·±åº¦å‰–æ</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx æ·±åº¦å‰–æ</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ğŸ§‘â€ğŸ’»å®æˆ˜ç³»ç»Ÿè®¾è®¡</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">â“é—®ç­”</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ğŸ‘€åŠ¨æ€</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">ğŸ é¦–é¡µ</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">âœ’ï¸çƒ­é—¨ç®—æ³•</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ğŸ–ï¸èµæç»å…¸è®¾è®¡" class="dropdown-title"><!----> <span class="title" style="display:;">ğŸ–ï¸èµæç»å…¸è®¾è®¡</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis æ·±åº¦å‰–æ</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka æ·±åº¦å‰–æ</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty æ·±åº¦å‰–æ</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx æ·±åº¦å‰–æ</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ğŸ§‘â€ğŸ’»å®æˆ˜ç³»ç»Ÿè®¾è®¡</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">â“é—®ç­”</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ğŸ‘€åŠ¨æ€</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ä¸€ã€å‰è¨€</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>äºŒã€åŸºç¡€çŸ¥è¯†</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>ä¸‰ã€ä¸»çº¿ä»»åŠ¡</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/b0bc66/" class="sidebar-link">Netty æ¡†æ¶æ¦‚è¿°</a></li><li><a href="/pages/9582d0/" class="sidebar-link">Bootstrapï¼ˆclientï¼‰æºç è§£æ</a></li><li><a href="/pages/b2a14a/" class="sidebar-link">Bootstrapï¼ˆserverï¼‰æºç è§£æ</a></li><li><a href="/pages/8d1ba9/Channel/" class="sidebar-link">Channel æºç è§£æ</a></li><li><a href="/pages/397456/" class="sidebar-link">EventLoop æºç è§£æ</a></li><li><a href="/pages/ce1f78/" class="sidebar-link">ChannelHandler æºç è§£æ</a></li><li><a href="/pages/4234c0/" aria-current="page" class="active sidebar-link">ChannelPipeline æºç è§£æ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/4234c0/#å‰è¨€" class="sidebar-link">å‰è¨€</a></li><li class="sidebar-sub-header level2"><a href="/pages/4234c0/#channel-ä¸-channelpipeline" class="sidebar-link">Channel ä¸ ChannelPipeline</a></li><li class="sidebar-sub-header level2"><a href="/pages/4234c0/#channelpipeline-çš„åˆå§‹åŒ–å†æ¢" class="sidebar-link">ChannelPipeline çš„åˆå§‹åŒ–å†æ¢</a></li><li class="sidebar-sub-header level2"><a href="/pages/4234c0/#è‡ªå®šä¹‰-channelhandler-çš„æ·»åŠ è¿‡ç¨‹" class="sidebar-link">è‡ªå®šä¹‰ ChannelHandler çš„æ·»åŠ è¿‡ç¨‹</a></li><li class="sidebar-sub-header level2"><a href="/pages/4234c0/#channelhandler-çš„åå­—" class="sidebar-link">ChannelHandler çš„åå­—</a></li><li class="sidebar-sub-header level2"><a href="/pages/4234c0/#å…³äº-pipeline-çš„äº‹ä»¶ä¼ è¾“æœºåˆ¶" class="sidebar-link">å…³äº Pipeline çš„äº‹ä»¶ä¼ è¾“æœºåˆ¶</a></li><li class="sidebar-sub-header level2"><a href="/pages/4234c0/#æ€»ç»“-2" class="sidebar-link">æ€»ç»“</a></li><li class="sidebar-sub-header level2"><a href="/pages/4234c0/#å‚è€ƒèµ„æ–™" class="sidebar-link">å‚è€ƒèµ„æ–™</a></li></ul></li><li><a href="/pages/43eb30/" class="sidebar-link">ByteBuf æºç è§£æ</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>å››ã€æ·±å…¥ Netty æ ¸å¿ƒ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>äº”ã€æ·±å…¥ Netty å†…å­˜ç®¡ç†</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="é¦–é¡µ" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>Netty ç³»ç»Ÿè®¾è®¡</span></li><li data-v-06225672><span data-v-06225672>ä¸‰ã€ä¸»çº¿ä»»åŠ¡</span></li></ul> <div class="info" data-v-06225672><div title="ä½œè€…" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/brother-one" target="_blank" title="ä½œè€…" class="beLink" data-v-06225672>echo</a></div> <div title="åˆ›å»ºæ—¶é—´" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-09-18</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">ç›®å½•</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">ChannelPipeline æºç è§£æ<!----></h1> <div class="page-slot page-slot-top">
    <div class="wwads-cn wwads-horizontal page-wwads" data-id="136"></div>
    <style>
      .page-wwads{
        width:100%!important;
        min-height: 0;
        margin: 0;
      }
      .page-wwads .wwads-img img{
        width:80px!important;
      }
      .page-wwads .wwads-poweredby{
        width: 40px;
        position: absolute;
        right: 25px;
        bottom: 3px;
      }
      .wwads-content .wwads-text, .page-wwads .wwads-text{
        height: 100%;
        padding-top: 5px;
        display: block;
      }
  </style>
  </div> <div class="theme-vdoing-content content__default"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="header-anchor">#</a> å‰è¨€</h2> <p>è¿™ç¯‡æ˜¯ <strong>Netty æºç åˆ†æ</strong> çš„ç¬¬äºŒç¯‡, åœ¨è¿™ç¯‡æ–‡ç« ä¸­, æˆ‘ä¼šä¸ºè¯»è€…è¯¦ç»†åœ°åˆ†æ Netty ä¸­çš„ ChannelPipeline æœºåˆ¶.</p> <h2 id="channel-ä¸-channelpipeline"><a href="#channel-ä¸-channelpipeline" class="header-anchor">#</a> Channel ä¸ ChannelPipeline</h2> <p>ç›¸ä¿¡å¤§å®¶éƒ½çŸ¥é“äº†, åœ¨ Netty ä¸­æ¯ä¸ª Channel éƒ½æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª ChannelPipeline ä¸ä¹‹å¯¹åº”, å®ƒä»¬çš„ç»„æˆå…³ç³»å¦‚ä¸‹:</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409182343315.png" alt="image-20240918234347275"></p> <p>é€šè¿‡ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ°, ä¸€ä¸ª Channel åŒ…å«äº†ä¸€ä¸ª ChannelPipeline, è€Œ ChannelPipeline ä¸­åˆç»´æŠ¤äº†ä¸€ä¸ªç”± ChannelHandlerContext ç»„æˆçš„åŒå‘é“¾è¡¨. è¿™ä¸ªé“¾è¡¨çš„å¤´æ˜¯ HeadContext, é“¾è¡¨çš„å°¾æ˜¯ TailContext, å¹¶ä¸”æ¯ä¸ª ChannelHandlerContext ä¸­åˆå…³è”ç€ä¸€ä¸ª ChannelHandler. ä¸Šé¢çš„å›¾ç¤ºç»™äº†æˆ‘ä»¬ä¸€ä¸ªå¯¹ ChannelPipeline çš„ç›´è§‚è®¤è¯†, ä½†æ˜¯å®é™…ä¸Š Netty å®ç°çš„ Channel æ˜¯å¦çœŸçš„æ˜¯è¿™æ ·çš„å‘¢? æˆ‘ä»¬ç»§ç»­ç”¨æºç è¯´è¯.</p> <p>åœ¨ç¬¬ä¸€ç«  <strong>Netty æºç åˆ†æä¹‹ ä¸€ æ­å¼€ Bootstrap ç¥ç§˜çš„çº¢ç›–å¤´</strong> ä¸­, æˆ‘ä»¬å·²ç»çŸ¥é“äº†ä¸€ä¸ª Channel çš„åˆå§‹åŒ–çš„åŸºæœ¬è¿‡ç¨‹, ä¸‹é¢æˆ‘ä»¬å†å›é¡¾ä¸€ä¸‹. ä¸‹é¢çš„ä»£ç æ˜¯ AbstractChannel æ„é€ å™¨:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">AbstractChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>
    unsafe <span class="token operator">=</span> <span class="token function">newUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pipeline <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultChannelPipeline</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>AbstractChannel æœ‰ä¸€ä¸ª pipeline å­—æ®µ, åœ¨æ„é€ å™¨ä¸­ä¼šåˆå§‹åŒ–å®ƒä¸º DefaultChannelPipelineçš„å®ä¾‹. è¿™é‡Œçš„ä»£ç å°±å°è¯äº†ä¸€ç‚¹: <code>æ¯ä¸ª Channel éƒ½æœ‰ä¸€ä¸ª ChannelPipeline</code>. æ¥ç€æˆ‘ä»¬è·Ÿè¸ªä¸€ä¸‹ DefaultChannelPipeline çš„åˆå§‹åŒ–è¿‡ç¨‹. é¦–å…ˆè¿›å…¥åˆ° DefaultChannelPipeline æ„é€ å™¨ä¸­:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">DefaultChannelPipeline</span><span class="token punctuation">(</span><span class="token class-name">AbstractChannel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>channel <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">&quot;channel&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>channel <span class="token operator">=</span> channel<span class="token punctuation">;</span>

    tail <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TailContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    head <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HeadContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    head<span class="token punctuation">.</span>next <span class="token operator">=</span> tail<span class="token punctuation">;</span>
    tail<span class="token punctuation">.</span>prev <span class="token operator">=</span> head<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨ DefaultChannelPipeline æ„é€ å™¨ä¸­, é¦–å…ˆå°†ä¸ä¹‹å…³è”çš„ Channel ä¿å­˜åˆ°å­—æ®µ channel ä¸­, ç„¶åå®ä¾‹åŒ–ä¸¤ä¸ª ChannelHandlerContext, ä¸€ä¸ªæ˜¯ HeadContext å®ä¾‹ head, å¦ä¸€ä¸ªæ˜¯ TailContext å®ä¾‹ tail. æ¥ç€å°† head å’Œ tail äº’ç›¸æŒ‡å‘, æ„æˆä¸€ä¸ªåŒå‘é“¾è¡¨. <code>ç‰¹åˆ«æ³¨æ„åˆ°, æˆ‘ä»¬åœ¨å¼€å§‹çš„ç¤ºæ„å›¾ä¸­, head å’Œ tail å¹¶æ²¡æœ‰åŒ…å« ChannelHandler</code>, è¿™æ˜¯å› ä¸º HeadContext å’Œ TailContext ç»§æ‰¿äº AbstractChannelHandlerContext çš„åŒæ—¶ä¹Ÿå®ç°äº† ChannelHandler æ¥å£äº†, å› æ­¤å®ƒä»¬æœ‰ Context å’Œ Handler çš„åŒé‡å±æ€§.</p> <h2 id="channelpipeline-çš„åˆå§‹åŒ–å†æ¢"><a href="#channelpipeline-çš„åˆå§‹åŒ–å†æ¢" class="header-anchor">#</a> ChannelPipeline çš„åˆå§‹åŒ–å†æ¢</h2> <p>åœ¨ç¬¬ä¸€ç« çš„æ—¶å€™, æˆ‘ä»¬å·²ç»å¯¹ ChannelPipeline çš„åˆå§‹åŒ–æœ‰äº†ä¸€ä¸ªå¤§è‡´çš„äº†è§£, ä¸è¿‡å½“æ—¶é‡ç‚¹æ¯•ç«Ÿä¸åœ¨ ChannelPipeline è¿™é‡Œ, å› æ­¤æ²¡æœ‰æ·±å…¥åœ°åˆ†æå®ƒçš„åˆå§‹åŒ–è¿‡ç¨‹. é‚£ä¹ˆä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹ä¸€ä¸‹å…·ä½“çš„ ChannelPipeline çš„åˆå§‹åŒ–éƒ½åšäº†å“ªäº›å·¥ä½œå§.</p> <h3 id="channelpipeline-å®ä¾‹åŒ–è¿‡ç¨‹"><a href="#channelpipeline-å®ä¾‹åŒ–è¿‡ç¨‹" class="header-anchor">#</a> ChannelPipeline å®ä¾‹åŒ–è¿‡ç¨‹</h3> <p>æˆ‘ä»¬å†æ¥å›é¡¾ä¸€ä¸‹, åœ¨å®ä¾‹åŒ–ä¸€ä¸ª Channel æ—¶, ä¼šä¼´éšç€ä¸€ä¸ª ChannelPipeline çš„å®ä¾‹åŒ–, å¹¶ä¸”æ­¤ Channel ä¼šä¸è¿™ä¸ª ChannelPipeline ç›¸äº’å…³è”, è¿™ä¸€ç‚¹å¯ä»¥é€šè¿‡NioSocketChannel çš„çˆ¶ç±» AbstractChannel çš„æ„é€ å™¨äºˆä»¥ä½è¯:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">AbstractChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>
    unsafe <span class="token operator">=</span> <span class="token function">newUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pipeline <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultChannelPipeline</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å½“å®ä¾‹åŒ–ä¸€ä¸ª Channel(è¿™é‡Œä»¥ EchoClient ä¸ºä¾‹, é‚£ä¹ˆ Channel å°±æ˜¯ NioSocketChannel), å…¶ pipeline å­—æ®µå°±æ˜¯æˆ‘ä»¬æ–°åˆ›å»ºçš„ DefaultChannelPipeline å¯¹è±¡, é‚£ä¹ˆæˆ‘ä»¬å°±æ¥çœ‹ä¸€ä¸‹ DefaultChannelPipeline çš„æ„é€ æ–¹æ³•å§:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">DefaultChannelPipeline</span><span class="token punctuation">(</span><span class="token class-name">AbstractChannel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>channel <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">&quot;channel&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>channel <span class="token operator">=</span> channel<span class="token punctuation">;</span>

    tail <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TailContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    head <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HeadContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    head<span class="token punctuation">.</span>next <span class="token operator">=</span> tail<span class="token punctuation">;</span>
    tail<span class="token punctuation">.</span>prev <span class="token operator">=</span> head<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¯ä»¥çœ‹åˆ°, åœ¨ DefaultChannelPipeline çš„æ„é€ æ–¹æ³•ä¸­, å°†ä¼ å…¥çš„ channel èµ‹å€¼ç»™å­—æ®µ this.channel, æ¥ç€åˆå®ä¾‹åŒ–äº†ä¸¤ä¸ªç‰¹æ®Šçš„å­—æ®µ: <strong>tail</strong> ä¸ <strong>head</strong>. è¿™ä¸¤ä¸ªå­—æ®µæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨çš„å¤´å’Œå°¾. å…¶å®åœ¨ DefaultChannelPipeline ä¸­, ç»´æŠ¤äº†ä¸€ä¸ªä»¥ AbstractChannelHandlerContext ä¸ºèŠ‚ç‚¹çš„åŒå‘é“¾è¡¨, è¿™ä¸ªé“¾è¡¨æ˜¯ Netty å®ç° Pipeline æœºåˆ¶çš„å…³é”®. å†å›é¡¾ä¸€ä¸‹ head å’Œ tail çš„ç±»å±‚æ¬¡ç»“æ„:</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409182347586.png" alt="HeadContext ç±»å±‚æ¬¡ç»“æ„.png"></p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409182347847.png" alt="TailContext ç±»å±‚æ¬¡ç»“æ„.png"></p> <p>ä»ç±»å±‚æ¬¡ç»“æ„å›¾ä¸­å¯ä»¥å¾ˆæ¸…æ¥šåœ°çœ‹åˆ°, head å®ç°äº† <strong>ChannelInboundHandler</strong>, è€Œ tail å®ç°äº† <strong>ChannelOutboundHandler</strong> æ¥å£, å¹¶ä¸”å®ƒä»¬éƒ½å®ç°äº† <strong>ChannelHandlerContext</strong> æ¥å£, å› æ­¤å¯ä»¥è¯´ <strong>head å’Œ tail æ—¢æ˜¯ä¸€ä¸ª ChannelHandler, åˆæ˜¯ä¸€ä¸ª ChannelHandlerContext.</strong></p> <p>æ¥ç€çœ‹ä¸€ä¸‹ HeadContext çš„æ„é€ å™¨:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">HeadContext</span><span class="token punctuation">(</span><span class="token class-name">DefaultChannelPipeline</span> pipeline<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>pipeline<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token constant">HEAD_NAME</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    unsafe <span class="token operator">=</span> pipeline<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å®ƒè°ƒç”¨äº†çˆ¶ç±» AbstractChannelHandlerContext çš„æ„é€ å™¨, å¹¶ä¼ å…¥å‚æ•° inbound = false, outbound = true. TailContext çš„æ„é€ å™¨ä¸ HeadContext çš„ç›¸å, å®ƒè°ƒç”¨äº†çˆ¶ç±» AbstractChannelHandlerContext çš„æ„é€ å™¨, å¹¶ä¼ å…¥å‚æ•° inbound = true, outbound = false. å³ header æ˜¯ä¸€ä¸ª outboundHandler, è€Œ tail æ˜¯ä¸€ä¸ªinboundHandler, å…³äºè¿™ä¸€ç‚¹, å¤§å®¶è¦ç‰¹åˆ«æ³¨æ„, å› ä¸ºåœ¨åé¢çš„åˆ†æä¸­, æˆ‘ä»¬ä¼šåå¤ç”¨åˆ° inbound å’Œ outbound è¿™ä¸¤ä¸ªå±æ€§.</p> <h3 id="é“¾è¡¨çš„èŠ‚ç‚¹-channelhandlercontext"><a href="#é“¾è¡¨çš„èŠ‚ç‚¹-channelhandlercontext" class="header-anchor">#</a> é“¾è¡¨çš„èŠ‚ç‚¹ ChannelHandlerContext</h3> <h3 id="channelinitializer-çš„æ·»åŠ "><a href="#channelinitializer-çš„æ·»åŠ " class="header-anchor">#</a> ChannelInitializer çš„æ·»åŠ </h3> <p>ä¸Šé¢ä¸€å°èŠ‚ä¸­, æˆ‘ä»¬å·²ç»åˆ†æäº† Channel çš„ç»„æˆ, å…¶ä¸­æˆ‘ä»¬äº†è§£åˆ°, æœ€å¼€å§‹çš„æ—¶å€™ ChannelPipeline ä¸­å«æœ‰ä¸¤ä¸ª ChannelHandlerContext(åŒæ—¶ä¹Ÿæ˜¯ ChannelHandler), ä½†æ˜¯è¿™ä¸ª Pipelineå¹¶ä¸èƒ½å®ç°ä»€ä¹ˆç‰¹æ®Šçš„åŠŸèƒ½, å› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰ç»™å®ƒæ·»åŠ è‡ªå®šä¹‰çš„ ChannelHandler. é€šå¸¸æ¥è¯´, æˆ‘ä»¬åœ¨åˆå§‹åŒ– Bootstrap, ä¼šæ·»åŠ æˆ‘ä»¬è‡ªå®šä¹‰çš„ ChannelHandler, å°±ä»¥æˆ‘ä»¬ç†Ÿæ‚‰çš„ EchoClient æ¥ä¸¾ä¾‹å§:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">Bootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">TCP_NODELAY</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token annotation punctuation">@Override</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
         <span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EchoClientHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ä¸Šé¢ä»£ç çš„åˆå§‹åŒ–è¿‡ç¨‹, ç›¸ä¿¡å¤§å®¶éƒ½ä¸é™Œç”Ÿ. åœ¨è°ƒç”¨ handler æ—¶, ä¼ å…¥äº† ChannelInitializer å¯¹è±¡, å®ƒæä¾›äº†ä¸€ä¸ª initChannel æ–¹æ³•ä¾›æˆ‘ä»¬åˆå§‹åŒ– ChannelHandler. é‚£ä¹ˆè¿™ä¸ªåˆå§‹åŒ–è¿‡ç¨‹æ˜¯æ€æ ·çš„å‘¢? ä¸‹é¢æˆ‘ä»¬å°±æ¥æ­å¼€å®ƒçš„ç¥ç§˜é¢çº±.</p> <p>ChannelInitializer å®ç°äº† ChannelHandler, é‚£ä¹ˆå®ƒæ˜¯åœ¨ä»€ä¹ˆæ—¶å€™æ·»åŠ åˆ° ChannelPipeline ä¸­çš„å‘¢? è¿›è¡Œäº†ä¸€ç•ªæœç´¢å, æˆ‘ä»¬å‘ç°å®ƒæ˜¯åœ¨ Bootstrap.init æ–¹æ³•ä¸­æ·»åŠ åˆ° ChannelPipeline ä¸­çš„. å…¶ä»£ç å¦‚ä¸‹:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸Šé¢çš„ä»£ç å°† handler() è¿”å›çš„ ChannelHandler æ·»åŠ åˆ° Pipeline ä¸­, è€Œ handler() è¿”å›çš„æ˜¯handler å…¶å®å°±æ˜¯æˆ‘ä»¬åœ¨åˆå§‹åŒ– Bootstrap è°ƒç”¨ handler è®¾ç½®çš„ ChannelInitializer å®ä¾‹, å› æ­¤è¿™é‡Œå°±æ˜¯å°† ChannelInitializer æ’å…¥åˆ°äº† Pipeline çš„æœ«ç«¯. æ­¤æ—¶ Pipeline çš„ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤º:</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409182350318.png" alt="image-20240918235057285"></p> <p>æœ‰æœ‹å‹å¯èƒ½å°±æœ‰ç–‘æƒ‘äº†, æˆ‘æ˜æ˜æ’å…¥çš„æ˜¯ä¸€ä¸ª ChannelInitializer å®ä¾‹, ä¸ºä»€ä¹ˆåœ¨ ChannelPipeline ä¸­çš„åŒå‘é“¾è¡¨ä¸­çš„å…ƒç´ å´æ˜¯ä¸€ä¸ª ChannelHandlerContext? ä¸ºäº†è§£ç­”è¿™ä¸ªé—®é¢˜, æˆ‘ä»¬ç»§ç»­åœ¨ä»£ç ä¸­å¯»æ‰¾ç­”æ¡ˆå§. æˆ‘ä»¬åˆšæ‰æåˆ°, åœ¨ Bootstrap.init ä¸­ä¼šè°ƒç”¨ p.addLast() æ–¹æ³•, å°† ChannelInitializer æ’å…¥åˆ°é“¾è¡¨æœ«ç«¯:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">addLast</span><span class="token punctuation">(</span><span class="token class-name">EventExecutorGroup</span> group<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">checkDuplicateName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ£€æŸ¥æ­¤ handler æ˜¯å¦æœ‰é‡å¤çš„åå­—</span>

        <span class="token class-name">AbstractChannelHandlerContext</span> newCtx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultChannelHandlerContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> group<span class="token punctuation">,</span> name<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addLast0</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> newCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>addLast æœ‰å¾ˆå¤šé‡è½½çš„æ–¹æ³•, æˆ‘ä»¬å…³æ³¨è¿™ä¸ªæ¯”è¾ƒé‡è¦çš„æ–¹æ³•å°±å¯ä»¥äº†. ä¸Šé¢çš„ addLast æ–¹æ³•ä¸­, é¦–å…ˆæ£€æŸ¥è¿™ä¸ª ChannelHandler çš„åå­—æ˜¯å¦æ˜¯é‡å¤çš„, å¦‚æœä¸é‡å¤çš„è¯, åˆ™ä¸ºè¿™ä¸ª Handler åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„ DefaultChannelHandlerContext å®ä¾‹, å¹¶ä¸ä¹‹å…³è”èµ·æ¥(Context ä¸­æœ‰ä¸€ä¸ª handler å±æ€§ä¿å­˜ç€å¯¹åº”çš„ Handler å®ä¾‹). åˆ¤æ–­æ­¤ Handler æ˜¯å¦é‡åçš„æ–¹æ³•å¾ˆç®€å•: Netty ä¸­æœ‰ä¸€ä¸ª <strong>name2ctx</strong> Map å­—æ®µ, key æ˜¯ handler çš„åå­—, è€Œ value åˆ™æ˜¯ handler æœ¬èº«. å› æ­¤é€šè¿‡å¦‚ä¸‹ä»£ç å°±å¯ä»¥åˆ¤æ–­ä¸€ä¸ª handler æ˜¯å¦é‡åäº†:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkDuplicateName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>name2ctx<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Duplicate handler name: &quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸ºäº†æ·»åŠ ä¸€ä¸ª handler åˆ° pipeline ä¸­, å¿…é¡»æŠŠæ­¤ handler åŒ…è£…æˆ ChannelHandlerContext. å› æ­¤åœ¨ä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ–°å®ä¾‹åŒ–äº†ä¸€ä¸ª newCtx å¯¹è±¡, å¹¶å°† handler ä½œä¸ºå‚æ•°ä¼ é€’åˆ°æ„é€ æ–¹æ³•ä¸­. é‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ä¾‹åŒ–çš„ DefaultChannelHandlerContext åˆ°åº•æœ‰ä»€ä¹ˆç„æœºå§. é¦–å…ˆçœ‹å®ƒçš„æ„é€ å™¨:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">DefaultChannelHandlerContext</span><span class="token punctuation">(</span>
        <span class="token class-name">DefaultChannelPipeline</span> pipeline<span class="token punctuation">,</span> <span class="token class-name">EventExecutorGroup</span> group<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>pipeline<span class="token punctuation">,</span> group<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token function">isInbound</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">isOutbound</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">&quot;handler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>handler <span class="token operator">=</span> handler<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>DefaultChannelHandlerContext çš„æ„é€ å™¨ä¸­, è°ƒç”¨äº†ä¸¤ä¸ªå¾ˆæœ‰æ„æ€çš„æ–¹æ³•: <strong>isInbound</strong> ä¸ <strong>isOutbound</strong>, è¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯åšä»€ä¹ˆçš„å‘¢?</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isInbound</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> handler <span class="token keyword">instanceof</span> <span class="token class-name">ChannelInboundHandler</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isOutbound</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> handler <span class="token keyword">instanceof</span> <span class="token class-name">ChannelOutboundHandler</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä»æºç ä¸­å¯ä»¥çœ‹åˆ°, å½“ä¸€ä¸ª handler å®ç°äº† ChannelInboundHandler æ¥å£, åˆ™ isInbound è¿”å›çœŸ; ç›¸ä¼¼åœ°, å½“ä¸€ä¸ª handler å®ç°äº† ChannelOutboundHandler æ¥å£, åˆ™ isOutbound å°±è¿”å›çœŸ. è€Œè¿™ä¸¤ä¸ª boolean å˜é‡ä¼šä¼ é€’åˆ°çˆ¶ç±» AbstractChannelHandlerContext ä¸­, å¹¶åˆå§‹åŒ–çˆ¶ç±»çš„ä¸¤ä¸ªå­—æ®µ: <strong>inbound</strong> ä¸ <strong>outbound</strong>. é‚£ä¹ˆè¿™é‡Œçš„ ChannelInitializer æ‰€å¯¹åº”çš„ DefaultChannelHandlerContext çš„ inbound ä¸ inbound å­—æ®µåˆ†åˆ«æ˜¯ä»€ä¹ˆå‘¢? é‚£å°±çœ‹ä¸€ä¸‹ ChannelInitializer åˆ°åº•å®ç°äº†å“ªä¸ªæ¥å£ä¸å°±è¡Œäº†? å¦‚ä¸‹æ˜¯ ChannelInitializer çš„ç±»å±‚æ¬¡ç»“æ„å›¾ï¼š</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409182352418.png" alt="image-20240918235249371"></p> <p>å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°, ChannelInitializer ä»…ä»…å®ç°äº† ChannelInboundHandler æ¥å£, å› æ­¤è¿™é‡Œå®ä¾‹åŒ–çš„ DefaultChannelHandlerContext çš„ inbound = true, outbound = false. ä¸å°±æ˜¯ inbound å’Œ outbound ä¸¤ä¸ªå­—æ®µå˜›, ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¹ˆå¤§è´¹å‘¨ç« åœ°åˆ†æä¸€ç•ª? å…¶å®è¿™ä¸¤ä¸ªå­—æ®µå…³ç³»åˆ° pipeline çš„äº‹ä»¶çš„æµå‘ä¸åˆ†ç±», å› æ­¤æ˜¯ååˆ†å…³é”®çš„, ä¸è¿‡æˆ‘åœ¨è¿™é‡Œå…ˆå–ä¸ªå…³å­, åé¢æˆ‘ä»¬å†æ¥è¯¦ç»†åˆ†æè¿™ä¸¤ä¸ªå­—æ®µæ‰€èµ·çš„ä½œç”¨. åœ¨è¿™é‡Œ, è¯»è€…åªéœ€è¦è®°ä½, <strong>ChannelInitializer æ‰€å¯¹åº”çš„ DefaultChannelHandlerContext çš„ inbound = true, outbound = false</strong> å³å¯.</p> <p>å½“åˆ›å»ºå¥½ Context å, å°±å°†è¿™ä¸ª Context æ’å…¥åˆ° Pipeline çš„åŒå‘é“¾è¡¨ä¸­:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addLast0</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">AbstractChannelHandlerContext</span> newCtx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">checkMultiplicity</span><span class="token punctuation">(</span>newCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">AbstractChannelHandlerContext</span> prev <span class="token operator">=</span> tail<span class="token punctuation">.</span>prev<span class="token punctuation">;</span>
    newCtx<span class="token punctuation">.</span>prev <span class="token operator">=</span> prev<span class="token punctuation">;</span>
    newCtx<span class="token punctuation">.</span>next <span class="token operator">=</span> tail<span class="token punctuation">;</span>
    prev<span class="token punctuation">.</span>next <span class="token operator">=</span> newCtx<span class="token punctuation">;</span>
    tail<span class="token punctuation">.</span>prev <span class="token operator">=</span> newCtx<span class="token punctuation">;</span>

    name2ctx<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> newCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">callHandlerAdded</span><span class="token punctuation">(</span>newCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ˜¾ç„¶, è¿™ä¸ªä»£ç å°±æ˜¯å…¸å‹çš„åŒå‘é“¾è¡¨çš„æ’å…¥æ“ä½œäº†. å½“è°ƒç”¨äº† addLast æ–¹æ³•å, Netty å°±ä¼šå°†æ­¤ handler æ·»åŠ åˆ°åŒå‘é“¾è¡¨ä¸­ tail å…ƒç´ ä¹‹å‰çš„ä½ç½®.</p> <h2 id="è‡ªå®šä¹‰-channelhandler-çš„æ·»åŠ è¿‡ç¨‹"><a href="#è‡ªå®šä¹‰-channelhandler-çš„æ·»åŠ è¿‡ç¨‹" class="header-anchor">#</a> è‡ªå®šä¹‰ ChannelHandler çš„æ·»åŠ è¿‡ç¨‹</h2> <p>åœ¨ä¸Šä¸€å°èŠ‚ä¸­, æˆ‘ä»¬å·²ç»åˆ†æäº†ä¸€ä¸ª ChannelInitializer å¦‚ä½•æ’å…¥åˆ° Pipeline ä¸­çš„, æ¥ä¸‹æ¥å°±æ¥æ¢è®¨ä¸€ä¸‹ ChannelInitializer åœ¨å“ªé‡Œè¢«è°ƒç”¨, ChannelInitializer çš„ä½œç”¨, ä»¥åŠæˆ‘ä»¬è‡ªå®šä¹‰çš„ ChannelHandler æ˜¯å¦‚ä½•æ’å…¥åˆ° Pipeline ä¸­çš„.</p> <p>åœ¨ <strong>Netty æºç åˆ†æä¹‹ ä¸€ æ­å¼€ Bootstrap ç¥ç§˜çš„çº¢ç›–å¤´ (å®¢æˆ·ç«¯)</strong> ä¸€ç« çš„ <strong>channel çš„æ³¨å†Œè¿‡ç¨‹</strong> å°èŠ‚ä¸­, æˆ‘ä»¬å·²ç»åˆ†æè¿‡ Channel çš„æ³¨å†Œè¿‡ç¨‹äº†, è¿™é‡Œæˆ‘ä»¬å†ç®€å•åœ°å¤ä¹ ä¸€ä¸‹:</p> <ul><li>é¦–å…ˆåœ¨ AbstractBootstrap.initAndRegisterä¸­, é€šè¿‡ group().register(channel), è°ƒç”¨ MultithreadEventLoopGroup.register æ–¹æ³•</li> <li>åœ¨MultithreadEventLoopGroup.register ä¸­, é€šè¿‡ next() è·å–ä¸€ä¸ªå¯ç”¨çš„ SingleThreadEventLoop, ç„¶åè°ƒç”¨å®ƒçš„ register</li> <li>åœ¨ SingleThreadEventLoop.register ä¸­, é€šè¿‡ channel.unsafe().register(this, promise) æ¥è·å– channel çš„ unsafe() åº•å±‚æ“ä½œå¯¹è±¡, ç„¶åè°ƒç”¨å®ƒçš„ register.</li> <li>åœ¨ AbstractUnsafe.register æ–¹æ³•ä¸­, è°ƒç”¨ register0 æ–¹æ³•æ³¨å†Œ Channel</li> <li>åœ¨ AbstractUnsafe.register0 ä¸­, è°ƒç”¨ AbstractNioChannel#doRegister æ–¹æ³•</li> <li>AbstractNioChannel.doRegister æ–¹æ³•é€šè¿‡ javaChannel().register(eventLoop().selector, 0, this) å°† Channel å¯¹åº”çš„ Java NIO SockerChannel æ³¨å†Œåˆ°ä¸€ä¸ª eventLoop çš„ Selector ä¸­, å¹¶ä¸”å°†å½“å‰ Channel ä½œä¸º attachment.</li></ul> <p>è€Œæˆ‘ä»¬è‡ªå®šä¹‰ ChannelHandler çš„æ·»åŠ è¿‡ç¨‹, å‘ç”Ÿåœ¨ AbstractUnsafe.register0 ä¸­, åœ¨è¿™ä¸ªæ–¹æ³•ä¸­è°ƒç”¨äº† pipeline.fireChannelRegistered() æ–¹æ³•, å…¶å®ç°å¦‚ä¸‹:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">fireChannelRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    head<span class="token punctuation">.</span><span class="token function">fireChannelRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸Šé¢çš„ä»£ç å¾ˆç®€å•, å°±æ˜¯è°ƒç”¨äº† head.fireChannelRegistered() æ–¹æ³•è€Œå·².</p> <blockquote><p>å…³äºä¸Šé¢ä»£ç çš„ head.fireXXX çš„è°ƒç”¨å½¢å¼, æ˜¯ Netty ä¸­ Pipeline ä¼ é€’äº‹ä»¶çš„å¸¸ç”¨æ–¹å¼, æˆ‘ä»¬ä»¥åä¼šç»å¸¸çœ‹åˆ°.</p></blockquote> <p>è¿˜è®°å¾— head çš„ ç±»å±‚æ¬¡ç»“æ„å›¾ä¸, head æ˜¯ä¸€ä¸ª AbstractChannelHandlerContext å®ä¾‹, å¹¶ä¸”å®ƒæ²¡æœ‰é‡å†™ fireChannelRegistered æ–¹æ³•, å› æ­¤ head.fireChannelRegistered å…¶å®æ˜¯è°ƒç”¨çš„ AbstractChannelHandlerContext.fireChannelRegistered:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ChannelHandlerContext</span> <span class="token function">fireChannelRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">AbstractChannelHandlerContext</span> next <span class="token operator">=</span> <span class="token function">findContextInbound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">EventExecutor</span> executor <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>executor<span class="token punctuation">.</span><span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        next<span class="token punctuation">.</span><span class="token function">invokeChannelRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OneTimeTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                next<span class="token punctuation">.</span><span class="token function">invokeChannelRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¿™ä¸ªæ–¹æ³•çš„ç¬¬ä¸€å¥æ˜¯è°ƒç”¨ findContextInbound è·å–ä¸€ä¸ª Context, é‚£ä¹ˆå®ƒè¿”å›çš„ Context åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢? æˆ‘ä»¬è·Ÿè¿›ä»£ç ä¸­çœ‹ä¸€ä¸‹:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">AbstractChannelHandlerContext</span> <span class="token function">findContextInbound</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AbstractChannelHandlerContext</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        ctx <span class="token operator">=</span> ctx<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>inbound<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ctx<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¾ˆæ˜¾ç„¶, è¿™ä¸ªä»£ç ä¼šä» head å¼€å§‹éå† Pipeline çš„åŒå‘é“¾è¡¨, ç„¶åæ‰¾åˆ°ç¬¬ä¸€ä¸ªå±æ€§ inbound ä¸º true çš„ ChannelHandlerContext å®ä¾‹. æƒ³èµ·æ¥äº†æ²¡? æˆ‘ä»¬åœ¨å‰é¢åˆ†æ ChannelInitializer æ—¶, èŠ±äº†å¤§é‡çš„ç¬”å¢¨æ¥åˆ†æäº† inbound å’Œ outbound å±æ€§, ä½ çœ‹ç°åœ¨è¿™é‡Œå°±ç”¨ä¸Šäº†. å›æƒ³ä¸€ä¸‹, ChannelInitializer å®ç°äº† ChannelInboudHandler, å› æ­¤å®ƒæ‰€å¯¹åº”çš„ ChannelHandlerContext çš„ inbound å±æ€§å°±æ˜¯ true, å› æ­¤è¿™é‡Œè¿”å›å°±æ˜¯ ChannelInitializer å®ä¾‹æ‰€å¯¹åº”çš„ ChannelHandlerContext. å³:</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409182357565.png" alt="image-20240918235746523"></p> <p>å½“è·å–åˆ° inbound çš„ Context å, å°±è°ƒç”¨å®ƒçš„ invokeChannelRegistered æ–¹æ³•:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeChannelRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ChannelInboundHandler</span><span class="token punctuation">)</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">channelRegistered</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">notifyHandlerException</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æˆ‘ä»¬å·²ç»å¼ºè°ƒè¿‡äº†, æ¯ä¸ª ChannelHandler éƒ½ä¸ä¸€ä¸ª ChannelHandlerContext å…³è”, æˆ‘ä»¬å¯ä»¥é€šè¿‡ ChannelHandlerContext è·å–åˆ°å¯¹åº”çš„ ChannelHandler. å› æ­¤å¾ˆæ˜¾ç„¶äº†, è¿™é‡Œ handler() è¿”å›çš„, å…¶å®å°±æ˜¯ä¸€å¼€å§‹æˆ‘ä»¬å®ä¾‹åŒ–çš„ ChannelInitializer å¯¹è±¡, å¹¶æ¥ç€è°ƒç”¨äº† ChannelInitializer.channelRegistered æ–¹æ³•. çœ‹åˆ°è¿™é‡Œ, è¯»è€…æœ‹å‹æ˜¯å¦ä¼šè§‰å¾—æœ‰ç‚¹çœ¼ç†Ÿå‘¢ï¼ŸChannelInitializer.channelRegistered è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬åœ¨ç¬¬ä¸€ç« çš„æ—¶å€™å·²ç»å¤§é‡åœ°æ¥è§¦äº†, ä½†æ˜¯æˆ‘ä»¬å¹¶æ²¡æœ‰æ·±å…¥åœ°åˆ†æè¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨è¿‡ç¨‹, é‚£ä¹ˆåœ¨è¿™é‡Œè¯»è€…æœ‹å‹åº”è¯¥å¯¹å®ƒçš„è°ƒç”¨æœ‰äº†æ›´åŠ æ·±å…¥çš„äº†è§£äº†å§</p> <p>é‚£ä¹ˆè¿™ä¸ªæ–¹æ³•ä¸­åˆæœ‰ä»€ä¹ˆç„æœºå‘¢? ç»§ç»­çœ‹ä»£ç :</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">channelRegistered</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">C</span><span class="token punctuation">)</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">fireChannelRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>initChannel è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬å¾ˆç†Ÿæ‚‰äº†å§, å®ƒå°±æ˜¯æˆ‘ä»¬åœ¨åˆå§‹åŒ– Bootstrap æ—¶, è°ƒç”¨ handler æ–¹æ³•ä¼ å…¥çš„åŒ¿åå†…éƒ¨ç±»æ‰€å®ç°çš„æ–¹æ³•:</p> <div class="language-Java extra-class"><pre class="language-java"><code>bootstrap<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token annotation punctuation">@Override</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
         <span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EchoClientHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>å› æ­¤å½“è°ƒç”¨äº†è¿™ä¸ªæ–¹æ³•å, æˆ‘ä»¬è‡ªå®šä¹‰çš„ ChannelHandler å°±æ’å…¥åˆ° Pipeline äº†, æ­¤æ—¶çš„ Pipeline å¦‚ä¸‹å›¾æ‰€ç¤º:</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409190001027.png" alt="image-20240919000109982"></p> <p>å½“æ·»åŠ äº†è‡ªå®šä¹‰çš„ ChannelHandler å, ä¼šåˆ é™¤ ChannelInitializer è¿™ä¸ª ChannelHandler, å³ &quot;ctx.pipeline().remove(this)&quot;, å› æ­¤æœ€åçš„ Pipeline å¦‚ä¸‹:</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409190001933.png" alt=""></p> <p>å¥½äº†, åˆ°äº†è¿™é‡Œ, æˆ‘ä»¬çš„ <strong>è‡ªå®šä¹‰ ChannelHandler çš„æ·»åŠ è¿‡ç¨‹</strong> ä¹Ÿåˆ†æçš„æŸ¥ä¸å¤šäº†.</p> <h2 id="channelhandler-çš„åå­—"><a href="#channelhandler-çš„åå­—" class="header-anchor">#</a> ChannelHandler çš„åå­—</h2> <p>æˆ‘ä»¬æ³¨æ„åˆ°, pipeline.addXXX éƒ½æœ‰ä¸€ä¸ªé‡è½½çš„æ–¹æ³•, ä¾‹å¦‚ addLast, å®ƒæœ‰ä¸€ä¸ªé‡è½½çš„ç‰ˆæœ¬æ˜¯:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">ChannelPipeline</span> <span class="token function">addLast</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šäº†æ‰€æ·»åŠ çš„ handler çš„åå­—(æ›´å‡†ç¡®åœ°è¯´æ˜¯ ChannelHandlerContext çš„åå­—, ä¸è¿‡æˆ‘ä»¬é€šå¸¸æ˜¯ä»¥ handler ä½œä¸ºå™è¿°çš„å¯¹è±¡, å› æ­¤è¯´æˆ handler çš„åå­—ä¾¿äºç†è§£). é‚£ä¹ˆ handler çš„åå­—æœ‰ä»€ä¹ˆç”¨å‘¢? å¦‚æœæˆ‘ä»¬ä¸è®¾ç½®name, é‚£ä¹ˆ handler ä¼šæœ‰æ€æ ·çš„åå­—? ä¸ºäº†è§£ç­”è¿™äº›ç–‘æƒ‘, è€è§„çŸ©, ä¾ç„¶æ˜¯ä»æºç ä¸­æ‰¾åˆ°ç­”æ¡ˆ. æˆ‘ä»¬è¿˜æ˜¯ä»¥ addLast æ–¹æ³•ä¸ºä¾‹:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">addLast</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¿™ä¸ªæ–¹æ³•ä¼šè°ƒç”¨é‡è½½çš„ addLast æ–¹æ³•:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">addLast</span><span class="token punctuation">(</span><span class="token class-name">EventExecutorGroup</span> group<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">checkDuplicateName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">AbstractChannelHandlerContext</span> newCtx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultChannelHandlerContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> group<span class="token punctuation">,</span> name<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addLast0</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> newCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ç¬¬ä¸€ä¸ªå‚æ•°è¢«è®¾ç½®ä¸º null, æˆ‘ä»¬ä¸å…³ç³»å®ƒ. ç¬¬äºŒå‚æ•°å°±æ˜¯è¿™ä¸ª handler çš„åå­—. çœ‹ä»£ç å¯çŸ¥, åœ¨æ·»åŠ ä¸€ä¸ª handler ä¹‹å‰, éœ€è¦è°ƒç”¨ <strong>checkDuplicateName</strong> æ–¹æ³•æ¥ç¡®å®šæ­¤ handler çš„åå­—æ˜¯å¦å’Œå·²æ·»åŠ çš„ handler çš„åå­—é‡å¤. è€Œè¿™ä¸ª checkDuplicateName æ–¹æ³•æˆ‘ä»¬åœ¨å‰é¢å·²ç»æœ‰æåˆ°, è¿™é‡Œå†å›é¡¾ä¸€ä¸‹:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkDuplicateName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>name2ctx<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Duplicate handler name: &quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Netty åˆ¤æ–­ä¸€ä¸ª handler çš„åå­—æ˜¯å¦é‡å¤çš„ä¾æ®å¾ˆç®€å•: DefaultChannelPipeline ä¸­æœ‰ä¸€ä¸ª ç±»å‹ä¸º Map&lt;String, AbstractChannelHandlerContext&gt; çš„ <strong>name2ctx</strong> å­—æ®µ, å®ƒçš„ key æ˜¯ä¸€ä¸ª handler çš„åå­—, è€Œ value åˆ™æ˜¯è¿™ä¸ª handler æ‰€å¯¹åº”çš„ ChannelHandlerContext. æ¯å½“æ–°æ·»åŠ ä¸€ä¸ª handler æ—¶, å°±ä¼š put åˆ° name2ctx ä¸­. å› æ­¤æ£€æŸ¥ name2ctx ä¸­æ˜¯å¦åŒ…å«è¿™ä¸ª name å³å¯. å½“æ²¡æœ‰é‡åçš„ handler æ—¶, å°±ä¸ºè¿™ä¸ª handler ç”Ÿæˆä¸€ä¸ªå…³è”çš„ DefaultChannelHandlerContext å¯¹è±¡, ç„¶åå°±å°† name å’Œ newCtx ä½œä¸º key-value å¯¹ æ”¾åˆ° name2Ctx ä¸­.</p> <h3 id="è‡ªåŠ¨ç”Ÿæˆ-handler-çš„åå­—"><a href="#è‡ªåŠ¨ç”Ÿæˆ-handler-çš„åå­—" class="header-anchor">#</a> è‡ªåŠ¨ç”Ÿæˆ handler çš„åå­—</h3> <p>å¦‚æœæˆ‘ä»¬è°ƒç”¨çš„æ˜¯å¦‚ä¸‹çš„ addLast æ–¹æ³•</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">ChannelPipeline</span> <span class="token function">addLast</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> handlers<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>é‚£ä¹ˆ Netty ä¼šè°ƒç”¨ generateName ä¸ºæˆ‘ä»¬çš„ handler è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªåå­—:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">generateName</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">WeakHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> nameCaches<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> nameCaches<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> handlerType <span class="token operator">=</span> handler<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>cache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        name <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            name <span class="token operator">=</span> <span class="token function">generateName0</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// It's not very likely for a user to put more than one handler of the same type, but make sure to avoid</span>
        <span class="token comment">// any name conflicts.  Note that we don't cache the names generated here.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>name2ctx<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> baseName <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> name<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Strip the trailing '0'.</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> newName <span class="token operator">=</span> baseName <span class="token operator">+</span> i<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name2ctx<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>newName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    name <span class="token operator">=</span> newName<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è€Œ generateName ä¼šæ¥ç€è°ƒç”¨ <strong>generateName0</strong> æ¥å®é™…äº§ç”Ÿä¸€ä¸ª handler çš„åå­—:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">generateName0</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> handlerType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">simpleClassName</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;#0&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è‡ªåŠ¨ç”Ÿæˆçš„åå­—çš„è§„åˆ™å¾ˆç®€å•, å°±æ˜¯ handler çš„ç®€å•ç±»ååŠ ä¸Š &quot;#0&quot;, å› æ­¤æˆ‘ä»¬çš„ EchoClientHandler çš„åå­—å°±æ˜¯ &quot;EchoClientHandler#0&quot;, è¿™ä¸€ç‚¹ä¹Ÿå¯ä»¥é€šè¿‡è°ƒè¯•çª—å£ä½è¯:</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409190003646.png" alt="EchoClientHandler çš„åå­—.png"></p> <h2 id="å…³äº-pipeline-çš„äº‹ä»¶ä¼ è¾“æœºåˆ¶"><a href="#å…³äº-pipeline-çš„äº‹ä»¶ä¼ è¾“æœºåˆ¶" class="header-anchor">#</a> å…³äº Pipeline çš„äº‹ä»¶ä¼ è¾“æœºåˆ¶</h2> <p>å‰é¢ç« èŠ‚ä¸­, æˆ‘ä»¬çŸ¥é“ AbstractChannelHandlerContext ä¸­æœ‰ inbound å’Œ outbound ä¸¤ä¸ª boolean å˜é‡, åˆ†åˆ«ç”¨äºæ ‡è¯† Context æ‰€å¯¹åº”çš„ handler çš„ç±»å‹, å³:</p> <ul><li>inbound ä¸ºçœŸæ—¶, è¡¨ç¤ºå¯¹åº”çš„ ChannelHandler å®ç°äº† ChannelInboundHandler æ–¹æ³•.</li> <li>outbound ä¸ºçœŸæ—¶, è¡¨ç¤ºå¯¹åº”çš„ ChannelHandler å®ç°äº† ChannelOutboundHandler æ–¹æ³•.</li></ul> <p>è¯»è€…æœ‹å‹è‚¯å®šå¾ˆç–‘æƒ‘äº†å§: é‚£ç©¶ç«Ÿè¿™ä¸¤ä¸ªå­—æ®µæœ‰ä»€ä¹ˆä½œç”¨å‘¢? å…¶å®è¿™è¿˜è¦ä» ChannelPipeline çš„ä¼ è¾“çš„äº‹ä»¶ç±»å‹è¯´èµ·. <strong>Netty çš„äº‹ä»¶å¯ä»¥åˆ†ä¸º Inbound å’Œ Outbound äº‹ä»¶.</strong></p> <p>å¦‚ä¸‹æ˜¯ä» Netty å®˜ç½‘ä¸Šæ‹·è´çš„ä¸€ä¸ªå›¾ç¤º:</p> <div class="language- extra-class"><pre class="language-text"><code>                                             I/O Request
                                        via Channel or
                                    ChannelHandlerContext
                                                  |
+---------------------------------------------------+---------------+
|                           ChannelPipeline         |               |
|                                                  \|/              |
|    +---------------------+            +-----------+----------+    |
|    | Inbound Handler  N  |            | Outbound Handler  1  |    |
|    +----------+----------+            +-----------+----------+    |
|              /|\                                  |               |
|               |                                  \|/              |
|    +----------+----------+            +-----------+----------+    |
|    | Inbound Handler N-1 |            | Outbound Handler  2  |    |
|    +----------+----------+            +-----------+----------+    |
|              /|\                                  .               |
|               .                                   .               |
| ChannelHandlerContext.fireIN_EVT() ChannelHandlerContext.OUT_EVT()|
|        [ method call]                       [method call]         |
|               .                                   .               |
|               .                                  \|/              |
|    +----------+----------+            +-----------+----------+    |
|    | Inbound Handler  2  |            | Outbound Handler M-1 |    |
|    +----------+----------+            +-----------+----------+    |
|              /|\                                  |               |
|               |                                  \|/              |
|    +----------+----------+            +-----------+----------+    |
|    | Inbound Handler  1  |            | Outbound Handler  M  |    |
|    +----------+----------+            +-----------+----------+    |
|              /|\                                  |               |
+---------------+-----------------------------------+---------------+
              |                                  \|/
+---------------+-----------------------------------+---------------+
|               |                                   |               |
|       [ Socket.read() ]                    [ Socket.write() ]     |
|                                                                   |
|  Netty Internal I/O Threads (Transport Implementation)            |
+-------------------------------------------------------------------+
</code></pre></div><p>ä»ä¸Šå›¾å¯ä»¥çœ‹å‡º, inbound äº‹ä»¶å’Œ outbound äº‹ä»¶çš„æµå‘æ˜¯ä¸ä¸€æ ·çš„, inbound äº‹ä»¶çš„æµè¡Œæ˜¯ä»ä¸‹è‡³ä¸Š, è€Œ outbound åˆšå¥½ç›¸å, æ˜¯ä»ä¸Šåˆ°ä¸‹. å¹¶ä¸” inbound çš„ä¼ é€’æ–¹å¼æ˜¯é€šè¿‡è°ƒç”¨ç›¸åº”çš„ <strong>ChannelHandlerContext.fireIN_EVT()</strong> æ–¹æ³•, è€Œ outbound æ–¹æ³•çš„çš„ä¼ é€’æ–¹å¼æ˜¯é€šè¿‡è°ƒç”¨ <strong>ChannelHandlerContext.OUT_EVT()</strong> æ–¹æ³•. ä¾‹å¦‚ <strong>ChannelHandlerContext.fireChannelRegistered()</strong> è°ƒç”¨ä¼šå‘é€ä¸€ä¸ª <strong>ChannelRegistered</strong> çš„ inbound ç»™ä¸‹ä¸€ä¸ªChannelHandlerContext, è€Œ <strong>ChannelHandlerContext.bind</strong> è°ƒç”¨ä¼šå‘é€ä¸€ä¸ª <strong>bind</strong> çš„ outbound äº‹ä»¶ç»™ ä¸‹ä¸€ä¸ª ChannelHandlerContext.</p> <p>Inbound äº‹ä»¶ä¼ æ’­æ–¹æ³•æœ‰:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">fireChannelRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">fireChannelActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">fireChannelRead</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span>
<span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">fireChannelReadComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">fireExceptionCaught</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span><span class="token punctuation">)</span>
<span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">fireUserEventTriggered</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span>
<span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">fireChannelWritabilityChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">fireChannelInactive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">fireChannelUnregistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>Oubound äº‹ä»¶ä¼ è¾“æ–¹æ³•æœ‰:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">SocketAddress</span><span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span><span class="token punctuation">)</span>
<span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">SocketAddress</span><span class="token punctuation">,</span> <span class="token class-name">SocketAddress</span><span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span><span class="token punctuation">)</span>
<span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span><span class="token punctuation">)</span>
<span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token class-name">ChannelPromise</span><span class="token punctuation">)</span>
<span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token class-name">ChannelPromise</span><span class="token punctuation">)</span>
</code></pre></div><p><code>æ³¨æ„, å¦‚æœæˆ‘ä»¬æ•è·äº†ä¸€ä¸ªäº‹ä»¶, å¹¶ä¸”æƒ³è®©è¿™ä¸ªäº‹ä»¶ç»§ç»­ä¼ é€’ä¸‹å», é‚£ä¹ˆéœ€è¦è°ƒç”¨ Context ç›¸åº”çš„ä¼ æ’­æ–¹æ³•.</code> ä¾‹å¦‚:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyInboundHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelActive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Connected!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">fireChannelActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> clas <span class="token class-name">MyOutboundHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelOutboundHandlerAdapter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Closing ..&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸Šé¢çš„ä¾‹å­ä¸­, MyInboundHandler æ”¶åˆ°äº†ä¸€ä¸ª channelActive äº‹ä»¶, å®ƒåœ¨å¤„ç†å, å¦‚æœå¸Œæœ›å°†äº‹ä»¶ç»§ç»­ä¼ æ’­ä¸‹å», é‚£ä¹ˆéœ€è¦æ¥ç€è°ƒç”¨ ctx.fireChannelActive().</p> <h3 id="outbound-æ“ä½œ"><a href="#outbound-æ“ä½œ" class="header-anchor">#</a> Outbound æ“ä½œ</h3> <p><code>Outbound äº‹ä»¶éƒ½æ˜¯è¯·æ±‚äº‹ä»¶(request event)</code>, å³è¯·æ±‚æŸä»¶äº‹æƒ…çš„å‘ç”Ÿ, ç„¶åé€šè¿‡ Outbound äº‹ä»¶è¿›è¡Œé€šçŸ¥. Outbound äº‹ä»¶çš„ä¼ æ’­æ–¹å‘æ˜¯ tail -&gt; customContext -&gt; head.</p> <p>æˆ‘ä»¬æ¥ä¸‹æ¥ä»¥ connect äº‹ä»¶ä¸ºä¾‹, åˆ†æä¸€ä¸‹ Outbound äº‹ä»¶çš„ä¼ æ’­æœºåˆ¶. é¦–å…ˆ, å½“ç”¨æˆ·è°ƒç”¨äº† Bootstrap.connect æ–¹æ³•æ—¶, å°±ä¼šè§¦å‘ä¸€ä¸ª <strong>Connect è¯·æ±‚äº‹ä»¶</strong>, æ­¤è°ƒç”¨ä¼šè§¦å‘å¦‚ä¸‹è°ƒç”¨é“¾:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">Bootstrap</span><span class="token punctuation">.</span>connect <span class="token operator">-&gt;</span> <span class="token class-name">Bootstrap</span><span class="token punctuation">.</span>doConnect <span class="token operator">-&gt;</span> <span class="token class-name">Bootstrap</span><span class="token punctuation">.</span>doConnect0 <span class="token operator">-&gt;</span> <span class="token class-name">AbstractChannel</span><span class="token punctuation">.</span>connect
</code></pre></div><p>ç»§ç»­è·Ÿè¸ªçš„è¯, æˆ‘ä»¬å°±å‘ç°, AbstractChannel.connect å…¶å®ç”±è°ƒç”¨äº† DefaultChannelPipeline.connect æ–¹æ³•:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">SocketAddress</span> remoteAddress<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> pipeline<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>remoteAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è€Œ pipeline.connect çš„å®ç°å¦‚ä¸‹:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">SocketAddress</span> remoteAddress<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> tail<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>remoteAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¯ä»¥çœ‹åˆ°, å½“ outbound äº‹ä»¶(è¿™é‡Œæ˜¯ connect äº‹ä»¶)ä¼ é€’åˆ° Pipeline å, å®ƒå…¶å®æ˜¯ä»¥ tail ä¸ºèµ·ç‚¹å¼€å§‹ä¼ æ’­çš„. è€Œ tail.connect å…¶å®è°ƒç”¨çš„æ˜¯ AbstractChannelHandlerContext.connect æ–¹æ³•:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">connect</span><span class="token punctuation">(</span>
        <span class="token keyword">final</span> <span class="token class-name">SocketAddress</span> remoteAddress<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">final</span> <span class="token class-name">AbstractChannelHandlerContext</span> next <span class="token operator">=</span> <span class="token function">findContextOutbound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">EventExecutor</span> executor <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    next<span class="token punctuation">.</span><span class="token function">invokeConnect</span><span class="token punctuation">(</span>remoteAddress<span class="token punctuation">,</span> localAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>findContextOutbound() é¡¾åæ€ä¹‰, å®ƒçš„ä½œç”¨æ˜¯ä»¥å½“å‰ Context ä¸ºèµ·ç‚¹, å‘ Pipeline ä¸­çš„ Context åŒå‘é“¾è¡¨çš„å‰ç«¯å¯»æ‰¾ç¬¬ä¸€ä¸ª <strong>outbound</strong> å±æ€§ä¸ºçœŸçš„ Context(å³å…³è”ç€ ChannelOutboundHandler çš„ Context), ç„¶åè¿”å›. å®ƒçš„å®ç°å¦‚ä¸‹:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">AbstractChannelHandlerContext</span> <span class="token function">findContextOutbound</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AbstractChannelHandlerContext</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        ctx <span class="token operator">=</span> ctx<span class="token punctuation">.</span>prev<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>outbound<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ctx<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å½“æˆ‘ä»¬æ‰¾åˆ°äº†ä¸€ä¸ª outbound çš„ Context å, å°±è°ƒç”¨å®ƒçš„ invokeConnect æ–¹æ³•, è¿™ä¸ªæ–¹æ³•ä¸­ä¼šè°ƒç”¨ Context æ‰€å…³è”ç€çš„ ChannelHandler çš„ connect æ–¹æ³•:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeConnect</span><span class="token punctuation">(</span><span class="token class-name">SocketAddress</span> remoteAddress<span class="token punctuation">,</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ChannelOutboundHandler</span><span class="token punctuation">)</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> remoteAddress<span class="token punctuation">,</span> localAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">notifyOutboundHandlerException</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¦‚æœç”¨æˆ·æ²¡æœ‰é‡å†™ ChannelHandler çš„ connect æ–¹æ³•, é‚£ä¹ˆä¼šè°ƒç”¨ ChannelOutboundHandlerAdapter æ‰€å®ç°çš„æ–¹æ³•:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">SocketAddress</span> remoteAddress<span class="token punctuation">,</span>
        <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>remoteAddress<span class="token punctuation">,</span> localAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æˆ‘ä»¬çœ‹åˆ°, ChannelOutboundHandlerAdapter.connect ä»…ä»…è°ƒç”¨äº† ctx.connect, è€Œè¿™ä¸ªè°ƒç”¨åˆå›åˆ°äº†:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">Context</span><span class="token punctuation">.</span>connect <span class="token operator">-&gt;</span> <span class="token class-name">Connect</span><span class="token punctuation">.</span>findContextOutbound <span class="token operator">-&gt;</span> next<span class="token punctuation">.</span>invokeConnect <span class="token operator">-&gt;</span> handler<span class="token punctuation">.</span>connect <span class="token operator">-&gt;</span> <span class="token class-name">Context</span><span class="token punctuation">.</span>connect
</code></pre></div><p>è¿™æ ·çš„å¾ªç¯ä¸­, ç›´åˆ° connect äº‹ä»¶ä¼ é€’åˆ°DefaultChannelPipeline çš„åŒå‘é“¾è¡¨çš„å¤´èŠ‚ç‚¹, å³ head ä¸­. ä¸ºä»€ä¹ˆä¼šä¼ é€’åˆ° head ä¸­å‘¢? å›æƒ³ä¸€ä¸‹, head å®ç°äº† ChannelOutboundHandler, å› æ­¤å®ƒçš„ outbound å±æ€§æ˜¯ true. <code>å› ä¸º head æœ¬èº«æ—¢æ˜¯ä¸€ä¸ª ChannelHandlerContext, åˆå®ç°äº† ChannelOutboundHandler æ¥å£</code>, å› æ­¤å½“ connect æ¶ˆæ¯ä¼ é€’åˆ° head å, ä¼šå°†æ¶ˆæ¯è½¬é€’åˆ°å¯¹åº”çš„ ChannelHandler ä¸­å¤„ç†, è€Œæ°å¥½, head çš„ handler() è¿”å›çš„å°±æ˜¯ head æœ¬èº«:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ChannelHandler</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å› æ­¤æœ€ç»ˆ connect äº‹ä»¶æ˜¯åœ¨ head ä¸­å¤„ç†çš„. head çš„ connect äº‹ä»¶å¤„ç†æ–¹æ³•å¦‚ä¸‹:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">connect</span><span class="token punctuation">(</span>
        <span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span>
        <span class="token class-name">SocketAddress</span> remoteAddress<span class="token punctuation">,</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">,</span>
        <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    unsafe<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>remoteAddress<span class="token punctuation">,</span> localAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åˆ°è¿™é‡Œ, æ•´ä¸ª Connect è¯·æ±‚äº‹ä»¶å°±ç»“æŸäº†. ä¸‹é¢ä»¥ä¸€å¹…å›¾æ¥æè¿°ä¸€ä¸ªæ•´ä¸ª Connect è¯·æ±‚äº‹ä»¶çš„å¤„ç†è¿‡ç¨‹:</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409190007292.png" alt="image-20240919000704287"></p> <p>æˆ‘ä»¬ä»…ä»…ä»¥ Connect è¯·æ±‚äº‹ä»¶ä¸ºä¾‹, åˆ†æäº† Outbound äº‹ä»¶çš„ä¼ æ’­è¿‡ç¨‹, ä½†æ˜¯å…¶å®æ‰€æœ‰çš„ outbound çš„äº‹ä»¶ä¼ æ’­éƒ½éµå¾ªç€ä¸€æ ·çš„ä¼ æ’­è§„å¾‹, è¯»è€…å¯ä»¥è¯•ç€åˆ†æä¸€ä¸‹å…¶ä»–çš„ outbound äº‹ä»¶, ä½“ä¼šä¸€ä¸‹å®ƒä»¬çš„ä¼ æ’­è¿‡ç¨‹.</p> <h3 id="inbound-äº‹ä»¶"><a href="#inbound-äº‹ä»¶" class="header-anchor">#</a> Inbound äº‹ä»¶</h3> <p>Inbound äº‹ä»¶å’Œ Outbound äº‹ä»¶çš„å¤„ç†è¿‡ç¨‹æœ‰ç‚¹é•œåƒ. <code>Inbound äº‹ä»¶æ˜¯ä¸€ä¸ªé€šçŸ¥äº‹ä»¶</code>, å³æŸä»¶äº‹å·²ç»å‘ç”Ÿäº†, ç„¶åé€šè¿‡ Inbound äº‹ä»¶è¿›è¡Œé€šçŸ¥. Inbound é€šå¸¸å‘ç”Ÿåœ¨ Channel çš„çŠ¶æ€çš„æ”¹å˜æˆ– IO äº‹ä»¶å°±ç»ª. Inbound çš„ç‰¹ç‚¹æ˜¯å®ƒä¼ æ’­æ–¹å‘æ˜¯ head -&gt; customContext -&gt; tail.</p> <p>æ—¢ç„¶ä¸Šé¢æˆ‘ä»¬åˆ†æäº† Connect è¿™ä¸ª Outbound äº‹ä»¶, é‚£ä¹ˆæ¥ç€åˆ†æ Connect äº‹ä»¶åä¼šå‘ç”Ÿä»€ä¹ˆ Inbound äº‹ä»¶, å¹¶æœ€ç»ˆæ‰¾åˆ° Outbound å’Œ Inbound äº‹ä»¶ä¹‹é—´çš„è”ç³».</p> <p>å½“ Connect è¿™ä¸ª Outbound ä¼ æ’­åˆ° unsafe å, å…¶å®æ˜¯åœ¨ AbstractNioUnsafe.connect æ–¹æ³•ä¸­è¿›è¡Œå¤„ç†çš„:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">connect</span><span class="token punctuation">(</span>
        <span class="token keyword">final</span> <span class="token class-name">SocketAddress</span> remoteAddress<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">doConnect</span><span class="token punctuation">(</span>remoteAddress<span class="token punctuation">,</span> localAddress<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fulfillConnectPromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> wasActive<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨ AbstractNioUnsafe.connect ä¸­, é¦–å…ˆè°ƒç”¨ doConnect æ–¹æ³•è¿›è¡Œå®é™…ä¸Šçš„ Socket è¿æ¥, å½“è¿æ¥ä¸Šå, ä¼šè°ƒç”¨ fulfillConnectPromise æ–¹æ³•:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">fulfillConnectPromise</span><span class="token punctuation">(</span><span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">,</span> <span class="token keyword">boolean</span> wasActive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// Regardless if the connection attempt was cancelled, channelActive() event should be triggered,</span>
    <span class="token comment">// because what happened is what happened.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>wasActive <span class="token operator">&amp;&amp;</span> <span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fireChannelActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æˆ‘ä»¬çœ‹åˆ°, åœ¨ fulfillConnectPromise ä¸­, ä¼šé€šè¿‡è°ƒç”¨ pipeline().fireChannelActive() å°†é€šé“æ¿€æ´»çš„æ¶ˆæ¯(å³ Socket è¿æ¥æˆåŠŸ)å‘é€å‡ºå». <code>è€Œè¿™é‡Œ, å½“è°ƒç”¨ pipeline.fireXXX å, å°±æ˜¯ Inbound äº‹ä»¶çš„èµ·ç‚¹.</code> å› æ­¤å½“è°ƒç”¨äº† pipeline().fireChannelActive() å, å°±äº§ç”Ÿäº†ä¸€ä¸ª ChannelActive Inbound äº‹ä»¶, æˆ‘ä»¬å°±ä»è¿™é‡Œå¼€å§‹çœ‹çœ‹è¿™ä¸ª Inbound äº‹ä»¶æ˜¯æ€ä¹ˆä¼ æ’­çš„å§.</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">fireChannelActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    head<span class="token punctuation">.</span><span class="token function">fireChannelActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAutoRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å“ˆå“ˆ, æœç„¶, åœ¨ fireChannelActive æ–¹æ³•ä¸­, è°ƒç”¨çš„æ˜¯ head.fireChannelActive, <code>å› æ­¤å¯ä»¥è¯æ˜äº†, Inbound äº‹ä»¶åœ¨ Pipeline ä¸­ä¼ è¾“çš„èµ·ç‚¹æ˜¯ head.</code> é‚£ä¹ˆ, åœ¨ head.fireChannelActive() ä¸­åˆåšäº†ä»€ä¹ˆå‘¢?</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ChannelHandlerContext</span> <span class="token function">fireChannelActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">AbstractChannelHandlerContext</span> next <span class="token operator">=</span> <span class="token function">findContextInbound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">EventExecutor</span> executor <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    next<span class="token punctuation">.</span><span class="token function">invokeChannelActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸Šé¢çš„ä»£ç åº”è¯¥å¾ˆç†Ÿæ‚‰äº†å§. å›æƒ³ä¸€ä¸‹åœ¨ Outbound äº‹ä»¶(ä¾‹å¦‚ Connect äº‹ä»¶)çš„ä¼ è¾“è¿‡ç¨‹ä¸­æ—¶, æˆ‘ä»¬ä¹Ÿæœ‰ç±»ä¼¼çš„æ“ä½œ:</p> <ul><li>é¦–å…ˆè°ƒç”¨ findContextInbound, ä» Pipeline çš„åŒå‘é“¾è¡¨ä¸­ä¸­æ‰¾åˆ°ç¬¬ä¸€ä¸ªå±æ€§ inbound ä¸ºçœŸçš„ Context, ç„¶åè¿”å›</li> <li>è°ƒç”¨è¿™ä¸ª Context çš„ invokeChannelActive</li></ul> <p>invokeChannelActive æ–¹æ³•å¦‚ä¸‹:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeChannelActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ChannelInboundHandler</span><span class="token punctuation">)</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">channelActive</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">notifyHandlerException</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¿™ä¸ªæ–¹æ³•å’Œ Outbound çš„å¯¹åº”æ–¹æ³•(ä¾‹å¦‚ invokeConnect) å¦‚å‡ºä¸€è¾™. åŒ Outbound ä¸€æ ·, å¦‚æœç”¨æˆ·æ²¡æœ‰é‡å†™ channelActive æ–¹æ³•, é‚£ä¹ˆä¼šè°ƒç”¨ ChannelInboundHandlerAdapter çš„ channelActive æ–¹æ³•:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelActive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">fireChannelActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åŒæ ·åœ°, åœ¨ ChannelInboundHandlerAdapter.channelActive ä¸­, ä»…ä»…è°ƒç”¨äº† ctx.fireChannelActive æ–¹æ³•, å› æ­¤å°±ä¼šæœ‰å¦‚ä¸‹å¾ªç¯:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">Context</span><span class="token punctuation">.</span>fireChannelActive <span class="token operator">-&gt;</span> <span class="token class-name">Connect</span><span class="token punctuation">.</span>findContextInbound <span class="token operator">-&gt;</span> nextContext<span class="token punctuation">.</span>invokeChannelActive <span class="token operator">-&gt;</span> nextHandler<span class="token punctuation">.</span>channelActive <span class="token operator">-&gt;</span> nextContext<span class="token punctuation">.</span>fireChannelActive
</code></pre></div><p>è¿™æ ·çš„å¾ªç¯ä¸­. åŒç†, tail æœ¬èº« æ—¢å®ç°äº† <strong>ChannelInboundHandler</strong> æ¥å£, åˆå®ç°äº† <strong>ChannelHandlerContext</strong> æ¥å£, å› æ­¤å½“ channelActive æ¶ˆæ¯ä¼ é€’åˆ° tail å, ä¼šå°†æ¶ˆæ¯è½¬é€’åˆ°å¯¹åº”çš„ ChannelHandler ä¸­å¤„ç†, è€Œæ°å¥½, tail çš„ handler() è¿”å›çš„å°±æ˜¯ tail æœ¬èº«:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ChannelHandler</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å› æ­¤ channelActive Inbound äº‹ä»¶æœ€ç»ˆæ˜¯åœ¨ tail ä¸­å¤„ç†çš„, æˆ‘ä»¬çœ‹ä¸€ä¸‹å®ƒçš„å¤„ç†æ–¹æ³•:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelActive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre></div><p>TailContext.channelActive æ–¹æ³•æ˜¯ç©ºçš„. å¦‚æœè¯»è€…è‡ªè¡ŒæŸ¥çœ‹ TailContext çš„ Inbound å¤„ç†æ–¹æ³•æ—¶, ä¼šå‘ç°, å®ƒä»¬çš„å®ç°éƒ½æ˜¯ç©ºçš„. å¯è§, å¦‚æœæ˜¯ Inbound, å½“ç”¨æˆ·æ²¡æœ‰å®ç°è‡ªå®šä¹‰çš„å¤„ç†å™¨æ—¶, é‚£ä¹ˆé»˜è®¤æ˜¯ä¸å¤„ç†çš„.</p> <p>ç”¨ä¸€å¹…å›¾æ¥æ€»ç»“ä¸€ä¸‹ Inbound çš„ä¼ è¾“è¿‡ç¨‹å§:</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409190007491.png" alt="image-20240919000535862"></p> <h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="header-anchor">#</a> æ€»ç»“</h3> <p>å¯¹äº Outboundäº‹ä»¶:</p> <ul><li>Outbound äº‹ä»¶æ˜¯è¯·æ±‚äº‹ä»¶(ç”± Connect å‘èµ·ä¸€ä¸ªè¯·æ±‚, å¹¶æœ€ç»ˆç”± unsafe å¤„ç†è¿™ä¸ªè¯·æ±‚)</li> <li>Outbound äº‹ä»¶çš„å‘èµ·è€…æ˜¯ Channel</li> <li>Outbound äº‹ä»¶çš„å¤„ç†è€…æ˜¯ unsafe</li> <li>Outbound äº‹ä»¶åœ¨ Pipeline ä¸­çš„ä¼ è¾“æ–¹å‘æ˜¯ tail -&gt; head.</li> <li>åœ¨ ChannelHandler ä¸­å¤„ç†äº‹ä»¶æ—¶, å¦‚æœè¿™ä¸ª Handler ä¸æ˜¯æœ€åä¸€ä¸ª Hnalder, åˆ™éœ€è¦è°ƒç”¨ ctx.xxx (ä¾‹å¦‚ ctx.connect) å°†æ­¤äº‹ä»¶ç»§ç»­ä¼ æ’­ä¸‹å». å¦‚æœä¸è¿™æ ·åš, é‚£ä¹ˆæ­¤äº‹ä»¶çš„ä¼ æ’­ä¼šæå‰ç»ˆæ­¢.</li> <li>Outbound äº‹ä»¶æµ: Context.OUT_EVT -&gt; Connect.findContextOutbound -&gt; nextContext.invokeOUT_EVT -&gt; nextHandler.OUT_EVT -&gt; nextContext.OUT_EVT</li></ul> <p>å¯¹äº Inbound äº‹ä»¶:</p> <ul><li>Inbound äº‹ä»¶æ˜¯é€šçŸ¥äº‹ä»¶, å½“æŸä»¶äº‹æƒ…å·²ç»å°±ç»ªå, é€šçŸ¥ä¸Šå±‚.</li> <li>Inbound äº‹ä»¶å‘èµ·è€…æ˜¯ unsafe</li> <li>Inbound äº‹ä»¶çš„å¤„ç†è€…æ˜¯ Channel, å¦‚æœç”¨æˆ·æ²¡æœ‰å®ç°è‡ªå®šä¹‰çš„å¤„ç†æ–¹æ³•, é‚£ä¹ˆInbound äº‹ä»¶é»˜è®¤çš„å¤„ç†è€…æ˜¯ TailContext, å¹¶ä¸”å…¶å¤„ç†æ–¹æ³•æ˜¯ç©ºå®ç°.</li> <li>Inbound äº‹ä»¶åœ¨ Pipeline ä¸­ä¼ è¾“æ–¹å‘æ˜¯ head -&gt; tail</li> <li>åœ¨ ChannelHandler ä¸­å¤„ç†äº‹ä»¶æ—¶, å¦‚æœè¿™ä¸ª Handler ä¸æ˜¯æœ€åä¸€ä¸ª Hnalder, åˆ™éœ€è¦è°ƒç”¨ ctx.fireIN_EVT (ä¾‹å¦‚ ctx.fireChannelActive) å°†æ­¤äº‹ä»¶ç»§ç»­ä¼ æ’­ä¸‹å». å¦‚æœä¸è¿™æ ·åš, é‚£ä¹ˆæ­¤äº‹ä»¶çš„ä¼ æ’­ä¼šæå‰ç»ˆæ­¢.</li> <li>Outbound äº‹ä»¶æµ: Context.fireIN_EVT -&gt; Connect.findContextInbound -&gt; nextContext.invokeIN_EVT -&gt; nextHandler.IN_EVT -&gt; nextContext.fireIN_EVT</li></ul> <p>outbound å’Œ inbound äº‹ä»¶ååˆ†çš„é•œåƒ, å¹¶ä¸” Context ä¸ Handler ç›´æ¥çš„è°ƒç”¨å…³ç³»æ˜¯å¦å®¹æ˜“æ··æ·†, å› æ­¤è¯»è€…åœ¨é˜…è¯»è¿™é‡Œçš„æºç æ—¶, éœ€è¦ç‰¹åˆ«çš„æ³¨æ„.</p> <h2 id="æ€»ç»“-2"><a href="#æ€»ç»“-2" class="header-anchor">#</a> æ€»ç»“</h2> <h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="header-anchor">#</a> å‚è€ƒèµ„æ–™</h2></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/echo-lxy/echo-system-design/edit/master/docs/Netty ç³»ç»Ÿè®¾è®¡/20.ä¸‰ã€ä¸»çº¿ä»»åŠ¡/30.ChannelPipeline æºç è§£æ.md" target="_blank" rel="noopener noreferrer">ç¼–è¾‘</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°äº:</span> <span class="time">2024/09/18, 16:19:18</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        â†
        <a href="/pages/ce1f78/" class="prev">ChannelHandler æºç è§£æ</a></span> <span class="next"><a href="/pages/43eb30/">ByteBuf æºç è§£æ</a>â†’
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:lixinyang2002@163.com" title="å‘é‚®ä»¶" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/echo-lxy" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="å¬éŸ³ä¹" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="æœ¬ç«™ä¸»é¢˜">Vdoing</a> 
    | Copyright Â© 2024-2024
    <span>Xinyang Li | MIT License</span></div> <div class="buttons"><div title="è¿”å›é¡¶éƒ¨" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="å»è¯„è®º" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ä¸»é¢˜æ¨¡å¼" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          è·Ÿéšç³»ç»Ÿ
        </li><li class="iconfont icon-rijianmoshi">
          æµ…è‰²æ¨¡å¼
        </li><li class="iconfont icon-yejianmoshi">
          æ·±è‰²æ¨¡å¼
        </li><li class="iconfont icon-yuedu">
          é˜…è¯»æ¨¡å¼
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.2fa17da6.js" defer></script><script src="/assets/js/2.933750c6.js" defer></script><script src="/assets/js/49.15d8e916.js" defer></script><script src="/assets/js/7.7eb70372.js" defer></script>
  </body>
</html>
