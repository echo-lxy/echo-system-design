<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ç¬¬å…­è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆå‘é€ç½‘ç»œæ•°æ®.md | EchoDesign</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="ç³»ç»Ÿè®¾è®¡ä¹‹ã€Œè®²è§£ + é¢è¯•æŒ‡å—ã€ï¼Œæ°´æ»´çŸ³ç©¿ï¼Œè®¾è®¡æ— é“¶å¼¹ï¼">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.c76c3453.css" as="style"><link rel="preload" href="/assets/js/app.6c7acbd0.js" as="script"><link rel="preload" href="/assets/js/2.933750c6.js" as="script"><link rel="preload" href="/assets/js/56.5ecf867d.js" as="script"><link rel="preload" href="/assets/js/7.7eb70372.js" as="script"><link rel="prefetch" href="/assets/js/10.2cc95be8.js"><link rel="prefetch" href="/assets/js/100.2b21dce5.js"><link rel="prefetch" href="/assets/js/101.09d5e594.js"><link rel="prefetch" href="/assets/js/11.c7521a10.js"><link rel="prefetch" href="/assets/js/12.38d1989d.js"><link rel="prefetch" href="/assets/js/13.8ddd597e.js"><link rel="prefetch" href="/assets/js/14.397b7600.js"><link rel="prefetch" href="/assets/js/15.b3c76984.js"><link rel="prefetch" href="/assets/js/16.831e5a24.js"><link rel="prefetch" href="/assets/js/17.acb3bf3d.js"><link rel="prefetch" href="/assets/js/18.e491edb6.js"><link rel="prefetch" href="/assets/js/19.daf31819.js"><link rel="prefetch" href="/assets/js/20.cb4a5c13.js"><link rel="prefetch" href="/assets/js/21.24c0f101.js"><link rel="prefetch" href="/assets/js/22.7d106f59.js"><link rel="prefetch" href="/assets/js/23.623f0b5d.js"><link rel="prefetch" href="/assets/js/24.6ba53300.js"><link rel="prefetch" href="/assets/js/25.1fb855d9.js"><link rel="prefetch" href="/assets/js/26.0146252c.js"><link rel="prefetch" href="/assets/js/27.de80589e.js"><link rel="prefetch" href="/assets/js/28.d4ca2c30.js"><link rel="prefetch" href="/assets/js/29.7325b5ce.js"><link rel="prefetch" href="/assets/js/3.5c09ac9d.js"><link rel="prefetch" href="/assets/js/30.892b2994.js"><link rel="prefetch" href="/assets/js/31.a532917f.js"><link rel="prefetch" href="/assets/js/32.13b70e91.js"><link rel="prefetch" href="/assets/js/33.64ab8d0c.js"><link rel="prefetch" href="/assets/js/34.6d3cc288.js"><link rel="prefetch" href="/assets/js/35.5b49d706.js"><link rel="prefetch" href="/assets/js/36.be98cc35.js"><link rel="prefetch" href="/assets/js/37.ead210df.js"><link rel="prefetch" href="/assets/js/38.9f396b5a.js"><link rel="prefetch" href="/assets/js/39.8409097b.js"><link rel="prefetch" href="/assets/js/4.73518a0f.js"><link rel="prefetch" href="/assets/js/40.0ada49bd.js"><link rel="prefetch" href="/assets/js/41.fcee3e0f.js"><link rel="prefetch" href="/assets/js/42.b34f1599.js"><link rel="prefetch" href="/assets/js/43.5a509601.js"><link rel="prefetch" href="/assets/js/44.64fd3383.js"><link rel="prefetch" href="/assets/js/45.685623ac.js"><link rel="prefetch" href="/assets/js/46.7624d38c.js"><link rel="prefetch" href="/assets/js/47.86be3d8d.js"><link rel="prefetch" href="/assets/js/48.ba7dfd47.js"><link rel="prefetch" href="/assets/js/49.ee9681bc.js"><link rel="prefetch" href="/assets/js/5.94727770.js"><link rel="prefetch" href="/assets/js/50.3e91aa07.js"><link rel="prefetch" href="/assets/js/51.ad7a3e32.js"><link rel="prefetch" href="/assets/js/52.08ad747c.js"><link rel="prefetch" href="/assets/js/53.5ee4652a.js"><link rel="prefetch" href="/assets/js/54.0bbf2ba5.js"><link rel="prefetch" href="/assets/js/55.0edcba5d.js"><link rel="prefetch" href="/assets/js/57.72ba41a6.js"><link rel="prefetch" href="/assets/js/58.7144aef6.js"><link rel="prefetch" href="/assets/js/59.f96f0065.js"><link rel="prefetch" href="/assets/js/6.0b558b79.js"><link rel="prefetch" href="/assets/js/60.66a7f41d.js"><link rel="prefetch" href="/assets/js/61.08b4acf0.js"><link rel="prefetch" href="/assets/js/62.cc8fdced.js"><link rel="prefetch" href="/assets/js/63.41ff19e4.js"><link rel="prefetch" href="/assets/js/64.9b3def35.js"><link rel="prefetch" href="/assets/js/65.0b2ab47d.js"><link rel="prefetch" href="/assets/js/66.2ae7a107.js"><link rel="prefetch" href="/assets/js/67.79dd6daf.js"><link rel="prefetch" href="/assets/js/68.1b76c178.js"><link rel="prefetch" href="/assets/js/69.7ac52a2f.js"><link rel="prefetch" href="/assets/js/70.7279b1df.js"><link rel="prefetch" href="/assets/js/71.f44644ed.js"><link rel="prefetch" href="/assets/js/72.c8cf2fab.js"><link rel="prefetch" href="/assets/js/73.526febf1.js"><link rel="prefetch" href="/assets/js/74.d9ad1a67.js"><link rel="prefetch" href="/assets/js/75.90fd56c9.js"><link rel="prefetch" href="/assets/js/76.32858593.js"><link rel="prefetch" href="/assets/js/77.7b3f6980.js"><link rel="prefetch" href="/assets/js/78.31a353ef.js"><link rel="prefetch" href="/assets/js/79.173bbc8c.js"><link rel="prefetch" href="/assets/js/8.0ec7f6e8.js"><link rel="prefetch" href="/assets/js/80.d8713e74.js"><link rel="prefetch" href="/assets/js/81.d124398a.js"><link rel="prefetch" href="/assets/js/82.3b90a7cc.js"><link rel="prefetch" href="/assets/js/83.f3a9ee0c.js"><link rel="prefetch" href="/assets/js/84.1fd412a9.js"><link rel="prefetch" href="/assets/js/85.f69467b2.js"><link rel="prefetch" href="/assets/js/86.931cbb70.js"><link rel="prefetch" href="/assets/js/87.78b2eebd.js"><link rel="prefetch" href="/assets/js/88.605444aa.js"><link rel="prefetch" href="/assets/js/89.e05e3a70.js"><link rel="prefetch" href="/assets/js/9.6e274fca.js"><link rel="prefetch" href="/assets/js/90.ca1ff100.js"><link rel="prefetch" href="/assets/js/91.8ad18b18.js"><link rel="prefetch" href="/assets/js/92.b554f1c7.js"><link rel="prefetch" href="/assets/js/93.fb2397b7.js"><link rel="prefetch" href="/assets/js/94.1eade7f0.js"><link rel="prefetch" href="/assets/js/95.96f5db04.js"><link rel="prefetch" href="/assets/js/96.5ed2d348.js"><link rel="prefetch" href="/assets/js/97.0154143f.js"><link rel="prefetch" href="/assets/js/98.8d8d41db.js"><link rel="prefetch" href="/assets/js/99.690e4395.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c76c3453.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="ç›®å½•" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="EchoDesign" class="logo"> <span class="site-name can-hide">EchoDesign</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">ğŸ é¦–é¡µ</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">âœ’ï¸çƒ­é—¨ç®—æ³•</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ğŸ–ï¸èµæç»å…¸è®¾è®¡" class="dropdown-title"><!----> <span class="title" style="display:;">ğŸ–ï¸èµæç»å…¸è®¾è®¡</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ç³»ç»Ÿè®¾è®¡</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ğŸ§‘â€ğŸ’»å®æˆ˜ç³»ç»Ÿè®¾è®¡</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">â“é—®ç­”</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ğŸ‘€åŠ¨æ€</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">ğŸ é¦–é¡µ</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">âœ’ï¸çƒ­é—¨ç®—æ³•</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ğŸ–ï¸èµæç»å…¸è®¾è®¡" class="dropdown-title"><!----> <span class="title" style="display:;">ğŸ–ï¸èµæç»å…¸è®¾è®¡</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ç³»ç»Ÿè®¾è®¡</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ğŸ§‘â€ğŸ’»å®æˆ˜ç³»ç»Ÿè®¾è®¡</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">â“é—®ç­”</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ğŸ‘€åŠ¨æ€</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ä¸€ã€å‰è¨€</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>äºŒã€åŸºç¡€çŸ¥è¯†</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ä¸‰ã€ä¸»çº¿ä»»åŠ¡</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>å››ã€æ·±å…¥ Netty æ ¸å¿ƒ</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/c3d4a6/" class="sidebar-link">ç¬¬ä¸€è¯¾ï¼šé€è¿‡ Netty çœ‹ IO æ¨¡å‹</a></li><li><a href="/pages/70bb50/" class="sidebar-link">ç¬¬äºŒè¯¾ï¼šReactoråœ¨Nettyä¸­çš„å®ç°</a></li><li><a href="/pages/830f05/" class="sidebar-link">ç¬¬ä¸‰è¯¾ï¼šNettyæ ¸å¿ƒå¼•æ“Reactorçš„è¿è½¬æ¶æ„</a></li><li><a href="/pages/6d0640/" class="sidebar-link">ç¬¬å››è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œè¿æ¥</a></li><li><a href="/pages/9cb8c1/" class="sidebar-link">ç¬¬äº”è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œæ•°æ®</a></li><li><a href="/pages/cfe9ff/" aria-current="page" class="active sidebar-link">ç¬¬å…­è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆå‘é€ç½‘ç»œæ•°æ®.md</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/cfe9ff/#_1-channelhandlercontext" class="sidebar-link">1. ChannelHandlerContext</a></li><li class="sidebar-sub-header level2"><a href="/pages/cfe9ff/#_2-writeäº‹ä»¶çš„ä¼ æ’­" class="sidebar-link">2. writeäº‹ä»¶çš„ä¼ æ’­</a></li><li class="sidebar-sub-header level2"><a href="/pages/cfe9ff/#_3-writeæ–¹æ³•å‘é€æ•°æ®" class="sidebar-link">3. writeæ–¹æ³•å‘é€æ•°æ®</a></li><li class="sidebar-sub-header level2"><a href="/pages/cfe9ff/#_3-2-headcontext" class="sidebar-link">3.2 HeadContext</a></li><li class="sidebar-sub-header level2"><a href="/pages/cfe9ff/#_3-3-channeloutboundbuffer" class="sidebar-link">3.3 ChannelOutboundBuffer</a></li><li class="sidebar-sub-header level2"><a href="/pages/cfe9ff/#_4-flush" class="sidebar-link">4. flush</a></li><li class="sidebar-sub-header level2"><a href="/pages/cfe9ff/#_5-ç»ˆäºå¼€å§‹çœŸæ­£åœ°å‘é€æ•°æ®äº†" class="sidebar-link">5. ç»ˆäºå¼€å§‹çœŸæ­£åœ°å‘é€æ•°æ®äº†ï¼</a></li><li class="sidebar-sub-header level2"><a href="/pages/cfe9ff/#_6-å¤„ç†socketå¯å†™ä½†å·²ç»å†™æ»¡16æ¬¡è¿˜æ²¡å†™å®Œçš„æƒ…å†µ" class="sidebar-link">6. å¤„ç†Socketå¯å†™ä½†å·²ç»å†™æ»¡16æ¬¡è¿˜æ²¡å†™å®Œçš„æƒ…å†µ</a></li><li class="sidebar-sub-header level2"><a href="/pages/cfe9ff/#_7-op-writeäº‹ä»¶çš„å¤„ç†" class="sidebar-link">7. OP_WRITEäº‹ä»¶çš„å¤„ç†</a></li><li class="sidebar-sub-header level2"><a href="/pages/cfe9ff/#_8-writeandflush" class="sidebar-link">8. writeAndFlush</a></li><li class="sidebar-sub-header level2"><a href="/pages/cfe9ff/#æ€»ç»“" class="sidebar-link">æ€»ç»“</a></li></ul></li><li><a href="/pages/ed2e85/" class="sidebar-link">ç¬¬ä¸ƒè¯¾ï¼šè¯¦è§£ Netty ä¸­æ‰€æœ‰IOäº‹ä»¶çš„è§¦å‘æ—¶æœºå’Œä¼ æ’­æµç¨‹</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>äº”ã€æ·±å…¥ Netty å†…å­˜ç®¡ç†</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="é¦–é¡µ" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>Netty ç³»ç»Ÿè®¾è®¡</span></li><li data-v-06225672><span data-v-06225672>å››ã€æ·±å…¥ Netty æ ¸å¿ƒ</span></li></ul> <div class="info" data-v-06225672><div title="ä½œè€…" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/brother-one" target="_blank" title="ä½œè€…" class="beLink" data-v-06225672>echo</a></div> <div title="åˆ›å»ºæ—¶é—´" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-09-19</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">ç›®å½•</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">ç¬¬å…­è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆå‘é€ç½‘ç»œæ•°æ®.md<!----></h1> <div class="page-slot page-slot-top">
    <div class="wwads-cn wwads-horizontal page-wwads" data-id="136"></div>
    <style>
      .page-wwads{
        width:100%!important;
        min-height: 0;
        margin: 0;
      }
      .page-wwads .wwads-img img{
        width:80px!important;
      }
      .page-wwads .wwads-poweredby{
        width: 40px;
        position: absolute;
        right: 25px;
        bottom: 3px;
      }
      .wwads-content .wwads-text, .page-wwads .wwads-text{
        height: 100%;
        padding-top: 5px;
        display: block;
      }
  </style>
  </div> <div class="theme-vdoing-content content__default"><blockquote><p>æœ¬ç³»åˆ—Nettyæºç è§£ææ–‡ç« åŸºäº <strong>4.1.56.Final</strong>ç‰ˆæœ¬</p></blockquote> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191113813.png" alt="å›¾ç‰‡">ä¸»ä»Reactorç»„å®Œæ•´ç»“æ„.png</p> <p>åœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484244&amp;idx=1&amp;sn=831060fc38caa201d69f87305de7f86a&amp;chksm=ce77c513f9004c05b48f849ff99997d6d7252453135ae856a029137b88aa70b8e046013d596e&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">ã€ŠNettyå¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œæ•°æ®ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº† Netty çš„ SubReactor å¤„ç†ç½‘ç»œæ•°æ®è¯»å–çš„å®Œæ•´è¿‡ç¨‹ï¼Œå½“ Netty ä¸ºæˆ‘ä»¬è¯»å–äº†ç½‘ç»œè¯·æ±‚æ•°æ®ï¼Œå¹¶ä¸”æˆ‘ä»¬åœ¨è‡ªå·±çš„ä¸šåŠ¡çº¿ç¨‹ä¸­å®Œæˆäº†ä¸šåŠ¡å¤„ç†åï¼Œå°±éœ€è¦å°†ä¸šåŠ¡å¤„ç†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯äº†ï¼Œé‚£ä¹ˆæœ¬æ–‡æˆ‘ä»¬å°±æ¥ä»‹ç»ä¸‹ SubReactor å¦‚ä½•å¤„ç†ç½‘ç»œæ•°æ®å‘é€çš„æ•´ä¸ªè¿‡ç¨‹ã€‚</p> <p>æˆ‘ä»¬éƒ½çŸ¥é“ Netty æ˜¯ä¸€æ¬¾é«˜æ€§èƒ½çš„å¼‚æ­¥äº‹ä»¶é©±åŠ¨çš„ç½‘ç»œé€šè®¯æ¡†æ¶ï¼Œæ—¢ç„¶æ˜¯ç½‘ç»œé€šè®¯æ¡†æ¶é‚£ä¹ˆå®ƒä¸»è¦åšçš„äº‹æƒ…å°±æ˜¯ï¼š</p> <ul><li>æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ã€‚</li> <li>è¯»å–è¿æ¥ä¸Šçš„ç½‘ç»œè¯·æ±‚æ•°æ®ã€‚</li> <li>å‘è¿æ¥å‘é€ç½‘ç»œå“åº”æ•°æ®ã€‚</li></ul> <p>å‰è¾¹ç³»åˆ—æ–‡ç« åœ¨ä»‹ç»<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484005&amp;idx=1&amp;sn=52f51269902a58f40d33208421109bc3&amp;chksm=ce77c422f9004d340e5b385ef6ba24dfba1f802076ace80ad6390e934173a10401e64e13eaeb&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">Nettyçš„å¯åŠ¨<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä»¥åŠ<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484184&amp;idx=1&amp;sn=726877ce28cf6e5d2ac3225fae687f19&amp;chksm=ce77c55ff9004c493b592288819dc4d4664b5949ee97fed977b6558bc517dad0e1f73fab0f46&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">æ¥æ”¶è¿æ¥<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åªçœ‹åˆ° OP_ACCEPT äº‹ä»¶ä»¥åŠ OP_READ äº‹ä»¶çš„æ³¨å†Œï¼Œå¹¶æœªçœ‹åˆ° OP_WRITE äº‹ä»¶çš„æ³¨å†Œã€‚</p> <ul><li>é‚£ä¹ˆåœ¨ä»€ä¹ˆæƒ…å†µä¸‹ Netty æ‰ä¼šå‘ SubReactor å»æ³¨å†Œ OP_WRITE äº‹ä»¶å‘¢ï¼Ÿ</li> <li>Netty åˆæ˜¯æ€ä¹ˆå¯¹å†™æ“ä½œåšåˆ°å¼‚æ­¥å¤„ç†çš„å‘¢ï¼Ÿ</li></ul> <p>æœ¬æ–‡ç¬”è€…å°†ä¼šä¸ºå¤§å®¶ä¸€ä¸€æ­æ™“è¿™äº›è°œåº•ã€‚æˆ‘ä»¬è¿˜æ˜¯ä»¥ä¹‹å‰çš„ EchoServer ä¸ºä¾‹è¿›è¡Œè¯´æ˜ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>@Sharable
public class EchoServerHandler extends ChannelInboundHandlerAdapter {

    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) {
        //æ­¤å¤„çš„msgå°±æ˜¯Nettyåœ¨read loopä¸­ä»NioSocketChannelä¸­è¯»å–åˆ°çš„ByteBuffer
        ctx.write(msg);
    }

}
</code></pre></div><p>æˆ‘ä»¬å°†åœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484244&amp;idx=1&amp;sn=831060fc38caa201d69f87305de7f86a&amp;chksm=ce77c513f9004c05b48f849ff99997d6d7252453135ae856a029137b88aa70b8e046013d596e&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">ã€ŠNettyå¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œæ•°æ®ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸€æ–‡ä¸­è¯»å–åˆ°çš„ ByteBuffer (è¿™é‡Œçš„ Object msg)ï¼Œç›´æ¥å‘é€å›ç»™å®¢æˆ·ç«¯ï¼Œç”¨è¿™ä¸ªç®€å•çš„ä¾‹å­æ¥æ­å¼€ Netty å¦‚ä½•å‘é€æ•°æ®çš„åºå¹•~~</p> <blockquote><p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆè¦é€šè¿‡è§£ç å™¨å°†è¯»å–åˆ°çš„ ByteBuffer è§£ç è½¬æ¢ä¸ºæˆ‘ä»¬çš„ä¸šåŠ¡ Request ç±»ï¼Œç„¶ååœ¨ä¸šåŠ¡çº¿ç¨‹ä¸­åšä¸šåŠ¡å¤„ç†ï¼Œåœ¨é€šè¿‡ç¼–ç å™¨å¯¹ä¸šåŠ¡ Response ç±»ç¼–ç ä¸º ByteBuffer ï¼Œæœ€ååˆ©ç”¨ ChannelHandlerContext ctx çš„å¼•ç”¨å‘é€å“åº”æ•°æ®ã€‚</p></blockquote> <blockquote><p>æœ¬æ–‡æˆ‘ä»¬åªèšç„¦ Netty å†™æ•°æ®çš„è¿‡ç¨‹ï¼Œå¯¹äº Netty ç¼–è§£ç ç›¸å…³çš„å†…å®¹ï¼Œç¬”è€…ä¼šåœ¨åç»­çš„æ–‡ç« ä¸­ä¸“é—¨ä»‹ç»ã€‚</p></blockquote> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191113734.png" alt="å›¾ç‰‡">æœ¬æ–‡æ¦‚è¦.png</p> <h2 id="_1-channelhandlercontext"><a href="#_1-channelhandlercontext" class="header-anchor">#</a> 1. ChannelHandlerContext</h2> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)pipelineç»“æ„.png</p> <p>é€šè¿‡å‰é¢å‡ ç¯‡æ–‡ç« çš„ä»‹ç»ï¼Œæˆ‘ä»¬çŸ¥é“ Netty ä¼šä¸ºæ¯ä¸ª Channel åˆ†é…ä¸€ä¸ª pipeline ï¼Œpipeline æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨çš„ç»“æ„ã€‚Netty ä¸­äº§ç”Ÿçš„ IO å¼‚æ­¥äº‹ä»¶ä¼šåœ¨è¿™ä¸ª pipeline ä¸­ä¼ æ’­ã€‚</p> <p>Netty ä¸­çš„ IO å¼‚æ­¥äº‹ä»¶å¤§ä½“ä¸Šåˆ†ä¸ºä¸¤ç±»ï¼š</p> <ul><li><p>inboundäº‹ä»¶ï¼šå…¥ç«™äº‹ä»¶ï¼Œæ¯”å¦‚å‰è¾¹ä»‹ç»çš„ ChannelActive äº‹ä»¶ï¼Œ ChannelRead äº‹ä»¶ï¼Œå®ƒä»¬ä¼šä» pipeline çš„å¤´ç»“ç‚¹ HeadContext å¼€å§‹ä¸€ç›´å‘åä¼ æ’­ã€‚</p></li> <li><p>outboundäº‹ä»¶ï¼šå‡ºç«™äº‹ä»¶ï¼Œæ¯”å¦‚æœ¬æ–‡ä¸­å³å°†è¦ä»‹ç»åˆ°çš„ writeäº‹ä»¶ ä»¥åŠ flush äº‹ä»¶ï¼Œå‡ºç«™äº‹ä»¶ä¼šä»ç›¸åçš„æ–¹å‘ä»åå¾€å‰ä¼ æ’­ç›´åˆ° HeadContext ã€‚æœ€ç»ˆä¼šåœ¨ HeadContext ä¸­å®Œæˆå‡ºç«™äº‹ä»¶çš„å¤„ç†ã€‚</p></li> <li><ul><li>æœ¬ä¾‹ä¸­ç”¨åˆ°çš„ channelHandlerContext.write()  ä¼šä½¿ write äº‹ä»¶ä»å½“å‰ ChannelHandler ä¹Ÿå°±æ˜¯è¿™é‡Œçš„ EchoServerHandler å¼€å§‹æ²¿ç€ pipeline å‘å‰ä¼ æ’­ã€‚</li> <li>è€Œ channelHandlerContext.channel().write() åˆ™ä¼šä½¿ write äº‹ä»¶ä» pipeline çš„å°¾ç»“ç‚¹ TailContext å¼€å§‹å‘å‰ä¼ æ’­ç›´åˆ° HeadContext ã€‚</li></ul></li></ul> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)å®¢æˆ·ç«¯channel pipelineç»“æ„.png</p> <p>è€Œ pipeline è¿™æ ·ä¸€ä¸ªåŒå‘é“¾è¡¨æ•°æ®ç»“æ„ä¸­çš„ç±»å‹æ­£æ˜¯ ChannelHandlerContext  ï¼Œç”± ChannelHandlerContext åŒ…è£¹æˆ‘ä»¬è‡ªå®šä¹‰çš„ IO å¤„ç†é€»è¾‘ ChannelHandlerã€‚</p> <blockquote><p>ChannelHandler å¹¶ä¸éœ€è¦æ„ŸçŸ¥åˆ°å®ƒæ‰€å¤„çš„ pipeline ä¸­çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œåªéœ€è¦ä¸“å¿ƒå¤„ç†å¥½ IO é€»è¾‘å³å¯ï¼Œå…³äº pipeline çš„ä¸Šä¸‹æ–‡ä¿¡æ¯å…¨éƒ¨å°è£…åœ¨ ChannelHandlerContextä¸­ã€‚</p></blockquote> <p>ChannelHandler åœ¨ Netty ä¸­çš„ä½œç”¨åªæ˜¯è´Ÿè´£å¤„ç† IO é€»è¾‘ï¼Œæ¯”å¦‚ç¼–ç ï¼Œè§£ç ã€‚å®ƒå¹¶ä¸ä¼šæ„ŸçŸ¥åˆ°å®ƒåœ¨ pipeline ä¸­çš„ä½ç½®ï¼Œæ›´ä¸ä¼šæ„ŸçŸ¥å’Œå®ƒç›¸é‚»çš„ä¸¤ä¸ª ChannelHandlerã€‚<strong>äº‹å®ä¸Š ChannelHandlerä¹Ÿå¹¶ä¸éœ€è¦å»å…³å¿ƒè¿™äº›ï¼Œå®ƒå”¯ä¸€éœ€è¦å…³æ³¨çš„å°±æ˜¯å¤„ç†æ‰€å…³å¿ƒçš„å¼‚æ­¥äº‹ä»¶</strong></p> <p>è€Œ ChannelHandlerContext ä¸­ç»´æŠ¤äº† pipeline è¿™ä¸ªåŒå‘é“¾è¡¨ä¸­çš„ pre ä»¥åŠ next æŒ‡é’ˆï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿çš„æ‰¾åˆ°ä¸å…¶ç›¸é‚»çš„ ChannelHandler ï¼Œå¹¶å¯ä»¥è¿‡æ»¤å‡ºä¸€äº›ç¬¦åˆæ‰§è¡Œæ¡ä»¶çš„ ChannelHandlerã€‚æ­£å¦‚å®ƒçš„å‘½åä¸€æ ·ï¼Œ ChannelHandlerContext  æ­£æ˜¯èµ·åˆ°äº†ç»´æŠ¤ ChannelHandler ä¸Šä¸‹æ–‡çš„ä¸€ä¸ªä½œç”¨ã€‚è€Œ Netty ä¸­çš„å¼‚æ­¥äº‹ä»¶åœ¨ pipeline ä¸­çš„ä¼ æ’­é çš„å°±æ˜¯è¿™ä¸ª ChannelHandlerContext ã€‚</p> <blockquote><p>è¿™æ ·è®¾è®¡å°±ä½¿å¾— ChannelHandlerContext å’Œ ChannelHandler çš„èŒè´£å•ä¸€ï¼Œå„å¸å…¶èŒï¼Œå…·æœ‰é«˜åº¦çš„å¯æ‰©å±•æ€§ã€‚</p></blockquote> <h2 id="_2-writeäº‹ä»¶çš„ä¼ æ’­"><a href="#_2-writeäº‹ä»¶çš„ä¼ æ’­" class="header-anchor">#</a> 2. writeäº‹ä»¶çš„ä¼ æ’­</h2> <p>æˆ‘ä»¬æ— è®ºæ˜¯åœ¨ä¸šåŠ¡çº¿ç¨‹æˆ–è€…æ˜¯åœ¨ SubReactor çº¿ç¨‹ä¸­å®Œæˆä¸šåŠ¡å¤„ç†åï¼Œéƒ½éœ€è¦é€šè¿‡ channelHandlerContext çš„å¼•ç”¨å°† writeäº‹ä»¶åœ¨ pipeline ä¸­è¿›è¡Œä¼ æ’­ã€‚ç„¶ååœ¨ pipeline ä¸­ç›¸åº”çš„ ChannelHandler ä¸­ç›‘å¬ write äº‹ä»¶ä»è€Œå¯ä»¥å¯¹ writeäº‹ä»¶è¿›è¡Œè‡ªå®šä¹‰ç¼–æ’å¤„ç†ï¼ˆæ¯”å¦‚æˆ‘ä»¬å¸¸ç”¨çš„ç¼–ç å™¨ï¼‰ï¼Œæœ€ç»ˆä¼ æ’­åˆ° HeadContext ä¸­æ‰§è¡Œå‘é€æ•°æ®çš„é€»è¾‘æ“ä½œã€‚</p> <p>å‰è¾¹ä¹Ÿæåˆ° Netty ä¸­æœ‰ä¸¤ä¸ªè§¦å‘ write äº‹ä»¶ä¼ æ’­çš„æ–¹æ³•ï¼Œå®ƒä»¬çš„ä¼ æ’­å¤„ç†é€»è¾‘éƒ½æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡å®ƒä»¬åœ¨ pipeline ä¸­çš„<strong>ä¼ æ’­èµ·ç‚¹</strong>æ˜¯ä¸åŒçš„ã€‚</p> <ul><li>channelHandlerContext.write() æ–¹æ³•ä¼šä»å½“å‰ ChannelHandler å¼€å§‹åœ¨ pipeline ä¸­å‘å‰ä¼ æ’­ write äº‹ä»¶ç›´åˆ° HeadContextã€‚</li> <li>channelHandlerContext.channel().write() æ–¹æ³•åˆ™ä¼šä» pipeline çš„å°¾ç»“ç‚¹ TailContext å¼€å§‹åœ¨ pipeline ä¸­å‘å‰ä¼ æ’­ write äº‹ä»¶ç›´åˆ° HeadContext ã€‚</li></ul> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191113159.png" alt="å›¾ç‰‡">å®¢æˆ·ç«¯channel pipelineç»“æ„.png</p> <p>åœ¨æˆ‘ä»¬æ¸…æ¥šäº† write äº‹ä»¶çš„æ€»ä½“ä¼ æ’­æµç¨‹åï¼Œæ¥ä¸‹æ¥å°±æ¥çœ‹çœ‹åœ¨ write äº‹ä»¶ä¼ æ’­çš„è¿‡ç¨‹ä¸­Nettyä¸ºæˆ‘ä»¬ä½œäº†äº›ä»€ä¹ˆï¼Ÿè¿™é‡Œæˆ‘ä»¬ä»¥ channelHandlerContext.write() æ–¹æ³•ä¸ºä¾‹è¯´æ˜ã€‚</p> <h2 id="_3-writeæ–¹æ³•å‘é€æ•°æ®"><a href="#_3-writeæ–¹æ³•å‘é€æ•°æ®" class="header-anchor">#</a> 3. writeæ–¹æ³•å‘é€æ•°æ®</h2> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)writeäº‹ä»¶ä¼ æ’­æµç¨‹.png</p> <div class="language- extra-class"><pre class="language-text"><code>abstract class AbstractChannelHandlerContext implements ChannelHandlerContext, ResourceLeakHint {

    @Override
    public ChannelFuture write(Object msg) {
        return write(msg, newPromise());
    }

    @Override
    public ChannelFuture write(final Object msg, final ChannelPromise promise) {
        write(msg, false, promise);
        return promise;
    }

}
</code></pre></div><p>è¿™é‡Œæˆ‘ä»¬çœ‹åˆ° Netty çš„å†™æ“ä½œæ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œå½“æˆ‘ä»¬åœ¨ä¸šåŠ¡çº¿ç¨‹ä¸­è°ƒç”¨ channelHandlerContext.write() åï¼ŒNetty ä¼šç»™æˆ‘ä»¬è¿”å›ä¸€ä¸ª ChannelFutureï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ª ChannelFutrue ä¸­æ·»åŠ  ChannelFutureListener ï¼Œè¿™æ ·å½“ Netty å°†æˆ‘ä»¬è¦å‘é€çš„æ•°æ®å‘é€åˆ°åº•å±‚ Socket ä¸­æ—¶ï¼ŒNetty ä¼šé€šè¿‡ ChannelFutureListener é€šçŸ¥æˆ‘ä»¬å†™å…¥ç»“æœã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public void channelRead(final ChannelHandlerContext ctx, final Object msg) {
        //æ­¤å¤„çš„msgå°±æ˜¯Nettyåœ¨read loopä¸­ä»NioSocketChannelä¸­è¯»å–åˆ°çš„ByteBuffer
        ChannelFuture future = ctx.write(msg);
        future.addListener(new ChannelFutureListener() {
            @Override
            public void operationComplete(ChannelFuture future) throws Exception {
                Throwable cause = future.cause();
                if (cause != null) {
                     å¤„ç†å¼‚å¸¸æƒ…å†µ
                } else {                    
                     å†™å…¥SocketæˆåŠŸåï¼ŒNettyä¼šé€šçŸ¥åˆ°è¿™é‡Œ
                }
            }
        });
}
</code></pre></div><p>å½“å¼‚æ­¥äº‹ä»¶åœ¨ pipeline ä¼ æ’­çš„è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œå¼‚æ­¥äº‹ä»¶å°±ä¼šåœæ­¢åœ¨ pipeline ä¸­ä¼ æ’­ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œéœ€è¦å¯¹å†™æ“ä½œå¼‚å¸¸æƒ…å†µè¿›è¡Œå¤„ç†ã€‚</p> <ul><li>å…¶ä¸­ inbound ç±»å¼‚æ­¥äº‹ä»¶å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œ<strong>ä¼šè§¦å‘exceptionCaughtäº‹ä»¶ä¼ æ’­</strong>ã€‚exceptionCaught äº‹ä»¶æœ¬èº«ä¹Ÿæ˜¯ä¸€ç§ inbound äº‹ä»¶ï¼Œä¼ æ’­æ–¹å‘ä¼šä»å½“å‰å‘ç”Ÿå¼‚å¸¸çš„ ChannelHandler å¼€å§‹ä¸€ç›´å‘åä¼ æ’­ç›´åˆ° TailContextã€‚</li> <li>è€Œ outbound ç±»å¼‚æ­¥äº‹ä»¶å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œ<strong>åˆ™ä¸ä¼šè§¦å‘exceptionCaughtäº‹ä»¶ä¼ æ’­</strong>ã€‚ä¸€èˆ¬åªæ˜¯é€šçŸ¥ç›¸å…³ ChannelFutureã€‚ä½†å¦‚æœæ˜¯ flush äº‹ä»¶åœ¨ä¼ æ’­è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œåˆ™ä¼šè§¦å‘å½“å‰å‘ç”Ÿå¼‚å¸¸çš„ ChannelHandler ä¸­ exceptionCaught äº‹ä»¶å›è°ƒã€‚</li></ul> <p>æˆ‘ä»¬ç»§ç»­å›å½’åˆ°å†™æ“ä½œçš„ä¸»çº¿ä¸Šæ¥~~~</p> <div class="language- extra-class"><pre class="language-text"><code>    private void write(Object msg, boolean flush, ChannelPromise promise) {
        ObjectUtil.checkNotNull(msg, &quot;msg&quot;);

        ................çœç•¥æ£€æŸ¥promiseçš„æœ‰æ•ˆæ€§...............

        //flush = true è¡¨ç¤ºchannelHandlerä¸­è°ƒç”¨çš„æ˜¯writeAndFlushæ–¹æ³•ï¼Œè¿™é‡Œéœ€è¦æ‰¾åˆ°pipelineä¸­è¦†ç›–writeæˆ–è€…flushæ–¹æ³•çš„channelHandler
        //flush = false è¡¨ç¤ºè°ƒç”¨çš„æ˜¯writeæ–¹æ³•ï¼Œåªéœ€è¦æ‰¾åˆ°pipelineä¸­è¦†ç›–writeæ–¹æ³•çš„channelHandler
        final AbstractChannelHandlerContext next = findContextOutbound(flush ?
                (MASK_WRITE | MASK_FLUSH) : MASK_WRITE);
        //ç”¨äºæ£€æŸ¥å†…å­˜æ³„éœ²
        final Object m = pipeline.touch(msg, next);
        //è·å–pipelineä¸­ä¸‹ä¸€ä¸ªè¦è¢«æ‰§è¡Œçš„channelHandlerçš„executor
        EventExecutor executor = next.executor();
        //ç¡®ä¿OutBoundäº‹ä»¶ç”±ChannelHandleræŒ‡å®šçš„executoræ‰§è¡Œ
        if (executor.inEventLoop()) {
            //å¦‚æœå½“å‰çº¿ç¨‹æ­£æ˜¯channelHandleræŒ‡å®šçš„executoråˆ™ç›´æ¥æ‰§è¡Œ
            if (flush) {
                next.invokeWriteAndFlush(m, promise);
            } else {
                next.invokeWrite(m, promise);
            }
        } else {
            //å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯ChannelHandleræŒ‡å®šçš„executor,åˆ™å°è£…æˆå¼‚æ­¥ä»»åŠ¡æäº¤ç»™æŒ‡å®šexecutoræ‰§è¡Œï¼Œæ³¨æ„è¿™é‡Œçš„executorä¸ä¸€å®šæ˜¯reactorçº¿ç¨‹ã€‚
            final WriteTask task = WriteTask.newInstance(next, m, promise, flush);
            if (!safeExecute(executor, task, promise, m, !flush)) {
                task.cancel();
            }
        }
    }
</code></pre></div><p>write äº‹ä»¶è¦å‘å‰åœ¨ pipeline ä¸­ä¼ æ’­ï¼Œå°±éœ€è¦åœ¨ pipeline ä¸Šæ‰¾åˆ°ä¸‹ä¸€ä¸ªå…·æœ‰æ‰§è¡Œèµ„æ ¼çš„ ChannelHandlerï¼Œå› ä¸ºä½äºå½“å‰ ChannelHandler å‰è¾¹çš„å¯èƒ½æ˜¯ ChannelInboundHandler ç±»å‹çš„ä¹Ÿå¯èƒ½æ˜¯ ChannelOutboundHandler ç±»å‹çš„ ChannelHandler ï¼Œæˆ–è€…æœ‰å¯èƒ½å‹æ ¹å°±ä¸å…³å¿ƒ write äº‹ä»¶çš„ ChannelHandlerï¼ˆæ²¡æœ‰å®ç°writeå›è°ƒæ–¹æ³•ï¼‰ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)writeäº‹ä»¶çš„ä¼ æ’­.png</p> <p>è¿™é‡Œæˆ‘ä»¬å°±éœ€è¦é€šè¿‡ findContextOutbound æ–¹æ³•åœ¨å½“å‰ ChannelHandler çš„å‰è¾¹æ‰¾åˆ° ChannelOutboundHandler ç±»å‹å¹¶ä¸”è¦†ç›–å®ç° write å›è°ƒæ–¹æ³•çš„ ChannelHandler ä½œä¸ºä¸‹ä¸€ä¸ªè¦æ‰§è¡Œçš„å¯¹è±¡ã€‚</p> <h3 id="_3-1-findcontextoutbound"><a href="#_3-1-findcontextoutbound" class="header-anchor">#</a> 3.1 findContextOutbound</h3> <div class="language- extra-class"><pre class="language-text"><code>  private AbstractChannelHandlerContext findContextOutbound(int mask) {
        AbstractChannelHandlerContext ctx = this;
        //è·å–å½“å‰ChannelHandlerçš„executor
        EventExecutor currentExecutor = executor();
        do {
            //è·å–å‰ä¸€ä¸ªChannelHandler
            ctx = ctx.prev;
        } while (skipContext(ctx, currentExecutor, mask, MASK_ONLY_OUTBOUND));
        return ctx;
    }
    //åˆ¤æ–­å‰ä¸€ä¸ªChannelHandleræ˜¯å¦å…·æœ‰å“åº”Writeäº‹ä»¶çš„èµ„æ ¼
    private static boolean skipContext(
            AbstractChannelHandlerContext ctx, EventExecutor currentExecutor, int mask, int onlyMask) {

        return (ctx.executionMask &amp; (onlyMask | mask)) == 0 ||
                (ctx.executor() == currentExecutor &amp;&amp; (ctx.executionMask &amp; mask) == 0);
    }
</code></pre></div><p>findContextOutbound æ–¹æ³•æ¥æ”¶çš„å‚æ•°æ˜¯ä¸€ä¸ªæ©ç ï¼Œè¿™ä¸ªæ©ç è¡¨ç¤ºè¦å‘å‰æŸ¥æ‰¾å…·æœ‰ä»€ä¹ˆæ ·æ‰§è¡Œèµ„æ ¼çš„ ChannelHandlerã€‚å› ä¸ºæˆ‘ä»¬è¿™é‡Œè°ƒç”¨çš„æ˜¯ ChannelHandlerContext çš„ write æ–¹æ³•æ‰€ä»¥ flush = falseï¼Œä¼ é€’è¿›æ¥çš„æ©ç ä¸º MASK_WRITEï¼Œè¡¨ç¤ºæˆ‘ä»¬è¦å‘å‰æŸ¥æ‰¾è¦†ç›–å®ç°äº† write å›è°ƒæ–¹æ³•çš„ ChannelOutboundHandlerã€‚</p> <h4 id="_3-1-1-æ©ç çš„å·§å¦™åº”ç”¨"><a href="#_3-1-1-æ©ç çš„å·§å¦™åº”ç”¨" class="header-anchor">#</a> 3.1.1 æ©ç çš„å·§å¦™åº”ç”¨</h4> <p>Netty ä¸­å°† ChannelHandler è¦†ç›–å®ç°çš„ä¸€äº›å¼‚æ­¥äº‹ä»¶å›è°ƒæ–¹æ³•ç”¨ int å‹çš„æ©ç æ¥è¡¨ç¤ºï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è¿™ä¸ªæ©ç æ¥åˆ¤æ–­å½“å‰ ChannelHandler å…·æœ‰ä»€ä¹ˆæ ·çš„æ‰§è¡Œèµ„æ ¼ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>final class ChannelHandlerMask {
    ....................çœç•¥......................

    static final int MASK_CHANNEL_ACTIVE = 1 &lt;&lt; 3;
    static final int MASK_CHANNEL_READ = 1 &lt;&lt; 5;
    static final int MASK_CHANNEL_READ_COMPLETE = 1 &lt;&lt; 6;
    static final int MASK_WRITE = 1 &lt;&lt; 15;
    static final int MASK_FLUSH = 1 &lt;&lt; 16;

   //outboundäº‹ä»¶æ©ç é›†åˆ
   static final int MASK_ONLY_OUTBOUND =  MASK_BIND | MASK_CONNECT | MASK_DISCONNECT |
            MASK_CLOSE | MASK_DEREGISTER | MASK_READ | MASK_WRITE | MASK_FLUSH;
    ....................çœç•¥......................
}
</code></pre></div><p>åœ¨ ChannelHandler è¢«æ·»åŠ è¿› pipeline çš„æ—¶å€™ï¼ŒNetty ä¼šæ ¹æ®å½“å‰ ChannelHandler çš„ç±»å‹ä»¥åŠå…¶è¦†ç›–å®ç°çš„å¼‚æ­¥äº‹ä»¶å›è°ƒæ–¹æ³•ï¼Œé€šè¿‡ <code>| è¿ç®—</code> å‘ ChannelHandlerContext#executionMask å­—æ®µæ·»åŠ è¯¥ ChannelHandler çš„æ‰§è¡Œèµ„æ ¼ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>abstract class AbstractChannelHandlerContext implements ChannelHandlerContext, ResourceLeakHint {

    //ChannelHandleræ‰§è¡Œèµ„æ ¼æ©ç 
    private final int executionMask;

    ....................çœç•¥......................
}
</code></pre></div><p>ç±»ä¼¼çš„æ©ç ç”¨æ³•å…¶å®æˆ‘ä»¬åœ¨å‰è¾¹çš„æ–‡ç« <a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484087&amp;idx=1&amp;sn=0c065780e0f05c23c8e6465ede86cba0&amp;chksm=ce77c4f0f9004de63be369a664105708bc5975b52993f4a6df223caed34cc1ef6185a16acd75&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€Šä¸€æ–‡èŠé€Nettyæ ¸å¿ƒå¼•æ“Reactorçš„è¿è½¬æ¶æ„ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸­ä¹Ÿæåˆ°è¿‡ï¼Œåœ¨ Channel å‘å¯¹åº”çš„ Reactor æ³¨å†Œè‡ªå·±æ„Ÿå…´è¶£çš„ IO äº‹ä»¶æ—¶ï¼Œä¹Ÿæ˜¯ç”¨åˆ°äº†ä¸€ä¸ª int å‹çš„æ©ç  interestOps æ¥è¡¨ç¤º Channel æ„Ÿå…´è¶£çš„ IO äº‹ä»¶é›†åˆã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    protected void doBeginRead() throws Exception {

        final SelectionKey selectionKey = this.selectionKey;
        if (!selectionKey.isValid()) {
            return;
        }

        readPending = true;

        final int interestOps = selectionKey.interestOps();
        /**
         * 1ï¼šServerSocketChannel åˆå§‹åŒ–æ—¶ readInterestOpè®¾ç½®çš„æ˜¯OP_ACCEPTäº‹ä»¶
         * 2ï¼šSocketChannel åˆå§‹åŒ–æ—¶ readInterestOpè®¾ç½®çš„æ˜¯OP_READäº‹ä»¶
         * */
        if ((interestOps &amp; readInterestOp) == 0) {
            //æ³¨å†Œç›‘å¬OP_ACCEPTæˆ–è€…OP_READäº‹ä»¶
            selectionKey.interestOps(interestOps | readInterestOp);
        }
    }
</code></pre></div><ul><li>ç”¨ &amp; æ“ä½œåˆ¤æ–­ï¼ŒæŸä¸ªäº‹ä»¶æ˜¯å¦åœ¨äº‹ä»¶é›†åˆä¸­ï¼š<code>(readyOps &amp; SelectionKey.OP_CONNECT) != 0</code></li> <li>ç”¨ | æ“ä½œå‘äº‹ä»¶é›†åˆä¸­æ·»åŠ äº‹ä»¶ï¼š<code>interestOps | readInterestOp</code></li> <li>ä»äº‹ä»¶é›†åˆä¸­åˆ é™¤æŸä¸ªäº‹ä»¶ï¼Œæ˜¯é€šè¿‡å…ˆå°†è¦åˆ é™¤äº‹ä»¶å–å ~ ï¼Œç„¶ååœ¨å’Œäº‹ä»¶é›†åˆåš &amp; æ“ä½œï¼š<code>ops &amp;= ~SelectionKey.OP_CONNECT</code></li></ul> <blockquote><p>è¿™éƒ¨åˆ†å†…å®¹ç¬”è€…ä¼šåœ¨ä¸‹ç¯‡æ–‡ç« å…¨é¢ä»‹ç» pipeline çš„æ—¶å€™è¯¦ç»†è®²è§£ï¼Œå¤§å®¶è¿™é‡Œåªéœ€è¦çŸ¥é“è¿™é‡Œçš„æ©ç å°±æ˜¯è¡¨ç¤ºä¸€ä¸ªæ‰§è¡Œèµ„æ ¼çš„é›†åˆã€‚å½“å‰ ChannelHandler çš„æ‰§è¡Œèµ„æ ¼å­˜æ”¾åœ¨å®ƒçš„ ChannelHandlerContext ä¸­çš„ executionMask å­—æ®µä¸­ã€‚</p></blockquote> <h4 id="_3-1-2-å‘å‰æŸ¥æ‰¾å…·æœ‰æ‰§è¡Œèµ„æ ¼çš„channeloutboundhandler"><a href="#_3-1-2-å‘å‰æŸ¥æ‰¾å…·æœ‰æ‰§è¡Œèµ„æ ¼çš„channeloutboundhandler" class="header-anchor">#</a> 3.1.2 å‘å‰æŸ¥æ‰¾å…·æœ‰æ‰§è¡Œèµ„æ ¼çš„ChannelOutboundHandler</h4> <div class="language- extra-class"><pre class="language-text"><code>  private AbstractChannelHandlerContext findContextOutbound(int mask) {
        //å½“å‰ChannelHandler
        AbstractChannelHandlerContext ctx = this;
        //è·å–å½“å‰ChannelHandlerçš„executor
        EventExecutor currentExecutor = executor();
        do {
            //è·å–å‰ä¸€ä¸ªChannelHandler
            ctx = ctx.prev;
        } while (skipContext(ctx, currentExecutor, mask, MASK_ONLY_OUTBOUND));
        return ctx;
    }

    //åˆ¤æ–­å‰ä¸€ä¸ªChannelHandleræ˜¯å¦å…·æœ‰å“åº”Writeäº‹ä»¶çš„èµ„æ ¼
    private static boolean skipContext(
            AbstractChannelHandlerContext ctx, EventExecutor currentExecutor, int mask, int onlyMask) {

        return (ctx.executionMask &amp; (onlyMask | mask)) == 0 ||
                (ctx.executor() == currentExecutor &amp;&amp; (ctx.executionMask &amp; mask) == 0);
    }
</code></pre></div><p>å‰è¾¹æˆ‘ä»¬æåˆ° ChannelHandlerContext ä¸ä»…å°è£…äº† ChannelHandler çš„æ‰§è¡Œèµ„æ ¼æ©ç è¿˜å¯ä»¥æ„ŸçŸ¥åˆ°å½“å‰ ChannelHandler åœ¨ pipeline ä¸­çš„ä½ç½®ï¼Œå› ä¸º ChannelHandlerContext ä¸­ç»´æŠ¤äº†å‰é©±æŒ‡é’ˆ prev ä»¥åŠåé©±æŒ‡é’ˆ nextã€‚</p> <p>è¿™é‡Œæˆ‘ä»¬éœ€è¦åœ¨ pipeline ä¸­ä¼ æ’­ write äº‹ä»¶ï¼Œå®ƒæ˜¯ä¸€ç§ outbound äº‹ä»¶ï¼Œæ‰€ä»¥éœ€è¦å‘å‰ä¼ æ’­ï¼Œè¿™é‡Œé€šè¿‡ ChannelHandlerContext çš„å‰é©±æŒ‡é’ˆ prev æ‹¿åˆ°å½“å‰ ChannelHandler åœ¨ pipeline ä¸­çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>ctx = ctx.prev;
</code></pre></div><p>é€šè¿‡ skipContext æ–¹æ³•åˆ¤æ–­å‰é©±èŠ‚ç‚¹æ˜¯å¦å…·æœ‰æ‰§è¡Œçš„èµ„æ ¼ã€‚å¦‚æœæ²¡æœ‰æ‰§è¡Œèµ„æ ¼åˆ™è·³è¿‡ç»§ç»­å‘å‰æŸ¥æ‰¾ã€‚å¦‚æœå…·æœ‰æ‰§è¡Œèµ„æ ¼åˆ™è¿”å›å¹¶å“åº” write äº‹ä»¶ã€‚</p> <p>åœ¨ write äº‹ä»¶ä¼ æ’­åœºæ™¯ä¸­ï¼Œæ‰§è¡Œèµ„æ ¼æŒ‡çš„æ˜¯å‰é©± ChannelHandler æ˜¯å¦æ˜¯ChannelOutboundHandler ç±»å‹çš„ï¼Œå¹¶ä¸”å®ƒæ˜¯å¦è¦†ç›–å®ç°äº† write äº‹ä»¶å›è°ƒæ–¹æ³•ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class EchoChannelHandler extends ChannelOutboundHandlerAdapter {

    @Override
    public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) throws Exception {
        super.write(ctx, msg, promise);
    }
}
</code></pre></div><h4 id="_3-1-3-skipcontext"><a href="#_3-1-3-skipcontext" class="header-anchor">#</a> 3.1.3 skipContext</h4> <p>è¯¥æ–¹æ³•ä¸»è¦ç”¨æ¥åˆ¤æ–­å½“å‰ ChannelHandler çš„å‰é©±èŠ‚ç‚¹æ˜¯å¦å…·æœ‰ mask æ©ç ä¸­åŒ…å«çš„äº‹ä»¶å“åº”èµ„æ ¼ã€‚</p> <p>æ–¹æ³•å‚æ•°ä¸­æœ‰ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„æ©ç ï¼š</p> <ul><li><code>int onlyMask</code>ï¼šç”¨æ¥æŒ‡å®šå½“å‰ ChannelHandler éœ€è¦ç¬¦åˆçš„ç±»å‹ã€‚å…¶ä¸­MASK_ONLY_OUTBOUND ä¸º ChannelOutboundHandler ç±»å‹çš„æ©ç ï¼Œ MASK_ONLY_INBOUND ä¸º ChannelInboundHandler ç±»å‹çš„æ©ç ã€‚</li></ul> <div class="language- extra-class"><pre class="language-text"><code>final class ChannelHandlerMask {

    //outboundäº‹ä»¶çš„æ©ç é›†åˆ
    static final int MASK_ONLY_OUTBOUND =  MASK_BIND | MASK_CONNECT | MASK_DISCONNECT |
            MASK_CLOSE | MASK_DEREGISTER | MASK_READ | MASK_WRITE | MASK_FLUSH;

    //inboundäº‹ä»¶çš„æ©ç é›†åˆ
    static final int MASK_ONLY_INBOUND =  MASK_CHANNEL_REGISTERED |
            MASK_CHANNEL_UNREGISTERED | MASK_CHANNEL_ACTIVE | MASK_CHANNEL_INACTIVE | MASK_CHANNEL_READ |
            MASK_CHANNEL_READ_COMPLETE | MASK_USER_EVENT_TRIGGERED | MASK_CHANNEL_WRITABILITY_CHANGED;
}
</code></pre></div><p>æ¯”å¦‚æœ¬å°èŠ‚ä¸­æˆ‘ä»¬æ˜¯åœ¨ä»‹ç» write äº‹ä»¶çš„ä¼ æ’­ï¼Œé‚£ä¹ˆå°±éœ€è¦åœ¨å½“å‰ChannelHandler å‰è¾¹é¦–å…ˆæ˜¯æ‰¾åˆ°ä¸€ä¸ª ChannelOutboundHandler ç±»å‹çš„ChannelHandlerã€‚</p> <p><code>ctx.executionMask &amp; (onlyMask | mask)) == 0</code> ç”¨äºåˆ¤æ–­å‰ä¸€ä¸ª ChannelHandler æ˜¯å¦ä¸ºæˆ‘ä»¬æŒ‡å®šçš„ ChannelHandler ç±»å‹ï¼Œåœ¨æœ¬å°èŠ‚ä¸­æˆ‘ä»¬æŒ‡å®šçš„æ˜¯ <code>onluMask = MASK_ONLY_OUTBOUND</code> å³ ChannelOutboundHandler ç±»å‹ã€‚å¦‚æœä¸æ˜¯ï¼Œè¿™é‡Œå°±ä¼šç›´æ¥è·³è¿‡ï¼Œç»§ç»­åœ¨ pipeline ä¸­å‘å‰æŸ¥æ‰¾ã€‚</p> <ul><li><code>int mask</code>ï¼šç”¨äºæŒ‡å®šå‰ä¸€ä¸ª ChannelHandler éœ€è¦å®ç°çš„ç›¸å…³å¼‚æ­¥äº‹ä»¶å¤„ç†å›è°ƒã€‚åœ¨æœ¬å°èŠ‚ä¸­è¿™é‡ŒæŒ‡å®šçš„æ˜¯ MASK_WRITE ï¼Œå³éœ€è¦å®ç° write å›è°ƒæ–¹æ³•ã€‚é€šè¿‡ <code>(ctx.executionMask &amp; mask) == 0</code> æ¡ä»¶æ¥åˆ¤æ–­å‰ä¸€ä¸ªChannelHandler æ˜¯å¦å®ç°äº† write å›è°ƒï¼Œå¦‚æœæ²¡æœ‰å®ç°è¿™é‡Œå°±è·³è¿‡ï¼Œç»§ç»­åœ¨ pipeline ä¸­å‘å‰æŸ¥æ‰¾ã€‚</li></ul> <blockquote><p>å…³äº skipContext æ–¹æ³•çš„è¯¦ç»†ä»‹ç»ï¼Œç¬”è€…è¿˜ä¼šåœ¨ä¸‹ç¯‡æ–‡ç« å…¨é¢ä»‹ç» pipelineçš„æ—¶å€™å†æ¬¡è¿›è¡Œä»‹ç»ï¼Œè¿™é‡Œå¤§å®¶åªéœ€è¦æ˜ç™½è¯¥æ–¹æ³•çš„æ ¸å¿ƒé€»è¾‘å³å¯ã€‚</p></blockquote> <h4 id="_3-1-4-å‘å‰ä¼ æ’­writeäº‹ä»¶"><a href="#_3-1-4-å‘å‰ä¼ æ’­writeäº‹ä»¶" class="header-anchor">#</a> 3.1.4 å‘å‰ä¼ æ’­writeäº‹ä»¶</h4> <p>é€šè¿‡ findContextOutbound æ–¹æ³•æˆ‘ä»¬åœ¨ pipeline ä¸­æ‰¾åˆ°äº†ä¸‹ä¸€ä¸ªå…·æœ‰æ‰§è¡Œèµ„æ ¼çš„ ChannelHandlerï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯ä¸‹ä¸€ä¸ª ChannelOutboundHandler ç±»å‹å¹¶ä¸”è¦†ç›–å®ç°äº† write æ–¹æ³•çš„ ChannelHandlerã€‚</p> <p>Netty ç´§æ¥ç€ä¼šè°ƒç”¨è¿™ä¸ª nextChannelHandler çš„ write æ–¹æ³•å®ç° write äº‹ä»¶åœ¨ pipeline ä¸­çš„ä¼ æ’­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>        //è·å–ä¸‹ä¸€ä¸ªè¦è¢«æ‰§è¡Œçš„channelHandleræŒ‡å®šçš„executor
        EventExecutor executor = next.executor();
        //ç¡®ä¿outboundäº‹ä»¶çš„æ‰§è¡Œ æ˜¯ç”± channelHandleræŒ‡å®šçš„executoræ‰§è¡Œçš„
        if (executor.inEventLoop()) {
            //å¦‚æœå½“å‰çº¿ç¨‹æ˜¯æŒ‡å®šçš„executor åˆ™ç›´æ¥æ“ä½œ
            if (flush) {
                next.invokeWriteAndFlush(m, promise);
            } else {
                next.invokeWrite(m, promise);
            }
        } else {
            //å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯channelHandleræŒ‡å®šçš„executorï¼Œåˆ™å°è£…ç¨‹å¼‚æ­¥ä»»åŠ¡ æäº¤ç»™æŒ‡å®šçš„executoræ‰§è¡Œ
            final WriteTask task = WriteTask.newInstance(next, m, promise, flush);
            if (!safeExecute(executor, task, promise, m, !flush)) {
                task.cancel();
            }
        }
</code></pre></div><p>åœ¨æˆ‘ä»¬å‘ pipeline æ·»åŠ  ChannelHandler çš„æ—¶å€™å¯ä»¥é€šè¿‡<code>ChannelPipeline#addLast(EventExecutorGroup,ChannelHandler......)</code> æ–¹æ³•æŒ‡å®šæ‰§è¡Œè¯¥ ChannelHandler çš„executorã€‚å¦‚æœä¸ç‰¹æ®ŠæŒ‡å®šï¼Œé‚£ä¹ˆæ‰§è¡Œè¯¥ ChannelHandler çš„executoré»˜è®¤ä¸ºè¯¥ Channel ç»‘å®šçš„ Reactor çº¿ç¨‹ã€‚</p> <blockquote><p>æ‰§è¡Œ ChannelHandler ä¸­å¼‚æ­¥äº‹ä»¶å›è°ƒæ–¹æ³•çš„çº¿ç¨‹å¿…é¡»æ˜¯ ChannelHandler æŒ‡å®šçš„executorã€‚</p></blockquote> <p>æ‰€ä»¥è¿™é‡Œé¦–å…ˆæˆ‘ä»¬éœ€è¦è·å–åœ¨ findContextOutbound æ–¹æ³•æŸ¥æ‰¾å‡ºæ¥çš„ä¸‹ä¸€ä¸ªç¬¦åˆæ‰§è¡Œæ¡ä»¶çš„ ChannelHandler æŒ‡å®šçš„executorã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>EventExecutor executor = next.executor()
</code></pre></div><p>å¹¶é€šè¿‡ <code>executor.inEventLoop()</code> æ–¹æ³•åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯è¯¥ ChannelHandler æŒ‡å®šçš„ executorã€‚</p> <p>å¦‚æœæ˜¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æ¥åœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œ ChannelHandler ä¸­çš„ write æ–¹æ³•ã€‚</p> <p>å¦‚æœä¸æ˜¯ï¼Œæˆ‘ä»¬å°±éœ€è¦å°† ChannelHandler å¯¹ write äº‹ä»¶çš„å›è°ƒæ“ä½œå°è£…æˆå¼‚æ­¥ä»»åŠ¡ WriteTask å¹¶æäº¤ç»™ ChannelHandler æŒ‡å®šçš„ executor ä¸­ï¼Œç”± executor è´Ÿè´£æ‰§è¡Œã€‚</p> <blockquote><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸ª executor å¹¶ä¸ä¸€å®šæ˜¯ channel ç»‘å®šçš„ reactor çº¿ç¨‹ã€‚å®ƒå¯ä»¥æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„çº¿ç¨‹æ± ï¼Œä¸è¿‡éœ€è¦æˆ‘ä»¬é€šè¿‡ ChannelPipeline#addLast æ–¹æ³•è¿›è¡ŒæŒ‡å®šï¼Œå¦‚æœæˆ‘ä»¬ä¸æŒ‡å®šï¼Œé»˜è®¤æƒ…å†µä¸‹æ‰§è¡Œ ChannelHandler çš„ executor æ‰æ˜¯ channel ç»‘å®šçš„ reactor çº¿ç¨‹ã€‚</p></blockquote> <blockquote><p>è¿™é‡ŒNettyéœ€è¦ç¡®ä¿ outbound äº‹ä»¶æ˜¯ç”± channelHandler æŒ‡å®šçš„ executor æ‰§è¡Œçš„ã€‚</p></blockquote> <p><strong>è¿™é‡Œæœ‰äº›åŒå­¦å¯èƒ½ä¼šæœ‰ç–‘é—®ï¼Œå¦‚æœæˆ‘ä»¬å‘pipielineæ·»åŠ ChannelHandlerçš„æ—¶å€™ï¼Œä¸ºæ¯ä¸ªChannelHandleræŒ‡å®šä¸åŒçš„executoræ—¶ï¼ŒNettyå¦‚æœç¡®ä¿çº¿ç¨‹å®‰å…¨å‘¢</strong>ï¼Ÿï¼Ÿ</p> <p>å¤§å®¶è¿˜è®°å¾—pipelineä¸­çš„ç»“æ„å—ï¼Ÿ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191113159.png" alt="å›¾ç‰‡">å®¢æˆ·ç«¯channel pipelineç»“æ„.png</p> <p>outbound äº‹ä»¶åœ¨ pipeline ä¸­çš„ä¼ æ’­æœ€ç»ˆä¼šä¼ æ’­åˆ° HeadContext ä¸­ï¼Œä¹‹å‰çš„ç³»åˆ—æ–‡ç« æˆ‘ä»¬æåˆ°è¿‡ï¼ŒHeadContext ä¸­å°è£…äº† Channel çš„ Unsafe ç±»è´Ÿè´£ Channel åº•å±‚çš„ IO æ“ä½œã€‚è€Œ HeadContext æŒ‡å®šçš„ executor æ­£æ˜¯å¯¹åº” channel ç»‘å®šçš„ reactor çº¿ç¨‹ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>æ‰€ä»¥æœ€ç»ˆåœ¨ netty å†…æ ¸ä¸­æ‰§è¡Œå†™æ“ä½œçš„çº¿ç¨‹ä¸€å®šæ˜¯ reactor çº¿ç¨‹ä»è€Œä¿è¯äº†çº¿ç¨‹å®‰å…¨æ€§ã€‚</p> <blockquote><p>å¿˜è®°è¿™æ®µå†…å®¹çš„åŒå­¦å¯ä»¥åœ¨å›é¡¾ä¸‹<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247483907&amp;idx=1&amp;sn=084c470a8fe6234c2c9461b5f713ff30&amp;chksm=ce77c444f9004d52e7c6244bee83479070effb0bc59236df071f4d62e91e25f01715fca53696&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€ŠReactoråœ¨Nettyä¸­çš„å®ç°(åˆ›å»ºç¯‡)ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ï¼Œç±»ä¼¼çš„å¥—è·¯æˆ‘ä»¬åœ¨ä»‹ç» NioServerSocketChannel è¿›è¡Œ bind ç»‘å®šä»¥åŠ register æ³¨å†Œçš„æ—¶å€™éƒ½ä»‹ç»è¿‡ï¼Œåªä¸è¿‡è¿™é‡Œå°† executor æ‰©å±•åˆ°äº†è‡ªå®šä¹‰çº¿ç¨‹æ± çš„èŒƒå›´ã€‚</p></blockquote> <h3 id="_3-1-5-è§¦å‘nextchannelhandlerçš„writeæ–¹æ³•å›è°ƒ"><a href="#_3-1-5-è§¦å‘nextchannelhandlerçš„writeæ–¹æ³•å›è°ƒ" class="header-anchor">#</a> 3.1.5 è§¦å‘nextChannelHandlerçš„writeæ–¹æ³•å›è°ƒ</h3> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)writeäº‹ä»¶çš„ä¼ æ’­1.png</p> <div class="language- extra-class"><pre class="language-text"><code>            //å¦‚æœå½“å‰çº¿ç¨‹æ˜¯æŒ‡å®šçš„executor åˆ™ç›´æ¥æ“ä½œ
            if (flush) {
                next.invokeWriteAndFlush(m, promise);
            } else {
                next.invokeWrite(m, promise);
            }
</code></pre></div><p>ç”±äºæˆ‘ä»¬åœ¨ç¤ºä¾‹ ChannelHandler ä¸­è°ƒç”¨çš„æ˜¯ ChannelHandlerContext#write æ–¹æ³•ï¼Œæ‰€ä»¥è¿™é‡Œçš„ flush = false ã€‚è§¦å‘è°ƒç”¨ nextChannelHandler çš„ write æ–¹æ³•ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    void invokeWrite(Object msg, ChannelPromise promise) {
        if (invokeHandler()) {
            invokeWrite0(msg, promise);
        } else {
            // å½“å‰channelHandlerè™½ç„¶æ·»åŠ åˆ°pipelineä¸­ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è°ƒç”¨handlerAdded
            // æ‰€ä»¥ä¸èƒ½è°ƒç”¨å½“å‰channelHandlerä¸­çš„å›è°ƒæ–¹æ³•ï¼Œåªèƒ½ç»§ç»­å‘å‰ä¼ é€’writeäº‹ä»¶
            write(msg, promise);
        }
    }
</code></pre></div><p>è¿™é‡Œé¦–å…ˆéœ€è¦é€šè¿‡ invokeHandler() æ–¹æ³•åˆ¤æ–­è¿™ä¸ª nextChannelHandler ä¸­çš„ handlerAdded æ–¹æ³•æ˜¯å¦è¢«å›è°ƒè¿‡ã€‚å› ä¸º ChannelHandler åªæœ‰è¢«æ­£ç¡®çš„æ·»åŠ åˆ°å¯¹åº”çš„ ChannelHandlerContext ä¸­å¹¶ä¸”å‡†å¤‡å¥½å¤„ç†å¼‚æ­¥äº‹ä»¶æ—¶ï¼Œ ChannelHandler#handlerAdded æ–¹æ³•æ‰ä¼šè¢«å›è°ƒã€‚</p> <blockquote><p>è¿™ä¸€éƒ¨åˆ†å†…å®¹ç¬”è€…ä¼šåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­è¯¦ç»†ä¸ºå¤§å®¶ä»‹ç»ï¼Œè¿™é‡Œå¤§å®¶åªéœ€è¦äº†è§£è°ƒç”¨ invokeHandler() æ–¹æ³•çš„ç›®çš„å°±æ˜¯ä¸ºäº†ç¡®å®š ChannelHandler æ˜¯å¦è¢«æ­£ç¡®çš„åˆå§‹åŒ–ã€‚</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>    private boolean invokeHandler() {
        // Store in local variable to reduce volatile reads.
        int handlerState = this.handlerState;
        return handlerState == ADD_COMPLETE || (!ordered &amp;&amp; handlerState == ADD_PENDING);
    }
</code></pre></div><p>åªæœ‰è§¦å‘äº† handlerAdded å›è°ƒï¼ŒChannelHandler çš„çŠ¶æ€æ‰èƒ½å˜æˆ ADD_COMPLETE ã€‚</p> <p>å¦‚æœ invokeHandler() æ–¹æ³•è¿”å› falseï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦è·³è¿‡è¿™ä¸ªnextChannelHandlerï¼Œå¹¶è°ƒç”¨ ChannelHandlerContext#write æ–¹æ³•ç»§ç»­å‘å‰ä¼ æ’­ write äº‹ä»¶ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public ChannelFuture write(final Object msg, final ChannelPromise promise) {
        //ç»§ç»­å‘å‰ä¼ æ’­writeäº‹ä»¶ï¼Œå›åˆ°æµç¨‹èµ·ç‚¹
        write(msg, false, promise);
        return promise;
    }
</code></pre></div><p>å¦‚æœ invokeHandler() è¿”å› true ï¼Œè¯´æ˜è¿™ä¸ª nextChannelHandler å·²ç»åœ¨ pipeline ä¸­è¢«æ­£ç¡®çš„åˆå§‹åŒ–äº†ï¼ŒNetty ç›´æ¥è°ƒç”¨è¿™ä¸ª ChannelHandler çš„ write æ–¹æ³•ï¼Œè¿™æ ·å°±å®ç°äº† write äº‹ä»¶ä»å½“å‰ ChannelHandler ä¼ æ’­åˆ°äº†nextChannelHandlerã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private void invokeWrite0(Object msg, ChannelPromise promise) {
        try {
            //è°ƒç”¨å½“å‰ChannelHandlerä¸­çš„writeæ–¹æ³•
            ((ChannelOutboundHandler) handler()).write(this, msg, promise);
        } catch (Throwable t) {
            notifyOutboundHandlerException(t, promise);
        }
    }
</code></pre></div><blockquote><p>è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°åœ¨ write äº‹ä»¶çš„ä¼ æ’­è¿‡ç¨‹ä¸­å¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œé‚£ä¹ˆ write äº‹ä»¶å°±ä¼šåœæ­¢åœ¨ pipeline ä¸­ä¼ æ’­ï¼Œå¹¶é€šçŸ¥æ³¨å†Œçš„ ChannelFutureListenerã€‚</p></blockquote> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191113159.png" alt="å›¾ç‰‡">å®¢æˆ·ç«¯channel pipelineç»“æ„.png</p> <p>ä»æœ¬æ–‡ç¤ºä¾‹çš„ pipeline ç»“æ„ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå½“åœ¨ EchoServerHandler è°ƒç”¨ ChannelHandlerContext#write æ–¹æ³•åï¼Œwrite äº‹ä»¶ä¼šåœ¨ pipeline ä¸­å‘å‰ä¼ æ’­åˆ° HeadContext ä¸­ï¼Œè€Œåœ¨ HeadContext ä¸­æ‰æ˜¯ Netty çœŸæ­£å¤„ç† write äº‹ä»¶çš„åœ°æ–¹ã€‚</p> <h2 id="_3-2-headcontext"><a href="#_3-2-headcontext" class="header-anchor">#</a> 3.2 HeadContext</h2> <div class="language- extra-class"><pre class="language-text"><code>final class HeadContext extends AbstractChannelHandlerContext
            implements ChannelOutboundHandler, ChannelInboundHandler {
          
        @Override
        public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) {
            unsafe.write(msg, promise);
        }
 }
</code></pre></div><p>write äº‹ä»¶æœ€ç»ˆä¼šåœ¨ pipeline ä¸­ä¼ æ’­åˆ° HeadContext é‡Œå¹¶å›è°ƒ HeadContext çš„ write æ–¹æ³•ã€‚å¹¶åœ¨ write å›è°ƒä¸­è°ƒç”¨ channel çš„ unsafe ç±»æ‰§è¡Œåº•å±‚çš„ write æ“ä½œã€‚è¿™é‡Œæ­£æ˜¯ write äº‹ä»¶åœ¨ pipeline ä¸­çš„ä¼ æ’­ç»ˆç‚¹ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191113121.png" alt="å›¾ç‰‡">ChannelOutboundBufferä¸­ç¼“å­˜å¾…å‘é€æ•°æ®.png</p> <div class="language- extra-class"><pre class="language-text"><code> protected abstract class AbstractUnsafe implements Unsafe {
        //å¾…å‘é€æ•°æ®ç¼“å†²é˜Ÿåˆ—  Nettyæ˜¯å…¨å¼‚æ­¥æ¡†æ¶ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦ä¸€ä¸ªç¼“å†²é˜Ÿåˆ—æ¥ç¼“å­˜ç”¨æˆ·éœ€è¦å‘é€çš„æ•°æ® 
        private volatile ChannelOutboundBuffer outboundBuffer = new ChannelOutboundBuffer(AbstractChannel.this);
  
        @Override
        public final void write(Object msg, ChannelPromise promise) {
            assertEventLoop();
            //è·å–å½“å‰channelå¯¹åº”çš„å¾…å‘é€æ•°æ®ç¼“å†²é˜Ÿåˆ—ï¼ˆæ”¯æŒç”¨æˆ·å¼‚æ­¥å†™å…¥çš„æ ¸å¿ƒå…³é”®ï¼‰
            ChannelOutboundBuffer outboundBuffer = this.outboundBuffer;

            ..........çœç•¥..................

            int size;
            try {
                //è¿‡æ»¤messageç±»å‹ è¿™é‡Œåªä¼šæ¥å—DirectBufferæˆ–è€…fileRegionç±»å‹çš„msg
                msg = filterOutboundMessage(msg);
                //è®¡ç®—å½“å‰msgçš„å¤§å°
                size = pipeline.estimatorHandle().size(msg);
                if (size &lt; 0) {
                    size = 0;
                }
            } catch (Throwable t) {
              ..........çœç•¥..................
            }
            //å°†msg åŠ å…¥åˆ°Nettyä¸­çš„å¾…å†™å…¥æ•°æ®ç¼“å†²é˜Ÿåˆ—ChannelOutboundBufferä¸­
            outboundBuffer.addMessage(msg, size, promise);
        }
    
 }
</code></pre></div><p>ä¼—æ‰€å‘¨çŸ¥ Netty æ˜¯ä¸€ä¸ªå¼‚æ­¥äº‹ä»¶é©±åŠ¨çš„ç½‘ç»œæ¡†æ¶ï¼Œåœ¨ Netty ä¸­æ‰€æœ‰çš„ IO æ“ä½œå…¨éƒ¨éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬æœ¬å°èŠ‚ä»‹ç»çš„ write æ“ä½œï¼Œä¸ºäº†ä¿è¯å¼‚æ­¥æ‰§è¡Œ write æ“ä½œï¼ŒNetty å®šä¹‰äº†ä¸€ä¸ªå¾…å‘é€æ•°æ®ç¼“å†²é˜Ÿåˆ— ChannelOutboundBuffer ï¼ŒNetty å°†è¿™äº›ç”¨æˆ·éœ€è¦å‘é€çš„ç½‘ç»œæ•°æ®åœ¨å†™å…¥åˆ° Socket ä¹‹å‰ï¼Œå…ˆæ”¾åœ¨ ChannelOutboundBuffer ä¸­ç¼“å­˜ã€‚</p> <blockquote><p>æ¯ä¸ªå®¢æˆ·ç«¯ NioSocketChannel å¯¹åº”ä¸€ä¸ª ChannelOutboundBuffer å¾…å‘é€æ•°æ®ç¼“å†²é˜Ÿåˆ—</p></blockquote> <h3 id="_3-2-1-filteroutboundmessage"><a href="#_3-2-1-filteroutboundmessage" class="header-anchor">#</a> 3.2.1 filterOutboundMessage</h3> <p>ChannelOutboundBuffer åªä¼šæ¥å— ByteBuffer ç±»å‹ä»¥åŠ FileRegion ç±»å‹çš„ msg æ•°æ®ã€‚</p> <blockquote><p>FileRegion æ˜¯Nettyå®šä¹‰çš„ç”¨æ¥é€šè¿‡é›¶æ‹·è´çš„æ–¹å¼ç½‘ç»œä¼ è¾“æ–‡ä»¶æ•°æ®ã€‚æœ¬æ–‡æˆ‘ä»¬ä¸»è¦èšç„¦æ™®é€šç½‘ç»œæ•°æ® ByteBuffer çš„å‘é€ã€‚</p></blockquote> <p>æ‰€ä»¥åœ¨å°† msg å†™å…¥åˆ° ChannelOutboundBuffer ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ£€æŸ¥å¾…å†™å…¥ msg çš„ç±»å‹ã€‚ç¡®ä¿æ˜¯ ChannelOutboundBuffer å¯æ¥å—çš„ç±»å‹ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    protected final Object filterOutboundMessage(Object msg) {
        if (msg instanceof ByteBuf) {
            ByteBuf buf = (ByteBuf) msg;
            if (buf.isDirect()) {
                return msg;
            }

            return newDirectBuffer(buf);
        }

        if (msg instanceof FileRegion) {
            return msg;
        }

        throw new UnsupportedOperationException(
                &quot;unsupported message type: &quot; + StringUtil.simpleClassName(msg) + EXPECTED_TYPES);
    }
</code></pre></div><p>åœ¨ç½‘ç»œæ•°æ®ä¼ è¾“çš„è¿‡ç¨‹ä¸­ï¼ŒNettyä¸ºäº†å‡å°‘æ•°æ®ä» å †å†…å†…å­˜ åˆ° å †å¤–å†…å­˜ çš„æ‹·è´ä»¥åŠç¼“è§£GCçš„å‹åŠ›ï¼Œæ‰€ä»¥è¿™é‡Œå¿…é¡»é‡‡ç”¨ DirectByteBuffer ä½¿ç”¨å †å¤–å†…å­˜æ¥å­˜æ”¾ç½‘ç»œå‘é€æ•°æ®ã€‚</p> <h3 id="_3-2-2-estimatorhandleè®¡ç®—å½“å‰msgçš„å¤§å°"><a href="#_3-2-2-estimatorhandleè®¡ç®—å½“å‰msgçš„å¤§å°" class="header-anchor">#</a> 3.2.2 estimatorHandleè®¡ç®—å½“å‰msgçš„å¤§å°</h3> <div class="language- extra-class"><pre class="language-text"><code>public class DefaultChannelPipeline implements ChannelPipeline {
    //åŸå­æ›´æ–°estimatorHandleå­—æ®µ
    private static final AtomicReferenceFieldUpdater&lt;DefaultChannelPipeline, MessageSizeEstimator.Handle&gt; ESTIMATOR =
            AtomicReferenceFieldUpdater.newUpdater(
                    DefaultChannelPipeline.class, MessageSizeEstimator.Handle.class, &quot;estimatorHandle&quot;);

    //è®¡ç®—è¦å‘é€msgå¤§å°çš„handler
    private volatile MessageSizeEstimator.Handle estimatorHandle;

    final MessageSizeEstimator.Handle estimatorHandle() {
        MessageSizeEstimator.Handle handle = estimatorHandle;
        if (handle == null) {
            handle = channel.config().getMessageSizeEstimator().newHandle();
            if (!ESTIMATOR.compareAndSet(this, null, handle)) {
                handle = estimatorHandle;
            }
        }
        return handle;
    }
}
</code></pre></div><p>åœ¨ pipeline ä¸­ä¼šæœ‰ä¸€ä¸ª estimatorHandle ä¸“é—¨ç”¨æ¥è®¡ç®—å¾…å‘é€ ByteBuffer çš„å¤§å°ã€‚è¿™ä¸ª estimatorHandle ä¼šåœ¨ pipeline å¯¹åº”çš„ Channel ä¸­çš„é…ç½®ç±»åˆ›å»ºçš„æ—¶å€™è¢«åˆå§‹åŒ–ã€‚</p> <p>è¿™é‡Œ estimatorHandle çš„å®é™…ç±»å‹ä¸º<code>DefaultMessageSizeEstimator#HandleImpl</code>ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public final class DefaultMessageSizeEstimator implements MessageSizeEstimator {

    private static final class HandleImpl implements Handle {
        private final int unknownSize;

        private HandleImpl(int unknownSize) {
            this.unknownSize = unknownSize;
        }

        @Override
        public int size(Object msg) {
            if (msg instanceof ByteBuf) {
                return ((ByteBuf) msg).readableBytes();
            }
            if (msg instanceof ByteBufHolder) {
                return ((ByteBufHolder) msg).content().readableBytes();
            }
            if (msg instanceof FileRegion) {
                return 0;
            }
            return unknownSize;
        }
    }
</code></pre></div><p>è¿™é‡Œæˆ‘ä»¬çœ‹åˆ° ByteBuffer çš„å¤§å°å³ä¸º Buffer ä¸­æœªè¯»å–çš„å­—èŠ‚æ•° writerIndex - readerIndex ã€‚</p> <p>å½“æˆ‘ä»¬éªŒè¯äº†å¾…å†™å…¥æ•°æ® msg çš„ç±»å‹ä»¥åŠè®¡ç®—äº† msg çš„å¤§å°åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ <code>ChannelOutboundBuffer#addMessage</code>æ–¹æ³•å°† msg å†™å…¥åˆ°ChannelOutboundBufferï¼ˆå¾…å‘é€æ•°æ®ç¼“å†²é˜Ÿåˆ—ï¼‰ä¸­ã€‚</p> <p>write äº‹ä»¶å¤„ç†çš„æœ€ç»ˆé€»è¾‘å°±æ˜¯å°†å¾…å‘é€æ•°æ®å†™å…¥åˆ° ChannelOutboundBuffer ä¸­ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹ä¸‹è¿™ä¸ª ChannelOutboundBuffer å†…éƒ¨ç»“æ„åˆ°åº•æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿ</p> <h2 id="_3-3-channeloutboundbuffer"><a href="#_3-3-channeloutboundbuffer" class="header-anchor">#</a> 3.3 ChannelOutboundBuffer</h2> <p>ChannelOutboundBuffer å…¶å®æ˜¯ä¸€ä¸ªå•é“¾è¡¨ç»“æ„çš„ç¼“å†²é˜Ÿåˆ—ï¼Œé“¾è¡¨ä¸­çš„èŠ‚ç‚¹ç±»å‹ä¸º Entry ï¼Œç”±äº ChannelOutboundBuffer åœ¨ Netty ä¸­çš„ä½œç”¨å°±æ˜¯ç¼“å­˜åº”ç”¨ç¨‹åºå¾…å‘é€çš„ç½‘ç»œæ•°æ®ï¼Œæ‰€ä»¥ Entry ä¸­å°è£…çš„å°±æ˜¯å¾…å†™å…¥ Socket ä¸­çš„ç½‘ç»œå‘é€æ•°æ®ç›¸å…³çš„ä¿¡æ¯ï¼Œä»¥åŠ ChannelHandlerContext#write æ–¹æ³•ä¸­è¿”å›ç»™ç”¨æˆ·çš„ ChannelPromise ã€‚è¿™æ ·å¯ä»¥åœ¨æ•°æ®å†™å…¥Socketä¹‹åå¼‚æ­¥é€šçŸ¥åº”ç”¨ç¨‹åºã€‚</p> <p>æ­¤å¤– ChannelOutboundBuffer ä¸­è¿˜å°è£…äº†ä¸‰ä¸ªé‡è¦çš„æŒ‡é’ˆï¼š</p> <ul><li><code>unflushedEntry</code> ï¼šè¯¥æŒ‡é’ˆæŒ‡å‘ ChannelOutboundBuffer ä¸­ç¬¬ä¸€ä¸ªå¾…å‘é€æ•°æ®çš„ Entryã€‚</li> <li><code>tailEntry</code>ï¼šè¯¥æŒ‡é’ˆæŒ‡å‘ ChannelOutboundBuffer ä¸­æœ€åä¸€ä¸ªå¾…å‘é€æ•°æ®çš„ Entryã€‚é€šè¿‡ unflushedEntry å’Œ tailEntry è¿™ä¸¤ä¸ªæŒ‡é’ˆï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„å®šä½åˆ°å¾…å‘é€æ•°æ®çš„ Entry èŒƒå›´ã€‚</li> <li><code>flushedEntry</code>ï¼šå½“æˆ‘ä»¬é€šè¿‡ flush æ“ä½œéœ€è¦å°† ChannelOutboundBuffer ä¸­ç¼“å­˜çš„å¾…å‘é€æ•°æ®å‘é€åˆ° Socket ä¸­æ—¶ï¼ŒflushedEntry æŒ‡é’ˆä¼šæŒ‡å‘ unflushedEntry çš„ä½ç½®ï¼Œè¿™æ · flushedEntry æŒ‡é’ˆå’Œ tailEntry æŒ‡é’ˆä¹‹é—´çš„ Entry å°±æ˜¯æˆ‘ä»¬å³å°†å‘é€åˆ° Socket ä¸­çš„ç½‘ç»œæ•°æ®ã€‚</li></ul> <p>è¿™ä¸‰ä¸ªæŒ‡é’ˆåœ¨åˆå§‹åŒ–çš„æ—¶å€™å‡ä¸º null ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)ChannelOutboundBufferç»“æ„.png</p> <h3 id="_3-3-1-entry"><a href="#_3-3-1-entry" class="header-anchor">#</a> 3.3.1 Entry</h3> <p>Entry ä½œä¸º ChannelOutboundBuffer é“¾è¡¨ç»“æ„ä¸­çš„èŠ‚ç‚¹å…ƒç´ ç±»å‹ï¼Œé‡Œè¾¹å°è£…äº†å¾…å‘é€æ•°æ®çš„å„ç§ä¿¡æ¯ï¼ŒChannelOutboundBuffer å…¶å®å°±æ˜¯å¯¹ Entry ç»“æ„çš„ç»„ç»‡å’Œæ“ä½œã€‚å› æ­¤ç†è§£ Entry ç»“æ„æ˜¯ç†è§£æ•´ä¸ª ChannelOutboundBuffer è¿ä½œæµç¨‹çš„åŸºç¡€ã€‚</p> <p>ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹ä¸‹ Entry ç»“æ„å…·ä½“å°è£…äº†å“ªäº›å¾…å‘é€æ•°æ®çš„ä¿¡æ¯ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    static final class Entry {
        //Entryçš„å¯¹è±¡æ± ï¼Œç”¨æ¥åˆ›å»ºå’Œå›æ”¶Entryå¯¹è±¡
        private static final ObjectPool&lt;Entry&gt; RECYCLER = ObjectPool.newPool(new ObjectCreator&lt;Entry&gt;() {
            @Override
            public Entry newObject(Handle&lt;Entry&gt; handle) {
                return new Entry(handle);
            }
        });

        //DefaultHandleç”¨äºå›æ”¶å¯¹è±¡
        private final Handle&lt;Entry&gt; handle;
        //ChannelOutboundBufferä¸‹ä¸€ä¸ªèŠ‚ç‚¹
        Entry next;
        //å¾…å‘é€æ•°æ®
        Object msg;
        //msg è½¬æ¢ä¸º jdk nio ä¸­çš„byteBuffer
        ByteBuffer[] bufs;
        ByteBuffer buf;
        //å¼‚æ­¥writeæ“ä½œçš„future
        ChannelPromise promise;
        //å·²å‘é€äº†å¤šå°‘
        long progress;
        //æ€»å…±éœ€è¦å‘é€å¤šå°‘ï¼Œä¸åŒ…å«entryå¯¹è±¡å¤§å°ã€‚
        long total;
        //pendingSizeè¡¨ç¤ºentryå¯¹è±¡åœ¨å †ä¸­éœ€è¦çš„å†…å­˜æ€»é‡ å¾…å‘é€æ•°æ®å¤§å° + entryå¯¹è±¡æœ¬èº«åœ¨å †ä¸­å ç”¨å†…å­˜å¤§å°ï¼ˆ96ï¼‰
        int pendingSize;
        //msgä¸­åŒ…å«äº†å‡ ä¸ªjdk nio bytebuffer
        int count = -1;
        //writeæ“ä½œæ˜¯å¦è¢«å–æ¶ˆ
        boolean cancelled;
}
</code></pre></div><p><strong>æˆ‘ä»¬çœ‹åˆ°Entryç»“æ„ä¸­ä¸€å…±æœ‰12ä¸ªå­—æ®µï¼Œå…¶ä¸­1ä¸ªé™æ€å­—æ®µå’Œ11ä¸ªå®ä¾‹å­—æ®µã€‚</strong></p> <p>ä¸‹é¢ç¬”è€…å°±ä¸ºå¤§å®¶ä»‹ç»ä¸‹è¿™12ä¸ªå­—æ®µçš„å«ä¹‰åŠå…¶ä½œç”¨ï¼Œå…¶ä¸­æœ‰äº›å­—æ®µä¼šåœ¨åé¢çš„åœºæ™¯ä¸­ä½¿ç”¨åˆ°ï¼Œè¿™é‡Œå¤§å®¶å¯èƒ½å¯¹æœ‰äº›å­—æ®µç†è§£èµ·æ¥æ¯”è¾ƒæ¨¡ç³Šï¼Œä¸è¿‡æ²¡å…³ç³»ï¼Œè¿™é‡Œèƒ½çœ‹æ‡‚å¤šå°‘æ˜¯å¤šå°‘ï¼Œä¸ç†è§£ä¹Ÿæ²¡å…³ç³»ï¼Œè¿™é‡Œä»‹ç»åªæ˜¯ä¸ºäº†è®©å¤§å®¶æ··ä¸ªçœ¼ç†Ÿï¼Œåœ¨åé¢æµç¨‹çš„è®²è§£ä¸­ï¼Œç¬”è€…è¿˜ä¼šé‡æ–°æåˆ°è¿™äº›å­—æ®µã€‚</p> <ul><li><code>ObjectPool&lt;Entry&gt; RECYCLER</code>ï¼šEntry çš„å¯¹è±¡æ± ï¼Œè´Ÿè´£åˆ›å»ºç®¡ç† Entry å®ä¾‹ï¼Œç”±äº Netty æ˜¯ä¸€ä¸ªç½‘ç»œæ¡†æ¶ï¼Œæ‰€ä»¥ IO è¯»å†™å°±æˆäº†å®ƒçš„æ ¸å¿ƒæ“ä½œï¼Œåœ¨ä¸€ä¸ªæ”¯æŒé«˜æ€§èƒ½é«˜ååçš„ç½‘ç»œæ¡†æ¶ä¸­ï¼Œä¼šæœ‰å¤§é‡çš„ IO è¯»å†™æ“ä½œï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´é¢‘ç¹çš„åˆ›å»º Entry å¯¹è±¡ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œåˆ›å»ºä¸€ä¸ªå®ä¾‹å¯¹è±¡ä»¥åŠ GC å›æ”¶è¿™äº›å®ä¾‹å¯¹è±¡éƒ½æ˜¯éœ€è¦æ€§èƒ½å¼€é”€çš„ï¼Œé‚£ä¹ˆåœ¨å¤§é‡é¢‘ç¹åˆ›å»º Entry å¯¹è±¡çš„åœºæ™¯ä¸‹ï¼Œå¼•å…¥å¯¹è±¡æ± æ¥å¤ç”¨åˆ›å»ºå¥½çš„ Entry å¯¹è±¡å®ä¾‹å¯ä»¥æŠµæ¶ˆæ‰ç”±é¢‘ç¹åˆ›å»ºå¯¹è±¡ä»¥åŠGCå›æ”¶å¯¹è±¡æ‰€å¸¦æ¥çš„æ€§èƒ½å¼€é”€ã€‚</li></ul> <blockquote><p>å…³äºå¯¹è±¡æ± çš„è¯¦ç»†å†…å®¹ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å›çœ‹ä¸‹ç¬”è€…çš„è¿™ç¯‡æ–‡ç« <a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484419&amp;idx=1&amp;sn=3a75a495f0f117cca1548da1e0f3e6e6&amp;chksm=ce77c244f9004b52d74b8ffce149ea64e5a8f0ba6713b105d003fdaef8eaa9ad3a5a65d20427&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€Šè¯¦è§£Recyclerå¯¹è±¡æ± çš„ç²¾å¦™è®¾è®¡ä¸å®ç°ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <ul><li><p><code>Handle&lt;Entry&gt; handle</code>ï¼šé»˜è®¤å®ç°ç±»å‹ä¸º DefaultHandle ï¼Œç”¨äºæ•°æ®å‘é€å®Œæ¯•åï¼Œå¯¹è±¡æ± å›æ”¶ Entry å¯¹è±¡ã€‚ç”±å¯¹è±¡æ±  RECYCLER åœ¨åˆ›å»º Entry å¯¹è±¡çš„æ—¶å€™ä¼ é€’è¿›æ¥ã€‚</p></li> <li><p><code>Entry next</code>ï¼šChannelOutboundBuffer æ˜¯ä¸€ä¸ªå•é“¾è¡¨çš„ç»“æ„ï¼Œè¿™é‡Œçš„ next æŒ‡é’ˆç”¨äºæŒ‡å‘å½“å‰ Entry èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ã€‚</p></li> <li><p><code>Object msg</code>ï¼šåº”ç”¨ç¨‹åºå¾…å‘é€çš„ç½‘ç»œæ•°æ®ï¼Œè¿™é‡Œ msg çš„ç±»å‹ä¸º DirectByteBuffer æˆ–è€… FileRegionï¼ˆç”¨äºé€šè¿‡é›¶æ‹·è´çš„æ–¹å¼ç½‘ç»œä¼ è¾“æ–‡ä»¶ï¼‰ã€‚</p></li> <li><p><code>ByteBuffer[] bufs</code>ï¼šè¿™é‡Œçš„ ByteBuffer ç±»å‹ä¸º JDK NIO åŸç”Ÿçš„ ByteBuffer ç±»å‹ï¼Œå› ä¸º Netty æœ€ç»ˆå‘é€æ•°æ®æ˜¯é€šè¿‡ JDK NIO åº•å±‚çš„ SocketChannel è¿›è¡Œå‘é€ï¼Œæ‰€ä»¥éœ€è¦å°† Netty ä¸­å®ç°çš„ ByteBuffer ç±»å‹è½¬æ¢ä¸º JDK NIO ByteBuffer ç±»å‹ã€‚åº”ç”¨ç¨‹åºå‘é€çš„ ByteBuffer å¯èƒ½æ˜¯ä¸€ä¸ªä¹Ÿå¯èƒ½æ˜¯å¤šä¸ªï¼Œå¦‚æœå‘é€å¤šä¸ªå°±ç”¨ ByteBuffer[] bufs å°è£…åœ¨ Entry å¯¹è±¡ä¸­ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªå°±ç”¨ ByteBuffer buf å°è£…ã€‚</p></li> <li><p><code>int count</code>ï¼šè¡¨ç¤ºå¾…å‘é€æ•°æ® msg ä¸­ä¸€å…±åŒ…å«äº†å¤šå°‘ä¸ª ByteBuffer éœ€è¦å‘é€ã€‚</p></li> <li><p><code>ChannelPromise promise</code>ï¼šChannelHandlerContext#write å¼‚æ­¥å†™æ“ä½œè¿”å›çš„ ChannelFutureã€‚å½“ Netty å°†å¾…å‘é€æ•°æ®å†™å…¥åˆ° Socket ä¸­æ—¶ä¼šé€šè¿‡è¿™ä¸ª ChannelPromise é€šçŸ¥åº”ç”¨ç¨‹åºå‘é€ç»“æœã€‚</p></li> <li><p><code>long progress</code>ï¼šè¡¨ç¤ºå½“å‰çš„ä¸€ä¸ªå‘é€è¿›åº¦ï¼Œå·²ç»å‘é€äº†å¤šå°‘æ•°æ®ã€‚</p></li> <li><p><code>long total</code>ï¼šEntryä¸­æ€»å…±éœ€è¦å‘é€å¤šå°‘æ•°æ®ã€‚æ³¨æ„ï¼šè¿™ä¸ªå­—æ®µå¹¶ä¸åŒ…å« Entry å¯¹è±¡çš„å†…å­˜å ç”¨å¤§å°ã€‚åªæ˜¯è¡¨ç¤ºå¾…å‘é€ç½‘ç»œæ•°æ®çš„å¤§å°ã€‚</p></li> <li><p><code>boolean cancelled</code>ï¼šåº”ç”¨ç¨‹åºè°ƒç”¨çš„ write æ“ä½œæ˜¯å¦è¢«å–æ¶ˆã€‚</p></li> <li><p><code>int pendingSize</code>ï¼šè¡¨ç¤ºå¾…å‘é€æ•°æ®çš„å†…å­˜å ç”¨æ€»é‡ã€‚å¾…å‘é€æ•°æ®åœ¨å†…å­˜ä¸­çš„å ç”¨é‡åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p></li> <li><ul><li>Entryå¯¹è±¡ä¸­æ‰€å°è£…çš„å¾…å‘é€ç½‘ç»œæ•°æ®å¤§å°ã€‚</li> <li>Entryå¯¹è±¡æœ¬èº«åœ¨å†…å­˜ä¸­çš„å ç”¨é‡ã€‚</li></ul></li></ul> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191113752.png" alt="å›¾ç‰‡">Entryå†…å­˜å ç”¨æ€»é‡.png</p> <h3 id="_3-3-2-pendingsizeçš„ä½œç”¨"><a href="#_3-3-2-pendingsizeçš„ä½œç”¨" class="header-anchor">#</a> 3.3.2 pendingSizeçš„ä½œç”¨</h3> <p>æƒ³è±¡ä¸€ä¸‹è¿™æ ·çš„ä¸€ä¸ªåœºæ™¯ï¼Œå½“ç”±äºç½‘ç»œæ‹¥å¡æˆ–è€… Netty å®¢æˆ·ç«¯è´Ÿè½½å¾ˆé«˜å¯¼è‡´ç½‘ç»œæ•°æ®çš„æ¥æ”¶é€Ÿåº¦ä»¥åŠå¤„ç†é€Ÿåº¦è¶Šæ¥è¶Šæ…¢ï¼ŒTCP çš„æ»‘åŠ¨çª—å£ä¸æ–­ç¼©å°ä»¥å‡å°‘ç½‘ç»œæ•°æ®çš„å‘é€ç›´åˆ°ä¸º 0ï¼Œè€Œ Netty æœåŠ¡ç«¯å´æœ‰å¤§é‡é¢‘ç¹çš„å†™æ“ä½œï¼Œä¸æ–­çš„å†™å…¥åˆ° ChannelOutboundBuffer ä¸­ã€‚</p> <p>è¿™æ ·å°±å¯¼è‡´äº†æ•°æ®å‘é€ä¸å‡ºå»ä½†æ˜¯ Netty æœåŠ¡ç«¯åˆåœ¨ä¸åœçš„å†™æ•°æ®ï¼Œæ…¢æ…¢çš„å°±ä¼šæ’‘çˆ† ChannelOutboundBuffer å¯¼è‡´OOMã€‚è¿™é‡Œä¸»è¦æŒ‡çš„æ˜¯å †å¤–å†…å­˜çš„ OOMï¼Œå› ä¸º ChannelOutboundBuffer ä¸­åŒ…è£¹çš„å¾…å‘é€æ•°æ®å…¨éƒ¨å­˜å‚¨åœ¨å †å¤–å†…å­˜ä¸­ã€‚</p> <p>æ‰€ä»¥ Netty å°±å¿…é¡»é™åˆ¶ ChannelOutboundBuffer ä¸­çš„å¾…å‘é€æ•°æ®çš„å†…å­˜å ç”¨æ€»é‡ï¼Œä¸èƒ½è®©å®ƒæ— é™å¢é•¿ã€‚Netty ä¸­å®šä¹‰äº†é«˜ä½æ°´ä½çº¿ç”¨æ¥è¡¨ç¤º ChannelOutboundBuffer ä¸­çš„å¾…å‘é€æ•°æ®çš„å†…å­˜å ç”¨é‡çš„ä¸Šé™å’Œä¸‹é™ã€‚æ³¨æ„ï¼šè¿™é‡Œçš„å†…å­˜æ—¢åŒ…æ‹¬ JVM å †å†…å­˜å ç”¨ä¹ŸåŒ…æ‹¬å †å¤–å†…å­˜å ç”¨ã€‚</p> <ul><li>å½“å¾…å‘é€æ•°æ®çš„å†…å­˜å ç”¨æ€»é‡è¶…è¿‡é«˜æ°´ä½çº¿çš„æ—¶å€™ï¼ŒNetty å°±ä¼šå°† NioSocketChannel çš„çŠ¶æ€æ ‡è®°ä¸ºä¸å¯å†™çŠ¶æ€ã€‚å¦åˆ™å°±å¯èƒ½å¯¼è‡´ OOMã€‚</li> <li>å½“å¾…å‘é€æ•°æ®çš„å†…å­˜å ç”¨æ€»é‡ä½äºä½æ°´ä½çº¿çš„æ—¶å€™ï¼ŒNetty ä¼šå†æ¬¡å°† NioSocketChannel çš„çŠ¶æ€æ ‡è®°ä¸ºå¯å†™çŠ¶æ€ã€‚</li></ul> <p><strong>é‚£ä¹ˆæˆ‘ä»¬ç”¨ä»€ä¹ˆè®°å½•ChannelOutboundBufferä¸­çš„å¾…å‘é€æ•°æ®çš„å†…å­˜å ç”¨æ€»é‡å‘¢</strong>ï¼Ÿ</p> <p>ç­”æ¡ˆå°±æ˜¯æœ¬å°èŠ‚è¦ä»‹ç»çš„ pendingSize å­—æ®µã€‚<strong>åœ¨è°ˆåˆ°å¾…å‘é€æ•°æ®çš„å†…å­˜å ç”¨é‡æ—¶å¤§éƒ¨åˆ†åŒå­¦æ™®ééƒ½ä¼šæœ‰ä¸€ä¸ªè¯¯è§£å°±æ˜¯åªè®¡ç®—å¾…å‘é€æ•°æ®çš„å¤§å°ï¼ˆmsgä¸­åŒ…å«çš„å­—èŠ‚æ•°ï¼‰</strong> è€Œå¿½ç•¥äº† Entry å®ä¾‹å¯¹è±¡æœ¬èº«åœ¨å†…å­˜ä¸­çš„å ç”¨é‡ã€‚</p> <p>å› ä¸º Netty ä¼šå°†å¾…å‘é€æ•°æ®å°è£…åœ¨ Entry å®ä¾‹å¯¹è±¡ä¸­ï¼Œåœ¨å¤§é‡é¢‘ç¹çš„å†™æ“ä½œä¸­ä¼šäº§ç”Ÿå¤§é‡çš„ Entry å®ä¾‹å¯¹è±¡ï¼Œæ‰€ä»¥ Entry å®ä¾‹å¯¹è±¡çš„å†…å­˜å ç”¨æ˜¯ä¸å¯å¿½è§†çš„ã€‚</p> <p>å¦åˆ™å°±ä¼šå¯¼è‡´æ˜æ˜è¿˜æ²¡æœ‰åˆ°è¾¾é«˜æ°´ä½çº¿ï¼Œä½†æ˜¯ç”±äºå¤§é‡çš„ Entry å®ä¾‹å¯¹è±¡å­˜åœ¨ï¼Œä»è€Œå‘ç”ŸOOMã€‚</p> <p>æ‰€ä»¥ pendingSize çš„è®¡ç®—æ—¢è¦åŒ…å«å¾…å‘é€æ•°æ®çš„å¤§å°ä¹Ÿè¦åŒ…å«å…¶ Entry å®ä¾‹å¯¹è±¡çš„å†…å­˜å ç”¨å¤§å°ï¼Œè¿™æ ·æ‰èƒ½å‡†ç¡®è®¡ç®—å‡º ChannelOutboundBuffer ä¸­å¾…å‘é€æ•°æ®çš„å†…å­˜å ç”¨æ€»é‡ã€‚</p> <p>ChannelOutboundBuffer ä¸­æ‰€æœ‰çš„ Entry å®ä¾‹ä¸­çš„ pendingSize ä¹‹å’Œå°±æ˜¯å¾…å‘é€æ•°æ®æ€»çš„å†…å­˜å ç”¨é‡ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public final class ChannelOutboundBuffer {
  //ChannelOutboundBufferä¸­çš„å¾…å‘é€æ•°æ®çš„å†…å­˜å ç”¨æ€»é‡
  private volatile long totalPendingSize;

}
</code></pre></div><h3 id="_3-3-3-é«˜ä½æ°´ä½çº¿"><a href="#_3-3-3-é«˜ä½æ°´ä½çº¿" class="header-anchor">#</a> 3.3.3 é«˜ä½æ°´ä½çº¿</h3> <p>ä¸Šå°èŠ‚æåˆ° Netty ä¸ºäº†é˜²æ­¢ ChannelOutboundBuffer ä¸­çš„å¾…å‘é€æ•°æ®å†…å­˜å ç”¨æ— é™åˆ¶çš„å¢é•¿ä»è€Œå¯¼è‡´ OOM ï¼Œæ‰€ä»¥å¼•å…¥äº†é«˜ä½æ°´ä½çº¿ï¼Œä½œä¸ºå¾…å‘é€æ•°æ®å†…å­˜å ç”¨çš„ä¸Šé™å’Œä¸‹é™ã€‚</p> <p><strong>é‚£ä¹ˆé«˜ä½æ°´ä½çº¿å…·ä½“è®¾ç½®å¤šå¤§å‘¢</strong> ? æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ DefaultChannelConfig ä¸­çš„é…ç½®ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class DefaultChannelConfig implements ChannelConfig {

    //ChannelOutboundBufferä¸­çš„é«˜ä½æ°´ä½çº¿
    private volatile WriteBufferWaterMark writeBufferWaterMark = WriteBufferWaterMark.DEFAULT;

}
public final class WriteBufferWaterMark {

    private static final int DEFAULT_LOW_WATER_MARK = 32 * 1024;
    private static final int DEFAULT_HIGH_WATER_MARK = 64 * 1024;

    public static final WriteBufferWaterMark DEFAULT =
            new WriteBufferWaterMark(DEFAULT_LOW_WATER_MARK, DEFAULT_HIGH_WATER_MARK, false);

    WriteBufferWaterMark(int low, int high, boolean validate) {

        ..........çœç•¥æ ¡éªŒé€»è¾‘.........

        this.low = low;
        this.high = high;
    }
}
</code></pre></div><p>æˆ‘ä»¬çœ‹åˆ° ChannelOutboundBuffer ä¸­çš„é«˜æ°´ä½çº¿è®¾ç½®çš„å¤§å°ä¸º 64 KBï¼Œä½æ°´ä½çº¿è®¾ç½®çš„æ˜¯ 32 KBã€‚</p> <p>è¿™ä¹Ÿå°±æ„å‘³ç€æ¯ä¸ª Channel ä¸­çš„å¾…å‘é€æ•°æ®å¦‚æœè¶…è¿‡ 64 KBã€‚Channel çš„çŠ¶æ€å°±ä¼šå˜ä¸ºä¸å¯å†™çŠ¶æ€ã€‚å½“å†…å­˜å ç”¨é‡ä½äº 32 KBæ—¶ï¼ŒChannel çš„çŠ¶æ€ä¼šå†æ¬¡å˜ä¸ºå¯å†™çŠ¶æ€ã€‚</p> <h3 id="_3-3-4-entryå®ä¾‹å¯¹è±¡åœ¨jvmä¸­å ç”¨å†…å­˜å¤§å°"><a href="#_3-3-4-entryå®ä¾‹å¯¹è±¡åœ¨jvmä¸­å ç”¨å†…å­˜å¤§å°" class="header-anchor">#</a> 3.3.4 Entryå®ä¾‹å¯¹è±¡åœ¨JVMä¸­å ç”¨å†…å­˜å¤§å°</h3> <p>å‰è¾¹æåˆ° pendingSize çš„ä½œç”¨ä¸»è¦æ˜¯è®°å½•å½“å‰å¾…å‘é€æ•°æ®çš„å†…å­˜å ç”¨æ€»é‡ä»è€Œå¯ä»¥é¢„è­¦ OOM çš„å‘ç”Ÿã€‚</p> <p>å¾…å‘é€æ•°æ®çš„å†…å­˜å ç”¨åˆ†ä¸ºï¼šå¾…å‘é€æ•°æ® msg çš„å†…å­˜å ç”¨å¤§å°ä»¥åŠ Entry å¯¹è±¡æœ¬èº«åœ¨JVMä¸­çš„å†…å­˜å ç”¨ã€‚</p> <p>é‚£ä¹ˆ Entry å¯¹è±¡æœ¬èº«çš„å†…å­˜å ç”¨æˆ‘ä»¬è¯¥å¦‚ä½•è®¡ç®—å‘¢ï¼Ÿ</p> <p>è¦æƒ³ææ¸…æ¥šè¿™ä¸ªé—®é¢˜ï¼Œå¤§å®¶éœ€è¦å…ˆäº†è§£ä¸€ä¸‹ Java å¯¹è±¡å†…å­˜å¸ƒå±€çš„ç›¸å…³çŸ¥è¯†ã€‚å…³äºè¿™éƒ¨åˆ†èƒŒæ™¯çŸ¥è¯†ï¼Œç¬”è€…å·²ç»åœ¨ <a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484304&amp;idx=1&amp;sn=54bf0d07e69c5621c145afaece8f50d6&amp;chksm=ce77c5d7f9004cc1249a03dfd0fb12b7d75171f1b87acea1fa44bbb11ca374b6f42a66fa274d&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€Šä¸€æ–‡èŠé€å¯¹è±¡åœ¨JVMä¸­çš„å†…å­˜å¸ƒå±€ï¼Œä»¥åŠå†…å­˜å¯¹é½å’Œå‹ç¼©æŒ‡é’ˆçš„åŸç†åŠåº”ç”¨ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>è¿™ç¯‡æ–‡ç« ä¸­ç»™å‡ºäº†è¯¦å°½çš„é˜è¿°ï¼Œæƒ³æ·±å…¥äº†è§£è¿™å—çš„åŒå­¦å¯ä»¥çœ‹ä¸‹è¿™ç¯‡æ–‡ç« ã€‚</p> <p>è¿™é‡Œç¬”è€…åªä»è¿™ç¯‡æ–‡ç« ä¸­æç‚¼ä¸€äº›å…³äºè®¡ç®— Java å¯¹è±¡å ç”¨å†…å­˜å¤§å°ç›¸å…³çš„å†…å®¹ã€‚</p> <p>åœ¨å…³äº Java å¯¹è±¡å†…å­˜å¸ƒå±€è¿™ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬æåˆ°ï¼Œå¯¹äºJavaæ™®é€šå¯¹è±¡æ¥è¯´å†…å­˜ä¸­çš„å¸ƒå±€ç”±ï¼š<code>å¯¹è±¡å¤´ + å®ä¾‹æ•°æ®åŒº + Padding</code>ï¼Œè¿™ä¸‰éƒ¨åˆ†ç»„æˆã€‚</p> <p>å…¶ä¸­å¯¹è±¡å¤´ç”±å­˜å‚¨å¯¹è±¡è¿è¡Œæ—¶ä¿¡æ¯çš„ MarkWord ä»¥åŠæŒ‡å‘å¯¹è±¡ç±»å‹å…ƒä¿¡æ¯çš„ç±»å‹æŒ‡é’ˆç»„æˆã€‚</p> <blockquote><p>MarkWord ç”¨æ¥å­˜æ”¾ï¼šhashcodeï¼ŒGC åˆ†ä»£å¹´é¾„ï¼Œé”çŠ¶æ€æ ‡å¿—ï¼Œçº¿ç¨‹æŒæœ‰çš„é”ï¼Œåå‘çº¿ç¨‹ Idï¼Œåå‘æ—¶é—´æˆ³ç­‰ã€‚åœ¨ 32 ä½æ“ä½œç³»ç»Ÿå’Œ 64 ä½æ“ä½œç³»ç»Ÿä¸­ MarkWord åˆ†åˆ«å ç”¨ 4B å’Œ 8B å¤§å°çš„å†…å­˜ã€‚</p></blockquote> <blockquote><p>Java å¯¹è±¡å¤´ä¸­çš„ç±»å‹æŒ‡é’ˆè¿˜æœ‰å®ä¾‹æ•°æ®åŒºçš„å¯¹è±¡å¼•ç”¨ï¼Œåœ¨64 ä½ç³»ç»Ÿä¸­å¼€å¯å‹ç¼©æŒ‡é’ˆçš„æƒ…å†µä¸‹ï¼ˆ-XX:+UseCompressedOopsï¼‰å ç”¨ 4B å¤§å°ã€‚åœ¨å…³é—­å‹ç¼©æŒ‡é’ˆçš„æƒ…å†µä¸‹ï¼ˆ-XX:-UseCompressedOopsï¼‰å ç”¨ 8B å¤§å°ã€‚</p></blockquote> <p>å®ä¾‹æ•°æ®åŒºç”¨äºå­˜å‚¨ Java ç±»ä¸­å®šä¹‰çš„å®ä¾‹å­—æ®µï¼ŒåŒ…æ‹¬æ‰€æœ‰çˆ¶ç±»ä¸­çš„å®ä¾‹å­—æ®µä»¥åŠå¯¹è±¡å¼•ç”¨ã€‚</p> <p>åœ¨å®ä¾‹æ•°æ®åŒºä¸­å¯¹è±¡å­—æ®µä¹‹é—´çš„æ’åˆ—ä»¥åŠå†…å­˜å¯¹é½éœ€è¦éµå¾ªä¸‰ä¸ªå­—æ®µé‡æ’åˆ—è§„åˆ™ï¼š</p> <ul><li><code>è§„åˆ™1</code>ï¼šå¦‚æœä¸€ä¸ªå­—æ®µå ç”¨<code>X</code>ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆè¿™ä¸ªå­—æ®µçš„åç§»é‡OFFSETéœ€è¦å¯¹é½è‡³<code>NX</code>ã€‚</li> <li><code>è§„åˆ™2</code>ï¼šåœ¨å¼€å¯äº†å‹ç¼©æŒ‡é’ˆçš„ 64 ä½ JVM ä¸­ï¼ŒJava ç±»ä¸­çš„ç¬¬ä¸€ä¸ªå­—æ®µçš„ OFFSET éœ€è¦å¯¹é½è‡³ <code>4N</code>ï¼Œåœ¨å…³é—­å‹ç¼©æŒ‡é’ˆçš„æƒ…å†µä¸‹ç±»ä¸­ç¬¬ä¸€ä¸ªå­—æ®µçš„OFFSETéœ€è¦å¯¹é½è‡³ <code>8N</code>ã€‚</li> <li><code>è§„åˆ™3</code>ï¼šJVM é»˜è®¤åˆ†é…å­—æ®µçš„é¡ºåºä¸ºï¼šlong / doubleï¼Œint / floatï¼Œshort / charï¼Œbyte / booleanï¼Œoops(Ordianry Object Point å¼•ç”¨ç±»å‹æŒ‡é’ˆ)ï¼Œå¹¶ä¸”çˆ¶ç±»ä¸­å®šä¹‰çš„å®ä¾‹å˜é‡ä¼šå‡ºç°åœ¨å­ç±»å®ä¾‹å˜é‡ä¹‹å‰ã€‚å½“è®¾ç½®JVMå‚æ•° <code>-XX +CompactFields</code> æ—¶ï¼ˆé»˜è®¤ï¼‰ï¼Œå ç”¨å†…å­˜å°äº long / double çš„å­—æ®µä¼šå…è®¸è¢«æ’å…¥åˆ°å¯¹è±¡ä¸­ç¬¬ä¸€ä¸ª long / double å­—æ®µä¹‹å‰çš„é—´éš™ä¸­ï¼Œä»¥é¿å…ä¸å¿…è¦çš„å†…å­˜å¡«å……ã€‚</li></ul> <p>è¿˜æœ‰ä¸€ä¸ªé‡è¦è§„åˆ™å°±æ˜¯ Java è™šæ‹Ÿæœºå †ä¸­å¯¹è±¡çš„èµ·å§‹åœ°å€éœ€è¦å¯¹é½è‡³ 8 çš„å€æ•°ï¼ˆå¯ç”±JVMå‚æ•° -XX:ObjectAlignmentInBytes æ§åˆ¶ï¼Œé»˜è®¤ä¸º 8 ï¼‰ã€‚</p> <p>åœ¨äº†è§£ä¸Šè¿°å­—æ®µæ’åˆ—ä»¥åŠå¯¹è±¡ä¹‹é—´çš„å†…å­˜å¯¹é½è§„åˆ™åï¼Œæˆ‘ä»¬åˆ†åˆ«ä»¥å¼€å¯å‹ç¼©æŒ‡é’ˆå’Œå…³é—­å‹ç¼©æŒ‡é’ˆä¸¤ç§æƒ…å†µï¼Œæ¥å¯¹ Entry å¯¹è±¡çš„å†…å­˜å¸ƒå±€è¿›è¡Œåˆ†æå¹¶è®¡ç®—å¯¹è±¡å ç”¨å†…å­˜å¤§å°ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>   static final class Entry {
        .............çœç•¥staticå­—æ®µRECYCLER.........

        //DefaultHandleç”¨äºå›æ”¶å¯¹è±¡
        private final Handle&lt;Entry&gt; handle;
        //ChannelOutboundBufferä¸‹ä¸€ä¸ªèŠ‚ç‚¹
        Entry next;
        //å¾…å‘é€æ•°æ®
        Object msg;
        //msg è½¬æ¢ä¸º jdk nio ä¸­çš„byteBuffer
        ByteBuffer[] bufs;
        ByteBuffer buf;
        //å¼‚æ­¥writeæ“ä½œçš„future
        ChannelPromise promise;
        //å·²å‘é€äº†å¤šå°‘
        long progress;
        //æ€»å…±éœ€è¦å‘é€å¤šå°‘ï¼Œä¸åŒ…å«entryå¯¹è±¡å¤§å°ã€‚
        long total;
        //pendingSizeè¡¨ç¤ºentryå¯¹è±¡åœ¨å †ä¸­éœ€è¦çš„å†…å­˜æ€»é‡ å¾…å‘é€æ•°æ®å¤§å° + entryå¯¹è±¡æœ¬èº«åœ¨å †ä¸­å ç”¨å†…å­˜å¤§å°ï¼ˆ96ï¼‰
        int pendingSize;
        //msgä¸­åŒ…å«äº†å‡ ä¸ªjdk nio bytebuffer
        int count = -1;
        //writeæ“ä½œæ˜¯å¦è¢«å–æ¶ˆ
        boolean cancelled;
}
</code></pre></div><p>æˆ‘ä»¬çœ‹åˆ° Entry å¯¹è±¡ä¸­ä¸€å…±æœ‰ 11 ä¸ªå®ä¾‹å­—æ®µï¼Œå…¶ä¸­ 2 ä¸ª long å‹å­—æ®µï¼Œ2 ä¸ª int å‹å­—æ®µï¼Œ1 ä¸ª boolean å‹å­—æ®µï¼Œ6 ä¸ªå¯¹è±¡å¼•ç”¨ã€‚</p> <p>é»˜è®¤æƒ…å†µä¸‹JVMå‚æ•° <code>-XX +CompactFields</code> æ˜¯å¼€å¯çš„ã€‚</p> <h4 id="å¼€å¯æŒ‡é’ˆå‹ç¼©-xx-usecompressedoops"><a href="#å¼€å¯æŒ‡é’ˆå‹ç¼©-xx-usecompressedoops" class="header-anchor">#</a> å¼€å¯æŒ‡é’ˆå‹ç¼© -XX:+UseCompressedOops</h4> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191114206.png" alt="å›¾ç‰‡">image.png</p> <p>Entry å¯¹è±¡çš„å†…å­˜å¸ƒå±€ä¸­å¼€å¤´å…ˆæ˜¯ 8 ä¸ªå­—èŠ‚çš„ MarkWordï¼Œç„¶åæ˜¯ 4 ä¸ªå­—èŠ‚çš„ç±»å‹æŒ‡é’ˆï¼ˆå¼€å¯å‹ç¼©æŒ‡é’ˆï¼‰ã€‚</p> <p>åœ¨å®ä¾‹æ•°æ®åŒºä¸­å¯¹è±¡çš„æ’åˆ—è§„åˆ™éœ€è¦ç¬¦åˆè§„åˆ™3ï¼Œä¹Ÿå°±æ˜¯å­—æ®µä¹‹é—´çš„æ’åˆ—é¡ºåºéœ€è¦éµå¾ª <code>long &gt; int &gt; boolean &gt; oop(å¯¹è±¡å¼•ç”¨)</code>ã€‚</p> <p>æ ¹æ®è§„åˆ™ 3 Entryå¯¹è±¡å®ä¾‹æ•°æ®åŒºç¬¬ä¸€ä¸ªå­—æ®µåº”è¯¥æ˜¯ long progressï¼Œä½†æ ¹æ®è§„åˆ™1 long å‹å­—æ®µçš„ OFFSET éœ€è¦å¯¹é½è‡³ 8 çš„å€æ•°ï¼Œå¹¶ä¸”æ ¹æ® è§„åˆ™2 åœ¨å¼€å¯å‹ç¼©æŒ‡é’ˆçš„æƒ…å†µä¸‹ï¼Œå¯¹è±¡çš„ç¬¬ä¸€ä¸ªå­—æ®µ OFFSET éœ€è¦å¯¹é½è‡³ 4 çš„å€æ•°ã€‚æ‰€ä»¥å­—æ®µlong progress çš„ OFFET  = 16ï¼Œè¿™å°±å¿…ç„¶å¯¼è‡´äº†åœ¨å¯¹è±¡å¤´ä¸å­—æ®µ long progress ä¹‹é—´éœ€è¦ç”± 4 å­—èŠ‚çš„å­—èŠ‚å¡«å……ï¼ˆOFFET = 12å¤„å‘ç”Ÿå­—èŠ‚å¡«å……ï¼‰ã€‚</p> <p>ä½†æ˜¯ JVM é»˜è®¤å¼€å¯äº† <code>-XX +CompactFields</code>ï¼Œæ ¹æ® è§„åˆ™3 å ç”¨å†…å­˜å°äº long / double çš„å­—æ®µä¼šå…è®¸è¢«æ’å…¥åˆ°å¯¹è±¡ä¸­ç¬¬ä¸€ä¸ª long / double å­—æ®µä¹‹å‰çš„é—´éš™ä¸­ï¼Œä»¥é¿å…ä¸å¿…è¦çš„å†…å­˜å¡«å……ã€‚</p> <p>æ‰€ä»¥ä½äºåè¾¹çš„å­—æ®µ int pendingSize æ’å…¥åˆ°äº† OFFET = 12 ä½ç½®å¤„ï¼Œé¿å…äº†ä¸å¿…è¦çš„å­—èŠ‚å¡«å……ã€‚</p> <p>åœ¨ Entry å¯¹è±¡çš„å®ä¾‹æ•°æ®åŒºä¸­ç´§æ¥ç€åŸºç¡€ç±»å‹å­—æ®µåé¢è·Ÿç€çš„å°±æ˜¯ 6 ä¸ªå¯¹è±¡å¼•ç”¨å­—æ®µ(å¼€å¯å‹ç¼©æŒ‡é’ˆå ç”¨ 4 ä¸ªå­—èŠ‚)ã€‚</p> <p>å¤§å®¶ä¸€å®šæ³¨æ„åˆ° OFFSET = 37 å¤„æœ¬åº”è¯¥å­˜æ”¾çš„æ˜¯å­—æ®µ <code>private final Handle&lt;Entry&gt; handle</code> ä½†æ˜¯å´è¢«å¡«å……äº† 3 ä¸ªå­—èŠ‚ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p> <p>æ ¹æ®å­—æ®µé‡æ’åˆ—è§„åˆ™1ï¼šå¼•ç”¨å­—æ®µ <code>private final Handle&lt;Entry&gt; handle</code> å ç”¨ 4 ä¸ªå­—èŠ‚ï¼ˆå¼€å¯å‹ç¼©æŒ‡é’ˆçš„æƒ…å†µï¼‰ï¼Œæ‰€ä»¥éœ€è¦å¯¹é½è‡³4çš„å€æ•°ã€‚æ‰€ä»¥éœ€è¦å¡«å……3ä¸ªå­—èŠ‚ï¼Œä½¿å¾—å¼•ç”¨å­—æ®µ <code>private final Handle&lt;Entry&gt; handle</code> ä½äº OFFSET = 40 å¤„ã€‚</p> <p><strong>æ ¹æ®ä»¥ä¸Šè¿™äº›è§„åˆ™æœ€ç»ˆè®¡ç®—å‡ºæ¥åœ¨å¼€å¯å‹ç¼©æŒ‡é’ˆçš„æƒ…å†µä¸‹Entryå¯¹è±¡åœ¨å †ä¸­å ç”¨å†…å­˜å¤§å°ä¸º64å­—èŠ‚</strong></p> <h4 id="å…³é—­æŒ‡é’ˆå‹ç¼©-xx-usecompressedoops"><a href="#å…³é—­æŒ‡é’ˆå‹ç¼©-xx-usecompressedoops" class="header-anchor">#</a> å…³é—­æŒ‡é’ˆå‹ç¼© -XX:-UseCompressedOops</h4> <p>åœ¨åˆ†æå®Œ Entry å¯¹è±¡åœ¨å¼€å¯å‹ç¼©æŒ‡é’ˆæƒ…å†µä¸‹çš„å†…å­˜å¸ƒå±€æƒ…å†µåï¼Œæˆ‘æƒ³å¤§å®¶ç°åœ¨å¯¹å‰è¾¹ä»‹ç»çš„å­—æ®µé‡æ’åˆ—çš„ä¸‰ä¸ªè§„åˆ™ç†è§£æ›´åŠ æ¸…æ™°äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬åŸºäºè¿™ä¸ªåŸºç¡€æ¥åˆ†æä¸‹åœ¨å…³é—­å‹ç¼©æŒ‡é’ˆçš„æƒ…å†µä¸‹ Entry å¯¹è±¡çš„å†…å­˜å¸ƒå±€ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>é¦–å…ˆ Entry å¯¹è±¡åœ¨å†…å­˜å¸ƒå±€ä¸­çš„å¼€å¤´ä¾ç„¶æ˜¯ç”± 8 ä¸ªå­—èŠ‚çš„ MarkWord è¿˜æœ‰ 8 ä¸ªå­—èŠ‚çš„ç±»å‹æŒ‡é’ˆï¼ˆå…³é—­å‹ç¼©æŒ‡é’ˆï¼‰ç»„æˆçš„å¯¹è±¡å¤´ã€‚</p> <p>æˆ‘ä»¬çœ‹åˆ°åœ¨ OFFSET = 41 å¤„å‘ç”Ÿäº†å­—èŠ‚å¡«å……ï¼ŒåŸå› æ˜¯åœ¨å…³é—­å‹ç¼©æŒ‡é’ˆçš„æƒ…å†µä¸‹ï¼Œå¯¹è±¡å¼•ç”¨å ç”¨å†…å­˜å¤§å°å˜ä¸º 8 ä¸ªå­—èŠ‚ï¼Œæ ¹æ®è§„åˆ™1: å¼•ç”¨å­—æ®µ <code>private final Handle&lt;Entry&gt; handle</code> çš„ OFFET éœ€è¦å¯¹é½è‡³ 8 çš„å€æ•°ï¼Œæ‰€ä»¥éœ€è¦åœ¨è¯¥å¼•ç”¨å­—æ®µä¹‹å‰å¡«å…… 7 ä¸ªå­—èŠ‚ï¼Œä½¿å¾—å¼•ç”¨å­—æ®µ <code>private final Handle&lt;Entry&gt; handle</code> çš„OFFET = 48 ã€‚</p> <p><strong>ç»¼åˆå­—æ®µé‡æ’åˆ—çš„ä¸‰ä¸ªè§„åˆ™æœ€ç»ˆè®¡ç®—å‡ºæ¥åœ¨å…³é—­å‹ç¼©æŒ‡é’ˆçš„æƒ…å†µä¸‹Entryå¯¹è±¡åœ¨å †ä¸­å ç”¨å†…å­˜å¤§å°ä¸º96å­—èŠ‚</strong></p> <h3 id="_3-3-5-å‘channeloutboundbufferä¸­ç¼“å­˜å¾…å‘é€æ•°æ®"><a href="#_3-3-5-å‘channeloutboundbufferä¸­ç¼“å­˜å¾…å‘é€æ•°æ®" class="header-anchor">#</a> 3.3.5 å‘ChannelOutboundBufferä¸­ç¼“å­˜å¾…å‘é€æ•°æ®</h3> <p>åœ¨ä»‹ç»å®Œ ChannelOutboundBuffer çš„åŸºæœ¬ç»“æ„ä¹‹åï¼Œä¸‹é¢å°±æ¥åˆ°äº† Netty å¤„ç† write äº‹ä»¶çš„æœ€åä¸€æ­¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ç”¨æˆ·çš„å¾…å‘é€æ•°æ®æ˜¯å¦‚ä½•è¢«æ·»åŠ è¿› ChannelOutboundBuffer ä¸­çš„ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    public void addMessage(Object msg, int size, ChannelPromise promise) {
        Entry entry = Entry.newInstance(msg, size, total(msg), promise);
        if (tailEntry == null) {
            flushedEntry = null;
        } else {
            Entry tail = tailEntry;
            tail.next = entry;
        }
        tailEntry = entry;
        if (unflushedEntry == null) {
            unflushedEntry = entry;
        }

        incrementPendingOutboundBytes(entry.pendingSize, false);
    }
</code></pre></div><h4 id="_3-3-5-1-åˆ›å»ºentryå¯¹è±¡æ¥å°è£…å¾…å‘é€æ•°æ®ä¿¡æ¯"><a href="#_3-3-5-1-åˆ›å»ºentryå¯¹è±¡æ¥å°è£…å¾…å‘é€æ•°æ®ä¿¡æ¯" class="header-anchor">#</a> 3.3.5.1 åˆ›å»ºEntryå¯¹è±¡æ¥å°è£…å¾…å‘é€æ•°æ®ä¿¡æ¯</h4> <p>é€šè¿‡å‰è¾¹çš„ä»‹ç»æˆ‘ä»¬äº†è§£åˆ°å½“ç”¨æˆ·è°ƒç”¨ ctx.write(msg) ä¹‹åï¼Œwrite äº‹ä»¶å¼€å§‹åœ¨pipelineä¸­ä»å½“å‰ ChannelHandlerå¼€å§‹ä¸€ç›´å‘å‰è¿›è¡Œä¼ æ’­ï¼Œæœ€ç»ˆåœ¨ HeadContext ä¸­å°†å¾…å‘é€æ•°æ®å†™å…¥åˆ° channel å¯¹åº”çš„å†™ç¼“å†²åŒº ChannelOutboundBuffer ä¸­ã€‚</p> <p>è€Œ ChannelOutboundBuffer æ˜¯ç”± Entry ç»“æ„ç»„æˆçš„ä¸€ä¸ªå•é“¾è¡¨ï¼ŒEntry ç»“æ„å°è£…äº†ç”¨æˆ·å¾…å‘é€æ•°æ®çš„å„ç§ä¿¡æ¯ã€‚</p> <p>è¿™é‡Œé¦–å…ˆæˆ‘ä»¬éœ€è¦ä¸ºå¾…å‘é€æ•°æ®åˆ›å»º Entry å¯¹è±¡ï¼Œè€Œåœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484419&amp;idx=1&amp;sn=3a75a495f0f117cca1548da1e0f3e6e6&amp;chksm=ce77c244f9004b52d74b8ffce149ea64e5a8f0ba6713b105d003fdaef8eaa9ad3a5a65d20427&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€Šè¯¦è§£Recyclerå¯¹è±¡æ± çš„ç²¾å¦™è®¾è®¡ä¸å®ç°ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸€æ–‡ä¸­æˆ‘ä»¬ä»‹ç»å¯¹è±¡æ± æ—¶ï¼Œæåˆ° Netty ä½œä¸ºä¸€ä¸ªé«˜æ€§èƒ½é«˜ååçš„ç½‘ç»œæ¡†æ¶è¦é¢å¯¹æµ·é‡çš„ IO å¤„ç†æ“ä½œï¼Œè¿™ç§åœºæ™¯ä¸‹ä¼šé¢‘ç¹çš„åˆ›å»ºå¤§é‡çš„ Entry å¯¹è±¡ï¼Œè€Œå¯¹è±¡çš„åˆ›å»ºåŠå…¶å›æ”¶æ—¶éœ€è¦æ€§èƒ½å¼€é”€çš„ï¼Œå°¤å…¶æ˜¯åœ¨é¢å¯¹å¤§é‡é¢‘ç¹çš„åˆ›å»ºå¯¹è±¡åœºæ™¯ä¸‹ï¼Œè¿™ç§å¼€é”€ä¼šè¿›ä¸€æ­¥è¢«æ”¾å¤§ï¼Œæ‰€ä»¥ Netty å¼•å…¥äº†å¯¹è±¡æ± æ¥ç®¡ç† Entry å¯¹è±¡å®ä¾‹ä»è€Œé¿å… Entry å¯¹è±¡é¢‘ç¹åˆ›å»ºä»¥åŠ GC å¸¦æ¥çš„æ€§èƒ½å¼€é”€ã€‚</p> <p>æ—¢ç„¶ Entry å¯¹è±¡å·²ç»è¢«å¯¹è±¡æ± æ¥ç®¡ï¼Œé‚£ä¹ˆå®ƒåœ¨å¯¹è±¡æ± å¤–é¢æ˜¯ä¸èƒ½è¢«ç›´æ¥åˆ›å»ºçš„ï¼Œå…¶æ„é€ å‡½æ•°æ˜¯ç§æœ‰ç±»å‹ï¼Œå¹¶æä¾›ä¸€ä¸ªé™æ€æ–¹æ³• newInstance ä¾›å¤–éƒ¨çº¿ç¨‹ä»å¯¹è±¡æ± ä¸­è·å– Entry å¯¹è±¡ã€‚è¿™åœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484419&amp;idx=1&amp;sn=3a75a495f0f117cca1548da1e0f3e6e6&amp;chksm=ce77c244f9004b52d74b8ffce149ea64e5a8f0ba6713b105d003fdaef8eaa9ad3a5a65d20427&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€Šè¯¦è§£Recyclerå¯¹è±¡æ± çš„ç²¾å¦™è®¾è®¡ä¸å®ç°ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸€æ–‡ä¸­ä»‹ç»æ± åŒ–å¯¹è±¡çš„è®¾è®¡æ—¶ä¹Ÿæœ‰æåˆ°è¿‡ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>   static final class Entry {
        //é™æ€å˜é‡å¼•ç”¨ç±»å‹åœ°å€ è¿™ä¸ªæ˜¯åœ¨Klass Point(ç±»å‹æŒ‡é’ˆ)ä¸­å®šä¹‰ 8å­—èŠ‚ï¼ˆå¼€å¯æŒ‡é’ˆå‹ç¼© ä¸º4å­—èŠ‚ï¼‰
        private static final ObjectPool&lt;Entry&gt; RECYCLER = ObjectPool.newPool(new ObjectCreator&lt;Entry&gt;() {
            @Override
            public Entry newObject(Handle&lt;Entry&gt; handle) {
                return new Entry(handle);
            }
        });

        //Entryå¯¹è±¡åªèƒ½é€šè¿‡å¯¹è±¡æ± è·å–ï¼Œä¸å¯å¤–éƒ¨è‡ªè¡Œåˆ›å»º
        private Entry(Handle&lt;Entry&gt; handle) {
            this.handle = handle;
        }

        //ä¸è€ƒè™‘æŒ‡é’ˆå‹ç¼©çš„å¤§å° entryå¯¹è±¡åœ¨å †ä¸­å ç”¨çš„å†…å­˜å¤§å°ä¸º96
        //å¦‚æœå¼€å¯æŒ‡é’ˆå‹ç¼©ï¼Œentryå¯¹è±¡åœ¨å †ä¸­å ç”¨çš„å†…å­˜å¤§å° ä¼šæ˜¯64  
        static final int CHANNEL_OUTBOUND_BUFFER_ENTRY_OVERHEAD =
            SystemPropertyUtil.getInt(&quot;io.netty.transport.outboundBufferEntrySizeOverhead&quot;, 96);

        static Entry newInstance(Object msg, int size, long total, ChannelPromise promise) {
            Entry entry = RECYCLER.get();
            entry.msg = msg;
            //å¾…å‘æ•°æ®æ•°æ®å¤§å° + entryå¯¹è±¡å¤§å°
            entry.pendingSize = size + CHANNEL_OUTBOUND_BUFFER_ENTRY_OVERHEAD;
            entry.total = total;
            entry.promise = promise;
            return entry;
        }

        .......................çœç•¥................

    }
</code></pre></div><ol><li>é€šè¿‡æ± åŒ–å¯¹è±¡ Entry ä¸­æŒæœ‰çš„å¯¹è±¡æ±  RECYCLER ï¼Œä»å¯¹è±¡æ± ä¸­è·å– Entry å¯¹è±¡å®ä¾‹ã€‚</li> <li>å°†ç”¨æˆ·å¾…å‘é€æ•°æ® msgï¼ˆDirectByteBufferï¼‰ï¼Œå¾…å‘é€æ•°æ®å¤§å°ï¼štotal ï¼Œæœ¬æ¬¡å‘é€æ•°æ®çš„ channelFutureï¼Œä»¥åŠè¯¥ Entry å¯¹è±¡çš„ pendingSize ç»Ÿç»Ÿå°è£…åœ¨ Entry å¯¹è±¡å®ä¾‹çš„ç›¸åº”å­—æ®µä¸­ã€‚</li></ol> <p>è¿™é‡Œéœ€è¦ç‰¹æ®Šè¯´æ˜ä¸€ç‚¹çš„æ˜¯å…³äº pendingSize çš„è®¡ç®—æ–¹å¼ï¼Œä¹‹å‰æˆ‘ä»¬æåˆ° pendingSize ä¸­æ‰€è®¡ç®—çš„å†…å­˜å ç”¨ä¸€å…±åŒ…å«ä¸¤éƒ¨åˆ†ï¼š</p> <ul><li>å¾…å‘é€ç½‘ç»œæ•°æ®å¤§å°</li> <li>Entry å¯¹è±¡æœ¬èº«åœ¨å†…å­˜ä¸­çš„å ç”¨é‡</li></ul> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)Entryå†…å­˜å ç”¨æ€»é‡.png</p> <p>è€Œåœ¨ã€Š3.3.4 Entryå®ä¾‹å¯¹è±¡åœ¨JVMä¸­å ç”¨å†…å­˜å¤§å°ã€‹å°èŠ‚ä¸­æˆ‘ä»¬ä»‹ç»åˆ°ï¼ŒEntry å¯¹è±¡åœ¨å†…å­˜ä¸­çš„å ç”¨å¤§å°åœ¨å¼€å¯å‹ç¼©æŒ‡é’ˆçš„æƒ…å†µä¸‹ï¼ˆ-XX:+UseCompressedOopsï¼‰å ç”¨ 64 å­—èŠ‚ï¼Œåœ¨å…³é—­å‹ç¼©æŒ‡é’ˆçš„æƒ…å†µä¸‹ï¼ˆ-XX:-UseCompressedOopsï¼‰å ç”¨ 96 å­—èŠ‚ã€‚</p> <p>å­—æ®µ <code>CHANNEL_OUTBOUND_BUFFER_ENTRY_OVERHEAD</code> è¡¨ç¤ºçš„å°±æ˜¯ Entry å¯¹è±¡åœ¨å†…å­˜ä¸­çš„å ç”¨å¤§å°ï¼ŒNettyè¿™é‡Œé»˜è®¤æ˜¯ 96 å­—èŠ‚ï¼Œå½“ç„¶å¦‚æœæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå¼€å¯äº†æŒ‡é’ˆå‹ç¼©ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ JVM å¯åŠ¨å‚æ•° <code>-D io.netty.transport.outboundBufferEntrySizeOverhead</code> æŒ‡å®šä¸º 64 å­—èŠ‚ã€‚</p> <h4 id="_3-3-5-2-å°†entryå¯¹è±¡æ·»åŠ è¿›channeloutboundbufferä¸­"><a href="#_3-3-5-2-å°†entryå¯¹è±¡æ·»åŠ è¿›channeloutboundbufferä¸­" class="header-anchor">#</a> 3.3.5.2 å°†Entryå¯¹è±¡æ·»åŠ è¿›ChannelOutboundBufferä¸­</h4> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)ChannelOutboundBufferç»“æ„.png</p> <div class="language- extra-class"><pre class="language-text"><code>       if (tailEntry == null) {
            flushedEntry = null;
        } else {
            Entry tail = tailEntry;
            tail.next = entry;
        }
        tailEntry = entry;
        if (unflushedEntry == null) {
            unflushedEntry = entry;
        }
</code></pre></div><p>åœ¨ã€Š3.3 ChannelOutboundBufferã€‹å°èŠ‚ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬ä»‹ç»äº† ChannelOutboundBuffer ä¸­æœ€é‡è¦çš„ä¸‰ä¸ªæŒ‡é’ˆï¼Œè¿™é‡Œæ¶‰åŠåˆ°çš„ä¸¤ä¸ªæŒ‡é’ˆåˆ†åˆ«æ˜¯ï¼š</p> <ul><li><code>unflushedEntry</code> ï¼šæŒ‡å‘ ChannelOutboundBuffer ä¸­ç¬¬ä¸€ä¸ªæœªè¢« flush è¿› Socket çš„å¾…å‘é€æ•°æ®ã€‚ç”¨æ¥æŒ‡ç¤º ChannelOutboundBuffer çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ã€‚</li> <li><code>tailEntry</code>ï¼šæŒ‡å‘ ChannelOutboundBuffer ä¸­æœ€åä¸€ä¸ªèŠ‚ç‚¹ã€‚</li></ul> <p>é€šè¿‡ unflushedEntry å’Œ tailEntry å¯ä»¥å®šä½å‡ºå¾…å‘é€æ•°æ®çš„èŒƒå›´ã€‚Channel ä¸­çš„æ¯ä¸€æ¬¡ write äº‹ä»¶ï¼Œæœ€ç»ˆéƒ½ä¼šå°†å¾…å‘é€æ•°æ®æ’å…¥åˆ° ChannelOutboundBuffer çš„å°¾ç»“ç‚¹å¤„ã€‚</p> <h4 id="_3-3-5-3-incrementpendingoutboundbytes"><a href="#_3-3-5-3-incrementpendingoutboundbytes" class="header-anchor">#</a> 3.3.5.3 incrementPendingOutboundBytes</h4> <p>åœ¨å°† Entry å¯¹è±¡æ·»åŠ è¿› ChannelOutboundBuffer ä¹‹åï¼Œå°±éœ€è¦æ›´æ–°ç”¨äºè®°å½•å½“å‰ ChannelOutboundBuffer ä¸­å…³äºå¾…å‘é€æ•°æ®æ‰€å å†…å­˜æ€»é‡çš„æ°´ä½çº¿æŒ‡ç¤ºã€‚</p> <p>å¦‚æœæ›´æ–°åçš„æ°´ä½çº¿è¶…è¿‡äº† Netty æŒ‡å®šçš„é«˜æ°´ä½çº¿ <code>DEFAULT_HIGH_WATER_MARK = 64 * 1024</code>ï¼Œåˆ™éœ€è¦å°†å½“å‰ Channel çš„çŠ¶æ€è®¾ç½®ä¸ºä¸å¯å†™ï¼Œå¹¶åœ¨ pipeline ä¸­ä¼ æ’­ ChannelWritabilityChanged äº‹ä»¶ï¼Œæ³¨æ„è¯¥äº‹ä»¶æ˜¯ä¸€ä¸ª inbound äº‹ä»¶ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)å“åº”channelWritabilityChangedäº‹ä»¶.png</p> <div class="language- extra-class"><pre class="language-text"><code>public final class ChannelOutboundBuffer {

   //ChannelOutboundBufferä¸­çš„å¾…å‘é€æ•°æ®çš„å†…å­˜å ç”¨æ€»é‡ : æ‰€æœ‰Entryå¯¹è±¡æœ¬èº«æ‰€å ç”¨å†…å­˜å¤§å° + æ‰€æœ‰å¾…å‘é€æ•°æ®çš„å¤§å°
    private volatile long totalPendingSize;

    //æ°´ä½çº¿æŒ‡é’ˆ
    private static final AtomicLongFieldUpdater&lt;ChannelOutboundBuffer&gt; TOTAL_PENDING_SIZE_UPDATER =
            AtomicLongFieldUpdater.newUpdater(ChannelOutboundBuffer.class, &quot;totalPendingSize&quot;);

    private void incrementPendingOutboundBytes(long size, boolean invokeLater) {
        if (size == 0) {
            return;
        }
        //æ›´æ–°æ€»å…±å¾…å†™å…¥æ•°æ®çš„å¤§å°
        long newWriteBufferSize = TOTAL_PENDING_SIZE_UPDATER.addAndGet(this, size);
        //å¦‚æœå¾…å†™å…¥çš„æ•°æ® å¤§äº é«˜æ°´ä½çº¿ 64 * 1024  åˆ™è®¾ç½®å½“å‰channelä¸ºä¸å¯å†™ ç”±ç”¨æˆ·è‡ªå·±å†³å®šæ˜¯å¦ç»§ç»­å†™å…¥
        if (newWriteBufferSize &gt; channel.config().getWriteBufferHighWaterMark()) {
            //è®¾ç½®å½“å‰channelçŠ¶æ€ä¸ºä¸å¯å†™ï¼Œå¹¶è§¦å‘fireChannelWritabilityChangedäº‹ä»¶
            setUnwritable(invokeLater);
        }
    }

}
</code></pre></div><blockquote><p>volatile å…³é”®å­—åœ¨ Java å†…å­˜æ¨¡å‹ä¸­åªèƒ½ä¿è¯å˜é‡çš„å¯è§æ€§ï¼Œä»¥åŠç¦æ­¢æŒ‡ä»¤é‡æ’åºã€‚ä½†æ— æ³•ä¿è¯å¤šçº¿ç¨‹æ›´æ–°çš„åŸå­æ€§ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥é€šè¿‡AtomicLongFieldUpdater æ¥å¸®åŠ© totalPendingSize å­—æ®µå®ç°åŸå­æ€§çš„æ›´æ–°ã€‚</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>    // 0è¡¨ç¤ºchannelå¯å†™ï¼Œ1è¡¨ç¤ºchannelä¸å¯å†™
    private volatile int unwritable;

    private static final AtomicIntegerFieldUpdater&lt;ChannelOutboundBuffer&gt; UNWRITABLE_UPDATER =
            AtomicIntegerFieldUpdater.newUpdater(ChannelOutboundBuffer.class, &quot;unwritable&quot;);

    private void setUnwritable(boolean invokeLater) {
        for (;;) {
            final int oldValue = unwritable;
            final int newValue = oldValue | 1;
            if (UNWRITABLE_UPDATER.compareAndSet(this, oldValue, newValue)) {
                if (oldValue == 0) {
                    //è§¦å‘fireChannelWritabilityChangedäº‹ä»¶ è¡¨ç¤ºå½“å‰channelå˜ä¸ºä¸å¯å†™
                    fireChannelWritabilityChanged(invokeLater);
                }
                break;
            }
        }
    }
</code></pre></div><p>å½“ ChannelOutboundBuffer ä¸­çš„å†…å­˜å ç”¨æ°´ä½çº¿ totalPendingSize å·²ç»è¶…è¿‡é«˜æ°´ä½çº¿æ—¶ï¼Œè°ƒç”¨è¯¥æ–¹æ³•å°†å½“å‰ Channel çš„çŠ¶æ€è®¾ç½®ä¸ºä¸å¯å†™çŠ¶æ€ã€‚</p> <blockquote><p>unwritable == 0 è¡¨ç¤ºå½“å‰channelå¯å†™ï¼Œunwritable == 1 è¡¨ç¤ºå½“å‰channelä¸å¯å†™ã€‚</p></blockquote> <p>channel å¯ä»¥é€šè¿‡è°ƒç”¨ isWritable æ–¹æ³•æ¥åˆ¤æ–­è‡ªèº«å½“å‰çŠ¶æ€æ˜¯å¦å¯å†™ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    public boolean isWritable() {
        return unwritable == 0;
    }
</code></pre></div><p>å½“ Channel çš„çŠ¶æ€æ˜¯é¦–æ¬¡ä»å¯å†™çŠ¶æ€å˜ä¸ºä¸å¯å†™çŠ¶æ€æ—¶ï¼Œå°±ä¼šåœ¨ channel å¯¹åº”çš„ pipeline ä¸­ä¼ æ’­ ChannelWritabilityChanged äº‹ä»¶ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private void fireChannelWritabilityChanged(boolean invokeLater) {
        final ChannelPipeline pipeline = channel.pipeline();
        if (invokeLater) {
            Runnable task = fireChannelWritabilityChangedTask;
            if (task == null) {
                fireChannelWritabilityChangedTask = task = new Runnable() {
                    @Override
                    public void run() {
                        pipeline.fireChannelWritabilityChanged();
                    }
                };
            }
            channel.eventLoop().execute(task);
        } else {
            pipeline.fireChannelWritabilityChanged();
        }
    }
</code></pre></div><p>ç”¨æˆ·å¯ä»¥åœ¨è‡ªå®šä¹‰çš„ ChannelHandler ä¸­å®ç° channelWritabilityChanged äº‹ä»¶å›è°ƒæ–¹æ³•ï¼Œæ¥é’ˆå¯¹ Channel çš„å¯å†™çŠ¶æ€å˜åŒ–åšå‡ºä¸åŒçš„å¤„ç†ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class EchoServerHandler extends ChannelInboundHandlerAdapter {

    @Override
    public void channelWritabilityChanged(ChannelHandlerContext ctx) throws Exception {

        if (ctx.channel().isWritable()) {
            ...........å½“å‰channelå¯å†™.........
        } else {
            ...........å½“å‰channelä¸å¯å†™.........
        }
    }

}
</code></pre></div><p>åˆ°è¿™é‡Œ write äº‹ä»¶åœ¨ pipeline ä¸­çš„ä¼ æ’­ï¼Œç¬”è€…å°±ä¸ºå¤§å®¶ä»‹ç»å®Œäº†ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹å¦ä¸€ä¸ªé‡è¦çš„ flush äº‹ä»¶çš„å¤„ç†è¿‡ç¨‹ã€‚</p> <h2 id="_4-flush"><a href="#_4-flush" class="header-anchor">#</a> 4. flush</h2> <p>ä»å‰é¢ Netty å¯¹ write äº‹ä»¶çš„å¤„ç†è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å½“ç”¨æˆ·è°ƒç”¨ ctx.write(msg) æ–¹æ³•ä¹‹åï¼ŒNetty åªæ˜¯å°†ç”¨æˆ·è¦å‘é€çš„æ•°æ®ä¸´æ—¶å†™åˆ° channel å¯¹åº”çš„å¾…å‘é€ç¼“å†²é˜Ÿåˆ— ChannelOutboundBuffer ä¸­ï¼Œç„¶è€Œå¹¶ä¸ä¼šå°†æ•°æ®å†™å…¥ Socket ä¸­ã€‚</p> <p>è€Œå½“ä¸€æ¬¡ read äº‹ä»¶å®Œæˆä¹‹åï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨ ctx.flush() æ–¹æ³•å°† ChannelOutboundBuffer ä¸­çš„å¾…å‘é€æ•°æ®å†™å…¥ Socket ä¸­çš„å‘é€ç¼“å†²åŒºä¸­ï¼Œä»è€Œå°†æ•°æ®å‘é€å‡ºå»ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class EchoServerHandler extends ChannelInboundHandlerAdapter {

    @Override
    public void channelReadComplete(ChannelHandlerContext ctx) {
        //æœ¬æ¬¡OP_READäº‹ä»¶å¤„ç†å®Œæ¯•
        ctx.flush();
    }

}
</code></pre></div><h3 id="_4-1-flushäº‹ä»¶çš„ä¼ æ’­"><a href="#_4-1-flushäº‹ä»¶çš„ä¼ æ’­" class="header-anchor">#</a> 4.1 flushäº‹ä»¶çš„ä¼ æ’­</h3> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZwcdibKiceeWADsv1WFuEtvGFmptNuug6aLYJAs07c8dI3kylenu64goxtX7WlmUXPMRAdPOjbbAZw/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">pipelineç»“æ„.png</p> <p>flush äº‹ä»¶å’Œ write äº‹ä»¶ä¸€æ ·éƒ½æ˜¯ oubound äº‹ä»¶ï¼Œæ‰€ä»¥å®ƒä»¬çš„ä¼ æ’­æ–¹å‘éƒ½æ˜¯ä»åå¾€å‰åœ¨ pipeline ä¸­ä¼ æ’­ã€‚</p> <p>è§¦å‘ flush äº‹ä»¶ä¼ æ’­çš„åŒæ ·ä¹Ÿæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š</p> <ul><li><code>channelHandlerContext.flush()</code>ï¼šflushäº‹ä»¶ä¼šä»å½“å‰ channelHandler å¼€å§‹åœ¨ pipeline ä¸­å‘å‰ä¼ æ’­ç›´åˆ° headContextã€‚</li> <li><code>channelHandlerContext.channel().flush()</code>ï¼šflush äº‹ä»¶ä¼šä» pipeline çš„å°¾ç»“ç‚¹ tailContext å¤„å¼€å§‹å‘å‰ä¼ æ’­ç›´åˆ° headContextã€‚</li></ul> <div class="language- extra-class"><pre class="language-text"><code>abstract class AbstractChannelHandlerContext implements ChannelHandlerContext, ResourceLeakHint {

    @Override
    public ChannelHandlerContext flush() {
        //å‘å‰æŸ¥æ‰¾è¦†ç›–flushæ–¹æ³•çš„Outboundç±»å‹çš„ChannelHandler
        final AbstractChannelHandlerContext next = findContextOutbound(MASK_FLUSH);
        //è·å–æ‰§è¡ŒChannelHandlerçš„executor,åœ¨åˆå§‹åŒ–pipelineçš„æ—¶å€™è®¾ç½®ï¼Œé»˜è®¤ä¸ºReactorçº¿ç¨‹
        EventExecutor executor = next.executor();
        if (executor.inEventLoop()) {
            next.invokeFlush();
        } else {
            Tasks tasks = next.invokeTasks;
            if (tasks == null) {
                next.invokeTasks = tasks = new Tasks(next);
            }
            safeExecute(executor, tasks.invokeFlushTask, channel().voidPromise(), null, false);
        }

        return this;
    }

}
</code></pre></div><p>è¿™é‡Œçš„é€»è¾‘å’Œ write äº‹ä»¶ä¼ æ’­çš„é€»è¾‘åŸºæœ¬ä¸€æ ·ï¼Œä¹Ÿæ˜¯é¦–å…ˆé€šè¿‡findContextOutbound(MASK_FLUSH)  æ–¹æ³•ä»å½“å‰ ChannelHandler å¼€å§‹ä» pipeline ä¸­å‘å‰æŸ¥æ‰¾å‡ºç¬¬ä¸€ä¸ª ChannelOutboundHandler ç±»å‹çš„å¹¶ä¸”å®ç° flush äº‹ä»¶å›è°ƒæ–¹æ³•çš„ ChannelHandler ã€‚æ³¨æ„è¿™é‡Œä¼ å…¥çš„æ‰§è¡Œèµ„æ ¼æ©ç ä¸º MASK_FLUSHã€‚</p> <p>æ‰§è¡ŒChannelHandlerä¸­äº‹ä»¶å›è°ƒæ–¹æ³•çš„çº¿ç¨‹å¿…é¡»æ˜¯é€šè¿‡<code>pipeline#addLast(EventExecutorGroup group, ChannelHandler... handlers)</code>ä¸º ChannelHandler æŒ‡å®šçš„ executorã€‚å¦‚æœä¸æŒ‡å®šï¼Œé»˜è®¤çš„ executor ä¸º channel ç»‘å®šçš„  reactor çº¿ç¨‹ã€‚</p> <p>å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯ ChannelHandler æŒ‡å®šçš„ executorï¼Œåˆ™éœ€è¦å°† invokeFlush() æ–¹æ³•çš„è°ƒç”¨å°è£…æˆ Task äº¤ç»™æŒ‡å®šçš„ executor æ‰§è¡Œã€‚</p> <h3 id="_4-1-1-è§¦å‘nextchannelhandlerçš„flushæ–¹æ³•å›è°ƒ"><a href="#_4-1-1-è§¦å‘nextchannelhandlerçš„flushæ–¹æ³•å›è°ƒ" class="header-anchor">#</a> 4.1.1 è§¦å‘nextChannelHandlerçš„flushæ–¹æ³•å›è°ƒ</h3> <div class="language- extra-class"><pre class="language-text"><code>    private void invokeFlush() {
        if (invokeHandler()) {
            invokeFlush0();
        } else {
            //å¦‚æœè¯¥ChannelHandlerå¹¶æ²¡æœ‰åŠ å…¥åˆ°pipelineä¸­åˆ™ç»§ç»­å‘å‰ä¼ é€’flushäº‹ä»¶
            flush();
        }
    }
</code></pre></div><p>è¿™é‡Œå’Œ write äº‹ä»¶çš„ç›¸å…³å¤„ç†ä¸€æ ·ï¼Œé¦–å…ˆä¹Ÿæ˜¯éœ€è¦è°ƒç”¨ invokeHandler() æ–¹æ³•æ¥åˆ¤æ–­è¿™ä¸ª nextChannelHandler æ˜¯å¦åœ¨ pipeline ä¸­è¢«æ­£ç¡®çš„åˆå§‹åŒ–ã€‚</p> <p>å¦‚æœ nextChannelHandler ä¸­çš„ handlerAdded æ–¹æ³•å¹¶æ²¡æœ‰è¢«å›è°ƒè¿‡ï¼Œé‚£ä¹ˆè¿™é‡Œå°±åªèƒ½è·³è¿‡ nextChannelHandlerï¼Œå¹¶è°ƒç”¨ ChannelHandlerContext#flush æ–¹æ³•ç»§ç»­å‘å‰ä¼ æ’­flushäº‹ä»¶ã€‚</p> <p>å¦‚æœ nextChannelHandler ä¸­çš„ handlerAdded æ–¹æ³•å·²ç»è¢«å›è°ƒè¿‡ï¼Œè¯´æ˜ nextChannelHandler åœ¨ pipeline ä¸­å·²ç»è¢«æ­£ç¡®çš„åˆå§‹åŒ–å¥½ï¼Œåˆ™ç›´æ¥è°ƒç”¨nextChannelHandler çš„ flush äº‹ä»¶å›è°ƒæ–¹æ³•ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private void invokeFlush0() {
        try {
            ((ChannelOutboundHandler) handler()).flush(this);
        } catch (Throwable t) {
            invokeExceptionCaught(t);
        }
    }
</code></pre></div><p>è¿™é‡Œæœ‰ä¸€ç‚¹å’Œ write äº‹ä»¶å¤„ç†ä¸åŒçš„æ˜¯ï¼Œå½“è°ƒç”¨ nextChannelHandler çš„ flush å›è°ƒå‡ºç°å¼‚å¸¸çš„æ—¶å€™ï¼Œä¼šè§¦å‘ nextChannelHandler çš„ exceptionCaught å›è°ƒã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private void invokeExceptionCaught(final Throwable cause) {
        if (invokeHandler()) {
            try {
                handler().exceptionCaught(this, cause);
            } catch (Throwable error) {
                if (logger.isDebugEnabled()) {
                    logger.debug(....ç›¸å…³æ—¥å¿—æ‰“å°......);
                } else if (logger.isWarnEnabled()) {
                    logger.warn(...ç›¸å…³æ—¥å¿—æ‰“å°......));
                }
            }
        } else {
            fireExceptionCaught(cause);
        }
    }
</code></pre></div><p>è€Œå…¶ä»– outbound ç±»äº‹ä»¶æ¯”å¦‚ write äº‹ä»¶åœ¨ä¼ æ’­çš„è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œåªæ˜¯å›è°ƒé€šçŸ¥ç›¸å…³çš„ ChannelFutureã€‚å¹¶ä¸ä¼šè§¦å‘ exceptionCaught äº‹ä»¶çš„ä¼ æ’­ã€‚</p> <h3 id="_4-2-flushäº‹ä»¶çš„å¤„ç†"><a href="#_4-2-flushäº‹ä»¶çš„å¤„ç†" class="header-anchor">#</a> 4.2 flushäº‹ä»¶çš„å¤„ç†</h3> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)å®¢æˆ·ç«¯channel pipelineç»“æ„.png</p> <p>æœ€ç»ˆflushäº‹ä»¶ä¼šåœ¨pipelineä¸­ä¸€ç›´å‘å‰ä¼ æ’­è‡³HeadContextä¸­ï¼Œå¹¶åœ¨ HeadContext é‡Œè°ƒç”¨ channel çš„ unsafe ç±»å®Œæˆ flush äº‹ä»¶çš„æœ€ç»ˆå¤„ç†é€»è¾‘ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>final class HeadContext extends AbstractChannelHandlerContext {

        @Override
        public void flush(ChannelHandlerContext ctx) {
            unsafe.flush();
        }

}
</code></pre></div><p>ä¸‹é¢å°±çœŸæ­£åˆ°äº† Netty å¤„ç† flush äº‹ä»¶çš„åœ°æ–¹ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>protected abstract class AbstractUnsafe implements Unsafe {

       @Override
        public final void flush() {
            assertEventLoop();

            ChannelOutboundBuffer outboundBuffer = this.outboundBuffer;
            //channelä»¥å…³é—­
            if (outboundBuffer == null) {
                return;
            }
            //å°†flushedEntryæŒ‡é’ˆæŒ‡å‘ChannelOutboundBufferå¤´ç»“ç‚¹ï¼Œæ­¤æ—¶å˜ä¸ºå³å°†è¦flushè¿›Socketçš„æ•°æ®é˜Ÿåˆ—
            outboundBuffer.addFlush();
            //å°†å¾…å†™æ•°æ®å†™è¿›Socket
            flush0();
        }

}
</code></pre></div><h4 id="_4-2-1-channeloutboundbuffer-addflush"><a href="#_4-2-1-channeloutboundbuffer-addflush" class="header-anchor">#</a> 4.2.1 ChannelOutboundBuffer#addFlush</h4> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)ChannelOutboundBufferç»“æ„.png</p> <p>è¿™é‡Œå°±åˆ°äº†çœŸæ­£è¦å‘é€æ•°æ®çš„æ—¶å€™äº†ï¼Œåœ¨ addFlush æ–¹æ³•ä¸­ä¼šå°† flushedEntry æŒ‡é’ˆæŒ‡å‘ unflushedEntry æŒ‡é’ˆè¡¨ç¤ºçš„ç¬¬ä¸€ä¸ªæœªè¢« flush çš„ Entry èŠ‚ç‚¹ã€‚å¹¶å°† unflushedEntry æŒ‡é’ˆç½®ä¸ºç©ºï¼Œå‡†å¤‡å¼€å§‹ flush å‘é€æ•°æ®æµç¨‹ã€‚</p> <blockquote><p>æ­¤æ—¶ ChannelOutboundBuffer ç”±å¾…å‘é€æ•°æ®çš„ç¼“å†²é˜Ÿåˆ—å˜ä¸ºäº†å³å°†è¦ flush è¿› Socket çš„æ•°æ®é˜Ÿåˆ—</p></blockquote> <p>è¿™æ ·åœ¨ flushedEntry ä¸ tailEntry ä¹‹é—´çš„ Entry èŠ‚ç‚¹å³ä¸ºæœ¬æ¬¡ flush æ“ä½œéœ€è¦å‘é€çš„æ•°æ®èŒƒå›´ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>   public void addFlush() {
        Entry entry = unflushedEntry;
        if (entry != null) {
            if (flushedEntry == null) {
                flushedEntry = entry;
            }
            do {
                flushed ++;
                //å¦‚æœå½“å‰entryå¯¹åº”çš„writeæ“ä½œè¢«ç”¨æˆ·å–æ¶ˆï¼Œåˆ™é‡Šæ”¾msgï¼Œå¹¶é™ä½channelOutboundBufferæ°´ä½çº¿
                if (!entry.promise.setUncancellable()) {
                    int pending = entry.cancel();
                    decrementPendingOutboundBytes(pending, false, true);
                }
                entry = entry.next;
            } while (entry != null);

            // All flushed so reset unflushedEntry
            unflushedEntry = null;
        }
    }
</code></pre></div><p>åœ¨ flush å‘é€æ•°æ®æµç¨‹å¼€å§‹æ—¶ï¼Œæ•°æ®çš„å‘é€æµç¨‹å°±ä¸èƒ½è¢«å–æ¶ˆäº†ï¼Œåœ¨è¿™ä¹‹å‰æˆ‘ä»¬éƒ½æ˜¯å¯ä»¥é€šè¿‡ ChannelPromise å–æ¶ˆæ•°æ®å‘é€æµç¨‹çš„ã€‚</p> <p>æ‰€ä»¥è¿™é‡Œéœ€è¦å¯¹ ChannelOutboundBuffer ä¸­æ‰€æœ‰ Entry èŠ‚ç‚¹åŒ…è£¹çš„ ChannelPromise è®¾ç½®ä¸ºä¸å¯å–æ¶ˆçŠ¶æ€ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public interface Promise&lt;V&gt; extends Future&lt;V&gt; {

   /**
     * è®¾ç½®å½“å‰futureä¸ºä¸å¯å–æ¶ˆçŠ¶æ€
     * 
     * è¿”å›trueçš„æƒ…å†µï¼š
     * 1ï¼šæˆåŠŸçš„å°†futureè®¾ç½®ä¸ºuncancellable
     * 2ï¼šå½“futureå·²ç»æˆåŠŸå®Œæˆ
     * 
     * è¿”å›falseçš„æƒ…å†µï¼š
     * 1ï¼šfutureå·²ç»è¢«å–æ¶ˆï¼Œåˆ™ä¸èƒ½åœ¨è®¾ç½® uncancellable çŠ¶æ€
     *
     */
    boolean setUncancellable();

}
</code></pre></div><p>å¦‚æœè¿™é‡Œçš„ setUncancellable() æ–¹æ³•è¿”å› false åˆ™è¯´æ˜åœ¨è¿™ä¹‹å‰ç”¨æˆ·å·²ç»å°† ChannelPromise å–æ¶ˆæ‰äº†ï¼Œæ¥ä¸‹æ¥å°±éœ€è¦è°ƒç”¨ entry.cancel() æ–¹æ³•æ¥é‡Šæ”¾ä¸ºå¾…å‘é€æ•°æ® msg åˆ†é…çš„å †å¤–å†…å­˜ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>static final class Entry {
        //writeæ“ä½œæ˜¯å¦è¢«å–æ¶ˆ
        boolean cancelled;

        int cancel() {
            if (!cancelled) {
                cancelled = true;
                int pSize = pendingSize;

                // release message and replace with an empty buffer
                ReferenceCountUtil.safeRelease(msg);
                msg = Unpooled.EMPTY_BUFFER;

                pendingSize = 0;
                total = 0;
                progress = 0;
                bufs = null;
                buf = null;
                return pSize;
            }
            return 0;
        }

}
</code></pre></div><p>å½“ Entry å¯¹è±¡è¢«å–æ¶ˆåï¼Œå°±éœ€è¦å‡å°‘ ChannelOutboundBuffer çš„å†…å­˜å ç”¨æ€»é‡çš„æ°´ä½çº¿ totalPendingSizeã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private static final AtomicLongFieldUpdater&lt;ChannelOutboundBuffer&gt; TOTAL_PENDING_SIZE_UPDATER =
            AtomicLongFieldUpdater.newUpdater(ChannelOutboundBuffer.class, &quot;totalPendingSize&quot;);

    //æ°´ä½çº¿æŒ‡é’ˆ.ChannelOutboundBufferä¸­çš„å¾…å‘é€æ•°æ®çš„å†…å­˜å ç”¨æ€»é‡ : æ‰€æœ‰Entryå¯¹è±¡æœ¬èº«æ‰€å ç”¨å†…å­˜å¤§å° + æ‰€æœ‰å¾…å‘é€æ•°æ®çš„å¤§å°
    private volatile long totalPendingSize;

    private void decrementPendingOutboundBytes(long size, boolean invokeLater, boolean notifyWritability) {
        if (size == 0) {
            return;
        }

        long newWriteBufferSize = TOTAL_PENDING_SIZE_UPDATER.addAndGet(this, -size);
        if (notifyWritability &amp;&amp; newWriteBufferSize &lt; channel.config().getWriteBufferLowWaterMark()) {
            setWritable(invokeLater);
        }
    }
</code></pre></div><p>å½“æ›´æ–°åçš„æ°´ä½çº¿ä½äºä½æ°´ä½çº¿ <code>DEFAULT_LOW_WATER_MARK = 32 * 1024</code> æ—¶ï¼Œå°±å°†å½“å‰ channel è®¾ç½®ä¸ºå¯å†™çŠ¶æ€ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private void setWritable(boolean invokeLater) {
        for (;;) {
            final int oldValue = unwritable;
            final int newValue = oldValue &amp; ~1;
            if (UNWRITABLE_UPDATER.compareAndSet(this, oldValue, newValue)) {
                if (oldValue != 0 &amp;&amp; newValue == 0) {
                    fireChannelWritabilityChanged(invokeLater);
                }
                break;
            }
        }
    }
</code></pre></div><p>å½“ Channel çš„çŠ¶æ€æ˜¯ç¬¬ä¸€æ¬¡ä»ä¸å¯å†™çŠ¶æ€å˜ä¸ºå¯å†™çŠ¶æ€æ—¶ï¼ŒNetty ä¼šåœ¨ pipeline ä¸­å†æ¬¡è§¦å‘ ChannelWritabilityChanged äº‹ä»¶çš„ä¼ æ’­ã€‚</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZwcdibKiceeWADsv1WFuEtvGG2ibZXOVtmljrxSR8t3dib7vt87o8DVibHKt09BIu9tcpPsOdZ62XeLeA/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">å“åº”channelWritabilityChangedäº‹ä»¶.png</p> <h3 id="_4-2-2-å‘é€æ•°æ®å‰çš„æœ€åæ£€æŸ¥-flush0"><a href="#_4-2-2-å‘é€æ•°æ®å‰çš„æœ€åæ£€æŸ¥-flush0" class="header-anchor">#</a> 4.2.2 å‘é€æ•°æ®å‰çš„æœ€åæ£€æŸ¥---flush0</h3> <p>flush0 æ–¹æ³•è¿™é‡Œä¸»è¦åšçš„äº‹æƒ…å°±æ˜¯æ£€æŸ¥å½“ channel çš„çŠ¶æ€æ˜¯å¦æ­£å¸¸ï¼Œå¦‚æœ channel çŠ¶æ€ä¸€åˆ‡æ­£å¸¸ï¼Œåˆ™è°ƒç”¨ doWrite æ–¹æ³•å‘é€æ•°æ®ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>protected abstract class AbstractUnsafe implements Unsafe {

        //æ˜¯å¦æ­£åœ¨è¿›è¡Œflushæ“ä½œ
        private boolean inFlush0; 

        protected void flush0() {
            if (inFlush0) {
                // Avoid re-entrance
                return;
            }

            final ChannelOutboundBuffer outboundBuffer = this.outboundBuffer;
            //channelå·²ç»å…³é—­æˆ–è€…outboundBufferä¸ºç©º
            if (outboundBuffer == null || outboundBuffer.isEmpty()) {
                return;
            }

            inFlush0 = true;

            if (!isActive()) {
                try {
                    if (!outboundBuffer.isEmpty()) {
                        if (isOpen()) {
                            //å½“å‰channelå¤„äºdisConnectedçŠ¶æ€  é€šçŸ¥promise å†™å…¥å¤±è´¥ å¹¶è§¦å‘channelWritabilityChangedäº‹ä»¶
                            outboundBuffer.failFlushed(new NotYetConnectedException(), true);
                        } else {
                           //å½“å‰channelå¤„äºå…³é—­çŠ¶æ€ é€šçŸ¥promise å†™å…¥å¤±è´¥ ä½†ä¸è§¦å‘channelWritabilityChangedäº‹ä»¶
                           outboundBuffer.failFlushed(newClosedChannelException(initialCloseCause, &quot;flush0()&quot;), false);
                        }
                    }
                } finally {
                    inFlush0 = false;
                }
                return;
            }

            try {
                //å†™å…¥Socket
                doWrite(outboundBuffer);
            } catch (Throwable t) {
                handleWriteError(t);
            } finally {
                inFlush0 = false;
            }
        }

}
</code></pre></div><ul><li><code>outboundBuffer == null || outboundBuffer.isEmpty()</code> ï¼šå¦‚æœ channel å·²ç»å…³é—­äº†æˆ–è€…å¯¹åº”å†™ç¼“å†²åŒºä¸­æ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œé‚£ä¹ˆå°±åœæ­¢å‘é€æµç¨‹ï¼Œç›´æ¥ returnã€‚</li> <li><code>!isActive()</code> ï¼šå¦‚æœå½“å‰channelå¤„äºéæ´»è·ƒçŠ¶æ€ï¼Œåˆ™éœ€è¦è°ƒç”¨ <code>outboundBuffer#failFlushed</code> é€šçŸ¥ ChannelOutboundBuffer ä¸­æ‰€æœ‰å¾…å‘é€æ“ä½œå¯¹åº”çš„ channelPromise å‘ç”¨æˆ·çº¿ç¨‹æŠ¥å‘Šå‘é€å¤±è´¥ã€‚å¹¶å°†å¾…å‘é€æ•°æ® Entry å¯¹è±¡ä» ChannelOutboundBuffer ä¸­åˆ é™¤ï¼Œå¹¶é‡Šæ”¾å¾…å‘é€æ•°æ®ç©ºé—´ï¼Œå›æ”¶ Entry å¯¹è±¡å®ä¾‹ã€‚</li></ul> <p>è¿˜è®°å¾—æˆ‘ä»¬åœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484184&amp;idx=1&amp;sn=726877ce28cf6e5d2ac3225fae687f19&amp;chksm=ce77c55ff9004c493b592288819dc4d4664b5949ee97fed977b6558bc517dad0e1f73fab0f46&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€ŠNettyå¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œè¿æ¥ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸€æ–‡ä¸­æåˆ°è¿‡çš„ NioSocketChannel çš„ active çŠ¶æ€æœ‰å“ªäº›æ¡ä»¶å—ï¼Ÿï¼Ÿ</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public boolean isActive() {
        SocketChannel ch = javaChannel();
        return ch.isOpen() &amp;&amp; ch.isConnected();
    }
</code></pre></div><p>NioSocketChannel å¤„äº active çŠ¶æ€çš„æ¡ä»¶å¿…é¡»æ˜¯å½“å‰ NioSocketChannel æ˜¯ open çš„åŒæ—¶å¤„äº connected çŠ¶æ€ã€‚</p> <ul><li><code>!isActive() &amp;&amp; isOpen()</code>ï¼šè¯´æ˜å½“å‰ channel å¤„äº disConnected çŠ¶æ€ï¼Œè¿™æ—¶é€šçŸ¥ç»™ç”¨æˆ· channelPromise çš„å¼‚å¸¸ç±»å‹ä¸º NotYetConnectedException ,å¹¶é‡Šæ”¾æ‰€æœ‰å¾…å‘é€æ•°æ®å ç”¨çš„å †å¤–å†…å­˜ï¼Œå¦‚æœæ­¤æ—¶å†…å­˜å ç”¨é‡ä½äºä½æ°´ä½çº¿ï¼Œåˆ™è®¾ç½® channel ä¸ºå¯å†™çŠ¶æ€ï¼Œå¹¶è§¦å‘ channelWritabilityChanged äº‹ä»¶ã€‚</li></ul> <blockquote><p>å½“ channel å¤„äº disConnected çŠ¶æ€æ—¶ï¼Œç”¨æˆ·å¯ä»¥è¿›è¡Œ write æ“ä½œä½†ä¸èƒ½è¿›è¡Œ flush æ“ä½œã€‚</p></blockquote> <ul><li><code>!isActive() &amp;&amp; !isOpen()</code> ï¼šè¯´æ˜å½“å‰ channel å¤„äºå…³é—­çŠ¶æ€ï¼Œè¿™æ—¶é€šçŸ¥ç»™ç”¨æˆ· channelPromise çš„å¼‚å¸¸ç±»å‹ä¸º newClosedChannelException ï¼Œå› ä¸º channel å·²ç»å…³é—­ï¼Œæ‰€ä»¥è¿™é‡Œå¹¶ä¸ä¼šè§¦å‘ channelWritabilityChanged äº‹ä»¶ã€‚</li> <li>å½“ channel çš„è¿™äº›å¼‚å¸¸çŠ¶æ€æ ¡éªŒé€šè¿‡ä¹‹åï¼Œåˆ™è°ƒç”¨ doWrite æ–¹æ³•å°† ChannelOutboundBuffer ä¸­çš„å¾…å‘é€æ•°æ®å†™è¿›åº•å±‚ Socket ä¸­ã€‚</li></ul> <h4 id="_4-2-2-1-channeloutboundbuffer-failflushed"><a href="#_4-2-2-1-channeloutboundbuffer-failflushed" class="header-anchor">#</a> 4.2.2.1  ChannelOutboundBuffer#failFlushed</h4> <div class="language- extra-class"><pre class="language-text"><code>public final class ChannelOutboundBuffer {

    private boolean inFail;

    void failFlushed(Throwable cause, boolean notify) {
        if (inFail) {
            return;
        }

        try {
            inFail = true;
            for (;;) {
                if (!remove0(cause, notify)) {
                    break;
                }
            }
        } finally {
            inFail = false;
        }
    }
}
</code></pre></div><p>è¯¥æ–¹æ³•ç”¨äºåœ¨ Netty åœ¨å‘é€æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°å½“å‰ channel å¤„äºéæ´»è·ƒçŠ¶æ€ï¼Œåˆ™å°† ChannelOutboundBuffer ä¸­ flushedEntry ä¸tailEntry ä¹‹é—´çš„ Entry å¯¹è±¡èŠ‚ç‚¹å…¨éƒ¨åˆ é™¤ï¼Œå¹¶é‡Šæ”¾å‘é€æ•°æ®å ç”¨çš„å†…å­˜ç©ºé—´ï¼ŒåŒæ—¶å›æ”¶ Entry å¯¹è±¡å®ä¾‹ã€‚</p> <h4 id="_4-2-2-2-channeloutboundbuffer-remove0"><a href="#_4-2-2-2-channeloutboundbuffer-remove0" class="header-anchor">#</a> 4.2.2.2  ChannelOutboundBuffer#remove0</h4> <div class="language- extra-class"><pre class="language-text"><code>    private boolean remove0(Throwable cause, boolean notifyWritability) {
        Entry e = flushedEntry;
        if (e == null) {
            //æ¸…ç©ºå½“å‰reactorçº¿ç¨‹ç¼“å­˜çš„æ‰€æœ‰å¾…å‘é€æ•°æ®
            clearNioBuffers();
            return false;
        }
        Object msg = e.msg;

        ChannelPromise promise = e.promise;
        int size = e.pendingSize;
        //ä»channelOutboundBufferä¸­åˆ é™¤è¯¥EntryèŠ‚ç‚¹
        removeEntry(e);

        if (!e.cancelled) {
            // only release message, fail and decrement if it was not canceled before.
            //é‡Šæ”¾msgæ‰€å ç”¨çš„å†…å­˜ç©ºé—´
            ReferenceCountUtil.safeRelease(msg);
            //ç¼–è¾‘promiseå‘é€å¤±è´¥ï¼Œå¹¶é€šçŸ¥ç›¸åº”çš„Lisener
            safeFail(promise, cause);
            //ç”±äºmsgå¾—åˆ°é‡Šæ”¾ï¼Œæ‰€ä»¥éœ€è¦é™ä½channelOutboundBufferä¸­çš„å†…å­˜å ç”¨æ°´ä½çº¿ï¼Œå¹¶æ ¹æ®notifyWritabilityå†³å®šæ˜¯å¦è§¦å‘ChannelWritabilityChangedäº‹ä»¶
            decrementPendingOutboundBytes(size, false, notifyWritability);
        }

        // recycle the entry
        //å›æ”¶Entryå®ä¾‹å¯¹è±¡
        e.recycle();

        return true;
    }
</code></pre></div><p>å½“ä¸€ä¸ª Entry èŠ‚ç‚¹éœ€è¦ä» ChannelOutboundBuffer ä¸­æ¸…é™¤æ—¶ï¼ŒNetty éœ€è¦é‡Šæ”¾è¯¥ Entry èŠ‚ç‚¹ä¸­åŒ…è£¹çš„å‘é€æ•°æ® msg æ‰€å ç”¨çš„å†…å­˜ç©ºé—´ã€‚å¹¶æ ‡è®°å¯¹åº”çš„ promise ä¸ºå¤±è´¥åŒæ—¶é€šçŸ¥å¯¹åº”çš„ listener ï¼Œç”±äº msg å¾—åˆ°é‡Šæ”¾ï¼Œæ‰€ä»¥éœ€è¦é™ä½ channelOutboundBuffer ä¸­çš„å†…å­˜å ç”¨æ°´ä½çº¿ï¼Œå¹¶æ ¹æ® <code>boolean notifyWritability</code> å†³å®šæ˜¯å¦è§¦å‘ ChannelWritabilityChanged äº‹ä»¶ã€‚æœ€åéœ€è¦å°†è¯¥ Entry å®ä¾‹å›æ”¶è‡³ Recycler å¯¹è±¡æ± ä¸­ã€‚</p> <h2 id="_5-ç»ˆäºå¼€å§‹çœŸæ­£åœ°å‘é€æ•°æ®äº†"><a href="#_5-ç»ˆäºå¼€å§‹çœŸæ­£åœ°å‘é€æ•°æ®äº†" class="header-anchor">#</a> 5. ç»ˆäºå¼€å§‹çœŸæ­£åœ°å‘é€æ•°æ®äº†ï¼</h2> <p>æ¥åˆ°è¿™é‡Œæˆ‘ä»¬å°±çœŸæ­£è¿›å…¥åˆ°äº† Netty å‘é€æ•°æ®çš„æ ¸å¿ƒå¤„ç†é€»è¾‘ï¼Œåœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484244&amp;idx=1&amp;sn=831060fc38caa201d69f87305de7f86a&amp;chksm=ce77c513f9004c05b48f849ff99997d6d7252453135ae856a029137b88aa70b8e046013d596e&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€ŠNettyå¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œæ•°æ®ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸€æ–‡ä¸­ï¼Œç¬”è€…è¯¦ç»†ä»‹ç»äº† Netty è¯»å–æ•°æ®çš„æ ¸å¿ƒæµç¨‹ï¼ŒNetty ä¼šåœ¨ä¸€ä¸ª read loop ä¸­ä¸æ–­å¾ªç¯è¯»å– Socket ä¸­çš„æ•°æ®ç›´åˆ°æ•°æ®è¯»å–å®Œæ¯•æˆ–è€…è¯»å–æ¬¡æ•°å·²æ»¡ 16 æ¬¡ï¼Œå½“å¾ªç¯è¯»å–äº† 16 æ¬¡è¿˜æ²¡æœ‰è¯»å–å®Œæ¯•æ—¶ï¼ŒNetty å°±ä¸èƒ½åœ¨ç»§ç»­è¯»äº†ï¼Œå› ä¸º Netty è¦ä¿è¯ Reactor çº¿ç¨‹å¯ä»¥å‡åŒ€çš„å¤„ç†æ³¨å†Œåœ¨å®ƒä¸Šè¾¹çš„æ‰€æœ‰ Channel ä¸­çš„ IO äº‹ä»¶ã€‚å‰©ä¸‹æœªè¯»å–çš„æ•°æ®ç­‰åˆ°ä¸‹ä¸€æ¬¡ read loop åœ¨å¼€å§‹è¯»å–ã€‚</p> <p>é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨æ¯æ¬¡ read loop å¼€å§‹ä¹‹å‰ï¼ŒNetty éƒ½ä¼šåˆ†é…ä¸€ä¸ªåˆå§‹åŒ–å¤§å°ä¸º 2048 çš„ DirectByteBuffer æ¥è£…è½½ä» Socket ä¸­è¯»å–åˆ°çš„æ•°æ®ï¼Œå½“æ•´ä¸ª read loop ç»“æŸæ—¶ï¼Œä¼šæ ¹æ®æœ¬æ¬¡è¯»å–æ•°æ®çš„æ€»é‡æ¥åˆ¤æ–­æ˜¯å¦ä¸ºè¯¥ DirectByteBuffer è¿›è¡Œæ‰©å®¹æˆ–è€…ç¼©å®¹ï¼Œç›®çš„æ˜¯åœ¨ä¸‹ä¸€æ¬¡ read loop çš„æ—¶å€™å¯ä»¥ä¸ºå…¶åˆ†é…ä¸€ä¸ªå®¹é‡å¤§å°åˆé€‚çš„ DirectByteBuffer ã€‚</p> <p>å…¶å® Netty å¯¹å‘é€æ•°æ®çš„å¤„ç†å’Œå¯¹è¯»å–æ•°æ®çš„å¤„ç†æ ¸å¿ƒé€»è¾‘éƒ½æ˜¯ä¸€æ ·çš„ï¼Œè¿™é‡Œå¤§å®¶å¯ä»¥å°†è¿™ä¸¤ç¯‡æ–‡ç« ç»“åˆå¯¹æ¯”ç€çœ‹ã€‚</p> <p>ä½†å‘é€æ•°æ®çš„ç»†èŠ‚ä¼šå¤šä¸€äº›ï¼Œä¹Ÿä¼šæ›´å¤æ‚ä¸€äº›ï¼Œç”±äºè¿™å—é€»è¾‘æ•´ä½“ç¨å¾®æ¯”è¾ƒå¤æ‚ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥ä¸‹æ¥è¿˜æ˜¯åˆ†æ¨¡å—è¿›è¡Œè§£æï¼š</p> <h3 id="_5-1-å‘é€æ•°æ®å‰çš„å‡†å¤‡å·¥ä½œ"><a href="#_5-1-å‘é€æ•°æ®å‰çš„å‡†å¤‡å·¥ä½œ" class="header-anchor">#</a> 5.1 å‘é€æ•°æ®å‰çš„å‡†å¤‡å·¥ä½œ</h3> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    protected void doWrite(ChannelOutboundBuffer in) throws Exception {
        //è·å–NioSocketChannelä¸­å°è£…çš„jdk nioåº•å±‚socketChannel
        SocketChannel ch = javaChannel();
        //æœ€å¤§å†™å…¥æ¬¡æ•° é»˜è®¤ä¸º16 ç›®çš„æ˜¯ä¸ºäº†ä¿è¯SubReactorå¯ä»¥å¹³å‡çš„å¤„ç†æ³¨å†Œå…¶ä¸Šçš„æ‰€æœ‰Channel
        int writeSpinCount = config().getWriteSpinCount();
        do {
            if (in.isEmpty()) {
                // å¦‚æœå…¨éƒ¨æ•°æ®å·²ç»å†™å®Œ åˆ™ç§»é™¤OP_WRITEäº‹ä»¶å¹¶ç›´æ¥é€€å‡ºwriteLoop
                clearOpWrite();             
                return;
            }

            //  SO_SNDBUFè®¾ç½®çš„å‘é€ç¼“å†²åŒºå¤§å° * 2 ä½œä¸º æœ€å¤§å†™å…¥å­—èŠ‚æ•°  293976 = 146988 &lt;&lt; 1
            int maxBytesPerGatheringWrite = ((NioSocketChannelConfig) config).getMaxBytesPerGatheringWrite();
            // å°†ChannelOutboundBufferä¸­ç¼“å­˜çš„DirectBufferè½¬æ¢æˆJDK NIO çš„ ByteBuffer
            ByteBuffer[] nioBuffers = in.nioBuffers(1024, maxBytesPerGatheringWrite);
            // ChannelOutboundBufferä¸­æ€»å…±çš„DirectBufferæ•°
            int nioBufferCnt = in.nioBufferCount();

            switch (nioBufferCnt) {
                .........å‘åº•å±‚jdk nio socketChannelå‘é€æ•°æ®.........
            }
        } while (writeSpinCount &gt; 0);
        
        ............å¤„ç†æœ¬è½®write loopæœªå†™å®Œçš„æƒ…å†µ.......
    }
</code></pre></div><p>è¿™éƒ¨åˆ†å†…å®¹ä¸º Netty å¼€å§‹å‘é€æ•°æ®ä¹‹å‰çš„å‡†å¤‡å·¥ä½œï¼š</p> <h4 id="_5-1-1-è·å–write-loopæœ€å¤§å‘é€å¾ªç¯æ¬¡æ•°"><a href="#_5-1-1-è·å–write-loopæœ€å¤§å‘é€å¾ªç¯æ¬¡æ•°" class="header-anchor">#</a> 5.1.1 è·å–write loopæœ€å¤§å‘é€å¾ªç¯æ¬¡æ•°</h4> <p>ä»å½“å‰ NioSocketChannel çš„é…ç½®ç±» NioSocketChannelConfig ä¸­è·å– write loop æœ€å¤§å¾ªç¯å†™å…¥æ¬¡æ•°ï¼Œé»˜è®¤ä¸º 16ã€‚ä½†ä¹Ÿå¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼è¿›è¡Œè‡ªå®šä¹‰è®¾ç½®ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>            ServerBootstrap b = new ServerBootstrap();
            b.group(bossGroup, workerGroup)
                   .......
             .childOption(ChannelOption.WRITE_SPIN_COUNT,è‡ªå®šä¹‰æ•°å€¼)
</code></pre></div><h4 id="_5-1-2-å¤„ç†åœ¨ä¸€è½®write-loopä¸­å°±å‘é€å®Œæ•°æ®çš„æƒ…å†µ"><a href="#_5-1-2-å¤„ç†åœ¨ä¸€è½®write-loopä¸­å°±å‘é€å®Œæ•°æ®çš„æƒ…å†µ" class="header-anchor">#</a> 5.1.2 å¤„ç†åœ¨ä¸€è½®write loopä¸­å°±å‘é€å®Œæ•°æ®çš„æƒ…å†µ</h4> <p>è¿›å…¥ write loop ä¹‹åé¦–å…ˆéœ€è¦åˆ¤æ–­å½“å‰ ChannelOutboundBuffer ä¸­çš„æ•°æ®æ˜¯å¦å·²ç»å†™å®Œäº† <code>in.isEmpty())</code> ï¼Œå¦‚æœå…¨éƒ¨å†™å®Œå°±éœ€è¦æ¸…é™¤å½“å‰ Channel åœ¨ Reactor ä¸Šæ³¨å†Œçš„ OP_WRITE äº‹ä»¶ã€‚</p> <blockquote><p>è¿™é‡Œå¤§å®¶å¯èƒ½ä¼šæœ‰ç–‘é—®ï¼Œç›®å‰æˆ‘ä»¬è¿˜æ²¡æœ‰æ³¨å†Œ OP_WRITE äº‹ä»¶åˆ° Reactor ä¸Šï¼Œä¸ºå•¥è¦æ¸…é™¤å‘¢ï¼Ÿåˆ«ç€æ€¥ï¼Œç¬”è€…ä¼šåœ¨åé¢ä¸ºå¤§å®¶æ­æ™“ç­”æ¡ˆã€‚</p></blockquote> <h4 id="_5-1-3-è·å–æœ¬æ¬¡write-loop-æœ€å¤§å…è®¸å‘é€å­—èŠ‚æ•°"><a href="#_5-1-3-è·å–æœ¬æ¬¡write-loop-æœ€å¤§å…è®¸å‘é€å­—èŠ‚æ•°" class="header-anchor">#</a> 5.1.3 è·å–æœ¬æ¬¡write loop æœ€å¤§å…è®¸å‘é€å­—èŠ‚æ•°</h4> <p>ä» ChannelConfig ä¸­è·å–æœ¬æ¬¡ write loop æœ€å¤§å…è®¸å‘é€çš„å­—èŠ‚æ•° maxBytesPerGatheringWrite ã€‚åˆå§‹å€¼ä¸º <code>SO_SNDBUFå¤§å° * 2 = 293976 = 146988 &lt;&lt; 1</code>ï¼Œæœ€å°å€¼ä¸º 2048ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private final class NioSocketChannelConfig extends DefaultSocketChannelConfig {
        //293976 = 146988 &lt;&lt; 1
        //SO_SNDBUFè®¾ç½®çš„å‘é€ç¼“å†²åŒºå¤§å° * 2 ä½œä¸º æœ€å¤§å†™å…¥å­—èŠ‚æ•°
        //æœ€å°å€¼ä¸º2048 
        private volatile int maxBytesPerGatheringWrite = Integer.MAX_VALUE;
        private NioSocketChannelConfig(NioSocketChannel channel, Socket javaSocket) {
            super(channel, javaSocket);
            calculateMaxBytesPerGatheringWrite();
        }

        private void calculateMaxBytesPerGatheringWrite() {
            // 293976 = 146988 &lt;&lt; 1
            // SO_SNDBUFè®¾ç½®çš„å‘é€ç¼“å†²åŒºå¤§å° * 2 ä½œä¸º æœ€å¤§å†™å…¥å­—èŠ‚æ•°
            int newSendBufferSize = getSendBufferSize() &lt;&lt; 1;
            if (newSendBufferSize &gt; 0) {
                setMaxBytesPerGatheringWrite(newSendBufferSize);
            }
        }
   }
</code></pre></div><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹çš„æ–¹å¼è‡ªå®šä¹‰é…ç½® Socket å‘é€ç¼“å†²åŒºå¤§å°ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>            ServerBootstrap b = new ServerBootstrap();
            b.group(bossGroup, workerGroup)
                   .......
             .childOption(ChannelOption.SO_SNDBUF,è‡ªå®šä¹‰æ•°å€¼)
</code></pre></div><h4 id="_5-1-4-å°†å¾…å‘é€æ•°æ®è½¬æ¢æˆ-jdk-nio-bytebuffer"><a href="#_5-1-4-å°†å¾…å‘é€æ•°æ®è½¬æ¢æˆ-jdk-nio-bytebuffer" class="header-anchor">#</a> 5.1.4 å°†å¾…å‘é€æ•°æ®è½¬æ¢æˆ JDK NIO ByteBuffer</h4> <p>ç”±äºæœ€ç»ˆ Netty ä¼šè°ƒç”¨ JDK NIO çš„ SocketChannel å‘é€æ•°æ®ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦é¦–å…ˆå°†å½“å‰ Channel ä¸­çš„å†™ç¼“å†²é˜Ÿåˆ— ChannelOutboundBuffer é‡Œå­˜å‚¨çš„ DirectByteBufferï¼ˆ Netty ä¸­çš„ ByteBuffer å®ç°ï¼‰è½¬æ¢æˆ JDK NIO çš„ ByteBuffer ç±»å‹ã€‚æœ€ç»ˆå°†è½¬æ¢åçš„å¾…å‘é€æ•°æ®å­˜å‚¨åœ¨ ByteBuffer[] nioBuffers æ•°ç»„ä¸­ã€‚è¿™é‡Œé€šè¿‡è°ƒç”¨ <code>ChannelOutboundBuffer#nioBuffers</code> æ–¹æ³•å®Œæˆä»¥ä¸Š ByteBuffer ç±»å‹çš„è½¬æ¢ã€‚</p> <ul><li><code>maxBytesPerGatheringWrite</code>ï¼šè¡¨ç¤ºæœ¬æ¬¡ write loop ä¸­æœ€å¤šä» ChannelOutboundBuffer ä¸­è½¬æ¢ maxBytesPerGatheringWrite ä¸ªå­—èŠ‚å‡ºæ¥ã€‚ä¹Ÿå°±æ˜¯æœ¬æ¬¡ write loop æœ€å¤šèƒ½å‘é€å¤šå°‘å­—èŠ‚ã€‚</li> <li><code>1024</code>: æœ¬æ¬¡ write loop æœ€å¤šè½¬æ¢ 1024 ä¸ª ByteBufferï¼ˆ JDK NIO å®ç°ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´æœ¬æ¬¡ write loop æœ€å¤šæ‰¹é‡å‘é€å¤šå°‘ä¸ª ByteBuffer ã€‚</li></ul> <p>é€šè¿‡ <code>ChannelOutboundBuffer#nioBufferCount()</code> è·å–æœ¬æ¬¡ write loop æ€»å…±éœ€è¦å‘é€çš„ ByteBuffer æ•°é‡ nioBufferCnt ã€‚æ³¨æ„è¿™é‡Œå·²ç»å˜æˆäº† JDK NIO å®ç°çš„ ByteBuffer äº†ã€‚</p> <blockquote><p>è¯¦ç»†çš„ ByteBuffer ç±»å‹è½¬æ¢è¿‡ç¨‹ï¼Œç¬”è€…ä¼šåœ¨ä¸“é—¨è®²è§£ Buffer è®¾è®¡çš„æ—¶å€™ä¸ºå¤§å®¶å…¨é¢ç»†è‡´åœ°è®²è§£ï¼Œè¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯ä¸»è¦èšç„¦äºå‘é€æ•°æ®æµç¨‹çš„ä¸»çº¿ã€‚</p></blockquote> <p>å½“åšå®Œè¿™äº›å‘é€å‰çš„å‡†å¤‡å·¥ä½œä¹‹åï¼Œæ¥ä¸‹æ¥ Netty å°±å¼€å§‹å‘ JDK NIO SocketChannel å‘é€è¿™äº›å·²ç»è½¬æ¢å¥½çš„ JDK NIO ByteBuffer äº†ã€‚</p> <h3 id="_5-2-å‘jdk-nio-socketchannelå‘é€æ•°æ®"><a href="#_5-2-å‘jdk-nio-socketchannelå‘é€æ•°æ®" class="header-anchor">#</a> 5.2 å‘JDK NIO SocketChannelå‘é€æ•°æ®</h3> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZwcdibKiceeWADsv1WFuEtvGRWOLdwZGibSMcXVzyJmI5ribtNJr1kjwwB1MM5mGH0icIWXLGPE4OEbvw/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">flushæµç¨‹.png</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    protected void doWrite(ChannelOutboundBuffer in) throws Exception {      
        SocketChannel ch = javaChannel();
        int writeSpinCount = config().getWriteSpinCount();
        do {
  
            .........å°†å¾…å‘é€æ•°æ®è½¬æ¢åˆ°JDK NIO ByteBufferä¸­.........

            //æœ¬æ¬¡write loopä¸­éœ€è¦å‘é€çš„ JDK ByteBufferä¸ªæ•°
            int nioBufferCnt = in.nioBufferCount();

            switch (nioBufferCnt) {
                case 0:
                    //è¿™é‡Œä¸»è¦æ˜¯é’ˆå¯¹ ç½‘ç»œä¼ è¾“æ–‡ä»¶æ•°æ® çš„å¤„ç† FileRegion                 
                    writeSpinCount -= doWrite0(in);
                    break;
                case 1: {
                    .........å¤„ç†å•ä¸ªNioByteBufferå‘é€çš„æƒ…å†µ......
                    break;
                }
                default: {
                    .........æ‰¹é‡å¤„ç†å¤šä¸ªNioByteBufferså‘é€çš„æƒ…å†µ......
                    break;
                }            
            }
        } while (writeSpinCount &gt; 0);
        
        ............å¤„ç†æœ¬è½®write loopæœªå†™å®Œçš„æƒ…å†µ.......
    }
</code></pre></div><p>è¿™é‡Œå¤§å®¶å¯èƒ½å¯¹ <code>nioBufferCnt == 0</code> çš„æƒ…å†µæ¯”è¾ƒæœ‰ç–‘æƒ‘ï¼Œæ˜æ˜ä¹‹å‰å·²ç»æ ¡éªŒè¿‡ChannelOutboundBuffer ä¸ä¸ºç©ºäº†ï¼Œ<strong>ä¸ºä»€ä¹ˆè¿™é‡Œä» ChannelOutboundBuffer ä¸­è·å–åˆ°çš„ nioBuffer ä¸ªæ•°ä¾ç„¶ä¸º 0 å‘¢</strong>ï¼Ÿ</p> <p>åœ¨å‰è¾¹æˆ‘ä»¬ä»‹ç» Netty å¯¹ write äº‹ä»¶çš„å¤„ç†è¿‡ç¨‹æ—¶æè¿‡ï¼Œ ChannelOutboundBuffer ä¸­åªæ”¯æŒ ByteBuf ç±»å‹å’Œ FileRegion ç±»å‹ï¼Œå…¶ä¸­ ByteBuf ç±»å‹ç”¨äºè£…è½½æ™®é€šçš„å‘é€æ•°æ®ï¼Œè€Œ FileRegion ç±»å‹ç”¨äºé€šè¿‡é›¶æ‹·è´çš„æ–¹å¼ç½‘ç»œä¼ è¾“æ–‡ä»¶ã€‚</p> <p>è€Œè¿™é‡Œ ChannelOutboundBuffer è™½ç„¶ä¸ä¸ºç©ºï¼Œä½†æ˜¯è£…è½½çš„ NioByteBuffer ä¸ªæ•°å´ä¸º 0 è¯´æ˜ ChannelOutboundBuffer ä¸­è£…è½½çš„æ˜¯ FileRegion ç±»å‹ï¼Œå½“å‰æ­£åœ¨è¿›è¡Œç½‘ç»œæ–‡ä»¶çš„ä¼ è¾“ã€‚</p> <p><code>case 0</code> çš„åˆ†æ”¯ä¸»è¦å°±æ˜¯ç”¨äºå¤„ç†ç½‘ç»œæ–‡ä»¶ä¼ è¾“çš„æƒ…å†µã€‚</p> <h4 id="_5-2-1-é›¶æ‹·è´å‘é€ç½‘ç»œæ–‡ä»¶"><a href="#_5-2-1-é›¶æ‹·è´å‘é€ç½‘ç»œæ–‡ä»¶" class="header-anchor">#</a> 5.2.1 é›¶æ‹·è´å‘é€ç½‘ç»œæ–‡ä»¶</h4> <div class="language- extra-class"><pre class="language-text"><code>    protected final int doWrite0(ChannelOutboundBuffer in) throws Exception {
        Object msg = in.current();
        if (msg == null) {
            return 0;
        }
        return doWriteInternal(in, in.current());
    }
</code></pre></div><p>è¿™é‡Œéœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ç”¨äºæ–‡ä»¶ä¼ è¾“çš„æ–¹æ³• doWriteInternal ä¸­çš„è¿”å›å€¼ï¼Œç†è§£è¿™äº›è¿”å›å€¼çš„å…·ä½“æƒ…å†µæœ‰åŠ©äºæˆ‘ä»¬ç†è§£åé¢ write loop çš„é€»è¾‘èµ°å‘ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private int doWriteInternal(ChannelOutboundBuffer in, Object msg) throws Exception {

        if (msg instanceof ByteBuf) {

             ..............å¿½ç•¥............

        } else if (msg instanceof FileRegion) {
            FileRegion region = (FileRegion) msg;
            //æ–‡ä»¶å·²ç»ä¼ è¾“å®Œæ¯•
            if (region.transferred() &gt;= region.count()) {
                in.remove();
                return 0;
            }

            //é›¶æ‹·è´çš„æ–¹å¼ä¼ è¾“æ–‡ä»¶
            long localFlushedAmount = doWriteFileRegion(region);
            if (localFlushedAmount &gt; 0) {
                in.progress(localFlushedAmount);
                if (region.transferred() &gt;= region.count()) {
                    in.remove();
                }
                return 1;
            }
        } else {
            // Should not reach here.
            throw new Error();
        }
        //èµ°åˆ°è¿™é‡Œè¡¨ç¤º æ­¤æ—¶Socketå·²ç»å†™ä¸è¿›å»äº† é€€å‡ºwriteLoopï¼Œæ³¨å†ŒOP_WRITEäº‹ä»¶
        return WRITE_STATUS_SNDBUF_FULL;
    }
</code></pre></div><p>æœ€ç»ˆä¼šåœ¨ doWriteFileRegion æ–¹æ³•ä¸­é€šè¿‡ <code>FileChannel#transferTo</code> æ–¹æ³•åº•å±‚ç”¨åˆ°çš„ç³»ç»Ÿè°ƒç”¨ä¸º <code>sendFile</code> å®ç°é›¶æ‹·è´ç½‘ç»œæ–‡ä»¶çš„ä¼ è¾“ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class NioSocketChannel extends AbstractNioByteChannel implements io.netty.channel.socket.SocketChannel {

   @Override
    protected long doWriteFileRegion(FileRegion region) throws Exception {
        final long position = region.transferred();
        return region.transferTo(javaChannel(), position);
    }

}
</code></pre></div><blockquote><p>å…³äº Netty ä¸­æ¶‰åŠåˆ°çš„é›¶æ‹·è´ï¼Œç¬”è€…ä¼šæœ‰ä¸€ç¯‡ä¸“é—¨çš„æ–‡ç« ä¸ºå¤§å®¶è®²è§£ï¼Œæœ¬æ–‡çš„ä¸»é¢˜æˆ‘ä»¬è¿˜æ˜¯å…ˆèšç„¦äºæŠŠå‘é€æµç¨‹çš„ä¸»çº¿æ‰“é€šã€‚</p></blockquote> <p>æˆ‘ä»¬ç»§ç»­å›åˆ°å‘é€æ•°æ®æµç¨‹ä¸»çº¿ä¸Šæ¥~~</p> <div class="language- extra-class"><pre class="language-text"><code>                case 0:
                    //è¿™é‡Œä¸»è¦æ˜¯é’ˆå¯¹ ç½‘ç»œä¼ è¾“æ–‡ä»¶æ•°æ® çš„å¤„ç† FileRegion                 
                    writeSpinCount -= doWrite0(in);
                    break;
</code></pre></div><ul><li><code>region.transferred() &gt;= region.count()</code> ï¼šè¡¨ç¤ºå½“å‰ FileRegion ä¸­çš„æ–‡ä»¶æ•°æ®å·²ç»ä¼ è¾“å®Œæ¯•ã€‚é‚£ä¹ˆåœ¨è¿™ç§æƒ…å†µä¸‹æœ¬æ¬¡ write loop æ²¡æœ‰å†™å…¥ä»»ä½•æ•°æ®åˆ° Socket ï¼Œæ‰€ä»¥è¿”å› 0 ï¼ŒwriteSpinCount - 0 æ„æ€å°±æ˜¯æœ¬æ¬¡ write loop ä¸ç®—ï¼Œç»§ç»­å¾ªç¯ã€‚</li> <li><code>localFlushedAmount &gt; 0</code> ï¼šè¡¨ç¤ºæœ¬ write loop ä¸­å†™å…¥äº†ä¸€äº›æ•°æ®åˆ° Socket ä¸­ï¼Œä¼šæœ‰è¿”å› 1ï¼ŒwriteSpinCount - 1 å‡å°‘ä¸€æ¬¡ write loop æ¬¡æ•°ã€‚</li> <li><code>localFlushedAmount &lt;= 0</code> ï¼šè¡¨ç¤ºå½“å‰ Socket å‘é€ç¼“å†²åŒºå·²æ»¡ï¼Œæ— æ³•å†™å…¥æ•°æ®ï¼Œé‚£ä¹ˆå°±è¿”å› <code>WRITE_STATUS_SNDBUF_FULL = Integer.MAX_VALUE</code>ã€‚<code>writeSpinCount - Integer.MAX_VALUE</code> å¿…ç„¶æ˜¯è´Ÿæ•°ï¼Œç›´æ¥é€€å‡ºå¾ªç¯ï¼Œå‘ Reactor æ³¨å†Œ OP_WRITE äº‹ä»¶å¹¶é€€å‡º flush æµç¨‹ã€‚ç­‰ Socket å‘é€ç¼“å†²åŒºå¯å†™äº†ï¼ŒReactor ä¼šé€šçŸ¥ channel ç»§ç»­å‘é€æ–‡ä»¶æ•°æ®ã€‚<strong>è®°ä½è¿™é‡Œï¼Œæˆ‘ä»¬åé¢è¿˜ä¼šæåˆ°</strong>ã€‚</li></ul> <h4 id="_5-2-2-å‘é€æ™®é€šæ•°æ®"><a href="#_5-2-2-å‘é€æ™®é€šæ•°æ®" class="header-anchor">#</a> 5.2.2 å‘é€æ™®é€šæ•°æ®</h4> <p>å‰©ä¸‹ä¸¤ä¸ª case 1 å’Œ default åˆ†æ”¯ä¸»è¦å°±æ˜¯å¤„ç† ByteBuffer è£…è½½çš„æ™®é€šæ•°æ®å‘é€é€»è¾‘ã€‚</p> <p>å…¶ä¸­ case 1 è¡¨ç¤ºå½“å‰ Channel çš„ ChannelOutboundBuffer ä¸­åªåŒ…å«äº†ä¸€ä¸ª NioByteBuffer çš„æƒ…å†µã€‚</p> <p>default è¡¨ç¤ºå½“å‰ Channel çš„ ChannelOutboundBuffer ä¸­åŒ…å«äº†å¤šä¸ª NioByteBuffers çš„æƒ…å†µã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    protected void doWrite(ChannelOutboundBuffer in) throws Exception {      
        SocketChannel ch = javaChannel();
        int writeSpinCount = config().getWriteSpinCount();
        do {
  
            .........å°†å¾…å‘é€æ•°æ®è½¬æ¢åˆ°JDK NIO ByteBufferä¸­.........

            //æœ¬æ¬¡write loopä¸­éœ€è¦å‘é€çš„ JDK ByteBufferä¸ªæ•°
            int nioBufferCnt = in.nioBufferCount();

            switch (nioBufferCnt) {
                case 0:
                      ..........å¤„ç†ç½‘ç»œæ–‡ä»¶ä¼ è¾“.........
                case 1: {
                    ByteBuffer buffer = nioBuffers[0];
                    int attemptedBytes = buffer.remaining();
                    final int localWrittenBytes = ch.write(buffer);
                    if (localWrittenBytes &lt;= 0) {
                        //å¦‚æœå½“å‰Socketå‘é€ç¼“å†²åŒºæ»¡äº†å†™ä¸è¿›å»äº†ï¼Œåˆ™æ³¨å†ŒOP_WRITEäº‹ä»¶ï¼Œç­‰å¾…Socketå‘é€ç¼“å†²åŒºå¯å†™æ—¶ åœ¨å†™
                        // SubReactoråœ¨å¤„ç†OP_WRITEäº‹ä»¶æ—¶ï¼Œç›´æ¥è°ƒç”¨flushæ–¹æ³•
                        incompleteWrite(true);
                        return;
                    }
                    //æ ¹æ®å½“å‰å®é™…å†™å…¥æƒ…å†µè°ƒæ•´ maxBytesPerGatheringWriteæ•°å€¼
                    adjustMaxBytesPerGatheringWrite(attemptedBytes, localWrittenBytes, maxBytesPerGatheringWrite);
                    //å¦‚æœChannelOutboundBufferä¸­çš„æŸä¸ªEntryè¢«å…¨éƒ¨å†™å…¥ åˆ™åˆ é™¤è¯¥Entry
                    // å¦‚æœEntryè¢«å†™å…¥äº†ä¸€éƒ¨åˆ† è¿˜æœ‰ä¸€éƒ¨åˆ†æœªå†™å…¥  åˆ™æ›´æ–°Entryä¸­çš„readIndex ç­‰å¾…ä¸‹æ¬¡writeLoopç»§ç»­å†™å…¥
                    in.removeBytes(localWrittenBytes);
                    --writeSpinCount;
                    break;
                }
                default: {
                    // ChannelOutboundBufferä¸­æ€»å…±å¾…å†™å…¥æ•°æ®çš„å­—èŠ‚æ•°
                    long attemptedBytes = in.nioBufferSize();
                    //æ‰¹é‡å†™å…¥
                    final long localWrittenBytes = ch.write(nioBuffers, 0, nioBufferCnt);
                    if (localWrittenBytes &lt;= 0) {
                        incompleteWrite(true);
                        return;
                    }
                    //æ ¹æ®å®é™…å†™å…¥æƒ…å†µè°ƒæ•´ä¸€æ¬¡å†™å…¥æ•°æ®å¤§å°çš„æœ€å¤§å€¼
                    // maxBytesPerGatheringWriteå†³å®šæ¯æ¬¡å¯ä»¥ä»channelOutboundBufferä¸­è·å–å¤šå°‘å‘é€æ•°æ®
                    adjustMaxBytesPerGatheringWrite((int) attemptedBytes, (int) localWrittenBytes,
                            maxBytesPerGatheringWrite);
                    //ç§»é™¤å…¨éƒ¨å†™å®Œçš„BUfferï¼Œå¦‚æœåªå†™äº†éƒ¨åˆ†æ•°æ®åˆ™æ›´æ–°bufferçš„readerIndexï¼Œä¸‹ä¸€ä¸ªwriteLoopå†™å…¥
                    in.removeBytes(localWrittenBytes);
                    --writeSpinCount;
                    break;
                }            
            }
        } while (writeSpinCount &gt; 0);
        
        ............å¤„ç†æœ¬è½®write loopæœªå†™å®Œçš„æƒ…å†µ.......
    }
</code></pre></div><p>case 1 å’Œ default è¿™ä¸¤ä¸ªåˆ†æ”¯åœ¨å¤„ç†å‘é€æ•°æ®æ—¶çš„é€»è¾‘æ˜¯ä¸€æ ·çš„ï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯ case 1 æ˜¯å¤„ç†å•ä¸ª NioByteBuffer çš„å‘é€ï¼Œè€Œ default åˆ†æ”¯æ˜¯æ‰¹é‡å¤„ç†å¤šä¸ª NioByteBuffers çš„å‘é€ã€‚</p> <p>ä¸‹é¢ç¬”è€…å°±ä»¥ç»å¸¸è¢«è§¦å‘åˆ°çš„ default åˆ†æ”¯ä¸ºä¾‹æ¥ä¸ºå¤§å®¶è®²è¿° Netty åœ¨å¤„ç†æ•°æ®å‘é€æ—¶çš„é€»è¾‘ç»†èŠ‚ï¼š</p> <ol><li>é¦–å…ˆä»å½“å‰ NioSocketChannel ä¸­çš„ ChannelOutboundBuffer ä¸­è·å–æœ¬æ¬¡ write loop éœ€è¦å‘é€çš„å­—èŠ‚æ€»é‡ attemptedBytes ã€‚è¿™ä¸ª nioBufferSize æ˜¯åœ¨å‰è¾¹ä»‹ç» <code>ChannelOutboundBuffer#nioBuffers</code> æ–¹æ³•è½¬æ¢ JDK NIO ByteBuffer ç±»å‹æ—¶è¢«è®¡ç®—å‡ºæ¥çš„ã€‚</li> <li>è°ƒç”¨ JDK NIO åŸç”Ÿ SocketChannel æ‰¹é‡å‘é€ nioBuffers ä¸­çš„æ•°æ®ã€‚å¹¶è·å–åˆ°æœ¬æ¬¡ write loop ä¸€å…±æ‰¹é‡å‘é€äº†å¤šå°‘å­—èŠ‚ localWrittenBytes ã€‚</li></ol> <div class="language- extra-class"><pre class="language-text"><code>    /**
     * @throws  NotYetConnectedException
     *          If this channel is not yet connected
     */
    public abstract long write(ByteBuffer[] srcs, int offset, int length)
        throws IOException;
</code></pre></div><ol><li><code>localWrittenBytes &lt;= 0</code> è¡¨ç¤ºå½“å‰ Socket çš„å†™ç¼“å­˜åŒº SEND_BUF å·²æ»¡ï¼Œå†™ä¸è¿›æ•°æ®äº†ã€‚é‚£ä¹ˆå°±éœ€è¦å‘å½“å‰ NioSocketChannel å¯¹åº”çš„ Reactor æ³¨å†Œ OP_WRITE äº‹ä»¶ï¼Œå¹¶åœæ­¢å½“å‰ flush æµç¨‹ã€‚å½“ Socket çš„å†™ç¼“å†²åŒºæœ‰å®¹é‡å¯å†™æ—¶ï¼Œepoll ä¼šé€šçŸ¥ reactor çº¿ç¨‹ç»§ç»­å†™å…¥ã€‚</li></ol> <div class="language- extra-class"><pre class="language-text"><code>    protected final void incompleteWrite(boolean setOpWrite) {
        // Did not write completely.
        if (setOpWrite) {
            //è¿™é‡Œå¤„ç†è¿˜æ²¡å†™æ»¡16æ¬¡ ä½†æ˜¯socketç¼“å†²åŒºå·²æ»¡å†™ä¸è¿›å»çš„æƒ…å†µ æ³¨å†Œwriteäº‹ä»¶
            //ä»€ä¹ˆæ—¶å€™socketå¯å†™äº†ï¼Œ epollä¼šé€šçŸ¥reactorçº¿ç¨‹ç»§ç»­å†™
            setOpWrite();
        } else {
              ...........ç›®å‰è¿˜ä¸éœ€è¦å…³æ³¨è¿™é‡Œ.......
        }
    }
</code></pre></div><p>å‘ Reactor æ³¨å†Œ OP_WRITE äº‹ä»¶ï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>    protected final void setOpWrite() {
        final SelectionKey key = selectionKey();
        if (!key.isValid()) {
            return;
        }
        final int interestOps = key.interestOps();
        if ((interestOps &amp; SelectionKey.OP_WRITE) == 0) {
            key.interestOps(interestOps | SelectionKey.OP_WRITE);
        }
    }
</code></pre></div><blockquote><p>å…³äºé€šè¿‡ä½è¿ç®—æ¥å‘ IO äº‹ä»¶é›†åˆ interestOps æ·»åŠ ç›‘å¬ IO äº‹ä»¶çš„ç”¨æ³•ï¼Œåœ¨å‰è¾¹çš„æ–‡ç« ä¸­ï¼Œç¬”è€…å·²ç»å¤šæ¬¡ä»‹ç»è¿‡äº†ï¼Œè¿™é‡Œä¸å†é‡å¤ã€‚</p></blockquote> <ol><li>æ ¹æ®æœ¬æ¬¡ write loop å‘ Socket å†™ç¼“å†²åŒºå†™å…¥æ•°æ®çš„æƒ…å†µï¼Œæ¥è°ƒæ•´ä¸‹æ¬¡ write loop æœ€å¤§å†™å…¥å­—èŠ‚æ•°ã€‚maxBytesPerGatheringWrite å†³å®šæ¯æ¬¡ write loop å¯ä»¥ä» channelOutboundBuffer ä¸­æœ€å¤šè·å–å¤šå°‘å‘é€æ•°æ®ã€‚åˆå§‹å€¼ä¸º <code>SO_SNDBUFå¤§å° * 2 = 293976 = 146988 &lt;&lt; 1</code>ï¼Œæœ€å°å€¼ä¸º 2048ã€‚</li></ol> <div class="language- extra-class"><pre class="language-text"><code>    public static final int MAX_BYTES_PER_GATHERING_WRITE_ATTEMPTED_LOW_THRESHOLD = 4096;

    private void adjustMaxBytesPerGatheringWrite(int attempted, int written, int oldMaxBytesPerGatheringWrite) {
        if (attempted == written) {
            if (attempted &lt;&lt; 1 &gt; oldMaxBytesPerGatheringWrite) {
                ((NioSocketChannelConfig) config).setMaxBytesPerGatheringWrite(attempted &lt;&lt; 1);
            }
        } else if (attempted &gt; MAX_BYTES_PER_GATHERING_WRITE_ATTEMPTED_LOW_THRESHOLD &amp;&amp; written &lt; attempted &gt;&gt;&gt; 1) {
            ((NioSocketChannelConfig) config).setMaxBytesPerGatheringWrite(attempted &gt;&gt;&gt; 1);
        }
    }
</code></pre></div><blockquote><p>ç”±äºæ“ä½œç³»ç»Ÿä¼šåŠ¨æ€è°ƒæ•´ SO_SNDBUF çš„å¤§å°ï¼Œæ‰€ä»¥è¿™é‡Œ netty ä¹Ÿéœ€è¦æ ¹æ®æ“ä½œç³»ç»Ÿçš„åŠ¨æ€è°ƒæ•´åšå‡ºç›¸åº”çš„è°ƒæ•´ï¼Œç›®çš„æ˜¯å°½é‡å¤šçš„å»å†™å…¥æ•°æ®ã€‚</p></blockquote> <p><code>attempted == written</code> è¡¨ç¤ºæœ¬æ¬¡ write loop å°è¯•å†™å…¥çš„æ•°æ®èƒ½å…¨éƒ¨å†™å…¥åˆ° Socket çš„å†™ç¼“å†²åŒºä¸­ï¼Œé‚£ä¹ˆä¸‹æ¬¡ write loop å°±åº”è¯¥å°è¯•å»å†™å…¥æ›´å¤šçš„æ•°æ®ã€‚</p> <p><strong>é‚£ä¹ˆè¿™é‡Œçš„æ›´å¤šå…·ä½“æ˜¯å¤šå°‘å‘¢ï¼Ÿ</strong></p> <p>Netty ä¼šå°†æœ¬æ¬¡å†™å…¥çš„æ•°æ®é‡ written æ‰©å¤§ä¸¤å€ï¼Œå¦‚æœæ‰©å¤§ä¸¤å€åçš„å†™å…¥é‡å¤§äºæœ¬æ¬¡ write loop çš„æœ€å¤§é™åˆ¶å†™å…¥é‡ maxBytesPerGatheringWriteï¼Œè¯´æ˜ç”¨æˆ·çš„å†™å…¥éœ€æ±‚å¾ˆçŒ›çƒˆï¼ŒNettyå½“ç„¶è¦æ»¡è¶³è¿™æ ·çš„çŒ›çƒˆéœ€æ±‚ï¼Œé‚£ä¹ˆå°±å°†å½“å‰ NioSocketChannelConfig ä¸­çš„ maxBytesPerGatheringWrite æ›´æ–°ä¸ºæœ¬æ¬¡ write loop ä¸¤å€çš„å†™å…¥é‡å¤§å°ã€‚</p> <p>åœ¨ä¸‹æ¬¡ write loop å†™å…¥æ•°æ®çš„æ—¶å€™ï¼Œå°±ä¼šå°è¯•ä» ChannelOutboundBuffer ä¸­åŠ è½½æœ€å¤š <code>written * 2</code> å¤§å°çš„å­—èŠ‚æ•°ã€‚</p> <p>å¦‚æœæ‰©å¤§ä¸¤å€åçš„å†™å…¥é‡ä¾ç„¶å°äºç­‰äºæœ¬æ¬¡ write loop çš„æœ€å¤§é™åˆ¶å†™å…¥é‡ maxBytesPerGatheringWriteï¼Œè¯´æ˜ç”¨æˆ·çš„å†™å…¥éœ€æ±‚è¿˜ä¸æ˜¯å¾ˆçŒ›çƒˆï¼ŒNetty ç»§ç»­ç»´æŒæœ¬æ¬¡ maxBytesPerGatheringWrite æ•°å€¼ä¸å˜ã€‚</p> <p><strong>å¦‚æœæœ¬æ¬¡å†™å…¥çš„æ•°æ®è¿˜ä¸åŠå°è¯•å†™å…¥æ•°æ®çš„ 1 / 2</strong> ï¼š<code>written &lt; attempted &gt;&gt;&gt; 1</code>ã€‚è¯´æ˜å½“å‰ Socket å†™ç¼“å†²åŒºçš„å¯å†™å®¹é‡ä¸æ˜¯å¾ˆå¤šäº†ï¼Œä¸‹ä¸€æ¬¡ write loop å°±ä¸è¦å†™è¿™ä¹ˆå¤šäº†å°è¯•å‡å°‘ä¸‹æ¬¡å†™å…¥çš„é‡å°†ä¸‹æ¬¡ write loop è¦å†™å…¥çš„æ•°æ®å‡å°ä¸º attempted çš„1 / 2ã€‚å½“ç„¶ä¹Ÿä¸èƒ½æ— é™åˆ¶çš„å‡å°ï¼Œæœ€å°å€¼ä¸èƒ½ä½äº 2048ã€‚</p> <blockquote><p>è¿™é‡Œå¯ä»¥ç»“åˆç¬”è€…å‰è¾¹çš„æ–‡ç« <a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484244&amp;idx=1&amp;sn=831060fc38caa201d69f87305de7f86a&amp;chksm=ce77c513f9004c05b48f849ff99997d6d7252453135ae856a029137b88aa70b8e046013d596e&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€Šä¸€æ–‡èŠé€ByteBufferåŠ¨æ€è‡ªé€‚åº”æ‰©ç¼©å®¹æœºåˆ¶ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸­ä»‹ç»åˆ°çš„ read loop åœºæ™¯ä¸­çš„æ‰©ç¼©å®¹ä¸€èµ·å¯¹æ¯”ç€çœ‹ã€‚</p></blockquote> <blockquote><p>read loop ä¸­çš„æ‰©ç¼©å®¹è§¦å‘æ—¶æœºæ˜¯åœ¨ä¸€ä¸ªå®Œæ•´çš„ read loop ç»“æŸæ—¶å€™è§¦å‘ã€‚è€Œ write loop ä¸­æ‰©ç¼©å®¹çš„è§¦å‘æ—¶æœºæ˜¯åœ¨æ¯æ¬¡ write loop å‘é€å®Œæ•°æ®åï¼Œç«‹å³è§¦å‘æ‰©ç¼©å®¹åˆ¤æ–­ã€‚</p></blockquote> <ol><li>å½“æœ¬æ¬¡ write loop æ‰¹é‡å‘é€å®Œ ChannelOutboundBuffer ä¸­çš„æ•°æ®ä¹‹åï¼Œæœ€åè°ƒç”¨<code>in.removeBytes(localWrittenBytes)</code> ä» ChannelOutboundBuffer ä¸­ç§»é™¤å…¨éƒ¨å†™å®Œçš„ Entry ï¼Œå¦‚æœåªå‘é€äº† Entry çš„éƒ¨åˆ†æ•°æ®åˆ™æ›´æ–° Entry å¯¹è±¡ä¸­å°è£…çš„ DirectByteBuffer çš„ readerIndexï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡ write loop å†™å…¥ã€‚</li></ol> <p>åˆ°è¿™é‡Œï¼Œwrite loop ä¸­çš„å‘é€æ•°æ®çš„é€»è¾‘å°±ä»‹ç»å®Œäº†ï¼Œæ¥ä¸‹æ¥ Netty ä¼šåœ¨ write loop ä¸­å¾ªç¯åœ°å‘é€æ•°æ®ç›´åˆ°å†™æ»¡ 16 æ¬¡æˆ–è€…æ•°æ®å‘é€å®Œæ¯•ã€‚</p> <p>è¿˜æœ‰ä¸€ç§é€€å‡º write loop çš„æƒ…å†µå°±æ˜¯å½“ Socket ä¸­çš„å†™ç¼“å†²åŒºæ»¡äº†ï¼Œæ— æ³•åœ¨å†™å…¥æ—¶ã€‚Netty ä¼šé€€å‡º write loop å¹¶å‘ reactor æ³¨å†Œ OP_WRITE äº‹ä»¶ã€‚</p> <p>ä½†è¿™å…¶ä¸­è¿˜éšè—ç€ä¸€ç§æƒ…å†µå°±æ˜¯å¦‚æœ write loop å·²ç»å†™æ»¡ 16 æ¬¡ä½†è¿˜æ²¡å†™å®Œæ•°æ®å¹¶ä¸”æ­¤æ—¶ Socket å†™ç¼“å†²åŒºè¿˜æ²¡æœ‰æ»¡ï¼Œè¿˜å¯ä»¥ç»§ç»­åœ¨å†™ã€‚é‚£ Netty ä¼šå¦‚ä½•å¤„ç†è¿™ç§æƒ…å†µå‘¢ï¼Ÿ</p> <h2 id="_6-å¤„ç†socketå¯å†™ä½†å·²ç»å†™æ»¡16æ¬¡è¿˜æ²¡å†™å®Œçš„æƒ…å†µ"><a href="#_6-å¤„ç†socketå¯å†™ä½†å·²ç»å†™æ»¡16æ¬¡è¿˜æ²¡å†™å®Œçš„æƒ…å†µ" class="header-anchor">#</a> 6. å¤„ç†Socketå¯å†™ä½†å·²ç»å†™æ»¡16æ¬¡è¿˜æ²¡å†™å®Œçš„æƒ…å†µ</h2> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    protected void doWrite(ChannelOutboundBuffer in) throws Exception {      
        SocketChannel ch = javaChannel();
        int writeSpinCount = config().getWriteSpinCount();
        do {
  
            .........å°†å¾…å‘é€æ•°æ®è½¬æ¢åˆ°JDK NIO ByteBufferä¸­.........

            int nioBufferCnt = in.nioBufferCount();

            switch (nioBufferCnt) {
                case 0:
                    //è¿™é‡Œä¸»è¦æ˜¯é’ˆå¯¹ ç½‘ç»œä¼ è¾“æ–‡ä»¶æ•°æ® çš„å¤„ç† FileRegion                 
                    writeSpinCount -= doWrite0(in);
                    break;
                case 1: {
                      .....å‘é€å•ä¸ªnioBuffer....
                }
                default: {
                      .....æ‰¹é‡å‘é€å¤šä¸ªnioBuffers......
                }            
            }
        } while (writeSpinCount &gt; 0);
        
        //å¤„ç†write loopç»“æŸ ä½†æ•°æ®è¿˜æ²¡å†™å®Œçš„æƒ…å†µ
        incompleteWrite(writeSpinCount &lt; 0);
    }
</code></pre></div><p>å½“ write loop ç»“æŸåï¼Œè¿™æ—¶ writeSpinCount çš„å€¼ä¼šæœ‰ä¸¤ç§æƒ…å†µï¼š</p> <ul><li><code>writeSpinCount &lt; 0</code>ï¼šè¿™ç§æƒ…å†µæœ‰ç‚¹ä¸å¥½ç†è§£ï¼Œæˆ‘ä»¬åœ¨ä»‹ç» Netty é€šè¿‡é›¶æ‹·è´çš„æ–¹å¼ä¼ è¾“ç½‘ç»œæ–‡ä»¶ä¹Ÿå°±æ˜¯è¿™é‡Œçš„ case 0 åˆ†æ”¯é€»è¾‘æ—¶ï¼Œè¯¦ç»†ä»‹ç»äº† doWrite0 æ–¹æ³•çš„å‡ ç§è¿”å›å€¼ï¼Œå½“ Netty åœ¨ä¼ è¾“æ–‡ä»¶çš„è¿‡ç¨‹ä¸­å‘ç° Socket ç¼“å†²åŒºå·²æ»¡æ— æ³•åœ¨ç»§ç»­å†™å…¥æ•°æ®æ—¶ï¼Œä¼šè¿”å› <code>WRITE_STATUS_SNDBUF_FULL = Integer.MAX_VALUE</code>ï¼Œè¿™å°±ä½¿å¾— <code>writeSpinCountçš„å€¼ &lt; 0</code>ã€‚éšå break æ‰ write loop æ¥åˆ° <code>incompleteWrite(writeSpinCount &lt; 0)</code> æ–¹æ³•ä¸­ï¼Œæœ€åä¼šåœ¨ incompleteWrite æ–¹æ³•ä¸­å‘ reactor æ³¨å†Œ OP_WRITE äº‹ä»¶ã€‚å½“ Socket ç¼“å†²åŒºå˜å¾—å¯å†™æ—¶ï¼Œepoll ä¼šé€šçŸ¥ reactor çº¿ç¨‹ç»§ç»­å‘é€æ–‡ä»¶ã€‚</li></ul> <div class="language- extra-class"><pre class="language-text"><code>    protected final void incompleteWrite(boolean setOpWrite) {
        // Did not write completely.
        if (setOpWrite) {
            //è¿™é‡Œå¤„ç†è¿˜æ²¡å†™æ»¡16æ¬¡ ä½†æ˜¯socketç¼“å†²åŒºå·²æ»¡å†™ä¸è¿›å»çš„æƒ…å†µ æ³¨å†Œwriteäº‹ä»¶
            // ä»€ä¹ˆæ—¶å€™socketå¯å†™äº†ï¼Œ epollä¼šé€šçŸ¥reactorçº¿ç¨‹ç»§ç»­å†™
            setOpWrite();
        } else {
            ..............
        }
    }
</code></pre></div><ul><li><code>writeSpinCount == 0</code>ï¼šè¿™ç§æƒ…å†µå¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯å·²ç»å†™æ»¡äº† 16 æ¬¡ï¼Œä½†æ˜¯è¿˜æ²¡å†™å®Œï¼ŒåŒæ—¶ Socket çš„å†™ç¼“å†²åŒºæœªæ»¡ï¼Œè¿˜å¯ä»¥ç»§ç»­å†™å…¥ã€‚è¿™ç§æƒ…å†µä¸‹å³ä½¿ Socket è¿˜å¯ä»¥ç»§ç»­å†™å…¥ï¼ŒNetty ä¹Ÿä¸ä¼šå†å»å†™äº†ï¼Œå› ä¸ºæ‰§è¡Œ flush æ“ä½œçš„æ˜¯ reactor çº¿ç¨‹ï¼Œè€Œ reactor çº¿ç¨‹è´Ÿè´£æ‰§è¡Œæ³¨å†Œåœ¨å®ƒä¸Šè¾¹çš„æ‰€æœ‰ channel çš„ IO æ“ä½œï¼ŒNetty ä¸ä¼šå…è®¸ reactor çº¿ç¨‹ä¸€ç›´åœ¨ä¸€ä¸ª channel ä¸Šæ‰§è¡Œ IO æ“ä½œï¼Œreactor çº¿ç¨‹çš„æ‰§è¡Œæ—¶é—´éœ€è¦å‡åŒ€çš„åˆ†é…åˆ°æ¯ä¸ª channel ä¸Šã€‚æ‰€ä»¥è¿™é‡Œ Netty ä¼šåœä¸‹ï¼Œè½¬è€Œå»å¤„ç†å…¶ä»– channel ä¸Šçš„ IO äº‹ä»¶ã€‚</li></ul> <p><strong>é‚£ä¹ˆè¿˜æ²¡å†™å®Œçš„æ•°æ®ï¼ŒNettyä¼šå¦‚ä½•å¤„ç†å‘¢</strong>ï¼Ÿ</p> <div class="language- extra-class"><pre class="language-text"><code>    protected final void incompleteWrite(boolean setOpWrite) {
        // Did not write completely.
        if (setOpWrite) {
            //è¿™é‡Œå¤„ç†è¿˜æ²¡å†™æ»¡16æ¬¡ ä½†æ˜¯socketç¼“å†²åŒºå·²æ»¡å†™ä¸è¿›å»çš„æƒ…å†µ æ³¨å†Œwriteäº‹ä»¶
            // ä»€ä¹ˆæ—¶å€™socketå¯å†™äº†ï¼Œ epollä¼šé€šçŸ¥reactorçº¿ç¨‹ç»§ç»­å†™
            setOpWrite();
        } else {
            //è¿™é‡Œå¤„ç†çš„æ˜¯socketç¼“å†²åŒºä¾ç„¶å¯å†™ï¼Œä½†æ˜¯å†™äº†16æ¬¡è¿˜æ²¡å†™å®Œï¼Œè¿™æ—¶å°±ä¸èƒ½åœ¨å†™äº†ï¼Œreactorçº¿ç¨‹éœ€è¦å¤„ç†å…¶ä»–channelä¸Šçš„ioäº‹ä»¶

            //å› ä¸ºæ­¤æ—¶socketæ˜¯å¯å†™çš„ï¼Œå¿…é¡»æ¸…é™¤op_writeäº‹ä»¶ï¼Œå¦åˆ™ä¼šä¸€ç›´ä¸åœåœ°è¢«é€šçŸ¥
            clearOpWrite();
            //å¦‚æœæœ¬æ¬¡writeLoopè¿˜æ²¡å†™å®Œï¼Œåˆ™æäº¤flushTaskåˆ°reactor           
            eventLoop().execute(flushTask);

        }
</code></pre></div><p>è¿™ä¸ªæ–¹æ³•çš„ if åˆ†æ”¯é€»è¾‘ï¼Œæˆ‘ä»¬åœ¨ä»‹ç»<code>do {.....}while()</code>å¾ªç¯ä½“ write loop ä¸­å‘é€é€»è¾‘æ—¶å·²ç»æè¿‡ï¼Œåœ¨ write loop å¾ªç¯å‘é€æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå‘ç° Socket ç¼“å†²åŒºå·²æ»¡ï¼Œæ— æ³•å†™å…¥æ•°æ®æ—¶ï¼ˆ localWrittenBytes &lt;= 0ï¼‰ï¼Œåˆ™éœ€è¦å‘ reactor æ³¨å†Œ OP_WRITE äº‹ä»¶ï¼Œç­‰åˆ° Socket ç¼“å†²åŒºå˜ä¸ºå¯å†™çŠ¶æ€æ—¶ï¼Œepoll ä¼šé€šçŸ¥ reactor çº¿ç¨‹ç»§ç»­å†™å…¥å‰©ä¸‹çš„æ•°æ®ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>       do {
            .........å°†å¾…å‘é€æ•°æ®è½¬æ¢åˆ°JDK NIO ByteBufferä¸­.........

            int nioBufferCnt = in.nioBufferCount();

            switch (nioBufferCnt) {
                case 0:
                    writeSpinCount -= doWrite0(in);
                    break;
                case 1: {
                    .....å‘é€å•ä¸ªnioBuffer....
                    final int localWrittenBytes = ch.write(buffer);
                    if (localWrittenBytes &lt;= 0) {
                        incompleteWrite(true);
                        return;
                    }
                    .................çœç•¥..............
                    break;
                }
                default: {
                    .....æ‰¹é‡å‘é€å¤šä¸ªnioBuffers......
                    final long localWrittenBytes = ch.write(nioBuffers, 0, nioBufferCnt);
                    if (localWrittenBytes &lt;= 0) {
                        incompleteWrite(true);
                        return;
                    }
                    .................çœç•¥..............
                    break;
                }
            }
        } while (writeSpinCount &gt; 0);
</code></pre></div><blockquote><p>æ³¨æ„ if åˆ†æ”¯å¤„ç†çš„æƒ…å†µæ˜¯è¿˜æ²¡å†™æ»¡ 16 æ¬¡ï¼Œä½†æ˜¯ Socket ç¼“å†²åŒºå·²æ»¡ï¼Œæ— æ³•å†™å…¥çš„æƒ…å†µã€‚</p></blockquote> <p>è€Œ else åˆ†æ”¯æ­£æ˜¯å¤„ç†æˆ‘ä»¬è¿™é‡Œæ­£åœ¨è®¨è®ºçš„æƒ…å†µå³ Socket ç¼“å†²åŒºæ˜¯å¯å†™çš„ï¼Œä½†æ˜¯å·²ç»å†™æ»¡ 16 æ¬¡ï¼Œåœ¨æœ¬è½® write loop ä¸­ä¸èƒ½å†ç»§ç»­å†™å…¥çš„æƒ…å†µã€‚</p> <p>è¿™æ—¶ Netty ä¼šå°† channel ä¸­å‰©ä¸‹çš„å¾…å†™æ•°æ®çš„ flush æ“ä½œå°è£…ç¨‹ flushTaskï¼Œä¸¢è¿› reactor çš„æ™®é€šä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾… reactor æ‰§è¡Œå®Œå…¶ä»– channel ä¸Šçš„ io æ“ä½œååœ¨å›è¿‡å¤´æ¥æ‰§è¡Œæœªå†™å®Œçš„ flush ä»»åŠ¡ã€‚</p> <blockquote><p>å¿˜è®° Reactor æ•´ä½“è¿è¡Œé€»è¾‘çš„åŒå­¦ï¼Œå¯ä»¥åœ¨å›çœ‹ä¸‹ç¬”è€…çš„è¿™ç¯‡æ–‡ç« <a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484087&amp;idx=1&amp;sn=0c065780e0f05c23c8e6465ede86cba0&amp;chksm=ce77c4f0f9004de63be369a664105708bc5975b52993f4a6df223caed34cc1ef6185a16acd75&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€Šä¸€æ–‡èŠé€Nettyæ ¸å¿ƒå¼•æ“Reactorçš„è¿è½¬æ¶æ„ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>    private final Runnable flushTask = new Runnable() {
        @Override
        public void run() {
            ((AbstractNioUnsafe) unsafe()).flush0();
        }
    };
</code></pre></div><p>è¿™é‡Œæˆ‘ä»¬çœ‹åˆ° flushTask ä¸­çš„ä»»åŠ¡æ˜¯ç›´æ¥å†æ¬¡è°ƒç”¨ flush0 ç»§ç»­å›åˆ°å‘é€æ•°æ®çš„é€»è¾‘æµç¨‹ä¸­ã€‚</p> <p><strong>ç»†å¿ƒçš„åŒå­¦å¯èƒ½ä¼šæœ‰ç–‘é—®ï¼Œä¸ºä»€ä¹ˆè¿™é‡Œä¸åœ¨ç»§ç»­æ³¨å†Œ OP_WRITE äº‹ä»¶è€Œæ˜¯é€šè¿‡å‘ reactor æäº¤ä¸€ä¸ª flushTask æ¥å®Œæˆ channel ä¸­å‰©ä¸‹æ•°æ®çš„å†™å…¥å‘¢ï¼Ÿ</strong></p> <p>åŸå› æ˜¯è¿™é‡Œæˆ‘ä»¬è®²çš„ else åˆ†æ”¯æ˜¯ç”¨æ¥å¤„ç† Socket ç¼“å†²åŒºæœªæ»¡è¿˜æ˜¯å¯å†™çš„ï¼Œä½†æ˜¯ç”±äºç”¨æˆ·æœ¬æ¬¡è¦å‘é€çš„æ•°æ®å¤ªå¤šï¼Œå¯¼è‡´å†™äº† 16 æ¬¡è¿˜æ²¡å†™å®Œçš„æƒ…å½¢ã€‚</p> <p><strong>æ—¢ç„¶å½“å‰ Socket ç¼“å†²åŒºæ˜¯å¯å†™çš„ï¼Œæˆ‘ä»¬å°±ä¸èƒ½æ³¨å†Œ OP_WRITE äº‹ä»¶ï¼Œå¦åˆ™è¿™é‡Œä¸€ç›´ä¼šä¸åœåœ°æ”¶åˆ° epoll çš„é€šçŸ¥ã€‚å› ä¸º JDK NIO Selector é»˜è®¤çš„æ˜¯ epoll çš„æ°´å¹³è§¦å‘ã€‚</strong></p> <blockquote><p>å¿˜è®°æ°´å¹³è§¦å‘å’Œè¾¹ç¼˜è§¦å‘è¿™ä¸¤ç§ epoll å·¥ä½œæ¨¡å¼çš„åŒå­¦ï¼Œå¯ä»¥åœ¨å›çœ‹ä¸‹ç¬”è€…çš„è¿™ç¯‡æ–‡ç« <a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247483737&amp;idx=1&amp;sn=7ef3afbb54289c6e839eed724bb8a9d6&amp;chksm=ce77c71ef9004e08e3d164561e3a2708fc210c05408fa41f7fe338d8e85f39c1ad57519b614e&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€ŠèŠèŠNettyé‚£äº›äº‹å„¿ä¹‹ä»å†…æ ¸è§’åº¦çœ‹IOæ¨¡å‹ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>æ‰€ä»¥è¿™é‡Œåªèƒ½å‘ reactor æäº¤ flushTask æ¥ç»§ç»­å®Œæˆå‰©ä¸‹æ•°æ®çš„å†™å…¥ï¼Œè€Œä¸èƒ½æ³¨å†Œ OP_WRITE äº‹ä»¶ã€‚</p> <blockquote><p>æ³¨æ„ï¼šåªæœ‰å½“ Socket ç¼“å†²åŒºå·²æ»¡å¯¼è‡´æ— æ³•å†™å…¥æ—¶ï¼ŒNetty æ‰ä¼šå»æ³¨å†Œ OP_WRITE äº‹ä»¶ã€‚è¿™å’Œæˆ‘ä»¬ä¹‹å‰ä»‹ç»çš„ OP_ACCEPT äº‹ä»¶å’Œ OP_READ äº‹ä»¶çš„æ³¨å†Œæ—¶æœºæ˜¯ä¸åŒçš„ã€‚</p></blockquote> <p><strong>è¿™é‡Œå¤§å®¶å¯èƒ½è¿˜ä¼šæœ‰å¦ä¸€ä¸ªç–‘é—®ï¼Œå°±æ˜¯ä¸ºä»€ä¹ˆåœ¨å‘ reactor æäº¤ flushTask ä¹‹å‰éœ€è¦æ¸…ç† OP_WRITE äº‹ä»¶å‘¢ï¼Ÿ</strong> æˆ‘ä»¬å¹¶æ²¡æœ‰æ³¨å†Œ OP_WRITE äº‹ä»¶å‘€~~</p> <div class="language- extra-class"><pre class="language-text"><code>    protected final void incompleteWrite(boolean setOpWrite) {
        if (setOpWrite) {
            ......çœç•¥......
        } else {
            clearOpWrite();  
            eventLoop().execute(flushTask);
        }
</code></pre></div><p>åœ¨ä¸ºå¤§å®¶è§£ç­”è¿™ä¸ªç–‘é—®ä¹‹å‰ï¼Œç¬”è€…å…ˆä¸ºå¤§å®¶ä»‹ç»ä¸‹ Netty æ˜¯å¦‚ä½•å¤„ç† OP_WRITE äº‹ä»¶çš„ï¼Œå½“å¤§å®¶æ˜ç™½äº† OP_WRITE äº‹ä»¶çš„å¤„ç†é€»è¾‘åï¼Œè¿™ä¸ªç–‘é—®å°±è‡ªç„¶è§£å¼€äº†ã€‚</p> <h2 id="_7-op-writeäº‹ä»¶çš„å¤„ç†"><a href="#_7-op-writeäº‹ä»¶çš„å¤„ç†" class="header-anchor">#</a> 7. OP_WRITEäº‹ä»¶çš„å¤„ç†</h2> <p>åœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484087&amp;idx=1&amp;sn=0c065780e0f05c23c8e6465ede86cba0&amp;chksm=ce77c4f0f9004de63be369a664105708bc5975b52993f4a6df223caed34cc1ef6185a16acd75&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?ã€Šä¸€æ–‡èŠé€Nettyæ ¸å¿ƒå¼•æ“Reactorçš„è¿è½¬æ¶æ„ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»è¿‡ï¼Œå½“ Reactor ç›‘å¬åˆ° channel ä¸Šæœ‰ IO äº‹ä»¶å‘ç”Ÿåï¼Œæœ€ç»ˆä¼šåœ¨ processSelectedKey æ–¹æ³•ä¸­å¤„ç† channel ä¸Šçš„ IO äº‹ä»¶ï¼Œå…¶ä¸­ OP_ACCEPT äº‹ä»¶å’Œ OP_READ äº‹ä»¶çš„å¤„ç†è¿‡ç¨‹ï¼Œç¬”è€…å·²ç»åœ¨ä¹‹å‰çš„ç³»åˆ—æ–‡ç« ä¸­ä»‹ç»è¿‡äº†ï¼Œè¿™é‡Œæˆ‘ä»¬èšç„¦äº OP_WRITE äº‹ä»¶çš„å¤„ç†ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public final class NioEventLoop extends SingleThreadEventLoop {

   private void processSelectedKey(SelectionKey k, AbstractNioChannel ch) {
        final AbstractNioChannel.NioUnsafe unsafe = ch.unsafe();

        .............çœç•¥.......

        try {
            int readyOps = k.readyOps();

            if ((readyOps &amp; SelectionKey.OP_CONNECT) != 0) {
                  ......å¤„ç†connectäº‹ä»¶......
            }

            if ((readyOps &amp; SelectionKey.OP_WRITE) != 0) {
                ch.unsafe().forceFlush();
            }
 
            if ((readyOps &amp; (SelectionKey.OP_READ | SelectionKey.OP_ACCEPT)) != 0 || readyOps == 0) {
               ........å¤„ç†acceptå’Œreadäº‹ä»¶.........
            }
        } catch (CancelledKeyException ignored) {
            unsafe.close(unsafe.voidPromise());
        }
    }

}
</code></pre></div><p>è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°å½“ OP_WRITE äº‹ä»¶å‘ç”Ÿåï¼ŒNetty ç›´æ¥è°ƒç”¨ channel çš„ forceFlush æ–¹æ³•ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>       @Override
        public final void forceFlush() {
            // directly call super.flush0() to force a flush now
            super.flush0();
        }
</code></pre></div><p>å…¶å® forceFlush æ–¹æ³•ä¸­å¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šçš„é€»è¾‘ï¼Œç›´æ¥è°ƒç”¨ flush0 æ–¹æ³•å†æ¬¡å‘èµ· flush æ“ä½œç»§ç»­ channel ä¸­å‰©ä¸‹æ•°æ®çš„å†™å…¥ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    protected void doWrite(ChannelOutboundBuffer in) throws Exception {      
        SocketChannel ch = javaChannel();
        int writeSpinCount = config().getWriteSpinCount();
        do {
            if (in.isEmpty()) {
                clearOpWrite();
                return;
            }
            .........å°†å¾…å‘é€æ•°æ®è½¬æ¢åˆ°JDK NIO ByteBufferä¸­.........

            int nioBufferCnt = in.nioBufferCount();

            switch (nioBufferCnt) {
                case 0:
                      ......ä¼ è¾“ç½‘ç»œæ–‡ä»¶........
                case 1: {
                      .....å‘é€å•ä¸ªnioBuffer....
                }
                default: {
                      .....æ‰¹é‡å‘é€å¤šä¸ªnioBuffers......
                }            
            }
        } while (writeSpinCount &gt; 0);
        
        //å¤„ç†write loopç»“æŸ ä½†æ•°æ®è¿˜æ²¡å†™å®Œçš„æƒ…å†µ
        incompleteWrite(writeSpinCount &lt; 0);
    }
</code></pre></div><p>æ³¨æ„è¿™é‡Œçš„ clearOpWrite() æ–¹æ³•ï¼Œç”±äº channel ä¸Šçš„ OP_WRITE äº‹ä»¶å°±ç»ªï¼Œè¡¨æ˜æ­¤æ—¶ Socket ç¼“å†²åŒºå˜ä¸ºå¯å†™çŠ¶æ€ï¼Œä»è€Œ Reactor çº¿ç¨‹å†æ¬¡æ¥åˆ°äº† flush æµç¨‹ä¸­ã€‚</p> <p>å½“ ChannelOutboundBuffer ä¸­çš„æ•°æ®å…¨éƒ¨å†™å®Œå in.isEmpty() ï¼Œå°±éœ€è¦æ¸…ç† OP_WRITE äº‹ä»¶ï¼Œå› ä¸ºæ­¤æ—¶ Socket ç¼“å†²åŒºæ˜¯å¯å†™çš„ï¼Œè¿™ç§æƒ…å†µä¸‹å½“æ•°æ®å…¨éƒ¨å†™å®Œåï¼Œå°±éœ€è¦å–æ¶ˆå¯¹ OP_WRITE äº‹ä»¶çš„ç›‘å¬ï¼Œå¦åˆ™ epoll ä¼šä¸æ–­çš„é€šçŸ¥ Reactorã€‚</p> <p>åŒç†åœ¨ incompleteWrite æ–¹æ³•çš„ else åˆ†æ”¯ä¹Ÿéœ€è¦æ‰§è¡Œ clearOpWrite() æ–¹æ³•å–æ¶ˆå¯¹ OP_WRITE äº‹ä»¶çš„ç›‘å¬ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    protected final void incompleteWrite(boolean setOpWrite) {

        if (setOpWrite) {
            // è¿™é‡Œå¤„ç†è¿˜æ²¡å†™æ»¡16æ¬¡ ä½†æ˜¯socketç¼“å†²åŒºå·²æ»¡å†™ä¸è¿›å»çš„æƒ…å†µ æ³¨å†Œwriteäº‹ä»¶
            // ä»€ä¹ˆæ—¶å€™socketå¯å†™äº†ï¼Œ epollä¼šé€šçŸ¥reactorçº¿ç¨‹ç»§ç»­å†™
            setOpWrite();
        } else {
            // å¿…é¡»æ¸…é™¤OP_WRITEäº‹ä»¶ï¼Œæ­¤æ—¶Socketå¯¹åº”çš„ç¼“å†²åŒºä¾ç„¶æ˜¯å¯å†™çš„ï¼Œåªä¸è¿‡å½“å‰channelå†™å¤Ÿäº†16æ¬¡ï¼Œè¢«SubReactoré™åˆ¶äº†ã€‚
            // è¿™æ ·SubReactorå¯ä»¥è…¾å‡ºæ‰‹æ¥å¤„ç†å…¶ä»–channelä¸Šçš„IOäº‹ä»¶ã€‚è¿™é‡Œå¦‚æœä¸æ¸…é™¤OP_WRITEäº‹ä»¶ï¼Œåˆ™ä¼šä¸€ç›´è¢«é€šçŸ¥ã€‚
            clearOpWrite();

            //å¦‚æœæœ¬æ¬¡writeLoopè¿˜æ²¡å†™å®Œï¼Œåˆ™æäº¤flushTaskåˆ°SubReactor
            //é‡Šæ”¾SubReactorè®©å…¶å¯ä»¥ç»§ç»­å¤„ç†å…¶ä»–Channelä¸Šçš„IOäº‹ä»¶
            eventLoop().execute(flushTask);
        }
    }
</code></pre></div><h2 id="_8-writeandflush"><a href="#_8-writeandflush" class="header-anchor">#</a> 8. writeAndFlush</h2> <p>åœ¨æˆ‘ä»¬è®²å®Œäº† write äº‹ä»¶å’Œ flush äº‹ä»¶çš„å¤„ç†è¿‡ç¨‹ä¹‹åï¼ŒwriteAndFlush å°±å˜å¾—å¾ˆç®€å•äº†ï¼Œå®ƒå°±æ˜¯æŠŠ write å’Œ flush æµç¨‹ç»“åˆèµ·æ¥ï¼Œå…ˆè§¦å‘ write äº‹ä»¶ç„¶ååœ¨è§¦å‘ flush äº‹ä»¶ã€‚</p> <p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹ writeAndFlush çš„å…·ä½“é€»è¾‘å¤„ç†ï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>public class EchoServerHandler extends ChannelInboundHandlerAdapter {

    @Override
    public void channelRead(final ChannelHandlerContext ctx, final Object msg) {
        //æ­¤å¤„çš„msgå°±æ˜¯Nettyåœ¨read loopä¸­ä»NioSocketChannelä¸­è¯»å–åˆ°ByteBuffer
        ctx.writeAndFlush(msg);
    }
}
abstract class AbstractChannelHandlerContext implements ChannelHandlerContext, ResourceLeakHint {

    @Override
    public ChannelFuture writeAndFlush(Object msg) {
        return writeAndFlush(msg, newPromise());
    }

    @Override
    public ChannelFuture writeAndFlush(Object msg, ChannelPromise promise) {
        write(msg, true, promise);
        return promise;
    }

}
</code></pre></div><p>è¿™é‡Œå¯ä»¥çœ‹åˆ° writeAndFlush æ–¹æ³•çš„å¤„ç†å…¥å£å’Œ write äº‹ä»¶çš„å¤„ç†å…¥å£æ˜¯ä¸€æ ·çš„ã€‚å”¯ä¸€ä¸åŒçš„æ˜¯å…¥å£å¤„ç†å‡½æ•° write æ–¹æ³•çš„ boolean flush å…¥å‚ä¸åŒï¼Œåœ¨ writeAndFlush çš„å¤„ç†ä¸­ flush = trueã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private void write(Object msg, boolean flush, ChannelPromise promise) {
        ObjectUtil.checkNotNull(msg, &quot;msg&quot;);

        ................çœç•¥æ£€æŸ¥promiseçš„æœ‰æ•ˆæ€§...............

        //flush = true è¡¨ç¤ºchannelHandlerä¸­è°ƒç”¨çš„æ˜¯writeAndFlushæ–¹æ³•ï¼Œè¿™é‡Œéœ€è¦æ‰¾åˆ°pipelineä¸­è¦†ç›–writeæˆ–è€…flushæ–¹æ³•çš„channelHandler
        //flush = false è¡¨ç¤ºè°ƒç”¨çš„æ˜¯writeæ–¹æ³•ï¼Œåªéœ€è¦æ‰¾åˆ°pipelineä¸­è¦†ç›–writeæ–¹æ³•çš„channelHandler
        final AbstractChannelHandlerContext next = findContextOutbound(flush ?
                (MASK_WRITE | MASK_FLUSH) : MASK_WRITE);
        //ç”¨äºæ£€æŸ¥å†…å­˜æ³„éœ²
        final Object m = pipeline.touch(msg, next);
        //è·å–ä¸‹ä¸€ä¸ªè¦è¢«æ‰§è¡Œçš„channelHandlerçš„executor
        EventExecutor executor = next.executor();
        //ç¡®ä¿OutBoundäº‹ä»¶ç”±ChannelHandleræŒ‡å®šçš„executoræ‰§è¡Œ
        if (executor.inEventLoop()) {
            //å¦‚æœå½“å‰çº¿ç¨‹æ­£æ˜¯channelHandleræŒ‡å®šçš„executoråˆ™ç›´æ¥æ‰§è¡Œ
            if (flush) {
                next.invokeWriteAndFlush(m, promise);
            } else {
                next.invokeWrite(m, promise);
            }
        } else {
            //å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯ChannelHandleræŒ‡å®šçš„executor,åˆ™å°è£…æˆå¼‚æ­¥ä»»åŠ¡æäº¤ç»™æŒ‡å®šexecutoræ‰§è¡Œï¼Œæ³¨æ„è¿™é‡Œçš„executorä¸ä¸€å®šæ˜¯reactorçº¿ç¨‹ã€‚
            final WriteTask task = WriteTask.newInstance(next, m, promise, flush);
            if (!safeExecute(executor, task, promise, m, !flush)) {
                task.cancel();
            }
        }
    }
</code></pre></div><p>ç”±äºåœ¨ writeAndFlush æµç¨‹çš„å¤„ç†ä¸­ï¼Œflush æ ‡å¿—è¢«è®¾ç½®ä¸º trueï¼Œæ‰€ä»¥è¿™é‡Œæœ‰ä¸¤ä¸ªåœ°æ–¹ä¼šå’Œ write äº‹ä»¶çš„å¤„ç†æœ‰æ‰€ä¸åŒã€‚</p> <ul><li><code>findContextOutbound( MASK_WRITE | MASK_FLUSH )</code>ï¼šè¿™é‡Œåœ¨ pipeline ä¸­å‘å‰æŸ¥æ‰¾çš„ ChanneOutboundHandler éœ€è¦å®ç° write æ–¹æ³•æˆ–è€… flush æ–¹æ³•ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ write æ–¹æ³•å’Œ flush æ–¹æ³•åªéœ€è¦å®ç°å…¶ä¸­ä¸€ä¸ªå³å¯æ»¡è¶³æŸ¥æ‰¾æ¡ä»¶ã€‚å› ä¸ºä¸€èˆ¬æˆ‘ä»¬è‡ªå®šä¹‰ ChannelOutboundHandler æ—¶ï¼Œéƒ½ä¼šç»§æ‰¿ ChannelOutboundHandlerAdapter ç±»ï¼Œè€Œåœ¨ ChannelInboundHandlerAdapter ç±»ä¸­å¯¹äºè¿™äº› outbound äº‹ä»¶éƒ½ä¼šæœ‰é»˜è®¤çš„å®ç°ã€‚</li></ul> <div class="language- extra-class"><pre class="language-text"><code>public class ChannelOutboundHandlerAdapter extends ChannelHandlerAdapter implements ChannelOutboundHandler {

    @Skip
    @Override
    public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) throws Exception {
        ctx.write(msg, promise);
    }


    @Skip
    @Override
    public void flush(ChannelHandlerContext ctx) throws Exception {
        ctx.flush();
    }

}
</code></pre></div><p>è¿™æ ·åœ¨åé¢ä¼ æ’­ write äº‹ä»¶æˆ–è€… flush äº‹ä»¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬é€šè¿‡ä¸Šé¢é€»è¾‘æ‰¾å‡ºçš„ ChannelOutboundHandler ä¸­å¯èƒ½åªå®ç°äº†ä¸€ä¸ª flush æ–¹æ³•æˆ–è€… write æ–¹æ³•ã€‚ä¸è¿‡è¿™æ ·æ²¡å…³ç³»ï¼Œå¦‚æœè¿™é‡Œåœ¨ä¼ æ’­ outbound äº‹ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°æ‰¾å‡ºçš„ ChannelOutboundHandler ä¸­å¹¶æ²¡æœ‰å®ç°å¯¹åº”çš„ outbound äº‹ä»¶å›è°ƒå‡½æ•°ï¼Œé‚£ä¹ˆå°±ç›´æ¥è°ƒç”¨åœ¨ ChannelOutboundHandlerAdapter ä¸­çš„é»˜è®¤å®ç°ã€‚</p> <ul><li>åœ¨å‘å‰ä¼ æ’­ writeAndFlush äº‹ä»¶çš„æ—¶å€™ä¼šé€šè¿‡è°ƒç”¨ ChannelHandlerContext çš„ invokeWriteAndFlush æ–¹æ³•ï¼Œå…ˆä¼ æ’­ write äº‹ä»¶ ç„¶ååœ¨ä¼ æ’­ flush äº‹ä»¶ã€‚</li></ul> <div class="language- extra-class"><pre class="language-text"><code>    void invokeWriteAndFlush(Object msg, ChannelPromise promise) {
        if (invokeHandler()) {
            //å‘å‰ä¼ é€’writeäº‹ä»¶
            invokeWrite0(msg, promise);
            //å‘å‰ä¼ é€’flushäº‹ä»¶
            invokeFlush0();
        } else {
            writeAndFlush(msg, promise);
        }
    }

    private void invokeWrite0(Object msg, ChannelPromise promise) {
        try {
            //è°ƒç”¨å½“å‰ChannelHandlerä¸­çš„writeæ–¹æ³•
            ((ChannelOutboundHandler) handler()).write(this, msg, promise);
        } catch (Throwable t) {
            notifyOutboundHandlerException(t, promise);
        }
    }

    private void invokeFlush0() {
        try {
            ((ChannelOutboundHandler) handler()).flush(this);
        } catch (Throwable t) {
            invokeExceptionCaught(t);
        }
    }
</code></pre></div><p>è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°äº† writeAndFlush çš„æ ¸å¿ƒå¤„ç†é€»è¾‘ï¼Œ<strong>é¦–å…ˆå‘å‰ä¼ æ’­ write äº‹ä»¶ï¼Œç»è¿‡ write äº‹ä»¶çš„æµç¨‹å¤„ç†åï¼Œæœ€åå‘å‰ä¼ æ’­ flush äº‹ä»¶ã€‚</strong></p> <p>æ ¹æ®å‰è¾¹çš„ä»‹ç»ï¼Œè¿™é‡Œåœ¨å‘å‰ä¼ æ’­ write äº‹ä»¶çš„æ—¶å€™ï¼Œå¯èƒ½æŸ¥æ‰¾å‡ºçš„ ChannelOutboundHandler åªæ˜¯å®ç°äº† flush æ–¹æ³•ï¼Œä¸è¿‡æ²¡å…³ç³»ï¼Œè¿™é‡Œä¼šç›´æ¥è°ƒç”¨ write æ–¹æ³•åœ¨ ChannelOutboundHandlerAdapter çˆ¶ç±»ä¸­çš„é»˜è®¤å®ç°ã€‚åŒç† flush ä¹Ÿæ˜¯ä¸€æ ·ã€‚</p> <hr> <h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="header-anchor">#</a> æ€»ç»“</h2> <p>åˆ°è¿™é‡Œï¼ŒNetty å¤„ç†æ•°æ®å‘é€çš„æ•´ä¸ªå®Œæ•´æµç¨‹ï¼Œç¬”è€…å°±ä¸ºå¤§å®¶è¯¦ç»†åœ°ä»‹ç»å®Œäº†ï¼Œå¯ä»¥çœ‹åˆ° Netty åœ¨å¤„ç†è¯»å–æ•°æ®å’Œå¤„ç†å‘é€æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œè™½ç„¶æ ¸å¿ƒé€»è¾‘éƒ½å·®ä¸å¤šï¼Œä½†æ˜¯å‘é€æ•°æ®çš„è¿‡ç¨‹æ˜æ˜¾ç»†èŠ‚æ¯”è¾ƒå¤šï¼Œè€Œä¸”æ›´åŠ å¤æ‚ä¸€äº›ã€‚</p> <p>è¿™é‡Œç¬”è€…å°†è¯»å–æ•°æ®å’Œå‘é€æ•°æ®çš„ä¸åŒä¹‹å¤„æ€»ç»“å¦‚ä¸‹å‡ ç‚¹ä¾›å¤§å®¶å›å¿†å¯¹æ¯”ï¼š</p> <ul><li><p>åœ¨æ¯æ¬¡ read loop ä¹‹å‰ï¼Œä¼šåˆ†é…ä¸€ä¸ªå¤§å°å›ºå®šçš„ diretByteBuffer ç”¨æ¥è£…è½½è¯»å–æ•°æ®ã€‚æ¯è½® read loop å®Œå…¨ç»“æŸä¹‹åï¼Œæ‰ä¼šå†³å®šæ˜¯å¦å¯¹ä¸‹ä¸€è½®çš„è¯»å–è¿‡ç¨‹åˆ†é…çš„ directByteBuffer è¿›è¡Œæ‰©å®¹æˆ–è€…ç¼©å®¹ã€‚</p></li> <li><p>åœ¨æ¯æ¬¡ write loop ä¹‹å‰ï¼Œéƒ½ä¼šè·å–æœ¬æ¬¡ write loop æœ€å¤§èƒ½å¤Ÿå†™å…¥çš„å­—èŠ‚æ•°ï¼Œæ ¹æ®è¿™ä¸ªæœ€å¤§å†™å…¥å­—èŠ‚æ•°ä» ChannelOutboundBuffer ä¸­è½¬æ¢ JDK NIO ByteBuffer ã€‚æ¯æ¬¡å†™å…¥ Socket ä¹‹åéƒ½éœ€è¦é‡æ–°è¯„ä¼°æ˜¯å¦å¯¹è¿™ä¸ªæœ€å¤§å†™å…¥å­—èŠ‚æ•°è¿›è¡Œæ‰©å®¹æˆ–è€…ç¼©å®¹ã€‚</p></li> <li><p>read loop å’Œ write loop éƒ½è¢«é»˜è®¤é™å®šæœ€å¤šæ‰§è¡Œ 16 æ¬¡ã€‚</p></li> <li><p>åœ¨ä¸€ä¸ªå®Œæ•´çš„ read loop ä¸­ï¼Œå¦‚æœè¿˜è¯»å–ä¸å®Œæ•°æ®ï¼Œç›´æ¥é€€å‡ºã€‚ç­‰åˆ° reactor çº¿ç¨‹æ‰§è¡Œå®Œå…¶ä»– channel ä¸Šçš„ IO äº‹ä»¶å†æ¥è¯»å–æœªè¯»å®Œçš„æ•°æ®ã€‚</p></li> <li><p>è€Œåœ¨ä¸€ä¸ªå®Œæ•´çš„ write loop ä¸­ï¼Œæ•°æ®å‘é€ä¸å®Œï¼Œåˆ™åˆ†ä¸¤ç§æƒ…å†µã€‚</p></li> <li><ul><li>Socket ç¼“å†²åŒºæ»¡æ— æ³•åœ¨ç»§ç»­å†™å…¥ã€‚è¿™æ—¶å°±éœ€è¦å‘ reactor æ³¨å†Œ OP_WRITE äº‹ä»¶ã€‚ç­‰ Socket ç¼“å†²åŒºå˜çš„å¯å†™æ—¶ï¼Œepoll é€šçŸ¥ reactor çº¿ç¨‹ç»§ç»­å‘é€ã€‚</li> <li>Socket ç¼“å†²åŒºå¯å†™ï¼Œä½†æ˜¯ç”±äºå‘é€æ•°æ®å¤ªå¤šï¼Œå¯¼è‡´è™½ç„¶å†™æ»¡ 16 æ¬¡ä½†ä¾ç„¶æ²¡æœ‰å†™å®Œã€‚è¿™æ—¶å°±ç›´æ¥å‘ reactor ä¸¢ä¸€ä¸ª flushTask è¿›å»ï¼Œç­‰åˆ° reactor çº¿ç¨‹æ‰§è¡Œå®Œå…¶ä»– channel ä¸Šçš„ IO äº‹ä»¶ï¼Œåœ¨å›è¿‡å¤´æ¥æ‰§è¡Œ flushTaskã€‚</li></ul></li> <li><p>OP_READ äº‹ä»¶çš„æ³¨å†Œæ˜¯åœ¨ NioSocketChannel è¢«æ³¨å†Œåˆ°å¯¹åº”çš„ Reactor ä¸­æ—¶å°±ä¼šæ³¨å†Œã€‚<strong>è€Œ OP_WRITE äº‹ä»¶åªä¼šåœ¨ Socket ç¼“å†²åŒºæ»¡çš„æ—¶å€™æ‰ä¼šè¢«æ³¨å†Œã€‚å½“ Socket ç¼“å†²åŒºå†æ¬¡å˜å¾—å¯å†™æ—¶ï¼Œè¦è®°å¾—å–æ¶ˆ OP_WRITE äº‹ä»¶çš„ç›‘å¬ã€‚å¦åˆ™çš„è¯å°±ä¼šä¸€ç›´è¢«é€šçŸ¥</strong>ã€‚</p></li></ul> <p>å¥½äº†ï¼Œæœ¬æ–‡çš„å…¨éƒ¨å†…å®¹å°±åˆ°è¿™é‡Œäº†ï¼Œæˆ‘ä»¬ä¸‹ç¯‡æ–‡ç« è§~~~~</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/echo-lxy/echo-system-design/edit/master/docs/Netty ç³»ç»Ÿè®¾è®¡/25.å››ã€æ·±å…¥ Netty æ ¸å¿ƒ/20.ç¬¬å…­è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆå‘é€ç½‘ç»œæ•°æ®.md.md" target="_blank" rel="noopener noreferrer">ç¼–è¾‘</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°äº:</span> <span class="time">2024/09/19, 03:26:41</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        â†
        <a href="/pages/9cb8c1/" class="prev">ç¬¬äº”è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œæ•°æ®</a></span> <span class="next"><a href="/pages/ed2e85/">ç¬¬ä¸ƒè¯¾ï¼šè¯¦è§£ Netty ä¸­æ‰€æœ‰IOäº‹ä»¶çš„è§¦å‘æ—¶æœºå’Œä¼ æ’­æµç¨‹</a>â†’
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:lixinyang2002@163.com" title="å‘é‚®ä»¶" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/echo-lxy" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="å¬éŸ³ä¹" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="æœ¬ç«™ä¸»é¢˜">Vdoing</a> 
    | Copyright Â© 2024-2024
    <span>Xinyang Li | MIT License</span></div> <div class="buttons"><div title="è¿”å›é¡¶éƒ¨" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="å»è¯„è®º" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ä¸»é¢˜æ¨¡å¼" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          è·Ÿéšç³»ç»Ÿ
        </li><li class="iconfont icon-rijianmoshi">
          æµ…è‰²æ¨¡å¼
        </li><li class="iconfont icon-yejianmoshi">
          æ·±è‰²æ¨¡å¼
        </li><li class="iconfont icon-yuedu">
          é˜…è¯»æ¨¡å¼
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.6c7acbd0.js" defer></script><script src="/assets/js/2.933750c6.js" defer></script><script src="/assets/js/56.5ecf867d.js" defer></script><script src="/assets/js/7.7eb70372.js" defer></script>
  </body>
</html>
