<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>List шо╛шобф╕ОхоЮчО░ | Echo ч│╗ч╗Яшо╛шобф╣Лч╛О</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="ц░┤ц╗┤чЯ│чй┐я╝Мшо╛шобцЧащУ╢х╝╣">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.473bdd25.css" as="style"><link rel="preload" href="/assets/js/app.3449399e.js" as="script"><link rel="preload" href="/assets/js/2.933750c6.js" as="script"><link rel="preload" href="/assets/js/41.5525b2c4.js" as="script"><link rel="preload" href="/assets/js/7.7eb70372.js" as="script"><link rel="prefetch" href="/assets/js/10.8539d2c4.js"><link rel="prefetch" href="/assets/js/11.71fe9642.js"><link rel="prefetch" href="/assets/js/12.915fdd22.js"><link rel="prefetch" href="/assets/js/13.d9d26d25.js"><link rel="prefetch" href="/assets/js/14.397b7600.js"><link rel="prefetch" href="/assets/js/15.13af8159.js"><link rel="prefetch" href="/assets/js/16.2b4d4184.js"><link rel="prefetch" href="/assets/js/17.1f44d5e0.js"><link rel="prefetch" href="/assets/js/18.504b80bb.js"><link rel="prefetch" href="/assets/js/19.c5a27579.js"><link rel="prefetch" href="/assets/js/20.b5e0fdf1.js"><link rel="prefetch" href="/assets/js/21.af1069aa.js"><link rel="prefetch" href="/assets/js/22.af583a75.js"><link rel="prefetch" href="/assets/js/23.f8a8e8e0.js"><link rel="prefetch" href="/assets/js/24.88b84218.js"><link rel="prefetch" href="/assets/js/25.db0f299d.js"><link rel="prefetch" href="/assets/js/26.dc5ac22f.js"><link rel="prefetch" href="/assets/js/27.e82ff876.js"><link rel="prefetch" href="/assets/js/28.6b737928.js"><link rel="prefetch" href="/assets/js/29.ebd14054.js"><link rel="prefetch" href="/assets/js/3.aa815192.js"><link rel="prefetch" href="/assets/js/30.ed6ead0e.js"><link rel="prefetch" href="/assets/js/31.89a26765.js"><link rel="prefetch" href="/assets/js/32.f1016cda.js"><link rel="prefetch" href="/assets/js/33.fa9fdf81.js"><link rel="prefetch" href="/assets/js/34.9740832c.js"><link rel="prefetch" href="/assets/js/35.ac8dd46f.js"><link rel="prefetch" href="/assets/js/36.8aa375d9.js"><link rel="prefetch" href="/assets/js/37.381f3758.js"><link rel="prefetch" href="/assets/js/38.b82e8635.js"><link rel="prefetch" href="/assets/js/39.5259c5c3.js"><link rel="prefetch" href="/assets/js/4.73518a0f.js"><link rel="prefetch" href="/assets/js/40.92a2ab0c.js"><link rel="prefetch" href="/assets/js/42.825c6423.js"><link rel="prefetch" href="/assets/js/43.1f07064b.js"><link rel="prefetch" href="/assets/js/44.f4a3c564.js"><link rel="prefetch" href="/assets/js/45.52725702.js"><link rel="prefetch" href="/assets/js/46.73e4ddcb.js"><link rel="prefetch" href="/assets/js/47.7372c922.js"><link rel="prefetch" href="/assets/js/48.4ae5a7da.js"><link rel="prefetch" href="/assets/js/49.5d33831c.js"><link rel="prefetch" href="/assets/js/5.1875cdb3.js"><link rel="prefetch" href="/assets/js/50.ededdb64.js"><link rel="prefetch" href="/assets/js/51.88874359.js"><link rel="prefetch" href="/assets/js/52.a86508e6.js"><link rel="prefetch" href="/assets/js/53.a8d66d87.js"><link rel="prefetch" href="/assets/js/54.89dcf983.js"><link rel="prefetch" href="/assets/js/55.30c89211.js"><link rel="prefetch" href="/assets/js/56.249d1e23.js"><link rel="prefetch" href="/assets/js/57.ae215963.js"><link rel="prefetch" href="/assets/js/6.0b558b79.js"><link rel="prefetch" href="/assets/js/8.0ec7f6e8.js"><link rel="prefetch" href="/assets/js/9.6e274fca.js">
    <link rel="stylesheet" href="/assets/css/0.styles.473bdd25.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="чЫох╜Х" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="Echo ч│╗ч╗Яшо╛шобф╣Лч╛О" class="logo"> <span class="site-name can-hide">Echo ч│╗ч╗Яшо╛шобф╣Лч╛О</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">ЁЯПащжЦщб╡</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">тЬТя╕ПчГнщЧичоЧц│Х</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ч│╗ч╗Яшо╛шоб</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/84cb49/" class="nav-link">шо╛шобхЯ║чбАшо╛цЦ╜</a></li><li class="dropdown-item"><!----> <a href="/pages/a95d7d/" class="nav-link">шо╛шобчГнщЧих║ФчФи</a></li><li class="dropdown-item"><!----> <a href="/pages/def08a/" class="nav-link">хЬ║цЩпшо╛шоб</a></li></ul></div></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">тЭУщЧочнФ</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ЁЯСАхКицАБ</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">ЁЯПащжЦщб╡</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">тЬТя╕ПчГнщЧичоЧц│Х</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ч│╗ч╗Яшо╛шоб</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/84cb49/" class="nav-link">шо╛шобхЯ║чбАшо╛цЦ╜</a></li><li class="dropdown-item"><!----> <a href="/pages/a95d7d/" class="nav-link">шо╛шобчГнщЧих║ФчФи</a></li><li class="dropdown-item"><!----> <a href="/pages/def08a/" class="nav-link">хЬ║цЩпшо╛шоб</a></li></ul></div></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">тЭУщЧочнФ</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ЁЯСАхКицАБ</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>цМЗхНЧ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>хЯ║чбА</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/bdae41/" class="sidebar-link">String шо╛шобф╕ОхоЮчО░</a></li><li><a href="/pages/bd1e41/" aria-current="page" class="active sidebar-link">List шо╛шобф╕ОхоЮчО░</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/bd1e41/#хЙНшиА" class="sidebar-link">хЙНшиА</a></li><li class="sidebar-sub-header level2"><a href="/pages/bd1e41/#ziplist-шо╛шобф╕ОхоЮчО░" class="sidebar-link">ziplist шо╛шобф╕ОхоЮчО░</a></li><li class="sidebar-sub-header level2"><a href="/pages/bd1e41/#quicklist-шо╛шобф╕ОхоЮчО░" class="sidebar-link">quicklist шо╛шобф╕ОхоЮчО░</a></li><li class="sidebar-sub-header level2"><a href="/pages/bd1e41/#listpack-шо╛шобф╕ОхоЮчО░" class="sidebar-link">listpack шо╛шобф╕ОхоЮчО░</a></li><li class="sidebar-sub-header level2"><a href="/pages/bd1e41/#хп╣цпФ" class="sidebar-link">хп╣цпФ</a></li><li class="sidebar-sub-header level2"><a href="/pages/bd1e41/#цА╗ч╗У" class="sidebar-link">цА╗ч╗У</a></li></ul></li><li><a href="/pages/2d4311/" class="sidebar-link">Hash шо╛шобф╕ОхоЮчО░</a></li><li><a href="/pages/2d4312/" class="sidebar-link">ZSet шо╛шобф╕ОхоЮчО░</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ф╕╗ч║┐</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>цФпч║┐</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>щЫЖч╛д</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="щжЦщб╡" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>Redis ч│╗ч╗Яшо╛шоб</span></li><li data-v-06225672><span data-v-06225672>хЯ║чбА</span></li></ul> <div class="info" data-v-06225672><div title="ф╜ЬшАЕ" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/brother-one" target="_blank" title="ф╜ЬшАЕ" class="beLink" data-v-06225672>echo</a></div> <div title="хИЫх╗║цЧ╢щЧ┤" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-09-16</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">чЫох╜Х</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">List шо╛шобф╕ОхоЮчО░<!----></h1> <div class="page-slot page-slot-top">
    <div class="wwads-cn wwads-horizontal page-wwads" data-id="136"></div>
    <style>
      .page-wwads{
        width:100%!important;
        min-height: 0;
        margin: 0;
      }
      .page-wwads .wwads-img img{
        width:80px!important;
      }
      .page-wwads .wwads-poweredby{
        width: 40px;
        position: absolute;
        right: 25px;
        bottom: 3px;
      }
      .wwads-content .wwads-text, .page-wwads .wwads-text{
        height: 100%;
        padding-top: 5px;
        display: block;
      }
  </style>
  </div> <div class="theme-vdoing-content content__default"><div class="custom-block note"><p class="custom-block-title">цПРхЗ║щЧощвШцШпф╕АхИЗцЩ║цЕзчЪДх╝Ачлп</p> <ol><li>ф╕║ф╗Аф╣И Redis шо╛шобф║Жф╕ЙчзНч▒╗ф╝╝ф╜Жф╕НхРМчЪДх║Хх▒ВцХ░цНоч╗УцЮД ziplistуАБquicklistуАБlistpackя╝Я</li> <li>ziplist ф╕║ф╗Аф╣Иф╝ЪщЭвф╕┤цЯецЙ╛цХИчОЗщЩНф╜ОхТМхЖЕхнШш┐ЮщФБцЫ┤цЦ░чЪДщЧощвШя╝Я</li> <li>quicklist цШпхжВф╜ХшзгхЖ│ ziplist чЪДцАзшГ╜чУ╢щвИчЪДя╝Я</li> <li>listpack цШпхжВф╜ХщБ┐хЕН ziplist чЪДш┐ЮщФБцЫ┤цЦ░щЧощвШчЪДя╝Я</li> <li>хжВф╜ХхЬихоЮщЩЕх╝АхПСф╕нщАЙцЛйщАВхРИчЪД Redis List х║Хх▒Вч╗УцЮДя╝Мф╗ех╣│шббхЖЕхнШф╜┐чФихТМцАзшГ╜я╝Я</li> <li>ziplist хЬи Redis шо╛шобф╕нцЬЙхУкф║Ыф╝ШчВ╣швлф┐ЭчХЩф║Жф╕ЛцЭея╝МхН│ф╜┐хоГхнШхЬицАзшГ╜ф╕Нш╢│я╝Я</li> <li>х╜УцХ░цНоцПТхЕещЗПхдзцЧ╢я╝Мquicklist хжВф╜ХщБ┐хЕНхЖЕхнШщвСч╣БщЗНцЦ░хИЖщЕНшАМф┐ЭцМБщлШцХИя╝Я</li></ol></div> <h2 id="хЙНшиА"><a href="#хЙНшиА" class="header-anchor">#</a> хЙНшиА</h2> <p>Redis ф╕нчЪД List чЪДх║Хх▒ВцЬЙф╕ЙчзНцХ░цНоч╗УцЮД</p> <ul><li>ziplist</li> <li>quicklist</li> <li>listpack</li></ul> <p>ziplist чЪДцЬАхдзчЙ╣чВ╣я╝Мх░▒цШпхоГшвлшо╛шобцИРф╕АчзН <strong>хЖЕхнШч┤зхЗСхЮЛ</strong> чЪДцХ░цНоч╗УцЮДя╝МхНачФиф╕АхЭЧш┐Юч╗нчЪДхЖЕхнШчй║щЧ┤я╝Мф╗еш╛╛хИ░шКВчЬБхЖЕхнШчЪДчЫочЪД</p> <p>ф╜ЖцШпя╝М<strong>хЬишобчоЧцЬ║ч│╗ч╗Яф╕ня╝Мф╗╗ф╜Хф╕Аф╕кшо╛шобщГ╜цШпцЬЙхИйцЬЙх╝КчЪД</strong>уАВхп╣ф║О ziplist цЭешп┤я╝Мш┐Щф╕кщБУчРЖхРМца╖цИРчлЛуАВ</p> <p>шЩ╜чД╢ ziplist шКВчЬБф║ЖхЖЕхнШх╝АщФАя╝МхПпхоГф╣ЯхнШхЬиф╕дф╕кшо╛шобф╗гф╗╖</p> <ul><li>уАМф╕НшГ╜ф┐ЭхнШш┐ЗхдЪчЪДхЕГч┤ауАНя╝МхРжхИЩшо┐щЧоцАзшГ╜ф╝ЪщЩНф╜О</li> <li>уАМф╕НшГ╜ф┐ЭхнШш┐ЗхдзчЪДхЕГч┤ауАНя╝МхРжхИЩхо╣цШУхп╝шЗ┤хЖЕхнШщЗНцЦ░хИЖщЕНя╝МчФЪшЗ│хПпшГ╜х╝ХхПСш┐ЮщФБцЫ┤цЦ░чЪДщЧощвШуАВцЙАш░УчЪДш┐ЮщФБцЫ┤цЦ░я╝МчоАхНХцЭешп┤я╝Мх░▒цШп ziplist ф╕нчЪДцпПф╕Ащб╣щГ╜шжБшвлщЗНцЦ░хИЖщЕНхЖЕхнШчй║щЧ┤я╝МщАацИР ziplist чЪДцАзшГ╜щЩНф╜О</li></ul> <p>хЫацндя╝МщТИхп╣ ziplist хЬишо╛шобф╕КчЪДф╕Нш╢│я╝МRedis хЬиц╝Фш┐ЫчЪДш┐ЗчиЛф╕ня╝МцЦ░хвЮшо╛шобф║Жф╕дчзНцХ░цНоч╗УцЮД</p> <ul><li>quicklist</li> <li>istpack</li></ul> <p>хоГф╗мшо╛шобчЫоцаЗя╝МцШп <strong>х░╜хПпшГ╜хЬ░ф┐ЭцМБ ziplist шКВчЬБхЖЕхнШчЪДф╝ШхК┐я╝МхРМцЧ╢щБ┐хЕН ziplist ц╜ЬхЬичЪДцАзшГ╜ф╕ЛщЩНщЧощвШ</strong></p> <h2 id="ziplist-шо╛шобф╕ОхоЮчО░"><a href="#ziplist-шо╛шобф╕ОхоЮчО░" class="header-anchor">#</a> ziplist шо╛шобф╕ОхоЮчО░</h2> <h3 id="ziplist-хТМ-цХ┤цХ░щЫЖхРИ-чЪДшо╛шоб"><a href="#ziplist-хТМ-цХ┤цХ░щЫЖхРИ-чЪДшо╛шоб" class="header-anchor">#</a> ziplist хТМ цХ┤цХ░щЫЖхРИ чЪДшо╛шоб</h3> <p>щжЦхЕИф╜ашжБчЯещБУя╝МListуАБHash хТМ Sorted Set ш┐Щф╕ЙчзНцХ░цНоч▒╗хЮЛя╝МщГ╜хПпф╗еф╜┐чФихОЛч╝йхИЧшбия╝Иziplistя╝ЙцЭеф┐ЭхнШцХ░цНоуАВхОЛч╝йхИЧшбичЪДхЗ╜цХ░хоЪф╣ЙхТМхоЮчО░ф╗гчаБхИЖхИлхЬи ziplist.h хТМ ziplist.c ф╕н</p> <p>ф╕Нш┐Зя╝МцИСф╗мхЬи ziplist.h цЦЗф╗╢ф╕нхЕ╢хоЮца╣цЬмчЬЛф╕НхИ░хОЛч╝йхИЧшбичЪДч╗УцЮДф╜УхоЪф╣ЙуАВш┐ЩцШпхЫаф╕║хОЛч╝йхИЧшбицЬмш║лх░▒цШпф╕АхЭЧш┐Юч╗нчЪДхЖЕхнШчй║щЧ┤я╝МхоГщАЪш┐Зф╜┐чФиф╕НхРМчЪДч╝ЦчаБцЭеф┐ЭхнШцХ░цНо</p> <p>ш┐ЩщЗМф╕║ф║ЖцЦ╣ф╛┐чРЖшзгхОЛч╝йхИЧшбичЪДшо╛шобф╕ОхоЮчО░я╝МцИСф╗мхЕИцЭечЬЛчЬЛхоГчЪД<strong>хИЫх╗║хЗ╜цХ░ ziplistNew</strong>я╝МхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">ziplistNew</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//хИЭхзЛхИЖщЕНчЪДхдзх░П</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> bytes <span class="token operator">=</span> ZIPLIST_HEADER_SIZE<span class="token operator">+</span>ZIPLIST_END_SIZE<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>zl <span class="token operator">=</span> <span class="token function">zmalloc</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    тАж
   <span class="token comment">//х░ЖхИЧшбих░╛шо╛ч╜оф╕║ZIP_END</span>
    zl<span class="token punctuation">[</span>bytes<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> ZIP_END<span class="token punctuation">;</span>
    <span class="token keyword">return</span> zl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хоЮщЩЕф╕Кя╝М<code>ziplistNew</code> хЗ╜цХ░чЪДщА╗ш╛Сх╛ИчоАхНХя╝Мх░▒цШпхИЫх╗║ф╕АхЭЧш┐Юч╗нчЪДхЖЕхнШчй║щЧ┤я╝Мхдзх░Пф╕║ <code>ZIPLIST_HEADER_SIZE</code> хТМ <code>ZIPLIST_END_SIZE</code> чЪДцА╗хТМя╝МчД╢хРОхЖНцККшпеш┐Юч╗нчй║щЧ┤чЪДцЬАхРОф╕Аф╕кхнЧшКВш╡ЛхА╝ф╕║ <code>ZIP_END</code>я╝Мшбичд║хИЧшбич╗УцЭЯуАВ</p> <p>ш┐Щф╕Йф╕кхоПхИЖхИлшбичд║ ziplist чЪДхИЧшбихд┤хдзх░ПуАБхИЧшбих░╛хдзх░ПхТМхИЧшбих░╛хнЧшКВхЖЕхо╣</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">//ziplistчЪДхИЧшбихд┤хдзх░Пя╝МхМЕцЛм2ф╕к32 bitsцХ┤цХ░хТМ1ф╕к16bitsцХ┤цХ░я╝МхИЖхИлшбичд║хОЛч╝йхИЧшбичЪДцА╗хнЧшКВцХ░я╝МхИЧшбицЬАхРОф╕Аф╕кхЕГч┤ачЪДчж╗хИЧшбихд┤чЪДхБПчз╗я╝Мф╗ехПКхИЧшбиф╕нчЪДхЕГч┤аф╕кцХ░</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ZIPLIST_HEADER_SIZE</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token comment">//ziplistчЪДхИЧшбих░╛хдзх░Пя╝МхМЕцЛм1ф╕к8 bitsцХ┤цХ░я╝Мшбичд║хИЧшбич╗УцЭЯуАВ</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ZIPLIST_END_SIZE</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token comment">//ziplistчЪДхИЧшбих░╛хнЧшКВхЖЕхо╣</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ZIP_END</span> <span class="token expression"><span class="token number">255</span></span></span>
</code></pre></div><p>щВгф╣Ия╝МхЬихИЫх╗║ф╕Аф╕кцЦ░чЪД ziplist хРОя╝МшпехИЧшбичЪДхЖЕхнШх╕Гх▒Ах░▒хжВф╕ЛхЫ╛цЙАчд║уАВц│ицДПя╝МцндцЧ╢хИЧшбиф╕нш┐Шц▓бцЬЙхоЮщЩЕчЪДцХ░цНоуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409161954992.png" alt="image-20240916195417942"></p> <p>чД╢хРОя╝Мх╜УцИСф╗мх╛А ziplist ф╕нцПТхЕецХ░цНоцЧ╢я╝Мziplist х░▒ф╝Ъца╣цНоцХ░цНоцШпхнЧчмжф╕▓ш┐ШцШпцХ┤цХ░я╝Мф╗ехПКхоГф╗мчЪДхдзх░Пш┐ЫшбМф╕НхРМчЪДч╝ЦчаБуАВш┐ЩчзН<strong>ца╣цНоцХ░цНохдзх░Пш┐ЫшбМчЫ╕х║Фч╝ЦчаБ</strong>чЪДшо╛шобцАЭцГ│я╝МцнгцШп Redis ф╕║ф║ЖшКВчЬБхЖЕхнШшАМщЗЗчФичЪД</p> <p>ziplist хИЧшбищб╣хМЕцЛмф╕ЙщГихИЖхЖЕхо╣я╝МхИЖхИлцШп<strong>хЙНф╕Ащб╣чЪДщХ┐х║жя╝Иprevlenя╝Й</strong>уАБ<strong>х╜УхЙНщб╣щХ┐х║жф┐бцБпчЪДч╝ЦчаБч╗УцЮЬя╝Иencodingя╝Й</strong>я╝Мф╗ехПК<strong>х╜УхЙНщб╣чЪДхоЮщЩЕцХ░цНоя╝Иdataя╝Й</strong>уАВф╕ЛщЭвчЪДхЫ╛х▒Хчд║ф║ЖхИЧшбищб╣чЪДч╗УцЮДя╝ИхЫ╛ф╕нщЩдхИЧшбищб╣ф╣ЛхдЦчЪДхЖЕхо╣хИЖхИлцШп ziplist хЖЕхнШчй║щЧ┤чЪДш╡╖хзЛхТМх░╛щГия╝ЙуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409161954391.png" alt="image-20240916195445322"></p> <p>хоЮщЩЕф╕Кя╝МцЙАш░УчЪДч╝ЦчаБцКАцЬпя╝Мх░▒цШпцМЗ <strong>чФиф╕НхРМцХ░щЗПчЪДхнЧшКВцЭешбичд║ф┐ЭхнШчЪДф┐бцБп</strong>уАВхЬи ziplist ф╕ня╝Мч╝ЦчаБцКАцЬпф╕╗шжБх║ФчФихЬихИЧшбищб╣ф╕нчЪД prevlen хТМ encoding ш┐Щф╕дф╕кхЕГцХ░цНоф╕КуАВшАМх╜УхЙНщб╣чЪДхоЮщЩЕцХ░цНо dataя╝МхИЩцнгх╕╕чФицХ┤цХ░цИЦцШпхнЧчмжф╕▓цЭешбичд║уАВ</p> <p>цЙАф╗еш┐ЩщЗМя╝МцИСф╗мх░▒хЕИцЭечЬЛф╕Л <strong>prevlen чЪДч╝ЦчаБшо╛шоб</strong>уАВziplist ф╕нф╝ЪхМЕхРлхдЪф╕кхИЧшбищб╣я╝МцпПф╕кхИЧшбищб╣щГ╜цШпч┤зцМичЭАх╜╝цндхнШцФ╛чЪДя╝МхжВф╕ЛхЫ╛цЙАчд║уАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409161955955.png" alt="image-20240916195507893"></p> <p>шАМф╕║ф║ЖцЦ╣ф╛┐цЯецЙ╛я╝МцпПф╕кхИЧшбищб╣ф╕нщГ╜ф╝Ъшо░х╜ХхЙНф╕Ащб╣чЪДщХ┐х║жуАВхЫаф╕║цпПф╕кхИЧшбищб╣чЪДщХ┐х║жф╕Нф╕Аца╖я╝МцЙАф╗ехжВцЮЬф╜┐чФичЫ╕хРМчЪДхнЧшКВхдзх░ПцЭешо░х╜Х prevlenя╝Мх░▒ф╝ЪщАацИРхЖЕхнШчй║щЧ┤ц╡кш┤╣уАВ</p> <p>цИСч╗Щф╜аф╕╛ф╕кф╛ЛхнРя╝МхБЗшо╛цИСф╗мч╗Яф╕Аф╜┐чФи 4 хнЧшКВшо░х╜Х prevlenя╝МхжВцЮЬхЙНф╕Аф╕кхИЧшбищб╣хПкцШпф╕Аф╕кхнЧчмжф╕▓тАЬredisтАЭя╝МщХ┐х║жф╕║ 5 ф╕кхнЧшКВя╝МщВгф╣ИцИСф╗мчФи 1 ф╕кхнЧшКВя╝И8 bitsя╝Йх░▒шГ╜шбичд║ 256 хнЧшКВщХ┐х║жя╝И2 чЪД 8 цмбцЦ╣чнЙф║О 256я╝ЙчЪДхнЧчмжф╕▓ф║ЖуАВцндцЧ╢я╝Мprevlen чФи 4 хнЧшКВшо░х╜Хя╝МхЕ╢ф╕нх░▒цЬЙ 3 хнЧшКВцШпц╡кш┤╣цОЙф║ЖуАВ</p> <p>хе╜я╝МцИСф╗мхЖНхЫЮш┐Зхд┤цЭечЬЛя╝Мziplist хЬихп╣ prevlen ч╝ЦчаБцЧ╢я╝Мф╝ЪхЕИш░ГчФи <strong>zipStorePrevEntryLength хЗ╜цХ░</strong>я╝МчФиф║ОхИдцЦнхЙНф╕Аф╕кхИЧшбищб╣цШпхРжх░Пф║О 254 хнЧшКВуАВхжВцЮЬцШпчЪДшпЭя╝МщВгф╣И prevlen х░▒ф╜┐чФи 1 хнЧшКВшбичд║я╝ЫхРжхИЩя╝МzipStorePrevEntryLength хЗ╜цХ░х░▒ш░ГчФи zipStorePrevEntryLengthLarge хЗ╜цХ░ш┐Ыф╕Ацнеч╝ЦчаБуАВш┐ЩщГихИЖф╗гчаБхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">//хИдцЦнprevlenчЪДщХ┐х║жцШпхРжх░Пф║ОZIP_BIG_PREVLENя╝МZIP_BIG_PREVLENчнЙф║О254</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span> ZIP_BIG_PREVLEN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">//хжВцЮЬх░Пф║О254хнЧшКВя╝МщВгф╣Иш┐ФхЫЮprevlenф╕║1хнЧшКВ</span>
   p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> len<span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
   <span class="token comment">//хРжхИЩя╝Мш░ГчФиzipStorePrevEntryLengthLargeш┐ЫшбМч╝ЦчаБ</span>
   <span class="token keyword">return</span> <span class="token function">zipStorePrevEntryLengthLarge</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ф╣Ях░▒цШпшп┤я╝М<strong>zipStorePrevEntryLengthLarge хЗ╜цХ░</strong>ф╝ЪхЕИх░Ж prevlen чЪДчмм 1 хнЧшКВшо╛ч╜оф╕║ 254я╝МчД╢хРОф╜┐чФихЖЕхнШцЛ╖ш┤ЭхЗ╜цХ░ memcpyя╝Мх░ЖхЙНф╕Аф╕кхИЧшбищб╣чЪДщХ┐х║жхА╝цЛ╖ш┤ЭшЗ│ prevlen чЪДчмм 2 шЗ│чмм 5 хнЧшКВуАВцЬАхРОя╝МzipStorePrevEntryLengthLarge хЗ╜цХ░ш┐ФхЫЮ prevlen чЪДхдзх░Пя╝Мф╕║ 5 хнЧшКВуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//х░ЖprevlenчЪДчмм1хнЧшКВшо╛ч╜оф╕║ZIP_BIG_PREVLENя╝МхН│254</span>
    p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> ZIP_BIG_PREVLEN<span class="token punctuation">;</span>
  <span class="token comment">//х░ЖхЙНф╕Аф╕кхИЧшбищб╣чЪДщХ┐х║жхА╝цЛ╖ш┤ЭшЗ│prevlenчЪДчмм2шЗ│чмм5хнЧшКВя╝МхЕ╢ф╕нsizeof(len)чЪДхА╝ф╕║4</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>len<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    тАж
<span class="token punctuation">}</span>
<span class="token comment">//ш┐ФхЫЮprevlenчЪДхдзх░Пя╝Мф╕║5хнЧшКВ</span>
<span class="token keyword">return</span> <span class="token number">1</span><span class="token operator">+</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>хе╜я╝МхЬиф║Жшзгф║Ж prevlen ф╜┐чФи 1 хнЧшКВхТМ 5 хнЧшКВф╕дчзНч╝ЦчаБцЦ╣х╝ПхРОя╝МцИСф╗мхЖНцЭехнжф╣аф╕Л <strong>encoding чЪДч╝ЦчаБцЦ╣ц│Х</strong>уАВ</p> <p>цИСф╗мчЯещБУя╝Мф╕Аф╕кхИЧшбищб╣чЪДхоЮщЩЕцХ░цНоя╝МцЧвхПпф╗ецШпцХ┤цХ░ф╣ЯхПпф╗ецШпхнЧчмжф╕▓уАВцХ┤цХ░хПпф╗ецШп 16уАБ32уАБ64 чнЙхнЧшКВщХ┐х║жя╝МхРМцЧ╢хнЧчмжф╕▓чЪДщХ┐х║жф╣ЯхПпф╗ехдзх░Пф╕Нф╕АуАВ</p> <p>цЙАф╗ея╝Мziplist хЬи zipStoreEntryEncoding хЗ╜цХ░ф╕ня╝МщТИхп╣цХ┤цХ░хТМхнЧчмжф╕▓я╝Мх░▒хИЖхИлф╜┐чФиф║Жф╕НхРМхнЧшКВщХ┐х║жчЪДч╝ЦчаБч╗УцЮЬуАВф╕ЛщЭвчЪДф╗гчаБх▒Хчд║ф║Ж zipStoreEntryEncoding хЗ╜цХ░чЪДщГихИЖф╗гчаБя╝Мф╜ахПпф╗ечЬЛхИ░х╜УцХ░цНоцШпф╕НхРМщХ┐х║жхнЧчмжф╕▓цИЦцШпцХ┤цХ░цЧ╢я╝Мч╝ЦчаБч╗УцЮЬчЪДщХ┐х║ж len хдзх░Пф╕НхРМуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">//щ╗Шшодч╝ЦчаБч╗УцЮЬцШп1хнЧшКВ</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> len <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">//хжВцЮЬцШпхнЧчмжф╕▓цХ░цНо</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ZIP_IS_STR</span><span class="token punctuation">(</span>encoding<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//хнЧчмжф╕▓щХ┐х║жх░Пф║ОчнЙф║О63хнЧшКВя╝И16ш┐ЫхИ╢ф╕║0x3fя╝Й</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rawlen <span class="token operator">&lt;=</span> <span class="token number">0x3f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//щ╗Шшодч╝ЦчаБч╗УцЮЬцШп1хнЧшКВ</span>
        тАж
    <span class="token punctuation">}</span>
    <span class="token comment">//хнЧчмжф╕▓щХ┐х║жх░Пф║ОчнЙф║О16383хнЧшКВя╝И16ш┐ЫхИ╢ф╕║0x3fffя╝Й</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rawlen <span class="token operator">&lt;=</span> <span class="token number">0x3fff</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//ч╝ЦчаБч╗УцЮЬцШп2хнЧшКВ</span>
        len <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        тАж
    <span class="token punctuation">}</span>
    <span class="token comment">//хнЧчмжф╕▓щХ┐х║жхдзф║О16383хнЧшКВ</span>

    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//ч╝ЦчаБч╗УцЮЬцШп5хнЧшКВ</span>
        len <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">;</span>
        тАж
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">/* хжВцЮЬцХ░цНоцШпцХ┤цХ░я╝Мч╝ЦчаБч╗УцЮЬцШп1хнЧшКВ*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">)</span> <span class="token keyword">return</span> len<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>чоАшАМшиАф╣Ля╝МщТИхп╣ф╕НхРМщХ┐х║жчЪДцХ░цНоя╝Мф╜┐чФиф╕НхРМхдзх░ПчЪДхЕГцХ░цНоф┐бцБпя╝Иprevlen хТМ encodingя╝Йя╝Мш┐ЩчзНцЦ╣ц│ХхПпф╗ецЬЙцХИхЬ░шКВчЬБхЖЕхнШх╝АщФА</p> <p>щЩдф║Ж ziplist ф╣ЛхдЦя╝МRedis ш┐Шшо╛шобф║Жф╕Аф╕кхЖЕхнШхПЛхе╜чЪДцХ░цНоч╗УцЮДя╝Мш┐Щх░▒цШп<strong>цХ┤цХ░щЫЖхРИя╝Иintsetя╝Й</strong>я╝МхоГцШпф╜Ьф╕║х║Хх▒Вч╗УцЮДцЭехоЮчО░ Set цХ░цНоч▒╗хЮЛчЪДуАВ</p> <p>хТМ SDS х╡МхЕех╝ПхнЧчмжф╕▓уАБziplist ч▒╗ф╝╝я╝МцХ┤цХ░щЫЖхРИф╣ЯцШпф╕АхЭЧш┐Юч╗нчЪДхЖЕхнШчй║щЧ┤я╝Мш┐Щф╕АчВ╣цИСф╗мф╗ОцХ┤цХ░щЫЖхРИчЪДхоЪф╣Йф╕нх░▒хПпф╗ечЬЛхИ░уАВintset.h хТМ intset.c хИЖхИлхМЕцЛмф║ЖцХ┤цХ░щЫЖхРИчЪДхоЪф╣ЙхТМхоЮчО░</p> <p>ф╕ЛщЭвчЪДф╗гчаБх▒Хчд║ф║Ж intset чЪДч╗УцЮДхоЪф╣ЙуАВцИСф╗мхПпф╗ечЬЛхИ░я╝МцХ┤цХ░щЫЖхРИч╗УцЮДф╜Уф╕ншо░х╜ХцХ░цНочЪДщГихИЖя╝Мх░▒цШпф╕Аф╕к int8_t ч▒╗хЮЛчЪДцХ┤цХ░цХ░ч╗Д contentsуАВф╗ОхЖЕхнШф╜┐чФичЪДшзТх║жцЭечЬЛя╝МцХ┤цХ░цХ░ч╗Дх░▒цШпф╕АхЭЧш┐Юч╗нхЖЕхнШчй║щЧ┤я╝МцЙАф╗еш┐Щца╖х░▒щБ┐хЕНф║ЖхЖЕхнШчвОчЙЗя╝Мх╣╢цПРхНЗф║ЖхЖЕхнШф╜┐чФицХИчОЗ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">intset</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint32_t</span> encoding<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> length<span class="token punctuation">;</span>
    <span class="token class-name">int8_t</span> contents<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> intset<span class="token punctuation">;</span>
</code></pre></div><h3 id="цЙйх▒Х-шКВчЬБхЖЕхнШчЪДцХ░цНошо┐щЧо"><a href="#цЙйх▒Х-шКВчЬБхЖЕхнШчЪДцХ░цНошо┐щЧо" class="header-anchor">#</a> цЙйх▒Хя╝ЪшКВчЬБхЖЕхнШчЪДцХ░цНошо┐щЧо</h3> <p>цИСф╗мчЯещБУя╝МхЬи Redis хоЮф╛Лш┐РшбМцЧ╢я╝МцЬЙф║ЫцХ░цНоцШпф╝Ъшвлч╗Пх╕╕шо┐щЧочЪДя╝МцпФхжВх╕╕шзБчЪДцХ┤цХ░я╝МRedis хНПшооф╕нх╕╕шзБчЪДхЫЮхдНф┐бцБпя╝МхМЕцЛмцУНф╜ЬцИРхКЯя╝ИтАЬOKтАЭхнЧчмжф╕▓я╝ЙуАБцУНф╜Ьхд▒ш┤ея╝ИERRя╝Йя╝Мф╗ехПКх╕╕шзБчЪДцКещФЩф┐бцБпуАВ</p> <p>цЙАф╗ея╝Мф╕║ф║ЖщБ┐хЕНхЬихЖЕхнШф╕нхПНхдНхИЫх╗║ш┐Щф║Ыч╗Пх╕╕швлшо┐щЧочЪДцХ░цНоя╝МRedis х░▒щЗЗчФиф║Ж<strong>хЕ▒ф║лхп╣ш▒б</strong>чЪДшо╛шобцАЭцГ│уАВш┐Щф╕кшо╛шобцАЭцГ│х╛ИчоАхНХя╝Мх░▒цШпцККш┐Щф║Ых╕╕чФицХ░цНохИЫх╗║ф╕║хЕ▒ф║лхп╣ш▒бя╝Мх╜Уф╕Кх▒Вх║ФчФищЬАшжБшо┐щЧохоГф╗мцЧ╢я╝МчЫ┤цОешп╗хПЦх░▒шбМуАВ</p> <p>чО░хЬицИСф╗мх░▒цЭехБЪф╕кхБЗшо╛уАВцЬЙ 1000 ф╕кховцИ╖члпя╝МщГ╜шжБф┐ЭхнШтАЬ3тАЭш┐Щф╕кцХ┤цХ░уАВхжВцЮЬ Redis ф╕║цпПф╕кховцИ╖члпя╝МщГ╜хИЫх╗║ф║Жф╕Аф╕кхА╝ф╕║ 3 чЪД redisObjectя╝МщВгф╣ИхЖЕхнШф╕нх░▒ф╝ЪцЬЙхдзщЗПчЪДхЖЧф╜ЩуАВшАМф╜┐чФиф║ЖхЕ▒ф║лхп╣ш▒бцЦ╣ц│ХхРОя╝МRedis хЬихЖЕхнШф╕нхПкчФиф┐ЭхнШф╕Аф╕к 3 чЪД redisObject х░▒шбМя╝Мш┐Щца╖х░▒цЬЙцХИшКВчЬБф║ЖхЖЕхнШчй║щЧ┤уАВ</p> <p>ф╗еф╕Лф╗гчаБх▒Хчд║чЪДцШп server.c цЦЗф╗╢ф╕ня╝М<strong>хИЫх╗║хЕ▒ф║лхп╣ш▒бчЪДхЗ╜цХ░ createSharedObjects</strong>я╝Мф╜ахПпф╗ечЬЛф╕ЛуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">createSharedObjects</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   тАж
   <span class="token comment">//х╕╕шзБхЫЮхдНф┐бцБп</span>
   shared<span class="token punctuation">.</span>ok <span class="token operator">=</span> <span class="token function">createObject</span><span class="token punctuation">(</span>OBJ_STRING<span class="token punctuation">,</span><span class="token function">sdsnew</span><span class="token punctuation">(</span><span class="token string">&quot;+OK\r\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   shared<span class="token punctuation">.</span>err <span class="token operator">=</span> <span class="token function">createObject</span><span class="token punctuation">(</span>OBJ_STRING<span class="token punctuation">,</span><span class="token function">sdsnew</span><span class="token punctuation">(</span><span class="token string">&quot;-ERR\r\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   тАж
   <span class="token comment">//х╕╕шзБцКещФЩф┐бцБп</span>
 shared<span class="token punctuation">.</span>nokeyerr <span class="token operator">=</span> <span class="token function">createObject</span><span class="token punctuation">(</span>OBJ_STRING<span class="token punctuation">,</span><span class="token function">sdsnew</span><span class="token punctuation">(</span><span class="token string">&quot;-ERR no such key\r\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 shared<span class="token punctuation">.</span>syntaxerr <span class="token operator">=</span> <span class="token function">createObject</span><span class="token punctuation">(</span>OBJ_STRING<span class="token punctuation">,</span><span class="token function">sdsnew</span><span class="token punctuation">(</span><span class="token string">&quot;-ERR syntax error\r\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//0хИ░9999чЪДцХ┤цХ░</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> OBJ_SHARED_INTEGERS<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        shared<span class="token punctuation">.</span>integers<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span>
          <span class="token function">makeObjectShared</span><span class="token punctuation">(</span><span class="token function">createObject</span><span class="token punctuation">(</span>OBJ_STRING<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        тАж
    <span class="token punctuation">}</span>
   тАж
<span class="token punctuation">}</span>
</code></pre></div><h3 id="ziplist-чЪДф╕Нш╢│"><a href="#ziplist-чЪДф╕Нш╢│" class="header-anchor">#</a> ziplist чЪДф╕Нш╢│</h3> <p>ф╜ах╖▓ч╗ПчЯещБУя╝Мф╕Аф╕к ziplist цХ░цНоч╗УцЮДхЬихЖЕхнШф╕нчЪДх╕Гх▒Ая╝Мх░▒цШпф╕АхЭЧш┐Юч╗нчЪДхЖЕхнШчй║щЧ┤уАВш┐ЩхЭЧчй║щЧ┤чЪДш╡╖хзЛщГихИЖцШпхдзх░ПхЫ║хоЪчЪД 10 хнЧшКВхЕГцХ░цНоя╝МхЕ╢ф╕ншо░х╜Хф║Ж ziplist чЪДцА╗хнЧшКВцХ░уАБцЬАхРОф╕Аф╕кхЕГч┤ачЪДхБПчз╗щЗПф╗ехПКхИЧшбихЕГч┤ачЪДцХ░щЗПя╝МшАМш┐Щ 10 хнЧшКВхРОщЭвчЪДхЖЕхнШчй║щЧ┤хИЩф┐ЭхнШф║ЖхоЮщЩЕчЪДхИЧшбицХ░цНоуАВхЬи ziplist чЪДцЬАхРОщГихИЖя╝МцШпф╕Аф╕к 1 хнЧшКВчЪДцаЗшпЖя╝ИхЫ║хоЪф╕║ 255я╝Йя╝МчФицЭешбичд║ ziplist чЪДч╗УцЭЯя╝МхжВф╕ЛхЫ╛цЙАчд║я╝Ъ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409161958569.png" alt="image-20240916195800505"></p> <p>ф╕Нш┐Зя╝МшЩ╜чД╢ ziplist щАЪш┐Зч┤зхЗСчЪДхЖЕхнШх╕Гх▒АцЭеф┐ЭхнШцХ░цНоя╝МшКВчЬБф║ЖхЖЕхнШчй║щЧ┤я╝Мф╜ЖцШп ziplist ф╣ЯщЭвф╕┤чЭАщЪПф╣ЛшАМцЭечЪДф╕дф╕кф╕Нш╢│я╝Ъ</p> <ul><li><strong>цЯецЙ╛хдНцЭВх║жщлШ</strong></li> <li><strong>ц╜ЬхЬичЪДш┐ЮщФБцЫ┤цЦ░щгОщЩй</strong></li></ul> <p>щВгф╣Иф╕ЛщЭвя╝МцИСф╗мх░▒хИЖхИлцЭеф║Жшзгф╕Лш┐Щф╕дф╕кщЧощвШ</p> <h4 id="цЯецЙ╛хдНцЭВх║жщлШ"><a href="#цЯецЙ╛хдНцЭВх║жщлШ" class="header-anchor">#</a> цЯецЙ╛хдНцЭВх║жщлШ</h4> <p>хЫаф╕║ ziplist хд┤х░╛хЕГцХ░цНочЪДхдзх░ПцШпхЫ║хоЪчЪДя╝МцЙАф╗ехПпф╗ех╛Их┐лцЙ╛хИ░ щжЦщГихЕГч┤ахТМх░╛щГихЕГч┤ая╝Мф╜ЖщЧощвШцШп</p> <ul><li>х╜УшжБцЯецЙ╛ф╕нщЧ┤хЕГч┤ацЧ╢я╝Мziplist х░▒х╛Чф╗ОхИЧшбихд┤цИЦхИЧшбих░╛щБНхОЖцЙНшбМ</li> <li>цЫ┤ч│Яч│ХчЪДцШпя╝МхжВцЮЬ ziplist щЗМщЭвф┐ЭхнШчЪДцШпхнЧчмжф╕▓я╝Мziplist хЬицЯецЙ╛цЯРф╕кхЕГч┤ацЧ╢я╝Мш┐ШщЬАшжБщАРф╕АхИдцЦнхЕГч┤ачЪДцпПф╕кхнЧчмжя╝Мш┐Щца╖хПИш┐Ыф╕АцнехвЮхКаф║ЖхдНцЭВх║ж</li> <li>ziplist хЬицПТхЕехЕГч┤ацЧ╢я╝МхжВцЮЬхЖЕхнШчй║щЧ┤ф╕НхдЯф║Жя╝Мziplist ш┐ШщЬАшжБщЗНцЦ░хИЖщЕНф╕АхЭЧш┐Юч╗нчЪДхЖЕхнШчй║щЧ┤я╝МшАМш┐Щш┐Шф╝Ъш┐Ыф╕Ацнех╝ХхПС<strong>ш┐ЮщФБцЫ┤цЦ░</strong>чЪДщЧощвШ</li></ul> <p>ф╣ЯцнгхЫаф╕║хжВцндя╝МцИСф╗мхЬиф╜┐чФи ziplist ф┐ЭхнШ Hash цИЦ Sorted Set цХ░цНоцЧ╢я╝МщГ╜ф╝ЪхЬи redis.conf цЦЗф╗╢ф╕ня╝МщАЪш┐З hash-max-ziplist-entries хТМ zset-max-ziplist-entries ф╕дф╕кхПВцХ░я╝МцЭецОзхИ╢ф┐ЭхнШхЬи ziplist ф╕нчЪДхЕГч┤аф╕кцХ░</p> <h4 id="ш┐ЮщФБцЫ┤цЦ░щгОщЩй"><a href="#ш┐ЮщФБцЫ┤цЦ░щгОщЩй" class="header-anchor">#</a> ш┐ЮщФБцЫ┤цЦ░щгОщЩй</h4> <p>цИСф╗мчЯещБУя╝МхЫаф╕║ ziplist х┐Ещб╗ф╜┐чФиф╕АхЭЧш┐Юч╗нчЪДхЖЕхнШчй║щЧ┤цЭеф┐ЭхнШцХ░цНоя╝МцЙАф╗ех╜УцЦ░цПТхЕеф╕Аф╕кхЕГч┤ацЧ╢я╝Мziplist х░▒щЬАшжБшобчоЧхЕ╢цЙАщЬАчЪДчй║щЧ┤хдзх░Пя╝Мх╣╢чФ│шп╖чЫ╕х║ФчЪДхЖЕхнШчй║щЧ┤уАВш┐Щф╕Ач│╗хИЧцУНф╜Ья╝МцИСф╗мхПпф╗еф╗О ziplist чЪДхЕГч┤ацПТхЕехЗ╜цХ░ __ziplistInsert ф╕нчЬЛхИ░уАВ</p> <p><strong>__ziplistInsert хЗ╜цХ░щжЦхЕИф╝ЪшобчоЧшО╖х╛Чх╜УхЙН ziplist чЪДщХ┐х║ж</strong>я╝Мш┐Щф╕кцнещкдщАЪш┐З <code>ZIPLIST_BYTES</code> хоПхоЪф╣Йх░▒хПпф╗ехоМцИРя╝МхжВф╕ЛцЙАчд║уАВхРМцЧ╢я╝МшпехЗ╜цХ░ш┐Шхг░цШОф║Ж reqlen хПШщЗПя╝МчФиф║Ошо░х╜ХцПТхЕехЕГч┤ахРОцЙАщЬАчЪДцЦ░хвЮчй║щЧ┤хдзх░ПуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">//шО╖хПЦх╜УхЙНziplistщХ┐х║жcurlenя╝Ыхг░цШОreqlenхПШщЗПя╝МчФицЭешо░х╜ХцЦ░цПТхЕехЕГч┤ацЙАщЬАчЪДщХ┐х║ж</span>
<span class="token class-name">size_t</span> curlen <span class="token operator">=</span> <span class="token function">intrev32ifbe</span><span class="token punctuation">(</span><span class="token function">ZIPLIST_BYTES</span><span class="token punctuation">(</span>zl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> reqlen<span class="token punctuation">;</span>
</code></pre></div><p>чД╢хРОя╝М<strong>__ziplistInsert хЗ╜цХ░ф╝ЪхИдцЦнх╜УхЙНшжБцПТхЕечЪДф╜Нч╜оцШпхРжцШпхИЧшбицЬлх░╛</strong>уАВхжВцЮЬф╕НцШпцЬлх░╛я╝МщВгф╣Их░▒щЬАшжБшО╖хПЦф╜Нф║Ох╜УхЙНцПТхЕеф╜Нч╜очЪДхЕГч┤ачЪД prevlen хТМ prevlensizeуАВш┐ЩщГихИЖф╗гчаБхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">//хжВцЮЬцПТхЕечЪДф╜Нч╜оф╕НцШпziplistцЬлх░╛я╝МхИЩшО╖хПЦхЙНф╕Ащб╣щХ┐х║ж</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> ZIP_END<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ZIP_DECODE_PREVLEN</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> prevlensize<span class="token punctuation">,</span> prevlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    тАж
<span class="token punctuation">}</span>
</code></pre></div><p>хоЮщЩЕф╕Кя╝МхЬи ziplist ф╕ня╝МцпПф╕Аф╕кхЕГч┤ащГ╜ф╝Ъшо░х╜ХхЕ╢<strong>хЙНф╕Ащб╣чЪДщХ┐х║жя╝Мф╣Ях░▒цШп prevlen</strong>уАВчД╢хРОя╝Мф╕║ф║ЖшКВчЬБхЖЕхнШх╝АщФАя╝Мziplist ф╝Ъф╜┐чФиф╕НхРМчЪДчй║щЧ┤шо░х╜Х prevlenя╝Мш┐Щф╕к <strong>prevlen чй║щЧ┤хдзх░Пх░▒цШп prevlensize</strong>уАВ</p> <p>ф╕╛ф╕кчоАхНХчЪДф╛ЛхнРя╝Мх╜УхЬиф╕Аф╕кхЕГч┤а A хЙНцПТхЕеф╕Аф╕кцЦ░чЪДхЕГч┤а B цЧ╢я╝МA чЪД prevlen хТМ prevlensize щГ╜шжБца╣цНо B чЪДщХ┐х║жш┐ЫшбМчЫ╕х║ФчЪДхПШхМЦуАВ</p> <p>щВгф╣ИчО░хЬия╝МцИСф╗мхБЗшо╛ A чЪД prevlen хОЯцЬмхПкхНачФи 1 хнЧшКВя╝Иф╣Ях░▒цШп prevlensize чнЙф║О 1я╝Йя╝МшАМшГ╜шо░х╜ХчЪДхЙНф╕Ащб╣щХ┐х║жцЬАхдзф╕║ 253 хнЧшКВуАВцндцЧ╢я╝МхжВцЮЬ B чЪДщХ┐х║жш╢Еш┐Зф║Ж 253 хнЧшКВя╝МA чЪД prevlen х░▒щЬАшжБф╜┐чФи 5 ф╕кхнЧшКВцЭешо░х╜Хя╝Иprevlen хЕ╖ф╜УчЪДч╝ЦчаБцЦ╣х╝Пя╝Мф╜ахПпф╗ехдНф╣ахЫЮщб╛ф╕Лчмм 4 шо▓я╝Йя╝Мш┐Щца╖х░▒щЬАшжБчФ│шп╖щвЭхдЦчЪД 4 хнЧшКВчй║щЧ┤ф║ЖуАВф╕Нш┐Зя╝МхжВцЮЬхЕГч┤а B чЪДцПТхЕеф╜Нч╜оцШпхИЧшбицЬлх░╛я╝МщВгф╣ИцПТхЕехЕГч┤а B цЧ╢я╝МцИСф╗мх░▒ф╕НчФишАГшЩСхРОщЭвхЕГч┤ачЪД prevlen ф║Ж</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409161959761.png" alt="image-20240916195907680"></p> <p>хЫацндя╝Мф╕║ф║Жф┐ЭшпБ ziplist цЬЙш╢│хдЯчЪДхЖЕхнШчй║щЧ┤я╝МцЭеф┐ЭхнШцПТхЕехЕГч┤аф╗ехПКцПТхЕеф╜Нч╜охЕГч┤ачЪД prevlen ф┐бцБпя╝М<strong>__ziplistInsert хЗ╜цХ░хЬишО╖х╛ЧцПТхЕеф╜Нч╜охЕГч┤ачЪД prevlen хТМ prevlensize хРОя╝Мч┤зцОечЭАх░▒ф╝ЪшобчоЧцПТхЕехЕГч┤ачЪДщХ┐х║ж</strong>уАВ</p> <p>чО░хЬицИСф╗мх╖▓чЯея╝Мф╕Аф╕к ziplist хЕГч┤ахМЕцЛмф║Ж prevlenуАБencoding хТМхоЮщЩЕцХ░цНо data ф╕Йф╕кщГихИЖуАВцЙАф╗ея╝МхЬишобчоЧцПТхЕехЕГч┤ачЪДцЙАщЬАчй║щЧ┤цЧ╢я╝М__ziplistInsert хЗ╜цХ░ф╣Яф╝ЪхИЖхИлшобчоЧш┐Щф╕Йф╕кщГихИЖчЪДщХ┐х║жуАВш┐Щф╕кшобчоЧш┐ЗчиЛф╕АхЕ▒хПпф╗ехИЖцИРхЫЫцнецЭехоМцИРуАВ</p> <ul><li><strong>чммф╕Ацнея╝МшобчоЧхоЮщЩЕцПТхЕехЕГч┤ачЪДщХ┐х║жуАВ</strong></li></ul> <p>щжЦхЕИф╜ашжБчЯещБУя╝Мш┐Щф╕кшобчоЧш┐ЗчиЛхТМцПТхЕехЕГч┤ацШпцХ┤цХ░ш┐ШцШпхнЧчмжф╕▓цЬЙхЕ│уАВ__ziplistInsert хЗ╜цХ░ф╝ЪхЕИш░ГчФи zipTryEncoding хЗ╜цХ░я╝Мш┐Щф╕кхЗ╜цХ░ф╝ЪхИдцЦнцПТхЕехЕГч┤ацШпхРжф╕║цХ┤цХ░уАВхжВцЮЬцШпцХ┤цХ░я╝Мх░▒цМЙчЕзф╕НхРМчЪДцХ┤цХ░хдзх░Пя╝МшобчоЧ encoding хТМхоЮщЩЕцХ░цНо data хРДшЗкцЙАщЬАчЪДчй║щЧ┤я╝ЫхжВцЮЬцШпхнЧчмжф╕▓я╝МщВгф╣Их░▒хЕИцККхнЧчмжф╕▓щХ┐х║жшо░х╜Хф╕║цЙАщЬАчЪДцЦ░хвЮчй║щЧ┤хдзх░ПуАВш┐Щф╕Аш┐ЗчиЛчЪДф╗гчаБхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">zipTryEncoding</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>slen<span class="token punctuation">,</span><span class="token operator">&amp;</span>value<span class="token punctuation">,</span><span class="token operator">&amp;</span>encoding<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          reqlen <span class="token operator">=</span> <span class="token function">zipIntSize</span><span class="token punctuation">(</span>encoding<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          reqlen <span class="token operator">=</span> slen<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</code></pre></div><ul><li>чммф║Мцнея╝Мш░ГчФи zipStorePrevEntryLength хЗ╜цХ░я╝Мх░ЖцПТхЕеф╜Нч╜охЕГч┤ачЪД prevlen ф╣ЯшобчоЧхИ░цЙАщЬАчй║щЧ┤ф╕нуАВ</li></ul> <p>ш┐ЩцШпхЫаф╕║хЬицПТхЕехЕГч┤ахРОя╝М__ziplistInsert хЗ╜цХ░хПпшГ╜шжБф╕║цПТхЕеф╜Нч╜очЪДхЕГч┤ахИЖщЕНцЦ░хвЮчй║щЧ┤уАВш┐ЩщГихИЖф╗гчаБхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code>reqlen <span class="token operator">+=</span> <span class="token function">zipStorePrevEntryLength</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>prevlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>чммф╕Йцнея╝Мш░ГчФи zipStoreEntryEncoding хЗ╜цХ░я╝Мца╣цНохнЧчмжф╕▓чЪДщХ┐х║жя╝МшобчоЧчЫ╕х║Ф encoding чЪДхдзх░ПуАВ</li></ul> <p>хЬихИЪцЙНчЪДчммф╕Ацнеф╕ня╝М**ziplistInsert хЗ╜цХ░хп╣ф║ОхнЧчмжф╕▓цХ░цНоя╝МхПкцШпшо░х╜Хф║ЖхнЧчмжф╕▓цЬмш║лчЪДщХ┐х║жя╝МцЙАф╗ехЬичммф╕Йцнеф╕ня╝М**ziplistInsert хЗ╜цХ░ш┐Шф╝Ъш░ГчФи zipStoreEntryEncoding хЗ╜цХ░я╝Мца╣цНохнЧчмжф╕▓чЪДщХ┐х║жцЭешобчоЧчЫ╕х║ФчЪД encoding хдзх░Пя╝МхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code>reqlen <span class="token operator">+=</span> <span class="token function">zipStoreEntryEncoding</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>encoding<span class="token punctuation">,</span>slen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>хе╜ф║Жя╝МхИ░ш┐ЩщЗМя╝М__ziplistInsert хЗ╜цХ░х░▒х╖▓ч╗ПхЬи reqlen хПШщЗПф╕ня╝Мшо░х╜Хф║ЖцПТхЕехЕГч┤ачЪД prevlen щХ┐х║жуАБencoding хдзх░Пя╝Мф╗ехПКхоЮщЩЕцХ░цНо data чЪДщХ┐х║жуАВш┐Щца╖ф╕АцЭея╝МцПТхЕехЕГч┤ачЪДцХ┤ф╜УщХ┐х║жх░▒цЬЙф║Жя╝Мш┐Щф╣ЯцШпцПТхЕеф╜Нч╜охЕГч┤ачЪД prevlen цЙАшжБшо░х╜ХчЪДхдзх░ПуАВ</p> <ul><li>чммхЫЫцнея╝Мш░ГчФи zipPrevLenByteDiff хЗ╜цХ░я╝МхИдцЦнцПТхЕеф╜Нч╜охЕГч┤ачЪД prevlen хТМхоЮщЩЕцЙАщЬАчЪД prevlen хдзх░ПуАВ</li></ul> <p>цЬАхРОя╝М__ziplistInsert хЗ╜цХ░ф╝Ъш░ГчФи zipPrevLenByteDiff хЗ╜цХ░я╝МчФицЭехИдцЦнцПТхЕеф╜Нч╜охЕГч┤ачЪД prevlen хТМхоЮщЩЕцЙАщЬАчЪД prevlenя╝Мш┐Щф╕дшАЕщЧ┤чЪДхдзх░Пх╖охИлуАВш┐ЩщГихИЖф╗гчаБхжВф╕ЛцЙАчд║я╝Мprevlen чЪДхдзх░Пх╖охИлцШпф╜┐чФи nextdiff цЭешо░х╜ХчЪДя╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code>nextdiff <span class="token operator">=</span> <span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> ZIP_END<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">zipPrevLenByteDiff</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span>reqlen<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre></div><p>щВгф╣ИхЬиш┐ЩщЗМя╝МхжВцЮЬ nextdiff хдзф║О 0я╝Мх░▒шбицШОцПТхЕеф╜Нч╜охЕГч┤ачЪДчй║щЧ┤ф╕НхдЯя╝МщЬАшжБцЦ░хвЮ nextdiff хдзх░ПчЪДчй║щЧ┤я╝Мф╗еф╛┐шГ╜ф┐ЭхнШцЦ░чЪД prevlenуАВчД╢хРОя╝М<strong>__ziplistInsert хЗ╜цХ░хЬицЦ░хвЮчй║щЧ┤цЧ╢я╝Мх░▒ф╝Ъш░ГчФи ziplistResize хЗ╜цХ░я╝МцЭещЗНцЦ░хИЖщЕН ziplist цЙАщЬАчЪДчй║щЧ┤</strong>уАВ</p> <p>ziplistResize хЗ╜цХ░цОецФ╢чЪДхПВцХ░хИЖхИлцШпх╛ЕщЗНцЦ░хИЖщЕНчЪД ziplist хТМщЗНцЦ░хИЖщЕНчЪДчй║щЧ┤хдзх░ПуАВшАМ __ziplistInsert хЗ╜цХ░ф╝ахЕечЪДщЗНцЦ░хИЖщЕНхдзх░ПчЪДхПВцХ░я╝МцШпф╕Йф╕кщХ┐х║жф╣ЛхТМуАВ</p> <p>щВгф╣ИцШпхУкф╕Йф╕кщХ┐х║жф╣ЛхТМхСвя╝Я</p> <p>ш┐Щф╕Йф╕кщХ┐х║жхИЖхИлцШп ziplist чО░цЬЙхдзх░Пя╝Иcurlenя╝ЙуАБх╛ЕцПТхЕехЕГч┤ашЗкш║лцЙАщЬАчЪДцЦ░хвЮчй║щЧ┤я╝Иreqlenя╝Йя╝Мф╗ехПКцПТхЕеф╜Нч╜охЕГч┤а prevlen цЙАщЬАчЪДцЦ░хвЮчй║щЧ┤я╝Иnextdiffя╝ЙуАВф╕ЛщЭвчЪДф╗гчаБцШ╛чд║ф║Ж ziplistResize хЗ╜цХ░чЪДш░ГчФихТМхПВцХ░ф╝ащАТщА╗ш╛Ся╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code>zl <span class="token operator">=</span> <span class="token function">ziplistResize</span><span class="token punctuation">(</span>zl<span class="token punctuation">,</span>curlen<span class="token operator">+</span>reqlen<span class="token operator">+</span>nextdiff<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ш┐Ыф╕Ацнея╝МщВгф╣И ziplistResize хЗ╜цХ░хЬишО╖х╛Чф╕Йф╕кщХ┐х║жцА╗хТМф╣ЛхРОя╝МхЕ╖ф╜УцШпхжВф╜ХцЙйхо╣хСвя╝Я</p> <p>цИСф╗мхПпф╗еш┐Ыф╕АцнечЬЛф╕Л ziplistResize хЗ╜цХ░чЪДхоЮчО░я╝Мш┐Щф╕кхЗ╜цХ░ф╝Ъш░ГчФи <strong>zrealloc хЗ╜цХ░</strong>я╝МцЭехоМцИРчй║щЧ┤чЪДщЗНцЦ░хИЖщЕНя╝МшАМщЗНцЦ░хИЖщЕНчЪДчй║щЧ┤хдзх░Пх░▒цШпчФ▒<strong>ф╝ахЕехПВцХ░ len</strong> хЖ│хоЪчЪДуАВш┐Щца╖я╝МцИСф╗мх░▒ф║ЖшзгхИ░ф║Ж ziplistResize хЗ╜цХ░ц╢ЙхПКхИ░хЖЕхнШхИЖщЕНцУНф╜Ья╝МхЫацндхжВцЮЬцИСф╗мх╛А ziplist щвСч╣БцПТхЕеш┐ЗхдЪцХ░цНочЪДшпЭя╝Мх░▒хПпшГ╜х╝Хш╡╖хдЪцмбхЖЕхнШхИЖщЕНя╝Мф╗ОшАМф╝Ъхп╣ Redis цАзшГ╜щАацИРх╜▒хУНуАВ</p> <p>ф╕ЛщЭвчЪДф╗гчаБцШ╛чд║ф║Ж ziplistResize хЗ╜цХ░чЪДщГихИЖхоЮчО░я╝Мф╜ахПпф╗ечЬЛф╕ЛуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">ziplistResize</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>zl<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//хп╣zlш┐ЫшбМщЗНцЦ░хЖЕхнШчй║щЧ┤хИЖщЕНя╝МщЗНцЦ░хИЖщЕНчЪДхдзх░ПцШпlen</span>
    zl <span class="token operator">=</span> <span class="token function">zrealloc</span><span class="token punctuation">(</span>zl<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    тАж
    zl<span class="token punctuation">[</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> ZIP_END<span class="token punctuation">;</span>
    <span class="token keyword">return</span> zl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хе╜ф║Жя╝МхИ░ш┐ЩщЗМя╝МцИСф╗мх░▒ф║Жшзгф║Ж ziplist хЬицЦ░цПТхЕехЕГч┤ацЧ╢я╝Мф╝ЪшобчоЧхЕ╢цЙАщЬАчЪДцЦ░хвЮчй║щЧ┤я╝Мх╣╢ш┐ЫшбМщЗНцЦ░хИЖщЕНуАВшАМх╜УцЦ░цПТхЕечЪДхЕГч┤аш╛ГхдзцЧ╢я╝Мх░▒ф╝Ъх╝Хш╡╖цПТхЕеф╜Нч╜очЪДхЕГч┤а prevlensize хвЮхКая╝Мш┐ЫшАМх░▒ф╝Ъхп╝шЗ┤цПТхЕеф╜Нч╜очЪДхЕГч┤ацЙАхНачй║щЧ┤ф╣ЯхвЮхКауАВ</p> <p>шАМхжВцндф╕АцЭея╝Мш┐ЩчзНчй║щЧ┤цЦ░хвЮх░▒ф╝Ъх╝Хш╡╖ш┐ЮщФБцЫ┤цЦ░чЪДщЧощвШуАВ</p> <p>хоЮщЩЕф╕Кя╝МцЙАш░УчЪД<strong>ш┐ЮщФБцЫ┤цЦ░</strong>я╝Мх░▒цШпцМЗх╜Уф╕Аф╕кхЕГч┤ацПТхЕехРОя╝Мф╝Ъх╝Хш╡╖х╜УхЙНф╜Нч╜охЕГч┤ацЦ░хвЮ prevlensize чЪДчй║щЧ┤уАВшАМх╜УхЙНф╜Нч╜охЕГч┤ачЪДчй║щЧ┤хвЮхКахРОя╝МхПИф╝Ъш┐Ыф╕Ацнех╝Хш╡╖шпехЕГч┤ачЪДхРОч╗нхЕГч┤ая╝МхЕ╢ prevlensize цЙАщЬАчй║щЧ┤чЪДхвЮхКауАВ</p> <p>ш┐Щца╖я╝Мф╕АцЧжцПТхЕеф╜Нч╜охРОч╗нчЪДцЙАцЬЙхЕГч┤ая╝МщГ╜ф╝ЪхЫаф╕║хЙНх║ПхЕГч┤ачЪД prevlenszie хвЮхКая╝МшАМх╝Хш╡╖шЗкш║лчй║щЧ┤ф╣ЯшжБхвЮхКая╝Мш┐ЩчзНцпПф╕кхЕГч┤ачЪДчй║щЧ┤щГ╜щЬАшжБхвЮхКачЪДчО░ш▒бя╝Мх░▒цШпш┐ЮщФБцЫ┤цЦ░уАВцИСчФ╗ф║Жф╕ЛщЭвш┐Щх╝ахЫ╛я╝Мф╜ахПпф╗ечЬЛф╕ЛуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409161959782.png" alt="image-20240916195950700"></p> <p>ш┐ЮщФБцЫ┤цЦ░ф╕АцЧжхПСчФЯя╝Мх░▒ф╝Ъхп╝шЗ┤ ziplist хНачФичЪДхЖЕхнШчй║щЧ┤шжБхдЪцмбщЗНцЦ░хИЖщЕНя╝Мш┐Щх░▒ф╝ЪчЫ┤цОех╜▒хУНхИ░ ziplist чЪДшо┐щЧоцАзшГ╜уАВ</p> <p>цЙАф╗ешп┤я╝МшЩ╜чД╢ ziplist ч┤зхЗСхЮЛчЪДхЖЕхнШх╕Гх▒АшГ╜шКВчЬБхЖЕхнШх╝АщФАя╝Мф╜ЖцШпхжВцЮЬф┐ЭхнШчЪДхЕГч┤ацХ░щЗПхвЮхКаф║Жя╝МцИЦцШпхЕГч┤ахПШхдзф║Жя╝Мziplist х░▒ф╝ЪщЭвф╕┤цАзшГ╜щЧощвШуАВщВгф╣Ия╝МцЬЙц▓бцЬЙф╗Аф╣ИцЦ╣ц│ХхПпф╗ещБ┐хЕН ziplist чЪДщЧощвШхСв</p> <p>ш┐Щх░▒цШпцОеф╕ЛцЭецИСшжБч╗Щф╜аф╗Лч╗НчЪД quicklist хТМ listpackя╝Мш┐Щф╕дчзНцХ░цНоч╗УцЮДчЪДшо╛шобцАЭцГ│ф║Ж</p> <h2 id="quicklist-шо╛шобф╕ОхоЮчО░"><a href="#quicklist-шо╛шобф╕ОхоЮчО░" class="header-anchor">#</a> quicklist шо╛шобф╕ОхоЮчО░</h2> <p>цИСф╗мхЕИцЭехнжф╣аф╕Л quicklist чЪДхоЮчО░цАЭш╖пуАВ</p> <p>quicklist чЪДшо╛шобя╝МхЕ╢хоЮцШпч╗УхРИф║ЖщУ╛шбихТМ ziplist хРДшЗкчЪДф╝ШхК┐уАВчоАхНХцЭешп┤я╝М<strong>ф╕Аф╕к quicklist х░▒цШпф╕Аф╕кщУ╛шбия╝МшАМщУ╛шбиф╕нчЪДцпПф╕кхЕГч┤ахПИцШпф╕Аф╕к ziplist</strong></p> <p>цИСф╗мцЭечЬЛф╕Л quicklist чЪДцХ░цНоч╗УцЮДя╝Мш┐ЩцШпхЬи<a href="https://github.com/redis/redis/tree/5.0/src/quicklist.h" target="_blank" rel="noopener noreferrer">quicklist.h<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>цЦЗф╗╢ф╕нхоЪф╣ЙчЪДя╝МшАМ quicklist чЪДхЕ╖ф╜УхоЮчО░цШпхЬи<a href="https://github.com/redis/redis/tree/5.0/src/quicklist.c" target="_blank" rel="noopener noreferrer">quicklist.c<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>цЦЗф╗╢ф╕нуАВ</p> <p>щжЦхЕИя╝Мquicklist хЕГч┤ачЪДхоЪф╣Йя╝Мф╣Ях░▒цШп quicklistNodeуАВхЫаф╕║ quicklist цШпф╕Аф╕кщУ╛шбия╝МцЙАф╗ецпПф╕к quicklistNode ф╕ня╝МщГ╜хМЕхРлф║ЖхИЖхИлцМЗхРСхоГхЙНх║ПхТМхРОх║ПшКВчВ╣чЪД<strong>цМЗщТИ</strong>prev хТМ next**уАВхРМцЧ╢я╝МцпПф╕к quicklistNode хПИцШпф╕Аф╕к ziplistя╝МцЙАф╗ея╝МхЬи quicklistNode чЪДч╗УцЮДф╜Уф╕ня╝Мш┐ШцЬЙцМЗхРС ziplist чЪД**цМЗщТИ zlуАВ</p> <p>цндхдЦя╝МquicklistNode ч╗УцЮДф╜Уф╕нш┐ШхоЪф╣Йф║Жф╕Аф║Ых▒ЮцАзя╝МцпФхжВ ziplist чЪДхнЧшКВхдзх░ПуАБхМЕхРлчЪДхЕГч┤аф╕кцХ░уАБч╝ЦчаБца╝х╝ПуАБхнШхВицЦ╣х╝ПчнЙуАВф╕ЛщЭвчЪДф╗гчаБцШ╛чд║ф║Ж quicklistNode чЪДч╗УцЮДф╜УхоЪф╣Йя╝Мф╜ахПпф╗ечЬЛф╕ЛуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">quicklistNode</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">quicklistNode</span> <span class="token operator">*</span>prev<span class="token punctuation">;</span>     <span class="token comment">//хЙНф╕Аф╕кquicklistNode</span>
    <span class="token keyword">struct</span> <span class="token class-name">quicklistNode</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>     <span class="token comment">//хРОф╕Аф╕кquicklistNode</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>zl<span class="token punctuation">;</span>              <span class="token comment">//quicklistNodeцМЗхРСчЪДziplist</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> sz<span class="token punctuation">;</span>                <span class="token comment">//ziplistчЪДхнЧшКВхдзх░П</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> count <span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">;</span>        <span class="token comment">//ziplistф╕нчЪДхЕГч┤аф╕кцХ░</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> encoding <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span>   <span class="token comment">//ч╝ЦчаБца╝х╝Пя╝МхОЯчФЯхнЧшКВцХ░ч╗ДцИЦхОЛч╝йхнШхВи</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> container <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">//хнШхВицЦ╣х╝П</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> recompress <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//цХ░цНоцШпхРжшвлхОЛч╝й</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> attempted_compress <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//цХ░цНошГ╜хРжшвлхОЛч╝й</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> extra <span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">//щвДчХЩчЪДbitф╜Н</span>
<span class="token punctuation">}</span> quicklistNode<span class="token punctuation">;</span>
</code></pre></div><p>ф║Жшзгф║Ж quicklistNode чЪДхоЪф╣Йя╝МцИСф╗мхЖНцЭечЬЛф╕Л quicklist чЪДч╗УцЮДф╜УхоЪф╣ЙуАВ</p> <p>quicklist ф╜Ьф╕║ф╕Аф╕кщУ╛шбич╗УцЮДя╝МхЬихоГчЪДцХ░цНоч╗УцЮДф╕ня╝МцШпхоЪф╣Йф║Ж<strong>цХ┤ф╕к quicklist чЪДхд┤уАБх░╛цМЗщТИ</strong>я╝Мш┐Щца╖ф╕АцЭея╝МцИСф╗мх░▒хПпф╗ещАЪш┐З quicklist чЪДцХ░цНоч╗УцЮДя╝МцЭех┐лщАЯхоЪф╜НхИ░ quicklist чЪДщУ╛шбихд┤хТМщУ╛шбих░╛уАВ</p> <p>цндхдЦя╝Мquicklist ф╕нш┐ШхоЪф╣Йф║Ж quicklistNode чЪДф╕кцХ░уАБцЙАцЬЙ ziplist чЪДцА╗хЕГч┤аф╕кцХ░чнЙх▒ЮцАзуАВquicklist чЪДч╗УцЮДхоЪф╣ЙхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">quicklist</span> <span class="token punctuation">{</span>
    quicklistNode <span class="token operator">*</span>head<span class="token punctuation">;</span>      <span class="token comment">//quicklistчЪДщУ╛шбихд┤</span>
    quicklistNode <span class="token operator">*</span>tail<span class="token punctuation">;</span>      <span class="token comment">//quicklistчЪДщУ╛шбих░╛</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> count<span class="token punctuation">;</span>     <span class="token comment">//цЙАцЬЙziplistф╕нчЪДцА╗хЕГч┤аф╕кцХ░</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> len<span class="token punctuation">;</span>       <span class="token comment">//quicklistNodesчЪДф╕кцХ░</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span> quicklist<span class="token punctuation">;</span>
</code></pre></div><p>чД╢хРОя╝Мф╗О quicklistNode хТМ quicklist чЪДч╗УцЮДф╜УхоЪф╣Йф╕ня╝МцИСф╗мх░▒шГ╜чФ╗хЗ║ф╕ЛщЭвш┐Щх╝а quicklist чЪДчд║цДПхЫ╛уАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409162000522.png" alt="image-20240916200049462"></p> <p>шАМф╣ЯцнгхЫаф╕║ quicklist щЗЗчФиф║ЖщУ╛шбич╗УцЮДя╝МцЙАф╗ех╜УцПТхЕеф╕Аф╕кцЦ░чЪДхЕГч┤ацЧ╢я╝Мquicklist щжЦхЕИх░▒ф╝ЪцгАцЯецПТхЕеф╜Нч╜очЪД ziplist цШпхРжшГ╜хо╣ч║│шпехЕГч┤ая╝Мш┐ЩцШпщАЪш┐З <strong>_quicklistNodeAllowInsert хЗ╜цХ░</strong>цЭехоМцИРхИдцЦнчЪДуАВ</p> <p>_quicklistNodeAllowInsert хЗ╜цХ░ф╝ЪшобчоЧцЦ░цПТхЕехЕГч┤ахРОчЪДхдзх░Пя╝Иnew_szя╝Йя╝Мш┐Щф╕кхдзх░ПчнЙф║О quicklistNode чЪДх╜УхЙНхдзх░Пя╝Иnode-&gt;szя╝ЙуАБцПТхЕехЕГч┤ачЪДхдзх░Пя╝Иszя╝Йя╝Мф╗ехПКцПТхЕехЕГч┤ахРО ziplist чЪД prevlen хНачФихдзх░ПуАВ</p> <p>хЬишобчоЧхоМхдзх░Пф╣ЛхРОя╝М_quicklistNodeAllowInsert хЗ╜цХ░ф╝Ъф╛ЭцмбхИдцЦнцЦ░цПТхЕечЪДцХ░цНохдзх░Пя╝Иszя╝ЙцШпхРжц╗бш╢│шжБц▒Вя╝МхН│<strong>хНХф╕к ziplist цШпхРжф╕Нш╢Еш┐З 8KBя╝МцИЦцШпхНХф╕к ziplist щЗМчЪДхЕГч┤аф╕кцХ░цШпхРжц╗бш╢│шжБц▒В</strong>уАВ</p> <p>хПкшжБш┐ЩщЗМщЭвчЪДф╕Аф╕кцЭбф╗╢шГ╜ц╗бш╢│я╝Мquicklist х░▒хПпф╗ехЬих╜УхЙНчЪД quicklistNode ф╕нцПТхЕецЦ░хЕГч┤ая╝МхРжхИЩ quicklist х░▒ф╝ЪцЦ░х╗║ф╕Аф╕к quicklistNodeя╝Мф╗ецндцЭеф┐ЭхнШцЦ░цПТхЕечЪДхЕГч┤ауАВ</p> <p>ф╕ЛщЭвф╗гчаБцШ╛чд║ф║ЖцШпхРжхЕБшо╕хЬих╜УхЙН quicklistNode цПТхЕецХ░цНочЪДхИдцЦнщА╗ш╛Ся╝Мф╜ахПпф╗ечЬЛф╕ЛуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">unsigned</span> <span class="token keyword">int</span> new_sz <span class="token operator">=</span> node<span class="token operator">-&gt;</span>sz <span class="token operator">+</span> sz <span class="token operator">+</span> ziplist_overhead<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">likely</span><span class="token punctuation">(</span><span class="token function">_quicklistNodeSizeMeetsOptimizationRequirement</span><span class="token punctuation">(</span>new_sz<span class="token punctuation">,</span> fill<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">sizeMeetsSafetyLimit</span><span class="token punctuation">(</span>new_sz<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>node<span class="token operator">-&gt;</span>count <span class="token operator">&lt;</span> fill<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">else</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre></div><p>ш┐Щца╖ф╕АцЭея╝Мquicklist щАЪш┐ЗцОзхИ╢цпПф╕к quicklistNode ф╕ня╝Мziplist чЪДхдзх░ПцИЦцШпхЕГч┤аф╕кцХ░я╝Мх░▒цЬЙцХИхЗПх░Сф║ЖхЬи ziplist ф╕нцЦ░хвЮцИЦф┐оцФ╣хЕГч┤ахРОя╝МхПСчФЯш┐ЮщФБцЫ┤цЦ░чЪДцГЕхЖ╡я╝Мф╗ОшАМцПРф╛Ыф║ЖцЫ┤хе╜чЪДшо┐щЧоцАзшГ╜уАВ</p> <p>шАМ Redis щЩдф║Жшо╛шобф║Ж quicklist ч╗УцЮДцЭех║Фхп╣ ziplist чЪДщЧощвШф╗ехдЦя╝Мш┐ШхЬи 5.0 чЙИцЬмф╕нцЦ░хвЮф║Ж listpack цХ░цНоч╗УцЮДя╝МчФицЭех╜╗х║ХщБ┐хЕНш┐ЮщФБцЫ┤цЦ░уАВф╕ЛщЭвцИСф╗мх░▒ч╗зч╗нцЭехнжф╣аф╕ЛхоГчЪДшо╛шобхоЮчО░цАЭш╖пуАВ</p> <h2 id="listpack-шо╛шобф╕ОхоЮчО░"><a href="#listpack-шо╛шобф╕ОхоЮчО░" class="header-anchor">#</a> listpack шо╛шобф╕ОхоЮчО░</h2> <p>listpack ф╣ЯхПлч┤зхЗСхИЧшбия╝МхоГчЪДчЙ╣чВ╣х░▒цШп<strong>чФиф╕АхЭЧш┐Юч╗нчЪДхЖЕхнШчй║щЧ┤цЭеч┤зхЗСхЬ░ф┐ЭхнШцХ░цНо</strong>я╝МхРМцЧ╢ф╕║ф║ЖшКВчЬБхЖЕхнШчй║щЧ┤я╝М<strong>listpack хИЧшбищб╣ф╜┐чФиф║ЖхдЪчзНч╝ЦчаБцЦ╣х╝Пя╝МцЭешбичд║ф╕НхРМщХ┐х║жчЪДцХ░цНо</strong>я╝Мш┐Щф║ЫцХ░цНохМЕцЛмцХ┤цХ░хТМхнЧчмжф╕▓уАВ</p> <p>хТМ listpack чЫ╕хЕ│чЪДхоЮчО░цЦЗф╗╢цШп<a href="https://github.com/redis/redis/blob/5.0/src/listpack.c" target="_blank" rel="noopener noreferrer">listpack.c<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>я╝Мхд┤цЦЗф╗╢хМЕцЛм<a href="https://github.com/redis/redis/tree/5.0/src/listpack.h" target="_blank" rel="noopener noreferrer">listpack.h<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>хТМ<a href="https://github.com/redis/redis/tree/5.0/src/listpack_malloc.h" target="_blank" rel="noopener noreferrer">listpack_malloc.h<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>уАВцИСф╗мхЕИцЭечЬЛф╕Л listpack чЪД<strong>хИЫх╗║хЗ╜цХ░ lpNew</strong>я╝МхЫаф╕║ф╗Ош┐Щф╕кхЗ╜цХ░чЪДф╗гчаБщА╗ш╛Сф╕ня╝МцИСф╗мхПпф╗еф║ЖшзгхИ░ listpack чЪДцХ┤ф╜Уч╗УцЮДуАВ</p> <p>lpNew хЗ╜цХ░хИЫх╗║ф║Жф╕Аф╕кчй║чЪД listpackя╝Мф╕Ах╝АхзЛхИЖщЕНчЪДхдзх░ПцШп LP_HDR_SIZE хЖНхКа 1 ф╕кхнЧшКВуАВLP_HDR_SIZE хоПхоЪф╣ЙцШпхЬи listpack.c ф╕ня╝МхоГщ╗ШшодцШп 6 ф╕кхнЧшКВя╝МхЕ╢ф╕н 4 ф╕кхнЧшКВцШпшо░х╜Х listpack чЪДцА╗хнЧшКВцХ░я╝М2 ф╕кхнЧшКВцШпшо░х╜Х listpack чЪДхЕГч┤ацХ░щЗПуАВ</p> <p>цндхдЦя╝Мlistpack чЪДцЬАхРОф╕Аф╕кхнЧшКВцШпчФицЭецаЗшпЖ listpack чЪДч╗УцЭЯя╝МхЕ╢щ╗ШшодхА╝цШпхоПхоЪф╣Й LP_EOFуАВхТМ ziplist хИЧшбищб╣чЪДч╗УцЭЯцаЗшо░ф╕Аца╖я╝МLP_EOF чЪДхА╝ф╣ЯцШп 255уАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">lpNew</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//хИЖщЕНLP_HRD_SIZE+1</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>lp <span class="token operator">=</span> <span class="token function">lp_malloc</span><span class="token punctuation">(</span>LP_HDR_SIZE<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token comment">//шо╛ч╜оlistpackчЪДхдзх░П</span>
    <span class="token function">lpSetTotalBytes</span><span class="token punctuation">(</span>lp<span class="token punctuation">,</span>LP_HDR_SIZE<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//шо╛ч╜оlistpackчЪДхЕГч┤аф╕кцХ░я╝МхИЭхзЛхА╝ф╕║0</span>
    <span class="token function">lpSetNumElements</span><span class="token punctuation">(</span>lp<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//шо╛ч╜оlistpackчЪДч╗Ух░╛цаЗшпЖф╕║LP_EOFя╝МхА╝ф╕║255</span>
    lp<span class="token punctuation">[</span>LP_HDR_SIZE<span class="token punctuation">]</span> <span class="token operator">=</span> LP_EOF<span class="token punctuation">;</span>
    <span class="token keyword">return</span> lp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ф╜ахПпф╗ечЬЛчЬЛф╕ЛщЭвш┐Щх╝ахЫ╛я╝Мх▒Хчд║чЪДх░▒цШпхдзх░Пф╕║ LP_HDR_SIZE чЪД listpack хд┤хТМхА╝ф╕║ 255 чЪД listpack х░╛уАВх╜УцЬЙцЦ░хЕГч┤ацПТхЕецЧ╢я╝МшпехЕГч┤аф╝ЪшвлцПТхЬи listpack хд┤хТМх░╛ф╣ЛщЧ┤уАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409162001409.png" alt="image-20240916200137358"></p> <p>хе╜ф║Жя╝Мф║Жшзгф║Ж listpack чЪДцХ┤ф╜Уч╗УцЮДхРОя╝МцИСф╗мхЖНцЭечЬЛф╕Л listpack хИЧшбищб╣чЪДшо╛шобуАВ</p> <p>хТМ ziplist хИЧшбищб╣ч▒╗ф╝╝я╝Мlistpack хИЧшбищб╣ф╣ЯхМЕхРлф║ЖхЕГцХ░цНоф┐бцБпхТМцХ░цНоцЬмш║луАВф╕Нш┐Зя╝Мф╕║ф║ЖщБ┐хЕН ziplist х╝Хш╡╖чЪДш┐ЮщФБцЫ┤цЦ░щЧощвШя╝Мlistpack ф╕нчЪДцпПф╕кхИЧшбищб╣ф╕НхЖНхГП ziplist хИЧшбищб╣щВгца╖я╝Мф┐ЭхнШхЕ╢хЙНф╕Аф╕кхИЧшбищб╣чЪДщХ┐х║жя╝М<strong>хоГхПкф╝ЪхМЕхРлф╕Йф╕кцЦ╣щЭвхЖЕхо╣</strong>я╝МхИЖхИлцШпх╜УхЙНхЕГч┤ачЪДч╝ЦчаБч▒╗хЮЛя╝Иentry-encodingя╝ЙуАБхЕГч┤ацХ░цНо (entry-data)я╝Мф╗ехПКч╝ЦчаБч▒╗хЮЛхТМхЕГч┤ацХ░цНош┐Щф╕дщГихИЖчЪДщХ┐х║ж (entry-len)я╝МхжВф╕ЛхЫ╛цЙАчд║уАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409162001838.png" alt="image-20240916200146785"></p> <p>ш┐ЩщЗМя╝МхЕ│ф║О listpack хИЧшбищб╣чЪДшо╛шобя╝Мф╜ащЬАшжБщЗНчВ╣цОМцПбф╕дцЦ╣щЭвчЪДшжБчВ╣я╝МхИЖхИлцШпхИЧшбищб╣хЕГч┤ачЪДч╝ЦчаБч▒╗хЮЛя╝Мф╗ехПКхИЧшбищб╣щБ┐хЕНш┐ЮщФБцЫ┤цЦ░чЪДцЦ╣ц│ХуАВф╕ЛщЭвцИСх░▒х╕жф╜ахЕ╖ф╜Уф║Жшзгф╕ЛуАВ</p> <h3 id="listpack-хИЧшбищб╣ч╝ЦчаБцЦ╣ц│Х"><a href="#listpack-хИЧшбищб╣ч╝ЦчаБцЦ╣ц│Х" class="header-anchor">#</a> listpack хИЧшбищб╣ч╝ЦчаБцЦ╣ц│Х</h3> <p>цИСф╗мхЕИцЭечЬЛф╕Л listpack хЕГч┤ачЪДч╝ЦчаБч▒╗хЮЛуАВхжВцЮЬф╜ачЬЛф║Ж listpack.c цЦЗф╗╢я╝Мф╜аф╝ЪхПСчО░шпецЦЗф╗╢ф╕нцЬЙхдзщЗПч▒╗ф╝╝ LP_ENCODING<strong>XX_BIT_INT хТМ LP_ENCODING</strong>XX_BIT_STR чЪДхоПхоЪф╣Йя╝МхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LP_ENCODING_7BIT_UINT</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LP_ENCODING_6BIT_STR</span> <span class="token expression"><span class="token number">0x80</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LP_ENCODING_13BIT_INT</span> <span class="token expression"><span class="token number">0xC0</span></span></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LP_ENCODING_64BIT_INT</span> <span class="token expression"><span class="token number">0xF4</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LP_ENCODING_32BIT_STR</span> <span class="token expression"><span class="token number">0xF0</span></span></span>
</code></pre></div><p>ш┐Щф║ЫхоПхоЪф╣ЙхЕ╢хоЮх░▒хп╣х║Фф║Ж listpack чЪДхЕГч┤ач╝ЦчаБч▒╗хЮЛуАВхЕ╖ф╜УцЭешп┤я╝М<strong>listpack хЕГч┤аф╝Ъхп╣ф╕НхРМщХ┐х║жчЪДцХ┤цХ░хТМхнЧчмжф╕▓ш┐ЫшбМч╝ЦчаБ</strong>я╝Мш┐ЩщЗМцИСф╗мхИЖхИлцЭечЬЛф╕ЛуАВ</p> <p>щжЦхЕИя╝Мхп╣ф║О<strong>цХ┤цХ░ч╝ЦчаБ</strong>цЭешп┤я╝Мх╜У listpack хЕГч┤ачЪДч╝ЦчаБч▒╗хЮЛф╕║ LP_ENCODING_7BIT_UINT цЧ╢я╝Мшбичд║хЕГч┤ачЪДхоЮщЩЕцХ░цНоцШпф╕Аф╕к 7 bit чЪДцЧачмжхП╖цХ┤цХ░уАВхПИхЫаф╕║ LP_ENCODING_7BIT_UINT цЬмш║лчЪДхоПхоЪф╣ЙхА╝ф╕║ 0я╝МцЙАф╗еч╝ЦчаБч▒╗хЮЛчЪДхА╝ф╣ЯчЫ╕х║Фф╕║ 0я╝МхНа 1 ф╕к bitуАВ</p> <p>цндцЧ╢я╝Мч╝ЦчаБч▒╗хЮЛхТМхЕГч┤ахоЮщЩЕцХ░цНохЕ▒чФи 1 ф╕кхнЧшКВя╝Мш┐Щф╕кхнЧшКВчЪДцЬАщлШф╜Нф╕║ 0я╝Мшбичд║ч╝ЦчаБч▒╗хЮЛя╝МхРОч╗нчЪД 7 ф╜НчФицЭехнШхВи 7 bit чЪДцЧачмжхП╖цХ┤цХ░я╝МхжВф╕ЛхЫ╛цЙАчд║я╝Ъ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409162002422.png" alt="image-20240916200200371"></p> <p>шАМх╜Уч╝ЦчаБч▒╗хЮЛф╕║ LP_ENCODING_13BIT_INT цЧ╢я╝Мш┐Щшбичд║хЕГч┤ачЪДхоЮщЩЕцХ░цНоцШп 13 bit чЪДцХ┤цХ░уАВхРМцЧ╢я╝МхЫаф╕║ LP_ENCODING_13BIT_INT чЪДхоПхоЪф╣ЙхА╝ф╕║ 0xC0я╝Мш╜мцНвф╕║ф║Мш┐ЫхИ╢хА╝цШп 1100 0000я╝МцЙАф╗ея╝Мш┐Щф╕кф║Мш┐ЫхИ╢хА╝ф╕нчЪДхРО 5 ф╜НхТМхРОч╗нчЪД 1 ф╕кхнЧшКВя╝МхЕ▒ 13 ф╜Ня╝Мф╝ЪчФицЭеф┐ЭхнШ 13bit чЪДцХ┤цХ░уАВшАМшпеф║Мш┐ЫхИ╢хА╝ф╕нчЪДхЙН 3 ф╜Н 110я╝МхИЩчФицЭешбичд║х╜УхЙНчЪДч╝ЦчаБч▒╗хЮЛуАВцИСчФ╗ф║Жф╕ЛщЭвш┐Щх╝ахЫ╛я╝Мф╜ахПпф╗ечЬЛф╕ЛуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409162002531.png" alt=""></p> <p>хе╜я╝МхЬиф║Жшзгф║Ж LP_ENCODING_7BIT_UINT хТМ LP_ENCODING_13BIT_INT ш┐Щф╕дчзНч╝ЦчаБч▒╗хЮЛхРОя╝МхЙйф╕ЛчЪД LP_ENCODING_16BIT_INTуАБLP_ENCODING_24BIT_INTуАБLP_ENCODING_32BIT_INT хТМ LP_ENCODING_64BIT_INTя╝Мф╜ах║Фшпеф╣Ях░▒шГ╜чЯещБУхоГф╗мчЪДч╝ЦчаБцЦ╣х╝Пф║ЖуАВ</p> <p>ш┐ЩхЫЫчзНч▒╗хЮЛцШпхИЖхИлчФи 2 хнЧшКВя╝И16 bitя╝ЙуАБ3 хнЧшКВя╝И24 bitя╝ЙуАБ4 хнЧшКВя╝И32 bitя╝ЙхТМ 8 хнЧшКВя╝И64 bitя╝ЙцЭеф┐ЭхнШцХ┤цХ░цХ░цНоуАВхРМцЧ╢я╝МхоГф╗мчЪДч╝ЦчаБч▒╗хЮЛцЬмш║лхНа 1 хнЧшКВя╝Мч╝ЦчаБч▒╗хЮЛхА╝хИЖхИлцШпхоГф╗мчЪДхоПхоЪф╣ЙхА╝уАВ</p> <p>чД╢хРОя╝Мхп╣ф║О<strong>хнЧчмжф╕▓ч╝ЦчаБ</strong>цЭешп┤я╝Мф╕АхЕ▒цЬЙф╕ЙчзНч▒╗хЮЛя╝МхИЖхИлцШп LP_ENCODING_6BIT_STRуАБLP_ENCODING_12BIT_STR хТМ LP_ENCODING_32BIT_STRуАВф╗ОхИЪцЙНчЪДф╗Лч╗Нф╕ня╝Мф╜ахПпф╗ечЬЛхИ░я╝МцХ┤цХ░ч╝ЦчаБч▒╗хЮЛхРНчз░ф╕н BIT хЙНщЭвчЪДцХ░хнЧя╝Мшбичд║чЪДцШпцХ┤цХ░чЪДщХ┐х║жуАВхЫацндч▒╗ф╝╝чЪДя╝МхнЧчмжф╕▓ч╝ЦчаБч▒╗хЮЛхРНчз░ф╕н BIT хЙНчЪДцХ░хнЧя╝Мшбичд║чЪДх░▒цШпхнЧчмжф╕▓чЪДщХ┐х║жуАВ</p> <p>цпФхжВя╝Мх╜Уч╝ЦчаБч▒╗хЮЛф╕║ LP_ENCODING_6BIT_STR цЧ╢я╝Мч╝ЦчаБч▒╗хЮЛхНа 1 хнЧшКВуАВшпеч▒╗хЮЛчЪДхоПхоЪф╣ЙхА╝цШп 0x80я╝Мхп╣х║ФчЪДф║Мш┐ЫхИ╢хА╝цШп 1000 0000я╝Мш┐ЩхЕ╢ф╕нчЪДхЙН 2 ф╜НцШпчФицЭецаЗшпЖч╝ЦчаБч▒╗хЮЛцЬмш║ля╝МшАМхРО 6 ф╜Нф┐ЭхнШчЪДцШпхнЧчмжф╕▓щХ┐х║жуАВчД╢хРОя╝МхИЧшбищб╣ф╕нчЪДцХ░цНощГихИЖф┐ЭхнШф║ЖхоЮщЩЕчЪДхнЧчмжф╕▓уАВ</p> <p>ф╕ЛщЭвчЪДхЫ╛х▒Хчд║ф║Жф╕ЙчзНхнЧчмжф╕▓ч╝ЦчаБч▒╗хЮЛхТМцХ░цНочЪДх╕Гх▒Ая╝Мф╜ахПпф╗ечЬЛф╕ЛуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409162002153.png" alt="image-20240916200218058"></p> <h3 id="listpack-щБ┐хЕНш┐ЮщФБцЫ┤цЦ░чЪДхоЮчО░цЦ╣х╝П"><a href="#listpack-щБ┐хЕНш┐ЮщФБцЫ┤цЦ░чЪДхоЮчО░цЦ╣х╝П" class="header-anchor">#</a> listpack щБ┐хЕНш┐ЮщФБцЫ┤цЦ░чЪДхоЮчО░цЦ╣х╝П</h3> <p>цЬАхРОя╝МцИСф╗мхЖНцЭеф║Жшзгф╕Л listpack хИЧшбищб╣цШпхжВф╜ХщБ┐хЕНш┐ЮщФБцЫ┤цЦ░чЪДуАВ</p> <p>хЬи listpack ф╕ня╝МхЫаф╕║цпПф╕кхИЧшбищб╣хПкшо░х╜ХшЗкх╖▒чЪДщХ┐х║жя╝МшАМф╕Нф╝ЪхГП ziplist ф╕нчЪДхИЧшбищб╣щВгца╖я╝Мф╝Ъшо░х╜ХхЙНф╕Ащб╣чЪДщХ┐х║жуАВцЙАф╗ея╝Мх╜УцИСф╗мхЬи listpack ф╕нцЦ░хвЮцИЦф┐оцФ╣хЕГч┤ацЧ╢я╝МхоЮщЩЕф╕КхПкф╝Ъц╢ЙхПКцпПф╕кхИЧшбищб╣шЗкх╖▒чЪДцУНф╜Ья╝МшАМф╕Нф╝Ъх╜▒хУНхРОч╗нхИЧшбищб╣чЪДщХ┐х║жхПШхМЦя╝Мш┐Щх░▒щБ┐хЕНф║Жш┐ЮщФБцЫ┤цЦ░уАВ</p> <p>ф╕Нш┐Зя╝Мф╜ахПпшГ╜ф╝ЪцЬЙчЦСщЧоя╝Ъ<strong>хжВцЮЬ listpack хИЧшбищб╣хПкшо░х╜Хх╜УхЙНщб╣чЪДщХ┐х║жя╝МщВгф╣И listpack цФпцМБф╗Ох╖жхРСхП│цнгхРСцЯешпвхИЧшбия╝МцИЦцШпф╗ОхП│хРСх╖жхПНхРСцЯешпвхИЧшбихРЧя╝Я</strong></p> <p>хЕ╢хоЮя╝Мlistpack цШпшГ╜цФпцМБцнгуАБхПНхРСцЯешпвхИЧшбичЪДуАВ</p> <p><strong>х╜Ух║ФчФичиЛх║Пф╗Ох╖жхРСхП│цнгхРСцЯешпв listpack цЧ╢</strong>я╝МцИСф╗мхПпф╗ехЕИш░ГчФи lpFirst хЗ╜цХ░уАВшпехЗ╜цХ░чЪДхПВцХ░цШпцМЗхРС listpack хд┤чЪДцМЗщТИя╝МхоГхЬицЙзшбМцЧ╢я╝Мф╝ЪшойцМЗщТИхРСхП│хБПчз╗ LP_HDR_SIZE хдзх░Пя╝Мф╣Ях░▒цШпш╖│ш┐З listpack хд┤уАВф╜ахПпф╗ечЬЛф╕Л lpFirst хЗ╜цХ░чЪДф╗гчаБя╝МхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">lpFirst</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>lp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    lp <span class="token operator">+=</span> LP_HDR_SIZE<span class="token punctuation">;</span> <span class="token comment">//ш╖│ш┐Зlistpackхд┤щГи6ф╕кхнЧшКВ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> LP_EOF<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  <span class="token comment">//хжВцЮЬх╖▓ч╗ПцШпlistpackчЪДцЬлх░╛ч╗УцЭЯхнЧшКВя╝МхИЩш┐ФхЫЮNULL</span>
    <span class="token keyword">return</span> lp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>чД╢хРОя╝МхЖНш░ГчФи lpNext хЗ╜цХ░я╝МшпехЗ╜цХ░чЪДхПВцХ░хМЕцЛмф║ЖцМЗхРС listpack цЯРф╕кхИЧшбищб╣чЪДцМЗщТИуАВlpNext хЗ╜цХ░ф╝Ъш┐Ыф╕Ацнеш░ГчФи lpSkip хЗ╜цХ░я╝Мх╣╢ф╝ахЕех╜УхЙНхИЧшбищб╣чЪДцМЗщТИя╝МхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">lpNext</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>lp<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    p <span class="token operator">=</span> <span class="token function">lpSkip</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//ш░ГчФиlpSkipхЗ╜цХ░я╝МхБПчз╗цМЗщТИцМЗхРСф╕Лф╕Аф╕кхИЧшбищб╣</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> LP_EOF<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> p<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цЬАхРОя╝МlpSkip хЗ╜цХ░ф╝ЪхЕИхРОш░ГчФи lpCurrentEncodedSize хТМ lpEncodeBacklen ш┐Щф╕дф╕кхЗ╜цХ░уАВ</p> <p>lpCurrentEncodedSize хЗ╜цХ░цШпца╣цНох╜УхЙНхИЧшбищб╣чмм 1 ф╕кхнЧшКВчЪДхПЦхА╝я╝МцЭешобчоЧх╜УхЙНщб╣чЪДч╝ЦчаБч▒╗хЮЛя╝Мх╣╢ца╣цНоч╝ЦчаБч▒╗хЮЛя╝МшобчоЧх╜УхЙНщб╣ч╝ЦчаБч▒╗хЮЛхТМхоЮщЩЕцХ░цНочЪДцА╗щХ┐х║жуАВчД╢хРОя╝МlpEncodeBacklen хЗ╜цХ░ф╝Ъца╣цНоч╝ЦчаБч▒╗хЮЛхТМхоЮщЩЕцХ░цНочЪДщХ┐х║жф╣ЛхТМя╝Мш┐Ыф╕АцнешобчоЧхИЧшбищб╣цЬАхРОф╕АщГихИЖ entry-len цЬмш║лчЪДщХ┐х║жуАВ</p> <p>ш┐Щца╖ф╕АцЭея╝МlpSkip хЗ╜цХ░х░▒чЯещБУх╜УхЙНщб╣чЪДч╝ЦчаБч▒╗хЮЛуАБхоЮщЩЕцХ░цНохТМ entry-len чЪДцА╗щХ┐х║жф║Жя╝Мф╣Ях░▒хПпф╗ех░Жх╜УхЙНщб╣цМЗщТИхРСхП│хБПчз╗чЫ╕х║ФчЪДщХ┐х║жя╝Мф╗ОшАМхоЮчО░цЯехИ░ф╕Лф╕Аф╕кхИЧшбищб╣чЪДчЫочЪДуАВ</p> <p>ф╕ЛщЭвф╗гчаБх▒Хчд║ф║Ж lpEncodeBacklen хЗ╜цХ░чЪДхЯ║цЬмшобчоЧщА╗ш╛Ся╝Мф╜ахПпф╗ечЬЛф╕ЛуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token function">lpEncodeBacklen</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">uint64_t</span> l<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//ч╝ЦчаБч▒╗хЮЛхТМхоЮщЩЕцХ░цНочЪДцА╗щХ┐х║жх░Пф║ОчнЙф║О127я╝Мentry-lenщХ┐х║жф╕║1хнЧшКВ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">&lt;=</span> <span class="token number">127</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">&lt;</span> <span class="token number">16383</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//ч╝ЦчаБч▒╗хЮЛхТМхоЮщЩЕцХ░цНочЪДцА╗щХ┐х║жхдзф║О127ф╜Жх░Пф║О16383я╝Мentry-lenщХ┐х║жф╕║2хнЧшКВ</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">&lt;</span> <span class="token number">2097151</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//ч╝ЦчаБч▒╗хЮЛхТМхоЮщЩЕцХ░цНочЪДцА╗щХ┐х║жхдзф║О16383ф╜Жх░Пф║О2097151я╝Мentry-lenщХ┐х║жф╕║3хнЧшКВ</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">&lt;</span> <span class="token number">268435455</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//ч╝ЦчаБч▒╗хЮЛхТМхоЮщЩЕцХ░цНочЪДцА╗щХ┐х║жхдзф║О2097151ф╜Жх░Пф║О268435455я╝Мentry-lenщХ┐х║жф╕║4хнЧшКВ</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//хРжхИЩя╝Мentry-lenщХ┐х║жф╕║5хнЧшКВ</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цИСф╣ЯчФ╗ф║Жф╕Ах╝ахЫ╛я╝Мх▒Хчд║ф║Жф╗Ох╖жхРСхП│щБНхОЖ listpack чЪДхЯ║цЬмш┐ЗчиЛя╝Мф╜ахПпф╗ехЖНхЫЮщб╛ф╕ЛуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409162002083.png" alt="image-20240916200230974"></p> <p>хе╜я╝Мф║Жшзгф║Жф╗Ох╖жхРСхП│цнгхРСцЯешпв listpackя╝МцИСф╗мхЖНцЭечЬЛф╕Л<strong>ф╗ОхП│хРСх╖жхПНхРСцЯешпв listpack</strong>уАВ</p> <p>щжЦхЕИя╝МцИСф╗мца╣цНо listpack хд┤ф╕ншо░х╜ХчЪД listpack цА╗щХ┐х║жя╝Мх░▒хПпф╗ечЫ┤цОехоЪф╜НхИ░ listapck чЪДх░╛щГич╗УцЭЯцаЗшо░уАВчД╢хРОя╝МцИСф╗мхПпф╗еш░ГчФи lpPrev хЗ╜цХ░я╝МшпехЗ╜цХ░чЪДхПВцХ░хМЕцЛмцМЗхРСцЯРф╕кхИЧшбищб╣чЪДцМЗщТИя╝Мх╣╢ш┐ФхЫЮцМЗхРСх╜УхЙНхИЧшбищб╣хЙНф╕Ащб╣чЪДцМЗщТИуАВ</p> <p>lpPrev хЗ╜цХ░ф╕нчЪДхЕ│щФоф╕Ацнех░▒цШпш░ГчФи lpDecodeBacklen хЗ╜цХ░уАВlpDecodeBacklen хЗ╜цХ░ф╝Ъф╗ОхП│хРСх╖жя╝МщАРф╕кхнЧшКВхЬ░шп╗хПЦх╜УхЙНхИЧшбищб╣чЪД entry-lenуАВ</p> <p>щВгф╣Ия╝М<strong>lpDecodeBacklen хЗ╜цХ░хжВф╜ХхИдцЦн entry-len цШпхРжч╗УцЭЯф║ЖхСвя╝Я</strong></p> <p>ш┐Щх░▒ф╛Эш╡Цф║О entry-len чЪДч╝ЦчаБцЦ╣х╝Пф║ЖуАВentry-len цпПф╕кхнЧшКВчЪДцЬАщлШф╜Ня╝МцШпчФицЭешбичд║х╜УхЙНхнЧшКВцШпхРжф╕║ entry-len чЪДцЬАхРОф╕Аф╕кхнЧшКВя╝Мш┐ЩщЗМхнШхЬиф╕дчзНцГЕхЖ╡я╝МхИЖхИлцШпя╝Ъ</p> <ul><li>цЬАщлШф╜Нф╕║ 1я╝Мшбичд║ entry-len ш┐Шц▓бцЬЙч╗УцЭЯя╝Мх╜УхЙНхнЧшКВчЪДх╖жш╛╣хнЧшКВф╗НчД╢шбичд║ entry-len чЪДхЖЕхо╣я╝Ы</li> <li>цЬАщлШф╜Нф╕║ 0я╝Мшбичд║х╜УхЙНхнЧшКВх╖▓ч╗ПцШп entry-len цЬАхРОф╕Аф╕кхнЧшКВф║ЖуАВ</li></ul> <p>шАМ entry-len цпПф╕кхнЧшКВчЪДф╜О 7 ф╜Ня╝МхИЩшо░х╜Хф║ЖхоЮщЩЕчЪДщХ┐х║жф┐бцБпуАВш┐ЩщЗМф╜ащЬАшжБц│ицДПчЪДцШпя╝Мentry-len цпПф╕кхнЧшКВчЪДф╜О 7 ф╜НщЗЗчФиф║Ж<strong>хдзчлпцибх╝ПхнШхВи</strong>я╝Мф╣Ях░▒цШпшп┤я╝Мentry-len чЪДф╜Оф╜НхнЧшКВф┐ЭхнШхЬихЖЕхнШщлШхЬ░хЭАф╕КуАВ</p> <p>цИСчФ╗ф║Жф╕ЛщЭвш┐Щх╝ахЫ╛я╝Мх▒Хчд║ф║Ж entry-len ш┐ЩчзНчЙ╣хИлчЪДч╝ЦчаБцЦ╣х╝Пя╝Мф╜ахПпф╗ечЬЛф╕ЛуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409162002084.png" alt="image-20240916200241006"></p> <p>хоЮщЩЕф╕Кя╝МцнгцШпхЫаф╕║цЬЙф║Ж entry-len чЪДчЙ╣хИлч╝ЦчаБцЦ╣х╝Пя╝МlpDecodeBacklen хЗ╜цХ░х░▒хПпф╗еф╗Ох╜УхЙНхИЧшбищб╣ш╡╖хзЛф╜Нч╜очЪДцМЗщТИх╝АхзЛя╝МхРСх╖жщАРф╕кхнЧшКВшзгцЮРя╝Мх╛ЧхИ░хЙНф╕Ащб╣чЪД entry-len хА╝уАВш┐Щф╣ЯцШп lpDecodeBacklen хЗ╜цХ░чЪДш┐ФхЫЮхА╝уАВшАМф╗ОхИЪцЙНчЪДф╗Лч╗Нф╕ня╝МцИСф╗мчЯещБУ entry-len шо░х╜Хф║Жч╝ЦчаБч▒╗хЮЛхТМхоЮщЩЕцХ░цНочЪДщХ┐х║жф╣ЛхТМуАВ</p> <p>хЫацндя╝МlpPrev хЗ╜цХ░ф╝ЪхЖНш░ГчФи lpEncodeBacklen хЗ╜цХ░я╝МцЭешобчоЧх╛ЧхИ░ entry-len цЬмш║лщХ┐х║жя╝Мш┐Щца╖ф╕АцЭея╝МцИСф╗мх░▒хПпф╗ех╛ЧхИ░хЙНф╕Ащб╣чЪДцА╗щХ┐х║жя╝МшАМ lpPrev хЗ╜цХ░ф╣Ях░▒хПпф╗ех░ЖцМЗщТИцМЗхРСхЙНф╕Ащб╣чЪДш╡╖хзЛф╜Нч╜оф║ЖуАВцЙАф╗ецМЙчЕзш┐Щф╕кцЦ╣ц│Хя╝Мlistpack х░▒хоЮчО░ф║Жф╗ОхП│хРСх╖жчЪДцЯешпвхКЯшГ╜уАВ</p> <h2 id="хп╣цпФ"><a href="#хп╣цпФ" class="header-anchor">#</a> хп╣цпФ</h2> <table><thead><tr><th>чЙ╣цАз</th> <th>ziplist</th> <th>quicklist</th> <th>listpack</th></tr></thead> <tbody><tr><td>шо╛шобхдНцЭВх║ж</td> <td>ш╛Гф╕║хдНцЭВя╝МхМЕхРлхЙНф╕Аф╕кшКВчВ╣щХ┐х║жхнЧцо╡</td> <td>хдНцЭВ</td> <td>цЫ┤хКачоАхМЦя╝Мц▓бцЬЙхЙНф╕Аф╕кшКВчВ╣щХ┐х║жхнЧцо╡</td></tr> <tr><td>хЖЕхнШхНачФи</td> <td>хнШхЬихЖЧф╜ЩхнЧцо╡я╝МхЖЕхнШхИйчФичОЗш╛Гф╜О</td> <td>щлШ</td> <td>цЫ┤хКач┤зхЗСя╝МхЖЕхнШхНачФиф╜О</td></tr> <tr><td>цУНф╜ЬхдНцЭВх║ж</td> <td>цПТхЕеуАБхИащЩдцУНф╜ЬщЬАшжБцЫ┤цЦ░хЙНхРСшКВчВ╣щХ┐х║жя╝Мш╛ГцЕв</td> <td>ф╕н</td> <td>цУНф╜ЬчоАхНХщлШцХИя╝МцЧащЬАхдДчРЖхЙНхРСшКВчВ╣щХ┐х║жя╝Мф╜ЖцШпф╣ЯшжБчз╗хКи</td></tr> <tr><td>хЖЕхнШчз╗хКищЧощвШ</td> <td>щвСч╣БцПТхЕехИащЩдхПпшГ╜хп╝шЗ┤хдзшМГхЫ┤хЖЕхнШчз╗хКи</td> <td>ф╕н</td> <td>ф╗НхнШхЬихЖЕхнШчз╗хКищЧощвШя╝Мф╜ЖцУНф╜ЬцЫ┤хКачоАхНХ</td></tr> <tr><td>щАВчФихЬ║цЩп</td> <td>х░П hashя╝Мх░П zset</td> <td>list</td> <td>х░П hashя╝Мх░П zsetя╝Мх░П stream</td></tr></tbody></table> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409162019509.jpeg" alt="img"></p> <div class="custom-block note"><p class="custom-block-title">чмФшо░</p> <p>echo шодф╕║я╝Мziplist хТМ listpack щАВчФиф║ОхЕГч┤аш╛Гх░СцЧ╢чЪДхнШхВия╝Мф╕АцЧжхЕГч┤ахПШхдЪх░▒щЬАщЗЗчФи quicklist ш┐ЩчзНч▒╗ф╝╝ф║О linkedlist чЪДч╗УцЮДцЭеш┐ЫшбМхнШхВия╝Мф╜ЖцШп quicklist чЪД node цЬЙф╕дчзНщАЙцЛйя╝МхИЖхИлцШп ziplist хТМ listpackя╝МхЬицЬАцЦ░чЪДчЙИцЬмф╕нш▓Мф╝╝щГ╜цШпщЗЗчФи listpack цЭехоЮчО░чЪД</p></div> <h2 id="цА╗ч╗У"><a href="#цА╗ч╗У" class="header-anchor">#</a> цА╗ч╗У</h2> <p>цЬмцЦЗф╗О ziplist чЪДшо╛шобф╕Нш╢│хЗ║хПСя╝МхИ░хнжф╣а quicklist хТМ listpack чЪДшо╛шобцАЭцГ│</p> <p>ф╜ашжБчЯещБУя╝Мziplist чЪДф╕Нш╢│ф╕╗шжБхЬиф║О<strong>ф╕АцЧж ziplist ф╕нхЕГч┤аф╕кцХ░хдЪф║Жя╝МхоГчЪДцЯецЙ╛цХИчОЗх░▒ф╝ЪщЩНф╜О</strong>уАВшАМф╕ФхжВцЮЬхЬи ziplist щЗМцЦ░хвЮцИЦф┐оцФ╣цХ░цНоя╝Мziplist хНачФичЪДхЖЕхнШчй║щЧ┤ш┐ШщЬАшжБ<strong>щЗНцЦ░хИЖщЕН</strong>я╝ЫцЫ┤ч│Яч│ХчЪДцШпя╝Мziplist цЦ░хвЮцЯРф╕кхЕГч┤ацИЦф┐оцФ╣цЯРф╕кхЕГч┤ацЧ╢я╝МхПпшГ╜ф╝Ъхп╝шЗ┤хРОч╗нхЕГч┤ачЪД prevlen хНачФичй║щЧ┤щГ╜хПСчФЯхПШхМЦя╝Мф╗ОшАМх╝Хш╡╖<strong>ш┐ЮщФБцЫ┤цЦ░</strong>щЧощвШя╝Мхп╝шЗ┤цпПф╕кхЕГч┤ачЪДчй║щЧ┤щГ╜шжБщЗНцЦ░хИЖщЕНя╝Мш┐Щх░▒ф╝Ъхп╝шЗ┤ ziplist чЪДшо┐щЧоцАзшГ╜ф╕ЛщЩНуАВ</p> <p>цЙАф╗ея╝Мф╕║ф║Жх║Фхп╣ ziplist чЪДщЧощвШя╝МRedis хЕИцШпхЬи 3.0 чЙИцЬмф╕ншо╛шобхоЮчО░ф║Ж quicklistуАВquicklist ч╗УцЮДхЬи ziplist хЯ║чбАф╕Кя╝Мф╜┐чФищУ╛шбих░Ж ziplist ф╕▓шБФш╡╖цЭея╝МщУ╛шбичЪДцпПф╕кхЕГч┤ах░▒цШпф╕Аф╕к ziplistуАВш┐ЩчзНшо╛шоб<strong>хЗПх░Сф║ЖцХ░цНоцПТхЕецЧ╢хЖЕхнШчй║щЧ┤чЪДщЗНцЦ░хИЖщЕНя╝Мф╗ехПКхЖЕхнШцХ░цНочЪДцЛ╖ш┤Э</strong>уАВхРМцЧ╢я╝Мquicklist щЩРхИ╢ф║ЖцпПф╕кшКВчВ╣ф╕К ziplist чЪДхдзх░Пя╝Мф╕АцЧжф╕Аф╕к ziplist ш┐Зхдзя╝Мх░▒ф╝ЪщЗЗчФицЦ░хвЮ quicklist шКВчВ╣чЪДцЦ╣ц│ХуАВ</p> <p>ф╕Нш┐Зя╝МхПИхЫаф╕║ quicklist ф╜┐чФи quicklistNode ч╗УцЮДцМЗхРСцпПф╕к ziplistя╝МцЧачЦСхвЮхКаф║ЖхЖЕхнШх╝АщФАуАВф╕║ф║Ж<strong>хЗПх░СхЖЕхнШх╝АщФАя╝Мх╣╢ш┐Ыф╕АцнещБ┐хЕН ziplist ш┐ЮщФБцЫ┤цЦ░щЧощвШ</strong>я╝МRedis хЬи 5.0 чЙИцЬмф╕ня╝Мх░▒шо╛шобхоЮчО░ф║Ж listpack ч╗УцЮДуАВlistpack ч╗УцЮДц▓┐чФиф║Ж ziplist ч┤зхЗСхЮЛчЪДхЖЕхнШх╕Гх▒Ая╝МцККцпПф╕кхЕГч┤ащГ╜ч┤зцМичЭАцФ╛ч╜о</p> <p>listpack ф╕нцпПф╕кхИЧшбищб╣ф╕НхЖНхМЕхРлхЙНф╕Ащб╣чЪДщХ┐х║жф║Жя╝МхЫацндх╜УцЯРф╕кхИЧшбищб╣ф╕нчЪДцХ░цНохПСчФЯхПШхМЦя╝Мхп╝шЗ┤хИЧшбищб╣щХ┐х║жхПШхМЦцЧ╢я╝МхЕ╢ф╗ЦхИЧшбищб╣чЪДщХ┐х║жцШпф╕Нф╝ЪхПЧх╜▒хУНчЪДя╝МхЫашАМш┐Щх░▒щБ┐хЕНф║Ж ziplist щЭвф╕┤чЪДш┐ЮщФБцЫ┤цЦ░щЧощвШуАВ</p> <p>цА╗шАМшиАф╣Ля╝МRedis хЬихЖЕхнШч┤зхЗСхЮЛхИЧшбичЪДшо╛шобф╕ОхоЮчО░ф╕Кя╝Мф╗О ziplist хИ░ quicklistя╝МхЖНхИ░ listpackя╝Мф╜ахПпф╗ечЬЛхИ░ Redis хЬихЖЕхнШчй║щЧ┤х╝АщФАхТМшо┐щЧоцАзшГ╜ф╣ЛщЧ┤чЪДшо╛шобхПЦшИНя╝Мш┐Щф╕Ач│╗хИЧчЪДшо╛шобхПШхМЦя╝МцШпщЭЮх╕╕хА╝х╛Чф╜ахнжф╣ачЪД</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/echo-lxy/echo-system-design/edit/master/docs/Redis ч│╗ч╗Яшо╛шоб/02.хЯ║чбА/02.List шо╛шобф╕ОхоЮчО░.md" target="_blank" rel="noopener noreferrer">ч╝Цш╛С</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">ф╕КцмбцЫ┤цЦ░ф║О:</span> <span class="time">2024/09/17, 05:13:55</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        тЖР
        <a href="/pages/bdae41/" class="prev">String шо╛шобф╕ОхоЮчО░</a></span> <span class="next"><a href="/pages/2d4311/">Hash шо╛шобф╕ОхоЮчО░</a>тЖТ
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:lixinyang2002@163.com" title="хПСщВоф╗╢" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/echo-lxy" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="хРмщЯ│ф╣Р" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="цЬмчлЩф╕╗щвШ">Vdoing</a> 
    | Copyright ┬й 2024-2024
    <span>Xinyang Li | MIT License</span></div> <div class="buttons"><div title="ш┐ФхЫЮщб╢щГи" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="хО╗шпДшо║" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ф╕╗щвШцибх╝П" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          ш╖ЯщЪПч│╗ч╗Я
        </li><li class="iconfont icon-rijianmoshi">
          ц╡ЕшЙ▓цибх╝П
        </li><li class="iconfont icon-yejianmoshi">
          ц╖▒шЙ▓цибх╝П
        </li><li class="iconfont icon-yuedu">
          щШЕшп╗цибх╝П
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.3449399e.js" defer></script><script src="/assets/js/2.933750c6.js" defer></script><script src="/assets/js/41.5525b2c4.js" defer></script><script src="/assets/js/7.7eb70372.js" defer></script>
  </body>
</html>
