<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>чФЯф║зшАЕ | EchoDesign</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/echo-system-design/img/favicon.ico">
    <meta name="description" content="ч│╗ч╗Яшо╛шобф╣ЛуАМшо▓шзг + щЭвшпХцМЗхНЧуАНя╝Мц░┤ц╗┤чЯ│чй┐я╝Мшо╛шобцЧащУ╢х╝╣я╝Б">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/echo-system-design/assets/css/0.styles.744b3760.css" as="style"><link rel="preload" href="/echo-system-design/assets/js/app.29ec2c17.js" as="script"><link rel="preload" href="/echo-system-design/assets/js/2.933750c6.js" as="script"><link rel="preload" href="/echo-system-design/assets/js/18.4e49fa9b.js" as="script"><link rel="preload" href="/echo-system-design/assets/js/7.7eb70372.js" as="script"><link rel="prefetch" href="/echo-system-design/assets/js/10.2cc95be8.js"><link rel="prefetch" href="/echo-system-design/assets/js/100.2b21dce5.js"><link rel="prefetch" href="/echo-system-design/assets/js/101.09d5e594.js"><link rel="prefetch" href="/echo-system-design/assets/js/11.ddc7ccf4.js"><link rel="prefetch" href="/echo-system-design/assets/js/12.915fdd22.js"><link rel="prefetch" href="/echo-system-design/assets/js/13.d9d26d25.js"><link rel="prefetch" href="/echo-system-design/assets/js/14.ae63dfd6.js"><link rel="prefetch" href="/echo-system-design/assets/js/15.d5a34c66.js"><link rel="prefetch" href="/echo-system-design/assets/js/16.5a9b32ee.js"><link rel="prefetch" href="/echo-system-design/assets/js/17.bad7d194.js"><link rel="prefetch" href="/echo-system-design/assets/js/19.daf31819.js"><link rel="prefetch" href="/echo-system-design/assets/js/20.cb4a5c13.js"><link rel="prefetch" href="/echo-system-design/assets/js/21.24c0f101.js"><link rel="prefetch" href="/echo-system-design/assets/js/22.dd779f94.js"><link rel="prefetch" href="/echo-system-design/assets/js/23.4d814163.js"><link rel="prefetch" href="/echo-system-design/assets/js/24.891fe6fb.js"><link rel="prefetch" href="/echo-system-design/assets/js/25.41dca26b.js"><link rel="prefetch" href="/echo-system-design/assets/js/26.6337eac0.js"><link rel="prefetch" href="/echo-system-design/assets/js/27.97a0cc13.js"><link rel="prefetch" href="/echo-system-design/assets/js/28.95a1fb6b.js"><link rel="prefetch" href="/echo-system-design/assets/js/29.2b39f61a.js"><link rel="prefetch" href="/echo-system-design/assets/js/3.5c09ac9d.js"><link rel="prefetch" href="/echo-system-design/assets/js/30.e32f6b31.js"><link rel="prefetch" href="/echo-system-design/assets/js/31.a532917f.js"><link rel="prefetch" href="/echo-system-design/assets/js/32.13b70e91.js"><link rel="prefetch" href="/echo-system-design/assets/js/33.d10d51bb.js"><link rel="prefetch" href="/echo-system-design/assets/js/34.6671ead6.js"><link rel="prefetch" href="/echo-system-design/assets/js/35.2760ed8d.js"><link rel="prefetch" href="/echo-system-design/assets/js/36.be98cc35.js"><link rel="prefetch" href="/echo-system-design/assets/js/37.82be3556.js"><link rel="prefetch" href="/echo-system-design/assets/js/38.40fe2658.js"><link rel="prefetch" href="/echo-system-design/assets/js/39.84b6e82e.js"><link rel="prefetch" href="/echo-system-design/assets/js/4.73518a0f.js"><link rel="prefetch" href="/echo-system-design/assets/js/40.591baf2a.js"><link rel="prefetch" href="/echo-system-design/assets/js/41.f961e422.js"><link rel="prefetch" href="/echo-system-design/assets/js/42.8046590d.js"><link rel="prefetch" href="/echo-system-design/assets/js/43.d1865983.js"><link rel="prefetch" href="/echo-system-design/assets/js/44.abab45ac.js"><link rel="prefetch" href="/echo-system-design/assets/js/45.685623ac.js"><link rel="prefetch" href="/echo-system-design/assets/js/46.7624d38c.js"><link rel="prefetch" href="/echo-system-design/assets/js/47.5646b068.js"><link rel="prefetch" href="/echo-system-design/assets/js/48.a1b270df.js"><link rel="prefetch" href="/echo-system-design/assets/js/49.ee9681bc.js"><link rel="prefetch" href="/echo-system-design/assets/js/5.94727770.js"><link rel="prefetch" href="/echo-system-design/assets/js/50.b424b2c0.js"><link rel="prefetch" href="/echo-system-design/assets/js/51.98ad3d82.js"><link rel="prefetch" href="/echo-system-design/assets/js/52.2bb763f1.js"><link rel="prefetch" href="/echo-system-design/assets/js/53.f76e624c.js"><link rel="prefetch" href="/echo-system-design/assets/js/54.3098ec9f.js"><link rel="prefetch" href="/echo-system-design/assets/js/55.01c7393b.js"><link rel="prefetch" href="/echo-system-design/assets/js/56.13fd4db7.js"><link rel="prefetch" href="/echo-system-design/assets/js/57.6175a0b4.js"><link rel="prefetch" href="/echo-system-design/assets/js/58.24008d78.js"><link rel="prefetch" href="/echo-system-design/assets/js/59.7b7e3faf.js"><link rel="prefetch" href="/echo-system-design/assets/js/6.0b558b79.js"><link rel="prefetch" href="/echo-system-design/assets/js/60.cf282dab.js"><link rel="prefetch" href="/echo-system-design/assets/js/61.11238a6f.js"><link rel="prefetch" href="/echo-system-design/assets/js/62.cc8fdced.js"><link rel="prefetch" href="/echo-system-design/assets/js/63.55fc09a9.js"><link rel="prefetch" href="/echo-system-design/assets/js/64.9b3def35.js"><link rel="prefetch" href="/echo-system-design/assets/js/65.0b2ab47d.js"><link rel="prefetch" href="/echo-system-design/assets/js/66.2ae7a107.js"><link rel="prefetch" href="/echo-system-design/assets/js/67.8e1dbb45.js"><link rel="prefetch" href="/echo-system-design/assets/js/68.cab1ea3b.js"><link rel="prefetch" href="/echo-system-design/assets/js/69.5f61d937.js"><link rel="prefetch" href="/echo-system-design/assets/js/70.b920a5f7.js"><link rel="prefetch" href="/echo-system-design/assets/js/71.c3c29d34.js"><link rel="prefetch" href="/echo-system-design/assets/js/72.44c999da.js"><link rel="prefetch" href="/echo-system-design/assets/js/73.526febf1.js"><link rel="prefetch" href="/echo-system-design/assets/js/74.26f8d9a5.js"><link rel="prefetch" href="/echo-system-design/assets/js/75.dc7fdd0f.js"><link rel="prefetch" href="/echo-system-design/assets/js/76.32858593.js"><link rel="prefetch" href="/echo-system-design/assets/js/77.7b3f6980.js"><link rel="prefetch" href="/echo-system-design/assets/js/78.09407d20.js"><link rel="prefetch" href="/echo-system-design/assets/js/79.a0d29bfa.js"><link rel="prefetch" href="/echo-system-design/assets/js/8.0ec7f6e8.js"><link rel="prefetch" href="/echo-system-design/assets/js/80.ddcb5191.js"><link rel="prefetch" href="/echo-system-design/assets/js/81.d124398a.js"><link rel="prefetch" href="/echo-system-design/assets/js/82.3b90a7cc.js"><link rel="prefetch" href="/echo-system-design/assets/js/83.f3a9ee0c.js"><link rel="prefetch" href="/echo-system-design/assets/js/84.eeb423e8.js"><link rel="prefetch" href="/echo-system-design/assets/js/85.4cd3a775.js"><link rel="prefetch" href="/echo-system-design/assets/js/86.931cbb70.js"><link rel="prefetch" href="/echo-system-design/assets/js/87.47ba635a.js"><link rel="prefetch" href="/echo-system-design/assets/js/88.93192130.js"><link rel="prefetch" href="/echo-system-design/assets/js/89.b5690031.js"><link rel="prefetch" href="/echo-system-design/assets/js/9.6e274fca.js"><link rel="prefetch" href="/echo-system-design/assets/js/90.cdc8eb8f.js"><link rel="prefetch" href="/echo-system-design/assets/js/91.8ad18b18.js"><link rel="prefetch" href="/echo-system-design/assets/js/92.ec3a28ed.js"><link rel="prefetch" href="/echo-system-design/assets/js/93.f8975bc4.js"><link rel="prefetch" href="/echo-system-design/assets/js/94.1eade7f0.js"><link rel="prefetch" href="/echo-system-design/assets/js/95.40b14cb6.js"><link rel="prefetch" href="/echo-system-design/assets/js/96.15d8e4f1.js"><link rel="prefetch" href="/echo-system-design/assets/js/97.280e8dd8.js"><link rel="prefetch" href="/echo-system-design/assets/js/98.b46fd254.js"><link rel="prefetch" href="/echo-system-design/assets/js/99.d1ca4fc0.js">
    <link rel="stylesheet" href="/echo-system-design/assets/css/0.styles.744b3760.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="чЫох╜Х" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/echo-system-design/" class="home-link router-link-active"><img src="/echo-system-design/img/logo.png" alt="EchoDesign" class="logo"> <span class="site-name can-hide">EchoDesign</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/echo-system-design/" class="nav-link">ЁЯПащжЦщб╡</a></div><div class="nav-item"><a href="/echo-system-design/pages/fccd91/" class="nav-link">тЬТя╕ПчГнщЧичоЧц│Х</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕шо╛шоб" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕шо╛шоб</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/echo-system-design/pages/252196/" class="nav-link">Redis ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/echo-system-design/pages/b9733b/" class="nav-link">Kafka ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/echo-system-design/pages/bfab10/" class="nav-link">Netty ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/echo-system-design/pages/4601ca/" class="nav-link">Nginx ч│╗ч╗Яшо╛шоб</a></li></ul></div></div><div class="nav-item"><a href="/echo-system-design/pages/84cb49/" class="nav-link">ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб</a></div><div class="nav-item"><a href="/echo-system-design/pages/92b2ee/" class="nav-link">тЭУщЧочнФ</a></div><div class="nav-item"><a href="/echo-system-design/pages/52ebd8/" class="nav-link">ЁЯСАхКицАБ</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/echo-system-design/" class="nav-link">ЁЯПащжЦщб╡</a></div><div class="nav-item"><a href="/echo-system-design/pages/fccd91/" class="nav-link">тЬТя╕ПчГнщЧичоЧц│Х</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕шо╛шоб" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕шо╛шоб</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/echo-system-design/pages/252196/" class="nav-link">Redis ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/echo-system-design/pages/b9733b/" class="nav-link">Kafka ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/echo-system-design/pages/bfab10/" class="nav-link">Netty ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/echo-system-design/pages/4601ca/" class="nav-link">Nginx ч│╗ч╗Яшо╛шоб</a></li></ul></div></div><div class="nav-item"><a href="/echo-system-design/pages/84cb49/" class="nav-link">ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб</a></div><div class="nav-item"><a href="/echo-system-design/pages/92b2ee/" class="nav-link">тЭУщЧочнФ</a></div><div class="nav-item"><a href="/echo-system-design/pages/52ebd8/" class="nav-link">ЁЯСАхКицАБ</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ф╕АуАБхЙНшиА</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>ф╕ЙуАБф╕╗ч║┐ф╗╗хКб</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/echo-system-design/pages/46a58a/" class="sidebar-link">Kafka цХ┤ф╜УцЮ╢цЮД</a></li><li><a href="/echo-system-design/pages/bb1005/" aria-current="page" class="active sidebar-link">чФЯф║зшАЕ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/echo-system-design/pages/bb1005/#хЙНшиА" class="sidebar-link">хЙНшиА</a></li><li class="sidebar-sub-header level2"><a href="/echo-system-design/pages/bb1005/#цХ┤ф╜Уц╡БчиЛ" class="sidebar-link">цХ┤ф╜Уц╡БчиЛ</a></li><li class="sidebar-sub-header level2"><a href="/echo-system-design/pages/bb1005/#ф╕╗ч║┐чиЛ" class="sidebar-link">ф╕╗ч║┐чиЛ</a></li><li class="sidebar-sub-header level2"><a href="/echo-system-design/pages/bb1005/#sender-ч║┐чиЛ" class="sidebar-link">Sender ч║┐чиЛ</a></li><li class="sidebar-sub-header level2"><a href="/echo-system-design/pages/bb1005/#цА╗ч╗У" class="sidebar-link">цА╗ч╗У</a></li><li class="sidebar-sub-header level2"><a href="/echo-system-design/pages/bb1005/#хПВшАГш╡ДцЦЩ" class="sidebar-link">хПВшАГш╡ДцЦЩ</a></li></ul></li><li><a href="/echo-system-design/pages/aa0392/" class="sidebar-link">Broker</a></li><li><a href="/echo-system-design/pages/ca141b/" class="sidebar-link">ц╢Иш┤╣шАЕ</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>уАМчФЯф║зшАЕуАНц║РчаБхИЖцЮР</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>уАМц╢Иш┤╣шАЕуАНц║РчаБхИЖцЮР</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>уАМBrokerуАНхОЯчРЖхИЖцЮР</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>хЫЫуАБшо╛шобчЫоцаЗ</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/echo-system-design/" title="щжЦщб╡" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>Kafka  ч│╗ч╗Яшо╛шоб</span></li><li data-v-06225672><span data-v-06225672>ф╕ЙуАБф╕╗ч║┐ф╗╗хКб</span></li></ul> <div class="info" data-v-06225672><div title="ф╜ЬшАЕ" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/brother-one" target="_blank" title="ф╜ЬшАЕ" class="beLink" data-v-06225672>echo</a></div> <div title="хИЫх╗║цЧ╢щЧ┤" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-09-18</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">чЫох╜Х</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">чФЯф║зшАЕ<!----></h1> <div class="page-slot page-slot-top">
    <div class="wwads-cn wwads-horizontal page-wwads" data-id="136"></div>
    <style>
      .page-wwads{
        width:100%!important;
        min-height: 0;
        margin: 0;
      }
      .page-wwads .wwads-img img{
        width:80px!important;
      }
      .page-wwads .wwads-poweredby{
        width: 40px;
        position: absolute;
        right: 25px;
        bottom: 3px;
      }
      .wwads-content .wwads-text, .page-wwads .wwads-text{
        height: 100%;
        padding-top: 5px;
        display: block;
      }
  </style>
  </div> <div class="theme-vdoing-content content__default"><h2 id="хЙНшиА"><a href="#хЙНшиА" class="header-anchor">#</a> хЙНшиА</h2> <h2 id="цХ┤ф╜Уц╡БчиЛ"><a href="#цХ┤ф╜Уц╡БчиЛ" class="header-anchor">#</a> цХ┤ф╜Уц╡БчиЛ</h2> <ol><li>msg х░БшгЕцИР ProducerRecord</li> <li>цЛжцИкхЩи</li> <li>Record х║ПхИЧхМЦ</li> <li>чммф╕АцмбхПСщАБцЧ╢хЕИшО╖хПЦ kafka щЫЖч╛дхЕГцХ░цНо</li> <li>Record ца╣цНохЕГцХ░цНох╛ЧхИ░шжБхПСщАБхИ░ topic чЪДхИЖхМ║</li> <li>Record ц╖╗хКахИ░ <code>RecordAccumulator</code> ч╝УхЖ▓хМ║(цпПф╕кхИЖхМ║щГ╜цЬЙчЛмчлЛчЪДч╝УхЖ▓щШЯхИЧ)</li> <li>Sender ч║┐чиЛф╗О <code>RecordAccumulator</code> шО╖хПЦ batch record хПСщАБхИ░ Broker</li></ol> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409181252125.png" alt="image-20240918124411636"></p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// org.apache.kafka.clients.producer.KafkaProducer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Producer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token comment">// хИЖхМ║хЩия╝МхПпф╗ешЗкхоЪф╣Й</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Partitioner</span> partitioner<span class="token punctuation">;</span>
  <span class="token comment">// kafka щЫЖч╛дхЕГцХ░цНо</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Metadata</span> metadata<span class="token punctuation">;</span>
  <span class="token comment">// ч╝УхЖ▓хМ║</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RecordAccumulator</span> accumulator<span class="token punctuation">;</span>
  <span class="token comment">// хПСщАБч║┐чиЛ</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Sender</span> sender<span class="token punctuation">;</span>
  <span class="token comment">// цнещкдф╕Ая╝Ъх░БшгЕцИР ProducerRecord</span>
  <span class="token keyword">public</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RecordMetadata</span><span class="token punctuation">&gt;</span></span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">,</span> <span class="token class-name">Callback</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// intercept the record, which can be potentially modified; this method does not throw exceptions</span>
      <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> interceptedRecord <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> record <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span><span class="token function">onSend</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">doSend</span><span class="token punctuation">(</span>interceptedRecord<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RecordMetadata</span><span class="token punctuation">&gt;</span></span> <span class="token function">doSend</span><span class="token punctuation">(</span><span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">,</span> <span class="token class-name">Callback</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">TopicPartition</span> tp <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token comment">// чммф╕АцмбхПСщАБцХ░цНоцЧ╢я╝МхЕИчбоф┐Эх╖▓ч╗ПцЬЙ kafka metadata</span>
          <span class="token class-name">ClusterAndWaitTime</span> clusterAndWaitTime <span class="token operator">=</span> <span class="token function">waitOnMetadata</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> maxBlockTimeMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// maxBlockTimeMs щ╗Шшод 60s</span>
          <span class="token keyword">long</span> remainingWaitMs <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> maxBlockTimeMs <span class="token operator">-</span> clusterAndWaitTime<span class="token punctuation">.</span>waitedOnMetadataMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token class-name">Cluster</span> cluster <span class="token operator">=</span> clusterAndWaitTime<span class="token punctuation">.</span>cluster<span class="token punctuation">;</span>
          <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> serializedKey<span class="token punctuation">;</span>
          <span class="token comment">// цнещкдф║Мя╝Ъх║ПхИЧхМЦ</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
              serializedKey <span class="token operator">=</span> keySerializer<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> 
          <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> serializedValue<span class="token punctuation">;</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
              serializedValue <span class="token operator">=</span> valueSerializer<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> 

          <span class="token comment">// цнещкдф╕Йя╝ЪшО╖хПЦхИЖхМ║</span>
          <span class="token keyword">int</span> partition <span class="token operator">=</span> <span class="token function">partition</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> serializedKey<span class="token punctuation">,</span> serializedValue<span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">int</span> serializedSize <span class="token operator">=</span> <span class="token class-name">Records</span><span class="token punctuation">.</span><span class="token constant">LOG_OVERHEAD</span> <span class="token operator">+</span> <span class="token class-name">Record</span><span class="token punctuation">.</span><span class="token function">recordSize</span><span class="token punctuation">(</span>serializedKey<span class="token punctuation">,</span> serializedValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">ensureValidRecordSize</span><span class="token punctuation">(</span>serializedSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
          tp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TopicPartition</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partition<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
          <span class="token comment">// цнещкдхЫЫя╝Ъrecord ц╖╗хКахИ░ accumulator ч╝УхнШ</span>
          <span class="token class-name">RecordAccumulator<span class="token punctuation">.</span>RecordAppendResult</span> result <span class="token operator">=</span> accumulator<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>tp<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> serializedKey<span class="token punctuation">,</span> serializedValue<span class="token punctuation">,</span> interceptCallback<span class="token punctuation">,</span> remainingWaitMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>batchIsFull <span class="token operator">||</span> result<span class="token punctuation">.</span>newBatchCreated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Waking up the sender since topic {} partition {} is either full or getting a new batch&quot;</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partition<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// ц╗бш╢│ batch хПСщАБцЭбф╗╢я╝МхФдщЖТ sender хПСщАБцХ░цНо</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">return</span> result<span class="token punctuation">.</span>future<span class="token punctuation">;</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="ф╕╗ч║┐чиЛ"><a href="#ф╕╗ч║┐чиЛ" class="header-anchor">#</a> ф╕╗ч║┐чиЛ</h2> <h3 id="хИЭхзЛхМЦф╕ОхПВцХ░щЕНч╜о"><a href="#хИЭхзЛхМЦф╕ОхПВцХ░щЕНч╜о" class="header-anchor">#</a> хИЭхзЛхМЦф╕ОхПВцХ░щЕНч╜о</h3> <p>хЬи Kafka чФЯф║зшАЕчЪДхИЭхзЛхМЦщШ╢цо╡я╝Мф╕╗ч║┐чиЛф╕╗шжБш┤Яш┤гхп╣чФЯф║зшАЕчЪДхРДф╕кч╗Дф╗╢ш┐ЫшбМщЕНч╜оф╕ОхИЭхзЛхМЦуАВф╕╗шжБц╢ЙхПКчЪДхПВцХ░хМЕцЛмя╝Ъ</p> <ul><li><code>bootstrap.servers</code>я╝ЪKafka щЫЖч╛дчЪДхЬ░хЭАуАВ</li> <li><code>key.serializer</code> хТМ <code>value.serializer</code>я╝Ъц╢ИцБпчЪДщФохТМхА╝чЪДх║ПхИЧхМЦцЦ╣х╝ПуАВ</li> <li><code>acks</code>я╝ЪцОзхИ╢ц╢ИцБпчбошодчЪДцЦ╣х╝Пя╝МхЖ│хоЪц╢ИцБпчЪДхПпщЭацАзхТМх╗╢ш┐Яф╣ЛщЧ┤чЪДх╣│шббуАВ</li> <li><code>retries</code>я╝ЪщЗНшпХцмбцХ░я╝МхЬиц╢ИцБпхПСщАБхд▒ш┤ецЧ╢чФиф║ОцОзхИ╢щЗНшпХцЬ║хИ╢уАВ</li> <li><code>batch.size</code>я╝Ъц╢ИцБпцЙ╣цмбхдзх░Пя╝Мх╜▒хУНц╢ИцБпчЪДч┤пчзпхТМхПСщАБщвСчОЗуАВ</li></ul> <p>ш┐Щф║ЫхПВцХ░чЫ┤цОех╜▒хУН Kafka чФЯф║зшАЕчЪДхРЮхРРщЗПуАБхПпщЭацАзхТМх╗╢ш┐Яя╝МцШпцАзшГ╜ф╝ШхМЦчЪДщЗНчВ╣уАВ</p> <h3 id="kafkaproducer"><a href="#kafkaproducer" class="header-anchor">#</a> KafkaProducer</h3> <p><code>KafkaProducer</code> ч▒╗цШп Kafka чФЯф║зшАЕчЪДца╕х┐Гч▒╗я╝МхоГхоЮчО░ф║Ж Java чЪД <code>AutoCloseable</code> цОехПгя╝Мш┤Яш┤гчобчРЖц╢ИцБпхПСщАБчЪДчФЯхС╜хСицЬЯуАВхЕ╢ф╕╗шжБшБМш┤гхМЕцЛмя╝Ъ</p> <ul><li><strong>хИЭхзЛхМЦ</strong>я╝ЪхИЭхзЛхМЦчФЯф║зшАЕчЫ╕хЕ│чЪДцЛжцИкхЩиуАБх║ПхИЧхМЦхЩиуАБч┤пхКахЩиуАБSender ч║┐чиЛчнЙч╗Дф╗╢уАВ</li> <li><strong>ц╢ИцБпхПСщАБ</strong>я╝ЪцПРф╛Ы <code>send()</code> цЦ╣ц│Хя╝МчФиф║ОхПСщАБц╢ИцБпуАВхоГх░Жц╢ИцБпх░БшгЕф╕║ <code>ProducerRecord</code> хп╣ш▒бя╝Мф║дчФ▒хРОч╗нцибхЭЧш┐ЫшбМхдДчРЖуАВ</li></ul> <p><code>KafkaProducer</code> чЪДч║┐чиЛхоЙхЕицАзхТМщлШцХИчЪДш╡Дц║РчобчРЖф╜┐хЕ╢хЬищлШх╣╢хПСхЬ║цЩпф╕ЛшГ╜хдЯф┐ЭцМБшЙпхе╜чЪДцАзшГ╜уАВ</p> <h3 id="producerinterceptor"><a href="#producerinterceptor" class="header-anchor">#</a> ProducerInterceptor</h3> <p><code>ProducerInterceptor</code> ф╕╗шжБчФиф║ОхЬиц╢ИцБпхПСщАБхЙНхРОш┐ЫшбМцЛжцИкхТМхдДчРЖя╝Мх╕╕чФиф║ОхоЮчО░цЧех┐Чшо░х╜ХуАБч╗ЯшобхТМшЗкхоЪф╣ЙщА╗ш╛СуАВKafka чФЯф║зшАЕхЕБшо╕щЕНч╜охдЪф╕кцЛжцИкхЩия╝МхоГф╗мцМЙщб║х║ПцЙзшбМуАВ</p> <p>цЛжцИкхЩичЪДхЕ╕хЮЛх║ФчФихЬ║цЩпхМЕцЛмя╝Ъ</p> <ul><li>ф┐оцФ╣ц╢ИцБпхЖЕхо╣я╝Ъф╛ЛхжВч╗Щц╢ИцБпц╖╗хКахЕГцХ░цНоуАВ</li> <li>чЫСцОзф╕Оч╗Яшобя╝ЪхПпф╗еч╗ЯшобцпПцЭбц╢ИцБпчЪДхПСщАБцЧ╢щЧ┤цИЦхПСщАБчК╢цАБуАВ</li></ul> <div class="language-c extra-class"><pre class="language-c"><code>public class CustomProducerInterceptor implements ProducerInterceptor<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    @Override
    public ProducerRecord<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span> <span class="token function">onSend</span><span class="token punctuation">(</span>ProducerRecord<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// хПпф╗ехЬицндхдДф┐оцФ╣ц╢ИцБпцИЦц╖╗хКашЗкхоЪф╣ЙщА╗ш╛С</span>
        <span class="token keyword">return</span> record<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Override
    public <span class="token keyword">void</span> <span class="token function">onAcknowledgement</span><span class="token punctuation">(</span>RecordMetadata metadata<span class="token punctuation">,</span> Exception exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// хПпф╗ехЬицндхдДхдДчРЖц╢ИцБпхПСщАБцИРхКЯцИЦхд▒ш┤ечЪДщА╗ш╛С</span>
    <span class="token punctuation">}</span>

    @Override
    public <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    @Override
    public <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span>Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">&gt;</span> configs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="serializer"><a href="#serializer" class="header-anchor">#</a> Serializer</h3> <p>Kafka чФЯф║зшАЕф╕нчЪДх║ПхИЧхМЦхЩиш┤Яш┤гх░Ж Java хп╣ш▒бш╜мхМЦф╕║хнЧшКВцХ░ч╗Дя╝Мф╗еф╛┐щАЪш┐Зч╜Сч╗ЬхПСщАБуАВKafka хЖЕч╜оф║ЖхЗачзНх╕╕шзБчЪДх║ПхИЧхМЦхЩия╝Мф╛ЛхжВ <code>StringSerializer</code> хТМ <code>ByteArraySerializer</code>я╝Мф╣ЯцФпцМБчФицИ╖шЗкхоЪф╣Йх║ПхИЧхМЦхЩиуАВ</p> <p>хп╣ф║ОшЗкхоЪф╣Йхп╣ш▒бя╝МщЬАшжБхоЮчО░ <code>Serializer</code> цОехПгя╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code>public class CustomSerializer implements Serializer<span class="token operator">&lt;</span>MyObject<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    @Override
    public byte<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">serialize</span><span class="token punctuation">(</span>String topic<span class="token punctuation">,</span> MyObject data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// х░ЖшЗкхоЪф╣Йхп╣ш▒бш╜мцНвф╕║хнЧшКВцХ░ч╗Д</span>
        <span class="token keyword">return</span> SerializationUtils<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Override
    public <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>шЙпхе╜чЪДх║ПхИЧхМЦхЩишо╛шобф╕Нф╗ЕшГ╜ф┐ЭшпБцХ░цНочЪДф╕АшЗ┤цАзя╝Мш┐ШшГ╜ф╝ШхМЦф╝аш╛УцАзшГ╜уАВ</p> <h3 id="хЕГцХ░цНо"><a href="#хЕГцХ░цНо" class="header-anchor">#</a> хЕГцХ░цНо</h3> <p>Client щЬАшжБф╗О Broker шКВчВ╣шО╖хПЦ Topic чЪДхЕГцХ░цНоя╝МцЙНчЯещБУх░Жх╜УхЙН Record хПСщАБхУкф╕кхИЖхМ║</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// org.apache.kafka.clients.producer.KafkaProducer</span>
<span class="token keyword">private</span> <span class="token class-name">ClusterAndWaitTime</span> <span class="token function">waitOnMetadata</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Integer</span> partition<span class="token punctuation">,</span> <span class="token keyword">long</span> maxWaitMs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token comment">// ц╖╗хКашжБшО╖хПЦхЕГцХ░цНочЪД topicя╝МMap ч╗УцЮД</span>
    metadata<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Cluster</span> cluster <span class="token operator">=</span> metadata<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Integer</span> partitionsCount <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">partitionCountForTopic</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// хжВцЮЬх╖▓ч╗ПцЬЙхЕГцХ░цНоя╝МчЫ┤цОеш┐ФхЫЮ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>partitionsCount <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>partition <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> partition <span class="token operator">&lt;</span> partitionsCount<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ClusterAndWaitTime</span><span class="token punctuation">(</span>cluster<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// цн╗х╛кчОпф╕АчЫ┤хИ░шО╖хПЦхЕГцХ░цНо/ш╢ЕцЧ╢</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> version <span class="token operator">=</span> metadata<span class="token punctuation">.</span><span class="token function">requestUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// хФдщЖТ sender ч║┐чиЛхО╗шО╖хПЦ</span>
        sender<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// wait чЫ┤хИ░ sender шО╖хПЦхИ░хЕГцХ░цНохРОхФдщЖТ</span>
            <span class="token comment">// цИЦшАЕш╢ЕцЧ╢</span>
            metadata<span class="token punctuation">.</span><span class="token function">awaitUpdate</span><span class="token punctuation">(</span>version<span class="token punctuation">,</span> remainingWaitMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>partitionsCount <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ClusterAndWaitTime</span><span class="token punctuation">(</span>cluster<span class="token punctuation">,</span> elapsed<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* * Sender.run(this.client.poll(pollTimeout, now);) * NetworkClient.poll -&gt; NetworkClient.handleCompletedReceives * metadataUpdater.maybeUpdate -&gt; NetworkClient.maybeHandleCompletedReceive * metadataRequest = new MetadataRequest(new ArrayList&lt;&gt;(metadata.topics())); // хПкшО╖хПЦ metadata ф╕н topic * NetworkClient.handleResponse -&gt; MetaData.update */</span>
<span class="token comment">// org.apache.kafka.clients.Metadata</span>
<span class="token comment">// kafka хЕГцХ░цНоч╗УцЮД</span>
<span class="token keyword">private</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Cluster</span> cluster<span class="token punctuation">,</span> <span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>topicExpiryEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Handle expiry of topics from the metadata refresh set.</span>
    <span class="token comment">// чз╗щЩд TOPIC_EXPIRY_MS(5хИЖщТЯ) цЧ╢щЧ┤цо╡хЖЕц▓бцЬЙхПСщАБцХ░цНочЪД topic</span>
    <span class="token comment">// ф╕ЛцмбшО╖хПЦхЕГцХ░цНоцЧ╢х░▒ф╕НшО╖хПЦцнд topic хЕГцХ░цНо</span>
    <span class="token comment">// шО╖хПЦхЕГцХ░цНочЪДцЭбф╗╢я╝Ъcluster хЕГцХ░цНоф╕нц▓бцЬЙщЬАшжБ topic чЪДф┐бцБп</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> it <span class="token operator">=</span> topics<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">long</span> expireMs <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>expireMs <span class="token operator">==</span> <span class="token constant">TOPIC_EXPIRY_NEEDS_UPDATE</span><span class="token punctuation">)</span>
          entry<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>now <span class="token operator">+</span> <span class="token constant">TOPIC_EXPIRY_MS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>expireMs <span class="token operator">&lt;=</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// х╜УхЙН topic ш┐ЗцЬЯя╝Мчз╗щЩд</span>
          it<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Removing unused topic {} from the metadata list, expiryMs {} now {}&quot;</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> expireMs<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// цЫ┤цЦ░хЕГцХ░цНо</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>cluster <span class="token operator">=</span> cluster<span class="token punctuation">;</span>
  <span class="token comment">// хФдщЖТ metadata</span>
  <span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409181346231.jpeg" alt="img"></p> <h3 id="partitioner"><a href="#partitioner" class="header-anchor">#</a> Partitioner</h3> <p><code>Partitioner</code> хЖ│хоЪц╢ИцБпшвлхПСщАБхИ░ Kafka щЫЖч╛дф╕нхУкф╕кхИЖхМ║уАВKafka щ╗ШшодчЪДхИЖхМ║чнЦчХецШпхЯ║ф║Оц╢ИцБпчЪДщФоя╝И<code>key</code>я╝Йш┐ЫшбМхУИх╕МхИЖхМ║я╝Мф╜Жф╣ЯхПпф╗ещАЪш┐ЗхоЮчО░шЗкхоЪф╣Й <code>Partitioner</code> цЭехоЮчО░хдНцЭВчЪДхИЖхМ║щА╗ш╛СуАВ</p> <p>хЕ╕хЮЛчЪДхЬ║цЩпхМЕцЛмя╝Ъ</p> <ul><li>ф┐ЭшпБчЫ╕хРМ key чЪДц╢ИцБпшвлш╖пчФ▒хИ░хРМф╕АхИЖхМ║я╝Мчбоф┐Эц╢ИцБпчЪДщб║х║ПцАзуАВ</li> <li>ца╣цНоф╕ЪхКбщЬАц▒Вя╝МхоЮчО░чЙ╣хоЪхИЖхМ║чнЦчХея╝Мф╛ЛхжВх░Ж VIP чФицИ╖чЪДц╢ИцБпхПСщАБхИ░чЙ╣хоЪхИЖхМ║ф╗еф╛┐ф╝ШхЕИхдДчРЖуАВ</li></ul> <p>шЗкхоЪф╣Й <code>Partitioner</code> чд║ф╛Ля╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code>public class CustomPartitioner implements Partitioner <span class="token punctuation">{</span>
    @Override
    public <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span>String topic<span class="token punctuation">,</span> Object key<span class="token punctuation">,</span> byte<span class="token punctuation">[</span><span class="token punctuation">]</span> keyBytes<span class="token punctuation">,</span> Object value<span class="token punctuation">,</span> byte<span class="token punctuation">[</span><span class="token punctuation">]</span> valueBytes<span class="token punctuation">,</span> Cluster cluster<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// шЗкхоЪф╣ЙхИЖхМ║чнЦчХея╝Ъца╣цНо key чЪДхУИх╕МхА╝хЖ│хоЪхИЖхМ║</span>
        List<span class="token operator">&lt;</span>PartitionInfo<span class="token operator">&gt;</span> partitions <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">partitionsForTopic</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> numPartitions <span class="token operator">=</span> partitions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span> <span class="token operator">%</span> numPartitions<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Override
    public <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    @Override
    public <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span>Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">&gt;</span> configs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="recordaccumulator"><a href="#recordaccumulator" class="header-anchor">#</a> RecordAccumulator</h3> <ul><li>RecordAccumulator ф╕╗шжБчФицЭеч╝УхнШц╢ИцБпф╗еф╛┐ Sender ч║┐чиЛхПпф╗ецЙ╣щЗПхПСщАБя╝Мш┐ЫшАМхЗПх░Сч╜Сч╗Ьф╝аш╛УчЪДш╡Дц║Рц╢ИшАЧф╗ецПРхНЗцАз</li> <li>RecordAccumulatorч╝УхнШчЪДхдзх░ПхПпф╗ещАЪш┐ЗчФЯф║зшАЕховцИ╖члпхПВцХ░<code>buffer.memory</code>щЕНч╜оя╝Мщ╗ШшодхА╝ф╕║ 33554432Bя╝МхН│ 32MB</li> <li>хжВцЮЬчФЯф║зшАЕхПСщАБц╢ИцБпчЪДщАЯх║жш╢Еш┐ЗхПСщАБхИ░цЬНхКбхЩичЪДщАЯх║жя╝МхИЩф╝Ъхп╝шЗ┤чФЯф║зшАЕчй║щЧ┤ф╕Нш╢│я╝Мш┐Щф╕кцЧ╢хАЩ KafkaProducer чЪД <code>send()</code> цЦ╣ц│Хш░ГчФишжБф╣ИшвлщШ╗хбЮя╝МшжБф╣ИцКЫхЗ║х╝Вх╕╕я╝Мш┐Щф╕кхПЦхЖ│ф║ОхПВцХ░<code>max.block.ms</code> чЪДщЕНч╜оя╝МцндхПВцХ░чЪДщ╗ШшодхА╝ф╕║ 60000,хН│ 60 чзТуАВ</li> <li>ф╕╗ч║┐чиЛф╕нхПСщАБш┐ЗцЭечЪДц╢ИцБпщГ╜ф╝Ъшвлш┐╜хКахИ░ RecordAccumulator чЪДцЯРф╕к<strong>хПМчлпщШЯхИЧ</strong>ф╕ня╝МхЬи Recordccumulator чЪДхЖЕщГиф╕║цпПф╕кхИЖхМ║щГ╜ч╗┤цКдф║Жф╕Аф╕кхПМчлпщШЯхИЧя╝МщШЯхИЧф╕нчЪДхЖЕхо╣х░▒цШп Producer Batch я╝МхН│ <code>Deque&lt;ProducerBatch&gt;</code>уАВц╢ИцБпхЖЩхЕеч╝УхнШцЧ╢я╝Мш┐╜хКахИ░хПМчлпщШЯхИЧчЪДх░╛щГи</li> <li>Sender шп╗хПЦц╢ИцБпцЧ╢я╝Мф╗ОхПМчлпщШЯхИЧчЪДхд┤щГишп╗хПЦуАВProducer Batch  ф╕нхПпф╗ехМЕхРлф╕АшЗ│хдЪф╕к ProducerRecordуАВ щАЪф┐ЧхЬ░шп┤я╝М ProducerRecord цШпчФЯф║зшАЕф╕нхИЫх╗║чЪДц╢ИцБпя╝МшАМ Producer Batch цШпцМЗф╕Аф╕кц╢ИцБпцЙ╣цмбя╝М Producer Record ф╝ЪшвлхМЕхРлхЬи Producer Batch ф╕ня╝Мш┐Щца╖хПпф╗еф╜┐хнЧшКВчЪДф╜┐чФицЫ┤хКач┤зхЗСуАВф╕ОцндхРМцЧ╢я╝Мх░Жш╛Гх░ПчЪД ProducerRecord цЛ╝хЗСцИРф╕Аф╕кш╛ГхдзчЪД ProducerBatchя╝Мф╣ЯхПпф╗ехЗПх░Сч╜Сч╗Ьшп╖ц▒ВчЪДцмбцХ░ф╗ецПРхНЗцХ┤ф╜УчЪДхРЮхРРщЗП</li> <li>Producer Batch хТМц╢ИцБпчЪДхЕ╖ф╜Уца╝х╝ПцЬЙхЕ│я╝МхжВцЮЬчФЯф║зшАЕховцИ╖члпщЬАшжБхРСх╛ИхдЪхИЖхМ║хПСщАБц╢ИцБпя╝М хИЩхПпф╗ех░Ж <code>buffer.memory</code> хПВцХ░щАВх╜Уш░Гхдзф╗ехвЮхКацХ┤ф╜УчЪДхРЮхРРщЗП</li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// org.apache.kafka.clients.producer.internals.RecordAccumulator</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">RecordAccumulator</span> <span class="token punctuation">{</span>
  <span class="token comment">// чЬЯцнгчЪДч╝УхнШ CopyOnWriteMap</span>
  <span class="token comment">// Deque цШп ArrayDequeя╝Мх╜Уф╜Ьф╕║ф╕Аф╕кщШЯхИЧцЧ╢я╝МцпФ LinkedList х┐л</span>
  <span class="token comment">// цпПф╕кхИЖхМ║щГ╜цЬЙшЗкх╖▒чЪД Dequeя╝М хнШчЪДцШп RecordBatch</span>
  <span class="token comment">// RecordBatch цЙНцШп record чЬЯцнгч╝УхнШхТМ batch хПСщАБ</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">Deque</span><span class="token punctuation">&lt;</span><span class="token class-name">RecordBatch</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> batches<span class="token punctuation">;</span>
  <span class="token comment">/* * record ц╖╗хКахИ░ ч╝УхЖ▓хМ║ * ч║┐чиЛхоЙхЕия╝МхИЖцо╡хКащФБцПРщлШцАзшГ╜ */</span>
  <span class="token keyword">public</span> <span class="token class-name">RecordAppendResult</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">TopicPartition</span> tp<span class="token punctuation">,</span>
                                    <span class="token keyword">long</span> timestamp<span class="token punctuation">,</span>
                                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span>
                                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value<span class="token punctuation">,</span>
                                    <span class="token class-name">Callback</span> callback<span class="token punctuation">,</span>
                                    <span class="token keyword">long</span> maxTimeToBlock<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// getOrCreateDeque шО╖хПЦх╜УхЙНхИЖхМ║ч╝УхнШя╝Мч║┐чиЛхоЙхЕия╝МCopyOnWriteMap хРОч╗нф╗Лч╗Н</span>
        <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RecordBatch</span><span class="token punctuation">&gt;</span></span> dq <span class="token operator">=</span> <span class="token function">getOrCreateDeque</span><span class="token punctuation">(</span>tp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// чммф╕АцмбхКащФБ</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token class-name">RecordAppendResult</span> appendResult <span class="token operator">=</span> <span class="token function">tryAppend</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> dq<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>appendResult <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> appendResult<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token comment">// шзгщФБ</span>
        <span class="token comment">// ш╡░хИ░ш┐Щф╕Ацнешп┤цШОя╝Мф╕КщЭвчЪД tryAppend ш┐ФхЫЮnull хН│ RecordBatch ф╕║ null</span>
        <span class="token comment">// // хПпшГ╜цЬЙф╕дчзНцГЕхЖ╡я╝Ъц▓бцЬЙRecordBatchя╝МцЧзчЪДRecordBatch х╖▓хЖЩц╗бшжБх╝Аш╛ЯцЦ░чЪД RecordBatch</span>
        <span class="token comment">// хЖЕхнШц▒а(хРОч╗нф╗Лч╗Н)х╝Аш╛ЯцЦ░чЪД RecordBatchя╝Мф╛Ыц╖╗хКач╝УхнШцХ░цНо</span>
        <span class="token comment">// х╝Аш╛ЯцЦ░цЙ╣цмбчЪДчй║щЧ┤шАЧцЧ╢я╝Мф╕НхКащФБ</span>
        <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>batchSize<span class="token punctuation">,</span> <span class="token class-name">Records</span><span class="token punctuation">.</span><span class="token constant">LOG_OVERHEAD</span> <span class="token operator">+</span> <span class="token class-name">Record</span><span class="token punctuation">.</span><span class="token function">recordSize</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Allocating a new {} byte message buffer for topic {} partition {}&quot;</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> tp<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tp<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> free<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> maxTimeToBlock<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// чммф║МцмбхКащФБ</span>
        <span class="token comment">// ф╕Ая╝ЪtryAppend хЖНцмбх░ЭшпХц╖╗хКа</span>
        <span class="token comment">// ф║Мя╝Ъц╖╗хКацИРхКЯя╝Мшп┤цШОх╖▓хнШхЬи RecordBatchя╝МхИащЩдф╣ЛхЙНхИЫх╗║чЪД buffer</span>
        <span class="token comment">// ф╕Йя╝Ъц╖╗хКахд▒ш┤ея╝МхИйчФиф╣ЛхЙНхИЫх╗║чЪД buffer цЦ░х╗║ RecordBatchя╝МчД╢хРОц╖╗хКа</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token class-name">RecordAppendResult</span> appendResult <span class="token operator">=</span> <span class="token function">tryAppend</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> dq<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>appendResult <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// цндцЧ╢хПСчО░х╖▓цЬЙцЦ░цЙ╣цмбчЪД RecordBatchя╝МхИащЩдф╣ЛхЙНхИЫх╗║чЪД buffer</span>
                <span class="token comment">// ч╗УхРИхдЪч║┐чиЛхЬ║цЩпхО╗шАГшЩС</span>
                free<span class="token punctuation">.</span><span class="token function">deallocate</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> appendResult<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// цЦ░х╗║ RecordBatchя╝Мх╣╢х░Ж Record ц╖╗хКа</span>
            <span class="token class-name">MemoryRecords</span> records <span class="token operator">=</span> <span class="token class-name">MemoryRecords</span><span class="token punctuation">.</span><span class="token function">emptyRecords</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> compression<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>batchSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">RecordBatch</span> batch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RecordBatch</span><span class="token punctuation">(</span>tp<span class="token punctuation">,</span> records<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">FutureRecordMetadata</span> future <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>batch<span class="token punctuation">.</span><span class="token function">tryAppend</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// хИЖхМ║щШЯхИЧф╕нц╖╗хКа RecordBatchя╝Мф╕Лцмбф╕НчФихЖНхИЫх╗║</span>
            dq<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
            incomplete<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RecordAppendResult</span><span class="token punctuation">(</span>future<span class="token punctuation">,</span> dq<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">||</span> batch<span class="token punctuation">.</span>records<span class="token punctuation">.</span><span class="token function">isFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token comment">// шзгщФБ</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>batches</code> цШпчЬЯцнгчЪД Record ч╝УхнШцХ░цНоч╗УцЮДя╝Мш┐ЩщЗМшо╛шобф╣ЯцШпх╛Ич▓╛хжЩчЪДуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// org.apache.kafka.common.utils.CopyOnWriteMap</span>
<span class="token comment">// шп╗ф╝ШхМЦ</span>
<span class="token comment">// ш┐ЩщЗМф╕║ф║ЖцПРщлШщШЯхИЧчЪДцАзшГ╜я╝Мф╜┐чФичЪДцХ░цНоч╗УцЮДцШп ArrayDeque ,хН│ V = ArrayQueue</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CopyOnWriteMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token comment">/** * шп╗ map цЧ╢ц▓бхКа */</span>
  <span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Object</span> k<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/** * щЗНчВ╣ * хЖЩ map цЧ╢хКащФБя╝Мшп╗хЖЩхИЖчж╗цАЭш╖пя╝МщАВхРИшп╗хдЪхЖЩх░СчЪДхЬ║цЩпхН│хдЪ get х░С put * putя╝ЪцпПф╕кхИЖхМ║хПкф╝Ъ put ф╕Ацмбя╝МхоЮщЩЕцУНф╜Ьф╕нхИЖхМ║цХ░цЧ╢цЬЙцЬЙщЩРчЪД * ц│ицДПш┐ЩщЗМхдЪх╝Аш╛ЯцЦ░чЪД map я╝МчФиф║Оф║дцНвя╝Ъhttps://www.cnblogs.com/hapjin/p/4840107.html * чЦСщЧоя╝Ъф╕║ф╗Аф╣Иш┐ЩщЗМшжБхдЪхдНхИ╢ф╕Аф╗╜шАМф╕НцШпчЫ┤цОецУНф╜ЬхСвя╝Я хЫаф╕║хРМф╕к map хРМф╕АцЧ╢щЧ┤цЬЙхвЮхИахТМщБНхОЖцЧ╢я╝Мф╝ЪцКе ConcurrentModificationException * цЙАф╗еш┐ЩщЗМхдЪхдНхИ╢ф╕Аф╗╜я╝Мф┐ЭшпБшп╗хОЯцЭечЪД mapя╝МхЖЩхдЗф╗╜чЪД map хРОцЫ┐цНвхОЯхЕИчЪД map */</span>
  <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">V</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">K</span> k<span class="token punctuation">,</span> <span class="token class-name">V</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> copy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">V</span> prev <span class="token operator">=</span> copy<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>map <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableMap</span><span class="token punctuation">(</span>copy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> prev<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">V</span> <span class="token function">putIfAbsent</span><span class="token punctuation">(</span><span class="token class-name">K</span> k<span class="token punctuation">,</span> <span class="token class-name">V</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">containsKey</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token function">put</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
      <span class="token keyword">return</span> <span class="token function">get</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хИ░цндцИСф╗мхПпф╗ех╛ЧхИ░ <code>RecordAccumulator</code> чЪДцХ░цНоч╗УцЮДхЫ╛</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409181348722.jpeg" alt="img"></p> <h3 id="хЖЕхнШц▒а"><a href="#хЖЕхнШц▒а" class="header-anchor">#</a> хЖЕхнШц▒а</h3> <p>Producer хПСщАБцХ░цНоцШпцФТцЙ╣чЪДя╝МхЕИч╝УхнШхИ░ <code>RecordBatch</code> чД╢хРОхЖНцХ┤ф╜УхПСщАБуАВ<code>RecordBatch</code> хЬи JVM хЖЕхнШчй║щЧ┤я╝МProducer хРЮхРРх╛Ихдзх┐ЕчД╢ф╝ЪщвСч╣БхИЫх╗║ <code>RecordBatch</code>уАВхп╣ш▒бщвСч╣БхИЫх╗║я╝МхЬи JAVA ф╕ЦчХМф╕нф╕НхПпщБ┐хЕНчЪДц╢ЙхПКхИ░ <code>GC</code>я╝Мф╜Ж kafka хЬиш┐Щф╕АцнехБЪф║Ж<strong>ф╝ШхМЦ</strong>уАВф╕ЛщЭвф╕Аш╡╖чЬЛчЬЛхЬи Producer члпчЪД<strong>хЖЕхнШц▒а</strong>ф╝ШхМЦуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// шО╖хПЦ RecordBatch цЙАщЬАчЪДхЖЕхнШчй║щЧ┤</span>
<span class="token comment">// ByteBuffer buffer = free.allocate(size, maxTimeToBlock);</span>

<span class="token comment">// org.apache.kafka.clients.producer.internals.BufferPool</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">BufferPool</span> <span class="token punctuation">{</span>
  <span class="token comment">// хПпчФичЪД ByteBuffer щШЯхИЧ</span>
  <span class="token comment">// ByteBuffer цШп щ╗Шшод batch хдзх░ПчЪДхЖЕхнШхЭЧ</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">&gt;</span></span> free<span class="token punctuation">;</span>
  <span class="token comment">// щЬАшжБчнЙх╛Ех╝Аш╛Я ByteBuffer чЪД batchs(ц▓бцЬЙхПпч╝УхЖ▓чЪДхЖЕхнШя╝МщЬАшжБхПСщАБ batch цЭещЗКцФ╛)</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Condition</span><span class="token punctuation">&gt;</span></span> waiters<span class="token punctuation">;</span>
  <span class="token comment">// Deque&lt;ByteBuffer&gt; + availableMemory = ч╝УхнШц▒ахдзх░Пя╝Мщ╗Шшод 32M</span>
  <span class="token comment">// availableMemory хПпхИЖщЕНчЪДхЖЕхнШхдзх░П</span>
  <span class="token keyword">private</span> <span class="token keyword">long</span> availableMemory<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">ByteBuffer</span> <span class="token function">allocate</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">,</span> <span class="token keyword">long</span> maxTimeToBlockMs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token comment">// size хдзф║О цА╗ч╝УхнШц▒ахдзх░Пя╝МчЫ┤цОецКещФЩя╝Мхдкхдзф║ЖцФ╛ф╕Нф╕Л</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>totalMemory<span class="token punctuation">)</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Attempt to allocate &quot;</span> <span class="token operator">+</span> size
                                        <span class="token operator">+</span> <span class="token string">&quot; bytes, but there is a hard limit of &quot;</span>
                                        <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>totalMemory
                                        <span class="token operator">+</span> <span class="token string">&quot; on memory allocations.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// хКащФБ</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// хИдцЦн size цШпхРжф╕║шо╛ч╜очЪД batch size хдзх░Пя╝М</span>
    <span class="token comment">// ф╕АшИмщГ╜цШп batch хдзх░Пя╝МщЩдщЭЮф╕АцЭб record ш╢Еш┐З batch size хИЩшжБхдзф║О batch size</span>
    <span class="token comment">// ш┐ЩщЗМх╛ИхЕ│щФоя╝МцШпхЖЕхнШц▒ачобчРЖчЪДф╜УчО░я╝Ъ</span>
    <span class="token comment">// free:Deque&lt;ByteBuffer&gt; цШп ByteBufferщШЯхИЧя╝Мф╕Ф ByteBuffer хдзх░П=batch size</span>
    <span class="token comment">// хжВцЮЬшжБчФ│шп╖чЪДхЖЕхнШхдзх░ПцШп batch sizeя╝МщВгф╣ИчЫ┤цОеф╗О free шО╖хПЦхН│хПпя╝МцЧащЬАхИЫх╗║цЦ░чЪД ByteBuffer хп╣ш▒б</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> poolableSize <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>free<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>free<span class="token punctuation">.</span><span class="token function">pollFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// now check if the request is immediately satisfiable with the</span>
    <span class="token comment">// memory on hand or if we need to block</span>
    <span class="token keyword">int</span> freeListSize <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>free<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>poolableSize<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>availableMemory <span class="token operator">+</span> freeListSize <span class="token operator">&gt;=</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// чммф╕АчзНцГЕхЖ╡я╝Ъ</span>
        <span class="token comment">// х╜УхЙНхПпчФичЪДхЖЕхнШя╝ИavailableMemory + freeя╝Йхдзф║ОчФ│шп╖чЪД sizeя╝Мх╝Аш╛ЯхРОш┐ФхЫЮ</span>

        <span class="token comment">// щЗКцФ╛ free ф╕нчЪД ByteBuffer хИ░ availableMemoryя╝Мф┐ЭшпБ availableMemory чй║щЧ┤хдзф║ОчФ│шп╖чЪД size</span>
        <span class="token function">freeUp</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>availableMemory <span class="token operator">-=</span> size<span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// чммф║МчзНцГЕхЖ╡я╝Ъ</span>
        <span class="token comment">// х╜УхЙНхПпчФичЪДхЖЕхнШя╝ИavailableMemory + freeя╝Йх░Пф║ОчФ│шп╖чЪД size</span>
        <span class="token comment">// х╜УхЙНч║┐чиЛ blockя╝МчЫ┤хИ░я╝ИavailableMemory + freeя╝Йхдзф║ОчФ│шп╖чЪД sizeя╝МчнЙх╛Е щЗКцФ╛</span>
        <span class="token comment">// хжВцЮЬх╕╕х╕╕хПСчФЯш┐ЩчзНцГЕхЖ╡я╝Мх╗║шоохКахдзч╝УхЖ▓хМ║хдзх░П</span>
        <span class="token keyword">int</span> accumulated <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">Condition</span> moreMemory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> remainingTimeToBlockNs <span class="token operator">=</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>maxTimeToBlockMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// х╜УхЙНх╝Аш╛Я size я╝МхЖЕхнШчй║щЧ┤ф╕Нш╢│я╝Мф┐бцБпхнШхЕе waiters</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>waiters<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>moreMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// чнЙх╛Ея╝МчЫ┤хИ░ хПпчФихЖЕхнШхдзф║ОчФ│шп╖чЪД size</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>accumulated <span class="token operator">&lt;</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> startWaitNs <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">nanoseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> timeNs<span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> waitingTimeElapsed<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// wait</span>
                <span class="token comment">// ш╢ЕцЧ╢шЗкхКишЛПщЖТ</span>
                <span class="token comment">// цЬЙхЖЕхнШщЗКцФ╛швлхФдщЖТ</span>
                waitingTimeElapsed <span class="token operator">=</span> <span class="token operator">!</span>moreMemory<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span>remainingTimeToBlockNs<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">NANOSECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>waiters<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>moreMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token keyword">long</span> endWaitNs <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">nanoseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                timeNs <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">,</span> endWaitNs <span class="token operator">-</span> startWaitNs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>waitTime<span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span>timeNs<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// хжВцЮЬцШпш╢ЕцЧ╢чнЙх╛Ея╝Мшбичд║хЬишзДхоЪчЪДцЧ╢щЧ┤ц▓бцЬЙхПпчФичЪДхЖЕхнШя╝МчЫ┤цОецКещФЩя╝Мщ╗Шшод 60s - шО╖хПЦхЕГцХ░цНоцЧ╢щЧ┤</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>waitingTimeElapsed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>waiters<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>moreMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to allocate memory within the configured max blocking time &quot;</span> <span class="token operator">+</span> maxTimeToBlockMs <span class="token operator">+</span> <span class="token string">&quot; ms.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            remainingTimeToBlockNs <span class="token operator">-=</span> timeNs<span class="token punctuation">;</span>
            <span class="token comment">// хИ░ш┐Щф╕Ацнея╝Мшп┤цШОцЬЙхЖЕхнШщЗКцФ╛</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>accumulated <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> size <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>poolableSize <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>free<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// чФ│шп╖хЖЕхнШsize = batch sizeя╝МцКК free ф╕н ByteBuffer ш┐ФхЫЮ</span>
                buffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>free<span class="token punctuation">.</span><span class="token function">pollFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                accumulated <span class="token operator">=</span> size<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// ч┤пхКа хПпчФихЖЕхнШхдзх░Пя╝Мaccumulated</span>
                <span class="token function">freeUp</span><span class="token punctuation">(</span>size <span class="token operator">-</span> accumulated<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> got <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>size <span class="token operator">-</span> accumulated<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>availableMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>availableMemory <span class="token operator">-=</span> got<span class="token punctuation">;</span>
                accumulated <span class="token operator">+=</span> got<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deallocate</span><span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span> buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>poolableSize <span class="token operator">&amp;&amp;</span> size <span class="token operator">==</span> buffer<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// щЗКцФ╛чЪДхЖЕхнШхдзх░П = batch size</span>
              <span class="token comment">// ц╕Ечй║ bufferя╝Мх╣╢ц╖╗хКахИ░ free</span>
              <span class="token comment">// хЖЕхнШц▒ачобчРЖчЪДф╜УчО░я╝ЪчФихоМхЖЕхнШф╕НщЗКцФ╛я╝МчЫ┤цОехдНчФия╝МхЗПх░С GC</span>
              buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>free<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token comment">// щЗКцФ╛чЪДхЖЕхнШхдзх░П != batch sizeя╝МчЫ┤цОещЗКцФ╛чнЙх╛Е GC</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>availableMemory <span class="token operator">+=</span> size<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// цЬЙхЖЕхнШщЗКцФ╛я╝МхФдщЖТхЬичнЙх╛ЕхЖЕхнШх╝Аш╛ЯчЪД waiters</span>
          <span class="token class-name">Condition</span> moreMem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waiters<span class="token punctuation">.</span><span class="token function">peekFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>moreMem <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
              <span class="token comment">// waitingTimeElapsed = !moreMemory.await(remainingTimeToBlockNs, TimeUnit.NANOSECONDS);</span>
              moreMem<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
          lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>хЖЕхнШчФ│шп╖хТМщЗКцФ╛ф╕╗шжБф╗гчаБхжВф╕КцЙАчд║я╝МцОеф╕ЛцЭечРЖц╕Ешо╛шобя╝Ъ</p> <ul><li>ч╝УхЖ▓ц▒ахИЖф╕║я╝Ъfree хТМ availableMemory</li> <li>availableMemory шбичд║цЬкхИЖщЕНхПпчФичЪДхЖЕхнШя╝Мф╕╗шжБцШпшобчоЧцШпхРжхПпхИЖщЕН size хЖЕхнШя╝ЪхИЖщЕНцЧ╢хЗПх░Ся╝МщЗКцФ╛цЧ╢хвЮхКая╝МхЫЮцФ╢щЭа GC</li> <li>free я╝ЪByteBuffer щШЯхИЧя╝МByteBuffer хдзх░П = batch sizeя╝Мф╕АшИмцБ░хе╜цШпцпПцмбх╝Аш╛ЯчЪДхдзх░Пя╝МщЗКцФ╛цЧ╢ц╕Ечй║цХ░цНо<strong>щЗНцЦ░</strong>ц╖╗хКахИ░щШЯхИЧ</li></ul> <p>цМЙ batch size хдзх░ПхИТхИЖ ByteBufferя╝МхвЮхдзхдНчФицХИцЮЬя╝Ыф╕НчнЙф║О batch size чЪДхЖЕхнШчй║щЧ┤чЫ┤цОе GCя╝Мф╕Нф╝ЪхЗ║чО░хЖЕхнШчвОчЙЗщЧощвШуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409181350106.jpeg" alt="img"></p> <h3 id="nio"><a href="#nio" class="header-anchor">#</a> NIO</h3> <p>цЬЙф║Жф╗еф╕КчЪДчЯешпЖхРОя╝МцИСф╗мхПпф╗ех░Ж record хКахЕехИ░ batch ф╕ня╝МхЗЖхдЗхПСщАБхИ░ kafka brokerуАВхЬихПСщАБф╣ЛхЙНя╝МцИСф╗мхЕИхИЖцЮР kafka чЪДф╜┐чФичЪДч╜Сч╗ЬцбЖцЮ╢ <code>NIO</code>я╝МцЬЙхКйф║ОхРОч╗нхИЖцЮР <code>sender</code> ч║┐чиЛуАВч╜Сч╗Ьф╕АшИмц╢ЙхПКф╕Йф╕кш┐ЗчиЛя╝Ъх╗║члЛш┐ЮцОея╝МхПСщАБцХ░цНоя╝Мшп╗хУНх║ФуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// NetworkClient цШп kafka ч╜Сч╗Ьшп╖ц▒ВхоЮчО░ч▒╗</span>
<span class="token comment">// NetworkClient ф╕╗шжБцШпх░БшгЕ NIO ф╕н selector цУНф╜Ь</span>
<span class="token comment">// ф╕ЛщЭвф╕╗шжБхИЖцЮР kafka ф╕н selector цУНф╜Ья╝МхЕ│ф║О NetworkClient цФ╛хИ░хРОч╗нчЪД sender ч║┐чиЛф╕Аш╡╖хИЖцЮР</span>
<span class="token comment">// org.apache.kafka.common.network.Selector</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Selector</span> <span class="token keyword">implements</span> <span class="token class-name">Selectable</span> <span class="token punctuation">{</span>
  <span class="token comment">// java nioя╝Мф╕Нф║ЖшзгчЪДхЕИхО╗чЖЯцВЙф╕Л</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>channels<span class="token punctuation">.</span></span>Selector</span> nioSelector<span class="token punctuation">;</span>
  <span class="token comment">// шо░х╜Ххп╣ kafka broker ш┐ЮцОе</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">KafkaChannel</span><span class="token punctuation">&gt;</span></span> channels<span class="token punctuation">;</span>

  <span class="token comment">// ф╕О kafka broker х╗║члЛш┐ЮцОея╝Мid = kafka node</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">,</span> <span class="token class-name">InetSocketAddress</span> address<span class="token punctuation">,</span> <span class="token keyword">int</span> sendBufferSize<span class="token punctuation">,</span> <span class="token keyword">int</span> receiveBufferSize<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token class-name">SocketChannel</span> socketChannel <span class="token operator">=</span> <span class="token class-name">SocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// шо╛ч╜ощЭЮщШ╗хбЮцибх╝П</span>
    socketChannel<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Socket</span> socket <span class="token operator">=</span> socketChannel<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    socket<span class="token punctuation">.</span><span class="token function">setKeepAlive</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sendBufferSize <span class="token operator">!=</span> <span class="token class-name">Selectable</span><span class="token punctuation">.</span><span class="token constant">USE_DEFAULT_BUFFER_SIZE</span><span class="token punctuation">)</span>
        socket<span class="token punctuation">.</span><span class="token function">setSendBufferSize</span><span class="token punctuation">(</span>sendBufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>receiveBufferSize <span class="token operator">!=</span> <span class="token class-name">Selectable</span><span class="token punctuation">.</span><span class="token constant">USE_DEFAULT_BUFFER_SIZE</span><span class="token punctuation">)</span>
        socket<span class="token punctuation">.</span><span class="token function">setReceiveBufferSize</span><span class="token punctuation">(</span>receiveBufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// tcp ф╝ШхМЦ</span>
    socket<span class="token punctuation">.</span><span class="token function">setTcpNoDelay</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> connected<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// х░ЭшпХх╗║члЛш┐ЮцОе</span>
        connected <span class="token operator">=</span> socketChannel<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnresolvedAddressException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        socketChannel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;Can't resolve address: &quot;</span> <span class="token operator">+</span> address<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        socketChannel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// channel хКахИ░ nio selectorя╝Мх╣╢ц╖╗хКа OP_CONNECT ф║Лф╗╢</span>
    <span class="token comment">// хРОч╗н chanel х╗║члЛш┐ЮцОехРОя╝МчФ▒ nio selector ш┐ФхЫЮ connect ф║Лф╗╢</span>
    <span class="token class-name">SelectionKey</span> key <span class="token operator">=</span> socketChannel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>nioSelector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_CONNECT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// id = kafka nodeя╝ЫkafkaChannel хПкцШпхп╣ java channel чЪДх░БшгЕ</span>
    <span class="token class-name">KafkaChannel</span> channel <span class="token operator">=</span> channelBuilder<span class="token punctuation">.</span><span class="token function">buildChannel</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> key<span class="token punctuation">,</span> maxReceiveSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// хРОч╗нхдДчРЖцЧ╢хПпщАЪш┐З key.attachment х╛ЧхИ░ channel</span>
    key<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// шо░х╜Х kafka node хп╣х║ФчЪД channel</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>channels<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// хПСщАБцХ░цНо</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">Send</span> send<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// щАЪш┐Зsend шО╖хПЦ kafka node х╛ЧхИ░хп╣х║ФчЪД channel</span>
    <span class="token class-name">KafkaChannel</span> channel <span class="token operator">=</span> <span class="token function">channelOrFail</span><span class="token punctuation">(</span>send<span class="token punctuation">.</span><span class="token function">destination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// channel хПСщАБцХ░цНоя╝МцндцЧ╢хПкцШпф╕║ channel ц╖╗хКа OP_WRITEя╝Мх╣╢цЬкчЬЯцнгхПСщАБ</span>
        channel<span class="token punctuation">.</span><span class="token function">setSend</span><span class="token punctuation">(</span>send<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CancelledKeyException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>failedSends<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>send<span class="token punctuation">.</span><span class="token function">destination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// sender ч║┐чиЛф╕нф╝ЪхоЪцЧ╢ш░ГчФишО╖хПЦ event </span>
  <span class="token comment">// шп╗хПЦ nio selector eventя╝Мtime шбичд║цШпхРжщЬАшжБщШ╗хбЮчнЙх╛Еф║Лф╗╢хПСчФЯ</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// block чЫ┤хИ░цЬЙф║Лф╗╢</span>
    <span class="token comment">// ц│ицДПцндцЧ╢ф╝Ъ waitя╝МщВгф╣Иф╝Ъхп╝шЗ┤ sender ч║┐чиЛф╣Яф╝Ъф╝СчЬая╝МщЬАшжБш░ГчФи sender.wakeup хФдщЖТ</span>
    <span class="token keyword">int</span> readyKeys <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">long</span> endSelect <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">nanoseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sensors<span class="token punctuation">.</span>selectTime<span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span>endSelect <span class="token operator">-</span> startSelect<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// цЬЙщЬАшжБхУНх║ФчЪДф║Лф╗╢</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>readyKeys <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token operator">!</span>immediatelyConnectedKeys<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pollSelectionKeys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>nioSelector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> endSelect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pollSelectionKeys</span><span class="token punctuation">(</span>immediatelyConnectedKeys<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> endSelect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// хдДчРЖцЬНхКбчлпш┐ФхЫЮчЪДхУНх║Ф,stagedReceives</span>
    <span class="token function">addToCompletedReceives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// хдДчРЖ nio selector ш┐ФхЫЮчЪДф║Лф╗╢</span>
  <span class="token comment">// connect</span>
  <span class="token comment">// read</span>
  <span class="token comment">// write</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">pollSelectionKeys</span><span class="token punctuation">(</span><span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> selectionKeys<span class="token punctuation">,</span>
                                <span class="token keyword">boolean</span> isImmediatelyConnected<span class="token punctuation">,</span>
                                <span class="token keyword">long</span> currentTimeNanos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// eventKeys</span>
    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> selectionKeys<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SelectionKey</span> key <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        iterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">KafkaChannel</span> channel <span class="token operator">=</span> <span class="token function">channel</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// хдДчРЖ connect я╝Мф╕О kafka node х╖▓х╗║члЛш┐ЮцОея╝ЪOP_CONNECT</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isImmediatelyConnected <span class="token operator">||</span> key<span class="token punctuation">.</span><span class="token function">isConnectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// ш┐ЮцОех╗║члЛхоМцИРхРОя╝Мchannel ф╕Кхп╣х║ФчЪДkey хО╗щЩд OP_CONNECTя╝Мц╖╗хКа OP_READ ф║Лф╗╢</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">finishConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// шо░х╜Хх╜УхЙН kafka node х╖▓х╗║члЛш┐ЮцОе</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>connected<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>sensors<span class="token punctuation">.</span>connectionCreated<span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">SocketChannel</span> socketChannel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SocketChannel</span><span class="token punctuation">)</span> key<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Created socket with SO_RCVBUF = {}, SO_SNDBUF = {}, SO_TIMEOUT = {} to node {}&quot;</span><span class="token punctuation">,</span>
                            socketChannel<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getReceiveBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            socketChannel<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSendBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            socketChannel<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSoTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            channel<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment">// хдДчРЖ readя╝ЪхЬих╗║члЛш┐ЮцОехРОх╖▓ц╖╗хКа OP_READ ф║Лф╗╢</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">hasStagedReceive</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">NetworkReceive</span> networkReceive<span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>networkReceive <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    <span class="token function">addToStagedReceives</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> networkReceive<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// хдДчРЖ writeя╝ЪOP_WRITE (send(Send send))</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">isWritable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// channel.setSend(send); ф╕║ chanel ц╖╗хКа send</span>
                <span class="token comment">// щАЪш┐З chanel хПСщАБцХ░цНоя╝ЪRecordBatchs</span>
                <span class="token class-name">Send</span> send <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>send <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>completedSends<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>send<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>sensors<span class="token punctuation">.</span><span class="token function">recordBytesSent</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> send<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// хЕ│щЧнш┐ЮцОе</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>key<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">close</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>disconnected<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409181351976.jpeg" alt="img"></p> <h4 id="read"><a href="#read" class="header-anchor">#</a> read</h4> <p>х╜Уф╜┐чФи <code>NIO</code> я╝МчФ▒ф║О buffer хдзх░Пф╕НхМ╣щЕНщЧощвШя╝Мх┐ЕчД╢ф╝Ъчв░хИ░ч▓ШхМЕцИЦцЛЖхМЕчЪДщЧощвШуАВхБЗшо╛ф╕дф╕кхУНх║Фш┐ФхЫЮ тАЬhello wordтАЭ хТМ тАЬflink kafkaтАЭя╝МцЬЙхПпшГ╜цШпш┐ФхЫЮ(<strong>ф╕Аф╕кш┐ФхЫЮх░▒хе╜шзжхПСф╕Аф╕к read event</strong>)</p> <ul><li>тАЬhello wordтАЭ</li> <li>тАЬflink тАЬ</li> <li>тАЬkafkaтАЭ</li></ul> <p>ш┐ЩхПл<strong>цЛЖхМЕ</strong>я╝Мф╣ЯцЬЙхПпшГ╜ш┐ФхЫЮ</p> <ul><li>тАЬhello wordflinkтАЭ</li> <li>тАЬkafkaтАЭ</li></ul> <p>ш┐ЩхПл<strong>ч▓ШхМЕ</strong></p> <p>kafka чЪДшзгхЖ│цЦ╣цбИцШпчЫ╕х╜Уф║ОхЬихОЯцЬЙ data хЯ║чбАф╕КхвЮхКа headerя╝Мheader хПкхМЕхРл data sizeя╝Мх╛ИцЬ┤ч┤ахТМщАЪчФицЦ╣цбИуАВф╕дф╕кцХ░цНохМЕхПШцИР 10тАЭhello wordтАЭя╝М11тАЭflink kafkaтАЭуАВцндцЧ╢шп╗хПЦцЦ╣х╝ПхПШф╕║хЕИшп╗хПЦ4хнЧшКВ <code>size</code>я╝МчД╢хРОхЖНх╝Аш╛Я size хдзх░ПчЪД <code>buffer</code> хнШdataя╝М<strong>цн╗х╛кчОп</strong>чЫ┤хИ░ data buffer шп╗ц╗б</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// org.apache.kafka.common.network.Selector</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">hasStagedReceive</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">NetworkReceive</span> networkReceive<span class="token punctuation">;</span>
    <span class="token comment">// read receiveш┐ФхЫЮnull шбичд║х╜УхЙНхУНх║ФхМЕф╕║шп╗хПЦхоМцпХя╝МчнЙх╛Еф╕Лф╕к read eventхЖНшп╗</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>networkReceive <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token comment">// receive complete цЙНчоЧхУНх║Фшп╗хПЦхоМцпХ</span>
        <span class="token comment">// receive ц╖╗хКахИ░ stagedReceives</span>
        <span class="token function">addToStagedReceives</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> networkReceive<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// org.apache.kafka.common.network.KafkaChannel</span>
<span class="token keyword">public</span> <span class="token class-name">NetworkReceive</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">NetworkReceive</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>receive <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        receive <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NetworkReceive</span><span class="token punctuation">(</span>maxReceiveSize<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// read</span>
    <span class="token function">receive</span><span class="token punctuation">(</span>receive<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// size хТМ data щГ╜шп╗хПЦхоМцпХ,цЙНчоЧ complete</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>receive<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        receive<span class="token punctuation">.</span><span class="token function">payload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> receive<span class="token punctuation">;</span>
        receive <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">receive</span><span class="token punctuation">(</span><span class="token class-name">NetworkReceive</span> receive<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> receive<span class="token punctuation">.</span><span class="token function">readFrom</span><span class="token punctuation">(</span>transportLayer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">readFromReadableChannel</span><span class="token punctuation">(</span><span class="token class-name">ReadableByteChannel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> read <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// шп╗хПЦ sizeя╝Ы</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>size<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">int</span> bytesRead <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>bytesRead <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">EOFException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      read <span class="token operator">+=</span> bytesRead<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>size<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          size<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">int</span> receiveSize <span class="token operator">=</span> size<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
          <span class="token comment">// шп╗хПЦхИ░sizeя╝МхПпчЯе data щХ┐х║жя╝МчФ│шп╖хнШцФ╛ data цЙАщЬАчЪД buffer</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>receiveSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// шп╗хПЦ dataя╝ЫцпПцмбш┐ЫцЭещГ╜х┐Еф╝Ъшп╗хПЦ buffer</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">int</span> bytesRead <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>bytesRead <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">EOFException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      read <span class="token operator">+=</span> bytesRead<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> read<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="sender-ч║┐чиЛ"><a href="#sender-ч║┐чиЛ" class="header-anchor">#</a> Sender ч║┐чиЛ</h2> <p>цХ┤ф╕кчФЯф║зшАЕховцИ╖члпчФ▒ф╕дф╕кч║┐чиЛхНПш░Гш┐РшбМя╝Мш┐Щф╕дф╕кч║┐чиЛхИЖхИлф╕║ф╕╗ч║┐чиЛхТМSender ч║┐чиЛ(хПСщАБч║┐чиЛ)уАВхЬиф╕╗ч║┐чиЛф╕нчФ▒KafkaProducer хИЫх╗║ц╢ИцБпя╝МчД╢хРОщАЪш┐ЗхПпшГ╜чЪДцЛжцИкхЩиуАБх║ПхИЧхМЦхЩихТМхИЖхМ║хЩичЪДф╜ЬчФиф╣ЛхРОч╝УхнШхИ░ц╢ИцБпч┤пхКахЩи(RecordAccumulatorя╝Мф╣Ячз░ф╕║ц╢ИцБпцФ╢щЫЖхЩи)ф╕нуАВSender ч║┐чиЛш┤Яш┤гф╗ОRecordAccumulatorф╕ншО╖хПЦц╢ИцБпх╣╢х░ЖхЕ╢хПСщАБхИ░Kafkaф╕нуАВ</p> <p>хИ░цндцИСф╗мхЕ╖хдЗф║ЖхПСщАБ rocordBatch чЪДчОпхвГя╝Мх╝АхзЛхРСцЬНхКбчлпхПСщАБц╡БчиЛуАВ</p> <p><code>Sender</code> цШп Kafka чФЯф║зшАЕчЪДца╕х┐Гч║┐чиЛя╝Мш┤Яш┤гф╗Оц╢ИцБпч┤пхКахЩиф╕нцПРхПЦц╢ИцБпя╝Мх╣╢щАЪш┐Зч╜Сч╗ЬхПСщАБхИ░ Kafka цЬНхКбхЩиуАВхЕ╢х╖еф╜Ьц╡БчиЛхжВф╕Ля╝Ъ</p> <ol><li>ф╗О <code>RecordAccumulator</code> ф╕нхПЦхЗ║х╖▓хЗЖхдЗхе╜чЪДц╢ИцБпцЙ╣цмбуАВ</li> <li>ца╣цНоц╢ИцБпчЪДхИЖхМ║хТМф╕╗щвШцЙ╛хИ░хп╣х║ФчЪД Kafka цЬНхКбхЩиуАВ</li> <li>хПСщАБц╢ИцБпя╝Мх╣╢хдДчРЖхУНх║Фя╝ИхМЕцЛмщЗНшпХуАБш╢ЕцЧ╢уАБхд▒ш┤ечнЙцГЕхЖ╡я╝ЙуАВ</li></ol> <p><code>Sender</code> ч║┐чиЛцШпх╝Вцнеш┐РшбМчЪДя╝МщАЪш┐ЗщлШцХИчЪД I/O хТМцЙ╣щЗПхПСщАБцЬ║хИ╢ф┐ЭшпБф║ЖчФЯф║зшАЕчЪДщлШцАзшГ╜уАВхЬищлШхРЮхРРщЗПчЪДхЬ║цЩпф╕Ля╝Мш░ГцХ┤ <code>Sender</code> ч║┐чиЛчЪДчЫ╕хЕ│хПВцХ░я╝ИхжВ <code>retries</code> хТМ <code>max.in.flight.requests.per.connection</code>я╝ЙшГ╜хдЯцШ╛шСЧцПРхНЗц╢ИцБпхПСщАБчЪДцХИчОЗуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// org.apache.kafka.clients.producer.KafkaProducer</span>
<span class="token comment">// ц╗бш╢│ batch хПСщАБцЭбф╗╢я╝МхФдщЖТ sender хПСщАБцХ░цНо</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// шо░х╛Чф╕║ф╗Аф╣Иш┐ЩщЗМшжБхФдщЖТхРЧя╝Яselector.poll цЬЙхПпшГ╜ф╝Ъ wait</span>

<span class="token comment">// хРОхП░ч║┐чиЛхПСщАБшп╖ц▒В</span>
<span class="token comment">// org.apache.kafka.clients.producer.internals.Sender</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Sender</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">KafkaClient</span> client<span class="token punctuation">;</span>
  <span class="token comment">// whileя╝Иrunя╝Й</span>
  <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Cluster</span> cluster <span class="token operator">=</span> metadata<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ф╗Оч╝УхЖ▓ц▒а accumulator чнЫщАЙхЗ║ц╗бш╢│ batch send чЪД kafka nodes</span>
    <span class="token class-name">RecordAccumulator<span class="token punctuation">.</span>ReadyCheckResult</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span>cluster<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// хжВцЮЬцЬЙ topic чЪДхЕГцХ░цНоф┐бцБпф╜НшО╖хПЦя╝Мшо╛ч╜охЕГцХ░цНоцаЗшпЖ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>unknownLeaderTopics<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> topic <span class="token operator">:</span> result<span class="token punctuation">.</span>unknownLeaderTopics<span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>metadata<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>metadata<span class="token punctuation">.</span><span class="token function">requestUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ф╗ОщЬАшжБхПСщАБчЪД kafka nodes ф╕нчз╗щЩдц▓бцЬЙхЗЖхдЗхе╜ш┐ЮцОечЪД nodeя╝МхИдцЦнцЭбф╗╢</span>
    <span class="token comment">// хЕГцХ░цНохМЕхРлх╜УхЙН kafka node</span>
    <span class="token comment">// ф╕Ох╜УхЙН kafka node connection х╖▓х╗║члЛ</span>
    <span class="token comment">// ф╕Ох╜УхЙН kafka node channel х╖▓х╗║члЛ</span>
    <span class="token comment">// хПСщАБ batch шп╖ц▒ВцХ░цЬкш╢Еш┐ЗцМЗхоЪчЪДцЬАхдзхА╝(щ╗Шшод5)я╝МчФЯф║зф╕нф╕АшИмшо╛ч╜оф╕║1я╝Мф┐ЭшпБцХ░цНоф╕Нф╣▒х║П</span>
    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">&gt;</span></span> iter <span class="token operator">=</span> result<span class="token punctuation">.</span>readyNodes<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> notReadyTimeout <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span> node <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ready ф╕нхжВцЮЬхПСчО░цЬкш┐ЮцОеф╝ЪхО╗хИЭхзЛхМЦш┐ЮцОе selector.connect</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            iter<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            notReadyTimeout <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>notReadyTimeout<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">connectionDelay</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ф╗ОхЗЖхдЗхе╜хПСщАБчЪД kafkanodes ф╕ня╝МшО╖хПЦщЬАшжБхПСщАБчЪД recordBatch </span>
    <span class="token comment">// чммф╕Ацмбш░ГчФицЧ╢я╝Мф╕О kafka node чЪДш┐ЮцОещГ╜ц▓бцЬЙх╗║члЛя╝МцндцЧ╢ result.readyNodes ф╕║чй║</span>
    <span class="token comment">// хЬи poll хЗ╜цХ░хПСчО░ connect ф║Лф╗╢я╝МцндцЧ╢ф╝ЪхПСш╡╖ш┐ЮцОея╝МщВгф╣Иф╕ЛцмбхЖНхЗЖхдЗхПСщАБцЧ╢х░▒хПпф╗еф║Ж</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">RecordBatch</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> batches <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator<span class="token punctuation">.</span><span class="token function">drain</span><span class="token punctuation">(</span>cluster<span class="token punctuation">,</span>
                                                                      result<span class="token punctuation">.</span>readyNodes<span class="token punctuation">,</span>
                                                                      <span class="token keyword">this</span><span class="token punctuation">.</span>maxRequestSize<span class="token punctuation">,</span>
                                                                      now<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>guaranteeMessageOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Mute all the partitions drained</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RecordBatch</span><span class="token punctuation">&gt;</span></span> batchList <span class="token operator">:</span> batches<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RecordBatch</span> batch <span class="token operator">:</span> batchList<span class="token punctuation">)</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator<span class="token punctuation">.</span><span class="token function">mutePartition</span><span class="token punctuation">(</span>batch<span class="token punctuation">.</span>topicPartition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// хдДчРЖш╢ЕцЧ╢чЪДхПСщАБ</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RecordBatch</span><span class="token punctuation">&gt;</span></span> expiredBatches <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator<span class="token punctuation">.</span><span class="token function">abortExpiredBatches</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestTimeout<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// хИЫх╗║шп╖ц▒Вя╝Ъх░ЖшжБхПСщАБчЪД recordbatch х░БшгЕцИРClientRequest</span>
    <span class="token comment">// цпПф╕кrequests щГ╜цЬЙф╕кхЫЮш░ГхЗ╜цХ░(handleProduceResponse)я╝МхЬицФ╢хИ░хУНх║ФцЧ╢ш░ГчФи</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientRequest</span><span class="token punctuation">&gt;</span></span> requests <span class="token operator">=</span> <span class="token function">createProduceRequests</span><span class="token punctuation">(</span>batches<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> pollTimeout <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>nextReadyCheckDelayMs<span class="token punctuation">,</span> notReadyTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>readyNodes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Nodes with data ready to send: {}&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>readyNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Created {} produce requests: {}&quot;</span><span class="token punctuation">,</span> requests<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requests<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pollTimeout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// хПСщАБцХ░цНоя╝Мш┐ЩщЗМхПкцШпхЬи select ц│ихЖМ op_writeя╝Мх╣╢хЬи channel ц╖╗хКа send</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ClientRequest</span> request <span class="token operator">:</span> requests<span class="token punctuation">)</span>
        client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// хжВцЮЬщЬАшжБцЬЙцХ░цНохПСщАБя╝Мselect.poll(0)я╝Мф╕НчнЙх╛ЕчЫ┤цОеш┐ФхЫЮя╝МхЫаф╕║цЬЙцХ░цНошжБхПСщАБ</span>
    <span class="token comment">// хжВцЮЬц▓бцЬЙщЬАшжБхПСщАБчЪДцХ░цНоя╝Мselect.poll(timeout)я╝Мш╖Эчж╗ф╕ЛцмбцЬЙцХ░цНошжБхПСщАБчЪДщЧ┤щЪФ(linger ms)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>pollTimeout<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>sender ч║┐чиЛщА╗ш╛Сх╛Иц╕ЕцЩ░я╝Ъ</p> <ul><li>while ф╗еф╕Лцнещкд</li> <li>цгАцЯеч╝УхЖ▓хМ║ф╕нц╗бш╢│<strong>хПСщАБцЭбф╗╢</strong>чЪД recordBatch</li> <li>цгАцЯешжБхПСщАБчЪД recordBatch чЪДхЕГцХ░цНоцШпхРжх╖▓хЗЖхдЗ</li> <li>хИащЩдцЬкх╗║члЛш┐ЮцОечЪД kafka node(цЬкш┐ЮцОецЧ╢ф╝ЪхПСш╡╖ш┐ЮцОеф║Лф╗╢)</li> <li>шО╖хПЦх╖▓х╗║члЛш┐ЮцОе kafka node чЪД recordBatch</li> <li>х░Ж recordBatchs х░БшгЕцИР ClientRequest</li> <li>хПСщАБ ClientRequest</li> <li>poll</li></ul> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409181352804.jpeg" alt="img"></p> <h4 id="хПСш╡╖ш┐ЮцОе"><a href="#хПСш╡╖ш┐ЮцОе" class="header-anchor">#</a> хПСш╡╖ш┐ЮцОе</h4> <p>чиЛх║ПхИЪш┐РшбМчЪДцЧ╢хАЩшВпхоЪцШпц▓бцЬЙх╗║члЛш┐ЮцОея╝Мх╜УхПСчО░цЬЙ recordbatch щЬАшжБхПСщАБцЧ╢ф╝ЪхЕИхИдцЦнцШпхРжх╖▓ш┐ЮцОеуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// this.client.ready(node, now)</span>
<span class="token comment">// org.apache.kafka.clients.NetworkClient</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">ready</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">,</span> <span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot connect to empty node &quot;</span> <span class="token operator">+</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// entry</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isReady</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">// цЬкш┐ЮцОецИЦхд▒хО╗ш┐ЮцОея╝МхИЭхзЛхМЦ</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>connectionStates<span class="token punctuation">.</span><span class="token function">canConnect</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">idString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// selector.connect: OP_CONNECT</span>
      <span class="token function">initiateConnect</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/** * цгАцЯецШпхРжхПпф╗ехРСх╜УхЙН kafka node хПСщАБц╢ИцБпя╝Ъ * хЕГцХ░цНохМЕхРлх╜УхЙН kafka node * ф╕Ох╜УхЙН kafka node connection х╖▓х╗║члЛ * ф╕Ох╜УхЙН kafka node channel х╖▓х╗║члЛ * хПСщАБ batch шп╖ц▒ВцХ░цЬкш╢Еш┐ЗцМЗхоЪчЪДцЬАхдзхА╝(щ╗Шшод5) */</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isReady</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">,</span> <span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// if we need to update our metadata now declare all requests unready to make metadata requests first</span>
    <span class="token comment">// priority</span>
    <span class="token keyword">return</span> <span class="token operator">!</span>metadataUpdater<span class="token punctuation">.</span><span class="token function">isUpdateDue</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">canSendRequest</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">idString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="clientrequest"><a href="#clientrequest" class="header-anchor">#</a> ClientRequest</h4> <p>шжБхПСщАБчЪД recordBatch х░БшгЕцИР ClientRequest</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// List&lt;ClientRequest&gt; requests = createProduceRequests(batches, now);</span>
<span class="token comment">// org.apache.kafka.clients.producer.internals.Sender</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientRequest</span><span class="token punctuation">&gt;</span></span> <span class="token function">createProduceRequests</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">RecordBatch</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> collated<span class="token punctuation">,</span> <span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientRequest</span><span class="token punctuation">&gt;</span></span> requests <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientRequest</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>collated<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">RecordBatch</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> collated<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// хИЫх╗║шп╖ц▒Вя╝Ъacks щЭЮх╕╕щЗНшжБя╝МrequestTimeout щ╗Шшод 30s</span>
      <span class="token comment">// х░ЖхРМф╕к node ф╕КчЪДхдЪф╕к batchч╗ДшгЕхЬиф╕Аш╡╖</span>
      requests<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">produceRequest</span><span class="token punctuation">(</span>now<span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> acks<span class="token punctuation">,</span> requestTimeout<span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> requests<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token class-name">ClientRequest</span> <span class="token function">produceRequest</span><span class="token punctuation">(</span><span class="token keyword">long</span> now<span class="token punctuation">,</span> <span class="token keyword">int</span> destination<span class="token punctuation">,</span> <span class="token keyword">short</span> acks<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RecordBatch</span><span class="token punctuation">&gt;</span></span> batches<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">&gt;</span></span> produceRecordsByPartition <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>batches<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">RecordBatch</span><span class="token punctuation">&gt;</span></span> recordsByPartition <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">RecordBatch</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>batches<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RecordBatch</span> batch <span class="token operator">:</span> batches<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">TopicPartition</span> tp <span class="token operator">=</span> batch<span class="token punctuation">.</span>topicPartition<span class="token punctuation">;</span>
      produceRecordsByPartition<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>tp<span class="token punctuation">,</span> batch<span class="token punctuation">.</span>records<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      recordsByPartition<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>tp<span class="token punctuation">,</span> batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token class-name">ProduceRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProduceRequest</span><span class="token punctuation">(</span>acks<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> produceRecordsByPartition<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// recordBatch цХ░цНохнШхИ░ RequestSend цХ░цНоч╗УцЮД</span>
  <span class="token class-name">RequestSend</span> send <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RequestSend</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>destination<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                      <span class="token comment">// ApiKeys.PRODUCE цаЗшпЖчмжя╝МцЬНхКбчлпф╝Ъца╣цНош┐Щф╕кцаЗшпЖчмжхдДчРЖ</span>
                                      <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">nextRequestHeader</span><span class="token punctuation">(</span><span class="token class-name">ApiKeys</span><span class="token punctuation">.</span><span class="token constant">PRODUCE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                      request<span class="token punctuation">.</span><span class="token function">toStruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// шо╛ч╜ошп╖ц▒Вч╗УцЭЯчЪДхЫЮш░ГхЗ╜цХ░я╝МхРОч╗нхЬихУНх║Фф╝ЪчФихИ░ </span>
  <span class="token class-name">RequestCompletionHandler</span> callback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RequestCompletionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onComplete</span><span class="token punctuation">(</span><span class="token class-name">ClientResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">handleProduceResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> recordsByPartition<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ClientRequest</span><span class="token punctuation">(</span>now<span class="token punctuation">,</span> acks <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> send<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="хУНх║Ф"><a href="#хУНх║Ф" class="header-anchor">#</a> хУНх║Ф</h4> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// this.client.poll(pollTimeout, now);</span>
<span class="token comment">// org.apache.kafka.clients.NetworkClient</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientResponse</span><span class="token punctuation">&gt;</span></span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// цШпхРжщЬАшжБцЫ┤цЦ░хЕГцХ░цНо</span>
  <span class="token keyword">long</span> metadataTimeout <span class="token operator">=</span> metadataUpdater<span class="token punctuation">.</span><span class="token function">maybeUpdate</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// selector.pollя╝МхдДчРЖ OP_CONNECTуАБOP_WRITEуАБOP_READ ф║Лф╗╢</span>
      <span class="token comment">// OP_READ щАЪш┐З nio read -&gt; completedReceives</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> metadataTimeout<span class="token punctuation">,</span> requestTimeoutMs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Unexpected error during I/O&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// process completed actions</span>
  <span class="token keyword">long</span> updatedNow <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>time<span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientResponse</span><span class="token punctuation">&gt;</span></span> responses <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// хдДчРЖх╖▓хПСщАБчЪД send(recordBatch)</span>
  <span class="token comment">// responses.add(new ClientResponse(request, now, false, null));</span>
  <span class="token function">handleCompletedSends</span><span class="token punctuation">(</span>responses<span class="token punctuation">,</span> updatedNow<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// хдДчРЖш┐ФхЫЮчЪДхУНх║Ф</span>
  <span class="token comment">// responses.add(new ClientResponse(req, now, false, body));</span>
  <span class="token function">handleCompletedReceives</span><span class="token punctuation">(</span>responses<span class="token punctuation">,</span> updatedNow<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">handleDisconnections</span><span class="token punctuation">(</span>responses<span class="token punctuation">,</span> updatedNow<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">handleConnections</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// хдДчРЖш╢ЕцЧ╢чЪДшп╖ц▒В</span>
  <span class="token function">handleTimedOutRequests</span><span class="token punctuation">(</span>responses<span class="token punctuation">,</span> updatedNow<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// invoke callbacks</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ClientResponse</span> response <span class="token operator">:</span> responses<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token comment">// хЫЮш░Гшп╖ц▒ВчЪД callbackя╝МhandleProduceResponse</span>
              response<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onComplete</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Uncaught error in request completion:&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> responses<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>хПСщАБч╗УцЭЯчЪДхУНх║Ф</li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// org.apache.kafka.clients.NetworkClient</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleCompletedSends</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientResponse</span><span class="token punctuation">&gt;</span></span> responses<span class="token punctuation">,</span> <span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// completedSends.add(send); selector write цЧ╢хКахЕе</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Send</span> send <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">.</span><span class="token function">completedSends</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ClientRequest</span> request <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>inFlightRequests<span class="token punctuation">.</span><span class="token function">lastSent</span><span class="token punctuation">(</span>send<span class="token punctuation">.</span><span class="token function">destination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>request<span class="token punctuation">.</span><span class="token function">expectResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment">// ack = 0я╝МцЙНф╝ЪцЮДх╗║ send ч╗УцЭЯхУНх║Фя╝Мш┐ЩчзНцЦ╣х╝Пф╕НщЬАшжБцЬНхКбчлпш┐ФхЫЮч╗УцЮЬ</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>inFlightRequests<span class="token punctuation">.</span><span class="token function">completeLastSent</span><span class="token punctuation">(</span>send<span class="token punctuation">.</span><span class="token function">destination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// responseBody ф╕║ null</span>
            responses<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClientResponse</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> now<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>цЬНхКбчлпш┐ФхЫЮчЪДхУНх║Ф</li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleCompletedReceives</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientResponse</span><span class="token punctuation">&gt;</span></span> responses<span class="token punctuation">,</span> <span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">NetworkReceive</span> receive <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">.</span><span class="token function">completedReceives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">String</span> source <span class="token operator">=</span> receive<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">ClientRequest</span> req <span class="token operator">=</span> inFlightRequests<span class="token punctuation">.</span><span class="token function">completeNext</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// receive чЪДф║Мш┐ЫхИ╢шзгцЮРцИРхПпшпЖхИлчЪДцХ░цНо</span>
      <span class="token class-name">Struct</span> body <span class="token operator">=</span> <span class="token function">parseResponse</span><span class="token punctuation">(</span>receive<span class="token punctuation">.</span><span class="token function">payload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>metadataUpdater<span class="token punctuation">.</span><span class="token function">maybeHandleCompletedReceive</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> now<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token comment">// responseBody цЬЙхА╝</span>
          responses<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClientResponse</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> now<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>ш╢ЕцЧ╢шп╖ц▒ВчЪДхУНх║Ф</li></ul> <div class="language- extra-class"><pre class="language-text"><code>private void processDisconnection(List&lt;ClientResponse&gt; responses, String nodeId, long now) {
  connectionStates.disconnected(nodeId, now);
  for (ClientRequest request : this.inFlightRequests.clearAll(nodeId)) {
      log.trace(&quot;Cancelled request {} due to node {} being disconnected&quot;, request, nodeId);
      if (!metadataUpdater.maybeHandleDisconnection(request))
          // responseBody ф╕║ null ф╕Ф disconnected ф╕║ true
          responses.add(new ClientResponse(request, now, true, null));
  }
}
</code></pre></div><ul><li>хдДчРЖхУНх║Ф</li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// org.apache.kafka.clients.producer.internals.Sender</span>
<span class="token comment">// шп╖ц▒ВхЫЮш░Г</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleProduceResponse</span><span class="token punctuation">(</span><span class="token class-name">ClientResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">RecordBatch</span><span class="token punctuation">&gt;</span></span> batches<span class="token punctuation">,</span> <span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// batches = хПСщАБшп╖ц▒ВцЧ╢цР║х╕жчЪД recordBatch</span>
  <span class="token comment">// completeBatch</span>
  <span class="token keyword">int</span> correlationId <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">correlationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">wasDisconnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// хд▒хО╗ш┐ЮцОе</span>
      log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Cancelled request {} due to node {} being disconnected&quot;</span><span class="token punctuation">,</span> response<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                                                                            <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                                                                            <span class="token punctuation">.</span><span class="token function">destination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Errors = Errors.NETWORK_EXCEPTIONя╝М</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RecordBatch</span> batch <span class="token operator">:</span> batches<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token function">completeBatch</span><span class="token punctuation">(</span>batch<span class="token punctuation">,</span> <span class="token class-name">Errors</span><span class="token punctuation">.</span><span class="token constant">NETWORK_EXCEPTION</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token class-name">Record</span><span class="token punctuation">.</span><span class="token constant">NO_TIMESTAMP</span><span class="token punctuation">,</span> correlationId<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Received produce response from node {} with correlation id {}&quot;</span><span class="token punctuation">,</span>
                response<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">destination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                correlationId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">hasResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// ack != 0</span>
          <span class="token class-name">ProduceResponse</span> produceResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProduceResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">responseBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">ProduceResponse<span class="token punctuation">.</span>PartitionResponse</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> produceResponse<span class="token punctuation">.</span><span class="token function">responses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// цпПф╕к batch хдДчРЖ</span>
              <span class="token class-name">TopicPartition</span> tp <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token class-name">ProduceResponse<span class="token punctuation">.</span>PartitionResponse</span> partResp <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token class-name">Errors</span> error <span class="token operator">=</span> <span class="token class-name">Errors</span><span class="token punctuation">.</span><span class="token function">forCode</span><span class="token punctuation">(</span>partResp<span class="token punctuation">.</span>errorCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token class-name">RecordBatch</span> batch <span class="token operator">=</span> batches<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tp<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">completeBatch</span><span class="token punctuation">(</span>batch<span class="token punctuation">,</span> error<span class="token punctuation">,</span> partResp<span class="token punctuation">.</span>baseOffset<span class="token punctuation">,</span> partResp<span class="token punctuation">.</span>timestamp<span class="token punctuation">,</span> correlationId<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>sensors<span class="token punctuation">.</span><span class="token function">recordLatency</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">destination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">requestLatencyMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>sensors<span class="token punctuation">.</span><span class="token function">recordThrottleTime</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">destination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                          produceResponse<span class="token punctuation">.</span><span class="token function">getThrottleTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// ack = 0</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RecordBatch</span> batch <span class="token operator">:</span> batches<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token function">completeBatch</span><span class="token punctuation">(</span>batch<span class="token punctuation">,</span> <span class="token class-name">Errors</span><span class="token punctuation">.</span><span class="token constant">NONE</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token class-name">Record</span><span class="token punctuation">.</span><span class="token constant">NO_TIMESTAMP</span><span class="token punctuation">,</span> correlationId<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// recordBatch хдДчРЖ</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">completeBatch</span><span class="token punctuation">(</span><span class="token class-name">RecordBatch</span> batch<span class="token punctuation">,</span> <span class="token class-name">Errors</span> error<span class="token punctuation">,</span> <span class="token keyword">long</span> baseOffset<span class="token punctuation">,</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token keyword">long</span> correlationId<span class="token punctuation">,</span> <span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> <span class="token class-name">Errors</span><span class="token punctuation">.</span><span class="token constant">NONE</span> <span class="token operator">&amp;&amp;</span> <span class="token function">canRetry</span><span class="token punctuation">(</span>batch<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// цЬЙх╝Вх╕╕ф╕ФхПпф╗ещЗНцЦ░хПСщАБ</span>
      <span class="token comment">// retry</span>
      log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Got error produce response with correlation id {} on topic-partition {}, retrying ({} attempts left). Error: {}&quot;</span><span class="token punctuation">,</span>
                correlationId<span class="token punctuation">,</span>
                batch<span class="token punctuation">.</span>topicPartition<span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>retries <span class="token operator">-</span> batch<span class="token punctuation">.</span>attempts <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
                error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// щЗНцЦ░хКахЕе ч╝УхЖ▓хМ║</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator<span class="token punctuation">.</span><span class="token function">reenqueue</span><span class="token punctuation">(</span>batch<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// цЧах╝Вх╕╕</span>
      <span class="token comment">// цЬЙх╝Вх╕╕ф╕Фф╕НхПпф╗ещЗНцЦ░хПСщАБ</span>
      <span class="token class-name">RuntimeException</span> exception<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">==</span> <span class="token class-name">Errors</span><span class="token punctuation">.</span><span class="token constant">TOPIC_AUTHORIZATION_FAILED</span><span class="token punctuation">)</span>
          exception <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TopicAuthorizationException</span><span class="token punctuation">(</span>batch<span class="token punctuation">.</span>topicPartition<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">else</span>
          exception <span class="token operator">=</span> error<span class="token punctuation">.</span><span class="token function">exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// record хЫЮш░ГхЗ╜цХ░</span>
      batch<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span>baseOffset<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// recordBatch хПСщАБч╗УцЭЯя╝МхЖЕхнШц▒ахЫЮцФ╢шпехЖЕхнШ</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator<span class="token punctuation">.</span><span class="token function">deallocate</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token comment">// record хЫЮш░Г producer.send(,callback)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">long</span> baseOffset<span class="token punctuation">,</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">RuntimeException</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// thunks = records</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>thunks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token class-name">Thunk</span> thunk <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>thunks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// If the timestamp returned by server is NoTimestamp, that means CreateTime is used. Otherwise LogAppendTime is used.</span>
              <span class="token class-name">RecordMetadata</span> metadata <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RecordMetadata</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>topicPartition<span class="token punctuation">,</span>  baseOffset<span class="token punctuation">,</span> thunk<span class="token punctuation">.</span>future<span class="token punctuation">.</span><span class="token function">relativeOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                            timestamp <span class="token operator">==</span> <span class="token class-name">Record</span><span class="token punctuation">.</span><span class="token constant">NO_TIMESTAMP</span> <span class="token operator">?</span> thunk<span class="token punctuation">.</span>future<span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> timestamp<span class="token punctuation">,</span>
                                                            thunk<span class="token punctuation">.</span>future<span class="token punctuation">.</span><span class="token function">checksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                            thunk<span class="token punctuation">.</span>future<span class="token punctuation">.</span><span class="token function">serializedKeySize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                            thunk<span class="token punctuation">.</span>future<span class="token punctuation">.</span><span class="token function">serializedValueSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// цЧах╝Вх╕╕цЧ╢ record хЫЮш░ГхЗ╜цХ░</span>
              thunk<span class="token punctuation">.</span>callback<span class="token punctuation">.</span><span class="token function">onCompletion</span><span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token comment">// цЬЙх╝Вх╕╕цЧ╢ record хЫЮш░ГхЗ╜цХ░</span>
              thunk<span class="token punctuation">.</span>callback<span class="token punctuation">.</span><span class="token function">onCompletion</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409181354231.jpeg" alt="img"></p> <h2 id="цА╗ч╗У"><a href="#цА╗ч╗У" class="header-anchor">#</a> цА╗ч╗У</h2> <h2 id="хПВшАГш╡ДцЦЩ"><a href="#хПВшАГш╡ДцЦЩ" class="header-anchor">#</a> хПВшАГш╡ДцЦЩ</h2> <ul><li><a href="https://vendanner.github.io/2018/04/15/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-Kafka-%E4%B9%8B-Producer/" target="_blank" rel="noopener noreferrer">ц╖▒хЕечРЖшзг Kafka ф╣Л Producer - щШ┐щгЮчЪДхНЪхов | Danner Blog (vendanner.github.io)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/echo-lxy/echo-system-design/edit/master/docs/02.Kafka  ч│╗ч╗Яшо╛шоб/06.ф╕ЙуАБф╕╗ч║┐ф╗╗хКб/05.чФЯф║зшАЕ.md" target="_blank" rel="noopener noreferrer">ч╝Цш╛С</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">ф╕КцмбцЫ┤цЦ░ф║О:</span> <span class="time">2024/09/18, 11:29:27</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        тЖР
        <a href="/echo-system-design/pages/46a58a/" class="prev">Kafka цХ┤ф╜УцЮ╢цЮД</a></span> <span class="next"><a href="/echo-system-design/pages/aa0392/">Broker</a>тЖТ
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:lixinyang2002@163.com" title="хПСщВоф╗╢" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/echo-lxy" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="хРмщЯ│ф╣Р" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="цЬмчлЩф╕╗щвШ">Vdoing</a> 
    | Copyright ┬й 2024-2024
    <span>Xinyang Li | MIT License</span></div> <div class="buttons"><div title="ш┐ФхЫЮщб╢щГи" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="хО╗шпДшо║" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ф╕╗щвШцибх╝П" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          ш╖ЯщЪПч│╗ч╗Я
        </li><li class="iconfont icon-rijianmoshi">
          ц╡ЕшЙ▓цибх╝П
        </li><li class="iconfont icon-yejianmoshi">
          ц╖▒шЙ▓цибх╝П
        </li><li class="iconfont icon-yuedu">
          щШЕшп╗цибх╝П
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/echo-system-design/assets/js/app.29ec2c17.js" defer></script><script src="/echo-system-design/assets/js/2.933750c6.js" defer></script><script src="/echo-system-design/assets/js/18.4e49fa9b.js" defer></script><script src="/echo-system-design/assets/js/7.7eb70372.js" defer></script>
  </body>
</html>
