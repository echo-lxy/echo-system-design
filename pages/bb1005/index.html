<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ç”Ÿäº§è€… | EchoDesign</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/echo-system-design/img/favicon.ico">
    <meta name="description" content="ç³»ç»Ÿè®¾è®¡ä¹‹ã€Œè®²è§£ + é¢è¯•æŒ‡å—ã€ï¼Œæ°´æ»´çŸ³ç©¿ï¼Œè®¾è®¡æ— é“¶å¼¹ï¼">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/echo-system-design/assets/css/0.styles.744b3760.css" as="style"><link rel="preload" href="/echo-system-design/assets/js/app.29ec2c17.js" as="script"><link rel="preload" href="/echo-system-design/assets/js/2.933750c6.js" as="script"><link rel="preload" href="/echo-system-design/assets/js/18.4e49fa9b.js" as="script"><link rel="preload" href="/echo-system-design/assets/js/7.7eb70372.js" as="script"><link rel="prefetch" href="/echo-system-design/assets/js/10.2cc95be8.js"><link rel="prefetch" href="/echo-system-design/assets/js/100.2b21dce5.js"><link rel="prefetch" href="/echo-system-design/assets/js/101.09d5e594.js"><link rel="prefetch" href="/echo-system-design/assets/js/11.ddc7ccf4.js"><link rel="prefetch" href="/echo-system-design/assets/js/12.915fdd22.js"><link rel="prefetch" href="/echo-system-design/assets/js/13.d9d26d25.js"><link rel="prefetch" href="/echo-system-design/assets/js/14.ae63dfd6.js"><link rel="prefetch" href="/echo-system-design/assets/js/15.d5a34c66.js"><link rel="prefetch" href="/echo-system-design/assets/js/16.5a9b32ee.js"><link rel="prefetch" href="/echo-system-design/assets/js/17.bad7d194.js"><link rel="prefetch" href="/echo-system-design/assets/js/19.daf31819.js"><link rel="prefetch" href="/echo-system-design/assets/js/20.cb4a5c13.js"><link rel="prefetch" href="/echo-system-design/assets/js/21.24c0f101.js"><link rel="prefetch" href="/echo-system-design/assets/js/22.dd779f94.js"><link rel="prefetch" href="/echo-system-design/assets/js/23.4d814163.js"><link rel="prefetch" href="/echo-system-design/assets/js/24.891fe6fb.js"><link rel="prefetch" href="/echo-system-design/assets/js/25.41dca26b.js"><link rel="prefetch" href="/echo-system-design/assets/js/26.6337eac0.js"><link rel="prefetch" href="/echo-system-design/assets/js/27.97a0cc13.js"><link rel="prefetch" href="/echo-system-design/assets/js/28.95a1fb6b.js"><link rel="prefetch" href="/echo-system-design/assets/js/29.2b39f61a.js"><link rel="prefetch" href="/echo-system-design/assets/js/3.5c09ac9d.js"><link rel="prefetch" href="/echo-system-design/assets/js/30.e32f6b31.js"><link rel="prefetch" href="/echo-system-design/assets/js/31.a532917f.js"><link rel="prefetch" href="/echo-system-design/assets/js/32.13b70e91.js"><link rel="prefetch" href="/echo-system-design/assets/js/33.d10d51bb.js"><link rel="prefetch" href="/echo-system-design/assets/js/34.6671ead6.js"><link rel="prefetch" href="/echo-system-design/assets/js/35.2760ed8d.js"><link rel="prefetch" href="/echo-system-design/assets/js/36.be98cc35.js"><link rel="prefetch" href="/echo-system-design/assets/js/37.82be3556.js"><link rel="prefetch" href="/echo-system-design/assets/js/38.40fe2658.js"><link rel="prefetch" href="/echo-system-design/assets/js/39.84b6e82e.js"><link rel="prefetch" href="/echo-system-design/assets/js/4.73518a0f.js"><link rel="prefetch" href="/echo-system-design/assets/js/40.591baf2a.js"><link rel="prefetch" href="/echo-system-design/assets/js/41.f961e422.js"><link rel="prefetch" href="/echo-system-design/assets/js/42.8046590d.js"><link rel="prefetch" href="/echo-system-design/assets/js/43.d1865983.js"><link rel="prefetch" href="/echo-system-design/assets/js/44.abab45ac.js"><link rel="prefetch" href="/echo-system-design/assets/js/45.685623ac.js"><link rel="prefetch" href="/echo-system-design/assets/js/46.7624d38c.js"><link rel="prefetch" href="/echo-system-design/assets/js/47.5646b068.js"><link rel="prefetch" href="/echo-system-design/assets/js/48.a1b270df.js"><link rel="prefetch" href="/echo-system-design/assets/js/49.ee9681bc.js"><link rel="prefetch" href="/echo-system-design/assets/js/5.94727770.js"><link rel="prefetch" href="/echo-system-design/assets/js/50.b424b2c0.js"><link rel="prefetch" href="/echo-system-design/assets/js/51.98ad3d82.js"><link rel="prefetch" href="/echo-system-design/assets/js/52.2bb763f1.js"><link rel="prefetch" href="/echo-system-design/assets/js/53.f76e624c.js"><link rel="prefetch" href="/echo-system-design/assets/js/54.3098ec9f.js"><link rel="prefetch" href="/echo-system-design/assets/js/55.01c7393b.js"><link rel="prefetch" href="/echo-system-design/assets/js/56.13fd4db7.js"><link rel="prefetch" href="/echo-system-design/assets/js/57.6175a0b4.js"><link rel="prefetch" href="/echo-system-design/assets/js/58.24008d78.js"><link rel="prefetch" href="/echo-system-design/assets/js/59.7b7e3faf.js"><link rel="prefetch" href="/echo-system-design/assets/js/6.0b558b79.js"><link rel="prefetch" href="/echo-system-design/assets/js/60.cf282dab.js"><link rel="prefetch" href="/echo-system-design/assets/js/61.11238a6f.js"><link rel="prefetch" href="/echo-system-design/assets/js/62.cc8fdced.js"><link rel="prefetch" href="/echo-system-design/assets/js/63.55fc09a9.js"><link rel="prefetch" href="/echo-system-design/assets/js/64.9b3def35.js"><link rel="prefetch" href="/echo-system-design/assets/js/65.0b2ab47d.js"><link rel="prefetch" href="/echo-system-design/assets/js/66.2ae7a107.js"><link rel="prefetch" href="/echo-system-design/assets/js/67.8e1dbb45.js"><link rel="prefetch" href="/echo-system-design/assets/js/68.cab1ea3b.js"><link rel="prefetch" href="/echo-system-design/assets/js/69.5f61d937.js"><link rel="prefetch" href="/echo-system-design/assets/js/70.b920a5f7.js"><link rel="prefetch" href="/echo-system-design/assets/js/71.c3c29d34.js"><link rel="prefetch" href="/echo-system-design/assets/js/72.44c999da.js"><link rel="prefetch" href="/echo-system-design/assets/js/73.526febf1.js"><link rel="prefetch" href="/echo-system-design/assets/js/74.26f8d9a5.js"><link rel="prefetch" href="/echo-system-design/assets/js/75.dc7fdd0f.js"><link rel="prefetch" href="/echo-system-design/assets/js/76.32858593.js"><link rel="prefetch" href="/echo-system-design/assets/js/77.7b3f6980.js"><link rel="prefetch" href="/echo-system-design/assets/js/78.09407d20.js"><link rel="prefetch" href="/echo-system-design/assets/js/79.a0d29bfa.js"><link rel="prefetch" href="/echo-system-design/assets/js/8.0ec7f6e8.js"><link rel="prefetch" href="/echo-system-design/assets/js/80.ddcb5191.js"><link rel="prefetch" href="/echo-system-design/assets/js/81.d124398a.js"><link rel="prefetch" href="/echo-system-design/assets/js/82.3b90a7cc.js"><link rel="prefetch" href="/echo-system-design/assets/js/83.f3a9ee0c.js"><link rel="prefetch" href="/echo-system-design/assets/js/84.eeb423e8.js"><link rel="prefetch" href="/echo-system-design/assets/js/85.4cd3a775.js"><link rel="prefetch" href="/echo-system-design/assets/js/86.931cbb70.js"><link rel="prefetch" href="/echo-system-design/assets/js/87.47ba635a.js"><link rel="prefetch" href="/echo-system-design/assets/js/88.93192130.js"><link rel="prefetch" href="/echo-system-design/assets/js/89.b5690031.js"><link rel="prefetch" href="/echo-system-design/assets/js/9.6e274fca.js"><link rel="prefetch" href="/echo-system-design/assets/js/90.cdc8eb8f.js"><link rel="prefetch" href="/echo-system-design/assets/js/91.8ad18b18.js"><link rel="prefetch" href="/echo-system-design/assets/js/92.ec3a28ed.js"><link rel="prefetch" href="/echo-system-design/assets/js/93.f8975bc4.js"><link rel="prefetch" href="/echo-system-design/assets/js/94.1eade7f0.js"><link rel="prefetch" href="/echo-system-design/assets/js/95.40b14cb6.js"><link rel="prefetch" href="/echo-system-design/assets/js/96.15d8e4f1.js"><link rel="prefetch" href="/echo-system-design/assets/js/97.280e8dd8.js"><link rel="prefetch" href="/echo-system-design/assets/js/98.b46fd254.js"><link rel="prefetch" href="/echo-system-design/assets/js/99.d1ca4fc0.js">
    <link rel="stylesheet" href="/echo-system-design/assets/css/0.styles.744b3760.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="ç›®å½•" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/echo-system-design/" class="home-link router-link-active"><img src="/echo-system-design/img/logo.png" alt="EchoDesign" class="logo"> <span class="site-name can-hide">EchoDesign</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/echo-system-design/" class="nav-link">ğŸ é¦–é¡µ</a></div><div class="nav-item"><a href="/echo-system-design/pages/fccd91/" class="nav-link">âœ’ï¸çƒ­é—¨ç®—æ³•</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ğŸ–ï¸èµæç»å…¸è®¾è®¡" class="dropdown-title"><!----> <span class="title" style="display:;">ğŸ–ï¸èµæç»å…¸è®¾è®¡</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/echo-system-design/pages/252196/" class="nav-link">Redis ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/echo-system-design/pages/b9733b/" class="nav-link">Kafka ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/echo-system-design/pages/bfab10/" class="nav-link">Netty ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/echo-system-design/pages/4601ca/" class="nav-link">Nginx ç³»ç»Ÿè®¾è®¡</a></li></ul></div></div><div class="nav-item"><a href="/echo-system-design/pages/84cb49/" class="nav-link">ğŸ§‘â€ğŸ’»å®æˆ˜ç³»ç»Ÿè®¾è®¡</a></div><div class="nav-item"><a href="/echo-system-design/pages/92b2ee/" class="nav-link">â“é—®ç­”</a></div><div class="nav-item"><a href="/echo-system-design/pages/52ebd8/" class="nav-link">ğŸ‘€åŠ¨æ€</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/echo-system-design/" class="nav-link">ğŸ é¦–é¡µ</a></div><div class="nav-item"><a href="/echo-system-design/pages/fccd91/" class="nav-link">âœ’ï¸çƒ­é—¨ç®—æ³•</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ğŸ–ï¸èµæç»å…¸è®¾è®¡" class="dropdown-title"><!----> <span class="title" style="display:;">ğŸ–ï¸èµæç»å…¸è®¾è®¡</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/echo-system-design/pages/252196/" class="nav-link">Redis ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/echo-system-design/pages/b9733b/" class="nav-link">Kafka ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/echo-system-design/pages/bfab10/" class="nav-link">Netty ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/echo-system-design/pages/4601ca/" class="nav-link">Nginx ç³»ç»Ÿè®¾è®¡</a></li></ul></div></div><div class="nav-item"><a href="/echo-system-design/pages/84cb49/" class="nav-link">ğŸ§‘â€ğŸ’»å®æˆ˜ç³»ç»Ÿè®¾è®¡</a></div><div class="nav-item"><a href="/echo-system-design/pages/92b2ee/" class="nav-link">â“é—®ç­”</a></div><div class="nav-item"><a href="/echo-system-design/pages/52ebd8/" class="nav-link">ğŸ‘€åŠ¨æ€</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ä¸€ã€å‰è¨€</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>ä¸‰ã€ä¸»çº¿ä»»åŠ¡</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/echo-system-design/pages/46a58a/" class="sidebar-link">Kafka æ•´ä½“æ¶æ„</a></li><li><a href="/echo-system-design/pages/bb1005/" aria-current="page" class="active sidebar-link">ç”Ÿäº§è€…</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/echo-system-design/pages/bb1005/#å‰è¨€" class="sidebar-link">å‰è¨€</a></li><li class="sidebar-sub-header level2"><a href="/echo-system-design/pages/bb1005/#æ•´ä½“æµç¨‹" class="sidebar-link">æ•´ä½“æµç¨‹</a></li><li class="sidebar-sub-header level2"><a href="/echo-system-design/pages/bb1005/#ä¸»çº¿ç¨‹" class="sidebar-link">ä¸»çº¿ç¨‹</a></li><li class="sidebar-sub-header level2"><a href="/echo-system-design/pages/bb1005/#sender-çº¿ç¨‹" class="sidebar-link">Sender çº¿ç¨‹</a></li><li class="sidebar-sub-header level2"><a href="/echo-system-design/pages/bb1005/#æ€»ç»“" class="sidebar-link">æ€»ç»“</a></li><li class="sidebar-sub-header level2"><a href="/echo-system-design/pages/bb1005/#å‚è€ƒèµ„æ–™" class="sidebar-link">å‚è€ƒèµ„æ–™</a></li></ul></li><li><a href="/echo-system-design/pages/aa0392/" class="sidebar-link">Broker</a></li><li><a href="/echo-system-design/pages/ca141b/" class="sidebar-link">æ¶ˆè´¹è€…</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>ã€Œç”Ÿäº§è€…ã€æºç åˆ†æ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>ã€Œæ¶ˆè´¹è€…ã€æºç åˆ†æ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>ã€ŒBrokerã€åŸç†åˆ†æ</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>å››ã€è®¾è®¡ç›®æ ‡</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/echo-system-design/" title="é¦–é¡µ" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>Kafka  ç³»ç»Ÿè®¾è®¡</span></li><li data-v-06225672><span data-v-06225672>ä¸‰ã€ä¸»çº¿ä»»åŠ¡</span></li></ul> <div class="info" data-v-06225672><div title="ä½œè€…" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/brother-one" target="_blank" title="ä½œè€…" class="beLink" data-v-06225672>echo</a></div> <div title="åˆ›å»ºæ—¶é—´" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-09-18</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">ç›®å½•</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">ç”Ÿäº§è€…<!----></h1> <div class="page-slot page-slot-top">
    <div class="wwads-cn wwads-horizontal page-wwads" data-id="136"></div>
    <style>
      .page-wwads{
        width:100%!important;
        min-height: 0;
        margin: 0;
      }
      .page-wwads .wwads-img img{
        width:80px!important;
      }
      .page-wwads .wwads-poweredby{
        width: 40px;
        position: absolute;
        right: 25px;
        bottom: 3px;
      }
      .wwads-content .wwads-text, .page-wwads .wwads-text{
        height: 100%;
        padding-top: 5px;
        display: block;
      }
  </style>
  </div> <div class="theme-vdoing-content content__default"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="header-anchor">#</a> å‰è¨€</h2> <h2 id="æ•´ä½“æµç¨‹"><a href="#æ•´ä½“æµç¨‹" class="header-anchor">#</a> æ•´ä½“æµç¨‹</h2> <ol><li>msg å°è£…æˆ ProducerRecord</li> <li>æ‹¦æˆªå™¨</li> <li>Record åºåˆ—åŒ–</li> <li>ç¬¬ä¸€æ¬¡å‘é€æ—¶å…ˆè·å– kafka é›†ç¾¤å…ƒæ•°æ®</li> <li>Record æ ¹æ®å…ƒæ•°æ®å¾—åˆ°è¦å‘é€åˆ° topic çš„åˆ†åŒº</li> <li>Record æ·»åŠ åˆ° <code>RecordAccumulator</code> ç¼“å†²åŒº(æ¯ä¸ªåˆ†åŒºéƒ½æœ‰ç‹¬ç«‹çš„ç¼“å†²é˜Ÿåˆ—)</li> <li>Sender çº¿ç¨‹ä» <code>RecordAccumulator</code> è·å– batch record å‘é€åˆ° Broker</li></ol> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409181252125.png" alt="image-20240918124411636"></p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// org.apache.kafka.clients.producer.KafkaProducer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Producer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token comment">// åˆ†åŒºå™¨ï¼Œå¯ä»¥è‡ªå®šä¹‰</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Partitioner</span> partitioner<span class="token punctuation">;</span>
  <span class="token comment">// kafka é›†ç¾¤å…ƒæ•°æ®</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Metadata</span> metadata<span class="token punctuation">;</span>
  <span class="token comment">// ç¼“å†²åŒº</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RecordAccumulator</span> accumulator<span class="token punctuation">;</span>
  <span class="token comment">// å‘é€çº¿ç¨‹</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Sender</span> sender<span class="token punctuation">;</span>
  <span class="token comment">// æ­¥éª¤ä¸€ï¼šå°è£…æˆ ProducerRecord</span>
  <span class="token keyword">public</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RecordMetadata</span><span class="token punctuation">&gt;</span></span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">,</span> <span class="token class-name">Callback</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// intercept the record, which can be potentially modified; this method does not throw exceptions</span>
      <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> interceptedRecord <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> record <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span><span class="token function">onSend</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">doSend</span><span class="token punctuation">(</span>interceptedRecord<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RecordMetadata</span><span class="token punctuation">&gt;</span></span> <span class="token function">doSend</span><span class="token punctuation">(</span><span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">,</span> <span class="token class-name">Callback</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">TopicPartition</span> tp <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token comment">// ç¬¬ä¸€æ¬¡å‘é€æ•°æ®æ—¶ï¼Œå…ˆç¡®ä¿å·²ç»æœ‰ kafka metadata</span>
          <span class="token class-name">ClusterAndWaitTime</span> clusterAndWaitTime <span class="token operator">=</span> <span class="token function">waitOnMetadata</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> maxBlockTimeMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// maxBlockTimeMs é»˜è®¤ 60s</span>
          <span class="token keyword">long</span> remainingWaitMs <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> maxBlockTimeMs <span class="token operator">-</span> clusterAndWaitTime<span class="token punctuation">.</span>waitedOnMetadataMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token class-name">Cluster</span> cluster <span class="token operator">=</span> clusterAndWaitTime<span class="token punctuation">.</span>cluster<span class="token punctuation">;</span>
          <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> serializedKey<span class="token punctuation">;</span>
          <span class="token comment">// æ­¥éª¤äºŒï¼šåºåˆ—åŒ–</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
              serializedKey <span class="token operator">=</span> keySerializer<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> 
          <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> serializedValue<span class="token punctuation">;</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
              serializedValue <span class="token operator">=</span> valueSerializer<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> 

          <span class="token comment">// æ­¥éª¤ä¸‰ï¼šè·å–åˆ†åŒº</span>
          <span class="token keyword">int</span> partition <span class="token operator">=</span> <span class="token function">partition</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> serializedKey<span class="token punctuation">,</span> serializedValue<span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">int</span> serializedSize <span class="token operator">=</span> <span class="token class-name">Records</span><span class="token punctuation">.</span><span class="token constant">LOG_OVERHEAD</span> <span class="token operator">+</span> <span class="token class-name">Record</span><span class="token punctuation">.</span><span class="token function">recordSize</span><span class="token punctuation">(</span>serializedKey<span class="token punctuation">,</span> serializedValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">ensureValidRecordSize</span><span class="token punctuation">(</span>serializedSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
          tp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TopicPartition</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partition<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
          <span class="token comment">// æ­¥éª¤å››ï¼šrecord æ·»åŠ åˆ° accumulator ç¼“å­˜</span>
          <span class="token class-name">RecordAccumulator<span class="token punctuation">.</span>RecordAppendResult</span> result <span class="token operator">=</span> accumulator<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>tp<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> serializedKey<span class="token punctuation">,</span> serializedValue<span class="token punctuation">,</span> interceptCallback<span class="token punctuation">,</span> remainingWaitMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>batchIsFull <span class="token operator">||</span> result<span class="token punctuation">.</span>newBatchCreated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Waking up the sender since topic {} partition {} is either full or getting a new batch&quot;</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partition<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// æ»¡è¶³ batch å‘é€æ¡ä»¶ï¼Œå”¤é†’ sender å‘é€æ•°æ®</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">return</span> result<span class="token punctuation">.</span>future<span class="token punctuation">;</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="ä¸»çº¿ç¨‹"><a href="#ä¸»çº¿ç¨‹" class="header-anchor">#</a> ä¸»çº¿ç¨‹</h2> <h3 id="åˆå§‹åŒ–ä¸å‚æ•°é…ç½®"><a href="#åˆå§‹åŒ–ä¸å‚æ•°é…ç½®" class="header-anchor">#</a> åˆå§‹åŒ–ä¸å‚æ•°é…ç½®</h3> <p>åœ¨ Kafka ç”Ÿäº§è€…çš„åˆå§‹åŒ–é˜¶æ®µï¼Œä¸»çº¿ç¨‹ä¸»è¦è´Ÿè´£å¯¹ç”Ÿäº§è€…çš„å„ä¸ªç»„ä»¶è¿›è¡Œé…ç½®ä¸åˆå§‹åŒ–ã€‚ä¸»è¦æ¶‰åŠçš„å‚æ•°åŒ…æ‹¬ï¼š</p> <ul><li><code>bootstrap.servers</code>ï¼šKafka é›†ç¾¤çš„åœ°å€ã€‚</li> <li><code>key.serializer</code> å’Œ <code>value.serializer</code>ï¼šæ¶ˆæ¯çš„é”®å’Œå€¼çš„åºåˆ—åŒ–æ–¹å¼ã€‚</li> <li><code>acks</code>ï¼šæ§åˆ¶æ¶ˆæ¯ç¡®è®¤çš„æ–¹å¼ï¼Œå†³å®šæ¶ˆæ¯çš„å¯é æ€§å’Œå»¶è¿Ÿä¹‹é—´çš„å¹³è¡¡ã€‚</li> <li><code>retries</code>ï¼šé‡è¯•æ¬¡æ•°ï¼Œåœ¨æ¶ˆæ¯å‘é€å¤±è´¥æ—¶ç”¨äºæ§åˆ¶é‡è¯•æœºåˆ¶ã€‚</li> <li><code>batch.size</code>ï¼šæ¶ˆæ¯æ‰¹æ¬¡å¤§å°ï¼Œå½±å“æ¶ˆæ¯çš„ç´¯ç§¯å’Œå‘é€é¢‘ç‡ã€‚</li></ul> <p>è¿™äº›å‚æ•°ç›´æ¥å½±å“ Kafka ç”Ÿäº§è€…çš„ååé‡ã€å¯é æ€§å’Œå»¶è¿Ÿï¼Œæ˜¯æ€§èƒ½ä¼˜åŒ–çš„é‡ç‚¹ã€‚</p> <h3 id="kafkaproducer"><a href="#kafkaproducer" class="header-anchor">#</a> KafkaProducer</h3> <p><code>KafkaProducer</code> ç±»æ˜¯ Kafka ç”Ÿäº§è€…çš„æ ¸å¿ƒç±»ï¼Œå®ƒå®ç°äº† Java çš„ <code>AutoCloseable</code> æ¥å£ï¼Œè´Ÿè´£ç®¡ç†æ¶ˆæ¯å‘é€çš„ç”Ÿå‘½å‘¨æœŸã€‚å…¶ä¸»è¦èŒè´£åŒ…æ‹¬ï¼š</p> <ul><li><strong>åˆå§‹åŒ–</strong>ï¼šåˆå§‹åŒ–ç”Ÿäº§è€…ç›¸å…³çš„æ‹¦æˆªå™¨ã€åºåˆ—åŒ–å™¨ã€ç´¯åŠ å™¨ã€Sender çº¿ç¨‹ç­‰ç»„ä»¶ã€‚</li> <li><strong>æ¶ˆæ¯å‘é€</strong>ï¼šæä¾› <code>send()</code> æ–¹æ³•ï¼Œç”¨äºå‘é€æ¶ˆæ¯ã€‚å®ƒå°†æ¶ˆæ¯å°è£…ä¸º <code>ProducerRecord</code> å¯¹è±¡ï¼Œäº¤ç”±åç»­æ¨¡å—è¿›è¡Œå¤„ç†ã€‚</li></ul> <p><code>KafkaProducer</code> çš„çº¿ç¨‹å®‰å…¨æ€§å’Œé«˜æ•ˆçš„èµ„æºç®¡ç†ä½¿å…¶åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹èƒ½å¤Ÿä¿æŒè‰¯å¥½çš„æ€§èƒ½ã€‚</p> <h3 id="producerinterceptor"><a href="#producerinterceptor" class="header-anchor">#</a> ProducerInterceptor</h3> <p><code>ProducerInterceptor</code> ä¸»è¦ç”¨äºåœ¨æ¶ˆæ¯å‘é€å‰åè¿›è¡Œæ‹¦æˆªå’Œå¤„ç†ï¼Œå¸¸ç”¨äºå®ç°æ—¥å¿—è®°å½•ã€ç»Ÿè®¡å’Œè‡ªå®šä¹‰é€»è¾‘ã€‚Kafka ç”Ÿäº§è€…å…è®¸é…ç½®å¤šä¸ªæ‹¦æˆªå™¨ï¼Œå®ƒä»¬æŒ‰é¡ºåºæ‰§è¡Œã€‚</p> <p>æ‹¦æˆªå™¨çš„å…¸å‹åº”ç”¨åœºæ™¯åŒ…æ‹¬ï¼š</p> <ul><li>ä¿®æ”¹æ¶ˆæ¯å†…å®¹ï¼šä¾‹å¦‚ç»™æ¶ˆæ¯æ·»åŠ å…ƒæ•°æ®ã€‚</li> <li>ç›‘æ§ä¸ç»Ÿè®¡ï¼šå¯ä»¥ç»Ÿè®¡æ¯æ¡æ¶ˆæ¯çš„å‘é€æ—¶é—´æˆ–å‘é€çŠ¶æ€ã€‚</li></ul> <div class="language-c extra-class"><pre class="language-c"><code>public class CustomProducerInterceptor implements ProducerInterceptor<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    @Override
    public ProducerRecord<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span> <span class="token function">onSend</span><span class="token punctuation">(</span>ProducerRecord<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¯ä»¥åœ¨æ­¤å¤„ä¿®æ”¹æ¶ˆæ¯æˆ–æ·»åŠ è‡ªå®šä¹‰é€»è¾‘</span>
        <span class="token keyword">return</span> record<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Override
    public <span class="token keyword">void</span> <span class="token function">onAcknowledgement</span><span class="token punctuation">(</span>RecordMetadata metadata<span class="token punctuation">,</span> Exception exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¯ä»¥åœ¨æ­¤å¤„å¤„ç†æ¶ˆæ¯å‘é€æˆåŠŸæˆ–å¤±è´¥çš„é€»è¾‘</span>
    <span class="token punctuation">}</span>

    @Override
    public <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    @Override
    public <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span>Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">&gt;</span> configs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="serializer"><a href="#serializer" class="header-anchor">#</a> Serializer</h3> <p>Kafka ç”Ÿäº§è€…ä¸­çš„åºåˆ—åŒ–å™¨è´Ÿè´£å°† Java å¯¹è±¡è½¬åŒ–ä¸ºå­—èŠ‚æ•°ç»„ï¼Œä»¥ä¾¿é€šè¿‡ç½‘ç»œå‘é€ã€‚Kafka å†…ç½®äº†å‡ ç§å¸¸è§çš„åºåˆ—åŒ–å™¨ï¼Œä¾‹å¦‚ <code>StringSerializer</code> å’Œ <code>ByteArraySerializer</code>ï¼Œä¹Ÿæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰åºåˆ—åŒ–å™¨ã€‚</p> <p>å¯¹äºè‡ªå®šä¹‰å¯¹è±¡ï¼Œéœ€è¦å®ç° <code>Serializer</code> æ¥å£ï¼š</p> <div class="language-c extra-class"><pre class="language-c"><code>public class CustomSerializer implements Serializer<span class="token operator">&lt;</span>MyObject<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    @Override
    public byte<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">serialize</span><span class="token punctuation">(</span>String topic<span class="token punctuation">,</span> MyObject data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å°†è‡ªå®šä¹‰å¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„</span>
        <span class="token keyword">return</span> SerializationUtils<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Override
    public <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è‰¯å¥½çš„åºåˆ—åŒ–å™¨è®¾è®¡ä¸ä»…èƒ½ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œè¿˜èƒ½ä¼˜åŒ–ä¼ è¾“æ€§èƒ½ã€‚</p> <h3 id="å…ƒæ•°æ®"><a href="#å…ƒæ•°æ®" class="header-anchor">#</a> å…ƒæ•°æ®</h3> <p>Client éœ€è¦ä» Broker èŠ‚ç‚¹è·å– Topic çš„å…ƒæ•°æ®ï¼Œæ‰çŸ¥é“å°†å½“å‰ Record å‘é€å“ªä¸ªåˆ†åŒº</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// org.apache.kafka.clients.producer.KafkaProducer</span>
<span class="token keyword">private</span> <span class="token class-name">ClusterAndWaitTime</span> <span class="token function">waitOnMetadata</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Integer</span> partition<span class="token punctuation">,</span> <span class="token keyword">long</span> maxWaitMs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ·»åŠ è¦è·å–å…ƒæ•°æ®çš„ topicï¼ŒMap ç»“æ„</span>
    metadata<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Cluster</span> cluster <span class="token operator">=</span> metadata<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Integer</span> partitionsCount <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">partitionCountForTopic</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœå·²ç»æœ‰å…ƒæ•°æ®ï¼Œç›´æ¥è¿”å›</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>partitionsCount <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>partition <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> partition <span class="token operator">&lt;</span> partitionsCount<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ClusterAndWaitTime</span><span class="token punctuation">(</span>cluster<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ­»å¾ªç¯ä¸€ç›´åˆ°è·å–å…ƒæ•°æ®/è¶…æ—¶</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> version <span class="token operator">=</span> metadata<span class="token punctuation">.</span><span class="token function">requestUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å”¤é†’ sender çº¿ç¨‹å»è·å–</span>
        sender<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// wait ç›´åˆ° sender è·å–åˆ°å…ƒæ•°æ®åå”¤é†’</span>
            <span class="token comment">// æˆ–è€…è¶…æ—¶</span>
            metadata<span class="token punctuation">.</span><span class="token function">awaitUpdate</span><span class="token punctuation">(</span>version<span class="token punctuation">,</span> remainingWaitMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>partitionsCount <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ClusterAndWaitTime</span><span class="token punctuation">(</span>cluster<span class="token punctuation">,</span> elapsed<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* * Sender.run(this.client.poll(pollTimeout, now);) * NetworkClient.poll -&gt; NetworkClient.handleCompletedReceives * metadataUpdater.maybeUpdate -&gt; NetworkClient.maybeHandleCompletedReceive * metadataRequest = new MetadataRequest(new ArrayList&lt;&gt;(metadata.topics())); // åªè·å– metadata ä¸­ topic * NetworkClient.handleResponse -&gt; MetaData.update */</span>
<span class="token comment">// org.apache.kafka.clients.Metadata</span>
<span class="token comment">// kafka å…ƒæ•°æ®ç»“æ„</span>
<span class="token keyword">private</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Cluster</span> cluster<span class="token punctuation">,</span> <span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>topicExpiryEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Handle expiry of topics from the metadata refresh set.</span>
    <span class="token comment">// ç§»é™¤ TOPIC_EXPIRY_MS(5åˆ†é’Ÿ) æ—¶é—´æ®µå†…æ²¡æœ‰å‘é€æ•°æ®çš„ topic</span>
    <span class="token comment">// ä¸‹æ¬¡è·å–å…ƒæ•°æ®æ—¶å°±ä¸è·å–æ­¤ topic å…ƒæ•°æ®</span>
    <span class="token comment">// è·å–å…ƒæ•°æ®çš„æ¡ä»¶ï¼šcluster å…ƒæ•°æ®ä¸­æ²¡æœ‰éœ€è¦ topic çš„ä¿¡æ¯</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> it <span class="token operator">=</span> topics<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">long</span> expireMs <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>expireMs <span class="token operator">==</span> <span class="token constant">TOPIC_EXPIRY_NEEDS_UPDATE</span><span class="token punctuation">)</span>
          entry<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>now <span class="token operator">+</span> <span class="token constant">TOPIC_EXPIRY_MS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>expireMs <span class="token operator">&lt;=</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// å½“å‰ topic è¿‡æœŸï¼Œç§»é™¤</span>
          it<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Removing unused topic {} from the metadata list, expiryMs {} now {}&quot;</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> expireMs<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// æ›´æ–°å…ƒæ•°æ®</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>cluster <span class="token operator">=</span> cluster<span class="token punctuation">;</span>
  <span class="token comment">// å”¤é†’ metadata</span>
  <span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409181346231.jpeg" alt="img"></p> <h3 id="partitioner"><a href="#partitioner" class="header-anchor">#</a> Partitioner</h3> <p><code>Partitioner</code> å†³å®šæ¶ˆæ¯è¢«å‘é€åˆ° Kafka é›†ç¾¤ä¸­å“ªä¸ªåˆ†åŒºã€‚Kafka é»˜è®¤çš„åˆ†åŒºç­–ç•¥æ˜¯åŸºäºæ¶ˆæ¯çš„é”®ï¼ˆ<code>key</code>ï¼‰è¿›è¡Œå“ˆå¸Œåˆ†åŒºï¼Œä½†ä¹Ÿå¯ä»¥é€šè¿‡å®ç°è‡ªå®šä¹‰ <code>Partitioner</code> æ¥å®ç°å¤æ‚çš„åˆ†åŒºé€»è¾‘ã€‚</p> <p>å…¸å‹çš„åœºæ™¯åŒ…æ‹¬ï¼š</p> <ul><li>ä¿è¯ç›¸åŒ key çš„æ¶ˆæ¯è¢«è·¯ç”±åˆ°åŒä¸€åˆ†åŒºï¼Œç¡®ä¿æ¶ˆæ¯çš„é¡ºåºæ€§ã€‚</li> <li>æ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼Œå®ç°ç‰¹å®šåˆ†åŒºç­–ç•¥ï¼Œä¾‹å¦‚å°† VIP ç”¨æˆ·çš„æ¶ˆæ¯å‘é€åˆ°ç‰¹å®šåˆ†åŒºä»¥ä¾¿ä¼˜å…ˆå¤„ç†ã€‚</li></ul> <p>è‡ªå®šä¹‰ <code>Partitioner</code> ç¤ºä¾‹ï¼š</p> <div class="language-c extra-class"><pre class="language-c"><code>public class CustomPartitioner implements Partitioner <span class="token punctuation">{</span>
    @Override
    public <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span>String topic<span class="token punctuation">,</span> Object key<span class="token punctuation">,</span> byte<span class="token punctuation">[</span><span class="token punctuation">]</span> keyBytes<span class="token punctuation">,</span> Object value<span class="token punctuation">,</span> byte<span class="token punctuation">[</span><span class="token punctuation">]</span> valueBytes<span class="token punctuation">,</span> Cluster cluster<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥ï¼šæ ¹æ® key çš„å“ˆå¸Œå€¼å†³å®šåˆ†åŒº</span>
        List<span class="token operator">&lt;</span>PartitionInfo<span class="token operator">&gt;</span> partitions <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">partitionsForTopic</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> numPartitions <span class="token operator">=</span> partitions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span> <span class="token operator">%</span> numPartitions<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Override
    public <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    @Override
    public <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span>Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">&gt;</span> configs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="recordaccumulator"><a href="#recordaccumulator" class="header-anchor">#</a> RecordAccumulator</h3> <ul><li>RecordAccumulator ä¸»è¦ç”¨æ¥ç¼“å­˜æ¶ˆæ¯ä»¥ä¾¿ Sender çº¿ç¨‹å¯ä»¥æ‰¹é‡å‘é€ï¼Œè¿›è€Œå‡å°‘ç½‘ç»œä¼ è¾“çš„èµ„æºæ¶ˆè€—ä»¥æå‡æ€§</li> <li>RecordAccumulatorç¼“å­˜çš„å¤§å°å¯ä»¥é€šè¿‡ç”Ÿäº§è€…å®¢æˆ·ç«¯å‚æ•°<code>buffer.memory</code>é…ç½®ï¼Œé»˜è®¤å€¼ä¸º 33554432Bï¼Œå³ 32MB</li> <li>å¦‚æœç”Ÿäº§è€…å‘é€æ¶ˆæ¯çš„é€Ÿåº¦è¶…è¿‡å‘é€åˆ°æœåŠ¡å™¨çš„é€Ÿåº¦ï¼Œåˆ™ä¼šå¯¼è‡´ç”Ÿäº§è€…ç©ºé—´ä¸è¶³ï¼Œè¿™ä¸ªæ—¶å€™ KafkaProducer çš„ <code>send()</code> æ–¹æ³•è°ƒç”¨è¦ä¹ˆè¢«é˜»å¡ï¼Œè¦ä¹ˆæŠ›å‡ºå¼‚å¸¸ï¼Œè¿™ä¸ªå–å†³äºå‚æ•°<code>max.block.ms</code> çš„é…ç½®ï¼Œæ­¤å‚æ•°çš„é»˜è®¤å€¼ä¸º 60000,å³ 60 ç§’ã€‚</li> <li>ä¸»çº¿ç¨‹ä¸­å‘é€è¿‡æ¥çš„æ¶ˆæ¯éƒ½ä¼šè¢«è¿½åŠ åˆ° RecordAccumulator çš„æŸä¸ª<strong>åŒç«¯é˜Ÿåˆ—</strong>ä¸­ï¼Œåœ¨ Recordccumulator çš„å†…éƒ¨ä¸ºæ¯ä¸ªåˆ†åŒºéƒ½ç»´æŠ¤äº†ä¸€ä¸ªåŒç«¯é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—ä¸­çš„å†…å®¹å°±æ˜¯ Producer Batch ï¼Œå³ <code>Deque&lt;ProducerBatch&gt;</code>ã€‚æ¶ˆæ¯å†™å…¥ç¼“å­˜æ—¶ï¼Œè¿½åŠ åˆ°åŒç«¯é˜Ÿåˆ—çš„å°¾éƒ¨</li> <li>Sender è¯»å–æ¶ˆæ¯æ—¶ï¼Œä»åŒç«¯é˜Ÿåˆ—çš„å¤´éƒ¨è¯»å–ã€‚Producer Batch  ä¸­å¯ä»¥åŒ…å«ä¸€è‡³å¤šä¸ª ProducerRecordã€‚ é€šä¿—åœ°è¯´ï¼Œ ProducerRecord æ˜¯ç”Ÿäº§è€…ä¸­åˆ›å»ºçš„æ¶ˆæ¯ï¼Œè€Œ Producer Batch æ˜¯æŒ‡ä¸€ä¸ªæ¶ˆæ¯æ‰¹æ¬¡ï¼Œ Producer Record ä¼šè¢«åŒ…å«åœ¨ Producer Batch ä¸­ï¼Œè¿™æ ·å¯ä»¥ä½¿å­—èŠ‚çš„ä½¿ç”¨æ›´åŠ ç´§å‡‘ã€‚ä¸æ­¤åŒæ—¶ï¼Œå°†è¾ƒå°çš„ ProducerRecord æ‹¼å‡‘æˆä¸€ä¸ªè¾ƒå¤§çš„ ProducerBatchï¼Œä¹Ÿå¯ä»¥å‡å°‘ç½‘ç»œè¯·æ±‚çš„æ¬¡æ•°ä»¥æå‡æ•´ä½“çš„ååé‡</li> <li>Producer Batch å’Œæ¶ˆæ¯çš„å…·ä½“æ ¼å¼æœ‰å…³ï¼Œå¦‚æœç”Ÿäº§è€…å®¢æˆ·ç«¯éœ€è¦å‘å¾ˆå¤šåˆ†åŒºå‘é€æ¶ˆæ¯ï¼Œ åˆ™å¯ä»¥å°† <code>buffer.memory</code> å‚æ•°é€‚å½“è°ƒå¤§ä»¥å¢åŠ æ•´ä½“çš„ååé‡</li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// org.apache.kafka.clients.producer.internals.RecordAccumulator</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">RecordAccumulator</span> <span class="token punctuation">{</span>
  <span class="token comment">// çœŸæ­£çš„ç¼“å­˜ CopyOnWriteMap</span>
  <span class="token comment">// Deque æ˜¯ ArrayDequeï¼Œå½“ä½œä¸ºä¸€ä¸ªé˜Ÿåˆ—æ—¶ï¼Œæ¯” LinkedList å¿«</span>
  <span class="token comment">// æ¯ä¸ªåˆ†åŒºéƒ½æœ‰è‡ªå·±çš„ Dequeï¼Œ å­˜çš„æ˜¯ RecordBatch</span>
  <span class="token comment">// RecordBatch æ‰æ˜¯ record çœŸæ­£ç¼“å­˜å’Œ batch å‘é€</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">Deque</span><span class="token punctuation">&lt;</span><span class="token class-name">RecordBatch</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> batches<span class="token punctuation">;</span>
  <span class="token comment">/* * record æ·»åŠ åˆ° ç¼“å†²åŒº * çº¿ç¨‹å®‰å…¨ï¼Œåˆ†æ®µåŠ é”æé«˜æ€§èƒ½ */</span>
  <span class="token keyword">public</span> <span class="token class-name">RecordAppendResult</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">TopicPartition</span> tp<span class="token punctuation">,</span>
                                    <span class="token keyword">long</span> timestamp<span class="token punctuation">,</span>
                                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span>
                                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value<span class="token punctuation">,</span>
                                    <span class="token class-name">Callback</span> callback<span class="token punctuation">,</span>
                                    <span class="token keyword">long</span> maxTimeToBlock<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// getOrCreateDeque è·å–å½“å‰åˆ†åŒºç¼“å­˜ï¼Œçº¿ç¨‹å®‰å…¨ï¼ŒCopyOnWriteMap åç»­ä»‹ç»</span>
        <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RecordBatch</span><span class="token punctuation">&gt;</span></span> dq <span class="token operator">=</span> <span class="token function">getOrCreateDeque</span><span class="token punctuation">(</span>tp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ç¬¬ä¸€æ¬¡åŠ é”</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token class-name">RecordAppendResult</span> appendResult <span class="token operator">=</span> <span class="token function">tryAppend</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> dq<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>appendResult <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> appendResult<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token comment">// è§£é”</span>
        <span class="token comment">// èµ°åˆ°è¿™ä¸€æ­¥è¯´æ˜ï¼Œä¸Šé¢çš„ tryAppend è¿”å›null å³ RecordBatch ä¸º null</span>
        <span class="token comment">// // å¯èƒ½æœ‰ä¸¤ç§æƒ…å†µï¼šæ²¡æœ‰RecordBatchï¼Œæ—§çš„RecordBatch å·²å†™æ»¡è¦å¼€è¾Ÿæ–°çš„ RecordBatch</span>
        <span class="token comment">// å†…å­˜æ± (åç»­ä»‹ç»)å¼€è¾Ÿæ–°çš„ RecordBatchï¼Œä¾›æ·»åŠ ç¼“å­˜æ•°æ®</span>
        <span class="token comment">// å¼€è¾Ÿæ–°æ‰¹æ¬¡çš„ç©ºé—´è€—æ—¶ï¼Œä¸åŠ é”</span>
        <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>batchSize<span class="token punctuation">,</span> <span class="token class-name">Records</span><span class="token punctuation">.</span><span class="token constant">LOG_OVERHEAD</span> <span class="token operator">+</span> <span class="token class-name">Record</span><span class="token punctuation">.</span><span class="token function">recordSize</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Allocating a new {} byte message buffer for topic {} partition {}&quot;</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> tp<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tp<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> free<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> maxTimeToBlock<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ç¬¬äºŒæ¬¡åŠ é”</span>
        <span class="token comment">// ä¸€ï¼štryAppend å†æ¬¡å°è¯•æ·»åŠ </span>
        <span class="token comment">// äºŒï¼šæ·»åŠ æˆåŠŸï¼Œè¯´æ˜å·²å­˜åœ¨ RecordBatchï¼Œåˆ é™¤ä¹‹å‰åˆ›å»ºçš„ buffer</span>
        <span class="token comment">// ä¸‰ï¼šæ·»åŠ å¤±è´¥ï¼Œåˆ©ç”¨ä¹‹å‰åˆ›å»ºçš„ buffer æ–°å»º RecordBatchï¼Œç„¶åæ·»åŠ </span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token class-name">RecordAppendResult</span> appendResult <span class="token operator">=</span> <span class="token function">tryAppend</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> dq<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>appendResult <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// æ­¤æ—¶å‘ç°å·²æœ‰æ–°æ‰¹æ¬¡çš„ RecordBatchï¼Œåˆ é™¤ä¹‹å‰åˆ›å»ºçš„ buffer</span>
                <span class="token comment">// ç»“åˆå¤šçº¿ç¨‹åœºæ™¯å»è€ƒè™‘</span>
                free<span class="token punctuation">.</span><span class="token function">deallocate</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> appendResult<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// æ–°å»º RecordBatchï¼Œå¹¶å°† Record æ·»åŠ </span>
            <span class="token class-name">MemoryRecords</span> records <span class="token operator">=</span> <span class="token class-name">MemoryRecords</span><span class="token punctuation">.</span><span class="token function">emptyRecords</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> compression<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>batchSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">RecordBatch</span> batch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RecordBatch</span><span class="token punctuation">(</span>tp<span class="token punctuation">,</span> records<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">FutureRecordMetadata</span> future <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>batch<span class="token punctuation">.</span><span class="token function">tryAppend</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// åˆ†åŒºé˜Ÿåˆ—ä¸­æ·»åŠ  RecordBatchï¼Œä¸‹æ¬¡ä¸ç”¨å†åˆ›å»º</span>
            dq<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
            incomplete<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RecordAppendResult</span><span class="token punctuation">(</span>future<span class="token punctuation">,</span> dq<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">||</span> batch<span class="token punctuation">.</span>records<span class="token punctuation">.</span><span class="token function">isFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token comment">// è§£é”</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>batches</code> æ˜¯çœŸæ­£çš„ Record ç¼“å­˜æ•°æ®ç»“æ„ï¼Œè¿™é‡Œè®¾è®¡ä¹Ÿæ˜¯å¾ˆç²¾å¦™çš„ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// org.apache.kafka.common.utils.CopyOnWriteMap</span>
<span class="token comment">// è¯»ä¼˜åŒ–</span>
<span class="token comment">// è¿™é‡Œä¸ºäº†æé«˜é˜Ÿåˆ—çš„æ€§èƒ½ï¼Œä½¿ç”¨çš„æ•°æ®ç»“æ„æ˜¯ ArrayDeque ,å³ V = ArrayQueue</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CopyOnWriteMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token comment">/** * è¯» map æ—¶æ²¡åŠ  */</span>
  <span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Object</span> k<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/** * é‡ç‚¹ * å†™ map æ—¶åŠ é”ï¼Œè¯»å†™åˆ†ç¦»æ€è·¯ï¼Œé€‚åˆè¯»å¤šå†™å°‘çš„åœºæ™¯å³å¤š get å°‘ put * putï¼šæ¯ä¸ªåˆ†åŒºåªä¼š put ä¸€æ¬¡ï¼Œå®é™…æ“ä½œä¸­åˆ†åŒºæ•°æ—¶æœ‰æœ‰é™çš„ * æ³¨æ„è¿™é‡Œå¤šå¼€è¾Ÿæ–°çš„ map ï¼Œç”¨äºäº¤æ¢ï¼šhttps://www.cnblogs.com/hapjin/p/4840107.html * ç–‘é—®ï¼šä¸ºä»€ä¹ˆè¿™é‡Œè¦å¤šå¤åˆ¶ä¸€ä»½è€Œä¸æ˜¯ç›´æ¥æ“ä½œå‘¢ï¼Ÿ å› ä¸ºåŒä¸ª map åŒä¸€æ—¶é—´æœ‰å¢åˆ å’Œéå†æ—¶ï¼Œä¼šæŠ¥ ConcurrentModificationException * æ‰€ä»¥è¿™é‡Œå¤šå¤åˆ¶ä¸€ä»½ï¼Œä¿è¯è¯»åŸæ¥çš„ mapï¼Œå†™å¤‡ä»½çš„ map åæ›¿æ¢åŸå…ˆçš„ map */</span>
  <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">V</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">K</span> k<span class="token punctuation">,</span> <span class="token class-name">V</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> copy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">V</span> prev <span class="token operator">=</span> copy<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>map <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableMap</span><span class="token punctuation">(</span>copy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> prev<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">V</span> <span class="token function">putIfAbsent</span><span class="token punctuation">(</span><span class="token class-name">K</span> k<span class="token punctuation">,</span> <span class="token class-name">V</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">containsKey</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token function">put</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
      <span class="token keyword">return</span> <span class="token function">get</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åˆ°æ­¤æˆ‘ä»¬å¯ä»¥å¾—åˆ° <code>RecordAccumulator</code> çš„æ•°æ®ç»“æ„å›¾</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409181348722.jpeg" alt="img"></p> <h3 id="å†…å­˜æ± "><a href="#å†…å­˜æ± " class="header-anchor">#</a> å†…å­˜æ± </h3> <p>Producer å‘é€æ•°æ®æ˜¯æ”’æ‰¹çš„ï¼Œå…ˆç¼“å­˜åˆ° <code>RecordBatch</code> ç„¶åå†æ•´ä½“å‘é€ã€‚<code>RecordBatch</code> åœ¨ JVM å†…å­˜ç©ºé—´ï¼ŒProducer ååå¾ˆå¤§å¿…ç„¶ä¼šé¢‘ç¹åˆ›å»º <code>RecordBatch</code>ã€‚å¯¹è±¡é¢‘ç¹åˆ›å»ºï¼Œåœ¨ JAVA ä¸–ç•Œä¸­ä¸å¯é¿å…çš„æ¶‰åŠåˆ° <code>GC</code>ï¼Œä½† kafka åœ¨è¿™ä¸€æ­¥åšäº†<strong>ä¼˜åŒ–</strong>ã€‚ä¸‹é¢ä¸€èµ·çœ‹çœ‹åœ¨ Producer ç«¯çš„<strong>å†…å­˜æ± </strong>ä¼˜åŒ–ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// è·å– RecordBatch æ‰€éœ€çš„å†…å­˜ç©ºé—´</span>
<span class="token comment">// ByteBuffer buffer = free.allocate(size, maxTimeToBlock);</span>

<span class="token comment">// org.apache.kafka.clients.producer.internals.BufferPool</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">BufferPool</span> <span class="token punctuation">{</span>
  <span class="token comment">// å¯ç”¨çš„ ByteBuffer é˜Ÿåˆ—</span>
  <span class="token comment">// ByteBuffer æ˜¯ é»˜è®¤ batch å¤§å°çš„å†…å­˜å—</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">&gt;</span></span> free<span class="token punctuation">;</span>
  <span class="token comment">// éœ€è¦ç­‰å¾…å¼€è¾Ÿ ByteBuffer çš„ batchs(æ²¡æœ‰å¯ç¼“å†²çš„å†…å­˜ï¼Œéœ€è¦å‘é€ batch æ¥é‡Šæ”¾)</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Condition</span><span class="token punctuation">&gt;</span></span> waiters<span class="token punctuation">;</span>
  <span class="token comment">// Deque&lt;ByteBuffer&gt; + availableMemory = ç¼“å­˜æ± å¤§å°ï¼Œé»˜è®¤ 32M</span>
  <span class="token comment">// availableMemory å¯åˆ†é…çš„å†…å­˜å¤§å°</span>
  <span class="token keyword">private</span> <span class="token keyword">long</span> availableMemory<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">ByteBuffer</span> <span class="token function">allocate</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">,</span> <span class="token keyword">long</span> maxTimeToBlockMs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token comment">// size å¤§äº æ€»ç¼“å­˜æ± å¤§å°ï¼Œç›´æ¥æŠ¥é”™ï¼Œå¤ªå¤§äº†æ”¾ä¸ä¸‹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>totalMemory<span class="token punctuation">)</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Attempt to allocate &quot;</span> <span class="token operator">+</span> size
                                        <span class="token operator">+</span> <span class="token string">&quot; bytes, but there is a hard limit of &quot;</span>
                                        <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>totalMemory
                                        <span class="token operator">+</span> <span class="token string">&quot; on memory allocations.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åŠ é”</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ¤æ–­ size æ˜¯å¦ä¸ºè®¾ç½®çš„ batch size å¤§å°ï¼Œ</span>
    <span class="token comment">// ä¸€èˆ¬éƒ½æ˜¯ batch å¤§å°ï¼Œé™¤éä¸€æ¡ record è¶…è¿‡ batch size åˆ™è¦å¤§äº batch size</span>
    <span class="token comment">// è¿™é‡Œå¾ˆå…³é”®ï¼Œæ˜¯å†…å­˜æ± ç®¡ç†çš„ä½“ç°ï¼š</span>
    <span class="token comment">// free:Deque&lt;ByteBuffer&gt; æ˜¯ ByteBufferé˜Ÿåˆ—ï¼Œä¸” ByteBuffer å¤§å°=batch size</span>
    <span class="token comment">// å¦‚æœè¦ç”³è¯·çš„å†…å­˜å¤§å°æ˜¯ batch sizeï¼Œé‚£ä¹ˆç›´æ¥ä» free è·å–å³å¯ï¼Œæ— éœ€åˆ›å»ºæ–°çš„ ByteBuffer å¯¹è±¡</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> poolableSize <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>free<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>free<span class="token punctuation">.</span><span class="token function">pollFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// now check if the request is immediately satisfiable with the</span>
    <span class="token comment">// memory on hand or if we need to block</span>
    <span class="token keyword">int</span> freeListSize <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>free<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>poolableSize<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>availableMemory <span class="token operator">+</span> freeListSize <span class="token operator">&gt;=</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ç¬¬ä¸€ç§æƒ…å†µï¼š</span>
        <span class="token comment">// å½“å‰å¯ç”¨çš„å†…å­˜ï¼ˆavailableMemory + freeï¼‰å¤§äºç”³è¯·çš„ sizeï¼Œå¼€è¾Ÿåè¿”å›</span>

        <span class="token comment">// é‡Šæ”¾ free ä¸­çš„ ByteBuffer åˆ° availableMemoryï¼Œä¿è¯ availableMemory ç©ºé—´å¤§äºç”³è¯·çš„ size</span>
        <span class="token function">freeUp</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>availableMemory <span class="token operator">-=</span> size<span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// ç¬¬äºŒç§æƒ…å†µï¼š</span>
        <span class="token comment">// å½“å‰å¯ç”¨çš„å†…å­˜ï¼ˆavailableMemory + freeï¼‰å°äºç”³è¯·çš„ size</span>
        <span class="token comment">// å½“å‰çº¿ç¨‹ blockï¼Œç›´åˆ°ï¼ˆavailableMemory + freeï¼‰å¤§äºç”³è¯·çš„ sizeï¼Œç­‰å¾… é‡Šæ”¾</span>
        <span class="token comment">// å¦‚æœå¸¸å¸¸å‘ç”Ÿè¿™ç§æƒ…å†µï¼Œå»ºè®®åŠ å¤§ç¼“å†²åŒºå¤§å°</span>
        <span class="token keyword">int</span> accumulated <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">Condition</span> moreMemory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> remainingTimeToBlockNs <span class="token operator">=</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>maxTimeToBlockMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å½“å‰å¼€è¾Ÿ size ï¼Œå†…å­˜ç©ºé—´ä¸è¶³ï¼Œä¿¡æ¯å­˜å…¥ waiters</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>waiters<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>moreMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ç­‰å¾…ï¼Œç›´åˆ° å¯ç”¨å†…å­˜å¤§äºç”³è¯·çš„ size</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>accumulated <span class="token operator">&lt;</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> startWaitNs <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">nanoseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> timeNs<span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> waitingTimeElapsed<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// wait</span>
                <span class="token comment">// è¶…æ—¶è‡ªåŠ¨è‹é†’</span>
                <span class="token comment">// æœ‰å†…å­˜é‡Šæ”¾è¢«å”¤é†’</span>
                waitingTimeElapsed <span class="token operator">=</span> <span class="token operator">!</span>moreMemory<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span>remainingTimeToBlockNs<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">NANOSECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>waiters<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>moreMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token keyword">long</span> endWaitNs <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">nanoseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                timeNs <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">,</span> endWaitNs <span class="token operator">-</span> startWaitNs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>waitTime<span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span>timeNs<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// å¦‚æœæ˜¯è¶…æ—¶ç­‰å¾…ï¼Œè¡¨ç¤ºåœ¨è§„å®šçš„æ—¶é—´æ²¡æœ‰å¯ç”¨çš„å†…å­˜ï¼Œç›´æ¥æŠ¥é”™ï¼Œé»˜è®¤ 60s - è·å–å…ƒæ•°æ®æ—¶é—´</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>waitingTimeElapsed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>waiters<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>moreMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to allocate memory within the configured max blocking time &quot;</span> <span class="token operator">+</span> maxTimeToBlockMs <span class="token operator">+</span> <span class="token string">&quot; ms.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            remainingTimeToBlockNs <span class="token operator">-=</span> timeNs<span class="token punctuation">;</span>
            <span class="token comment">// åˆ°è¿™ä¸€æ­¥ï¼Œè¯´æ˜æœ‰å†…å­˜é‡Šæ”¾</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>accumulated <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> size <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>poolableSize <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>free<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// ç”³è¯·å†…å­˜size = batch sizeï¼ŒæŠŠ free ä¸­ ByteBuffer è¿”å›</span>
                buffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>free<span class="token punctuation">.</span><span class="token function">pollFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                accumulated <span class="token operator">=</span> size<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// ç´¯åŠ  å¯ç”¨å†…å­˜å¤§å°ï¼Œaccumulated</span>
                <span class="token function">freeUp</span><span class="token punctuation">(</span>size <span class="token operator">-</span> accumulated<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> got <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>size <span class="token operator">-</span> accumulated<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>availableMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>availableMemory <span class="token operator">-=</span> got<span class="token punctuation">;</span>
                accumulated <span class="token operator">+=</span> got<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deallocate</span><span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span> buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>poolableSize <span class="token operator">&amp;&amp;</span> size <span class="token operator">==</span> buffer<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// é‡Šæ”¾çš„å†…å­˜å¤§å° = batch size</span>
              <span class="token comment">// æ¸…ç©º bufferï¼Œå¹¶æ·»åŠ åˆ° free</span>
              <span class="token comment">// å†…å­˜æ± ç®¡ç†çš„ä½“ç°ï¼šç”¨å®Œå†…å­˜ä¸é‡Šæ”¾ï¼Œç›´æ¥å¤ç”¨ï¼Œå‡å°‘ GC</span>
              buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>free<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token comment">// é‡Šæ”¾çš„å†…å­˜å¤§å° != batch sizeï¼Œç›´æ¥é‡Šæ”¾ç­‰å¾… GC</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>availableMemory <span class="token operator">+=</span> size<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// æœ‰å†…å­˜é‡Šæ”¾ï¼Œå”¤é†’åœ¨ç­‰å¾…å†…å­˜å¼€è¾Ÿçš„ waiters</span>
          <span class="token class-name">Condition</span> moreMem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waiters<span class="token punctuation">.</span><span class="token function">peekFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>moreMem <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
              <span class="token comment">// waitingTimeElapsed = !moreMemory.await(remainingTimeToBlockNs, TimeUnit.NANOSECONDS);</span>
              moreMem<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
          lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>å†…å­˜ç”³è¯·å’Œé‡Šæ”¾ä¸»è¦ä»£ç å¦‚ä¸Šæ‰€ç¤ºï¼Œæ¥ä¸‹æ¥ç†æ¸…è®¾è®¡ï¼š</p> <ul><li>ç¼“å†²æ± åˆ†ä¸ºï¼šfree å’Œ availableMemory</li> <li>availableMemory è¡¨ç¤ºæœªåˆ†é…å¯ç”¨çš„å†…å­˜ï¼Œä¸»è¦æ˜¯è®¡ç®—æ˜¯å¦å¯åˆ†é… size å†…å­˜ï¼šåˆ†é…æ—¶å‡å°‘ï¼Œé‡Šæ”¾æ—¶å¢åŠ ï¼Œå›æ”¶é  GC</li> <li>free ï¼šByteBuffer é˜Ÿåˆ—ï¼ŒByteBuffer å¤§å° = batch sizeï¼Œä¸€èˆ¬æ°å¥½æ˜¯æ¯æ¬¡å¼€è¾Ÿçš„å¤§å°ï¼Œé‡Šæ”¾æ—¶æ¸…ç©ºæ•°æ®<strong>é‡æ–°</strong>æ·»åŠ åˆ°é˜Ÿåˆ—</li></ul> <p>æŒ‰ batch size å¤§å°åˆ’åˆ† ByteBufferï¼Œå¢å¤§å¤ç”¨æ•ˆæœï¼›ä¸ç­‰äº batch size çš„å†…å­˜ç©ºé—´ç›´æ¥ GCï¼Œä¸ä¼šå‡ºç°å†…å­˜ç¢ç‰‡é—®é¢˜ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409181350106.jpeg" alt="img"></p> <h3 id="nio"><a href="#nio" class="header-anchor">#</a> NIO</h3> <p>æœ‰äº†ä»¥ä¸Šçš„çŸ¥è¯†åï¼Œæˆ‘ä»¬å¯ä»¥å°† record åŠ å…¥åˆ° batch ä¸­ï¼Œå‡†å¤‡å‘é€åˆ° kafka brokerã€‚åœ¨å‘é€ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆåˆ†æ kafka çš„ä½¿ç”¨çš„ç½‘ç»œæ¡†æ¶ <code>NIO</code>ï¼Œæœ‰åŠ©äºåç»­åˆ†æ <code>sender</code> çº¿ç¨‹ã€‚ç½‘ç»œä¸€èˆ¬æ¶‰åŠä¸‰ä¸ªè¿‡ç¨‹ï¼šå»ºç«‹è¿æ¥ï¼Œå‘é€æ•°æ®ï¼Œè¯»å“åº”ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// NetworkClient æ˜¯ kafka ç½‘ç»œè¯·æ±‚å®ç°ç±»</span>
<span class="token comment">// NetworkClient ä¸»è¦æ˜¯å°è£… NIO ä¸­ selector æ“ä½œ</span>
<span class="token comment">// ä¸‹é¢ä¸»è¦åˆ†æ kafka ä¸­ selector æ“ä½œï¼Œå…³äº NetworkClient æ”¾åˆ°åç»­çš„ sender çº¿ç¨‹ä¸€èµ·åˆ†æ</span>
<span class="token comment">// org.apache.kafka.common.network.Selector</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Selector</span> <span class="token keyword">implements</span> <span class="token class-name">Selectable</span> <span class="token punctuation">{</span>
  <span class="token comment">// java nioï¼Œä¸äº†è§£çš„å…ˆå»ç†Ÿæ‚‰ä¸‹</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>channels<span class="token punctuation">.</span></span>Selector</span> nioSelector<span class="token punctuation">;</span>
  <span class="token comment">// è®°å½•å¯¹ kafka broker è¿æ¥</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">KafkaChannel</span><span class="token punctuation">&gt;</span></span> channels<span class="token punctuation">;</span>

  <span class="token comment">// ä¸ kafka broker å»ºç«‹è¿æ¥ï¼Œid = kafka node</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">,</span> <span class="token class-name">InetSocketAddress</span> address<span class="token punctuation">,</span> <span class="token keyword">int</span> sendBufferSize<span class="token punctuation">,</span> <span class="token keyword">int</span> receiveBufferSize<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token class-name">SocketChannel</span> socketChannel <span class="token operator">=</span> <span class="token class-name">SocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è®¾ç½®éé˜»å¡æ¨¡å¼</span>
    socketChannel<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Socket</span> socket <span class="token operator">=</span> socketChannel<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    socket<span class="token punctuation">.</span><span class="token function">setKeepAlive</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sendBufferSize <span class="token operator">!=</span> <span class="token class-name">Selectable</span><span class="token punctuation">.</span><span class="token constant">USE_DEFAULT_BUFFER_SIZE</span><span class="token punctuation">)</span>
        socket<span class="token punctuation">.</span><span class="token function">setSendBufferSize</span><span class="token punctuation">(</span>sendBufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>receiveBufferSize <span class="token operator">!=</span> <span class="token class-name">Selectable</span><span class="token punctuation">.</span><span class="token constant">USE_DEFAULT_BUFFER_SIZE</span><span class="token punctuation">)</span>
        socket<span class="token punctuation">.</span><span class="token function">setReceiveBufferSize</span><span class="token punctuation">(</span>receiveBufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// tcp ä¼˜åŒ–</span>
    socket<span class="token punctuation">.</span><span class="token function">setTcpNoDelay</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> connected<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// å°è¯•å»ºç«‹è¿æ¥</span>
        connected <span class="token operator">=</span> socketChannel<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnresolvedAddressException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        socketChannel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;Can't resolve address: &quot;</span> <span class="token operator">+</span> address<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        socketChannel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// channel åŠ åˆ° nio selectorï¼Œå¹¶æ·»åŠ  OP_CONNECT äº‹ä»¶</span>
    <span class="token comment">// åç»­ chanel å»ºç«‹è¿æ¥åï¼Œç”± nio selector è¿”å› connect äº‹ä»¶</span>
    <span class="token class-name">SelectionKey</span> key <span class="token operator">=</span> socketChannel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>nioSelector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_CONNECT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// id = kafka nodeï¼›kafkaChannel åªæ˜¯å¯¹ java channel çš„å°è£…</span>
    <span class="token class-name">KafkaChannel</span> channel <span class="token operator">=</span> channelBuilder<span class="token punctuation">.</span><span class="token function">buildChannel</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> key<span class="token punctuation">,</span> maxReceiveSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åç»­å¤„ç†æ—¶å¯é€šè¿‡ key.attachment å¾—åˆ° channel</span>
    key<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// è®°å½• kafka node å¯¹åº”çš„ channel</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>channels<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// å‘é€æ•°æ®</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">Send</span> send<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// é€šè¿‡send è·å– kafka node å¾—åˆ°å¯¹åº”çš„ channel</span>
    <span class="token class-name">KafkaChannel</span> channel <span class="token operator">=</span> <span class="token function">channelOrFail</span><span class="token punctuation">(</span>send<span class="token punctuation">.</span><span class="token function">destination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// channel å‘é€æ•°æ®ï¼Œæ­¤æ—¶åªæ˜¯ä¸º channel æ·»åŠ  OP_WRITEï¼Œå¹¶æœªçœŸæ­£å‘é€</span>
        channel<span class="token punctuation">.</span><span class="token function">setSend</span><span class="token punctuation">(</span>send<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CancelledKeyException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>failedSends<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>send<span class="token punctuation">.</span><span class="token function">destination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// sender çº¿ç¨‹ä¸­ä¼šå®šæ—¶è°ƒç”¨è·å– event </span>
  <span class="token comment">// è¯»å– nio selector eventï¼Œtime è¡¨ç¤ºæ˜¯å¦éœ€è¦é˜»å¡ç­‰å¾…äº‹ä»¶å‘ç”Ÿ</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// block ç›´åˆ°æœ‰äº‹ä»¶</span>
    <span class="token comment">// æ³¨æ„æ­¤æ—¶ä¼š waitï¼Œé‚£ä¹ˆä¼šå¯¼è‡´ sender çº¿ç¨‹ä¹Ÿä¼šä¼‘çœ ï¼Œéœ€è¦è°ƒç”¨ sender.wakeup å”¤é†’</span>
    <span class="token keyword">int</span> readyKeys <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">long</span> endSelect <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">nanoseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sensors<span class="token punctuation">.</span>selectTime<span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span>endSelect <span class="token operator">-</span> startSelect<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// æœ‰éœ€è¦å“åº”çš„äº‹ä»¶</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>readyKeys <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token operator">!</span>immediatelyConnectedKeys<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pollSelectionKeys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>nioSelector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> endSelect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pollSelectionKeys</span><span class="token punctuation">(</span>immediatelyConnectedKeys<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> endSelect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å¤„ç†æœåŠ¡ç«¯è¿”å›çš„å“åº”,stagedReceives</span>
    <span class="token function">addToCompletedReceives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// å¤„ç† nio selector è¿”å›çš„äº‹ä»¶</span>
  <span class="token comment">// connect</span>
  <span class="token comment">// read</span>
  <span class="token comment">// write</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">pollSelectionKeys</span><span class="token punctuation">(</span><span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> selectionKeys<span class="token punctuation">,</span>
                                <span class="token keyword">boolean</span> isImmediatelyConnected<span class="token punctuation">,</span>
                                <span class="token keyword">long</span> currentTimeNanos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// eventKeys</span>
    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> selectionKeys<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SelectionKey</span> key <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        iterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">KafkaChannel</span> channel <span class="token operator">=</span> <span class="token function">channel</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// å¤„ç† connect ï¼Œä¸ kafka node å·²å»ºç«‹è¿æ¥ï¼šOP_CONNECT</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isImmediatelyConnected <span class="token operator">||</span> key<span class="token punctuation">.</span><span class="token function">isConnectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// è¿æ¥å»ºç«‹å®Œæˆåï¼Œchannel ä¸Šå¯¹åº”çš„key å»é™¤ OP_CONNECTï¼Œæ·»åŠ  OP_READ äº‹ä»¶</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">finishConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// è®°å½•å½“å‰ kafka node å·²å»ºç«‹è¿æ¥</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>connected<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>sensors<span class="token punctuation">.</span>connectionCreated<span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">SocketChannel</span> socketChannel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SocketChannel</span><span class="token punctuation">)</span> key<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Created socket with SO_RCVBUF = {}, SO_SNDBUF = {}, SO_TIMEOUT = {} to node {}&quot;</span><span class="token punctuation">,</span>
                            socketChannel<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getReceiveBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            socketChannel<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSendBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            socketChannel<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSoTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            channel<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment">// å¤„ç† readï¼šåœ¨å»ºç«‹è¿æ¥åå·²æ·»åŠ  OP_READ äº‹ä»¶</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">hasStagedReceive</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">NetworkReceive</span> networkReceive<span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>networkReceive <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    <span class="token function">addToStagedReceives</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> networkReceive<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// å¤„ç† writeï¼šOP_WRITE (send(Send send))</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">isWritable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// channel.setSend(send); ä¸º chanel æ·»åŠ  send</span>
                <span class="token comment">// é€šè¿‡ chanel å‘é€æ•°æ®ï¼šRecordBatchs</span>
                <span class="token class-name">Send</span> send <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>send <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>completedSends<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>send<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>sensors<span class="token punctuation">.</span><span class="token function">recordBytesSent</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> send<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// å…³é—­è¿æ¥</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>key<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">close</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>disconnected<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409181351976.jpeg" alt="img"></p> <h4 id="read"><a href="#read" class="header-anchor">#</a> read</h4> <p>å½“ä½¿ç”¨ <code>NIO</code> ï¼Œç”±äº buffer å¤§å°ä¸åŒ¹é…é—®é¢˜ï¼Œå¿…ç„¶ä¼šç¢°åˆ°ç²˜åŒ…æˆ–æ‹†åŒ…çš„é—®é¢˜ã€‚å‡è®¾ä¸¤ä¸ªå“åº”è¿”å› â€œhello wordâ€ å’Œ â€œflink kafkaâ€ï¼Œæœ‰å¯èƒ½æ˜¯è¿”å›(<strong>ä¸€ä¸ªè¿”å›å°±å¥½è§¦å‘ä¸€ä¸ª read event</strong>)</p> <ul><li>â€œhello wordâ€</li> <li>â€œflink â€œ</li> <li>â€œkafkaâ€</li></ul> <p>è¿™å«<strong>æ‹†åŒ…</strong>ï¼Œä¹Ÿæœ‰å¯èƒ½è¿”å›</p> <ul><li>â€œhello wordflinkâ€</li> <li>â€œkafkaâ€</li></ul> <p>è¿™å«<strong>ç²˜åŒ…</strong></p> <p>kafka çš„è§£å†³æ–¹æ¡ˆæ˜¯ç›¸å½“äºåœ¨åŸæœ‰ data åŸºç¡€ä¸Šå¢åŠ  headerï¼Œheader åªåŒ…å« data sizeï¼Œå¾ˆæœ´ç´ å’Œé€šç”¨æ–¹æ¡ˆã€‚ä¸¤ä¸ªæ•°æ®åŒ…å˜æˆ 10â€hello wordâ€ï¼Œ11â€flink kafkaâ€ã€‚æ­¤æ—¶è¯»å–æ–¹å¼å˜ä¸ºå…ˆè¯»å–4å­—èŠ‚ <code>size</code>ï¼Œç„¶åå†å¼€è¾Ÿ size å¤§å°çš„ <code>buffer</code> å­˜dataï¼Œ<strong>æ­»å¾ªç¯</strong>ç›´åˆ° data buffer è¯»æ»¡</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// org.apache.kafka.common.network.Selector</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">hasStagedReceive</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">NetworkReceive</span> networkReceive<span class="token punctuation">;</span>
    <span class="token comment">// read receiveè¿”å›null è¡¨ç¤ºå½“å‰å“åº”åŒ…ä¸ºè¯»å–å®Œæ¯•ï¼Œç­‰å¾…ä¸‹ä¸ª read eventå†è¯»</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>networkReceive <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token comment">// receive complete æ‰ç®—å“åº”è¯»å–å®Œæ¯•</span>
        <span class="token comment">// receive æ·»åŠ åˆ° stagedReceives</span>
        <span class="token function">addToStagedReceives</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> networkReceive<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// org.apache.kafka.common.network.KafkaChannel</span>
<span class="token keyword">public</span> <span class="token class-name">NetworkReceive</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">NetworkReceive</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>receive <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        receive <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NetworkReceive</span><span class="token punctuation">(</span>maxReceiveSize<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// read</span>
    <span class="token function">receive</span><span class="token punctuation">(</span>receive<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// size å’Œ data éƒ½è¯»å–å®Œæ¯•,æ‰ç®— complete</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>receive<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        receive<span class="token punctuation">.</span><span class="token function">payload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> receive<span class="token punctuation">;</span>
        receive <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">receive</span><span class="token punctuation">(</span><span class="token class-name">NetworkReceive</span> receive<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> receive<span class="token punctuation">.</span><span class="token function">readFrom</span><span class="token punctuation">(</span>transportLayer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">readFromReadableChannel</span><span class="token punctuation">(</span><span class="token class-name">ReadableByteChannel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> read <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// è¯»å– sizeï¼›</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>size<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">int</span> bytesRead <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>bytesRead <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">EOFException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      read <span class="token operator">+=</span> bytesRead<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>size<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          size<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">int</span> receiveSize <span class="token operator">=</span> size<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
          <span class="token comment">// è¯»å–åˆ°sizeï¼Œå¯çŸ¥ data é•¿åº¦ï¼Œç”³è¯·å­˜æ”¾ data æ‰€éœ€çš„ buffer</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>receiveSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// è¯»å– dataï¼›æ¯æ¬¡è¿›æ¥éƒ½å¿…ä¼šè¯»å– buffer</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">int</span> bytesRead <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>bytesRead <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">EOFException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      read <span class="token operator">+=</span> bytesRead<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> read<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="sender-çº¿ç¨‹"><a href="#sender-çº¿ç¨‹" class="header-anchor">#</a> Sender çº¿ç¨‹</h2> <p>æ•´ä¸ªç”Ÿäº§è€…å®¢æˆ·ç«¯ç”±ä¸¤ä¸ªçº¿ç¨‹åè°ƒè¿è¡Œï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«ä¸ºä¸»çº¿ç¨‹å’ŒSender çº¿ç¨‹(å‘é€çº¿ç¨‹)ã€‚åœ¨ä¸»çº¿ç¨‹ä¸­ç”±KafkaProducer åˆ›å»ºæ¶ˆæ¯ï¼Œç„¶åé€šè¿‡å¯èƒ½çš„æ‹¦æˆªå™¨ã€åºåˆ—åŒ–å™¨å’Œåˆ†åŒºå™¨çš„ä½œç”¨ä¹‹åç¼“å­˜åˆ°æ¶ˆæ¯ç´¯åŠ å™¨(RecordAccumulatorï¼Œä¹Ÿç§°ä¸ºæ¶ˆæ¯æ”¶é›†å™¨)ä¸­ã€‚Sender çº¿ç¨‹è´Ÿè´£ä»RecordAccumulatorä¸­è·å–æ¶ˆæ¯å¹¶å°†å…¶å‘é€åˆ°Kafkaä¸­ã€‚</p> <p>åˆ°æ­¤æˆ‘ä»¬å…·å¤‡äº†å‘é€ rocordBatch çš„ç¯å¢ƒï¼Œå¼€å§‹å‘æœåŠ¡ç«¯å‘é€æµç¨‹ã€‚</p> <p><code>Sender</code> æ˜¯ Kafka ç”Ÿäº§è€…çš„æ ¸å¿ƒçº¿ç¨‹ï¼Œè´Ÿè´£ä»æ¶ˆæ¯ç´¯åŠ å™¨ä¸­æå–æ¶ˆæ¯ï¼Œå¹¶é€šè¿‡ç½‘ç»œå‘é€åˆ° Kafka æœåŠ¡å™¨ã€‚å…¶å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š</p> <ol><li>ä» <code>RecordAccumulator</code> ä¸­å–å‡ºå·²å‡†å¤‡å¥½çš„æ¶ˆæ¯æ‰¹æ¬¡ã€‚</li> <li>æ ¹æ®æ¶ˆæ¯çš„åˆ†åŒºå’Œä¸»é¢˜æ‰¾åˆ°å¯¹åº”çš„ Kafka æœåŠ¡å™¨ã€‚</li> <li>å‘é€æ¶ˆæ¯ï¼Œå¹¶å¤„ç†å“åº”ï¼ˆåŒ…æ‹¬é‡è¯•ã€è¶…æ—¶ã€å¤±è´¥ç­‰æƒ…å†µï¼‰ã€‚</li></ol> <p><code>Sender</code> çº¿ç¨‹æ˜¯å¼‚æ­¥è¿è¡Œçš„ï¼Œé€šè¿‡é«˜æ•ˆçš„ I/O å’Œæ‰¹é‡å‘é€æœºåˆ¶ä¿è¯äº†ç”Ÿäº§è€…çš„é«˜æ€§èƒ½ã€‚åœ¨é«˜ååé‡çš„åœºæ™¯ä¸‹ï¼Œè°ƒæ•´ <code>Sender</code> çº¿ç¨‹çš„ç›¸å…³å‚æ•°ï¼ˆå¦‚ <code>retries</code> å’Œ <code>max.in.flight.requests.per.connection</code>ï¼‰èƒ½å¤Ÿæ˜¾è‘—æå‡æ¶ˆæ¯å‘é€çš„æ•ˆç‡ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// org.apache.kafka.clients.producer.KafkaProducer</span>
<span class="token comment">// æ»¡è¶³ batch å‘é€æ¡ä»¶ï¼Œå”¤é†’ sender å‘é€æ•°æ®</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// è®°å¾—ä¸ºä»€ä¹ˆè¿™é‡Œè¦å”¤é†’å—ï¼Ÿselector.poll æœ‰å¯èƒ½ä¼š wait</span>

<span class="token comment">// åå°çº¿ç¨‹å‘é€è¯·æ±‚</span>
<span class="token comment">// org.apache.kafka.clients.producer.internals.Sender</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Sender</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">KafkaClient</span> client<span class="token punctuation">;</span>
  <span class="token comment">// whileï¼ˆrunï¼‰</span>
  <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Cluster</span> cluster <span class="token operator">=</span> metadata<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ä»ç¼“å†²æ±  accumulator ç­›é€‰å‡ºæ»¡è¶³ batch send çš„ kafka nodes</span>
    <span class="token class-name">RecordAccumulator<span class="token punctuation">.</span>ReadyCheckResult</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span>cluster<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// å¦‚æœæœ‰ topic çš„å…ƒæ•°æ®ä¿¡æ¯ä½è·å–ï¼Œè®¾ç½®å…ƒæ•°æ®æ ‡è¯†</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>unknownLeaderTopics<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> topic <span class="token operator">:</span> result<span class="token punctuation">.</span>unknownLeaderTopics<span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>metadata<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>metadata<span class="token punctuation">.</span><span class="token function">requestUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ä»éœ€è¦å‘é€çš„ kafka nodes ä¸­ç§»é™¤æ²¡æœ‰å‡†å¤‡å¥½è¿æ¥çš„ nodeï¼Œåˆ¤æ–­æ¡ä»¶</span>
    <span class="token comment">// å…ƒæ•°æ®åŒ…å«å½“å‰ kafka node</span>
    <span class="token comment">// ä¸å½“å‰ kafka node connection å·²å»ºç«‹</span>
    <span class="token comment">// ä¸å½“å‰ kafka node channel å·²å»ºç«‹</span>
    <span class="token comment">// å‘é€ batch è¯·æ±‚æ•°æœªè¶…è¿‡æŒ‡å®šçš„æœ€å¤§å€¼(é»˜è®¤5)ï¼Œç”Ÿäº§ä¸­ä¸€èˆ¬è®¾ç½®ä¸º1ï¼Œä¿è¯æ•°æ®ä¸ä¹±åº</span>
    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">&gt;</span></span> iter <span class="token operator">=</span> result<span class="token punctuation">.</span>readyNodes<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> notReadyTimeout <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span> node <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ready ä¸­å¦‚æœå‘ç°æœªè¿æ¥ä¼šå»åˆå§‹åŒ–è¿æ¥ selector.connect</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            iter<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            notReadyTimeout <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>notReadyTimeout<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">connectionDelay</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ä»å‡†å¤‡å¥½å‘é€çš„ kafkanodes ä¸­ï¼Œè·å–éœ€è¦å‘é€çš„ recordBatch </span>
    <span class="token comment">// ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ï¼Œä¸ kafka node çš„è¿æ¥éƒ½æ²¡æœ‰å»ºç«‹ï¼Œæ­¤æ—¶ result.readyNodes ä¸ºç©º</span>
    <span class="token comment">// åœ¨ poll å‡½æ•°å‘ç° connect äº‹ä»¶ï¼Œæ­¤æ—¶ä¼šå‘èµ·è¿æ¥ï¼Œé‚£ä¹ˆä¸‹æ¬¡å†å‡†å¤‡å‘é€æ—¶å°±å¯ä»¥äº†</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">RecordBatch</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> batches <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator<span class="token punctuation">.</span><span class="token function">drain</span><span class="token punctuation">(</span>cluster<span class="token punctuation">,</span>
                                                                      result<span class="token punctuation">.</span>readyNodes<span class="token punctuation">,</span>
                                                                      <span class="token keyword">this</span><span class="token punctuation">.</span>maxRequestSize<span class="token punctuation">,</span>
                                                                      now<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>guaranteeMessageOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Mute all the partitions drained</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RecordBatch</span><span class="token punctuation">&gt;</span></span> batchList <span class="token operator">:</span> batches<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RecordBatch</span> batch <span class="token operator">:</span> batchList<span class="token punctuation">)</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator<span class="token punctuation">.</span><span class="token function">mutePartition</span><span class="token punctuation">(</span>batch<span class="token punctuation">.</span>topicPartition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å¤„ç†è¶…æ—¶çš„å‘é€</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RecordBatch</span><span class="token punctuation">&gt;</span></span> expiredBatches <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator<span class="token punctuation">.</span><span class="token function">abortExpiredBatches</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestTimeout<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// åˆ›å»ºè¯·æ±‚ï¼šå°†è¦å‘é€çš„ recordbatch å°è£…æˆClientRequest</span>
    <span class="token comment">// æ¯ä¸ªrequests éƒ½æœ‰ä¸ªå›è°ƒå‡½æ•°(handleProduceResponse)ï¼Œåœ¨æ”¶åˆ°å“åº”æ—¶è°ƒç”¨</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientRequest</span><span class="token punctuation">&gt;</span></span> requests <span class="token operator">=</span> <span class="token function">createProduceRequests</span><span class="token punctuation">(</span>batches<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> pollTimeout <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>nextReadyCheckDelayMs<span class="token punctuation">,</span> notReadyTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>readyNodes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Nodes with data ready to send: {}&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>readyNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Created {} produce requests: {}&quot;</span><span class="token punctuation">,</span> requests<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requests<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pollTimeout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å‘é€æ•°æ®ï¼Œè¿™é‡Œåªæ˜¯åœ¨ select æ³¨å†Œ op_writeï¼Œå¹¶åœ¨ channel æ·»åŠ  send</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ClientRequest</span> request <span class="token operator">:</span> requests<span class="token punctuation">)</span>
        client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// å¦‚æœéœ€è¦æœ‰æ•°æ®å‘é€ï¼Œselect.poll(0)ï¼Œä¸ç­‰å¾…ç›´æ¥è¿”å›ï¼Œå› ä¸ºæœ‰æ•°æ®è¦å‘é€</span>
    <span class="token comment">// å¦‚æœæ²¡æœ‰éœ€è¦å‘é€çš„æ•°æ®ï¼Œselect.poll(timeout)ï¼Œè·ç¦»ä¸‹æ¬¡æœ‰æ•°æ®è¦å‘é€çš„é—´éš”(linger ms)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>pollTimeout<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>sender çº¿ç¨‹é€»è¾‘å¾ˆæ¸…æ™°ï¼š</p> <ul><li>while ä»¥ä¸‹æ­¥éª¤</li> <li>æ£€æŸ¥ç¼“å†²åŒºä¸­æ»¡è¶³<strong>å‘é€æ¡ä»¶</strong>çš„ recordBatch</li> <li>æ£€æŸ¥è¦å‘é€çš„ recordBatch çš„å…ƒæ•°æ®æ˜¯å¦å·²å‡†å¤‡</li> <li>åˆ é™¤æœªå»ºç«‹è¿æ¥çš„ kafka node(æœªè¿æ¥æ—¶ä¼šå‘èµ·è¿æ¥äº‹ä»¶)</li> <li>è·å–å·²å»ºç«‹è¿æ¥ kafka node çš„ recordBatch</li> <li>å°† recordBatchs å°è£…æˆ ClientRequest</li> <li>å‘é€ ClientRequest</li> <li>poll</li></ul> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409181352804.jpeg" alt="img"></p> <h4 id="å‘èµ·è¿æ¥"><a href="#å‘èµ·è¿æ¥" class="header-anchor">#</a> å‘èµ·è¿æ¥</h4> <p>ç¨‹åºåˆšè¿è¡Œçš„æ—¶å€™è‚¯å®šæ˜¯æ²¡æœ‰å»ºç«‹è¿æ¥ï¼Œå½“å‘ç°æœ‰ recordbatch éœ€è¦å‘é€æ—¶ä¼šå…ˆåˆ¤æ–­æ˜¯å¦å·²è¿æ¥ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// this.client.ready(node, now)</span>
<span class="token comment">// org.apache.kafka.clients.NetworkClient</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">ready</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">,</span> <span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot connect to empty node &quot;</span> <span class="token operator">+</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// entry</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isReady</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">// æœªè¿æ¥æˆ–å¤±å»è¿æ¥ï¼Œåˆå§‹åŒ–</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>connectionStates<span class="token punctuation">.</span><span class="token function">canConnect</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">idString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// selector.connect: OP_CONNECT</span>
      <span class="token function">initiateConnect</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/** * æ£€æŸ¥æ˜¯å¦å¯ä»¥å‘å½“å‰ kafka node å‘é€æ¶ˆæ¯ï¼š * å…ƒæ•°æ®åŒ…å«å½“å‰ kafka node * ä¸å½“å‰ kafka node connection å·²å»ºç«‹ * ä¸å½“å‰ kafka node channel å·²å»ºç«‹ * å‘é€ batch è¯·æ±‚æ•°æœªè¶…è¿‡æŒ‡å®šçš„æœ€å¤§å€¼(é»˜è®¤5) */</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isReady</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">,</span> <span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// if we need to update our metadata now declare all requests unready to make metadata requests first</span>
    <span class="token comment">// priority</span>
    <span class="token keyword">return</span> <span class="token operator">!</span>metadataUpdater<span class="token punctuation">.</span><span class="token function">isUpdateDue</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">canSendRequest</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">idString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="clientrequest"><a href="#clientrequest" class="header-anchor">#</a> ClientRequest</h4> <p>è¦å‘é€çš„ recordBatch å°è£…æˆ ClientRequest</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// List&lt;ClientRequest&gt; requests = createProduceRequests(batches, now);</span>
<span class="token comment">// org.apache.kafka.clients.producer.internals.Sender</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientRequest</span><span class="token punctuation">&gt;</span></span> <span class="token function">createProduceRequests</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">RecordBatch</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> collated<span class="token punctuation">,</span> <span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientRequest</span><span class="token punctuation">&gt;</span></span> requests <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientRequest</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>collated<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">RecordBatch</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> collated<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// åˆ›å»ºè¯·æ±‚ï¼šacks éå¸¸é‡è¦ï¼ŒrequestTimeout é»˜è®¤ 30s</span>
      <span class="token comment">// å°†åŒä¸ª node ä¸Šçš„å¤šä¸ª batchç»„è£…åœ¨ä¸€èµ·</span>
      requests<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">produceRequest</span><span class="token punctuation">(</span>now<span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> acks<span class="token punctuation">,</span> requestTimeout<span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> requests<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token class-name">ClientRequest</span> <span class="token function">produceRequest</span><span class="token punctuation">(</span><span class="token keyword">long</span> now<span class="token punctuation">,</span> <span class="token keyword">int</span> destination<span class="token punctuation">,</span> <span class="token keyword">short</span> acks<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RecordBatch</span><span class="token punctuation">&gt;</span></span> batches<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">&gt;</span></span> produceRecordsByPartition <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>batches<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">RecordBatch</span><span class="token punctuation">&gt;</span></span> recordsByPartition <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">RecordBatch</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>batches<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RecordBatch</span> batch <span class="token operator">:</span> batches<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">TopicPartition</span> tp <span class="token operator">=</span> batch<span class="token punctuation">.</span>topicPartition<span class="token punctuation">;</span>
      produceRecordsByPartition<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>tp<span class="token punctuation">,</span> batch<span class="token punctuation">.</span>records<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      recordsByPartition<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>tp<span class="token punctuation">,</span> batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token class-name">ProduceRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProduceRequest</span><span class="token punctuation">(</span>acks<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> produceRecordsByPartition<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// recordBatch æ•°æ®å­˜åˆ° RequestSend æ•°æ®ç»“æ„</span>
  <span class="token class-name">RequestSend</span> send <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RequestSend</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>destination<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                      <span class="token comment">// ApiKeys.PRODUCE æ ‡è¯†ç¬¦ï¼ŒæœåŠ¡ç«¯ä¼šæ ¹æ®è¿™ä¸ªæ ‡è¯†ç¬¦å¤„ç†</span>
                                      <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">nextRequestHeader</span><span class="token punctuation">(</span><span class="token class-name">ApiKeys</span><span class="token punctuation">.</span><span class="token constant">PRODUCE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                      request<span class="token punctuation">.</span><span class="token function">toStruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è®¾ç½®è¯·æ±‚ç»“æŸçš„å›è°ƒå‡½æ•°ï¼Œåç»­åœ¨å“åº”ä¼šç”¨åˆ° </span>
  <span class="token class-name">RequestCompletionHandler</span> callback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RequestCompletionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onComplete</span><span class="token punctuation">(</span><span class="token class-name">ClientResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">handleProduceResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> recordsByPartition<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ClientRequest</span><span class="token punctuation">(</span>now<span class="token punctuation">,</span> acks <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> send<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="å“åº”"><a href="#å“åº”" class="header-anchor">#</a> å“åº”</h4> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// this.client.poll(pollTimeout, now);</span>
<span class="token comment">// org.apache.kafka.clients.NetworkClient</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientResponse</span><span class="token punctuation">&gt;</span></span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// æ˜¯å¦éœ€è¦æ›´æ–°å…ƒæ•°æ®</span>
  <span class="token keyword">long</span> metadataTimeout <span class="token operator">=</span> metadataUpdater<span class="token punctuation">.</span><span class="token function">maybeUpdate</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// selector.pollï¼Œå¤„ç† OP_CONNECTã€OP_WRITEã€OP_READ äº‹ä»¶</span>
      <span class="token comment">// OP_READ é€šè¿‡ nio read -&gt; completedReceives</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> metadataTimeout<span class="token punctuation">,</span> requestTimeoutMs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Unexpected error during I/O&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// process completed actions</span>
  <span class="token keyword">long</span> updatedNow <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>time<span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientResponse</span><span class="token punctuation">&gt;</span></span> responses <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å¤„ç†å·²å‘é€çš„ send(recordBatch)</span>
  <span class="token comment">// responses.add(new ClientResponse(request, now, false, null));</span>
  <span class="token function">handleCompletedSends</span><span class="token punctuation">(</span>responses<span class="token punctuation">,</span> updatedNow<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å¤„ç†è¿”å›çš„å“åº”</span>
  <span class="token comment">// responses.add(new ClientResponse(req, now, false, body));</span>
  <span class="token function">handleCompletedReceives</span><span class="token punctuation">(</span>responses<span class="token punctuation">,</span> updatedNow<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">handleDisconnections</span><span class="token punctuation">(</span>responses<span class="token punctuation">,</span> updatedNow<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">handleConnections</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å¤„ç†è¶…æ—¶çš„è¯·æ±‚</span>
  <span class="token function">handleTimedOutRequests</span><span class="token punctuation">(</span>responses<span class="token punctuation">,</span> updatedNow<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// invoke callbacks</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ClientResponse</span> response <span class="token operator">:</span> responses<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token comment">// å›è°ƒè¯·æ±‚çš„ callbackï¼ŒhandleProduceResponse</span>
              response<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onComplete</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Uncaught error in request completion:&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> responses<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>å‘é€ç»“æŸçš„å“åº”</li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// org.apache.kafka.clients.NetworkClient</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleCompletedSends</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientResponse</span><span class="token punctuation">&gt;</span></span> responses<span class="token punctuation">,</span> <span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// completedSends.add(send); selector write æ—¶åŠ å…¥</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Send</span> send <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">.</span><span class="token function">completedSends</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ClientRequest</span> request <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>inFlightRequests<span class="token punctuation">.</span><span class="token function">lastSent</span><span class="token punctuation">(</span>send<span class="token punctuation">.</span><span class="token function">destination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>request<span class="token punctuation">.</span><span class="token function">expectResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment">// ack = 0ï¼Œæ‰ä¼šæ„å»º send ç»“æŸå“åº”ï¼Œè¿™ç§æ–¹å¼ä¸éœ€è¦æœåŠ¡ç«¯è¿”å›ç»“æœ</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>inFlightRequests<span class="token punctuation">.</span><span class="token function">completeLastSent</span><span class="token punctuation">(</span>send<span class="token punctuation">.</span><span class="token function">destination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// responseBody ä¸º null</span>
            responses<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClientResponse</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> now<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>æœåŠ¡ç«¯è¿”å›çš„å“åº”</li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleCompletedReceives</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientResponse</span><span class="token punctuation">&gt;</span></span> responses<span class="token punctuation">,</span> <span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">NetworkReceive</span> receive <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">.</span><span class="token function">completedReceives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">String</span> source <span class="token operator">=</span> receive<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">ClientRequest</span> req <span class="token operator">=</span> inFlightRequests<span class="token punctuation">.</span><span class="token function">completeNext</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// receive çš„äºŒè¿›åˆ¶è§£ææˆå¯è¯†åˆ«çš„æ•°æ®</span>
      <span class="token class-name">Struct</span> body <span class="token operator">=</span> <span class="token function">parseResponse</span><span class="token punctuation">(</span>receive<span class="token punctuation">.</span><span class="token function">payload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>metadataUpdater<span class="token punctuation">.</span><span class="token function">maybeHandleCompletedReceive</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> now<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token comment">// responseBody æœ‰å€¼</span>
          responses<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClientResponse</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> now<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>è¶…æ—¶è¯·æ±‚çš„å“åº”</li></ul> <div class="language- extra-class"><pre class="language-text"><code>private void processDisconnection(List&lt;ClientResponse&gt; responses, String nodeId, long now) {
  connectionStates.disconnected(nodeId, now);
  for (ClientRequest request : this.inFlightRequests.clearAll(nodeId)) {
      log.trace(&quot;Cancelled request {} due to node {} being disconnected&quot;, request, nodeId);
      if (!metadataUpdater.maybeHandleDisconnection(request))
          // responseBody ä¸º null ä¸” disconnected ä¸º true
          responses.add(new ClientResponse(request, now, true, null));
  }
}
</code></pre></div><ul><li>å¤„ç†å“åº”</li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// org.apache.kafka.clients.producer.internals.Sender</span>
<span class="token comment">// è¯·æ±‚å›è°ƒ</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleProduceResponse</span><span class="token punctuation">(</span><span class="token class-name">ClientResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">RecordBatch</span><span class="token punctuation">&gt;</span></span> batches<span class="token punctuation">,</span> <span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// batches = å‘é€è¯·æ±‚æ—¶æºå¸¦çš„ recordBatch</span>
  <span class="token comment">// completeBatch</span>
  <span class="token keyword">int</span> correlationId <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">correlationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">wasDisconnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¤±å»è¿æ¥</span>
      log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Cancelled request {} due to node {} being disconnected&quot;</span><span class="token punctuation">,</span> response<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                                                                            <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                                                                            <span class="token punctuation">.</span><span class="token function">destination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Errors = Errors.NETWORK_EXCEPTIONï¼Œ</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RecordBatch</span> batch <span class="token operator">:</span> batches<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token function">completeBatch</span><span class="token punctuation">(</span>batch<span class="token punctuation">,</span> <span class="token class-name">Errors</span><span class="token punctuation">.</span><span class="token constant">NETWORK_EXCEPTION</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token class-name">Record</span><span class="token punctuation">.</span><span class="token constant">NO_TIMESTAMP</span><span class="token punctuation">,</span> correlationId<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Received produce response from node {} with correlation id {}&quot;</span><span class="token punctuation">,</span>
                response<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">destination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                correlationId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">hasResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// ack != 0</span>
          <span class="token class-name">ProduceResponse</span> produceResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProduceResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">responseBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">ProduceResponse<span class="token punctuation">.</span>PartitionResponse</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> produceResponse<span class="token punctuation">.</span><span class="token function">responses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// æ¯ä¸ª batch å¤„ç†</span>
              <span class="token class-name">TopicPartition</span> tp <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token class-name">ProduceResponse<span class="token punctuation">.</span>PartitionResponse</span> partResp <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token class-name">Errors</span> error <span class="token operator">=</span> <span class="token class-name">Errors</span><span class="token punctuation">.</span><span class="token function">forCode</span><span class="token punctuation">(</span>partResp<span class="token punctuation">.</span>errorCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token class-name">RecordBatch</span> batch <span class="token operator">=</span> batches<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tp<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">completeBatch</span><span class="token punctuation">(</span>batch<span class="token punctuation">,</span> error<span class="token punctuation">,</span> partResp<span class="token punctuation">.</span>baseOffset<span class="token punctuation">,</span> partResp<span class="token punctuation">.</span>timestamp<span class="token punctuation">,</span> correlationId<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>sensors<span class="token punctuation">.</span><span class="token function">recordLatency</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">destination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">requestLatencyMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>sensors<span class="token punctuation">.</span><span class="token function">recordThrottleTime</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">destination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                          produceResponse<span class="token punctuation">.</span><span class="token function">getThrottleTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// ack = 0</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RecordBatch</span> batch <span class="token operator">:</span> batches<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token function">completeBatch</span><span class="token punctuation">(</span>batch<span class="token punctuation">,</span> <span class="token class-name">Errors</span><span class="token punctuation">.</span><span class="token constant">NONE</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token class-name">Record</span><span class="token punctuation">.</span><span class="token constant">NO_TIMESTAMP</span><span class="token punctuation">,</span> correlationId<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// recordBatch å¤„ç†</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">completeBatch</span><span class="token punctuation">(</span><span class="token class-name">RecordBatch</span> batch<span class="token punctuation">,</span> <span class="token class-name">Errors</span> error<span class="token punctuation">,</span> <span class="token keyword">long</span> baseOffset<span class="token punctuation">,</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token keyword">long</span> correlationId<span class="token punctuation">,</span> <span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> <span class="token class-name">Errors</span><span class="token punctuation">.</span><span class="token constant">NONE</span> <span class="token operator">&amp;&amp;</span> <span class="token function">canRetry</span><span class="token punctuation">(</span>batch<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// æœ‰å¼‚å¸¸ä¸”å¯ä»¥é‡æ–°å‘é€</span>
      <span class="token comment">// retry</span>
      log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Got error produce response with correlation id {} on topic-partition {}, retrying ({} attempts left). Error: {}&quot;</span><span class="token punctuation">,</span>
                correlationId<span class="token punctuation">,</span>
                batch<span class="token punctuation">.</span>topicPartition<span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>retries <span class="token operator">-</span> batch<span class="token punctuation">.</span>attempts <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
                error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// é‡æ–°åŠ å…¥ ç¼“å†²åŒº</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator<span class="token punctuation">.</span><span class="token function">reenqueue</span><span class="token punctuation">(</span>batch<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ— å¼‚å¸¸</span>
      <span class="token comment">// æœ‰å¼‚å¸¸ä¸”ä¸å¯ä»¥é‡æ–°å‘é€</span>
      <span class="token class-name">RuntimeException</span> exception<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">==</span> <span class="token class-name">Errors</span><span class="token punctuation">.</span><span class="token constant">TOPIC_AUTHORIZATION_FAILED</span><span class="token punctuation">)</span>
          exception <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TopicAuthorizationException</span><span class="token punctuation">(</span>batch<span class="token punctuation">.</span>topicPartition<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">else</span>
          exception <span class="token operator">=</span> error<span class="token punctuation">.</span><span class="token function">exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// record å›è°ƒå‡½æ•°</span>
      batch<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span>baseOffset<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// recordBatch å‘é€ç»“æŸï¼Œå†…å­˜æ± å›æ”¶è¯¥å†…å­˜</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator<span class="token punctuation">.</span><span class="token function">deallocate</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token comment">// record å›è°ƒ producer.send(,callback)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">long</span> baseOffset<span class="token punctuation">,</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">RuntimeException</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// thunks = records</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>thunks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token class-name">Thunk</span> thunk <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>thunks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// If the timestamp returned by server is NoTimestamp, that means CreateTime is used. Otherwise LogAppendTime is used.</span>
              <span class="token class-name">RecordMetadata</span> metadata <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RecordMetadata</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>topicPartition<span class="token punctuation">,</span>  baseOffset<span class="token punctuation">,</span> thunk<span class="token punctuation">.</span>future<span class="token punctuation">.</span><span class="token function">relativeOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                            timestamp <span class="token operator">==</span> <span class="token class-name">Record</span><span class="token punctuation">.</span><span class="token constant">NO_TIMESTAMP</span> <span class="token operator">?</span> thunk<span class="token punctuation">.</span>future<span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> timestamp<span class="token punctuation">,</span>
                                                            thunk<span class="token punctuation">.</span>future<span class="token punctuation">.</span><span class="token function">checksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                            thunk<span class="token punctuation">.</span>future<span class="token punctuation">.</span><span class="token function">serializedKeySize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                            thunk<span class="token punctuation">.</span>future<span class="token punctuation">.</span><span class="token function">serializedValueSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// æ— å¼‚å¸¸æ—¶ record å›è°ƒå‡½æ•°</span>
              thunk<span class="token punctuation">.</span>callback<span class="token punctuation">.</span><span class="token function">onCompletion</span><span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token comment">// æœ‰å¼‚å¸¸æ—¶ record å›è°ƒå‡½æ•°</span>
              thunk<span class="token punctuation">.</span>callback<span class="token punctuation">.</span><span class="token function">onCompletion</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409181354231.jpeg" alt="img"></p> <h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="header-anchor">#</a> æ€»ç»“</h2> <h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="header-anchor">#</a> å‚è€ƒèµ„æ–™</h2> <ul><li><a href="https://vendanner.github.io/2018/04/15/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-Kafka-%E4%B9%8B-Producer/" target="_blank" rel="noopener noreferrer">æ·±å…¥ç†è§£ Kafka ä¹‹ Producer - é˜¿é£çš„åšå®¢ | Danner Blog (vendanner.github.io)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/echo-lxy/echo-system-design/edit/master/docs/02.Kafka  ç³»ç»Ÿè®¾è®¡/06.ä¸‰ã€ä¸»çº¿ä»»åŠ¡/05.ç”Ÿäº§è€….md" target="_blank" rel="noopener noreferrer">ç¼–è¾‘</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°äº:</span> <span class="time">2024/09/18, 11:29:27</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        â†
        <a href="/echo-system-design/pages/46a58a/" class="prev">Kafka æ•´ä½“æ¶æ„</a></span> <span class="next"><a href="/echo-system-design/pages/aa0392/">Broker</a>â†’
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:lixinyang2002@163.com" title="å‘é‚®ä»¶" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/echo-lxy" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="å¬éŸ³ä¹" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="æœ¬ç«™ä¸»é¢˜">Vdoing</a> 
    | Copyright Â© 2024-2024
    <span>Xinyang Li | MIT License</span></div> <div class="buttons"><div title="è¿”å›é¡¶éƒ¨" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="å»è¯„è®º" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ä¸»é¢˜æ¨¡å¼" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          è·Ÿéšç³»ç»Ÿ
        </li><li class="iconfont icon-rijianmoshi">
          æµ…è‰²æ¨¡å¼
        </li><li class="iconfont icon-yejianmoshi">
          æ·±è‰²æ¨¡å¼
        </li><li class="iconfont icon-yuedu">
          é˜…è¯»æ¨¡å¼
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/echo-system-design/assets/js/app.29ec2c17.js" defer></script><script src="/echo-system-design/assets/js/2.933750c6.js" defer></script><script src="/echo-system-design/assets/js/18.4e49fa9b.js" defer></script><script src="/echo-system-design/assets/js/7.7eb70372.js" defer></script>
  </body>
</html>
