<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Bootstrapï¼ˆserverï¼‰æºç è§£æ | EchoDesign</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="ç³»ç»Ÿè®¾è®¡ä¹‹ã€Œè®²è§£ + é¢è¯•æŒ‡å—ã€ï¼Œæ°´æ»´çŸ³ç©¿ï¼Œè®¾è®¡æ— é“¶å¼¹ï¼">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.c76c3453.css" as="style"><link rel="preload" href="/assets/js/app.6c7acbd0.js" as="script"><link rel="preload" href="/assets/js/2.933750c6.js" as="script"><link rel="preload" href="/assets/js/45.685623ac.js" as="script"><link rel="preload" href="/assets/js/7.7eb70372.js" as="script"><link rel="prefetch" href="/assets/js/10.2cc95be8.js"><link rel="prefetch" href="/assets/js/100.2b21dce5.js"><link rel="prefetch" href="/assets/js/101.09d5e594.js"><link rel="prefetch" href="/assets/js/11.c7521a10.js"><link rel="prefetch" href="/assets/js/12.38d1989d.js"><link rel="prefetch" href="/assets/js/13.8ddd597e.js"><link rel="prefetch" href="/assets/js/14.397b7600.js"><link rel="prefetch" href="/assets/js/15.b3c76984.js"><link rel="prefetch" href="/assets/js/16.831e5a24.js"><link rel="prefetch" href="/assets/js/17.acb3bf3d.js"><link rel="prefetch" href="/assets/js/18.e491edb6.js"><link rel="prefetch" href="/assets/js/19.daf31819.js"><link rel="prefetch" href="/assets/js/20.cb4a5c13.js"><link rel="prefetch" href="/assets/js/21.24c0f101.js"><link rel="prefetch" href="/assets/js/22.7d106f59.js"><link rel="prefetch" href="/assets/js/23.623f0b5d.js"><link rel="prefetch" href="/assets/js/24.6ba53300.js"><link rel="prefetch" href="/assets/js/25.1fb855d9.js"><link rel="prefetch" href="/assets/js/26.0146252c.js"><link rel="prefetch" href="/assets/js/27.de80589e.js"><link rel="prefetch" href="/assets/js/28.d4ca2c30.js"><link rel="prefetch" href="/assets/js/29.7325b5ce.js"><link rel="prefetch" href="/assets/js/3.5c09ac9d.js"><link rel="prefetch" href="/assets/js/30.892b2994.js"><link rel="prefetch" href="/assets/js/31.a532917f.js"><link rel="prefetch" href="/assets/js/32.13b70e91.js"><link rel="prefetch" href="/assets/js/33.64ab8d0c.js"><link rel="prefetch" href="/assets/js/34.6d3cc288.js"><link rel="prefetch" href="/assets/js/35.5b49d706.js"><link rel="prefetch" href="/assets/js/36.be98cc35.js"><link rel="prefetch" href="/assets/js/37.ead210df.js"><link rel="prefetch" href="/assets/js/38.9f396b5a.js"><link rel="prefetch" href="/assets/js/39.8409097b.js"><link rel="prefetch" href="/assets/js/4.73518a0f.js"><link rel="prefetch" href="/assets/js/40.0ada49bd.js"><link rel="prefetch" href="/assets/js/41.fcee3e0f.js"><link rel="prefetch" href="/assets/js/42.b34f1599.js"><link rel="prefetch" href="/assets/js/43.5a509601.js"><link rel="prefetch" href="/assets/js/44.64fd3383.js"><link rel="prefetch" href="/assets/js/46.7624d38c.js"><link rel="prefetch" href="/assets/js/47.86be3d8d.js"><link rel="prefetch" href="/assets/js/48.ba7dfd47.js"><link rel="prefetch" href="/assets/js/49.ee9681bc.js"><link rel="prefetch" href="/assets/js/5.94727770.js"><link rel="prefetch" href="/assets/js/50.3e91aa07.js"><link rel="prefetch" href="/assets/js/51.ad7a3e32.js"><link rel="prefetch" href="/assets/js/52.08ad747c.js"><link rel="prefetch" href="/assets/js/53.5ee4652a.js"><link rel="prefetch" href="/assets/js/54.0bbf2ba5.js"><link rel="prefetch" href="/assets/js/55.0edcba5d.js"><link rel="prefetch" href="/assets/js/56.5ecf867d.js"><link rel="prefetch" href="/assets/js/57.72ba41a6.js"><link rel="prefetch" href="/assets/js/58.7144aef6.js"><link rel="prefetch" href="/assets/js/59.f96f0065.js"><link rel="prefetch" href="/assets/js/6.0b558b79.js"><link rel="prefetch" href="/assets/js/60.66a7f41d.js"><link rel="prefetch" href="/assets/js/61.08b4acf0.js"><link rel="prefetch" href="/assets/js/62.cc8fdced.js"><link rel="prefetch" href="/assets/js/63.41ff19e4.js"><link rel="prefetch" href="/assets/js/64.9b3def35.js"><link rel="prefetch" href="/assets/js/65.0b2ab47d.js"><link rel="prefetch" href="/assets/js/66.2ae7a107.js"><link rel="prefetch" href="/assets/js/67.79dd6daf.js"><link rel="prefetch" href="/assets/js/68.1b76c178.js"><link rel="prefetch" href="/assets/js/69.7ac52a2f.js"><link rel="prefetch" href="/assets/js/70.7279b1df.js"><link rel="prefetch" href="/assets/js/71.f44644ed.js"><link rel="prefetch" href="/assets/js/72.c8cf2fab.js"><link rel="prefetch" href="/assets/js/73.526febf1.js"><link rel="prefetch" href="/assets/js/74.d9ad1a67.js"><link rel="prefetch" href="/assets/js/75.90fd56c9.js"><link rel="prefetch" href="/assets/js/76.32858593.js"><link rel="prefetch" href="/assets/js/77.7b3f6980.js"><link rel="prefetch" href="/assets/js/78.31a353ef.js"><link rel="prefetch" href="/assets/js/79.173bbc8c.js"><link rel="prefetch" href="/assets/js/8.0ec7f6e8.js"><link rel="prefetch" href="/assets/js/80.d8713e74.js"><link rel="prefetch" href="/assets/js/81.d124398a.js"><link rel="prefetch" href="/assets/js/82.3b90a7cc.js"><link rel="prefetch" href="/assets/js/83.f3a9ee0c.js"><link rel="prefetch" href="/assets/js/84.1fd412a9.js"><link rel="prefetch" href="/assets/js/85.f69467b2.js"><link rel="prefetch" href="/assets/js/86.931cbb70.js"><link rel="prefetch" href="/assets/js/87.78b2eebd.js"><link rel="prefetch" href="/assets/js/88.605444aa.js"><link rel="prefetch" href="/assets/js/89.e05e3a70.js"><link rel="prefetch" href="/assets/js/9.6e274fca.js"><link rel="prefetch" href="/assets/js/90.ca1ff100.js"><link rel="prefetch" href="/assets/js/91.8ad18b18.js"><link rel="prefetch" href="/assets/js/92.b554f1c7.js"><link rel="prefetch" href="/assets/js/93.fb2397b7.js"><link rel="prefetch" href="/assets/js/94.1eade7f0.js"><link rel="prefetch" href="/assets/js/95.96f5db04.js"><link rel="prefetch" href="/assets/js/96.5ed2d348.js"><link rel="prefetch" href="/assets/js/97.0154143f.js"><link rel="prefetch" href="/assets/js/98.8d8d41db.js"><link rel="prefetch" href="/assets/js/99.690e4395.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c76c3453.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="ç›®å½•" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="EchoDesign" class="logo"> <span class="site-name can-hide">EchoDesign</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">ğŸ é¦–é¡µ</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">âœ’ï¸çƒ­é—¨ç®—æ³•</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ğŸ–ï¸èµæç»å…¸è®¾è®¡" class="dropdown-title"><!----> <span class="title" style="display:;">ğŸ–ï¸èµæç»å…¸è®¾è®¡</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ç³»ç»Ÿè®¾è®¡</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ğŸ§‘â€ğŸ’»å®æˆ˜ç³»ç»Ÿè®¾è®¡</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">â“é—®ç­”</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ğŸ‘€åŠ¨æ€</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">ğŸ é¦–é¡µ</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">âœ’ï¸çƒ­é—¨ç®—æ³•</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ğŸ–ï¸èµæç»å…¸è®¾è®¡" class="dropdown-title"><!----> <span class="title" style="display:;">ğŸ–ï¸èµæç»å…¸è®¾è®¡</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ç³»ç»Ÿè®¾è®¡</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ğŸ§‘â€ğŸ’»å®æˆ˜ç³»ç»Ÿè®¾è®¡</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">â“é—®ç­”</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ğŸ‘€åŠ¨æ€</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ä¸€ã€å‰è¨€</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>äºŒã€åŸºç¡€çŸ¥è¯†</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>ä¸‰ã€ä¸»çº¿ä»»åŠ¡</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/b0bc66/" class="sidebar-link">Netty æ¡†æ¶æ¦‚è¿°</a></li><li><a href="/pages/9582d0/" class="sidebar-link">Bootstrapï¼ˆclientï¼‰æºç è§£æ</a></li><li><a href="/pages/b2a14a/" aria-current="page" class="active sidebar-link">Bootstrapï¼ˆserverï¼‰æºç è§£æ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/b2a14a/#æœåŠ¡å™¨ç«¯" class="sidebar-link">æœåŠ¡å™¨ç«¯</a></li><li class="sidebar-sub-header level2"><a href="/pages/b2a14a/#åè®°" class="sidebar-link">åè®°</a></li></ul></li><li><a href="/pages/8d1ba9/Channel/" class="sidebar-link">Channel æºç è§£æ</a></li><li><a href="/pages/397456/" class="sidebar-link">EventLoop æºç è§£æ</a></li><li><a href="/pages/ce1f78/" class="sidebar-link">ChannelHandler æºç è§£æ</a></li><li><a href="/pages/4234c0/" class="sidebar-link">ChannelPipeline æºç è§£æ</a></li><li><a href="/pages/43eb30/" class="sidebar-link">ByteBuf æºç è§£æ</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>å››ã€æ·±å…¥ Netty æ ¸å¿ƒ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>äº”ã€æ·±å…¥ Netty å†…å­˜ç®¡ç†</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="é¦–é¡µ" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>Netty ç³»ç»Ÿè®¾è®¡</span></li><li data-v-06225672><span data-v-06225672>ä¸‰ã€ä¸»çº¿ä»»åŠ¡</span></li></ul> <div class="info" data-v-06225672><div title="ä½œè€…" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/brother-one" target="_blank" title="ä½œè€…" class="beLink" data-v-06225672>echo</a></div> <div title="åˆ›å»ºæ—¶é—´" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-09-18</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">ç›®å½•</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">Bootstrapï¼ˆserverï¼‰æºç è§£æ<!----></h1> <div class="page-slot page-slot-top">
    <div class="wwads-cn wwads-horizontal page-wwads" data-id="136"></div>
    <style>
      .page-wwads{
        width:100%!important;
        min-height: 0;
        margin: 0;
      }
      .page-wwads .wwads-img img{
        width:80px!important;
      }
      .page-wwads .wwads-poweredby{
        width: 40px;
        position: absolute;
        right: 25px;
        bottom: 3px;
      }
      .wwads-content .wwads-text, .page-wwads .wwads-text{
        height: 100%;
        padding-top: 5px;
        display: block;
      }
  </style>
  </div> <div class="theme-vdoing-content content__default"><h2 id="æœåŠ¡å™¨ç«¯"><a href="#æœåŠ¡å™¨ç«¯" class="header-anchor">#</a> æœåŠ¡å™¨ç«¯</h2> <p>åœ¨åˆ†æå®¢æˆ·ç«¯çš„ä»£ç æ—¶, æˆ‘ä»¬å·²ç»å¯¹ Bootstrap å¯åŠ¨ Netty æœ‰äº†ä¸€ä¸ªå¤§è‡´çš„è®¤è¯†, é‚£ä¹ˆæ¥ä¸‹æ¥åˆ†ææœåŠ¡å™¨ç«¯æ—¶, å°±ä¼šç›¸å¯¹ç®€å•ä¸€äº›äº†. é¦–å…ˆè¿˜æ˜¯æ¥çœ‹ä¸€ä¸‹æœåŠ¡å™¨ç«¯çš„å¯åŠ¨ä»£ç :</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">EchoServer</span> <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token constant">SSL</span> <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;ssl&quot;</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">PORT</span> <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;port&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;8007&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// Configure SSL.</span>
        <span class="token keyword">final</span> <span class="token class-name">SslContext</span> sslCtx<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">SSL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">SelfSignedCertificate</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SelfSignedCertificate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sslCtx <span class="token operator">=</span> <span class="token class-name">SslContextBuilder</span><span class="token punctuation">.</span><span class="token function">forServer</span><span class="token punctuation">(</span>ssc<span class="token punctuation">.</span><span class="token function">certificate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ssc<span class="token punctuation">.</span><span class="token function">privateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            sslCtx <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Configure the server.</span>
        <span class="token class-name">EventLoopGroup</span> bossGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EventLoopGroup</span> workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>
             <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_BACKLOG</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoggingHandler</span><span class="token punctuation">(</span><span class="token class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">INFO</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 <span class="token annotation punctuation">@Override</span>
                 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                     <span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token keyword">if</span> <span class="token punctuation">(</span>sslCtx <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                         p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>sslCtx<span class="token punctuation">.</span><span class="token function">newHandler</span><span class="token punctuation">(</span>ch<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token punctuation">}</span>
                     <span class="token comment">//p.addLast(new LoggingHandler(LogLevel.INFO));</span>
                     p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EchoServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token punctuation">}</span>
             <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Start the server.</span>
            <span class="token class-name">ChannelFuture</span> f <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Wait until the server socket is closed.</span>
            f<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// Shut down all event loops to terminate all threads.</span>
            bossGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            workerGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å’Œå®¢æˆ·ç«¯çš„ä»£ç ç›¸æ¯”, æ²¡æœ‰å¾ˆå¤§çš„å·®åˆ«, åŸºæœ¬ä¸Šä¹Ÿæ˜¯è¿›è¡Œäº†å¦‚ä¸‹å‡ ä¸ªéƒ¨åˆ†çš„åˆå§‹åŒ–:</p> <ol><li>EventLoopGroup: ä¸è®ºæ˜¯æœåŠ¡å™¨ç«¯è¿˜æ˜¯å®¢æˆ·ç«¯, éƒ½å¿…é¡»æŒ‡å®š EventLoopGroup. åœ¨è¿™ä¸ªä¾‹å­ä¸­, æŒ‡å®šäº† NioEventLoopGroup, è¡¨ç¤ºä¸€ä¸ª NIO çš„ EventLoopGroup, ä¸è¿‡æœåŠ¡å™¨ç«¯éœ€è¦æŒ‡å®šä¸¤ä¸ª EventLoopGroup, ä¸€ä¸ªæ˜¯ bossGroup, ç”¨äºå¤„ç†å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚; å¦ä¸€ä¸ªæ˜¯ workerGroup, ç”¨äºå¤„ç†ä¸å„ä¸ªå®¢æˆ·ç«¯è¿æ¥çš„ IO æ“ä½œ</li> <li>ChannelType: æŒ‡å®š Channel çš„ç±»å‹. å› ä¸ºæ˜¯æœåŠ¡å™¨ç«¯, å› æ­¤ä½¿ç”¨äº† NioServerSocketChannel</li> <li>Handler: è®¾ç½®æ•°æ®çš„å¤„ç†å™¨</li></ol> <h3 id="channel-çš„åˆå§‹åŒ–è¿‡ç¨‹"><a href="#channel-çš„åˆå§‹åŒ–è¿‡ç¨‹" class="header-anchor">#</a> Channel çš„åˆå§‹åŒ–è¿‡ç¨‹</h3> <p>æˆ‘ä»¬åœ¨åˆ†æå®¢æˆ·ç«¯çš„ Channel åˆå§‹åŒ–è¿‡ç¨‹æ—¶, å·²ç»æåˆ°, Channel æ˜¯å¯¹ Java åº•å±‚ Socket è¿æ¥çš„æŠ½è±¡, å¹¶ä¸”çŸ¥é“äº†å®¢æˆ·ç«¯çš„ Channel çš„å…·ä½“ç±»å‹æ˜¯ NioSocketChannel, é‚£ä¹ˆè‡ªç„¶çš„, æœåŠ¡å™¨ç«¯çš„ Channel ç±»å‹å°±æ˜¯ NioServerSocketChannel äº†. é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬æŒ‰ç…§åˆ†æå®¢æˆ·ç«¯çš„æµç¨‹å¯¹æœåŠ¡å™¨ç«¯çš„ä»£ç ä¹ŸåŒæ ·åœ°åˆ†æä¸€é, è¿™æ ·ä¹Ÿæ–¹ä¾¿æˆ‘ä»¬å¯¹æ¯”ä¸€ä¸‹æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯æœ‰å“ªäº›ä¸ä¸€æ ·çš„åœ°æ–¹.</p> <h4 id="channel-ç±»å‹çš„ç¡®å®š"><a href="#channel-ç±»å‹çš„ç¡®å®š" class="header-anchor">#</a> Channel ç±»å‹çš„ç¡®å®š</h4> <p>åŒæ ·çš„åˆ†æå¥—è·¯, æˆ‘ä»¬å·²ç»çŸ¥é“äº†, åœ¨å®¢æˆ·ç«¯ä¸­, Channel çš„ç±»å‹å…¶å®æ˜¯åœ¨åˆå§‹åŒ–æ—¶, é€šè¿‡ Bootstrap.channel() æ–¹æ³•è®¾ç½®çš„, æœåŠ¡å™¨ç«¯è‡ªç„¶ä¹Ÿä¸ä¾‹å¤–</p> <p>åœ¨æœåŠ¡å™¨ç«¯, æˆ‘ä»¬è°ƒç”¨äº† ServerBootstarap.channel(NioServerSocketChannel.class), ä¼ é€’äº†ä¸€ä¸ª NioServerSocketChannel Class å¯¹è±¡. è¿™æ ·çš„è¯, æŒ‰ç…§å’Œåˆ†æå®¢æˆ·ç«¯ä»£ç ä¸€æ ·çš„æµç¨‹, æˆ‘ä»¬å°±å¯ä»¥ç¡®å®š, NioServerSocketChannel çš„å®ä¾‹åŒ–æ˜¯é€šè¿‡ BootstrapChannelFactory å·¥å‚ç±»æ¥å®Œæˆçš„, è€Œ BootstrapChannelFactory ä¸­çš„ clazz å­—æ®µè¢«è®¾ç½®ä¸ºäº† NioServerSocketChannel.class, å› æ­¤å½“è°ƒç”¨ BootstrapChannelFactory.newChannel() æ—¶:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">newChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// åˆ é™¤ try å—</span>
    <span class="token keyword">return</span> clazz<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å°±è·å–åˆ°äº†ä¸€ä¸ª NioServerSocketChannel çš„å®ä¾‹.</p> <p>æœ€åæˆ‘ä»¬ä¹Ÿæ¥æ€»ç»“ä¸€ä¸‹:</p> <ul><li>ServerBootstrap ä¸­çš„ ChannelFactory çš„å®ç°æ˜¯ BootstrapChannelFactory</li> <li>ç”Ÿæˆçš„ Channel çš„å…·ä½“ç±»å‹æ˜¯ NioServerSocketChannel. Channel çš„å®ä¾‹åŒ–è¿‡ç¨‹, å…¶å®å°±æ˜¯è°ƒç”¨çš„ ChannelFactory.newChannel æ–¹æ³•, è€Œå®ä¾‹åŒ–çš„ Channel çš„å…·ä½“çš„ç±»å‹åˆæ˜¯å’Œåœ¨åˆå§‹åŒ– ServerBootstrap æ—¶ä¼ å…¥çš„ channel() æ–¹æ³•çš„å‚æ•°ç›¸å…³. å› æ­¤å¯¹äºæˆ‘ä»¬è¿™ä¸ªä¾‹å­ä¸­çš„æœåŠ¡å™¨ç«¯çš„ ServerBootstrap è€Œè¨€, ç”Ÿæˆçš„çš„ Channel å®ä¾‹å°±æ˜¯ NioServerSocketChannel</li></ul> <h4 id="nioserversocketchannel-çš„å®ä¾‹åŒ–è¿‡ç¨‹"><a href="#nioserversocketchannel-çš„å®ä¾‹åŒ–è¿‡ç¨‹" class="header-anchor">#</a> NioServerSocketChannel çš„å®ä¾‹åŒ–è¿‡ç¨‹</h4> <p>é¦–å…ˆè¿˜æ˜¯æ¥çœ‹ä¸€ä¸‹ NioServerSocketChannel çš„å®ä¾‹åŒ–è¿‡ç¨‹. ä¸‹é¢æ˜¯ NioServerSocketChannel çš„ç±»å±‚æ¬¡ç»“æ„å›¾:</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409182203035.png" alt="NioServerSocketChannel ç±»å±‚æ¬¡ç»“æ„.png"></p> <p>é¦–å…ˆ, æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„é»˜è®¤çš„æ„é€ å™¨. å’Œ NioSocketChannel ç±»ä¼¼, æ„é€ å™¨éƒ½æ˜¯è°ƒç”¨äº† newSocket æ¥æ‰“å¼€ä¸€ä¸ª Java çš„ NIO Socket, ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯, å®¢æˆ·ç«¯çš„ newSocket è°ƒç”¨çš„æ˜¯ openSocketChannel, è€ŒæœåŠ¡å™¨ç«¯çš„ newSocket è°ƒç”¨çš„æ˜¯ openServerSocketChannel. é¡¾åæ€ä¹‰, ä¸€ä¸ªæ˜¯å®¢æˆ·ç«¯çš„ Java SocketChannel, ä¸€ä¸ªæ˜¯æœåŠ¡å™¨ç«¯çš„ Java ServerSocketChannel.</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token function">newSocket</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_SELECTOR_PROVIDER</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ServerSocketChannel</span> <span class="token function">newSocket</span><span class="token punctuation">(</span><span class="token class-name">SelectorProvider</span> provider<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> provider<span class="token punctuation">.</span><span class="token function">openServerSocketChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ¥ä¸‹æ¥ä¼šè°ƒç”¨é‡è½½çš„æ„é€ å™¨:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">(</span><span class="token class-name">ServerSocketChannel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> channel<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_ACCEPT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioServerSocketChannelConfig</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¿™ä¸ªæ„é€ å…¶ä¸­, è°ƒç”¨çˆ¶ç±»æ„é€ å™¨æ—¶, ä¼ å…¥çš„å‚æ•°æ˜¯ <strong>SelectionKey.OP_ACCEPT</strong>. ä½œä¸ºå¯¹æ¯”, æˆ‘ä»¬å›æƒ³ä¸€ä¸‹, åœ¨å®¢æˆ·ç«¯çš„ Channel åˆå§‹åŒ–æ—¶, ä¼ å…¥çš„å‚æ•°æ˜¯ <strong>SelectionKey.OP_READ</strong></p> <p>æœ‰ Java NIO Socket å¼€å‘ç»éªŒçš„æœ‹å‹å°±çŸ¥é“äº†, Java NIO æ˜¯ä¸€ç§ Reactor æ¨¡å¼, æˆ‘ä»¬é€šè¿‡ selector æ¥å®ç° I/O çš„å¤šè·¯å¤ç”¨å¤ç”¨. åœ¨ä¸€å¼€å§‹æ—¶, æœåŠ¡å™¨ç«¯éœ€è¦ç›‘å¬å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚, å› æ­¤åœ¨è¿™é‡Œæˆ‘ä»¬è®¾ç½®äº† <strong>SelectionKey.OP_ACCEPT</strong>, å³é€šçŸ¥ selector æˆ‘ä»¬å¯¹å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚æ„Ÿå…´è¶£.</p> <p>æ¥ç€å’Œå®¢æˆ·ç«¯çš„åˆ†æä¸€ä¸‹, ä¼šé€çº§åœ°è°ƒç”¨çˆ¶ç±»çš„æ„é€ å™¨ NioServerSocketChannel &lt;- AbstractNioMessageChannel &lt;- AbstractNioChannel &lt;- AbstractChannel.</p> <p>åŒæ ·çš„, åœ¨ AbstractChannel ä¸­ä¼šå®ä¾‹åŒ–ä¸€ä¸ª unsafe å’Œ pipeline:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">AbstractChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>
    unsafe <span class="token operator">=</span> <span class="token function">newUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pipeline <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultChannelPipeline</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸è¿‡, è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯, å®¢æˆ·ç«¯çš„ unsafe æ˜¯ä¸€ä¸ª AbstractNioByteChannel#NioByteUnsafe çš„å®ä¾‹, è€Œåœ¨æœåŠ¡å™¨ç«¯æ—¶, å› ä¸º AbstractNioMessageChannel é‡å†™äº† newUnsafe æ–¹æ³•:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token class-name">AbstractNioUnsafe</span> <span class="token function">newUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NioMessageUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å› æ­¤åœ¨æœåŠ¡å™¨ç«¯, unsafe å­—æ®µå…¶å®æ˜¯ä¸€ä¸ª AbstractNioMessageChannel#AbstractNioUnsafe çš„å®ä¾‹. æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹, åœ¨ NioServerSocketChannsl å®ä¾‹åŒ–è¿‡ç¨‹ä¸­, æ‰€éœ€è¦åšçš„å·¥ä½œ:</p> <ul><li>è°ƒç”¨ NioServerSocketChannel.newSocket(DEFAULT_SELECTOR_PROVIDER) æ‰“å¼€ä¸€ä¸ªæ–°çš„ Java NIO ServerSocketChannel</li> <li>AbstractChannel(Channel parent) ä¸­åˆå§‹åŒ– AbstractChannel çš„å±æ€§:</li> <li>parent å±æ€§ç½®ä¸º null</li> <li>unsafe é€šè¿‡ newUnsafe() å®ä¾‹åŒ–ä¸€ä¸ª unsafe å¯¹è±¡, å®ƒçš„ç±»å‹æ˜¯ AbstractNioMessageChannel#AbstractNioUnsafe å†…éƒ¨ç±»</li> <li>pipeline æ˜¯ new DefaultChannelPipeline(this) æ–°åˆ›å»ºçš„å®ä¾‹.</li> <li>AbstractNioChannel ä¸­çš„å±æ€§:</li> <li>SelectableChannel ch è¢«è®¾ç½®ä¸º Java ServerSocketChannel, å³ NioServerSocketChannel#newSocket è¿”å›çš„ Java NIO ServerSocketChannel.</li> <li>readInterestOp è¢«è®¾ç½®ä¸º SelectionKey.OP_ACCEPT</li> <li>SelectableChannel ch è¢«é…ç½®ä¸ºéé˜»å¡çš„ <strong>ch.configureBlocking(false)</strong></li> <li>NioServerSocketChannel ä¸­çš„å±æ€§:</li> <li>ServerSocketChannelConfig config = new NioServerSocketChannelConfig(this, javaChannel().socket())</li></ul> <h3 id="channelpipeline-åˆå§‹åŒ–"><a href="#channelpipeline-åˆå§‹åŒ–" class="header-anchor">#</a> ChannelPipeline åˆå§‹åŒ–</h3> <p>æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯çš„ ChannelPipeline çš„åˆå§‹åŒ–ä¸€è‡´, å› æ­¤å°±ä¸å†å•ç‹¬åˆ†æäº†.</p> <h3 id="channel-çš„æ³¨å†Œ"><a href="#channel-çš„æ³¨å†Œ" class="header-anchor">#</a> Channel çš„æ³¨å†Œ</h3> <p>æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯çš„ Channel çš„æ³¨å†Œè¿‡ç¨‹ä¸€è‡´, å› æ­¤å°±ä¸å†å•ç‹¬åˆ†æäº†.</p> <h3 id="å…³äº-bossgroup-ä¸-workergroup"><a href="#å…³äº-bossgroup-ä¸-workergroup" class="header-anchor">#</a> å…³äº bossGroup ä¸ workerGroup</h3> <p>åœ¨å®¢æˆ·ç«¯çš„æ—¶å€™, æˆ‘ä»¬åªæä¾›äº†ä¸€ä¸ª EventLoopGroup å¯¹è±¡, è€Œåœ¨æœåŠ¡å™¨ç«¯çš„åˆå§‹åŒ–æ—¶, æˆ‘ä»¬è®¾ç½®äº†ä¸¤ä¸ª EventLoopGroup, ä¸€ä¸ªæ˜¯ bossGroup, å¦ä¸€ä¸ªæ˜¯ workerGroup. é‚£ä¹ˆè¿™ä¸¤ä¸ª EventLoopGroup éƒ½æ˜¯å¹²ä»€ä¹ˆç”¨çš„å‘¢? å…¶å®å‘¢, bossGroup æ˜¯ç”¨äºæœåŠ¡ç«¯ çš„ accept çš„, å³ç”¨äºå¤„ç†å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚. æˆ‘ä»¬å¯ä»¥æŠŠ Netty æ¯”ä½œä¸€ä¸ªé¥­åº—, bossGroup å°±åƒä¸€ä¸ªåƒä¸€ä¸ªå‰å°æ¥å¾…, å½“å®¢æˆ·æ¥åˆ°é¥­åº—åƒæ—¶, æ¥å¾…å‘˜å°±ä¼šå¼•å¯¼é¡¾å®¢å°±å, ä¸ºé¡¾å®¢ç«¯èŒ¶é€æ°´ç­‰. è€Œ workerGroup, å…¶å®å°±æ˜¯å®é™…ä¸Šå¹²æ´»çš„å•¦, å®ƒä»¬è´Ÿè´£å®¢æˆ·ç«¯è¿æ¥é€šé“çš„ IO æ“ä½œ: å½“æ¥å¾…å‘˜ æ‹›å¾…å¥½é¡¾å®¢å, å°±å¯ä»¥ç¨åšä¼‘æ¯, è€Œæ­¤æ—¶åå¨é‡Œçš„å¨å¸ˆä»¬(workerGroup)å°±å¼€å§‹å¿™ç¢Œåœ°å‡†å¤‡é¥­èœäº†. å…³äº bossGroup ä¸ workerGroup çš„å…³ç³», æˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹å›¾æ¥å±•ç¤º:</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409182205250.png" alt="image-20240918220553207"></p> <p>é¦–å…ˆ, æœåŠ¡å™¨ç«¯ bossGroup ä¸æ–­åœ°ç›‘å¬æ˜¯å¦æœ‰å®¢æˆ·ç«¯çš„è¿æ¥, å½“å‘ç°æœ‰ä¸€ä¸ªæ–°çš„å®¢æˆ·ç«¯è¿æ¥åˆ°æ¥æ—¶, bossGroup å°±ä¼šä¸ºæ­¤è¿æ¥åˆå§‹åŒ–å„é¡¹èµ„æº, ç„¶åä» workerGroup ä¸­é€‰å‡ºä¸€ä¸ª EventLoop ç»‘å®šåˆ°æ­¤å®¢æˆ·ç«¯è¿æ¥ä¸­. é‚£ä¹ˆæ¥ä¸‹æ¥çš„æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯çš„äº¤äº’è¿‡ç¨‹å°±å…¨éƒ¨åœ¨æ­¤åˆ†é…çš„ EventLoop ä¸­äº†.</p> <p>å£è¯´æ— å‡­, æˆ‘ä»¬è¿˜æ˜¯ä»¥æºç è¯´è¯å§. é¦–å…ˆåœ¨ ServerBootstrap åˆå§‹åŒ–æ—¶, è°ƒç”¨äº† <strong>b.group(bossGroup, workerGroup)</strong> è®¾ç½®äº†ä¸¤ä¸ª EventLoopGroup, æˆ‘ä»¬è·Ÿè¸ªè¿›å»çœ‹ä¸€ä¸‹:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ServerBootstrap</span> <span class="token function">group</span><span class="token punctuation">(</span><span class="token class-name">EventLoopGroup</span> parentGroup<span class="token punctuation">,</span> <span class="token class-name">EventLoopGroup</span> childGroup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>parentGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>childGroup <span class="token operator">=</span> childGroup<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ˜¾ç„¶, è¿™ä¸ªæ–¹æ³•åˆå§‹åŒ–äº†ä¸¤ä¸ªå­—æ®µ, ä¸€ä¸ªæ˜¯ <strong>group = parentGroup</strong>, å®ƒæ˜¯åœ¨ super.group(parentGroup) ä¸­åˆå§‹åŒ–çš„, å¦ä¸€ä¸ªæ˜¯ <strong>childGroup = childGroup</strong>. æ¥ç€æˆ‘ä»¬å¯åŠ¨ç¨‹åºè°ƒç”¨äº† b.bind æ–¹æ³•æ¥ç›‘å¬ä¸€ä¸ªæœ¬åœ°ç«¯å£. bind æ–¹æ³•ä¼šè§¦å‘å¦‚ä¸‹çš„è°ƒç”¨é“¾:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">AbstractBootstrap</span><span class="token punctuation">.</span>bind <span class="token operator">-&gt;</span> <span class="token class-name">AbstractBootstrap</span><span class="token punctuation">.</span>doBind <span class="token operator">-&gt;</span> <span class="token class-name">AbstractBootstrap</span><span class="token punctuation">.</span>initAndRegister
</code></pre></div><p>AbstractBootstrap.initAndRegister æ˜¯æˆ‘ä»¬çš„è€æœ‹å‹äº†, æˆ‘ä»¬åœ¨åˆ†æå®¢æˆ·ç«¯ç¨‹åºæ—¶, å’Œå®ƒæ‰“è¿‡å¾ˆå¤šäº¤åˆ°äº†, æˆ‘ä»¬å†æ¥å›é¡¾ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•å§:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> <span class="token function">initAndRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token function">channelFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> çœç•¥å¼‚å¸¸åˆ¤æ–­
    <span class="token function">init</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ChannelFuture</span> regFuture <span class="token operator">=</span> <span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> regFuture<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¿™é‡Œ group() æ–¹æ³•è¿”å›çš„æ˜¯ä¸Šé¢æˆ‘ä»¬æåˆ°çš„ bossGroup, è€Œè¿™é‡Œçš„ channel æˆ‘ä»¬ä¹Ÿå·²ç»åˆ†æè¿‡äº†, å®ƒæ˜¯ä¸€ä¸ªæ˜¯ä¸€ä¸ª NioServerSocketChannel å®ä¾‹, å› æ­¤æˆ‘ä»¬å¯ä»¥çŸ¥é“, group().register(channel) å°† bossGroup å’Œ NioServerSocketChannel å…³è”èµ·æ¥äº†. é‚£ä¹ˆ workerGroup æ˜¯åœ¨å“ªé‡Œä¸ NioSocketChannel å…³è”çš„å‘¢? æˆ‘ä»¬ç»§ç»­çœ‹ <strong>init(channel)</strong> æ–¹æ³•:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token class-name">EventLoopGroup</span> currentChildGroup <span class="token operator">=</span> childGroup<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">ChannelHandler</span> currentChildHandler <span class="token operator">=</span> childHandler<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelOption</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> currentChildOptions<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttributeKey</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> currentChildAttrs<span class="token punctuation">;</span>

    p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ChannelHandler</span> handler <span class="token operator">=</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServerBootstrapAcceptor</span><span class="token punctuation">(</span>
                    currentChildGroup<span class="token punctuation">,</span> currentChildHandler<span class="token punctuation">,</span> currentChildOptions<span class="token punctuation">,</span> currentChildAttrs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>init æ–¹æ³•åœ¨ ServerBootstrap ä¸­é‡å†™äº†, ä»ä¸Šé¢çš„ä»£ç ç‰‡æ®µä¸­æˆ‘ä»¬çœ‹åˆ°, å®ƒä¸º pipeline ä¸­æ·»åŠ äº†ä¸€ä¸ª ChannelInitializer, è€Œè¿™ä¸ª ChannelInitializer ä¸­æ·»åŠ äº†ä¸€ä¸ªå…³é”®çš„ <strong>ServerBootstrapAcceptor</strong> handler. å…³äº handler çš„æ·»åŠ ä¸åˆå§‹åŒ–çš„è¿‡ç¨‹, æˆ‘ä»¬ç•™å¾…ä¸‹ä¸€å°èŠ‚ä¸­åˆ†æ, æˆ‘ä»¬ç°åœ¨å…³æ³¨ä¸€ä¸‹ ServerBootstrapAcceptor ç±». ServerBootstrapAcceptor ä¸­é‡å†™äº† channelRead æ–¹æ³•, å…¶ä¸»è¦ä»£ç å¦‚ä¸‹:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Channel</span> child <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Channel</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
    child<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>childHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    childGroup<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ServerBootstrapAcceptor ä¸­çš„ childGroup æ˜¯æ„é€ æ­¤å¯¹è±¡æ˜¯ä¼ å…¥çš„ currentChildGroup, å³æˆ‘ä»¬çš„ workerGroup, è€Œ Channel æ˜¯ä¸€ä¸ª NioSocketChannel çš„å®ä¾‹, å› æ­¤è¿™é‡Œçš„ childGroup.register å°±æ˜¯å°† workerGroup ä¸­çš„æ‘¸ä¸ª EventLoop å’Œ NioSocketChannel å…³è”äº†. æ—¢ç„¶è¿™æ ·, é‚£ä¹ˆç°åœ¨çš„é—®é¢˜æ˜¯, ServerBootstrapAcceptor.channelRead æ–¹æ³•æ˜¯æ€ä¹ˆè¢«è°ƒç”¨çš„å‘¢? å…¶å®å½“ä¸€ä¸ª client è¿æ¥åˆ° server æ—¶, Java åº•å±‚çš„ NIO ServerSocketChannel ä¼šæœ‰ä¸€ä¸ª <strong>SelectionKey.OP_ACCEPT</strong> å°±ç»ªäº‹ä»¶, æ¥ç€å°±ä¼šè°ƒç”¨åˆ° NioServerSocketChannel.doReadMessages:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">doReadMessages</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> buf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">SocketChannel</span> ch <span class="token operator">=</span> <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> çœç•¥å¼‚å¸¸å¤„ç†
    buf<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NioSocketChannel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ch<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨ doReadMessages ä¸­, é€šè¿‡ javaChannel().accept() è·å–åˆ°å®¢æˆ·ç«¯æ–°è¿æ¥çš„ SocketChannel, æ¥ç€å°±å®ä¾‹åŒ–ä¸€ä¸ª <strong>NioSocketChannel</strong>, å¹¶ä¸”ä¼ å…¥ NioServerSocketChannel å¯¹è±¡(å³ this), ç”±æ­¤å¯çŸ¥, æˆ‘ä»¬åˆ›å»ºçš„è¿™ä¸ª NioSocketChannel çš„çˆ¶ Channel å°±æ˜¯ NioServerSocketChannel å®ä¾‹ . æ¥ä¸‹æ¥å°±ç»ç”± Netty çš„ ChannelPipeline æœºåˆ¶, å°†è¯»å–äº‹ä»¶é€çº§å‘é€åˆ°å„ä¸ª handler ä¸­, äºæ˜¯å°±ä¼šè§¦å‘å‰é¢æˆ‘ä»¬æåˆ°çš„ ServerBootstrapAcceptor.channelRead æ–¹æ³•å•¦.</p> <h3 id="handler-çš„æ·»åŠ è¿‡ç¨‹"><a href="#handler-çš„æ·»åŠ è¿‡ç¨‹" class="header-anchor">#</a> handler çš„æ·»åŠ è¿‡ç¨‹</h3> <p>æœåŠ¡å™¨ç«¯çš„ handler çš„æ·»åŠ è¿‡ç¨‹å’Œå®¢æˆ·ç«¯çš„æœ‰ç‚¹åŒºåˆ«, å’Œ EventLoopGroup ä¸€æ ·, æœåŠ¡å™¨ç«¯çš„ handler ä¹Ÿæœ‰ä¸¤ä¸ª, ä¸€ä¸ªæ˜¯é€šè¿‡ handler() æ–¹æ³•è®¾ç½® handler å­—æ®µ, å¦ä¸€ä¸ªæ˜¯é€šè¿‡ childHandler() è®¾ç½® childHandler å­—æ®µ. é€šè¿‡å‰é¢çš„ bossGroup å’Œ workerGroup çš„åˆ†æ, å…¶å®æˆ‘ä»¬åœ¨è¿™é‡Œå¯ä»¥å¤§èƒ†åœ°çŒœæµ‹: handler å­—æ®µä¸ accept è¿‡ç¨‹æœ‰å…³, å³è¿™ä¸ª handler è´Ÿè´£å¤„ç†å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚; è€Œ childHandler å°±æ˜¯è´Ÿè´£å’Œå®¢æˆ·ç«¯çš„è¿æ¥çš„ IO äº¤äº’. é‚£ä¹ˆå®é™…ä¸Šæ˜¯ä¸æ˜¯è¿™æ ·çš„å‘¢? æ¥, æˆ‘ä»¬ç»§ç»­é€šè¿‡ä»£ç è¯æ˜.</p> <p>åœ¨ <strong>å…³äº bossGroup ä¸ workerGroup</strong> å°èŠ‚ä¸­, æˆ‘ä»¬æåˆ°, ServerBootstrap é‡å†™äº† init æ–¹æ³•, åœ¨è¿™ä¸ªæ–¹æ³•ä¸­æ·»åŠ äº† handler:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token class-name">EventLoopGroup</span> currentChildGroup <span class="token operator">=</span> childGroup<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">ChannelHandler</span> currentChildHandler <span class="token operator">=</span> childHandler<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelOption</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> currentChildOptions<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttributeKey</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> currentChildAttrs<span class="token punctuation">;</span>

    p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ChannelHandler</span> handler <span class="token operator">=</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServerBootstrapAcceptor</span><span class="token punctuation">(</span>
                    currentChildGroup<span class="token punctuation">,</span> currentChildHandler<span class="token punctuation">,</span> currentChildOptions<span class="token punctuation">,</span> currentChildAttrs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸Šé¢ä»£ç çš„ <strong>initChannel</strong> æ–¹æ³•ä¸­, é¦–å…ˆé€šè¿‡ handler() æ–¹æ³•è·å–ä¸€ä¸ª handler, å¦‚æœè·å–çš„ handler ä¸ä¸ºç©º,åˆ™æ·»åŠ åˆ° pipeline ä¸­. ç„¶åæ¥ç€, æ·»åŠ äº†ä¸€ä¸ª ServerBootstrapAcceptor å®ä¾‹. é‚£ä¹ˆè¿™é‡Œ handler() æ–¹æ³•è¿”å›çš„æ˜¯å“ªä¸ªå¯¹è±¡å‘¢? å…¶å®å®ƒè¿”å›çš„æ˜¯ handler å­—æ®µ, è€Œè¿™ä¸ªå­—æ®µå°±æ˜¯æˆ‘ä»¬åœ¨æœåŠ¡å™¨ç«¯çš„å¯åŠ¨ä»£ç ä¸­è®¾ç½®çš„:</p> <div class="language-Java extra-class"><pre class="language-java"><code>b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoggingHandler</span><span class="token punctuation">(</span><span class="token class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">INFO</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>é‚£ä¹ˆè¿™ä¸ªæ—¶å€™, pipeline ä¸­çš„ handler æƒ…å†µå¦‚ä¸‹: [<img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409182200616.png" alt="Alt text">](https://github.com/yongshun/learn_netty_source_code/blob/master/Netty æºç åˆ†æä¹‹ ä¸€ æ­å¼€ Bootstrap ç¥ç§˜çš„çº¢ç›–å¤´ (æœåŠ¡å™¨ç«¯)/1477377831087.png)</p> <p>æ ¹æ®æˆ‘ä»¬åŸæ¥åˆ†æå®¢æˆ·ç«¯çš„ç»éªŒ, æˆ‘ä»¬æŒ‡å®š, å½“ channel ç»‘å®šåˆ° eventLoop å(åœ¨è¿™é‡Œæ˜¯ NioServerSocketChannel ç»‘å®šåˆ° bossGroup)ä¸­æ—¶, ä¼šåœ¨ pipeline ä¸­å‘å‡º <strong>fireChannelRegistered</strong> äº‹ä»¶, æ¥ç€å°±ä¼šè§¦å‘ ChannelInitializer.initChannel æ–¹æ³•çš„è°ƒç”¨. å› æ­¤åœ¨ç»‘å®šå®Œæˆå, æ­¤æ—¶çš„ pipeline çš„å†…å¦‚å¦‚ä¸‹: [<img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409182200531.png" alt="Alt text">](https://github.com/yongshun/learn_netty_source_code/blob/master/Netty æºç åˆ†æä¹‹ ä¸€ æ­å¼€ Bootstrap ç¥ç§˜çš„çº¢ç›–å¤´ (æœåŠ¡å™¨ç«¯)/1477378182291.png)</p> <p>å‰é¢æˆ‘ä»¬åœ¨åˆ†æ bossGroup å’Œ workerGroup æ—¶, å·²ç»çŸ¥é“äº†åœ¨ ServerBootstrapAcceptor.channelRead ä¸­ä¼šä¸ºæ–°å»ºçš„ Channel è®¾ç½® handler å¹¶æ³¨å†Œåˆ°ä¸€ä¸ª eventLoop ä¸­, å³:</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Channel</span> child <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Channel</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
    child<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>childHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    childGroup<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è€Œè¿™é‡Œçš„ childHandler å°±æ˜¯æˆ‘ä»¬åœ¨æœåŠ¡å™¨ç«¯å¯åŠ¨ä»£ç ä¸­è®¾ç½®çš„ handler:</p> <div class="language-Java extra-class"><pre class="language-java"><code>b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token annotation punctuation">@Override</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
         <span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>sslCtx <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>sslCtx<span class="token punctuation">.</span><span class="token function">newHandler</span><span class="token punctuation">(</span>ch<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token comment">//p.addLast(new LoggingHandler(LogLevel.INFO));</span>
         p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EchoServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>åç»­çš„æ­¥éª¤å°±æ²¡æœ‰ä»€ä¹ˆå¥½è¯´çš„äº†, å½“è¿™ä¸ªå®¢æˆ·ç«¯è¿æ¥ Channel æ³¨å†Œå, å°±ä¼šè§¦å‘ ChannelInitializer.initChannel æ–¹æ³•çš„è°ƒç”¨, æ­¤åçš„å®¢æˆ·ç«¯çš„ ChannelPipeline çŠ¶æ€å¦‚ä¸‹:</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409182209246.png" alt="æ–°å®¢æˆ·ç«¯è¿æ¥ä¹‹å, NioSocketChannel å¯¹åº”çš„ pipeline.png"></p> <p>æœ€åæˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹æœåŠ¡å™¨ç«¯çš„ handler ä¸ childHandler çš„åŒºåˆ«ä¸è”ç³»:</p> <ul><li>åœ¨æœåŠ¡å™¨ NioServerSocketChannel çš„ pipeline ä¸­æ·»åŠ çš„æ˜¯ handler ä¸ ServerBootstrapAcceptor.</li> <li>å½“æœ‰æ–°çš„å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚æ—¶, ServerBootstrapAcceptor.channelRead ä¸­è´Ÿè´£æ–°å»ºæ­¤è¿æ¥çš„ NioSocketChannel å¹¶æ·»åŠ  childHandler åˆ° NioSocketChannel å¯¹åº”çš„ pipeline ä¸­, å¹¶å°†æ­¤ channel ç»‘å®šåˆ° workerGroup ä¸­çš„æŸä¸ª eventLoop ä¸­.</li> <li>handler æ˜¯åœ¨ accept é˜¶æ®µèµ·ä½œç”¨, å®ƒå¤„ç†å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚.</li> <li>childHandler æ˜¯åœ¨å®¢æˆ·ç«¯è¿æ¥å»ºç«‹ä»¥åèµ·ä½œç”¨, å®ƒè´Ÿè´£å®¢æˆ·ç«¯è¿æ¥çš„ IO äº¤äº’.</li></ul> <p>ä¸‹é¢æˆ‘ä»¬ç”¨ä¸€å¹…å›¾æ¥æ€»ç»“ä¸€ä¸‹æœåŠ¡å™¨ç«¯çš„ handler æ·»åŠ æµç¨‹:</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409182210529.png" alt="image-20240918221010465"></p> <h2 id="åè®°"><a href="#åè®°" class="header-anchor">#</a> åè®°</h2> <p>è¿™æ˜¯ <strong>Netty æºç åˆ†æ</strong> ç³»åˆ—æ•™ç¨‹çš„ç¬¬ä¸€ç¯‡, æŒ‰æˆ‘çš„è®¡åˆ’, è¿™ä¸€ç¯‡æ–‡ç« æ˜¯ä¸€ä¸ªç®€è¿°æ€§è´¨çš„, å³è¿™é‡Œä¼šæ¶‰åŠåˆ° Netty å„ä¸ªåŠŸèƒ½æ¨¡å—, ä½†æ˜¯æˆ‘åªæ˜¯ç®€å•åœ°æäº†ä¸€ä¸‹, è€Œæ²¡æœ‰æ·±å…¥åœ°æ¢ç´¢å®ƒä»¬å†…éƒ¨çš„å®ç°æœºç†. ä¹‹æ‰€ä»¥è¿™æ ·åš, ç¬¬ä¸€, æ˜¯å› ä¸ºå¦‚æœä¸€ä¸Šæ¥å°±ä»ç»†èŠ‚åˆ†æ, é‚£ä¹ˆæœªå…ä¼šé™·å…¥å„ç§çç¢çš„ç»†èŠ‚ä¸­éš¾ä»¥è‡ªæ‹”; ç¬¬äºŒ, æˆ‘æƒ³ç»™è¯»è€…å±•ç¤ºä¸€ä¸ªä¸€ä¸ªå®Œæ•´çš„ Netty çš„è¿è¡Œæµç¨‹, è®©è¯»è€…ä»ä¸€ä¸ªæ•´ä½“ä¸Šå¯¹ Netty æœ‰ä¸€ä¸ªæ„Ÿæ€§çš„è®¤è¯†. æ­¤ç¯‡æ–‡ç« æ¶‰åŠçš„æ¨¡å—æ¯”è¾ƒå¤š, é¢æ¯”è¾ƒå¹¿, å› æ­¤å†™èµ·æ¥éš¾å…æœ‰ä¸€ç‚¹è·³è·ƒ, å¹¶ä¸”æˆ‘æ„Ÿè§‰å†™ç€å†™ç€è§è§æœ‰ç‚¹ä¸çŸ¥æ‰€äº‘, é€»è¾‘æ··ä¹±äº†, æ±—. å”‰, è¿˜æ˜¯æ„Ÿè§‰è‡ªå·±åŠŸåŠ›ä¸å¤Ÿ, hold ä¸ä½. æ¥ä¸‹æ¥çš„å‡ ç¯‡æ–‡ç« , æˆ‘ä¼šæ ¹æ® Netty çš„å„ä¸ªæ¨¡å—æ·±å…¥åˆ†æä¸€ä¸‹, å¸Œæœ›ä»¥åçš„æ–‡ç« èƒ½å¤Ÿç»„ç»‡çš„è°ƒç†æ›´åŠ æ¸…æ™°ä¸€äº›.</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/echo-lxy/echo-system-design/edit/master/docs/Netty ç³»ç»Ÿè®¾è®¡/20.ä¸‰ã€ä¸»çº¿ä»»åŠ¡/03.Bootstrapï¼ˆserverï¼‰æºç è§£æ.md" target="_blank" rel="noopener noreferrer">ç¼–è¾‘</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°äº:</span> <span class="time">2024/09/18, 16:19:18</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        â†
        <a href="/pages/9582d0/" class="prev">Bootstrapï¼ˆclientï¼‰æºç è§£æ</a></span> <span class="next"><a href="/pages/8d1ba9/Channel/">Channel æºç è§£æ</a>â†’
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:lixinyang2002@163.com" title="å‘é‚®ä»¶" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/echo-lxy" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="å¬éŸ³ä¹" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="æœ¬ç«™ä¸»é¢˜">Vdoing</a> 
    | Copyright Â© 2024-2024
    <span>Xinyang Li | MIT License</span></div> <div class="buttons"><div title="è¿”å›é¡¶éƒ¨" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="å»è¯„è®º" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ä¸»é¢˜æ¨¡å¼" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          è·Ÿéšç³»ç»Ÿ
        </li><li class="iconfont icon-rijianmoshi">
          æµ…è‰²æ¨¡å¼
        </li><li class="iconfont icon-yejianmoshi">
          æ·±è‰²æ¨¡å¼
        </li><li class="iconfont icon-yuedu">
          é˜…è¯»æ¨¡å¼
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.6c7acbd0.js" defer></script><script src="/assets/js/2.933750c6.js" defer></script><script src="/assets/js/45.685623ac.js" defer></script><script src="/assets/js/7.7eb70372.js" defer></script>
  </body>
</html>
