<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>чммф╕Гшп╛я╝ЪNetty ф╕нIOф║Лф╗╢чЪДшзжхПСцЧ╢цЬ║хТМф╝ацТнц╡БчиЛ | EchoDesign</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="ч│╗ч╗Яшо╛шобф╣ЛуАМшо▓шзг + щЭвшпХцМЗхНЧуАНя╝Мц░┤ц╗┤чЯ│чй┐я╝Мшо╛шобцЧащУ╢х╝╣я╝Б">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.f82a82e9.css" as="style"><link rel="preload" href="/assets/js/app.78f2b9cc.js" as="script"><link rel="preload" href="/assets/js/2.933750c6.js" as="script"><link rel="preload" href="/assets/js/58.bb9706ba.js" as="script"><link rel="preload" href="/assets/js/7.7eb70372.js" as="script"><link rel="prefetch" href="/assets/js/10.b313d17c.js"><link rel="prefetch" href="/assets/js/100.a9558091.js"><link rel="prefetch" href="/assets/js/101.007aa479.js"><link rel="prefetch" href="/assets/js/102.57bca734.js"><link rel="prefetch" href="/assets/js/11.c7521a10.js"><link rel="prefetch" href="/assets/js/12.f57a12da.js"><link rel="prefetch" href="/assets/js/13.d9d26d25.js"><link rel="prefetch" href="/assets/js/14.09cf8a64.js"><link rel="prefetch" href="/assets/js/15.d5a34c66.js"><link rel="prefetch" href="/assets/js/16.8cea924c.js"><link rel="prefetch" href="/assets/js/17.8d94c5e8.js"><link rel="prefetch" href="/assets/js/18.baad837c.js"><link rel="prefetch" href="/assets/js/19.571eaed1.js"><link rel="prefetch" href="/assets/js/20.d70e5281.js"><link rel="prefetch" href="/assets/js/21.0e0ed140.js"><link rel="prefetch" href="/assets/js/22.1ccaa6f3.js"><link rel="prefetch" href="/assets/js/23.623f0b5d.js"><link rel="prefetch" href="/assets/js/24.891fe6fb.js"><link rel="prefetch" href="/assets/js/25.41dca26b.js"><link rel="prefetch" href="/assets/js/26.6337eac0.js"><link rel="prefetch" href="/assets/js/27.de80589e.js"><link rel="prefetch" href="/assets/js/28.95a1fb6b.js"><link rel="prefetch" href="/assets/js/29.371a40e1.js"><link rel="prefetch" href="/assets/js/3.e62a71e4.js"><link rel="prefetch" href="/assets/js/30.e32f6b31.js"><link rel="prefetch" href="/assets/js/31.21bd2de1.js"><link rel="prefetch" href="/assets/js/32.f1174703.js"><link rel="prefetch" href="/assets/js/33.eab858f3.js"><link rel="prefetch" href="/assets/js/34.4ba0e53e.js"><link rel="prefetch" href="/assets/js/35.8287c9dc.js"><link rel="prefetch" href="/assets/js/36.b5f133ca.js"><link rel="prefetch" href="/assets/js/37.82be3556.js"><link rel="prefetch" href="/assets/js/38.40fe2658.js"><link rel="prefetch" href="/assets/js/39.6450065f.js"><link rel="prefetch" href="/assets/js/4.73518a0f.js"><link rel="prefetch" href="/assets/js/40.591baf2a.js"><link rel="prefetch" href="/assets/js/41.f961e422.js"><link rel="prefetch" href="/assets/js/42.b34f1599.js"><link rel="prefetch" href="/assets/js/43.5a509601.js"><link rel="prefetch" href="/assets/js/44.64fd3383.js"><link rel="prefetch" href="/assets/js/45.685623ac.js"><link rel="prefetch" href="/assets/js/46.b7523f9c.js"><link rel="prefetch" href="/assets/js/47.9bed4c1b.js"><link rel="prefetch" href="/assets/js/48.a1b270df.js"><link rel="prefetch" href="/assets/js/49.ee9681bc.js"><link rel="prefetch" href="/assets/js/5.b472a9bb.js"><link rel="prefetch" href="/assets/js/50.b424b2c0.js"><link rel="prefetch" href="/assets/js/51.53684c6e.js"><link rel="prefetch" href="/assets/js/52.a45a9bb1.js"><link rel="prefetch" href="/assets/js/53.6f165300.js"><link rel="prefetch" href="/assets/js/54.61a6a81b.js"><link rel="prefetch" href="/assets/js/55.5391018d.js"><link rel="prefetch" href="/assets/js/56.e0b862ae.js"><link rel="prefetch" href="/assets/js/57.374534af.js"><link rel="prefetch" href="/assets/js/59.6d5a538f.js"><link rel="prefetch" href="/assets/js/6.0b558b79.js"><link rel="prefetch" href="/assets/js/60.99b51260.js"><link rel="prefetch" href="/assets/js/61.33893dab.js"><link rel="prefetch" href="/assets/js/62.e6604fa3.js"><link rel="prefetch" href="/assets/js/63.e753bb13.js"><link rel="prefetch" href="/assets/js/64.59e76eda.js"><link rel="prefetch" href="/assets/js/65.66728f4b.js"><link rel="prefetch" href="/assets/js/66.30cbe3ea.js"><link rel="prefetch" href="/assets/js/67.9aea7c9b.js"><link rel="prefetch" href="/assets/js/68.79ee7ba7.js"><link rel="prefetch" href="/assets/js/69.a776cc2e.js"><link rel="prefetch" href="/assets/js/70.13d90b76.js"><link rel="prefetch" href="/assets/js/71.4f4c7733.js"><link rel="prefetch" href="/assets/js/72.b0948cb0.js"><link rel="prefetch" href="/assets/js/73.d7ed15dc.js"><link rel="prefetch" href="/assets/js/74.6884119c.js"><link rel="prefetch" href="/assets/js/75.b70b8a0c.js"><link rel="prefetch" href="/assets/js/76.2766fd7c.js"><link rel="prefetch" href="/assets/js/77.c9b76e03.js"><link rel="prefetch" href="/assets/js/78.9aa9da2e.js"><link rel="prefetch" href="/assets/js/79.ea5b4888.js"><link rel="prefetch" href="/assets/js/8.77b795dd.js"><link rel="prefetch" href="/assets/js/80.3c3f7534.js"><link rel="prefetch" href="/assets/js/81.76b7b1ed.js"><link rel="prefetch" href="/assets/js/82.7b7a2f1c.js"><link rel="prefetch" href="/assets/js/83.44c820ac.js"><link rel="prefetch" href="/assets/js/84.f53c8839.js"><link rel="prefetch" href="/assets/js/85.8c526118.js"><link rel="prefetch" href="/assets/js/86.e17eab25.js"><link rel="prefetch" href="/assets/js/87.a09f72d3.js"><link rel="prefetch" href="/assets/js/88.0f27b036.js"><link rel="prefetch" href="/assets/js/89.2fd11d59.js"><link rel="prefetch" href="/assets/js/9.36f81190.js"><link rel="prefetch" href="/assets/js/90.e60814ad.js"><link rel="prefetch" href="/assets/js/91.08cfa575.js"><link rel="prefetch" href="/assets/js/92.81c822a0.js"><link rel="prefetch" href="/assets/js/93.5f199263.js"><link rel="prefetch" href="/assets/js/94.266b7d71.js"><link rel="prefetch" href="/assets/js/95.0899dfb4.js"><link rel="prefetch" href="/assets/js/96.c1156914.js"><link rel="prefetch" href="/assets/js/97.18525931.js"><link rel="prefetch" href="/assets/js/98.ee554b1a.js"><link rel="prefetch" href="/assets/js/99.f0fb67c2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f82a82e9.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="чЫох╜Х" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="EchoDesign" class="logo"> <span class="site-name can-hide">EchoDesign</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">ЁЯПащжЦщб╡</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">тЬТя╕ПчГнщЧичоЧц│Х</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕шо╛шоб" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕шо╛шоб</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">JUC ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ч│╗ч╗Яшо╛шоб</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">тЭУщЧочнФ</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ЁЯСАхКицАБ</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">ЁЯПащжЦщб╡</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">тЬТя╕ПчГнщЧичоЧц│Х</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕шо╛шоб" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕шо╛шоб</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">JUC ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ч│╗ч╗Яшо╛шоб</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">тЭУщЧочнФ</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ЁЯСАхКицАБ</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ф╕АуАБхЙНшиА</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ф║МуАБхЯ║чбАчЯешпЖ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ф╕ЙуАБф╕╗ч║┐ф╗╗хКб</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>хЫЫуАБц╖▒хЕе Netty ца╕х┐Г</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/65674f/" class="sidebar-link">чммф╕Ашп╛я╝ЪщАПш┐З Netty ф╗ОхЖЕца╕шзТх║жчЬЛ IO цибхЮЛ</a></li><li><a href="/pages/440035/" class="sidebar-link">чммф║Мшп╛я╝ЪReactorхЬи Netty ф╕нчЪДхоЮчО░я╝ИхИЫх╗║чпЗя╝Й</a></li><li><a href="/pages/2f527f/" class="sidebar-link">Netty Reactor хРпхКихЕиц╡БчиЛ</a></li><li><a href="/pages/bb668a/" class="sidebar-link">чммф╕Йшп╛я╝ЪNetty ца╕х┐Гх╝ХцУО Reactor чЪДш┐Рш╜мцЮ╢цЮД</a></li><li><a href="/pages/be98dc/" class="sidebar-link">чммхЫЫшп╛я╝ЪNetty хжВф╜ХщлШцХИцОецФ╢ч╜Сч╗Ьш┐ЮцОе</a></li><li><a href="/pages/0938c1/" class="sidebar-link">чммф║Фшп╛я╝ЪNetty хжВф╜ХщлШцХИцОецФ╢ч╜Сч╗ЬцХ░цНо</a></li><li><a href="/pages/a73206/" class="sidebar-link">чммхЕншп╛я╝ЪNetty хжВф╜ХщлШцХИхПСщАБч╜Сч╗ЬцХ░цНо</a></li><li><a href="/pages/a1b0fe/" aria-current="page" class="active sidebar-link">чммф╕Гшп╛я╝ЪNetty ф╕нIOф║Лф╗╢чЪДшзжхПСцЧ╢цЬ║хТМф╝ацТнц╡БчиЛ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/a1b0fe/#хЙНшиА" class="sidebar-link">хЙНшиА</a></li><li class="sidebar-sub-header level2"><a href="/pages/a1b0fe/#_2-pipeline-чЪДхИЫх╗║" class="sidebar-link">2. pipeline чЪДхИЫх╗║</a></li><li class="sidebar-sub-header level2"><a href="/pages/a1b0fe/#_3-pipeline-ф╕нчЪДф║Лф╗╢хИЖч▒╗" class="sidebar-link">3. pipeline ф╕нчЪДф║Лф╗╢хИЖч▒╗</a></li><li class="sidebar-sub-header level2"><a href="/pages/a1b0fe/#_4-хРС-pipeline-ц╖╗хКа-channelhandler" class="sidebar-link">4. хРС pipeline ц╖╗хКа channelHandler</a></li><li class="sidebar-sub-header level2"><a href="/pages/a1b0fe/#_5-channehandlercontext-чЪДхИЫх╗║" class="sidebar-link">5. ChanneHandlerContext чЪДхИЫх╗║</a></li><li class="sidebar-sub-header level2"><a href="/pages/a1b0fe/#_6-ф╗О-pipeline-хИащЩд-channelhandler" class="sidebar-link">6. ф╗О pipeline хИащЩд channelHandler</a></li><li class="sidebar-sub-header level2"><a href="/pages/a1b0fe/#_7-pipeline-чЪДхИЭхзЛхМЦ" class="sidebar-link">7. pipeline чЪДхИЭхзЛхМЦ</a></li><li class="sidebar-sub-header level2"><a href="/pages/a1b0fe/#_8-ф║Лф╗╢ф╝ацТн" class="sidebar-link">8. ф║Лф╗╢ф╝ацТн</a></li><li class="sidebar-sub-header level2"><a href="/pages/a1b0fe/#цА╗ч╗У" class="sidebar-link">цА╗ч╗У</a></li><li class="sidebar-sub-header level2"><a href="/pages/a1b0fe/#хПВшАГш╡ДцЦЩ" class="sidebar-link">хПВшАГш╡ДцЦЩ</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ф║ФуАБц╖▒хЕе Netty хЖЕхнШчобчРЖ</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="щжЦщб╡" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>Netty ч│╗ч╗Яшо╛шоб</span></li><li data-v-06225672><span data-v-06225672>хЫЫуАБц╖▒хЕе Netty ца╕х┐Г</span></li></ul> <div class="info" data-v-06225672><div title="ф╜ЬшАЕ" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/brother-one" target="_blank" title="ф╜ЬшАЕ" class="beLink" data-v-06225672>echo</a></div> <div title="хИЫх╗║цЧ╢щЧ┤" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-09-19</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">чЫох╜Х</div> <div class="right-menu-content"></div></div></div> <h1><!---->чммф╕Гшп╛я╝ЪNetty ф╕нIOф║Лф╗╢чЪДшзжхПСцЧ╢цЬ║хТМф╝ацТнц╡БчиЛ<!----></h1> <div class="page-slot page-slot-top">
    <div class="wwads-cn wwads-horizontal page-wwads" data-id="136"></div>
    <style>
      .page-wwads{
        width:100%!important;
        min-height: 0;
        margin: 0;
      }
      .page-wwads .wwads-img img{
        width:80px!important;
      }
      .page-wwads .wwads-poweredby{
        width: 40px;
        position: absolute;
        right: 25px;
        bottom: 3px;
      }
      .wwads-content .wwads-text, .page-wwads .wwads-text{
        height: 100%;
        padding-top: 5px;
        display: block;
      }
  </style>
  </div> <div class="theme-vdoing-content content__default"><h2 id="хЙНшиА"><a href="#хЙНшиА" class="header-anchor">#</a> хЙНшиА</h2> <p>хЬихЙНш╛╣чЪДч│╗хИЧцЦЗчлаф╕ня╝МчмФшАЕф╕║хдзхо╢шпжч╗ЖхЙЦцЮРф║Ж Reactor цибхЮЛхЬи netty ф╕нчЪД<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247483907&amp;idx=1&amp;sn=084c470a8fe6234c2c9461b5f713ff30&amp;chksm=ce77c444f9004d52e7c6244bee83479070effb0bc59236df071f4d62e91e25f01715fca53696&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">хИЫх╗║<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>я╝М<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484005&amp;idx=1&amp;sn=52f51269902a58f40d33208421109bc3&amp;chksm=ce77c422f9004d340e5b385ef6ba24dfba1f802076ace80ad6390e934173a10401e64e13eaeb&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">хРпхКи<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>я╝М<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484087&amp;idx=1&amp;sn=0c065780e0f05c23c8e6465ede86cba0&amp;chksm=ce77c4f0f9004de63be369a664105708bc5975b52993f4a6df223caed34cc1ef6185a16acd75&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">ш┐РшбМ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>я╝М<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484184&amp;idx=1&amp;sn=726877ce28cf6e5d2ac3225fae687f19&amp;chksm=ce77c55ff9004c493b592288819dc4d4664b5949ee97fed977b6558bc517dad0e1f73fab0f46&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">цОецФ╢ш┐ЮцОе<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>я╝М<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484244&amp;idx=1&amp;sn=831060fc38caa201d69f87305de7f86a&amp;chksm=ce77c513f9004c05b48f849ff99997d6d7252453135ae856a029137b88aa70b8e046013d596e&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">цОецФ╢цХ░цНо<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>я╝М<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484532&amp;idx=1&amp;sn=c3a8b37a2eb09509d9914494ef108c68&amp;chksm=ce77c233f9004b25a29f9fdfb179e41646092d09bc89df2147a9fab66df13231e46dd6a5c26d&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">хПСщАБцХ░цНо<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>чЪДхоМцХ┤ц╡БчиЛя╝МхЬишпжч╗ЖхЙЦцЮРцХ┤ф╕к Reactor цибхЮЛхжВф╜ХхЬи netty ф╕нхоЮчО░чЪДш┐ЗчиЛщЗМя╝МцИСф╗мцИЦхдЪцИЦх░СчЪДшзБхИ░ф║Ж pipeline чЪДш║лх╜▒уАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191115157.webp" alt="хЫ╛чЙЗ"></p> <p>цпФхжВхЬи Reactor хРпхКичЪДш┐ЗчиЛф╕нщжЦхЕИщЬАшжБхИЫх╗║ NioServerSocketChannel я╝МхЬихИЫх╗║чЪДш┐ЗчиЛф╕нф╝Ъф╕║ NioServerSocketChannel хИЫх╗║хИЖщЕНф╕Аф╕к pipeline я╝МчФиф║Охп╣ OP_ACCEPT ф║Лф╗╢чЪДч╝ЦцОТуАВ</p> <p>х╜У NioServerSocketChannel хРС main reactor ц│ихЖМцИРхКЯхРОя╝Мф╝ЪхЬи pipeline ф╕ншзжхПС ChannelRegistered ф║Лф╗╢чЪДф╝ацТнуАВ</p> <p>х╜У NioServerSocketChannel ч╗СхоЪчлпхПгцИРхКЯхРОя╝Мф╝ЪхЬи pipeline ф╕ншзжхПС ChannelActive ф║Лф╗╢чЪДф╝ацТнуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191115136.webp" alt="хЫ╛чЙЗ"></p> <p>хПИцпФхжВхЬи Reactor цОецФ╢ш┐ЮцОечЪДш┐ЗчиЛф╕ня╝Мх╜УховцИ╖члпхПСш╡╖ф╕Аф╕кш┐ЮцОех╣╢хоМцИРф╕ЙцмбцПбцЙЛф╣ЛхРОя╝Мш┐ЮцОехп╣х║ФчЪД Socket ф╝ЪхнШцФ╛хЬихЖЕца╕ф╕нчЪДхЕиш┐ЮцОещШЯхИЧф╕ня╝МщЪПхРО JDK Selector ф╝ЪщАЪчЯе main reactor цндцЧ╢ NioServerSocketChannel ф╕КцЬЙ OP_ACCEPT ф║Лф╗╢ц┤╗ш╖Гя╝МцЬАхРО main reactor х╝АхзЛцЙзшбМ NioServerSocketChannel чЪДх║Хх▒ВцУНф╜Ьч▒╗ NioMessageUnsafe#read цЦ╣ц│ХхЬи NioServerSocketChannel ф╕нчЪД pipeline ф╕нф╝ацТн ChannelRead ф║Лф╗╢уАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192202493.webp" alt="хЫ╛чЙЗ"></p> <p>цЬАч╗Иф╝ЪхЬи NioServerSocketChannel чЪД pipeline ф╕нчЪД ServerBootstrapAcceptor ф╕нхУНх║Ф ChannelRead ф║Лф╗╢х╣╢хИЫх╗║хИЭхзЛхМЦ NioSocketChannel я╝МщЪПхРОф╝Ъф╕║цпПф╕Аф╕кцЦ░хИЫх╗║чЪД NioSocetChannel хИЫх╗║хИЖщЕНф╕Аф╕кчЛмчлЛчЪД pipeline я╝МчФиф║ОхРДшЗк NioSocketChannel ф╕КчЪД IO ф║Лф╗╢чЪДч╝ЦцОТуАВх╣╢хРС sub reactor ц│ихЖМ NioSocketChannel я╝МщЪПхРОхЬи NioSocketChannel чЪД pipeline ф╕нф╝ацТн ChannelRegistered ф║Лф╗╢я╝МцЬАхРОф╝ацТн ChannelActive ф║Лф╗╢уАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192202891.webp" alt="хЫ╛чЙЗ"></p> <p>ш┐ШцЬЙхЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484244&amp;idx=1&amp;sn=831060fc38caa201d69f87305de7f86a&amp;chksm=ce77c513f9004c05b48f849ff99997d6d7252453135ae856a029137b88aa70b8e046013d596e&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">уАКNetty хжВф╜ХщлШцХИцОецФ╢ч╜Сч╗ЬцХ░цНоуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕АцЦЗф╕ня╝МцИСф╗мф╣ЯцПРш┐Зх╜У sub reactor шп╗хПЦ NioSocketChannel ф╕нцЭешЗкховцИ╖члпчЪДшп╖ц▒ВцХ░цНоцЧ╢я╝Мф╝ЪхЬи NioSocketChannel чЪД pipeline ф╕нф╝ацТн ChannelRead ф║Лф╗╢я╝МхЬиф╕Аф╕кхоМцХ┤чЪД read loop шп╗хПЦхоМцпХхРОф╝Ъф╝ацТн ChannelReadComplete ф║Лф╗╢уАВ</p> <p>хЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484532&amp;idx=1&amp;sn=c3a8b37a2eb09509d9914494ef108c68&amp;chksm=ce77c233f9004b25a29f9fdfb179e41646092d09bc89df2147a9fab66df13231e46dd6a5c26d&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">уАКф╕АцЦЗцРЮцЗВ Netty хПСщАБцХ░цНохЕиц╡БчиЛуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕АцЦЗф╕ня╝МцИСф╗мшо▓хИ░ф║ЖхЬичФицИ╖ч╗Пш┐Зф╕ЪхКбхдДчРЖхРОя╝МщАЪш┐З write цЦ╣ц│ХхТМ flush цЦ╣ц│ХхИЖхИлхЬи NioSocketChannel чЪД pipeline ф╕нф╝ацТн write ф║Лф╗╢хТМ flush ф║Лф╗╢чЪДш┐ЗчиЛуАВ</p> <p>чмФшАЕх╕жхдзхо╢хПИхЫЮщб╛ф║Жф╕Аф╕ЛхЬихЙНш╛╣ч│╗хИЧцЦЗчлаф╕нхЕ│ф║О pipeline чЪДф╜┐чФихЬ║цЩпя╝Мф╜ЖцШпхЬиш┐Щф║Ыч│╗хИЧцЦЗчлаф╕нх╣╢цЬкхп╣ pipeline чЫ╕хЕ│чЪДч╗ЖшКВш┐ЫшбМхоМцХ┤хЕищЭвхЬ░цППш┐░я╝МщВгф╣ИцЬмцЦЗчмФшАЕх░Жф╕║хдзхо╢шпжч╗ЖчЪДхЙЦцЮРф╕Л pipeline хЬи IO ф║Лф╗╢чЪДч╝ЦцОТхТМф╝ацТнхЬ║цЩпф╕ЛчЪДхоМцХ┤хоЮчО░хОЯчРЖуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191115172.webp" alt="хЫ╛чЙЗ"></p> <h2 id="_2-pipeline-чЪДхИЫх╗║"><a href="#_2-pipeline-чЪДхИЫх╗║" class="header-anchor">#</a> 2. pipeline чЪДхИЫх╗║</h2> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192203433.webp" alt="хЫ╛чЙЗ"></p> <p>Netty ф╝Ъф╕║цпПф╕Аф╕к Channel хИЖщЕНф╕Аф╕кчЛмчлЛчЪД pipeline я╝Мpipeline ф╝┤щЪПчЭА channel чЪДхИЫх╗║шАМхИЫх╗║уАВ</p> <p>хЙНш╛╣ф╗Лч╗НхИ░ NioServerSocketChannel цШпхЬи netty цЬНхКбчлпхРпхКичЪДш┐ЗчиЛф╕нхИЫх╗║чЪДуАВшАМ NioSocketChannel чЪДхИЫх╗║цШпхЬих╜У NioServerSocketChannel ф╕КчЪД OP_ACCEPT ф║Лф╗╢ц┤╗ш╖ГцЧ╢я╝МчФ▒ main reactor ч║┐чиЛхЬи NioServerSocketChannel ф╕нхИЫх╗║я╝Мх╣╢хЬи NioServerSocketChannel чЪД pipeline ф╕нхп╣ OP_ACCEPT ф║Лф╗╢ш┐ЫшбМч╝ЦцОТцЧ╢я╝ИхЫ╛ф╕нчЪД ServerBootstrapAcceptor ф╕ня╝ЙхИЭхзЛхМЦчЪДуАВ</p> <p>цЧашо║цШпхИЫх╗║ NioServerSocketChannel щЗМчЪД pipeline ш┐ШцШпхИЫх╗║ NioSocketChannel щЗМчЪД pipeline , цЬАч╗ИщГ╜ф╝ЪхзФцЙШч╗ЩхоГф╗мчЪДчИ╢ч▒╗ AbstractChannel уАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191115176.webp" alt="хЫ╛чЙЗ"></p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractChannel</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultAttributeMap</span> <span class="token keyword">implements</span> <span class="token class-name">Channel</span> <span class="token punctuation">{</span>

    <span class="token keyword">protected</span> <span class="token class-name">AbstractChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>
        <span class="token comment">//channel хЕих▒АхФпф╕АID machineId+processId+sequence+timestamp+random</span>
        id <span class="token operator">=</span> <span class="token function">newId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//unsafeчФиф║Ох║Хх▒ВsocketчЪДчЫ╕хЕ│цУНф╜Ь</span>
        unsafe <span class="token operator">=</span> <span class="token function">newUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//ф╕║channelхИЖщЕНчЛмчлЛчЪДpipelineчФиф║ОIOф║Лф╗╢ч╝ЦцОТ</span>
        pipeline <span class="token operator">=</span> <span class="token function">newChannelPipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token class-name">DefaultChannelPipeline</span> <span class="token function">newChannelPipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultChannelPipeline</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultChannelPipeline</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelPipeline</span> <span class="token punctuation">{</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">//pipelineф╕нчЪДхд┤ч╗УчВ╣</span>
    <span class="token keyword">final</span> <span class="token class-name">AbstractChannelHandlerContext</span> head<span class="token punctuation">;</span>
    
    <span class="token comment">//pipelineф╕нчЪДх░╛ч╗УчВ╣</span>
    <span class="token keyword">final</span> <span class="token class-name">AbstractChannelHandlerContext</span> tail<span class="token punctuation">;</span>

    <span class="token comment">//pipelineф╕нцМБцЬЙхп╣х║ФchannelчЪДх╝ХчФи</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">protected</span> <span class="token class-name">DefaultChannelPipeline</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//pipelineф╕нцМБцЬЙхп╣х║ФchannelчЪДх╝ХчФи</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>channel <span class="token operator">=</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token string">&quot;channel&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        tail <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TailContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        head <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HeadContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        head<span class="token punctuation">.</span>next <span class="token operator">=</span> tail<span class="token punctuation">;</span>
        tail<span class="token punctuation">.</span>prev <span class="token operator">=</span> head<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хЬихЙНш╛╣чЪДч│╗хИЧцЦЗчлаф╕нчмФшАЕхдЪцмбцПРхИ░ш┐Зя╝Мpipeline чЪДч╗УцЮДцШпчФ▒ ChannelHandlerContext ч▒╗хЮЛчЪДшКВчВ╣цЮДцИРчЪДхПМхРСщУ╛шбиуАВхЕ╢ф╕нхд┤ч╗УчВ╣ф╕║ HeadContext я╝Мх░╛ч╗УчВ╣ф╕║ TailContext уАВхЕ╢хИЭхзЛч╗УцЮДхжВф╕Ля╝Ъ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192214784.webp" alt="хЫ╛чЙЗ"></p> <h3 id="_2-1-headcontext"><a href="#_2-1-headcontext" class="header-anchor">#</a> 2.1 HeadContext</h3> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">HEAD_NAME</span> <span class="token operator">=</span> <span class="token function">generateName0</span><span class="token punctuation">(</span><span class="token class-name">HeadContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HeadContext</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractChannelHandlerContext</span>
    <span class="token keyword">implements</span> <span class="token class-name">ChannelOutboundHandler</span><span class="token punctuation">,</span> <span class="token class-name">ChannelInboundHandler</span> <span class="token punctuation">{</span>
    <span class="token comment">//headContextф╕нцМБцЬЙхп╣channel unsafeцУНф╜Ьч▒╗чЪДх╝ХчФи чФиф║ОцЙзшбМchannelх║Хх▒ВцУНф╜Ь</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Unsafe</span> unsafe<span class="token punctuation">;</span>

    <span class="token class-name">HeadContext</span><span class="token punctuation">(</span><span class="token class-name">DefaultChannelPipeline</span> pipeline<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>pipeline<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token constant">HEAD_NAME</span><span class="token punctuation">,</span> <span class="token class-name">HeadContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//цМБцЬЙchannel unsafeцУНф╜Ьч▒╗чЪДх╝ХчФия╝МхРОч╗нчФиф║ОцЙзшбМchannelх║Хх▒ВцУНф╜Ь</span>
        unsafe <span class="token operator">=</span> pipeline<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//шо╛ч╜оchannelHandlerчЪДчК╢цАБф╕║ADD_COMPLETE</span>
        <span class="token function">setAddComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ChannelHandler</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цИСф╗мчЯещБУхПМхРСщУ╛шбич╗УцЮДчЪД pipeline ф╕нчЪДшКВчВ╣хЕГч┤аф╕║ ChannelHandlerContext я╝МцЧвчД╢ HeadContext ф╜Ьф╕║ pipeline чЪДхд┤ч╗УчВ╣я╝МщВгф╣ИхоГф╕АхоЪцШп ChannelHandlerContext ч▒╗хЮЛчЪДя╝МцЙАф╗ехоГщЬАшжБч╗зцЙ┐хоЮчО░ AbstractChannelHandlerContext я╝МчЫ╕х╜Уф║Оф╕Аф╕кхУихЕ╡чЪДф╜ЬчФия╝МхЫаф╕║чФицИ╖хПпф╗еф╗еф╗╗цДПщб║х║ПхРС pipeline ф╕нц╖╗хКа ChannelHandler я╝МщЬАшжБчФи HeadContext цЭехЫ║хоЪцМЗхРСчммф╕Аф╕к ChannelHandlerContext уАВ</p> <blockquote><p>хЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484532&amp;idx=1&amp;sn=c3a8b37a2eb09509d9914494ef108c68&amp;chksm=ce77c233f9004b25a29f9fdfb179e41646092d09bc89df2147a9fab66df13231e46dd6a5c26d&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">уАКф╕АцЦЗцРЮцЗВ Netty хПСщАБцХ░цНохЕиц╡БчиЛуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ф╕АцЦЗф╕нчЪДуАК1. ChannelHandlerContextуАЛх░ПшКВф╕ня╝МчмФшАЕцЫ╛ф╕║хдзхо╢шпжч╗Жф╗Лч╗Нш┐З ChannelHandlerContext хЬи pipeline ф╕нчЪДф╜ЬчФия╝Мх┐Шшо░чЪДхРМхнжхПпф╗ехЬихЫЮчЬЛф╕ЛуАВ</p></blockquote> <p>ф║ОцндхРМцЧ╢ HeadContext хПИхоЮчО░ф║Ж ChannelInboundHandler хТМ ChannelOutboundHandler цОехПгя╝Мшп┤цШО HeadContext хН│цШпф╕Аф╕к ChannelHandlerContext хПИцШпф╕Аф╕к ChannelHandler я╝МхоГхПпф╗ехРМцЧ╢хдДчРЖ Inbound ф║Лф╗╢хТМ Outbound ф║Лф╗╢уАВ</p> <p>цИСф╗мф╣Яц│ицДПхИ░ HeadContext ф╕нцМБцЬЙф║Жхп╣х║Ф channel чЪДх║Хх▒ВцУНф╜Ьч▒╗ unsafe я╝Мш┐Щф╣Яшп┤цШО IO ф║Лф╗╢хЬи pipeline ф╕нчЪДф╝ацТнцЬАч╗Иф╝ЪшР╜хЬи HeadContext ф╕нш┐ЫшбМцЬАхРОчЪД IO хдДчРЖуАВхоГцШп Inbound ф║Лф╗╢чЪДхдДчРЖш╡╖чВ╣я╝Мф╣ЯцШп Outbound ф║Лф╗╢чЪДхдДчРЖч╗ИчВ╣уАВш┐ЩщЗМф╣ЯхПпф╗ечЬЛхЗ║ HeadContext щЩдф║Жш╡╖хИ░хУихЕ╡чЪДф╜ЬчФия╝МхоГш┐ШцЙ┐цЛЕф║Жхп╣ channel х║Хх▒ВчЫ╕хЕ│чЪДцУНф╜ЬуАВ</p> <p>цпФхжВцИСф╗мхЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484005&amp;idx=1&amp;sn=52f51269902a58f40d33208421109bc3&amp;chksm=ce77c422f9004d340e5b385ef6ba24dfba1f802076ace80ad6390e934173a10401e64e13eaeb&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">уАКReactor хЬи Netty ф╕нчЪДхоЮчО░(хРпхКичпЗ)уАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕нф╗Лч╗НчЪД NioServerSocketChannel хЬихРС main reactor ц│ихЖМхоМцИРхРОф╝ЪшзжхПС ChannelRegistered ф║Лф╗╢ф╗О HeadContext х╝АхзЛф╛ЭцмбхЬи pipeline ф╕нхРСхРОф╝ацТнуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRegistered</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//цндцЧ╢firstRegistrationх╖▓ч╗ПхПШф╕║false,хЬиpipeline.invokeHandlerAddedIfNeededф╕нх╖▓швлш░ГчФиш┐З</span>
    <span class="token function">invokeHandlerAddedIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">fireChannelRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ф╗ехПК NioServerSocketChannel хЬиф╕ОчлпхПгч╗СхоЪцИРхКЯхРОф╝ЪшзжхПС ChannelActive ф║Лф╗╢ф╗О HeadContext х╝АхзЛф╛ЭцмбхЬи pipeline ф╕нхРСхРОф╝ацТня╝Мх╣╢хЬи HeadContext ф╕нщАЪш┐З unsafe.beginRead() ц│ихЖМ OP_ACCEPT ф║Лф╗╢хИ░ main reactor ф╕нуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//шзжхПСц│ихЖМOP_ACCEPTцИЦшАЕOP_READф║Лф╗╢</span>
    unsafe<span class="token punctuation">.</span><span class="token function">beginRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хРМчРЖхЬи NioSocketChannel хЬихРС sub reactor ц│ихЖМцИРхКЯхРОуАВф╝ЪхЕИхРОшзжхПС ChannelRegistered ф║Лф╗╢хТМ ChannelActive ф║Лф╗╢ф╗О HeadContext х╝АхзЛхЬи pipeline ф╕нхРСхРОф╝ацТнуАВх╣╢хЬи HeadContext ф╕нщАЪш┐З unsafe.beginRead() ц│ихЖМ OP_READ ф║Лф╗╢хИ░ sub reactor ф╕нуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelActive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//pipelineф╕нч╗зч╗нхРСхРОф╝ацТнchannelActiveф║Лф╗╢</span>
    ctx<span class="token punctuation">.</span><span class="token function">fireChannelActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//хжВцЮЬцШпautoRead хИЩшЗкхКишзжхПСreadф║Лф╗╢ф╝ацТн</span>
    <span class="token comment">//хЬиreadхЫЮш░ГхЗ╜цХ░ф╕н шзжхПСOP_ACCEPTцИЦшАЕOP_READф║Лф╗╢ц│ихЖМ</span>
    <span class="token function">readIfIsAutoRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484532&amp;idx=1&amp;sn=c3a8b37a2eb09509d9914494ef108c68&amp;chksm=ce77c233f9004b25a29f9fdfb179e41646092d09bc89df2147a9fab66df13231e46dd6a5c26d&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">уАКф╕АцЦЗцРЮцЗВ Netty хПСщАБцХ░цНохЕиц╡БчиЛуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕нф╗Лч╗НчЪД write ф║Лф╗╢хТМ flush ф║Лф╗╢цЬАч╗Иф╝ЪхЬи pipeline ф╕нф╗ОхРОхРСхЙНф╕АчЫ┤ф╝ацТнхИ░ HeadContext я╝Мх╣╢хЬи HeadContext ф╕нчЫ╕х║Фф║Лф╗╢хЫЮш░ГхЗ╜цХ░ф╕нш░ГчФи unsafe ч▒╗цУНф╜Ьх║Хх▒В channel хПСщАБцХ░цНоуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//хИ░headContextш┐ЩщЗМ msgчЪДч▒╗хЮЛх┐Ещб╗цШпByteBufferя╝Мф╣Ях░▒цШпшп┤х┐Ещб╗ч╗Пш┐Зч╝ЦчаБхЩих░Жф╕ЪхКбх▒ВхЖЩхЕечЪДхоЮф╜Уч╝ЦчаБф╕║ByteBuffer</span>
    unsafe<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unsafe<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>ф╗ОцЬмх░ПшКВчЪДхЖЕхо╣ф╗Лч╗Нф╕ня╝МцИСф╗мхПпф╗ечЬЛхЗ║хЬи Netty ф╕нхп╣ф║О Channel чЪДчЫ╕хЕ│х║Хх▒ВцУНф╜Ьш░ГчФихЭЗцШпхЬи HeadContext ф╕ншзжхПСчЪДуАВ</p></blockquote> <h3 id="_2-2-tailcontext"><a href="#_2-2-tailcontext" class="header-anchor">#</a> 2.2 TailContext</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TAIL_NAME</span> <span class="token operator">=</span> <span class="token function">generateName0</span><span class="token punctuation">(</span><span class="token class-name">TailContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">TailContext</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractChannelHandlerContext</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelInboundHandler</span> <span class="token punctuation">{</span>

    <span class="token class-name">TailContext</span><span class="token punctuation">(</span><span class="token class-name">DefaultChannelPipeline</span> pipeline<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>pipeline<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token constant">TAIL_NAME</span><span class="token punctuation">,</span> <span class="token class-name">TailContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//шо╛ч╜оchannelHandlerчЪДчК╢цАБф╕║ADD_COMPLETE</span>
        <span class="token function">setAddComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ChannelHandler</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хРМца╖ TailContext ф╜Ьф╕║хПМхРСщУ╛шбич╗УцЮДчЪД pipeline ф╕нчЪДх░╛ч╗УчВ╣я╝Мф╣ЯщЬАшжБч╗зцЙ┐хоЮчО░ AbstractChannelHandlerContext уАВф╜ЖхоГхРМцЧ╢хПИхоЮчО░ф║Ж ChannelInboundHandler</p> <p>ш┐Щшп┤цШО TailContext щЩдф║ЖцШпф╕Аф╕к ChannelHandlerContext хРМцЧ╢ф╣ЯцШпф╕Аф╕к ChannelInboundHandler уАВ</p> <h4 id="_2-2-1-tailcontext-ф╜Ьф╕║ф╕Аф╕к-channelhandlercontext-чЪДф╜ЬчФи"><a href="#_2-2-1-tailcontext-ф╜Ьф╕║ф╕Аф╕к-channelhandlercontext-чЪДф╜ЬчФи" class="header-anchor">#</a> 2.2.1 TailContext ф╜Ьф╕║ф╕Аф╕к ChannelHandlerContext чЪДф╜ЬчФи</h4> <p>TailContext ф╜Ьф╕║ф╕Аф╕к ChannelHandlerContext чЪДф╜ЬчФицШпш┤Яш┤гх░Ж outbound ф║Лф╗╢ф╗О pipeline чЪДцЬлх░╛ф╕АчЫ┤хРСхЙНф╝ацТнчЫ┤хИ░ HeadContext уАВх╜УчД╢хЙНцПРцШпчФицИ╖щЬАшжБш░ГчФи channel чЪДчЫ╕хЕ│ outbound цЦ╣ц│ХуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Channel</span> <span class="token keyword">extends</span> <span class="token class-name">AttributeMap</span><span class="token punctuation">,</span> <span class="token class-name">ChannelOutboundInvoker</span><span class="token punctuation">,</span> <span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token class-name">ChannelFuture</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ChannelFuture</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ChannelOutboundInvoker</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ChannelFuture</span> <span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ChannelFuture</span> <span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractChannel</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultAttributeMap</span> <span class="token keyword">implements</span> <span class="token class-name">Channel</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> pipeline<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Channel</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pipeline<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> pipeline<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultChannelPipeline</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelPipeline</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> tail<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        tail<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> <span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> tail<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>ш┐ЩщЗМцИСф╗мхПпф╗ечЬЛхИ░я╝Мх╜УцИСф╗мхЬишЗкхоЪф╣Й ChannelHandler ф╕нш░ГчФи <code>ctx.channel().write(msg)</code> цЧ╢я╝Мф╝ЪхЬи AbstractChannel ф╕ншзжхПС pipeline.write(msg) я╝МцЬАч╗ИхЬи DefaultChannelPipeline ф╕нш░ГчФи tail.write(msg) уАВф╜┐х╛Ч write ф║Лф╗╢хПпф╗еф╗О pipeline чЪДцЬлх░╛х╝АхзЛхРСхЙНф╝ацТня╝МхЕ╢ф╗Ц outbound ф║Лф╗╢чЪДф╝ацТнф╣ЯцШпф╕Аца╖чЪДщБУчРЖуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>шАМцИСф╗мшЗкхоЪф╣ЙчЪД ChannelHandler ф╝Ъшвлх░БшгЕхЬиф╕Аф╕к ChannelHandlerContext ф╕нф╗ОшАМхКахЕехИ░ pipeline ф╕ня╝МшАМш┐Щф╕кчФиф║ОшгЕш╜╜шЗкхоЪф╣Й ChannelHandler чЪД ChannelHandlerContext ф╕О TailContext ф╕Аца╖цЬмш┤иф╣ЯщГ╜цШп ChannelHandlerContext я╝МхПкф╕Нш┐ЗхЬи pipeline ф╕нчЪДф╜Нч╜оф╕НхРМч╜вф║ЖуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191115318.webp" alt="хЫ╛чЙЗ"></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ChannelHandlerContext</span> <span class="token keyword">extends</span> <span class="token class-name">AttributeMap</span><span class="token punctuation">,</span> <span class="token class-name">ChannelInboundInvoker</span><span class="token punctuation">,</span> <span class="token class-name">ChannelOutboundInvoker</span> <span class="token punctuation">{</span>

    <span class="token class-name">ChannelFuture</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ChannelFuture</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ChannelOutboundInvoker</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ChannelFuture</span> <span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ChannelFuture</span> <span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><p>цИСф╗мчЬЛхИ░ ChannelHandlerContext цОехПгцЬмш║лф╣Яф╝Ъч╗зцЙ┐ ChannelInboundInvoker хТМ ChannelOutboundInvoker цОехПгя╝МцЙАф╗ешп┤ ContextHandlerContext ф╣ЯхПпф╗ешзжхПС inbound ф║Лф╗╢хТМ outbound ф║Лф╗╢я╝МхПкф╕Нш┐Зшбиш╛╛чЪДшпнф╣ЙцШпхЬи pipeline ф╕нф╗Ох╜УхЙН ChannelHandler х╝АхзЛхРСхЙНцИЦшАЕхРСхРОф╝ацТн outbound ф║Лф╗╢цИЦшАЕ inbound ф║Лф╗╢уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>ш┐ЩщЗМшбичд║ write ф║Лф╗╢ф╗Ох╜УхЙН EchoServerHandler х╝АхзЛхЬи pipeline ф╕нхРСхЙНф╝ацТнчЫ┤хИ░ HeadContext уАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192217877.webp" alt="хЫ╛чЙЗ"></p> <h4 id="_2-2-2-tailcontext-ф╜Ьф╕║ф╕Аф╕к-channelinboundhandler-чЪДф╜ЬчФи"><a href="#_2-2-2-tailcontext-ф╜Ьф╕║ф╕Аф╕к-channelinboundhandler-чЪДф╜ЬчФи" class="header-anchor">#</a> 2.2.2 TailContext ф╜Ьф╕║ф╕Аф╕к ChannelInboundHandler чЪДф╜ЬчФи</h4> <p>цЬАхРО TailContext ф╜Ьф╕║ф╕Аф╕к ChannelInboundHandler чЪДф╜ЬчФих░▒цШпф╕║ inbound ф║Лф╗╢хЬи pipeline ф╕нчЪДф╝ацТнхБЪф╕Аф╕кхЕЬх║ХчЪДхдДчРЖуАВ</p> <p>ш┐ЩщЗМцПРхИ░чЪДхЕЬх║ХхдДчРЖцШпф╗Аф╣ИцДПцАЭхСвя╝Я</p> <p>цпФхжВцИСф╗мхЙНш╛╣ф╗Лч╗НхИ░чЪДя╝МхЬи NioSocketChannel хРС sub reactor ц│ихЖМцИРхКЯхРОф╣ЛхРОшзжхПСчЪД ChannelRegistered ф║Лф╗╢хТМ ChannelActive ф║Лф╗╢уАВцИЦшАЕхЬи reactor ч║┐чиЛшп╗хПЦ NioSocketChannel ф╕нчЪДшп╖ц▒ВцХ░цНоцЧ╢цЙАшзжхПСчЪД channelRead ф║Лф╗╢хТМ ChannelReadComplete ф║Лф╗╢уАВ</p> <p>ш┐Щф║Ы inbound ф║Лф╗╢щГ╜ф╝ЪщжЦхЕИф╗О HeadContext х╝АхзЛхЬи pipeline ф╕нф╕Аф╕кф╕Аф╕кчЪДхРСхРОф╝ащАТуАВ</p> <p>цЮБчлпчЪДцГЕхЖ╡цШпхжВцЮЬ pipeline ф╕нцЙАцЬЙ ChannelInboundHandler ф╕нчЫ╕х║ФчЪД inbound ф║Лф╗╢хЫЮш░ГцЦ╣ц│ХхЭЗф╕Нхп╣ф║Лф╗╢ф╜ЬхЗ║хдДчРЖя╝Мх╣╢ч╗зч╗нхРСхРОф╝ацТнуАВхжВф╕Лчд║ф╛Лф╗гчаБцЙАчд║я╝Ъ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">fireChannelRead</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelReadComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">fireChannelReadComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRegistered</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">fireChannelRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelActive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">fireChannelActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цЬАч╗Иш┐Щф║Ы inbound ф║Лф╗╢хЬи pipeline ф╕нх╛Чф╕НхИ░хдДчРЖя╝МцЬАхРОф╝Ъф╝ацТнхИ░ TailContext ф╕нуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">TailContext</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractChannelHandlerContext</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelInboundHandler</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">onUnhandledInboundMessage</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelReadComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">onUnhandledInboundChannelReadComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelActive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">onUnhandledInboundChannelActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>шАМхЬи TailContext ф╕нщЬАшжБхп╣ш┐Щф║Ых╛Чф╕НхИ░ф╗╗ф╜ХхдДчРЖчЪД inbound ф║Лф╗╢хБЪхЗ║цЬАч╗ИхдДчРЖуАВцпФхжВф╕вх╝Гшпе msgя╝Мх╣╢щЗКцФ╛цЙАхНачФичЪД directByteBufferя╝Мф╗ехЕНхПСчФЯхЖЕхнШц│ДщЬ▓уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onUnhandledInboundMessage</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">onUnhandledInboundMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Discarded message pipeline : {}. Channel : {}.&quot;</span><span class="token punctuation">,</span>
                     ctx<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">names</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onUnhandledInboundMessage</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>
            <span class="token string">&quot;Discarded inbound message {} that reached at the tail of the pipeline. &quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;Please check your pipeline configuration.&quot;</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token class-name">ReferenceCountUtil</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_3-pipeline-ф╕нчЪДф║Лф╗╢хИЖч▒╗"><a href="#_3-pipeline-ф╕нчЪДф║Лф╗╢хИЖч▒╗" class="header-anchor">#</a> 3. pipeline ф╕нчЪДф║Лф╗╢хИЖч▒╗</h2> <p>хЬихЙНш╛╣чЪДч│╗хИЧцЦЗчлаф╕ня╝МчмФшАЕхдЪцмбф╗Лч╗Нш┐Зя╝МNetty ф╕нчЪД IO ф║Лф╗╢ф╕АхЕ▒хИЖф╕║ф╕дхдзч▒╗я╝Ъinbound ч▒╗ф║Лф╗╢хТМ outbound ч▒╗ф║Лф╗╢уАВхЕ╢хоЮхжВцЮЬф╕еца╝цЭехИЖчЪДшпЭх║ФшпехИЖф╕║ф╕Йч▒╗уАВчммф╕ЙчзНф║Лф╗╢ч▒╗хЮЛф╕║ exceptionCaught х╝Вх╕╕ф║Лф╗╢ч▒╗хЮЛуАВ</p> <p>шАМ exceptionCaught ф║Лф╗╢хЬиф║Лф╗╢ф╝ацТншзТх║жф╕КцЭешп┤хТМ inbound ч▒╗ф║Лф╗╢ф╕Аца╖я╝МщГ╜цШпф╗О pipeline чЪД HeadContext х╝АхзЛф╕АчЫ┤хРСхРОф╝ащАТцИЦшАЕф╗Ох╜УхЙН ChannelHandler х╝АхзЛф╕АчЫ┤хРСхРОф╝ащАТчЫ┤хИ░ TailContext уАВцЙАф╗еф╕АшИмф╣Яф╝Ъх░Ж exceptionCaught ф║Лф╗╢ч╗Яф╕Ах╜Тф╕║ inbound ч▒╗ф║Лф╗╢уАВ</p> <p>шАМца╣цНоф║Лф╗╢ч▒╗хЮЛчЪДхИЖч▒╗я╝МчЫ╕х║Фш┤Яш┤гхдДчРЖф║Лф╗╢хЫЮш░ГчЪД ChannelHandler ф╣Яф╝ЪшвлхИЖф╕║ф╕дч▒╗я╝Ъ</p> <ul><li><code>ChannelInboundHandler</code> я╝Ъф╕╗шжБш┤Яш┤гхУНх║ФхдДчРЖ inbound ч▒╗ф║Лф╗╢хЫЮш░ГхТМ exceptionCaught ф║Лф╗╢хЫЮш░ГуАВ</li> <li><code>ChannelOutboundHandler</code> я╝Ъф╕╗шжБш┤Яш┤гхУНх║ФхдДчРЖ outbound ч▒╗ф║Лф╗╢хЫЮш░ГуАВ</li></ul> <p>щВгф╣ИцИСф╗мх╕╕шп┤чЪД inbound ч▒╗ф║Лф╗╢хТМ outbound ч▒╗ф║Лф╗╢хЕ╖ф╜УщГ╜хМЕхРлхУкф║Ыф║Лф╗╢хСвя╝Я</p> <h3 id="_3-1-inbound-ч▒╗ф║Лф╗╢"><a href="#_3-1-inbound-ч▒╗ф║Лф╗╢" class="header-anchor">#</a> 3.1 inbound ч▒╗ф║Лф╗╢</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ChannelHandlerMask</span> <span class="token punctuation">{</span>

    <span class="token comment">// inboundф║Лф╗╢щЫЖхРИ</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_ONLY_INBOUND</span> <span class="token operator">=</span>  <span class="token constant">MASK_CHANNEL_REGISTERED</span> <span class="token operator">|</span>
            <span class="token constant">MASK_CHANNEL_UNREGISTERED</span> <span class="token operator">|</span> <span class="token constant">MASK_CHANNEL_ACTIVE</span> <span class="token operator">|</span> <span class="token constant">MASK_CHANNEL_INACTIVE</span> <span class="token operator">|</span> <span class="token constant">MASK_CHANNEL_READ</span> <span class="token operator">|</span>
            <span class="token constant">MASK_CHANNEL_READ_COMPLETE</span> <span class="token operator">|</span> <span class="token constant">MASK_USER_EVENT_TRIGGERED</span> <span class="token operator">|</span> <span class="token constant">MASK_CHANNEL_WRITABILITY_CHANGED</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_ALL_INBOUND</span> <span class="token operator">=</span> <span class="token constant">MASK_EXCEPTION_CAUGHT</span> <span class="token operator">|</span> <span class="token constant">MASK_ONLY_INBOUND</span><span class="token punctuation">;</span>

    <span class="token comment">// inbound ч▒╗ф║Лф╗╢чЫ╕хЕ│цОйчаБ</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_EXCEPTION_CAUGHT</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_CHANNEL_REGISTERED</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_CHANNEL_UNREGISTERED</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_CHANNEL_ACTIVE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_CHANNEL_INACTIVE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_CHANNEL_READ</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_CHANNEL_READ_COMPLETE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_USER_EVENT_TRIGGERED</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_CHANNEL_WRITABILITY_CHANGED</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><p>netty ф╝Ъх░ЖхЕ╢цФпцМБчЪДцЙАцЬЙх╝Вцнеф║Лф╗╢чФицОйчаБцЭешбичд║я╝МхоЪф╣ЙхЬи ChannelHandlerMask ч▒╗ф╕ня╝М netty цбЖцЮ╢щАЪш┐Зш┐Щф║Ыф║Лф╗╢цОйчаБхПпф╗ех╛ИцЦ╣ф╛┐чЪДчЯещБУчФицИ╖шЗкхоЪф╣ЙчЪД ChannelHandler цШпх▒Юф║Оф╗Аф╣Ич▒╗хЮЛчЪДя╝ИChannelInboundHandler or ChannelOutboundHandler я╝ЙуАВ</p> <p>щЩдцндф╣ЛхдЦя╝Мinbound ч▒╗ф║Лф╗╢хжВцндф╣ЛхдЪя╝МчФицИ╖ф╣Ях╣╢ф╕НцШпхп╣цЙАцЬЙчЪД inbound ч▒╗ф║Лф╗╢цДЯхЕ┤ш╢гя╝МчФицИ╖хПпф╗ехЬишЗкхоЪф╣ЙчЪД ChannelInboundHandler ф╕ншжЖчЫЦшЗкх╖▒цДЯхЕ┤ш╢гчЪД inbound ф║Лф╗╢хЫЮш░Гя╝Мф╗ОшАМш╛╛хИ░щТИхп╣чЙ╣хоЪ inbound ф║Лф╗╢чЪДчЫСхРмуАВ</p> <p>ш┐Щф║ЫчФицИ╖цДЯхЕ┤ш╢гчЪД inbound ф║Лф╗╢щЫЖхРИхРМца╖ф╣Яф╝ЪчФицОйчаБчЪДх╜вх╝Пф┐ЭхнШхЬишЗкхоЪф╣Й ChannelHandler хп╣х║ФчЪД ChannelHandlerContext ф╕ня╝Мш┐Щца╖х╜УчЙ╣хоЪ inbound ф║Лф╗╢хЬи pipeline ф╕нх╝АхзЛф╝ацТнчЪДцЧ╢хАЩя╝Мnetty хПпф╗еца╣цНохп╣х║Ф ChannelHandlerContext ф╕нф┐ЭхнШчЪД inbound ф║Лф╗╢щЫЖхРИцОйчаБцЭехИдцЦня╝МчФицИ╖шЗкхоЪф╣ЙчЪД ChannelHandler цШпхРжхп╣шпе inbound ф║Лф╗╢цДЯхЕ┤ш╢гя╝Мф╗ОшАМхЖ│хоЪцШпхРжцЙзшбМчФицИ╖шЗкхоЪф╣Й ChannelHandler ф╕нчЪДчЫ╕х║ФхЫЮш░ГцЦ╣ц│ХцИЦшАЕш╖│ш┐Зхп╣шпе inbound ф║Лф╗╢ф╕НцДЯхЕ┤ш╢гчЪД ChannelHandler ч╗зч╗нхРСхРОф╝ацТнуАВ</p> <blockquote><p>ф╗Оф╗еф╕КцППш┐░ф╕ня╝МцИСф╗мф╣ЯхПпф╗ечкецОвхЗ║я╝МNetty х╝ХхЕе ChannelHandlerContext цЭех░БшгЕ ChannelHandler чЪДхОЯхЫая╝МхЬиф╗гчаБшо╛шобф╕Кш┐ШцШпщБ╡х╛кхНХф╕АшБМш┤гчЪДхОЯхИЩя╝М ChannelHandler цШпчФицИ╖цОешзжцЬАщвСч╣БчЪДф╕Аф╕к netty ч╗Дф╗╢я╝Мnetty х╕МцЬЫчФицИ╖шГ╜хдЯцККхЕищГиц│ицДПхКЫцФ╛хЬицЬАца╕х┐ГчЪД IO хдДчРЖф╕Кя╝МчФицИ╖хПкщЬАшжБхЕ│х┐ГшЗкх╖▒хп╣хУкф║Ых╝Вцнеф║Лф╗╢цДЯхЕ┤ш╢гх╣╢шАГшЩСчЫ╕х║ФчЪДхдДчРЖщА╗ш╛СхН│хПпя╝МшАМх╣╢ф╕НщЬАшжБхЕ│х┐Гх╝Вцнеф║Лф╗╢хЬи pipeline ф╕нхжВф╜Хф╝ащАТя╝МхжВф╜ХщАЙцЛйхЕ╖цЬЙцЙзшбМцЭбф╗╢чЪД ChannelHandler хО╗цЙзшбМцИЦшАЕш╖│ш┐ЗуАВш┐Щф║ЫхИЗщЭвцАзш┤ичЪДщА╗ш╛Ся╝Мnetty х░ЖхоГф╗мф╜Ьф╕║ф╕Кф╕ЛцЦЗф┐бцБпхЕищГих░БшгЕхЬи ChannelHandlerContext ф╕нчФ▒ netty цбЖцЮ╢цЬмш║лш┤Яш┤гхдДчРЖуАВ</p></blockquote> <blockquote><p>ф╗еф╕Кш┐Щф║ЫхЖЕхо╣я╝МчмФшАЕш┐Шф╝ЪхЬиф║Лф╗╢ф╝ацТнчЫ╕хЕ│х░ПшКВхБЪшпжч╗ЖчЪДф╗Лч╗Ня╝Мф╣ЛцЙАф╗еш┐ЩщЗМх╝ХхЗ║я╝Мш┐ШцШпф╕║ф║Жшойхдзхо╢цДЯхПЧф╕ЛхИйчФицОйчаБш┐ЫшбМщЫЖхРИцУНф╜ЬчЪДф╛┐хИйцАзя╝Мnetty ф╕нч▒╗ф╝╝ш┐Щца╖чЪДшо╛шобш┐ШцЬЙх╛ИхдЪя╝МцпФхжВхЙНш╛╣ч│╗хИЧцЦЗчлаф╕нхдЪцмбцПРхИ░ш┐ЗчЪДя╝Мchannel хЖНхРС reactor ц│ихЖМ IO ф║Лф╗╢цЧ╢я╝Мnetty ф╣ЯцШпх░Ж channel цДЯхЕ┤ш╢гчЪД IO ф║Лф╗╢чФицОйчаБчЪДх╜вх╝ПхнШхВиф║О SelectionKey ф╕нчЪД int interestOps ф╕нуАВ</p></blockquote> <p>цОеф╕ЛцЭечмФшАЕх░▒ф╕║хдзхо╢ф╗Лч╗Нф╕Лш┐Щф║Ы inbound ф║Лф╗╢я╝Мх╣╢цв│чРЖхЗ║ш┐Щф║Ы inbound ф║Лф╗╢чЪДшзжхПСцЧ╢цЬ║уАВцЦ╣ф╛┐хдзхо╢ца╣цНохРДшЗкф╕ЪхКбщЬАц▒ВчБ╡ц┤╗хЬ░ш┐ЫшбМчЫСхРмуАВ</p> <h4 id="_3-1-1-exceptioncaught-ф║Лф╗╢"><a href="#_3-1-1-exceptioncaught-ф║Лф╗╢" class="header-anchor">#</a> 3.1.1 ExceptionCaught ф║Лф╗╢</h4> <p>хЬицЬмх░ПшКВф╗Лч╗НчЪДш┐Щф║Ы inbound ч▒╗ф║Лф╗╢хЬи pipeline ф╕нф╝ацТнчЪДш┐ЗчиЛф╕ня╝МхжВцЮЬхЬичЫ╕х║Фф║Лф╗╢хЫЮш░ГхЗ╜цХ░цЙзшбМчЪДш┐ЗчиЛф╕нхПСчФЯх╝Вх╕╕я╝МщВгф╣Их░▒ф╝ЪшзжхПСхп╣х║Ф ChannelHandler ф╕нчЪД exceptionCaught ф║Лф╗╢хЫЮш░ГуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeExceptionCaught</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">invokeHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exceptionCaught</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;An exception {}&quot;</span> <span class="token operator">+</span>
                    <span class="token string">&quot;was thrown by a user handler's exceptionCaught() &quot;</span> <span class="token operator">+</span>
                    <span class="token string">&quot;method while handling the following exception:&quot;</span><span class="token punctuation">,</span>
                    <span class="token class-name">ThrowableUtil</span><span class="token punctuation">.</span><span class="token function">stackTraceToString</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;An exception '{}' [enable DEBUG level for full stacktrace] &quot;</span> <span class="token operator">+</span>
                    <span class="token string">&quot;was thrown by a user handler's exceptionCaught() &quot;</span> <span class="token operator">+</span>
                    <span class="token string">&quot;method while handling the following exception:&quot;</span><span class="token punctuation">,</span> error<span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">fireExceptionCaught</span><span class="token punctuation">(</span>cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>х╜УчД╢чФицИ╖хПпф╗ещАЙцЛйхЬи exceptionCaught ф║Лф╗╢хЫЮш░Гф╕нцШпхРжцЙзшбМ ctx.fireExceptionCaught(cause) ф╗ОшАМхЖ│хоЪцШпхРжх░Ж exceptionCaught ф║Лф╗╢ч╗зч╗нхРСхРОф╝ацТнуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exceptionCaught</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        ctx<span class="token punctuation">.</span><span class="token function">fireExceptionCaught</span><span class="token punctuation">(</span>cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>х╜У netty хЖЕца╕хдДчРЖш┐ЮцОечЪДцОецФ╢я╝Мф╗ехПКцХ░цНочЪДшп╗хПЦш┐ЗчиЛф╕нхжВцЮЬхПСчФЯх╝Вх╕╕я╝Мф╝ЪхЬицХ┤ф╕к pipeline ф╕ншзжхПС exceptionCaught ф║Лф╗╢чЪДф╝ацТнуАВ</p> <p><strong>ш┐ЩщЗМчмФшАЕф╕║ф╗Аф╣ИшжБхНХчЛмх╝║ш░ГхЬи inbound ф║Лф╗╢ф╝ацТнчЪДш┐ЗчиЛф╕нхПСчФЯх╝Вх╕╕я╝МцЙНф╝ЪхЫЮш░Г exceptionCaught хСв</strong> ?</p> <p>хЫаф╕║ inbound ф║Лф╗╢ф╕АшИмщГ╜цШпчФ▒ netty хЖЕца╕шзжхПСф╝ацТнчЪДя╝МшАМ outbound ф║Лф╗╢ф╕АшИмщГ╜цШпчФ▒чФицИ╖щАЙцЛйшзжхПСчЪДя╝МцпФхжВчФицИ╖хЬихдДчРЖхоМф╕ЪхКбщА╗ш╛СшзжхПСчЪД write ф║Лф╗╢цИЦшАЕ flush ф║Лф╗╢уАВ</p> <p>шАМхЬичФицИ╖шзжхПС outbound ф║Лф╗╢хРОя╝Мф╕АшИмщГ╜ф╝Ъх╛ЧхИ░ф╕Аф╕к ChannelPromise уАВчФицИ╖хПпф╗ехРС ChannelPromise ц╖╗хКахРДчзН listener уАВх╜У outbound ф║Лф╗╢хЬиф╝ацТнчЪДш┐ЗчиЛф╕нхПСчФЯх╝Вх╕╕цЧ╢я╝Мnetty ф╝ЪщАЪчЯечФицИ╖цМБцЬЙчЪДш┐Щф╕к ChannelPromise я╝М<strong>ф╜Жф╕Нф╝ЪшзжхПС exceptionCaught чЪДхЫЮш░Г</strong>уАВ</p> <p>цпФхжВцИСф╗мхЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484532&amp;idx=1&amp;sn=c3a8b37a2eb09509d9914494ef108c68&amp;chksm=ce77c233f9004b25a29f9fdfb179e41646092d09bc89df2147a9fab66df13231e46dd6a5c26d&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">уАКф╕АцЦЗцРЮцЗВ Netty хПСщАБцХ░цНохЕиц╡БчиЛуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕АцЦЗф╕нф╗Лч╗НхИ░чЪДхЬи write ф║Лф╗╢ф╝ацТнчЪДш┐ЗчиЛф╕нх░▒ф╕Нф╝ЪшзжхПС exceptionCaught ф║Лф╗╢хЫЮш░ГуАВхПкцШпхО╗щАЪчЯечФицИ╖чЪД ChannelPromise уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeWrite0</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//ш░ГчФих╜УхЙНChannelHandlerф╕нчЪДwriteцЦ╣ц│Х</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ChannelOutboundHandler</span><span class="token punctuation">)</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">notifyOutboundHandlerException</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">notifyOutboundHandlerException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> cause<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">PromiseNotificationUtil</span><span class="token punctuation">.</span><span class="token function">tryFailure</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> cause<span class="token punctuation">,</span> promise <span class="token keyword">instanceof</span> <span class="token class-name">VoidChannelPromise</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> logger<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>шАМ outbound ф║Лф╗╢ф╕нхПкцЬЙ flush ф║Лф╗╢чЪДф╝ацТнцШпф╕кф╛ЛхдЦ</strong>я╝Мх╜У flush ф║Лф╗╢хЬи pipeline ф╝ацТнчЪДш┐ЗчиЛф╕нхПСчФЯх╝Вх╕╕цЧ╢я╝Мф╝ЪшзжхПСхп╣х║Фх╝Вх╕╕ ChannelHandler чЪД exceptionCaught ф║Лф╗╢хЫЮш░ГуАВхЫаф╕║ flush цЦ╣ц│ХчЪДчн╛хРНф╕нф╕Нф╝Ъч╗ЩчФицИ╖ш┐ФхЫЮ ChannelPromise уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token class-name">ChannelHandlerContext</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeFlush0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ChannelOutboundHandler</span><span class="token punctuation">)</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">invokeExceptionCaught</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_3-1-2-channelregistered-ф║Лф╗╢"><a href="#_3-1-2-channelregistered-ф║Лф╗╢" class="header-anchor">#</a> 3.1.2 ChannelRegistered ф║Лф╗╢</h4> <p>х╜У main reactor хЬихРпхКичЪДцЧ╢хАЩя╝МNioServerSocketChannel ф╝ЪшвлхИЫх╗║х╣╢хИЭхзЛхМЦя╝МщЪПхРОх░▒ф╝ЪхРС main reactor ц│ихЖМя╝Мх╜Уц│ихЖМцИРхКЯхРОх░▒ф╝ЪхЬи NioServerSocketChannel ф╕нчЪД pipeline ф╕нф╝ацТн ChannelRegistered ф║Лф╗╢уАВ</p> <p>х╜У main reactor цОецФ╢ховцИ╖члпхПСш╡╖чЪДш┐ЮцОехРОя╝МNioSocketChannel ф╝ЪшвлхИЫх╗║х╣╢хИЭхзЛхМЦя╝МщЪПхРОф╝ЪхРС sub reactor ц│ихЖМя╝Мх╜Уц│ихЖМцИРхКЯхРОф╝ЪхЬи NioSocketChannel ф╕нчЪД pipeline ф╝ацТн ChannelRegistered ф║Лф╗╢уАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192221352.webp" alt="хЫ╛чЙЗ"></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">register0</span><span class="token punctuation">(</span><span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">//цЙзшбМчЬЯцнгчЪДц│ихЖМцУНф╜Ь</span>
    <span class="token function">doRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">//шзжхПСchannelRegisterф║Лф╗╢</span>
    pipeline<span class="token punctuation">.</span><span class="token function">fireChannelRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>ц│ицДПя╝ЪцндцЧ╢хп╣х║ФчЪД channel ш┐Шц▓бцЬЙц│ихЖМ IO ф║Лф╗╢хИ░чЫ╕х║ФчЪД reactor ф╕нуАВ</p></blockquote> <h4 id="_3-1-3-channelactive-ф║Лф╗╢"><a href="#_3-1-3-channelactive-ф║Лф╗╢" class="header-anchor">#</a> 3.1.3 ChannelActive ф║Лф╗╢</h4> <p>х╜У NioServerSocketChannel хЖНхРС main reactor ц│ихЖМцИРхКЯх╣╢шзжхПС ChannelRegistered ф║Лф╗╢ф╝ацТнф╣ЛхРОя╝МщЪПхРОх░▒ф╝ЪхЬи pipeline ф╕ншзжхПС bind ф║Лф╗╢я╝МшАМ bind ф║Лф╗╢цШпф╕Аф╕к outbound ф║Лф╗╢я╝Мф╝Ъф╗О pipeline ф╕нчЪДх░╛ч╗УчВ╣ TailContext ф╕АчЫ┤хРСхЙНф╝ацТнцЬАч╗ИхЬи HeadContext ф╕нцЙзшбМчЬЯцнгчЪДч╗СхоЪцУНф╜ЬуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">bind</span><span class="token punctuation">(</span>
    <span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//шзжхПСAbstractChannel-&gt;bindцЦ╣ц│Х цЙзшбМJDK NIO SelectableChannel цЙзшбМх║Хх▒Вч╗СхоЪцУНф╜Ь</span>
    unsafe<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>localAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token function">doBind</span><span class="token punctuation">(</span>localAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

   <span class="token comment">//ч╗СхоЪцИРхКЯхРО channelц┐Ац┤╗ шзжхПСchannelActiveф║Лф╗╢ф╝ацТн</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>wasActive <span class="token operator">&amp;&amp;</span> <span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">invokeLater</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//HeadContext-&gt;channelActive хЫЮш░ГцЦ╣ц│Х цЙзшбМц│ихЖМ OP_ACCEPT ф║Лф╗╢</span>
                    pipeline<span class="token punctuation">.</span><span class="token function">fireChannelActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
	
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>х╜У netty цЬНхКбчлп NioServerSocketChannel ч╗СхоЪчлпхПгцИРхКЯф╣ЛхРОя╝МцЙНчоЧцШпчЬЯцнгчЪД Active я╝МщЪПхРОшзжхПС ChannelActive ф║Лф╗╢хЬи pipeline ф╕нчЪДф╝ацТнуАВ</p> <p>ф╣ЛхЙНцИСф╗мф╣ЯцПРхИ░ш┐ЗхИдцЦн NioServerSocketChannel цШпхРж Active чЪДцаЗхЗЖх░▒цШп : <strong>х║Хх▒В JDK Nio ServerSocketChannel цШпхРж open х╣╢ф╕Ф ServerSocket цШпхРжх╖▓ч╗ПхоМцИРч╗СхоЪуАВ</strong></p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>шАМховцИ╖члп NioSocketChannel ф╕ншзжхПС ChannelActive ф║Лф╗╢х░▒ф╝ЪцпФш╛ГчоАхНХя╝Мх╜У NioSocketChannel хЖНхРС sub reactor ц│ихЖМцИРхКЯх╣╢шзжхПС ChannelRegistered ф╣ЛхРОя╝Мч┤зцОечЭАх░▒ф╝ЪшзжхПС ChannelActive ф║Лф╗╢хЬи pipeline ф╕нф╝ацТнуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192224528.webp" alt="хЫ╛чЙЗ"></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">register0</span><span class="token punctuation">(</span><span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//цЙзшбМчЬЯцнгчЪДц│ихЖМцУНф╜Ь</span>
        <span class="token function">doRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment">//шзжхПСchannelRegisterф║Лф╗╢</span>
        pipeline<span class="token punctuation">.</span><span class="token function">fireChannelRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>firstRegistration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//шзжхПСchannelActiveф║Лф╗╢</span>
                pipeline<span class="token punctuation">.</span><span class="token function">fireChannelActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAutoRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">beginRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>шАМховцИ╖члп NioSocketChannel цШпхРж Active чЪДцаЗшпЖцШпя╝Ъх║Хх▒В JDK NIO SocketChannel цШпхРж open х╣╢ф╕Фх║Хх▒В socket цШпхРжш┐ЮцОеуАВцплцЧачЦСщЧоя╝Мш┐ЩщЗМчЪД socket ф╕АхоЪцШп connected уАВцЙАф╗ечЫ┤цОешзжхПС ChannelActive ф║Лф╗╢уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SocketChannel</span> ch <span class="token operator">=</span> <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ch<span class="token punctuation">.</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> ch<span class="token punctuation">.</span><span class="token function">isConnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>ц│ицДПя╝ЪцндцЧ╢ channel цЙНф╝ЪхИ░чЫ╕х║ФчЪД reactor ф╕нхО╗ц│ихЖМцДЯхЕ┤ш╢гчЪД IO ф║Лф╗╢уАВх╜УчФицИ╖шЗкхоЪф╣ЙчЪД ChannelHandler цОецФ╢хИ░ ChannelActive ф║Лф╗╢цЧ╢я╝МшбицШО IO ф║Лф╗╢х╖▓ч╗Пц│ихЖМхИ░ reactor ф╕нф║ЖуАВ</p></blockquote> <h4 id="_3-1-4-channelread-хТМ-channelreadcomplete-ф║Лф╗╢"><a href="#_3-1-4-channelread-хТМ-channelreadcomplete-ф║Лф╗╢" class="header-anchor">#</a> 3.1.4 ChannelRead хТМ ChannelReadComplete ф║Лф╗╢</h4> <p>![хЫ╛чЙЗ](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)<img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192224958.webp" alt="хЫ╛чЙЗ"></p> <p>х╜УховцИ╖члпцЬЙцЦ░ш┐ЮцОешп╖ц▒ВчЪДцЧ╢хАЩя╝МцЬНхКбчлпчЪД NioServerSocketChannel ф╕КчЪД OP_ACCEPT ф║Лф╗╢ф╝Ъц┤╗ш╖Гя╝МщЪПхРО main reactor ф╝ЪхЬиф╕Аф╕к read loop ф╕нф╕НцЦнчЪДш░ГчФи serverSocketChannel.accept() цОецФ╢цЦ░чЪДш┐ЮцОечЫ┤хИ░хЕищГицОецФ╢хоМцпХцИЦшАЕш╛╛хИ░ read loop цЬАхдзцмбцХ░ 16 цмбуАВ</p> <p>хЬи NioServerSocketChannel ф╕ня╝МцпП accept ф╕Аф╕кцЦ░чЪДш┐ЮцОея╝Мх░▒ф╝ЪхЬи pipeline ф╕ншзжхПС ChannelRead ф║Лф╗╢уАВф╕Аф╕кхоМцХ┤чЪД read loop ч╗УцЭЯф╣ЛхРОя╝Мф╝ЪшзжхПС ChannelReadComplete ф║Лф╗╢уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">NioMessageUnsafe</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractNioUnsafe</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>


            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">do</span> <span class="token punctuation">{</span>
                    <span class="token comment">//х║Хх▒Вш░ГчФиNioServerSocketChannel-&gt;doReadMessages хИЫх╗║ховцИ╖члпSocketChannel</span>
                    <span class="token keyword">int</span> localRead <span class="token operator">=</span> <span class="token function">doReadMessages</span><span class="token punctuation">(</span>readBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>allocHandle<span class="token punctuation">.</span><span class="token function">continueReading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                exception <span class="token operator">=</span> t<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">int</span> size <span class="token operator">=</span> readBuf<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pipeline<span class="token punctuation">.</span><span class="token function">fireChannelRead</span><span class="token punctuation">(</span>readBuf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        pipeline<span class="token punctuation">.</span><span class="token function">fireChannelReadComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>х╜УховцИ╖члп NioSocketChannel ф╕КцЬЙшп╖ц▒ВцХ░цНохИ░цЭецЧ╢я╝МNioSocketChannel ф╕КчЪД OP_READ ф║Лф╗╢ц┤╗ш╖Гя╝МщЪПхРО sub reactor ф╣Яф╝ЪхЬиф╕Аф╕к read loop ф╕нхп╣ NioSocketChannel ф╕нчЪДшп╖ц▒ВцХ░цНош┐ЫшбМшп╗хПЦчЫ┤хИ░шп╗хПЦхоМцпХцИЦшАЕш╛╛хИ░ read loop чЪДцЬАхдзцмбцХ░ 16 цмбуАВ</p> <p>хЬи read loop чЪДшп╗хПЦш┐ЗчиЛф╕ня╝МцпПшп╗хПЦф╕Ацмбх░▒ф╝ЪхЬи pipeline ф╕ншзжхПС ChannelRead ф║Лф╗╢уАВх╜Уф╕Аф╕кхоМцХ┤чЪД read loop ч╗УцЭЯф╣ЛхРОя╝Мф╝ЪхЬи pipeline ф╕ншзжхПС ChannelReadComplete ф║Лф╗╢уАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191115068.webp" alt="хЫ╛чЙЗ"></p> <p><strong>ш┐ЩщЗМщЬАшжБц│ицДПчЪДцШпх╜У ChannelReadComplete ф║Лф╗╢шзжхПСцЧ╢я╝МцндцЧ╢х╣╢ф╕Нф╗гшби NioSocketChannel ф╕нчЪДшп╖ц▒ВцХ░цНох╖▓ч╗Пшп╗хПЦхоМцпХ</strong>я╝МхПпшГ╜чЪДцГЕхЖ╡цШпхПСщАБчЪДшп╖ц▒ВцХ░цНохдкхдЪя╝МхЬиф╕Аф╕к read loop ф╕ншп╗хПЦф╕НхоМш╛╛хИ░ф║ЖцЬАхдзщЩРхИ╢цмбцХ░ 16 цмбя╝Мш┐Шц▓бхЕищГишп╗хПЦхоМцпХх░▒щААхЗ║ф║Ж read loop уАВф╕АцЧжщААхЗ║ read loop х░▒ф╝ЪшзжхПС ChannelReadComplete ф║Лф╗╢уАВшпжч╗ЖхЖЕхо╣хПпф╗ецЯечЬЛчмФшАЕчЪДш┐ЩчпЗцЦЗчла<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484244&amp;idx=1&amp;sn=831060fc38caa201d69f87305de7f86a&amp;chksm=ce77c513f9004c05b48f849ff99997d6d7252453135ae856a029137b88aa70b8e046013d596e&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">уАКNetty хжВф╜ХщлШцХИцОецФ╢ч╜Сч╗ЬцХ░цНоуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>уАВ</p> <h4 id="_3-1-5-channelwritabilitychanged-ф║Лф╗╢"><a href="#_3-1-5-channelwritabilitychanged-ф║Лф╗╢" class="header-anchor">#</a> 3.1.5 ChannelWritabilityChanged ф║Лф╗╢</h4> <p>х╜УцИСф╗мхдДчРЖхоМф╕ЪхКбщА╗ш╛Сх╛ЧхИ░ф╕ЪхКбхдДчРЖч╗УцЮЬхРОя╝Мф╝Ъш░ГчФи ctx.write(msg) шзжхПС write ф║Лф╗╢хЬи pipeline ф╕нчЪДф╝ацТнуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цЬАч╗И netty ф╝Ъх░ЖхПСщАБцХ░цНо msg хЖЩхЕе NioSocketChannel ф╕нчЪДх╛ЕхПСщАБч╝УхЖ▓щШЯхИЧ ChannelOutboundBuffer ф╕нуАВх╣╢чнЙх╛ЕчФицИ╖ш░ГчФи flush цУНф╜Ьф╗О ChannelOutboundBuffer ф╕нх░Жх╛ЕхПСщАБцХ░цНо msg я╝МхЖЩхЕехИ░х║Хх▒В Socket чЪДхПСщАБч╝УхЖ▓хМ║ф╕нуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192227366.webp" alt="хЫ╛чЙЗ"></p> <p>х╜Ухп╣члпчЪДцОецФ╢хдДчРЖщАЯх║жщЭЮх╕╕цЕвцИЦшАЕч╜Сч╗ЬчК╢хЖ╡цЮБх║жцЛехбЮцЧ╢я╝Мф╜┐х╛Ч TCP ц╗СхКичкЧхПгф╕НцЦнчЪДч╝йх░Пя╝Мш┐Щх░▒хп╝шЗ┤хПСщАБчлпчЪДхПСщАБщАЯх║жф╣ЯхПШх╛Чш╢КцЭеш╢Кх░Пя╝МшАМцндцЧ╢чФицИ╖ш┐ШхЬиф╕НцЦнчЪДш░ГчФи ctx.write(msg) я╝Мш┐Щх░▒ф╝Ъхп╝шЗ┤ ChannelOutboundBuffer ф╝ЪцАехЙзхвЮхдзя╝Мф╗ОшАМхПпшГ╜хп╝шЗ┤ OOM уАВnetty х╝ХхЕеф║ЖщлШф╜Оц░┤ф╜Нч║┐цЭецОзхИ╢ ChannelOutboundBuffer чЪДхЖЕхнШхНачФиуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">WriteBufferWaterMark</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_LOW_WATER_MARK</span> <span class="token operator">=</span> <span class="token number">32</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_HIGH_WATER_MARK</span> <span class="token operator">=</span> <span class="token number">64</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>х╜У ChanneOutboundBuffer ф╕нчЪДхЖЕхнШхНачФищЗПш╢Еш┐ЗщлШц░┤ф╜Нч║┐цЧ╢я╝Мnetty х░▒ф╝Ъх░Жхп╣х║ФчЪД channel ч╜оф╕║ф╕НхПпхЖЩчК╢цАБя╝Мх╣╢хЬи pipeline ф╕ншзжхПС ChannelWritabilityChanged ф║Лф╗╢уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setUnwritable</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> invokeLater<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> oldValue <span class="token operator">=</span> unwritable<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> newValue <span class="token operator">=</span> oldValue <span class="token operator">|</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">UNWRITABLE_UPDATER</span><span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldValue <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//шзжхПСfireChannelWritabilityChangedф║Лф╗╢ шбичд║х╜УхЙНchannelхПШф╕║ф╕НхПпхЖЩ</span>
                <span class="token function">fireChannelWritabilityChanged</span><span class="token punctuation">(</span>invokeLater<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>х╜У ChannelOutboundBuffer ф╕нчЪДхЖЕхнШхНачФищЗПф╜Оф║Оф╜Оц░┤ф╜Нч║┐цЧ╢я╝Мnetty хПИф╝Ъх░Жхп╣х║ФчЪД NioSocketChannel шо╛ч╜оф╕║хПпхЖЩчК╢цАБя╝Мх╣╢хЖНцмбшзжхПС ChannelWritabilityChanged ф║Лф╗╢уАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192226787.webp" alt="хЫ╛чЙЗ"></p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setWritable</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> invokeLater<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> oldValue <span class="token operator">=</span> unwritable<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> newValue <span class="token operator">=</span> oldValue <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">UNWRITABLE_UPDATER</span><span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldValue <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> newValue <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">fireChannelWritabilityChanged</span><span class="token punctuation">(</span>invokeLater<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>чФицИ╖хПпхЬишЗкхоЪф╣Й ChannelHandler ф╕нщАЪш┐З ctx.channel().isWritable() хИдцЦнх╜УхЙН channel цШпхРжхПпхЖЩуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelWritabilityChanged</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isWritable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>х╜УхЙНchannelхПпхЖЩ<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>х╜УхЙНchannelф╕НхПпхЖЩ<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_3-1-6-usereventtriggered-ф║Лф╗╢"><a href="#_3-1-6-usereventtriggered-ф║Лф╗╢" class="header-anchor">#</a> 3.1.6 UserEventTriggered ф║Лф╗╢</h4> <p>netty цПРф╛Ыф║Жф╕АчзНф║Лф╗╢цЙйх▒ХцЬ║хИ╢хПпф╗ехЕБшо╕чФицИ╖шЗкхоЪф╣Йх╝Вцнеф║Лф╗╢я╝Мш┐Щца╖хПпф╗еф╜┐х╛ЧчФицИ╖шГ╜хдЯчБ╡ц┤╗чЪДхоЪф╣ЙхРДчзНхдНцЭВхЬ║цЩпчЪДхдДчРЖцЬ║хИ╢уАВ</p> <p>ф╕ЛщЭвцИСф╗мцЭечЬЛф╕ЛхжВф╜ХхЬи Netty ф╕ншЗкхоЪф╣Йх╝Вцнеф║Лф╗╢уАВ</p> <ol><li>хоЪф╣Йх╝Вцнеф║Лф╗╢уАВ</li></ol> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">OurOwnDefinedEvent</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">OurOwnDefinedEvent</span> <span class="token constant">INSTANCE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OurOwnDefinedEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">OurOwnDefinedEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>шзжхПСшЗкхоЪф╣Йф║Лф╗╢чЪДф╝ацТн</li></ol> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment">//ф║Лф╗╢хЬиpipelineф╕нф╗Ох╜УхЙНChannelHandlerContextх╝АхзЛхРСхРОф╝ацТн</span>
            ctx<span class="token punctuation">.</span><span class="token function">fireUserEventTriggered</span><span class="token punctuation">(</span><span class="token class-name">OurOwnDefinedEvent</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//ф║Лф╗╢ф╗ОpipelineчЪДхд┤ч╗УчВ╣headContextх╝АхзЛхРСхРОф╝ацТн</span>
            ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fireUserEventTriggered</span><span class="token punctuation">(</span><span class="token class-name">OurOwnDefinedEvent</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><ol start="3"><li>шЗкхоЪф╣Йф║Лф╗╢чЪДхУНх║ФхТМхдДчРЖуАВ</li></ol> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">userEventTriggered</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> evt<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">OurOwnDefinedEvent</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span> <span class="token operator">==</span> evt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>шЗкхоЪф╣Йф║Лф╗╢хдДчРЖ<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>хРОч╗нщЪПчЭАцИСф╗мц║РчаБшзгшп╗чЪДц╖▒хЕея╝МцИСф╗мш┐Шф╝ЪчЬЛхИ░ Netty шЗкх╖▒цЬмш║лф╣ЯхоЪф╣Йф║Жшо╕хдЪ UserEvent ф║Лф╗╢я╝МцИСф╗мхРОщЭвш┐Шф╝ЪхЬиф╗Лч╗Ня╝Мхдзхо╢ш┐ЩщЗМхПкцШпчиНх╛оф║Жшзгф╕Аф╕ЛчЫ╕хЕ│чЪДчФиц│ХхН│хПпуАВ</p> <h4 id="_3-1-7-channelinactive-хТМ-channelunregistered-ф║Лф╗╢"><a href="#_3-1-7-channelinactive-хТМ-channelunregistered-ф║Лф╗╢" class="header-anchor">#</a> 3.1.7 ChannelInactive хТМ ChannelUnregistered ф║Лф╗╢</h4> <p>х╜У Channel швлхЕ│щЧнф╣ЛхРОф╝ЪхЬи pipeline ф╕нхЕИшзжхПС ChannelInactive ф║Лф╗╢чЪДф╝ацТнчД╢хРОхЬишзжхПС ChannelUnregistered ф║Лф╗╢чЪДф╝ацТнуАВ</p> <p>цИСф╗мхПпф╗ехЬи Inbound ч▒╗хЮЛчЪД ChannelHandler ф╕нхУНх║Ф ChannelInactive хТМ ChannelUnregistered ф║Лф╗╢уАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelInactive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>хУНх║ФinActiveф║Лф╗╢<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment">//ч╗зч╗нхРСхРОф╝ацТнinActiveф║Лф╗╢</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">channelInactive</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelUnregistered</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>хУНх║Ф<span class="token class-name">Unregistered</span>ф║Лф╗╢<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment">//ч╗зч╗нхРСхРОф╝ацТнUnregisteredф║Лф╗╢</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">channelUnregistered</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>ш┐ЩщЗМхТМш┐ЮцОех╗║члЛф╣ЛхРОчЪДф║Лф╗╢шзжхПСщб║х║Пцнгхе╜чЫ╕хПНя╝Мш┐ЮцОех╗║члЛф╣ЛхРОцШпхЕИшзжхПС ChannelRegistered ф║Лф╗╢чД╢хРОхЬишзжхПС ChannelActive ф║Лф╗╢уАВ</p></blockquote> <h3 id="_3-2-outbound-ч▒╗ф║Лф╗╢"><a href="#_3-2-outbound-ч▒╗ф║Лф╗╢" class="header-anchor">#</a> 3.2 Outbound ч▒╗ф║Лф╗╢</h3> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ChannelHandlerMask</span> <span class="token punctuation">{</span>

    <span class="token comment">// outbound ф║Лф╗╢чЪДщЫЖхРИ</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_ONLY_OUTBOUND</span> <span class="token operator">=</span>  <span class="token constant">MASK_BIND</span> <span class="token operator">|</span> <span class="token constant">MASK_CONNECT</span> <span class="token operator">|</span> <span class="token constant">MASK_DISCONNECT</span> <span class="token operator">|</span>
            <span class="token constant">MASK_CLOSE</span> <span class="token operator">|</span> <span class="token constant">MASK_DEREGISTER</span> <span class="token operator">|</span> <span class="token constant">MASK_READ</span> <span class="token operator">|</span> <span class="token constant">MASK_WRITE</span> <span class="token operator">|</span> <span class="token constant">MASK_FLUSH</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_ALL_OUTBOUND</span> <span class="token operator">=</span> <span class="token constant">MASK_EXCEPTION_CAUGHT</span> <span class="token operator">|</span> <span class="token constant">MASK_ONLY_OUTBOUND</span><span class="token punctuation">;</span>

    <span class="token comment">// outbound ф║Лф╗╢цОйчаБ</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_BIND</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_CONNECT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_DISCONNECT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_CLOSE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">12</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_DEREGISTER</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">13</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_READ</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">14</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_WRITE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">15</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_FLUSH</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хТМ Inbound ч▒╗ф║Лф╗╢ф╕Аца╖я╝МOutbound ч▒╗ф║Лф╗╢ф╣ЯцЬЙхп╣х║ФчЪДцОйчаБшбичд║уАВф╕ЛщЭвцИСф╗мцЭечЬЛф╕Л Outbound ч▒╗ф║Лф╗╢чЪДшзжхПСцЧ╢цЬ║я╝Ъ</p> <h4 id="_3-2-1-read-ф║Лф╗╢"><a href="#_3-2-1-read-ф║Лф╗╢" class="header-anchor">#</a> 3.2.1 read ф║Лф╗╢</h4> <p><strong>хдзхо╢ш┐ЩщЗМщЬАшжБц│ицДПхМ║хИЖ read ф║Лф╗╢хТМ ChannelRead ф║Лф╗╢чЪДф╕НхРМ</strong>уАВ</p> <p>ChannelRead ф║Лф╗╢хЙНш╛╣цИСф╗мх╖▓ч╗Пф╗Лч╗Нф║Жя╝Мх╜У NioServerSocketChannel цОецФ╢хИ░цЦ░ш┐ЮцОецЧ╢я╝Мф╝ЪшзжхПС ChannelRead ф║Лф╗╢хЬихЕ╢ pipeline ф╕Кф╝ацТнуАВ</p> <p>х╜У NioSocketChannel ф╕КцЬЙшп╖ц▒ВцХ░цНоцЧ╢я╝МхЬи read loop ф╕ншп╗хПЦшп╖ц▒ВцХ░цНоцЧ╢ф╝ЪшзжхПС ChannelRead ф║Лф╗╢хЬихЕ╢ pipeline ф╕Кф╝ацТнуАВ</p> <p>шАМ read ф║Лф╗╢хИЩхТМ ChannelRead ф║Лф╗╢хоМхЕиф╕НхРМя╝Мread ф║Лф╗╢чЙ╣цМЗф╜┐ Channel хЕ╖хдЗцДЯчЯе IO ф║Лф╗╢чЪДшГ╜хКЫуАВNioServerSocketChannel хп╣х║ФчЪД OP_ACCEPT ф║Лф╗╢чЪДцДЯчЯешГ╜хКЫя╝МNioSocketChannel хп╣х║ФчЪДцШп OP_READ ф║Лф╗╢чЪДцДЯчЯешГ╜хКЫуАВ</p> <p>read ф║Лф╗╢чЪДшзжхПСцШпхЬих╜У channel щЬАшжБхРСхЕ╢хп╣х║ФчЪД reactor ц│ихЖМшп╗ч▒╗хЮЛф║Лф╗╢цЧ╢я╝ИцпФхжВ OP_ACCEPT ф║Лф╗╢ хТМ OP_READ ф║Лф╗╢я╝ЙцЙНф╝ЪшзжхПСуАВread ф║Лф╗╢чЪДхУНх║Фх░▒цШпх░Ж channel цДЯхЕ┤ш╢гчЪД IO ф║Лф╗╢ц│ихЖМхИ░хп╣х║ФчЪД reactor ф╕КуАВ</p> <p>цпФхжВ NioServerSocketChannel цДЯхЕ┤ш╢гчЪДцШп OP_ACCEPT ф║Лф╗╢я╝М NioSocketChannel цДЯхЕ┤ш╢гчЪДцШп OP_READ ф║Лф╗╢уАВ</p> <p>хЬихЙНш╛╣ф╗Лч╗Н ChannelActive ф║Лф╗╢цЧ╢цИСф╗мцПРхИ░я╝Мх╜У channel хдДф║О active чК╢цАБхРОф╝ЪхЬи pipeline ф╕нф╝ацТн ChannelActive ф║Лф╗╢уАВшАМхЬи HeadContext ф╕нчЪД ChannelActive ф║Лф╗╢хЫЮш░Гф╕нф╝ЪшзжхПС Read ф║Лф╗╢чЪДф╝ацТнуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HeadContext</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractChannelHandlerContext</span>
    <span class="token keyword">implements</span> <span class="token class-name">ChannelOutboundHandler</span><span class="token punctuation">,</span> <span class="token class-name">ChannelInboundHandler</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelActive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">fireChannelActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">readIfIsAutoRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readIfIsAutoRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAutoRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//хжВцЮЬцШпautoRead хИЩшзжхПСreadф║Лф╗╢ф╝ацТн</span>
            channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//шзжхПСц│ихЖМOP_ACCEPTцИЦшАЕOP_READф║Лф╗╢</span>
        unsafe<span class="token punctuation">.</span><span class="token function">beginRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>шАМхЬи HeadContext ф╕нчЪД read ф║Лф╗╢хЫЮш░Гф╕нф╝Ъш░ГчФи Channel чЪДх║Хх▒ВцУНф╜Ьч▒╗ unsafe чЪД beginRead цЦ╣ц│Хя╝МхЬишпецЦ╣ц│Хф╕нф╝ЪхРС reactor ц│ихЖМ channel цДЯхЕ┤ш╢гчЪД IO ф║Лф╗╢уАВхп╣ф║О NioServerSocketChannel цЭешп┤ш┐ЩщЗМц│ихЖМчЪДх░▒цШп OP_ACCEPT ф║Лф╗╢я╝Мхп╣ф║О NioSocketChannel цЭешп┤ш┐ЩщЗМц│ихЖМчЪДхИЩцШп OP_READ ф║Лф╗╢уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doBeginRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// Channel.read() or ChannelHandlerContext.read() was called</span>
    <span class="token keyword">final</span> <span class="token class-name">SelectionKey</span> selectionKey <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>selectionKey<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>selectionKey<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    readPending <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token keyword">int</span> interestOps <span class="token operator">=</span> selectionKey<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>interestOps <span class="token operator">&amp;</span> readInterestOp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//ц│ихЖМчЫСхРмOP_ACCEPTцИЦшАЕOP_READф║Лф╗╢</span>
        selectionKey<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span>interestOps <span class="token operator">|</span> readInterestOp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>ч╗Жх┐ГчЪДхРМхнжхПпшГ╜ц│ицДПхИ░ф║Ж channel хп╣х║ФчЪДщЕНч╜оч▒╗ф╕нхМЕхРлф║Жф╕Аф╕к autoRead х▒ЮцАзя╝МщВгф╣Иш┐Щф╕к autoRead хИ░х║ХцШпх╣▓ф╗Аф╣ИчЪДхСвя╝Я</strong></p> <p>хЕ╢хоЮш┐ЩцШп netty ф╕║хдзхо╢цПРф╛ЫчЪДф╕АчзНшГМхОЛцЬ║хИ╢я╝МчФицЭещШ▓цнв OOM я╝МцГ│ш▒бф╕Аф╕Лх╜Ухп╣члпхПСщАБцХ░цНощЭЮх╕╕хдЪх╣╢ф╕ФхПСщАБщАЯх║жщЭЮх╕╕х┐ля╝МшАМцЬНхКбчлпхдДчРЖщАЯх║жщЭЮх╕╕цЕвя╝Мф╕АцЧ╢щЧ┤ц╢Иш┤╣ф╕Нш┐ЗцЭеуАВшАМхп╣члпхПИхЬиф╕НхБЬчЪДхдзщЗПхПСщАБцХ░цНоя╝МцЬНхКбчлпчЪД reactor ч║┐чиЛф╕Нх╛Чф╕НхЬи read loop ф╕нф╕НхБЬчЪДшп╗хПЦя╝Мх╣╢ф╕Фф╕║шп╗хПЦхИ░чЪДцХ░цНохИЖщЕН ByteBuffer уАВшАМцЬНхКбчлпф╕ЪхКбч║┐чиЛхПИхдДчРЖф╕Нш┐ЗцЭея╝Мш┐Щх░▒хп╝шЗ┤ф║ЖхдзщЗПцЭеф╕НхПКхдДчРЖчЪДцХ░цНохНачФиф║ЖхдзщЗПчЪДхЖЕхнШчй║щЧ┤я╝Мф╗ОшАМхп╝шЗ┤ OOM уАВ</p> <p>щЭвхп╣ш┐ЩчзНцГЕхЖ╡я╝МцИСф╗мхПпф╗ещАЪш┐З <code>channelHandlerContext.channel().config().setAutoRead(false)</code> х░Ж autoRead х▒ЮцАзшо╛ч╜оф╕║ false уАВщЪПхРО netty х░▒ф╝Ъх░Ж channel ф╕нцДЯхЕ┤ш╢гчЪДшп╗ч▒╗хЮЛф║Лф╗╢ф╗О reactor ф╕нц│ищФАя╝Мф╗Оцнд reactor ф╕Нф╝ЪхЖНхп╣чЫ╕х║Фф║Лф╗╢ш┐ЫшбМчЫСхРмуАВш┐Щца╖ channel х░▒ф╕Нф╝ЪхЬишп╗хПЦцХ░цНоф║ЖуАВ</p> <blockquote><p>ш┐ЩщЗМ NioServerSocketChannel хп╣х║ФчЪДцШп OP_ACCEPT ф║Лф╗╢я╝М NioSocketChannel хп╣х║ФчЪДцШп OP_READ ф║Лф╗╢уАВ</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">removeReadOp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SelectionKey</span> key <span class="token operator">=</span> <span class="token function">selectionKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>key<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> interestOps <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>interestOps <span class="token operator">&amp;</span> readInterestOp<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        key<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span>interestOps <span class="token operator">&amp;</span> <span class="token operator">~</span>readInterestOp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>шАМх╜УцЬНхКбчлпчЪДхдДчРЖщАЯх║жцБвхдНцнгх╕╕я╝МцИСф╗мхПИхПпф╗ещАЪш┐З <code>channelHandlerContext.channel().config().setAutoRead(true)</code> х░Ж autoRead х▒ЮцАзшо╛ч╜оф╕║ true уАВш┐Щца╖ netty ф╝ЪхЬи pipeline ф╕ншзжхПС read ф║Лф╗╢я╝МцЬАч╗ИхЬи HeadContext ф╕нчЪД read ф║Лф╗╢хЫЮш░ГцЦ╣ц│Хф╕нщАЪш┐Зш░ГчФи unsafe#beginRead цЦ╣ц│Хх░Ж channel цДЯхЕ┤ш╢гчЪДшп╗ч▒╗хЮЛф║Лф╗╢щЗНцЦ░ц│ихЖМхИ░хп╣х║ФчЪД reactor ф╕нуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ChannelConfig</span> <span class="token function">setAutoRead</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> autoRead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> oldAutoRead <span class="token operator">=</span> <span class="token constant">AUTOREAD_UPDATER</span><span class="token punctuation">.</span><span class="token function">getAndSet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> autoRead <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>autoRead <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>oldAutoRead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//autoReadф╗ОfalseхПШф╕║true</span>
        channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>autoRead <span class="token operator">&amp;&amp;</span> oldAutoRead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//autoReadф╗ОtrueхПШф╕║false</span>
        <span class="token function">autoReadCleared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>read ф║Лф╗╢хПпф╗ечРЖшзгф╕║ф╜┐ channel цЛецЬЙшп╗чЪДшГ╜хКЫя╝Мх╜УцЬЙф║Жшп╗чЪДшГ╜хКЫхРОя╝М channelRead х░▒хПпф╗ешп╗хПЦхЕ╖ф╜УчЪДцХ░цНоф║ЖуАВ</p></blockquote> <h4 id="_3-2-2-write-хТМ-flush-ф║Лф╗╢"><a href="#_3-2-2-write-хТМ-flush-ф║Лф╗╢" class="header-anchor">#</a> 3.2.2 write хТМ flush ф║Лф╗╢</h4> <p>write ф║Лф╗╢хТМ flush ф║Лф╗╢цИСф╗мхЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484532&amp;idx=1&amp;sn=c3a8b37a2eb09509d9914494ef108c68&amp;chksm=ce77c233f9004b25a29f9fdfb179e41646092d09bc89df2147a9fab66df13231e46dd6a5c26d&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">уАКф╕АцЦЗцРЮцЗВ Netty хПСщАБцХ░цНохЕиц╡БчиЛуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕АцЦЗф╕нх╖▓ч╗ПщЭЮх╕╕шпжх░╜чЪДф╗Лч╗Нш┐Зф║Жя╝Мш┐ЩщЗМчмФшАЕхЬих╕жхдзхо╢чоАхНХхЫЮщб╛ф╕Аф╕ЛуАВ</p> <p>write ф║Лф╗╢хТМ flush ф║Лф╗╢хЭЗчФ▒чФицИ╖хЬихдДчРЖхоМф╕ЪхКбшп╖ц▒Вх╛ЧхИ░ф╕ЪхКбч╗УцЮЬхРОхЬиф╕ЪхКбч║┐чиЛф╕нф╕╗хКишзжхПСуАВ</p> <p>чФицИ╖цЧвхПпф╗ещАЪш┐З ChannelHandlerContext шзжхПСф╣ЯхПпф╗ещАЪш┐З Channel цЭешзжхПСуАВ</p> <p>ф╕НхРМф╣ЛхдДхЬиф║ОхжВцЮЬщАЪш┐З ChannelHandlerContext шзжхПСя╝МщВгф╣И write ф║Лф╗╢цИЦшАЕ flush ф║Лф╗╢х░▒ф╝ЪхЬи pipeline ф╕нф╗Ох╜УхЙН ChannelHandler х╝АхзЛф╕АчЫ┤хРСхЙНф╝ацТнчЫ┤хИ░ HeadContext уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelReadComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хжВцЮЬщАЪш┐З Channel шзжхПСя╝МщВгф╣И write ф║Лф╗╢хТМ flush ф║Лф╗╢х░▒ф╝Ъф╗О pipeline чЪДх░╛щГишКВчВ╣ TailContext х╝АхзЛф╕АчЫ┤хРСхЙНф╝ацТнчЫ┤хИ░ HeadContext уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelReadComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>х╜УчД╢ш┐ШцЬЙф╕Аф╕к writeAndFlush цЦ╣ц│Хя╝Мф╣Яф╝ЪхИЖф╕║ ChannelHandlerContext шзжхПСхТМ Channel чЪДшзжхПСуАВшзжхПС writeAndFlush хРОя╝Мwrite ф║Лф╗╢щжЦхЕИф╝ЪхЬи pipeline ф╕нф╝ацТня╝МцЬАхРО flush ф║Лф╗╢хЬи pipeline ф╕нф╝ацТнуАВ</p> <p>netty хп╣ write ф║Лф╗╢чЪДхдДчРЖцЬАч╗Иф╝Ъх░ЖхПСщАБцХ░цНохЖЩхЕе Channel хп╣х║ФчЪДхЖЩч╝УхЖ▓щШЯхИЧ ChannelOutboundBuffer ф╕нуАВцндцЧ╢цХ░цНох╣╢ц▓бцЬЙхПСщАБхЗ║хО╗шАМцШпхЬихЖЩч╝УхЖ▓щШЯхИЧф╕нч╝УхнШя╝Мш┐Щф╣ЯцШп netty хоЮчО░х╝ВцнехЖЩчЪДца╕х┐Гшо╛шобуАВ</p> <p>цЬАч╗ИщАЪш┐З flush цУНф╜Ьф╗О Channel ф╕нчЪДхЖЩч╝УхЖ▓щШЯхИЧ ChannelOutboundBuffer ф╕ншО╖хПЦхИ░х╛ЕхПСщАБцХ░цНоя╝Мх╣╢хЖЩхЕехИ░ Socket чЪДхПСщАБч╝УхЖ▓хМ║ф╕нуАВ</p> <h4 id="_3-2-3-close-ф║Лф╗╢"><a href="#_3-2-3-close-ф║Лф╗╢" class="header-anchor">#</a> 3.2.3 close ф║Лф╗╢</h4> <p>х╜УчФицИ╖хЬи ChannelHandler ф╕нш░ГчФихжВф╕ЛцЦ╣ц│Ххп╣ Channel ш┐ЫшбМхЕ│щЧнцЧ╢я╝Мф╝ЪшзжхПС Close ф║Лф╗╢хЬи pipeline ф╕нф╗ОхРОхРСхЙНф╝ацТнуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//closeф║Лф╗╢ф╗Ох╜УхЙНChannelHandlerContextх╝АхзЛхЬиpipelineф╕нхРСхЙНф╝ацТн</span>
ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//closeф║Лф╗╢ф╗ОpipelineчЪДх░╛ч╗УчВ╣tailContextх╝АхзЛхРСхЙНф╝ацТн</span>
ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>цИСф╗мхПпф╗ехЬи Outbound ч▒╗хЮЛчЪД ChannelHandler ф╕нхУНх║Ф close ф║Лф╗╢уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExampleChannelHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelOutboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>ховцИ╖члпchannelхЕ│щЧнф╣ЛхЙНчЪДхдДчРЖхЫЮш░Г<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment">//ч╗зч╗нхРСхЙНф╝ацТнcloseф║Лф╗╢</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цЬАч╗И close ф║Лф╗╢ф╝ЪхЬи pipeline ф╕нф╕АчЫ┤хРСхЙНф╝ацТнчЫ┤хИ░хд┤ч╗УчВ╣ HeadConnect ф╕ня╝Мх╣╢хЬи HeadContext ф╕нхоМцИРш┐ЮцОехЕ│щЧнчЪДцУНф╜Ья╝Мх╜Уш┐ЮцОехоМцИРхЕ│щЧнф╣ЛхРОя╝Мф╝ЪхЬи pipeline ф╕нхЕИхРОшзжхПС ChannelInactive ф║Лф╗╢хТМ ChannelUnregistered ф║Лф╗╢уАВ</p> <h4 id="_3-2-4-deregister-ф║Лф╗╢"><a href="#_3-2-4-deregister-ф║Лф╗╢" class="header-anchor">#</a> 3.2.4 deRegister ф║Лф╗╢</h4> <p>чФицИ╖хПпш░ГчФихжВф╕Лф╗гчаБх░Жх╜УхЙН Channel ф╗О Reactor ф╕нц│ищФАцОЙуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//deregisterф║Лф╗╢ф╗Ох╜УхЙНChannelHandlerContextх╝АхзЛхЬиpipelineф╕нхРСхЙНф╝ацТн</span>
ctx<span class="token punctuation">.</span><span class="token function">deregister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//deregisterф║Лф╗╢ф╗ОpipelineчЪДх░╛ч╗УчВ╣tailContextх╝АхзЛхРСхЙНф╝ацТн</span>
ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deregister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>цИСф╗мхПпф╗ехЬи Outbound ч▒╗хЮЛчЪД ChannelHandler ф╕нхУНх║Ф deregister ф║Лф╗╢уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExampleChannelHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelOutboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deregister</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>


        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>ховцИ╖члпchannelхПЦц╢Иц│ихЖМф╣ЛхЙНчЪДхдДчРЖхЫЮш░Г<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment">//ч╗зч╗нхРСхЙНф╝ацТнconnectф║Лф╗╢</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">deregister</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цЬАч╗И deRegister ф║Лф╗╢ф╝Ъф╝ацТншЗ│ pipeline ф╕нчЪДхд┤ч╗УчВ╣ HeadContext ф╕ня╝Мх╣╢хЬи HeadContext ф╕нхоМцИРх║Хх▒В channel хПЦц╢Иц│ихЖМчЪДцУНф╜ЬуАВх╜У Channel ф╗О Reactor ф╕Кц│ищФАф╣ЛхРОя╝Мф╗Оцнд Reactor х░Жф╕Нф╝ЪхЬичЫСхРм Channel ф╕КчЪД IO ф║Лф╗╢я╝Мх╣╢шзжхПС ChannelUnregistered ф║Лф╗╢хЬи pipeline ф╕нф╝ацТнуАВ</p> <h4 id="_3-2-5-connect-ф║Лф╗╢"><a href="#_3-2-5-connect-ф║Лф╗╢" class="header-anchor">#</a> 3.2.5 connect ф║Лф╗╢</h4> <p>хЬи Netty чЪДховцИ╖члпф╕нцИСф╗мхПпф╗ехИйчФи NioSocketChannel чЪД connect цЦ╣ц│ХшзжхПС connect ф║Лф╗╢хЬи pipeline ф╕нф╝ацТнуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//connectф║Лф╗╢ф╗Ох╜УхЙНChannelHandlerContextх╝АхзЛхЬиpipelineф╕нхРСхЙНф╝ацТн</span>
ctx<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>remoteAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//connectф║Лф╗╢ф╗ОpipelineчЪДх░╛ч╗УчВ╣tailContextх╝АхзЛхРСхЙНф╝ацТн</span>
ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>remoteAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>цИСф╗мхПпф╗ехЬи Outbound ч▒╗хЮЛчЪД ChannelHandler ф╕нхУНх║Ф connect ф║Лф╗╢уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExampleChannelHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelOutboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">SocketAddress</span> remoteAddress<span class="token punctuation">,</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">,</span>
                        <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>


        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>ховцИ╖члпchannelш┐ЮцОецИРхКЯф╣ЛхЙНчЪДхдДчРЖхЫЮш░Г<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment">//ч╗зч╗нхРСхЙНф╝ацТнconnectф║Лф╗╢</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> remoteAddress<span class="token punctuation">,</span> localAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цЬАч╗И connect ф║Лф╗╢ф╝ЪхЬи pipeline ф╕нчЪДхд┤ч╗УчВ╣ headContext ф╕ншзжхПСх║Хх▒ВчЪДш┐ЮцОех╗║члЛшп╖ц▒ВуАВх╜УховцИ╖члпцИРхКЯш┐ЮцОехИ░цЬНхКбчлпф╣ЛхРОя╝Мф╝ЪхЬиховцИ╖члп NioSocketChannel чЪД pipeline ф╕нф╝ацТн channelActive ф║Лф╗╢уАВ</p> <h4 id="_3-2-6-disconnect-ф║Лф╗╢"><a href="#_3-2-6-disconnect-ф║Лф╗╢" class="header-anchor">#</a> 3.2.6 disConnect ф║Лф╗╢</h4> <p>хЬи Netty чЪДховцИ╖члпф╕нцИСф╗мф╣ЯхПпф╗еш░ГчФи NioSocketChannel чЪД disconnect цЦ╣ц│ХхЬи pipeline ф╕ншзжхПС disconnect ф║Лф╗╢я╝Мш┐Щф╝Ъхп╝шЗ┤ NioSocketChannel чЪДхЕ│щЧнуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//disconnectф║Лф╗╢ф╗Ох╜УхЙНChannelHandlerContextх╝АхзЛхЬиpipelineф╕нхРСхЙНф╝ацТн</span>
ctx<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//disconnectф║Лф╗╢ф╗ОpipelineчЪДх░╛ч╗УчВ╣tailContextх╝АхзЛхРСхЙНф╝ацТн</span>
ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>цИСф╗мхПпф╗ехЬи Outbound ч▒╗хЮЛчЪД ChannelHandler ф╕нхУНх║Ф disconnect ф║Лф╗╢уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExampleChannelHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelOutboundHandlerAdapter</span> <span class="token punctuation">{</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>ховцИ╖члпchannelхН│х░ЖхЕ│щЧнхЙНчЪДхдДчРЖхЫЮш░Г<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment">//ч╗зч╗нхРСхЙНф╝ацТнdisconnectф║Лф╗╢</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цЬАч╗И disconnect ф║Лф╗╢ф╝Ъф╝ацТнхИ░ HeadContext ф╕ня╝Мх╣╢хЬи HeadContext ф╕нхоМцИРх║Хх▒ВчЪДцЦнх╝Аш┐ЮцОецУНф╜Ья╝Мх╜УховцИ╖члпцЦнх╝Аш┐ЮцОецИРхКЯхЕ│щЧнф╣ЛхРОя╝Мф╝ЪхЬи pipeline ф╕нхЕИхРОшзжхПС ChannelInactive ф║Лф╗╢хТМ ChannelUnregistered ф║Лф╗╢уАВ</p> <h2 id="_4-хРС-pipeline-ц╖╗хКа-channelhandler"><a href="#_4-хРС-pipeline-ц╖╗хКа-channelhandler" class="header-anchor">#</a> 4. хРС pipeline ц╖╗хКа channelHandler</h2> <p>хЬицИСф╗мшпжч╗Жф╗Лч╗Нф║ЖхЕищГичЪД inbound ч▒╗ф║Лф╗╢хТМ outbound ч▒╗ф║Лф╗╢чЪДцОйчаБшбичд║ф╗ехПКф║Лф╗╢чЪДшзжхПСхТМф╝ацТнш╖пх╛ДхРОя╝МчЫ╕ф┐бхдзхо╢чО░хЬихПпф╗ещАЪш┐З ChannelInboundHandler хТМ ChannelOutboundHandler цЭеца╣цНохЕ╖ф╜УчЪДф╕ЪхКбхЬ║цЩпщАЙцЛйхРИщАВчЪД ChannelHandler ч▒╗хЮЛф╗ехПКчЫСхРмхРИщАВчЪДф║Лф╗╢цЭехоМцИРф╕ЪхКбщЬАц▒Вф║ЖуАВ</p> <p>цЬмх░ПшКВх░▒шпеф╗Лч╗Нф╕Аф╕ЛшЗкхоЪф╣ЙчЪД ChannelHandler цШпхжВф╜Хц╖╗хКахИ░ pipeline ф╕нчЪДя╝Мnetty хЬиш┐Щф╕кш┐ЗчиЛф╕нх╕оцИСф╗мф╜Ьф║ЖхУкф║Ых╖еф╜Ь?</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">EchoServerHandler</span> serverHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EchoServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>serverHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>хПпц╖╗хКахдЪф╕кchannelHandler<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ф╗еф╕КцШпчмФшАЕчоАхМЦчЪДф╕Аф╕к netty цЬНхКбчлпщЕНч╜о ServerBootstrap хРпхКич▒╗чЪДф╕Ацо╡чд║ф╛Лф╗гчаБуАВцИСф╗мхПпф╗ечЬЛхИ░хЖНхРС channel хп╣х║ФчЪД pipeline ф╕нц╖╗хКа ChannelHandler цШпщАЪш┐З ChannelPipeline#addLast цЦ╣ц│Хх░ЖцМЗхоЪ ChannelHandler ц╖╗хКахИ░ pipeline чЪДцЬлх░╛хдДуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ChannelPipeline</span>
        <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundInvoker</span><span class="token punctuation">,</span> <span class="token class-name">ChannelOutboundInvoker</span><span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token comment">//хРСpipelineчЪДцЬлх░╛хдДцЙ╣щЗПц╖╗хКахдЪф╕кchannelHandler</span>
    <span class="token class-name">ChannelPipeline</span> <span class="token function">addLast</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> handlers<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//цМЗхоЪchannelHandlerчЪДexecutorя╝МчФ▒цМЗхоЪчЪДexecutorцЙзшбМchannelHandlerф╕нчЪДхЫЮш░ГцЦ╣ц│Х</span>
    <span class="token class-name">ChannelPipeline</span> <span class="token function">addLast</span><span class="token punctuation">(</span><span class="token class-name">EventExecutorGroup</span> group<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> handlers<span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token comment">//ф╕║channelHandlerцМЗхоЪхРНчз░</span>
    <span class="token class-name">ChannelPipeline</span> <span class="token function">addLast</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//ф╕║channelHandlerцМЗхоЪexecutorхТМname</span>
    <span class="token class-name">ChannelPipeline</span> <span class="token function">addLast</span><span class="token punctuation">(</span><span class="token class-name">EventExecutorGroup</span> group<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultChannelPipeline</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelPipeline</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">addLast</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> handlers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> handlers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">addLast</span><span class="token punctuation">(</span><span class="token class-name">EventExecutorGroup</span> executor<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> handlers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>handlers<span class="token punctuation">,</span> <span class="token string">&quot;handlers&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> h<span class="token operator">:</span> handlers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">addLast</span><span class="token punctuation">(</span>executor<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">addLast</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цЬАч╗И addLast чЪДш┐Щф║ЫщЗНш╜╜цЦ╣ц│ХщГ╜ф╝Ъш░ГчФихИ░ <code>DefaultChannelPipeline#addLast(EventExecutorGroup, String, ChannelHandler)</code> ш┐Щф╕кцЦ╣ц│Хф╗ОшАМхоМцИР ChannelHandler чЪДц╖╗хКа</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">addLast</span><span class="token punctuation">(</span><span class="token class-name">EventExecutorGroup</span> group<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">AbstractChannelHandlerContext</span> newCtx<span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//цгАцЯехРМф╕Аф╕кchannelHandlerхоЮф╛ЛцШпхРжхЕБшо╕швлщЗНхдНц╖╗хКа</span>
        <span class="token function">checkMultiplicity</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//хИЫх╗║channelHandlerContextхМЕшг╣channelHandlerх╣╢х░БшгЕцЙзшбМф╝ацТнф║Лф╗╢чЫ╕хЕ│чЪДф╕Кф╕ЛцЦЗф┐бцБп</span>
        newCtx <span class="token operator">=</span> <span class="token function">newContext</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> <span class="token function">filterName</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//х░ЖchannelHandelrContextцПТхЕехИ░pipelineф╕нчЪДцЬлх░╛хдДуАВхПМхРСщУ╛шбицУНф╜Ь</span>
        <span class="token comment">//цндцЧ╢channelHandlerчЪДчК╢цАБш┐ШцШпADD_PENDINGя╝МхПкцЬЙх╜УchannelHandlerчЪДhandlerAddedцЦ╣ц│ХшвлхЫЮш░ГхРОя╝МчК╢цАБцЙНф╝Ъф╕║ADD_COMPLETE</span>
        <span class="token function">addLast0</span><span class="token punctuation">(</span>newCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//хжВцЮЬх╜УхЙНchannelш┐Шц▓бцЬЙхРСreactorц│ихЖМя╝МхИЩх░ЖhandlerAddedцЦ╣ц│ХчЪДхЫЮш░Гц╖╗хКаш┐ЫpipelineчЪДф╗╗хКбщШЯхИЧф╕н</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>registered<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//ш┐ЩщЗМф╕╗шжБцШпчФицЭехдДчРЖChannelInitializerчЪДцГЕхЖ╡</span>
            <span class="token comment">//шо╛ч╜оchannelHandlerчЪДчК╢цАБф╕║ADD_PENDING хН│чнЙх╛Ец╖╗хКа,х╜УчК╢цАБхПШф╕║ADD_COMPLETEцЧ╢ channelHandlerф╕нчЪДhandlerAddedф╝ЪшвлхЫЮш░Г</span>
            newCtx<span class="token punctuation">.</span><span class="token function">setAddPending</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//хРСpipelineф╕нц╖╗хКаPendingHandlerAddedTaskф╗╗хКбя╝МхЬиф╗╗хКбф╕нхЫЮш░ГhandlerAdded</span>
            <span class="token comment">//х╜Уchannelц│ихЖМхИ░reactorхРОя╝Мpipelineф╕нчЪДpendingHandlerCallbackHeadф╗╗хКбщУ╛шбиф╝ЪшвлцМиф╕кцЙзшбМ</span>
            <span class="token function">callHandlerCallbackLater</span><span class="token punctuation">(</span>newCtx<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//хжВцЮЬх╜УхЙНchannelх╖▓ч╗ПхРСreactorц│ихЖМцИРхКЯя╝МщВгф╣Их░▒чЫ┤цОехЫЮш░ГchannelHandlerф╕нчЪДhandlerAdddedцЦ╣ц│Х</span>
        <span class="token class-name">EventExecutor</span> executor <span class="token operator">=</span> newCtx<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>executor<span class="token punctuation">.</span><span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//ш┐ЩщЗМщЬАшжБчбоф┐ЭchannelHandlerф╕нhandlerAddedцЦ╣ц│ХчЪДхЫЮш░ГцШпхЬиchannelцМЗхоЪчЪДexecutorф╕н</span>
            <span class="token function">callHandlerAddedInEventLoop</span><span class="token punctuation">(</span>newCtx<span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//хЫЮш░ГchannelHandlerф╕нчЪДhandlerAdddedцЦ╣ц│Х</span>
    <span class="token function">callHandlerAdded0</span><span class="token punctuation">(</span>newCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ш┐Щф╕кцЦ╣ц│ХчЪДщА╗ш╛Сш┐ШцШпцпФш╛ГхдНцЭВчЪДя╝Мц╢ЙхПКхИ░х╛ИхдЪч╗ЖшКВя╝Мф╕║ф║Жц╕ЕцЩ░хЬ░ф╕║хдзхо╢шо▓ш┐░я╝МчмФшАЕш┐ЩщЗМш┐ШцШпщЗЗчФицА╗хИЖцА╗чЪДч╗УцЮДя╝МхЕИцППш┐░шпецЦ╣ц│ХчЪДцА╗ф╜УщА╗ш╛Ся╝МчД╢хРОхЬищТИхп╣ца╕х┐Гч╗ЖшКВшжБчВ╣х▒Хх╝Ач╗ЖшКВхИЖцЮРуАВ</p> <p>хЫаф╕║хРС pipeline ф╕нц╖╗хКа channelHandler чЪДцУНф╜ЬхПпшГ╜ф╝ЪхЬихдЪф╕кч║┐чиЛф╕нш┐ЫшбМя╝МцЙАф╗еф╕║ф║Жчбоф┐Эц╖╗хКацУНф╜ЬчЪДч║┐чиЛхоЙхЕицАзя╝Мш┐ЩщЗМщЗЗчФиф╕Аф╕к synchronized шпнхПехЭЧх░ЖцХ┤ф╕кц╖╗хКащА╗ш╛СхМЕшг╣ш╡╖цЭеуАВ</p> <ol><li>щАЪш┐З checkMultiplicity цгАцЯешвлц╖╗хКачЪД ChannelHandler цШпхРжцШпхЕ▒ф║лчЪДя╝ИцаЗц│и @Sharable ц│ишзгя╝Йя╝МхжВцЮЬф╕НцШпхЕ▒ф║лчЪДщВгф╣ИхИЩф╕Нф╝ЪхЕБшо╕шпе ChannelHandler чЪД<strong>хРМф╕АхоЮф╛Л</strong>швлц╖╗хКаш┐ЫхдЪф╕к pipeline ф╕нуАВхжВцЮЬцШпхЕ▒ф║лчЪДя╝МхИЩхЕБшо╕шпе ChannelHandler чЪД<strong>хРМф╕Аф╕кхоЮф╛Л</strong>швлхдЪцмбц╖╗хКаш┐ЫхдЪф╕к pipeline ф╕нуАВ</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">checkMultiplicity</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token keyword">instanceof</span> <span class="token class-name">ChannelHandlerAdapter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ChannelHandlerAdapter</span> h <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ChannelHandlerAdapter</span><span class="token punctuation">)</span> handler<span class="token punctuation">;</span>
        <span class="token comment">//хПкцЬЙцаЗц│и@Sharableц│ишзгчЪДchannelHandlerя╝МцЙНшвлхЕБшо╕хРМф╕Аф╕кхоЮф╛Лшвлц╖╗хКаш┐ЫхдЪф╕кpipelineф╕н</span>
        <span class="token comment">//ц│ицДПя╝ЪцаЗц│и@Sharableф╣ЛхРОя╝Мф╕Аф╕кchannelHandlerчЪДхоЮф╛ЛхПпф╗ешвлц╖╗хКахИ░хдЪф╕кchannelхп╣х║ФчЪДpipelineф╕н</span>
        <span class="token comment">//хПпшГ╜швлхдЪч║┐чиЛцЙзшбМя╝МщЬАшжБчбоф┐Эч║┐чиЛхоЙхЕи</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>h<span class="token punctuation">.</span><span class="token function">isSharable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> h<span class="token punctuation">.</span>added<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ChannelPipelineException</span><span class="token punctuation">(</span>
                h<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                <span class="token string">&quot; is not a @Sharable handler, so can't be added or removed multiple times.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        h<span class="token punctuation">.</span>added <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>ш┐ЩщЗМхдзхо╢щЬАшжБц│ицДПчЪДцШпя╝МхжВцЮЬф╕Аф╕к ChannelHandler швлцаЗц│иф║Ж @Sharable ц│ишзг,ш┐Щх░▒цДПхС│чЭАхоГчЪДф╕Аф╕кхоЮф╛ЛхПпф╗ешвлхдЪцмбц╖╗хКаш┐ЫхдЪф╕к pipeline ф╕ня╝ИцпПф╕к channel хп╣х║Фф╕Аф╕к pipeline хоЮф╛Ля╝Йя╝МшАМш┐ЩхдЪф╕кф╕НхРМчЪД pipeline хПпшГ╜ф╝Ъшвлф╕НхРМчЪД reactor ч║┐чиЛцЙзшбМя╝МцЙАф╗ехЬиф╜┐чФихЕ▒ф║л ChannelHandler чЪДцЧ╢хАЩщЬАшжБчбоф┐ЭхЕ╢ч║┐чиЛхоЙхЕицАзуАВ</p></blockquote> <p>цпФхжВф╕ЛщЭвчЪДхоЮф╛Лф╗гчаБя╝Ъ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Sharable</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>щЬАшжБчбоф┐Эч║┐чиЛхоЙхЕи<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token keyword">final</span> <span class="token class-name">EchoServerHandler</span> serverHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EchoServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>serverHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>EchoServerHandler ф╕║цИСф╗мшЗкхоЪф╣ЙчЪД ChannelHandler я╝МхоГшвл @Sharable ц│ишзгцаЗц│ия╝МхЕих▒АхПкцЬЙф╕Аф╕кхоЮф╛Ля╝Мшвлц╖╗хКаш┐ЫхдЪф╕к Channel чЪД pipeline ф╕нуАВф╗ОшАМф╝ЪшвлхдЪф╕к reactor ч║┐чиЛцЙзшбМхИ░уАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192235829.webp" alt="хЫ╛чЙЗ"></p> <ol start="2"><li><p>ф╕║ ChannelHandler хИЫх╗║хЕ╢ ChannelHandlerContext я╝МчФиф║Ох░БшгЕ ChannelHandler чЪДхРНчз░я╝МчК╢цАБф┐бцБпя╝МцЙзшбМф╕Кф╕ЛцЦЗф┐бцБпя╝Мф╗ехПКчФиф║ОцДЯчЯе ChannelHandler хЬи pipeline ф╕нчЪДф╜Нч╜оф┐бцБпуАВnewContext цЦ╣ц│Хц╢ЙхПКчЪДч╗ЖшКВш╛ГхдЪя╝МхРОщЭвцИСф╗мхНХчЛмф╗Лч╗НуАВ</p></li> <li><p>щАЪш┐З addLast0 х░ЖцЦ░хИЫх╗║хЗ║цЭечЪД ChannelHandlerContext цПТхЕехИ░ pipeline ф╕нцЬлх░╛хдДуАВцЦ╣ц│ХчЪДщА╗ш╛Сх╛ИчоАхНХхЕ╢хоЮх░▒цШпф╕Аф╕кцЩощАЪчЪДхПМхРСщУ╛шбицПТхЕецУНф╜ЬуАВ</p></li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addLast0</span><span class="token punctuation">(</span><span class="token class-name">AbstractChannelHandlerContext</span> newCtx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AbstractChannelHandlerContext</span> prev <span class="token operator">=</span> tail<span class="token punctuation">.</span>prev<span class="token punctuation">;</span>
    newCtx<span class="token punctuation">.</span>prev <span class="token operator">=</span> prev<span class="token punctuation">;</span>
    newCtx<span class="token punctuation">.</span>next <span class="token operator">=</span> tail<span class="token punctuation">;</span>
    prev<span class="token punctuation">.</span>next <span class="token operator">=</span> newCtx<span class="token punctuation">;</span>
    tail<span class="token punctuation">.</span>prev <span class="token operator">=</span> newCtx<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>**ф╜ЖцШпш┐ЩщЗМхдзхо╢щЬАшжБц│ицДПчЪДчВ╣цШпя╝Ъ**шЩ╜чД╢цндцЧ╢ ChannelHandlerContext швлчЙйчРЖчЪДцПТхЕехИ░ф║Ж pipeline ф╕ня╝Мф╜ЖцШпцндцЧ╢ channelHandler чЪДчК╢цАБф╛ЭчД╢ф╕║ INIT чК╢цАБя╝Мф╗ОщА╗ш╛Сф╕КцЭешп┤х╣╢цЬкчоЧцШпчЬЯцнгчЪДцПТхЕехИ░ pipeline ф╕ня╝МщЬАшжБчнЙхИ░ ChannelHandler чЪД handlerAdded цЦ╣ц│ХшвлхЫЮш░ГцЧ╢я╝МчК╢цАБцЙНхПШф╕║ ADD_COMPLETE я╝МшАМхПкцЬЙ ADD_COMPLETE чК╢цАБчЪД ChannelHandler цЙНшГ╜хУНх║Ф pipeline ф╕нф╝ацТнчЪДф║Лф╗╢уАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191115611.webp" alt="хЫ╛чЙЗ"></p> <p>хЬиф╕КчпЗцЦЗчла<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484532&amp;idx=1&amp;sn=c3a8b37a2eb09509d9914494ef108c68&amp;chksm=ce77c233f9004b25a29f9fdfb179e41646092d09bc89df2147a9fab66df13231e46dd6a5c26d&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">уАКф╕АцЦЗцРЮцЗВ Netty хПСщАБцХ░цНохЕиц╡БчиЛуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕нчЪДуАК3.1.5 шзжхПС nextChannelHandler чЪД write цЦ╣ц│ХхЫЮш░ГуАЛх░ПшКВф╕нцИСф╗мф╣ЯцПРш┐Зя╝МхЬицпПцмб write ф║Лф╗╢цИЦшАЕ flush ф║Лф╗╢ф╝ацТнчЪДцЧ╢хАЩя╝МщГ╜щЬАшжБщАЪш┐З invokeHandler цЦ╣ц│ХцЭехИдцЦн channelHandler чЪДчК╢цАБцШпхРжф╕║ ADD_COMPLETE я╝МхРжхИЩх╜УхЙН channelHandler хИЩф╕НшГ╜хУНх║ФцнгхЬи pipeline ф╕нф╝ацТнчЪДф║Лф╗╢уАВ<strong>х┐Ещб╗шжБчнЙхИ░хп╣х║ФчЪД handlerAdded цЦ╣ц│ХшвлхЫЮш░ГцЙНхПпф╗ея╝МхЫаф╕║ handlerAdded цЦ╣ц│Хф╕нхПпшГ╜хМЕхРлф╕Аф║Ы ChannelHandler хИЭхзЛхМЦчЪДщЗНшжБщА╗ш╛СуАВ</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">invokeHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ш┐ЩщЗМцШпф╕Аф╕кф╝ШхМЦчВ╣я╝Мnetty чФиф╕Аф╕кх▒АщГихПШщЗПф┐ЭхнШ handlerState</span>
    <span class="token comment">// чЫочЪДцШпхЗПх░С volatile хПШщЗП handlerState чЪДшп╗хПЦцмбцХ░</span>
    <span class="token keyword">int</span> handlerState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handlerState<span class="token punctuation">;</span>
    <span class="token keyword">return</span> handlerState <span class="token operator">==</span> <span class="token constant">ADD_COMPLETE</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>ordered <span class="token operator">&amp;&amp;</span> handlerState <span class="token operator">==</span> <span class="token constant">ADD_PENDING</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">invokeWrite</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">invokeHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">invokeWrite0</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// х╜УхЙНchannelHandlerшЩ╜чД╢ц╖╗хКахИ░pipelineф╕ня╝Мф╜ЖцШпх╣╢ц▓бцЬЙш░ГчФиhandlerAdded</span>
        <span class="token comment">// цЙАф╗еф╕НшГ╜ш░ГчФих╜УхЙНchannelHandlerф╕нчЪДхЫЮш░ГцЦ╣ц│Хя╝МхПкшГ╜ч╗зч╗нхРСхЙНф╝ащАТwriteф║Лф╗╢</span>
        <span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">invokeHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">invokeFlush0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//хжВцЮЬшпеChannelHandlerшЩ╜чД╢хКахЕехИ░pipelineф╕нф╜ЖhandlerAddedцЦ╣ц│Хх╣╢цЬкшвлхЫЮш░Гя╝МхИЩч╗зч╗нхРСхЙНф╝ащАТflushф║Лф╗╢</span>
        <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>ф║ЛхоЮф╕Кф╕Нф╗Еф╗ЕцШп write ф║Лф╗╢хТМ flush ф║Лф╗╢хЬиф╝ацТнчЪДцЧ╢хАЩщЬАшжБхИдцЦн ChannelHandler чЪДчК╢цАБя╝МцЙАцЬЙчЪД inbound ч▒╗ф║Лф╗╢хТМ outbound ч▒╗ф║Лф╗╢хЬиф╝ацТнчЪДцЧ╢хАЩщГ╜щЬАшжБщАЪш┐З invokeHandler цЦ╣ц│ХцЭехИдцЦнх╜УхЙН ChannelHandler чЪДчК╢цАБцШпхРжф╕║ ADD_COMPLETE я╝МщЬАшжБчбоф┐ЭхЬи ChannelHandler хУНх║Фф║Лф╗╢ф╣ЛхЙНя╝МхоГчЪД handlerAdded цЦ╣ц│ХшвлхЫЮш░ГуАВ</p></blockquote> <ol start="4"><li>хжВцЮЬхРС pipeline ф╕нц╖╗хКа ChannelHandler чЪДцЧ╢хАЩя╝М channel ш┐Шц▓бцЭех╛ЧхПКц│ихЖМхИ░ reactor ф╕ня╝МщВгф╣ИщЬАшжБх░Жх╜УхЙН ChannelHandler чЪДчК╢цАБхЕИшо╛ч╜оф╕║ ADD_PENDING я╝Мх╣╢х░ЖхЫЮш░Гшпе ChannelHandler чЪД handlerAdded цЦ╣ц│Хх░БшгЕцИР PendingHandlerAddedTask ф╗╗хКбц╖╗хКаш┐Ы pipeline ф╕нчЪДф╗╗хКбхИЧшбиф╕ня╝МчнЙхИ░ channel хРС reactor ц│ихЖМф╣ЛхРОя╝Мreactor ч║┐чиЛф╝ЪцМиф╕кцЙзшбМ pipeline ф╕нф╗╗хКбхИЧшбиф╕нчЪДф╗╗хКбуАВ</li></ol> <blockquote><p>ш┐Щцо╡щА╗ш╛Сф╕╗шжБчФицЭехдДчРЖ ChannelInitializer чЪДц╖╗хКахЬ║цЩпя╝МхЫаф╕║чЫохЙНхПкцЬЙ ChannelInitializer ш┐Щф╕кчЙ╣цоКчЪД channelHandler ф╝ЪхЬи channel ц▓бцЬЙц│ихЖМф╣ЛхЙНшвлц╖╗хКаш┐Ы pipeline ф╕н</p></blockquote> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>registered<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    newCtx<span class="token punctuation">.</span><span class="token function">setAddPending</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">callHandlerCallbackLater</span><span class="token punctuation">(</span>newCtx<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хРС pipeline чЪДф╗╗хКбхИЧшби pendingHandlerCallbackHead ф╕нц╖╗хКа PendingHandlerAddedTask ф╗╗хКбя╝Ъ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultChannelPipeline</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelPipeline</span> <span class="token punctuation">{</span>

    <span class="token comment">// pipelineф╕нчЪДф╗╗хКбхИЧшби</span>
    <span class="token keyword">private</span> <span class="token class-name">PendingHandlerCallback</span> pendingHandlerCallbackHead<span class="token punctuation">;</span>

    <span class="token comment">// хРСф╗╗хКбхИЧшбих░╛щГиц╖╗хКаPendingHandlerAddedTask</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">callHandlerCallbackLater</span><span class="token punctuation">(</span><span class="token class-name">AbstractChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token keyword">boolean</span> added<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">assert</span> <span class="token operator">!</span>registered<span class="token punctuation">;</span>

        <span class="token class-name">PendingHandlerCallback</span> task <span class="token operator">=</span> added <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">PendingHandlerAddedTask</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">PendingHandlerRemovedTask</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PendingHandlerCallback</span> pending <span class="token operator">=</span> pendingHandlerCallbackHead<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pending <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pendingHandlerCallbackHead <span class="token operator">=</span> task<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Find the tail of the linked-list.</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>pending<span class="token punctuation">.</span>next <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pending <span class="token operator">=</span> pending<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            pending<span class="token punctuation">.</span>next <span class="token operator">=</span> task<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>PendingHandlerAddedTask ф╗╗хКбш┤Яш┤гхЫЮш░Г ChannelHandler ф╕нчЪД handlerAdded цЦ╣ц│ХуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">PendingHandlerAddedTask</span> <span class="token keyword">extends</span> <span class="token class-name">PendingHandlerCallback</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">callHandlerAdded0</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">callHandlerAdded0</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">AbstractChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">callHandlerAdded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192238675.webp" alt="хЫ╛чЙЗ"></p> <ol><li>щЩдф║Ж ChannelInitializer ш┐Щф╕кчЙ╣цоКчЪД ChannelHandler чЪДц╖╗хКацШпхЬи channel хРС reactor ц│ихЖМф╣ЛхЙНхдЦя╝МхЙйф╕ЛчЪДш┐Щф║ЫчФицИ╖шЗкхоЪф╣ЙчЪД ChannelHandler чЪДц╖╗хКая╝МхЭЗцШпхЬи channel хРС reactor ц│ихЖМф╣ЛхРОшвлц╖╗хКаш┐Ы pipeline чЪДуАВш┐ЩчзНхЬ║цЩпф╕ЛчЪДхдДчРЖх░▒ф╝ЪхПШх╛ЧцпФш╛ГчоАхНХя╝МхЬи ChannelHandler швлцПТхЕехИ░ pipeline ф╕нф╣ЛхРОя╝Мх░▒ф╝ЪчлЛхН│хЫЮш░Гшпе ChannelHandler чЪД handlerAdded цЦ╣ц│ХуАВ<strong>ф╜ЖцШпщЬАшжБчбоф┐Э handlerAdded цЦ╣ц│ХчЪДхЫЮш░ГхЬи channel цМЗхоЪчЪД executor ф╕нш┐ЫшбМуАВ</strong></li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">EventExecutor</span> executor <span class="token operator">=</span> newCtx<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>executor<span class="token punctuation">.</span><span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">callHandlerAddedInEventLoop</span><span class="token punctuation">(</span>newCtx<span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">callHandlerAdded0</span><span class="token punctuation">(</span>newCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>хжВцЮЬх╜УхЙНцЙзшбМч║┐чиЛх╣╢ф╕НцШп ChannelHandler цМЗхоЪчЪД executor ( !executor.inEventLoop() )я╝МщВгф╣Их░▒щЬАшжБчбоф┐Э handlerAdded цЦ╣ц│ХчЪДхЫЮш░ГхЬи channel цМЗхоЪчЪД executor ф╕нш┐ЫшбМуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">callHandlerAddedInEventLoop</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">AbstractChannelHandlerContext</span> newCtx<span class="token punctuation">,</span> <span class="token class-name">EventExecutor</span> executor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    newCtx<span class="token punctuation">.</span><span class="token function">setAddPending</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">callHandlerAdded0</span><span class="token punctuation">(</span>newCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>ш┐ЩщЗМщЬАшжБц│ицДПчЪДцШпщЬАшжБхЬихЫЮш░Г handlerAdded цЦ╣ц│Хф╣ЛхЙНх░Ж ChannelHandler чЪДчК╢цАБцПРхЙНшо╛ч╜оф╕║ ADD_COMPLETE уАВ</strong> хЫаф╕║чФицИ╖хПпшГ╜хЬи ChannelHandler ф╕нчЪД handerAdded хЫЮш░Гф╕ншзжхПСф╕Аф║Ыф║Лф╗╢я╝МшАМхжВцЮЬцндцЧ╢ ChannelHandler чЪДчК╢цАБф╕НцШп ADD_COMPLETE чЪДшпЭя╝Мх░▒ф╝ЪхБЬцнвхп╣ф║Лф╗╢чЪДхУНх║Фя╝Мф╗ОшАМщФЩш┐Зф║Лф╗╢чЪДхдДчРЖуАВ</p> <blockquote><p>ш┐ЩчзНх▒Юф║Оф╕АчзНчФицИ╖цЮБчлпчЪДф╜┐чФицГЕхЖ╡уАВ</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">callHandlerAdded</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setAddComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handlerAdded</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_5-channehandlercontext-чЪДхИЫх╗║"><a href="#_5-channehandlercontext-чЪДхИЫх╗║" class="header-anchor">#</a> 5. ChanneHandlerContext чЪДхИЫх╗║</h2> <p>хЬиф╗Лч╗НхоМ ChannelHandler хРС pipeline ц╖╗хКачЪДцХ┤ф╕кщА╗ш╛Сш┐ЗчиЛхРОя╝МцЬмх░ПшКВцИСф╗мцЭечЬЛф╕ЛхжВф╜Хф╕║ ChannelHandler хИЫх╗║хп╣х║ФчЪД ChannelHandlerContext я╝Мф╗ехПК ChannelHandlerContext ф╕нхЕ╖ф╜УхМЕхРлф║ЖхУкф║Ыф╕Кф╕ЛцЦЗф┐бцБпуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultChannelPipeline</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelPipeline</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">addLast</span><span class="token punctuation">(</span><span class="token class-name">EventExecutorGroup</span> group<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">AbstractChannelHandlerContext</span> newCtx<span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token comment">//хИЫх╗║channelHandlerContextхМЕшг╣channelHandlerх╣╢х░БшгЕцЙзшбМф╝ацТнчЫ╕хЕ│чЪДф╕Кф╕ЛцЦЗф┐бцБп</span>
            newCtx <span class="token operator">=</span> <span class="token function">newContext</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> <span class="token function">filterName</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

             <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">AbstractChannelHandlerContext</span> <span class="token function">newContext</span><span class="token punctuation">(</span><span class="token class-name">EventExecutorGroup</span> group<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultChannelHandlerContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">childExecutor</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>хЬихИЫх╗║ ChannelHandlerContext ф╣ЛхЙНя╝МщЬАшжБхБЪф╕дф╕кщЗНшжБчЪДхЙНч╜оцУНф╜Ья╝Ъ</p> <ul><li>щАЪш┐З filterName цЦ╣ц│Хф╕║ ChannelHandlerContext ш┐Зц╗дхЗ║хЬи pipeline ф╕нхФпф╕АчЪДхРНчз░</li> <li>хжВцЮЬчФицИ╖ф╕║ ChannelHandler цМЗхоЪф║ЖчЙ╣цоКчЪД EventExecutorGroup я╝Мш┐ЩщЗМх░▒щЬАшжБщАЪш┐З childExecutor цЦ╣ц│Хф╗ОцМЗхоЪчЪД EventExecutorGroup ф╕нщАЙхЗ║ф╕Аф╕к EventExecutor ф╕О ChannelHandler ч╗СхоЪ</li></ul> <h3 id="_5-1-filtername"><a href="#_5-1-filtername" class="header-anchor">#</a> 5.1 filterName</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">filterName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// хжВцЮЬц▓бцЬЙцМЗхоЪname,хИЩф╝Ъф╕║handlerщ╗ШшодчФЯцИРф╕Аф╕кnameя╝МшпецЦ╣ц│ХхПпчбоф┐Эщ╗ШшодчФЯцИРчЪДnameхЬиpipelineф╕нф╕Нф╝ЪщЗНхдН</span>
        <span class="token keyword">return</span> <span class="token function">generateName</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// хжВцЮЬцМЗхоЪф║Жnameя╝МщЬАшжБчбоф┐ЭnameхЬиpipelineф╕нцШпхФпф╕АчЪД</span>
    <span class="token function">checkDuplicateName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хжВцЮЬчФицИ╖хЖНхРС pipeline ц╖╗хКа ChannelHandler чЪДцЧ╢хАЩя╝Мф╕║хЕ╢цМЗхоЪф║ЖхЕ╖ф╜УчЪДхРНчз░я╝МщВгф╣Иш┐ЩщЗМщЬАшжБчбоф┐ЭчФицИ╖цМЗхоЪчЪДхРНчз░хЬи pipeline ф╕нцШпхФпф╕АчЪД</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkDuplicateName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">context0</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Duplicate handler name: &quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
     * щАЪш┐ЗцМЗхоЪхРНчз░хЬиpipelineф╕нцЯецЙ╛хп╣х║ФчЪДchannelHandler ц▓бцЬЙш┐ФхЫЮnull
     * */</span>
<span class="token keyword">private</span> <span class="token class-name">AbstractChannelHandlerContext</span> <span class="token function">context0</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AbstractChannelHandlerContext</span> context <span class="token operator">=</span> head<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>context <span class="token operator">!=</span> tail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> context<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        context <span class="token operator">=</span> context<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хжВцЮЬчФицИ╖ц▓бцЬЙф╕║ ChannelHandler цМЗхоЪхРНчз░я╝МщВгф╣Их░▒щЬАшжБф╕║ ChannelHandler хЬи pipeline ф╕нщ╗ШшодчФЯцИРф╕Аф╕кхФпф╕АчЪДхРНчз░уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// pipelineф╕нchannelHandlerхп╣х║ФчЪДnameч╝УхнШ</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">FastThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> nameCaches <span class="token operator">=</span>
    <span class="token keyword">new</span> <span class="token class-name">FastThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WeakHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">generateName</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// шО╖хПЦpipelineф╕нchannelHandlerхп╣х║ФчЪДnameч╝УхнШ</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> nameCaches<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> handlerType <span class="token operator">=</span> handler<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> name <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// х╜УхЙНhandlerш┐Шц▓бхп╣х║ФчЪДnameч╝УхнШя╝МхИЩщ╗ШшодчФЯцИРя╝ЪsimpleClassName + #0</span>
        name <span class="token operator">=</span> <span class="token function">generateName0</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">context0</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ф╕НцЦнщЗНшпХхРНчз░хРОч╝А#n + 1 чЫ┤хИ░ц▓бцЬЙщЗНхдН</span>
        <span class="token class-name">String</span> baseName <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> name<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> newName <span class="token operator">=</span> baseName <span class="token operator">+</span> i<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">context0</span><span class="token punctuation">(</span>newName<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                name <span class="token operator">=</span> newName<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">generateName0</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> handlerType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">simpleClassName</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;#0&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>pipeline ф╕нф╜┐чФиф║Жф╕Аф╕к FastThreadLocal ч▒╗хЮЛчЪД nameCaches цЭеч╝УхнШхРДчзНч▒╗хЮЛ ChannelHandler чЪДхЯ║чбАхРНчз░уАВхРОщЭвф╝Ъца╣цНош┐Щф╕кхЯ║чбАхРНчз░ф╕НцЦнчЪДщЗНшпХчФЯцИРф╕Аф╕кц▓бцЬЙхЖ▓чкБчЪДцнгх╝ПхРНчз░уАВч╝УхнШ nameCaches ф╕нчЪД key шбичд║чЙ╣хоЪчЪД ChannelHandler ч▒╗хЮЛя╝Мvalue шбичд║шпечЙ╣хоЪч▒╗хЮЛчЪД ChannelHandler чЪДхЯ║чбАхРНчз░ <code>simpleClassName + #0</code>уАВ</p> <p>шЗкхКиф╕║ ChannelHandler чФЯцИРщ╗ШшодхРНчз░чЪДщА╗ш╛СцШпя╝Ъ</p> <ul><li>щжЦхЕИф╗Оч╝УхнШф╕н nameCaches шО╖хПЦх╜УхЙНц╖╗хКачЪД ChannelHandler чЪДхЯ║чбАхРНчз░ <code>simpleClassName + #0</code>уАВ</li> <li>хжВцЮЬшпехЯ║чбАхРНчз░ <code>simpleClassName + #0</code> хЬи pipeline ф╕нцШпхФпф╕АчЪДя╝МщВгф╣Их░▒х░ЖхЯ║чбАхРНчз░ф╜Ьф╕║ ChannelHandler чЪДхРНчз░уАВ</li> <li>хжВцЮЬч╝УхнШчЪДхЯ║чбАхРНчз░хЬи pipeline ф╕нф╕НцШпхФпф╕АчЪДя╝МхИЩф╕НцЦнчЪДхвЮхКахРНчз░хРОч╝А <code>simpleClassName#1 ,simpleClassName#2 ...... simpleClassName#n</code> чЫ┤хИ░ф║зчФЯф╕Аф╕кц▓бцЬЙщЗНхдНчЪДхРНчз░уАВ</li></ul> <blockquote><p>шЩ╜чД╢чФицИ╖ф╕НхдзхПпшГ╜х░ЖхРМф╕Ач▒╗хЮЛчЪД channelHandler щЗНхдНц╖╗хКахИ░ pipeline ф╕ня╝Мф╜ЖцШп netty ф╕║ф║ЖщШ▓цнвш┐ЩчзНхПНхдНц╖╗хКахРМф╕Ач▒╗хЮЛ ChannelHandler чЪДшбМф╕║хп╝шЗ┤чЪДхРНчз░хЖ▓чкБя╝Мф╗ОшАМхИйчФи nameCaches цЭеч╝УхнШхРМф╕Ач▒╗хЮЛ ChannelHandler чЪДхЯ║чбАхРНчз░ <code>simpleClassName + #0</code>я╝МчД╢хРОщАЪш┐Зф╕НцЦнчЪДщЗНшпХщАТхвЮхРНчз░хРОч╝Ая╝МцЭечФЯцИРф╕Аф╕кхЬи pipeline ф╕нхФпф╕АчЪДхРНчз░уАВ</p></blockquote> <h3 id="_5-2-childexecutor"><a href="#_5-2-childexecutor" class="header-anchor">#</a> 5.2 childExecutor</h3> <p>щАЪш┐ЗхЙНш╛╣чЪДф╗Лч╗НцИСф╗мф║ЖшзгхИ░я╝Мх╜УцИСф╗мхРС pipeline ц╖╗хКа ChannelHandler чЪДцЧ╢хАЩя╝Мnetty хЕБшо╕цИСф╗мф╕║ ChannelHandler цМЗхоЪчЙ╣хоЪчЪД executor хО╗цЙзшбМ ChannelHandler ф╕нчЪДхРДчзНф║Лф╗╢хЫЮш░ГцЦ╣ц│ХуАВ</p> <p>щАЪх╕╕цИСф╗мф╝Ъф╕║ ChannelHandler цМЗхоЪф╕Аф╕к EventExecutorGroupя╝МхЬихИЫх╗║ ChannelHandlerContext чЪДцЧ╢хАЩя╝Мф╝ЪщАЪш┐З childExecutor цЦ╣ц│Хф╗О EventExecutorGroup ф╕нщАЙхПЦф╕Аф╕к EventExecutor цЭеф╕Ошпе ChannelHandler ч╗СхоЪуАВ</p> <blockquote><p>EventExecutorGroup цШп netty шЗкхоЪф╣ЙчЪДф╕Аф╕кч║┐чиЛц▒ацибхЮЛя╝МхЕ╢ф╕нхМЕхРлхдЪф╕к EventExecutor я╝МшАМ EventExecutor хЬи netty ф╕нцШпф╕Аф╕кч║┐чиЛчЪДцЙзшбМцибхЮЛуАВчЫ╕хЕ│чЪДхЕ╖ф╜УхоЮчО░хТМчФиц│ХчмФшАЕх╖▓ч╗ПхЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247483907&amp;idx=1&amp;sn=084c470a8fe6234c2c9461b5f713ff30&amp;chksm=ce77c444f9004d52e7c6244bee83479070effb0bc59236df071f4d62e91e25f01715fca53696&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">уАКReactor хЬи Netty ф╕нчЪДхоЮчО░(хИЫх╗║чпЗ)уАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕АцЦЗф╕нч╗ЩхЗ║ф║Жшпжх░╜чЪДф╗Лч╗Ня╝Мх┐Шшо░чЪДхРМхнжхПпф╗ехЬихЫЮщб╛ф╕ЛуАВ</p></blockquote> <p>хЬиф╗Лч╗Н executor чЪДч╗СхоЪщА╗ш╛Сф╣ЛхЙНя╝Мш┐ЩщЗМчмФшАЕщЬАшжБхЕИф╕║хдзхо╢ф╗Лч╗Нф╕Аф╕кчЫ╕хЕ│чЪДщЗНшжБхПВцХ░я╝Ъ<code>SINGLE_EVENTEXECUTOR_PER_GROUP</code> я╝Мщ╗Шшодф╕║ true уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token function">childOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SINGLE_EVENTEXECUTOR_PER_GROUP</span><span class="token punctuation">,</span><span class="token boolean">true</span>я╝Й
</code></pre></div><p>цИСф╗мчЯещБУхЬи netty ф╕ня╝МцпПф╕Аф╕к channel щГ╜ф╝Ъхп╣х║Фф╕Аф╕кчЛмчлЛчЪД pipeline я╝МхжВцЮЬцИСф╗мх╝АхРпф║Ж <code>SINGLE_EVENTEXECUTOR_PER_GROUP</code> хПВцХ░я╝Мшбичд║хЬиф╕Аф╕к channel хп╣х║ФчЪД pipeline ф╕ня╝МхжВцЮЬцИСф╗мф╕║хдЪф╕к ChannelHandler цМЗхоЪф║ЖхРМф╕Аф╕к EventExecutorGroup я╝МщВгф╣Иш┐ЩхдЪф╕к channelHandler хПкшГ╜ч╗СхоЪхИ░ EventExecutorGroup ф╕нчЪДхРМф╕Аф╕к EventExecutor ф╕КуАВ</p> <p>ф╗Аф╣ИцДПцАЭхСвя╝Яя╝ЯцпФхжВцИСф╗мцЬЙф╕ЛщЭвф╕Ацо╡хИЭхзЛхМЦ<code>pipeline</code>чЪДф╗гчаБя╝Ъ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>eventExecutorGroup<span class="token punctuation">,</span>channelHandler1<span class="token punctuation">)</span>
                pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>eventExecutorGroup<span class="token punctuation">,</span>channelHandler2<span class="token punctuation">)</span>
                pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>eventExecutorGroup<span class="token punctuation">,</span>channelHandler3<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>eventExecutorGroup ф╕нхМЕхРл EventExecutor1я╝МEventExecutor2 я╝М EventExecutor3 ф╕Йф╕кцЙзшбМч║┐чиЛуАВ</p> <p>хБЗшо╛цндцЧ╢чммф╕Аф╕кш┐ЮцОеш┐ЫцЭея╝МхЬихИЫх╗║ channel1 хРОхИЭхзЛхМЦ pipeline1 чЪДцЧ╢хАЩя╝МхжВцЮЬхЬих╝АхРп <code>SINGLE_EVENTEXECUTOR_PER_GROUP</code> хПВцХ░чЪДцГЕхЖ╡ф╕Ля╝МщВгф╣ИхЬи channel1 хп╣х║ФчЪД pipeline1 ф╕н channelHandler1я╝МchannelHandler2 я╝М channelHandler3 ч╗СхоЪчЪД EventExecutor хЭЗф╕║ EventExecutorGroup ф╕нчЪД EventExecutor1 уАВ</p> <p>чммф║Мф╕кш┐ЮцОе channel2 хп╣х║ФчЪД pipeline2 ф╕н channelHandler1 я╝М channelHandler2 я╝МchannelHandler3 ч╗СхоЪчЪД EventExecutor хЭЗф╕║ EventExecutorGroup ф╕нчЪД EventExecutor2 уАВ</p> <p>чммф╕Йф╕кш┐ЮцОе channel3 хп╣х║ФчЪД pipeline3 ф╕н channelHandler1 я╝М channelHandler2 я╝МchannelHandler3 ч╗СхоЪчЪД EventExecutor хЭЗф╕║ EventExecutorGroup ф╕нчЪД EventExecutor3 уАВ</p> <p>ф╗ецндч▒╗цОи........</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191115389.webp" alt="хЫ╛чЙЗ"></p> <p>хжВцЮЬхЬихЕ│щЧн <code>SINGLE_EVENTEXECUTOR_PER_GROUP</code> хПВцХ░чЪДцГЕхЖ╡ф╕Л, channel1 хп╣х║ФчЪД pipeline1 ф╕н channelHandler1 ф╝Ъч╗СхоЪхИ░ EventExecutorGroup ф╕нчЪД EventExecutor1 я╝МchannelHandler2 ф╝Ъч╗СхоЪхИ░ EventExecutor2 я╝МchannelHandler3 ф╝Ъч╗СхоЪхИ░ EventExecutor3 уАВ</p> <p>хРМчРЖхЕ╢ф╗Ц channel хп╣х║ФчЪД pipeline ф╕нчЪД channelHandler ч╗СхоЪщА╗ш╛СхРМ channel1 уАВхоГф╗мхЭЗф╝Ъч╗СхоЪхИ░ EventExecutorGroup ф╕нчЪДф╕НхРМ EventExecutor ф╕нуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192242607.webp" alt="хЫ╛чЙЗ"></p> <p>х╜УцИСф╗мф║Жшзгф║Ж <code>SINGLE_EVENTEXECUTOR_PER_GROUP</code>хПВцХ░чЪДф╜ЬчФиф╣ЛхРОя╝МхЖНцЭечЬЛф╕ЛщЭвш┐Щцо╡ч╗СхоЪщА╗ш╛Сх░▒х╛Ихо╣цШУчРЖшзгф║ЖуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// хЬицпПф╕кpipelineф╕нщГ╜ф╝Ъф┐ЭхнШEventExecutorGroupф╕нч╗СхоЪчЪДч║┐чиЛ</span>
<span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EventExecutorGroup</span><span class="token punctuation">,</span> <span class="token class-name">EventExecutor</span><span class="token punctuation">&gt;</span></span> childExecutors<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">EventExecutor</span> <span class="token function">childExecutor</span><span class="token punctuation">(</span><span class="token class-name">EventExecutorGroup</span> group<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>group <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Boolean</span> pinEventExecutor <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SINGLE_EVENTEXECUTOR_PER_GROUP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pinEventExecutor <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>pinEventExecutor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//хжВцЮЬц▓бцЬЙх╝АхРпSINGLE_EVENTEXECUTOR_PER_GROUPя╝МхИЩцМЙщб║х║Пф╗ОцМЗхоЪчЪДEventExecutorGroupф╕нф╕║channelHandlerхИЖщЕНEventExecutor</span>
        <span class="token keyword">return</span> group<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//шО╖хПЦpipelineч╗СхоЪхИ░EventExecutorGroupчЪДч║┐чиЛя╝ИхЬиф╕Аф╕кpipelineф╕нф╝Ъф╕║цпПф╕кцМЗхоЪчЪДEventExecutorGroupч╗СхоЪф╕Аф╕кхЫ║хоЪчЪДч║┐чиЛя╝Й</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EventExecutorGroup</span><span class="token punctuation">,</span> <span class="token class-name">EventExecutor</span><span class="token punctuation">&gt;</span></span> childExecutors <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>childExecutors<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>childExecutors <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        childExecutors <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>childExecutors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IdentityHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EventExecutorGroup</span><span class="token punctuation">,</span> <span class="token class-name">EventExecutor</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//шО╖хПЦшпеpipelineч╗СхоЪхЬицМЗхоЪEventExecutorGroupф╕нчЪДч║┐чиЛ</span>
    <span class="token class-name">EventExecutor</span> childExecutor <span class="token operator">=</span> childExecutors<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>childExecutor <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        childExecutor <span class="token operator">=</span> group<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        childExecutors<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> childExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> childExecutor<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хжВцЮЬцИСф╗мх╣╢цЬкчЙ╣цоКцМЗхоЪ ChannelHandler чЪД executor я╝МщВгф╣Ищ╗Шшодф╝ЪцШпхп╣х║Ф channel ч╗СхоЪчЪД reactor ч║┐чиЛш┤Яш┤гцЙзшбМшпе ChannelHandler уАВ</p> <p>хжВцЮЬцИСф╗мцЬкх╝АхРп <code>SINGLE_EVENTEXECUTOR_PER_GROUP</code>я╝Мnetty х░▒ф╝Ъф╗ОцИСф╗мцМЗхоЪчЪД EventExecutorGroup ф╕нцМЙчЕз round-robin чЪДцЦ╣х╝Пф╕║ ChannelHandler ч╗СхоЪхЕ╢ф╕нф╕Аф╕к eventExecutor уАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192243345.webp" alt="хЫ╛чЙЗ"></p> <p>хжВцЮЬцИСф╗мх╝АхРпф║Ж <code>SINGLE_EVENTEXECUTOR_PER_GROUP</code>я╝М<strong>чЫ╕хРМчЪД EventExecutorGroup хЬихРМф╕Аф╕к pipeline хоЮф╛Лф╕нчЪДч╗СхоЪхЕ│ч│╗цШпхЫ║хоЪчЪД</strong>уАВхЬи pipeline ф╕нхжВцЮЬхдЪф╕к channelHandler цМЗхоЪф║ЖхРМф╕Аф╕к EventExecutorGroup я╝МщВгф╣Иш┐Щф║Ы channelHandler чЪД executor хЭЗф╝Ъч╗СхоЪхИ░ф╕Аф╕кхЫ║хоЪчЪД eventExecutor ф╕КуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191115389.webp" alt="хЫ╛чЙЗ"></p> <p>ш┐ЩчзНхЫ║хоЪчЪДч╗СхоЪхЕ│ч│╗ч╝УхнШф║ОцпПф╕к pipeline ф╕нчЪД Map&lt;EventExecutorGroup, EventExecutor&gt; childExecutors хнЧцо╡ф╕ня╝Мkey цШпчФицИ╖ф╕║ channelHandler цМЗхоЪчЪД EventExecutorGroup я╝Мvalue ф╕║шпе EventExecutorGroup хЬи pipeline хоЮф╛Лф╕нчЪДч╗СхоЪ eventExecutor уАВ</p> <p>цОеф╕ЛцЭех░▒цШпф╗О childExecutors ф╕ншО╖хПЦцМЗхоЪ EventExecutorGroup хЬишпе pipeline хоЮф╛Лф╕нчЪДч╗СхоЪ eventExecutorя╝МхжВцЮЬч╗СхоЪхЕ│ч│╗ш┐ШцЬкх╗║члЛя╝МхИЩщАЪш┐З round-robin чЪДцЦ╣х╝Пф╗О EventExecutorGroup ф╕нщАЙхПЦф╕Аф╕к eventExecutor ш┐ЫшбМч╗СхоЪя╝Мх╣╢хЬи childExecutor ф╕нч╝УхнШч╗СхоЪхЕ│ч│╗уАВ</p> <p>хжВцЮЬч╗СхоЪхЕ│ч│╗х╖▓ч╗Пх╗║члЛя╝МхИЩчЫ┤цОеф╕║ ChannelHandler цМЗхоЪч╗СхоЪхе╜чЪД eventExecutorуАВ</p> <h3 id="_5-3-channehandlercontext"><a href="#_5-3-channehandlercontext" class="header-anchor">#</a> 5.3 ChanneHandlerContext</h3> <p>хЬиф╗Лч╗НхоМхИЫх╗║ ChannelHandlerContext чЪДф╕дф╕кхЙНч╜оцУНф╜ЬхРОя╝МцИСф╗мхЫЮхд┤цЭечЬЛф╕Л ChannelHandlerContext ф╕нхМЕхРлф║ЖхУкф║ЫхЕ╖ф╜УчЪДф╕Кф╕ЛцЦЗф┐бцБпуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">DefaultChannelHandlerContext</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractChannelHandlerContext</span> <span class="token punctuation">{</span>

    <span class="token comment">// ChannelHandlerContextхМЕшг╣чЪДchannelHandler</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">;</span>

    <span class="token class-name">DefaultChannelHandlerContext</span><span class="token punctuation">(</span>
            <span class="token class-name">DefaultChannelPipeline</span> pipeline<span class="token punctuation">,</span> <span class="token class-name">EventExecutor</span> executor<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>pipeline<span class="token punctuation">,</span> executor<span class="token punctuation">,</span> name<span class="token punctuation">,</span> handler<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//хМЕшг╣чЪДchannelHandler</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>handler <span class="token operator">=</span> handler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ChannelHandler</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> handler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractChannelHandlerContext</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">,</span> <span class="token class-name">ResourceLeakHint</span> <span class="token punctuation">{</span>
    <span class="token comment">//хп╣х║ФchannelHandlerчЪДхРНчз░</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token comment">//ChannelHandlerContextф╕нцМБцЬЙpipelineчЪДх╝ХчФи</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DefaultChannelPipeline</span> pipeline<span class="token punctuation">;</span>

    <span class="token comment">// channelHandler хп╣х║ФчЪД executor щ╗Шшодф╕║ reactor</span>
    <span class="token keyword">final</span> <span class="token class-name">EventExecutor</span> executor<span class="token punctuation">;</span>

    <span class="token comment">//channelHandlerContextф╕нф┐ЭхнШchannelHandlerчЪДцЙзшбМцЭбф╗╢цОйчаБя╝ИцШпф╗Аф╣Ич▒╗хЮЛчЪДChannelHandler,хп╣ф╗Аф╣Иф║Лф╗╢цДЯхЕ┤ш╢гя╝Й</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> executionMask<span class="token punctuation">;</span>

    <span class="token comment">//falseшбичд║ х╜УchannelHandlerчЪДчК╢цАБф╕║ADD_PENDINGчЪДцЧ╢хАЩя╝Мф╣ЯхПпф╗ехУНх║Фpipelineф╕нчЪДф║Лф╗╢</span>
    <span class="token comment">//trueшбичд║хПкцЬЙхЬиchannelHandlerчЪДчК╢цАБф╕║ADD_COMPLETEчЪДцЧ╢хАЩцЙНшГ╜хУНх║Фpipelineф╕нчЪДф║Лф╗╢</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> ordered<span class="token punctuation">;</span>

    <span class="token comment">//channelHandelrчЪДчК╢цАБя╝МхИЭхзЛхМЦф╕║INIT</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> handlerState <span class="token operator">=</span> <span class="token constant">INIT</span><span class="token punctuation">;</span>

    <span class="token class-name">AbstractChannelHandlerContext</span><span class="token punctuation">(</span><span class="token class-name">DefaultChannelPipeline</span> pipeline<span class="token punctuation">,</span> <span class="token class-name">EventExecutor</span> executor<span class="token punctuation">,</span>
                                  <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelHandler</span><span class="token punctuation">&gt;</span></span> handlerClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pipeline <span class="token operator">=</span> pipeline<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>executor <span class="token operator">=</span> executor<span class="token punctuation">;</span>
        <span class="token comment">//channelHandlerContextф╕нф┐ЭхнШchannelHandlerчЪДцЙзшбМцЭбф╗╢цОйчаБя╝ИцШпф╗Аф╣Ич▒╗хЮЛчЪДChannelHandler,хп╣ф╗Аф╣Иф║Лф╗╢цДЯхЕ┤ш╢гя╝Й</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>executionMask <span class="token operator">=</span> <span class="token function">mask</span><span class="token punctuation">(</span>handlerClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ordered <span class="token operator">=</span> executor <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> executor <span class="token keyword">instanceof</span> <span class="token class-name">OrderedEventExecutor</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192244294.webp" alt="хЫ╛чЙЗ"></p> <p>ш┐ЩщЗМчмФшАЕщЗНчВ╣ф╗Лч╗Н orderd х▒ЮцАзхТМ executionMask х▒ЮцАзя╝МхЕ╢ф╗ЦчЪДх▒ЮцАзхдзхо╢х╛Ихо╣цШУчРЖшзгуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code>ordered <span class="token operator">=</span> executor <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> executor <span class="token keyword">instanceof</span> <span class="token class-name">OrderedEventExecutor</span><span class="token punctuation">;</span>
</code></pre></div><p>х╜УцИСф╗мф╕НцМЗхоЪ channelHandler чЪД executor цЧ╢цИЦшАЕцМЗхоЪчЪД executor ч▒╗хЮЛф╕║ OrderedEventExecutor цЧ╢я╝Мordered = trueуАВ</p> <p>щВгф╣Иш┐Щф╕к ordered х▒ЮцАзхп╣ф║О ChannelHandler хУНх║Ф pipeline ф╕нчЪДф║Лф╗╢цЬЙф╗Аф╣Их╜▒хУНхСвя╝Я</p> <p>цИСф╗мф╣ЛхЙНф╗Лч╗Нш┐ЗхЬи ChannelHandler хУНх║Ф pipeline ф╕нчЪДф║Лф╗╢ф╣ЛхЙНщГ╜ф╝Ъш░ГчФи invokeHandler() цЦ╣ц│ХцЭехИдцЦнцШпхРжхЫЮш░Г ChannelHandler чЪДф║Лф╗╢хЫЮш░ГцЦ╣ц│Хш┐ШцШпш╖│ш┐ЗуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">invokeHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> handlerState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handlerState<span class="token punctuation">;</span>
    <span class="token keyword">return</span> handlerState <span class="token operator">==</span> <span class="token constant">ADD_COMPLETE</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>ordered <span class="token operator">&amp;&amp;</span> handlerState <span class="token operator">==</span> <span class="token constant">ADD_PENDING</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>х╜У <code>ordered == false</code> цЧ╢я╝МchannelHandler чЪДчК╢цАБф╕║ ADD_PENDING чЪДцЧ╢хАЩя╝Мф╣ЯхПпф╗ехУНх║Ф pipeline ф╕нчЪДф║Лф╗╢уАВ</li> <li>х╜У <code>ordered == true</code> цЧ╢я╝МхПкцЬЙхЬи channelHandler чЪДчК╢цАБф╕║ ADD_COMPLETE чЪДцЧ╢хАЩцЙНшГ╜хУНх║Ф pipeline ф╕нчЪДф║Лф╗╢</li></ul> <p>хПжф╕Аф╕кщЗНшжБчЪДх▒ЮцАз <code>executionMask</code> ф┐ЭхнШчЪДцШпх╜УхЙН ChannelHandler чЪДф╕Аф║ЫцЙзшбМцЭбф╗╢ф┐бцБпцОйчаБя╝МцпФхжВя╝Ъ</p> <ul><li>х╜УхЙН ChannelHandler цШпф╗Аф╣Ич▒╗хЮЛчЪДя╝И ChannelInboundHandler or ChannelOutboundHandler ?я╝ЙуАВ</li> <li>х╜УхЙН ChannelHandler хп╣хУкф║Ыф║Лф╗╢цДЯхЕ┤ш╢гя╝ИшжЖчЫЦф║ЖхУкф║Ыф║Лф╗╢хЫЮш░ГцЦ╣ц│Х?я╝Й</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">FastThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelHandler</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token constant">MASKS</span> <span class="token operator">=</span>
    <span class="token keyword">new</span> <span class="token class-name">FastThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelHandler</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelHandler</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WeakHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelHandler</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">mask</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelHandler</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// хЫаф╕║цпПх╗║члЛф╕Аф╕кchannelх░▒ф╝ЪхИЭхзЛхМЦф╕Аф╕кpipelineя╝Мш┐ЩщЗМщЬАшжБх░ЖChannelHandlerхп╣х║ФчЪДmaskч╝УхнШ</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelHandler</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> <span class="token constant">MASKS</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Integer</span> mask <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mask <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// шобчоЧChannelHandlerхп╣х║ФчЪДmaskя╝Иф╗Аф╣Ич▒╗хЮЛчЪДChannelHandlerя╝Мхп╣ф╗Аф╣Иф║Лф╗╢цДЯхЕ┤ш╢гя╝Й</span>
        mask <span class="token operator">=</span> <span class="token function">mask0</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> mask<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ш┐ЩщЗМщЬАшжБф╕Аф╕к FastThreadLocal ч▒╗хЮЛчЪД MASKS хнЧцо╡цЭеч╝УхнШ ChannelHandler хп╣х║ФчЪДцЙзшбМцОйчаБуАВхЫаф╕║ ChannelHandler ч▒╗ф╕АцЧжшвлхоЪф╣ЙхЗ║цЭехоГчЪДцЙзшбМцОйчаБх░▒хЫ║хоЪф║Жя╝МшАМ netty щЬАшжБцОецФ╢хдзщЗПчЪДш┐ЮцОея╝МхИЫх╗║хдзщЗПчЪД channel я╝Мх╣╢ф╕║ш┐Щф║Ы channel хИЭхзЛхМЦхп╣х║ФчЪД pipeline я╝МщЬАшжБщвСч╣БчЪДшо░х╜Х channelHandler чЪДцЙзшбМцОйчаБхИ░ context ч▒╗ф╕ня╝МцЙАф╗еш┐ЩщЗМщЬАшжБх░ЖцОйчаБч╝УхнШш╡╖цЭеуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">mask0</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelHandler</span><span class="token punctuation">&gt;</span></span> handlerType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> mask <span class="token operator">=</span> <span class="token constant">MASK_EXCEPTION_CAUGHT</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ChannelInboundHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//хжВцЮЬшпеChannelHandlerцШпInboundч▒╗хЮЛчЪДя╝МхИЩхЕИх░Жinboundф║Лф╗╢хЕищГишо╛ч╜ош┐ЫцОйчаБф╕н</span>
            mask <span class="token operator">|=</span> <span class="token constant">MASK_ALL_INBOUND</span><span class="token punctuation">;</span>

            <span class="token comment">//цЬАхРОхЬихп╣ф╕НцДЯхЕ┤ш╢гчЪДф║Лф╗╢ф╕Аф╕АцОТщЩдя╝Иhandlerф╕нчЪДф║Лф╗╢хЫЮш░ГцЦ╣ц│ХхжВцЮЬцаЗц│иф║Ж@Skipц│ишзгя╝МхИЩшодф╕║handlerхп╣шпеф║Лф╗╢ф╕НцДЯхЕ┤ш╢гя╝Й</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSkippable</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">,</span> <span class="token string">&quot;channelRegistered&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mask <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token constant">MASK_CHANNEL_REGISTERED</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSkippable</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">,</span> <span class="token string">&quot;channelUnregistered&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mask <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token constant">MASK_CHANNEL_UNREGISTERED</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSkippable</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">,</span> <span class="token string">&quot;channelActive&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mask <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token constant">MASK_CHANNEL_ACTIVE</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSkippable</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">,</span> <span class="token string">&quot;channelInactive&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mask <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token constant">MASK_CHANNEL_INACTIVE</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSkippable</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">,</span> <span class="token string">&quot;channelRead&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mask <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token constant">MASK_CHANNEL_READ</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSkippable</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">,</span> <span class="token string">&quot;channelReadComplete&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mask <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token constant">MASK_CHANNEL_READ_COMPLETE</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSkippable</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">,</span> <span class="token string">&quot;channelWritabilityChanged&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mask <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token constant">MASK_CHANNEL_WRITABILITY_CHANGED</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSkippable</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">,</span> <span class="token string">&quot;userEventTriggered&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mask <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token constant">MASK_USER_EVENT_TRIGGERED</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ChannelOutboundHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//хжВцЮЬhandlerф╕║Outboundч▒╗хЮЛчЪДя╝МхИЩхЕИх░ЖхЕищГиoutboundф║Лф╗╢шо╛ч╜ош┐ЫцОйчаБф╕н</span>
            mask <span class="token operator">|=</span> <span class="token constant">MASK_ALL_OUTBOUND</span><span class="token punctuation">;</span>

            <span class="token comment">//цЬАхРОхп╣handlerф╕НцДЯхЕ┤ш╢гчЪДф║Лф╗╢ф╗ОцОйчаБф╕нф╕Аф╕АцОТщЩд</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSkippable</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">,</span> <span class="token string">&quot;bind&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                            <span class="token class-name">SocketAddress</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mask <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token constant">MASK_BIND</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSkippable</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">,</span> <span class="token string">&quot;connect&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">SocketAddress</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                            <span class="token class-name">SocketAddress</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mask <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token constant">MASK_CONNECT</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSkippable</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">,</span> <span class="token string">&quot;disconnect&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mask <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token constant">MASK_DISCONNECT</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSkippable</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">,</span> <span class="token string">&quot;close&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mask <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token constant">MASK_CLOSE</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSkippable</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">,</span> <span class="token string">&quot;deregister&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mask <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token constant">MASK_DEREGISTER</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSkippable</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">,</span> <span class="token string">&quot;read&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mask <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token constant">MASK_READ</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSkippable</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">,</span> <span class="token string">&quot;write&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                            <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mask <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token constant">MASK_WRITE</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSkippable</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">,</span> <span class="token string">&quot;flush&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mask <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token constant">MASK_FLUSH</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSkippable</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">,</span> <span class="token string">&quot;exceptionCaught&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Throwable</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mask <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token constant">MASK_EXCEPTION_CAUGHT</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Should never reach here.</span>
        <span class="token class-name">PlatformDependent</span><span class="token punctuation">.</span><span class="token function">throwException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//шобчоЧхЗ║чЪДцОйчаБщЬАшжБч╝УхнШя╝МхЫаф╕║цпПцмбхРСpipelineф╕нц╖╗хКашпеч▒╗хЮЛчЪДhandlerчЪДцЧ╢хАЩщГ╜щЬАшжБшО╖хПЦцОйчаБя╝ИхИЫх╗║ф╕Аф╕кchannel х░▒щЬАшжБф╕║хЕ╢хИЭхзЛхМЦpipelineя╝Й</span>
    <span class="token keyword">return</span> mask<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>шобчоЧ ChannelHandler чЪДцЙзшбМцОйчаБ mask0 цЦ╣ц│ХшЩ╜чД╢цпФш╛ГщХ┐я╝Мф╜ЖцШпщА╗ш╛СхН┤хНБхИЖчоАхНХуАВхЬицЬмцЦЗчЪДчммф╕Йх░ПшКВуАК3. pipeline ф╕нчЪДф║Лф╗╢хИЖч▒╗уАЛф╕ня╝МчмФшАЕф╕║хдзхо╢шпжч╗Жф╗Лч╗Нф║ЖхРДчзНф║Лф╗╢ч▒╗хЮЛчЪДцОйчаБшбичд║я╝Мш┐ЩщЗМцИСцЭечЬЛф╕ЛхжВф╜ХхИйчФиш┐Щф║ЫхЯ║цЬмф║Лф╗╢цОйчаБцЭешобчоЧхЗ║ ChannelHandler чЪДцЙзшбМцОйчаБчЪДуАВ</p> <p>хжВцЮЬ ChannelHandler цШп ChannelInboundHandler ч▒╗хЮЛчЪДя╝МщВгф╣ИщжЦхЕИф╝Ъх░ЖцЙАцЬЙ Inbound ф║Лф╗╢цОйчаБшо╛ч╜ош┐ЫцЙзшбМцОйчаБ mask ф╕нуАВ</p> <p>цЬАхРОцМиф╕кщБНхОЖцЙАцЬЙ Inbound ф║Лф╗╢я╝Мф╗ОцОйчаБщЫЖхРИ mask ф╕нцОТщЩдшпе ChannelHandler ф╕НцДЯхЕ┤ш╢гчЪДф║Лф╗╢уАВш┐Щца╖ф╕Аш╜оф╕ЛцЭея╝Мх░▒х╛ЧхИ░ф║Ж ChannelHandler чЪДцЙзшбМцОйчаБуАВ</p> <blockquote><p>ф╗Ош┐Щф╕кш┐ЗчиЛф╕нцИСф╗мхПпф╗ечЬЛхИ░я╝МChannelHandler чЪДцЙзшбМцОйчаБхМЕхРлчЪДцШпшпе ChannelHandler цДЯхЕ┤ш╢гчЪДф║Лф╗╢цОйчаБщЫЖхРИуАВх╜Уф║Лф╗╢хЬи pipeline ф╕нф╝ацТнчЪДцЧ╢хАЩя╝МхЬи ChannelHandlerContext ф╕нхПпф╗ехИйчФиш┐Щф╕кцЙзшбМцОйчаБцЭехИдцЦня╝Мх╜УхЙН ChannelHandler цШпхРжчмжхРИхУНх║Фшпеф║Лф╗╢чЪДш╡Дца╝уАВ</p></blockquote> <p>хРМчРЖцИСф╗мф╣ЯхПпф╗ешобчоЧхЗ║ ChannelOutboundHandler ч▒╗хЮЛчЪД ChannelHandler хп╣х║ФчЪДцЙзшбМцОйчаБуАВ</p> <p><strong>щВгф╣И netty цбЖцЮ╢цШпхжВф╜ХхИдцЦнхЗ║цИСф╗мшЗкхоЪф╣ЙчЪД ChannelHandler хп╣хУкф║Ыф║Лф╗╢цДЯхЕ┤ш╢гя╝Мхп╣хУкф║Ыф║Лф╗╢ф╕НцДЯхЕ┤ш╢гчЪДхСв</strong>?</p> <p>ш┐ЩщЗМцИСф╗мф╗е ChannelInboundHandler ч▒╗хЮЛф╕╛ф╛Лшп┤цШОя╝МхЬицЬмцЦЗчммф╕Йх░ПшКВф╕ня╝МчмФшАЕхп╣цЙАцЬЙ Inbound ч▒╗хЮЛчЪДф║Лф╗╢ф╜Ьф║Жф╕Аф╕кхЕищЭвчЪДф╗Лч╗Ня╝Мф╜ЖцШпхЬихоЮщЩЕх╝АхПСф╕ня╝МцИСф╗мхПпшГ╜х╣╢ф╕НщЬАшжБчЫСхРмцЙАцЬЙчЪД Inbound ф║Лф╗╢я╝МхПпшГ╜хПкцШпщЬАшжБчЫСхРмхЕ╢ф╕нчЪДф╕АхИ░ф╕дф╕кф║Лф╗╢уАВ</p> <p>хп╣ф║ОцИСф╗мф╕НцДЯхЕ┤ш╢гчЪДф║Лф╗╢я╝МцИСф╗мхПкщЬАшжБхЬихЕ╢хп╣х║ФчЪДхЫЮш░ГцЦ╣ц│Хф╕КцаЗц│и @Skip ц│ишзгхН│хПпя╝Мnetty х░▒ф╝Ъшодф╕║шпе ChannelHandler хп╣цаЗц│и @Skip ц│ишзгчЪДф║Лф╗╢ф╕НцДЯхЕ┤ш╢гя╝Мх╜Уф╕НцДЯхЕ┤ш╢гчЪДф║Лф╗╢хЬи pipeline ф╝ацТнчЪДцЧ╢хАЩя╝Мшпе ChannelHandler х░▒ф╕НщЬАшжБцЙзшбМхУНх║ФуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isSkippable</span><span class="token punctuation">(</span>
    <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> handlerType<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> methodName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> paramTypes<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedExceptionAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token class-name">Method</span> m<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// щжЦхЕИцЯечЬЛч▒╗ф╕нцШпхРжшжЖчЫЦхоЮчО░ф║Жхп╣х║ФчЪДф║Лф╗╢хЫЮш░ГцЦ╣ц│Х</span>
                m <span class="token operator">=</span> handlerType<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span> paramTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>
                        <span class="token string">&quot;Class {} missing method {}, assume we can not skip execution&quot;</span><span class="token punctuation">,</span> handlerType<span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> m <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> m<span class="token punctuation">.</span><span class="token function">isAnnotationPresent</span><span class="token punctuation">(</span><span class="token class-name">Skip</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>щВгцИСф╗мхЬич╝ЦхЖЩшЗкхоЪф╣Й ChannelHandler чЪДцЧ╢хАЩцШпф╕НцШпшжБхЬи ChannelInboundHandler цИЦшАЕ ChannelOutboundHandler цОехПгцПРф╛ЫчЪДцЙАцЬЙф║Лф╗╢хЫЮш░ГцЦ╣ц│Хф╕Кя╝Мхп╣цИСф╗мф╕НцДЯхЕ┤ш╢гчЪДф║Лф╗╢ч╣БчРРхЬ░ф╕Аф╕АцаЗц│и @Skip ц│ишзгхСвя╝Я</p> <p>хЕ╢хоЮцШпф╕НщЬАшжБчЪДя╝Мnetty ф╕║цИСф╗мцПРф╛Ыф║Ж ChannelInboundHandlerAdapter ч▒╗хТМ ChannelOutboundHandlerAdapter ч▒╗я╝Мnetty ф║ЛхЕИх╖▓ч╗ПхЬиш┐Щф║Ы Adapter ч▒╗ф╕нчЪДф║Лф╗╢хЫЮш░ГцЦ╣ц│Хф╕КхЕищГицаЗц│иф║Ж @Skip ц│ишзгя╝МцИСф╗мхЬишЗкхоЪф╣ЙхоЮчО░ ChannelHandler чЪДцЧ╢хАЩхПкщЬАшжБч╗зцЙ┐ш┐Щф║Ы Adapter ч▒╗х╣╢шжЖчЫЦцИСф╗мцДЯхЕ┤ш╢гчЪДф║Лф╗╢хЫЮш░ГцЦ╣ц│ХхН│хПпуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelHandlerAdapter</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelInboundHandler</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Skip</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRegistered</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">fireChannelRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Skip</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelUnregistered</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">fireChannelUnregistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Skip</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelActive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">fireChannelActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Skip</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelInactive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">fireChannelInactive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Skip</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">fireChannelRead</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Skip</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelReadComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">fireChannelReadComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Skip</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">userEventTriggered</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> evt<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">fireUserEventTriggered</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Skip</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelWritabilityChanged</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">fireChannelWritabilityChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Skip</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;deprecation&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exceptionCaught</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">fireExceptionCaught</span><span class="token punctuation">(</span>cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_6-ф╗О-pipeline-хИащЩд-channelhandler"><a href="#_6-ф╗О-pipeline-хИащЩд-channelhandler" class="header-anchor">#</a> 6. ф╗О pipeline хИащЩд channelHandler</h2> <p>ф╗Оф╕Кф╕кх░ПшКВчЪДхЖЕхо╣ф╕нцИСф╗мхПпф╗ечЬЛхИ░хРС pipeline ф╕нц╖╗хКа ChannelHandler чЪДщА╗ш╛Сш┐ШцШпцпФш╛ГхдНцЭВчЪДя╝Мц╢ЙхПКхИ░чЪДч╗ЖшКВцпФш╛ГхдЪуАВ</p> <p>щВгф╣ИхЬиф║Жшзгф║ЖхРС pipeline ф╕нц╖╗хКа ChannelHandler чЪДш┐ЗчиЛф╣ЛхРОя╝Мф╗О pipeline ф╕нхИащЩд ChannelHandler чЪДщА╗ш╛Сх░▒хПШх╛Чх╛Ихе╜чРЖшзгф║ЖуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ChannelPipeline</span>
        <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundInvoker</span><span class="token punctuation">,</span> <span class="token class-name">ChannelOutboundInvoker</span><span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token comment">//ф╗Оpipelineф╕нхИащЩдцМЗхоЪчЪДchannelHandler</span>
    <span class="token class-name">ChannelPipeline</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//ф╗Оpipelineф╕нхИащЩдцМЗхоЪхРНчз░чЪДchannelHandler</span>
    <span class="token class-name">ChannelHandler</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//ф╗Оpipelineф╕нхИащЩдчЙ╣хоЪч▒╗хЮЛчЪДchannelHandler</span>
    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelHandler</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> handlerType<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>netty цПРф╛Ыф║Жф╗еф╕Кф╕ЙчзНцЦ╣х╝Пф╗О pipeline ф╕нхИащЩдцМЗхоЪ ChannelHandler я╝Мф╕ЛщЭвцИСф╗мф╗ечммф╕АчзНцЦ╣х╝Пф╕║ф╛ЛцЭеф╗Лч╗Н ChannelHandler чЪДхИащЩдш┐ЗчиЛуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultChannelPipeline</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelPipeline</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">remove</span><span class="token punctuation">(</span><span class="token function">getContextOrDie</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="_6-1-getcontextordie"><a href="#_6-1-getcontextordie" class="header-anchor">#</a> 6.1 getContextOrDie</h3> <p>щжЦхЕИщЬАшжБщАЪш┐З getContextOrDie цЦ╣ц│ХхЬи pipeline ф╕нцЯецЙ╛хИ░цМЗхоЪчЪД ChannelHandler хп╣х║ФчЪД ChannelHandelrContext уАВф╗еф╛┐чбошодшжБхИащЩдчЪД ChannelHandler чбохоЮцШпхнШхЬиф║О pipeline ф╕нуАВ</p> <p>context цЦ╣ц│ХцШпщАЪш┐ЗщБНхОЖ pipeline ф╕нчЪДхПМхРСщУ╛шбицЭецЯецЙ╛шжБхИащЩдчЪД ChannelHandlerContext уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">AbstractChannelHandlerContext</span> <span class="token function">getContextOrDie</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AbstractChannelHandlerContext</span> ctx <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AbstractChannelHandlerContext</span><span class="token punctuation">)</span> <span class="token function">context</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span>handler<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> ctx<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelHandlerContext</span> <span class="token function">context</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> <span class="token string">&quot;handler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// шО╖хПЦ pipeline хПМхРСщУ╛шбич╗УцЮДчЪДхд┤ч╗УчВ╣</span>
    <span class="token class-name">AbstractChannelHandlerContext</span> ctx <span class="token operator">=</span> head<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> ctx<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        ctx <span class="token operator">=</span> ctx<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_6-2-remove"><a href="#_6-2-remove" class="header-anchor">#</a> 6.2 remove</h3> <p>remove цЦ╣ц│ХчЪДцХ┤ф╜Уф╗гчаБч╗УцЮДхТМ addLast0 цЦ╣ц│ХчЪДф╗гчаБч╗УцЮДф╕Аца╖я╝МцХ┤ф╜УщА╗ш╛Сф╣ЯцШпхЕИф╗О pipeline ф╕нчЪДхПМхРСщУ╛шбич╗УцЮДф╕нх░ЖцМЗхоЪчЪД ChanneHandlerContext хИащЩдя╝МчД╢хРОхЬихдДчРЖшвлхИащЩдчЪД ChannelHandler ф╕н handlerRemoved цЦ╣ц│ХчЪДхЫЮш░ГуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">AbstractChannelHandlerContext</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">AbstractChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span> ctx <span class="token operator">!=</span> head <span class="token operator">&amp;&amp;</span> ctx <span class="token operator">!=</span> tail<span class="token punctuation">;</span>

    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//ф╗ОpipelineчЪДхПМхРСхИЧшбиф╕нхИащЩдцМЗхоЪchannelHandlerхп╣х║ФчЪДcontext</span>
        <span class="token function">atomicRemoveFromHandlerList</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>registered<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//хжВцЮЬцндцЧ╢channelш┐ШцЬкхРСreactorц│ихЖМя╝МхИЩщАЪш┐ЗхРСpipelineф╕нц╖╗хКаPendingHandlerRemovedTaskф╗╗хКб</span>
            <span class="token comment">//хЬиц│ихЖМф╣ЛхРОхЫЮш░ГchannelHandelrф╕нчЪДhandlerRemovedцЦ╣ц│Х</span>
            <span class="token function">callHandlerCallbackLater</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ctx<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//channelHandelrф╗Оpipelineф╕нхИащЩдхРОя╝МщЬАшжБхЫЮш░ГхЕ╢handlerRemovedцЦ╣ц│Х</span>
        <span class="token comment">//щЬАшжБчбоф┐ЭhandlerRemovedцЦ╣ц│ХхЬиchannelHandelrцМЗхоЪчЪДexecutorф╕нш┐ЫшбМ</span>
        <span class="token class-name">EventExecutor</span> executor <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>executor<span class="token punctuation">.</span><span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">callHandlerRemoved0</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ctx<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">callHandlerRemoved0</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ctx<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>ф╗О pipeline ф╕нхИащЩдцМЗхоЪ ChannelHandler хп╣х║ФчЪД ChannelHandlerContext уАВщА╗ш╛СцпФш╛ГчоАхНХя╝Мх░▒цШпцЩощАЪхПМхРСщУ╛шбичЪДхИащЩдцУНф╜ЬуАВ</li></ol> <div class="language- extra-class"><pre class="language-text"><code>    private synchronized void atomicRemoveFromHandlerList(AbstractChannelHandlerContext ctx) {
        AbstractChannelHandlerContext prev = ctx.prev;
        AbstractChannelHandlerContext next = ctx.next;
        prev.next = next;
        next.prev = prev;
    }
</code></pre></div><ol start="2"><li>хжВцЮЬцндцЧ╢ channel х╣╢цЬкхРСхп╣х║ФчЪД reactor ш┐ЫшбМц│ихЖМя╝МхИЩщЬАшжБхРС pipeline чЪДф╗╗хКбхИЧшбиф╕нц╖╗хКа PendingHandlerRemovedTask ф╗╗хКбя╝МхЖНшпеф╗╗хКбф╕нф╝ЪцЙзшбМ ChannelHandler чЪД handlerRemoved хЫЮш░Гя╝Мх╜У channel хРС reactor ц│ихЖМцИРхКЯхРОя╝Мreactor ф╝ЪцЙзшбМ pipeline ф╕нф╗╗хКбхИЧшбиф╕нчЪДф╗╗хКбя╝Мф╗ОшАМхЫЮш░ГшвлхИащЩд ChannelHandler чЪД handlerRemoved цЦ╣ц│ХуАВ</li></ol> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192246499.webp" alt="хЫ╛чЙЗ"></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">PendingHandlerRemovedTask</span> <span class="token keyword">extends</span> <span class="token class-name">PendingHandlerCallback</span> <span class="token punctuation">{</span>

    <span class="token class-name">PendingHandlerRemovedTask</span><span class="token punctuation">(</span><span class="token class-name">AbstractChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">callHandlerRemoved0</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хЬицЙзшбМ ChannelHandler ф╕н handlerRemoved хЫЮш░ГчЪДцЧ╢хАЩя╝МщЬАшжБхп╣ ChannelHandler чЪДчК╢цАБш┐ЫшбМхИдцЦня╝ЪхПкцЬЙх╜У handlerState ф╕║ ADD_COMPLETE чЪДцЧ╢хАЩцЙНшГ╜хЫЮш░Г handlerRemoved цЦ╣ц│ХуАВ</p> <blockquote><p>ш┐ЩщЗМшбиш╛╛чЪДшпнф╣ЙцШпхПкцЬЙх╜У ChannelHanler чЪД handlerAdded цЦ╣ц│ХшвлхЫЮш░Гф╣ЛхРОя╝МщВгф╣ИхЬи ChannelHanler швлф╗О pipeline ф╕нхИащЩдчЪДцЧ╢хАЩхоГчЪД handlerRemoved цЦ╣ц│ХцЙНхПпф╗ешвлхЫЮш░ГуАВ</p></blockquote> <p>хЬи ChannelHandler чЪД handlerRemove цЦ╣ц│ХшвлхЫЮш░Гф╣ЛхРОя╝Мх░Ж ChannelHandler чЪДчК╢цАБшо╛ч╜оф╕║ REMOVE_COMPLETE уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">callHandlerRemoved0</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">AbstractChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// хЬиш┐ЩщЗМхЫЮш░Г handlerRemoved цЦ╣ц│Х</span>
        ctx<span class="token punctuation">.</span><span class="token function">callHandlerRemoved</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fireExceptionCaught</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelPipelineException</span><span class="token punctuation">(</span>
            ctx<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.handlerRemoved() has thrown an exception.&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">callHandlerRemoved</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>handlerState <span class="token operator">==</span> <span class="token constant">ADD_COMPLETE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handlerRemoved</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// Mark the handler as removed in any case.</span>
        <span class="token function">setRemoved</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">setRemoved</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    handlerState <span class="token operator">=</span> <span class="token constant">REMOVE_COMPLETE</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>хжВцЮЬ channel х╖▓ч╗ПхЬи reactor ф╕нц│ихЖМцИРхКЯя╝МщВгф╣Их╜У channelHandler ф╗О pipeline ф╕нхИащЩдф╣ЛхРОя╝МщЬАшжБчлЛхН│хЫЮш░ГхЕ╢ handlerRemoved цЦ╣ц│ХуАВф╜ЖцШпщЬАшжБчбоф┐Э handlerRemoved цЦ╣ц│ХхЬи channelHandler цМЗхоЪчЪД executor ф╕нш┐ЫшбМуАВ</li></ol> <h2 id="_7-pipeline-чЪДхИЭхзЛхМЦ"><a href="#_7-pipeline-чЪДхИЭхзЛхМЦ" class="header-anchor">#</a> 7. pipeline чЪДхИЭхзЛхМЦ</h2> <p>хЕ╢хоЮхЕ│ф║О pipeline хИЭхзЛхМЦчЪДчЫ╕хЕ│хЖЕхо╣цИСф╗мхЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484005&amp;idx=1&amp;sn=52f51269902a58f40d33208421109bc3&amp;chksm=ce77c422f9004d340e5b385ef6ba24dfba1f802076ace80ad6390e934173a10401e64e13eaeb&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">уАКшпжч╗ЖхЫ╛шзг Netty Reactor хРпхКихЕиц╡БчиЛуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕нх╖▓ч╗ПчоАшжБф╗Лч╗Нф║Ж NioServerSocketChannel ф╕нчЪД pipeline чЪДхИЭхзЛхМЦцЧ╢цЬ║ф╗ехПКш┐ЗчиЛуАВ</p> <p>хЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484184&amp;idx=1&amp;sn=726877ce28cf6e5d2ac3225fae687f19&amp;chksm=ce77c55ff9004c493b592288819dc4d4664b5949ee97fed977b6558bc517dad0e1f73fab0f46&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">уАКNetty хжВф╜ХщлШцХИцОецФ╢ч╜Сч╗Ьш┐ЮцОеуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕нчмФшАЕф╣ЯчоАшжБф╗Лч╗Нф║Ж NioSocketChannel ф╕н pipeline чЪДхИЭхзЛхМЦцЧ╢цЬ║ф╗ехПКш┐ЗчиЛуАВ</p> <p>цЬмх░ПшКВчмФшАЕх░Жч╗УхРИш┐Щф╕дчзНч▒╗хЮЛчЪД Channel цЭехоМцХ┤хЕищЭвчЪДф╗Лч╗Н pipeline чЪДцХ┤ф╕кхИЭхзЛхМЦш┐ЗчиЛуАВ</p> <h3 id="_7-1-nioserversocketchannel-ф╕н-pipeline-чЪДхИЭхзЛхМЦ"><a href="#_7-1-nioserversocketchannel-ф╕н-pipeline-чЪДхИЭхзЛхМЦ" class="header-anchor">#</a> 7.1 NioServerSocketChannel ф╕н pipeline чЪДхИЭхзЛхМЦ</h3> <p>ф╗ОхЙНш╛╣цПРхИ░чЪДш┐Щф╕дчпЗцЦЗчлаф╗ехПКцЬмцЦЗхЙНш╛╣чЪДчЫ╕хЕ│хЖЕхо╣цИСф╗мчЯещБУя╝МNetty цПРф╛Ыф║Жф╕Аф╕кчЙ╣цоКчЪД ChannelInboundHandler хПлхБЪ ChannelInitializer я╝МчФицИ╖хПпф╗ехИйчФиш┐Щф╕кчЙ╣цоКчЪД ChannelHandler хп╣ Channel ф╕нчЪД pipeline ш┐ЫшбМшЗкхоЪф╣ЙчЪДхИЭхзЛхМЦщА╗ш╛СуАВ</p> <p>хжВцЮЬчФицИ╖хПкх╕МцЬЫхЬи pipeline ф╕нц╖╗хКаф╕Аф╕кхЫ║хоЪчЪД ChannelHandler хПпф╗ещАЪш┐ЗхжВф╕Лф╗гчаБчЫ┤цОец╖╗хКауАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span><span class="token comment">//щЕНч╜оф╕╗ф╗ОReactor</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoggingHandler</span><span class="token punctuation">(</span><span class="token class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">INFO</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>хжВцЮЬх╕МцЬЫц╖╗хКахдЪф╕к ChannelHandler я╝МхИЩхПпф╗ещАЪш┐З ChannelInitializer цЭешЗкхоЪф╣Йц╖╗хКащА╗ш╛СуАВ</p> <blockquote><p>чФ▒ф║Оф╜┐чФи ChannelInitializer хИЭхзЛхМЦ NioServerSocketChannel ф╕н pipeline чЪДщА╗ш╛Сф╝ЪчиНх╛охдНцЭВф╕АчВ╣я╝Мф╕ЛщЭвцИСф╗мхЭЗф╗еш┐Щф╕кхдНцЭВчЪДцбИф╛ЛцЭешо▓ш┐░ pipeline чЪДхИЭхзЛхМЦш┐ЗчиЛуАВ</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span><span class="token comment">//щЕНч╜оф╕╗ф╗ОReactor</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>шЗкхоЪф╣ЙpipelineхИЭхзЛхМЦщА╗ш╛С<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>channelHandler1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>channelHandler2<span class="token punctuation">)</span><span class="token punctuation">;</span>
            p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>channelHandler3<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>ф╗еф╕Кш┐Щф║ЫчФ▒чФицИ╖шЗкхоЪф╣ЙчЪДчФиф║ОхИЭхзЛхМЦ pipeline чЪД ChannelInitializer я╝Мшвлф┐ЭхнШшЗ│ ServerBootstrap хРпхКич▒╗ф╕нчЪД handler хнЧцо╡ф╕нуАВчФиф║ОхРОч╗нчЪДхИЭхзЛхМЦш░ГчФи</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractBootstrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractBootstrap</span><span class="token punctuation">&lt;</span><span class="token class-name">B</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">C</span> <span class="token keyword">extends</span> <span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Cloneable</span>
   <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хЬицЬНхКбчлпхРпхКичЪДцЧ╢хАЩя╝Мф╝Ъф╝┤щЪПчЭА NioServeSocketChannel чЪДхИЫх╗║ф╗ехПКхИЭхзЛхМЦя╝МхЬихИЭхзЛхМЦ NioServerSokcetChannel чЪДцЧ╢хАЩф╝Ъх░Жф╕Аф╕кцЦ░чЪД ChannelInitializer ц╖╗хКаш┐Ы pipeline ф╕ня╝МхЬицЦ░чЪД ChannelInitializer ф╕нцЙНф╝Ъх░ЖчФицИ╖шЗкхоЪф╣ЙчЪД ChannelInitializer ц╖╗хКаш┐Ы pipeline ф╕ня╝МщЪПхРОцЙНцЙзшбМхИЭхзЛхМЦш┐ЗчиЛуАВ</p> <p>Netty ш┐ЩщЗМф╣ЛцЙАф╗ех╝ХхЕеф╕Аф╕кцЦ░чЪД ChannelInitializer цЭехИЭхзЛхМЦ NioServerSocketChannel ф╕нчЪД pipeline чЪДхОЯхЫацШпщЬАшжБхЕ╝хо╣хЙНш╛╣ф╗Лч╗НчЪДш┐Щф╕дчзНхИЭхзЛхМЦ pipeline чЪДцЦ╣х╝ПуАВ</p> <ul><li>ф╕АчзНцШпчЫ┤цОеф╜┐чФиф╕Аф╕кхЕ╖ф╜УчЪД ChannelHandler цЭехИЭхзЛхМЦ pipelineуАВ</li> <li>хПжф╕АчзНцШпф╜┐чФи ChannelInitializer цЭешЗкхоЪф╣ЙхИЭхзЛхМЦ pipeline щА╗ш╛СуАВ</li></ul> <blockquote><p>х┐Шшо░ netty хРпхКиш┐ЗчиЛчЪДхРМхнжхПпф╗ехЬихЫЮчЬЛф╕ЛчмФшАЕчЪД<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484005&amp;idx=1&amp;sn=52f51269902a58f40d33208421109bc3&amp;chksm=ce77c422f9004d340e5b385ef6ba24dfba1f802076ace80ad6390e934173a10401e64e13eaeb&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">уАКшпжч╗ЖхЫ╛шзг Netty Reactor хРпхКихЕиц╡БчиЛуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ш┐ЩчпЗцЦЗчлауАВ</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code>   <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Channel</span> ch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//ServerBootstrapф╕нчФицИ╖цМЗхоЪчЪДchannelHandler</span>
                <span class="token class-name">ChannelHandler</span> handler <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
</code></pre></div><p><strong>ц│ицДПцндцЧ╢ NioServerSocketChannel х╣╢цЬкх╝АхзЛхРС Main Reactor ц│ихЖМ</strong>я╝Мца╣цНоцЬмцЦЗчммхЫЫх░ПшКВуАК4. хРС pipeline ц╖╗хКа channelHandler уАЛф╕нчЪДф╗Лч╗Ня╝МцндцЧ╢хРС pipeline ф╕нц╖╗хКаш┐Щф╕кцЦ░чЪД ChannelInitializer ф╣ЛхРОя╝Мnetty ф╝ЪхРС pipeline чЪДф╗╗хКбхИЧшбиф╕нц╖╗хКа PendingHandlerAddedTask уАВх╜У NioServerSocketChannel хРС Main Reactor ц│ихЖМцИРхКЯф╣ЛхРОя╝Мч┤зцОечЭА Main Reactor ч║┐чиЛф╝Ъш░ГчФиш┐Щф╕к PendingHandlerAddedTask я╝МхЬиф╗╗хКбф╕нф╝ЪцЙзшбМш┐Щф╕кцЦ░чЪД ChannelInitializer чЪД handlerAdded хЫЮш░ГуАВхЬиш┐Щф╕кхЫЮш░ГцЦ╣ц│Хф╕нф╝ЪцЙзшбМф╕Кш╛╣ initChannel цЦ╣ц│ХщЗМчЪДф╗гчаБуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192248265.webp" alt="хЫ╛чЙЗ"></p> <p>х╜У NioServerSocketChannel хЬихРС Main Reactor ц│ихЖМцИРхКЯф╣ЛхРОя╝Мх░▒цМиф╕кцЙзшбМ pipeline ф╕нчЪДф╗╗хКбхИЧшбиф╕нчЪДф╗╗хКбуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code>       <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">register0</span><span class="token punctuation">(</span><span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">boolean</span> firstRegistration <span class="token operator">=</span> neverRegistered<span class="token punctuation">;</span>
                <span class="token comment">//цЙзшбМчЬЯцнгчЪДц│ихЖМцУНф╜Ь</span>
                <span class="token function">doRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//ф┐оцФ╣ц│ихЖМчК╢цАБ</span>
                neverRegistered <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                registered <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token comment">//ш░ГчФиpipelineф╕нчЪДф╗╗хКбщУ╛шбия╝МцЙзшбМPendingHandlerAddedTask</span>
                pipeline<span class="token punctuation">.</span><span class="token function">invokeHandlerAddedIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">invokeHandlerAddedIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">assert</span> channel<span class="token punctuation">.</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>firstRegistration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            firstRegistration <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment">// цЙзшбМ pipeline ф╗╗хКбхИЧшбиф╕нчЪД PendingHandlerAddedTask ф╗╗хКбуАВ</span>
            <span class="token function">callHandlerAddedForAllHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>цЙзшбМ pipeline ф╗╗хКбхИЧшбиф╕нчЪД PendingHandlerAddedTask ф╗╗хКбя╝Ъ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">callHandlerAddedForAllHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// pipeline ф╗╗хКбхИЧшбиф╕нчЪДхд┤ч╗УчВ╣</span>
    <span class="token keyword">final</span> <span class="token class-name">PendingHandlerCallback</span> pendingHandlerCallbackHead<span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">assert</span> <span class="token operator">!</span>registered<span class="token punctuation">;</span>
        <span class="token comment">// This Channel itself was registered.</span>
        registered <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        pendingHandlerCallbackHead <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pendingHandlerCallbackHead<span class="token punctuation">;</span>
        <span class="token comment">// Null out so it can be GC'ed.</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pendingHandlerCallbackHead <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">PendingHandlerCallback</span> task <span class="token operator">=</span> pendingHandlerCallbackHead<span class="token punctuation">;</span>
    <span class="token comment">// цМиф╕кцЙзшбМф╗╗хКбхИЧшбиф╕нчЪДф╗╗хКб</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//шзжхПС ChannelInitializer чЪД handlerAdded хЫЮш░Г</span>
        task<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        task <span class="token operator">=</span> task<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цЬАч╗ИхЬи PendingHandlerAddedTask ф╕нцЙзшбМ pipeline ф╕н ChannelInitializer чЪД handlerAdded хЫЮш░ГуАВ</p> <blockquote><p>ш┐Щф╕к ChannelInitializer х░▒цШпхЬихИЭхзЛхМЦ NioServerSocketChannel чЪД init цЦ╣ц│Хф╕нхРС pipeline ц╖╗хКачЪД ChannelInitializerуАВ</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Sharable</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span> <span class="token keyword">extends</span> <span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handlerAdded</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">initChannel</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//хИЭхзЛхМЦх╖еф╜ЬхоМцИРхРОя╝МщЬАшжБх░ЖшЗкш║лф╗Оpipelineф╕нчз╗щЩд</span>
                <span class="token function">removeState</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>хЬи handelrAdded хЫЮш░Гф╕нцЙзшбМ ChannelInitializer хМ┐хРНч▒╗ф╕н initChannel цЦ╣ц│Хя╝М<strong>ц│ицДПцндцЧ╢цЙзшбМчЪД ChannelInitializer ч▒╗ф╕║хЬицЬмх░ПшКВх╝Ахд┤ init цЦ╣ц│Хф╕нчФ▒ Netty цбЖцЮ╢ц╖╗хКачЪД ChannelInitializer я╝Мх╣╢ф╕НцШпчФицИ╖шЗкхоЪф╣ЙчЪД ChannelInitializer уАВ</strong></p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Channel</span> ch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//ServerBootstrapф╕нчФицИ╖цМЗхоЪчЪДChannelInitializer</span>
                <span class="token class-name">ChannelHandler</span> handler <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
</code></pre></div><p>цЙзшбМхоМ ChannelInitializer хМ┐хРНч▒╗ф╕н initChannel цЦ╣ц│ХхРОя╝МщЬАх░Ж ChannelInitializer ф╗О pipeline ф╕нхИащЩдуАВх╣╢хЫЮш░Г ChannelInitializer чЪД handlerRemoved цЦ╣ц│ХуАВхИащЩдш┐ЗчиЛчмФшАЕх╖▓ч╗ПхЬичммхЕнх░ПшКВуАК6. ф╗О pipeline хИащЩд channelHandlerуАЛшпжч╗Жф╗Лч╗Нш┐Зф║ЖуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>initMap<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Guard against re-entrance.</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//цЙзшбМChannelInitializerхМ┐хРНч▒╗ф╕нчЪДinitChannelцЦ╣ц│Х</span>
                <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">C</span><span class="token punctuation">)</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">exceptionCaught</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pipeline<span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//хИЭхзЛхМЦхоМцпХхРОя╝Мф╗Оpipelineф╕нчз╗щЩдшЗкш║л</span>
                    pipeline<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>х╜УцЙзшбМхоМ initChannel цЦ╣ц│ХхРОцндцЧ╢ pipeline чЪДч╗УцЮДхжВф╕ЛхЫ╛цЙАчд║я╝Ъ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191115923.webp" alt="хЫ╛чЙЗ"></p> <p>х╜УчФицИ╖чЪДшЗкхоЪф╣Й ChannelInitializer швлц╖╗хКаш┐Ы pipeline ф╣ЛхРОя╝Мца╣цНочммхЫЫх░ПшКВцЙАшо▓чЪДц╖╗хКащА╗ш╛Ся╝МцндцЧ╢ NioServerSocketChannel х╖▓ч╗ПхРС main reactor цИРхКЯц│ихЖМхоМцпХя╝Мф╕НхЖНщЬАшжБхРС pipeine чЪДф╗╗хКбхИЧшбиф╕нц╖╗хКа PendingHandlerAddedTask ф╗╗хКбя╝МшАМцШпчЫ┤цОеш░ГчФишЗкхоЪф╣Й ChannelInitializer ф╕нчЪД handlerAdded хЫЮш░Гя╝МхТМф╕КщЭвчЪДщА╗ш╛Сф╕Аца╖уАВф╕НхРМчЪДцШпш┐ЩщЗМцЬАч╗ИхЫЮш░ГшЗ│чФицИ╖шЗкхоЪф╣ЙчЪДхИЭхзЛхМЦщА╗ш╛СхоЮчО░ initChannel цЦ╣ц│Хф╕нуАВцЙзшбМхоМчФицИ╖шЗкхоЪф╣ЙчЪДхИЭхзЛхМЦщА╗ш╛Сф╣ЛхРОя╝Мф╗О pipeline хИащЩдчФицИ╖шЗкхоЪф╣ЙчЪД ChannelInitializer уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span><span class="token comment">//щЕНч╜оф╕╗ф╗ОReactor</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>шЗкхоЪф╣ЙpipelineхИЭхзЛхМЦщА╗ш╛С<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>channelHandler1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>channelHandler2<span class="token punctuation">)</span><span class="token punctuation">;</span>
            p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>channelHandler3<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>щЪПхРО netty ф╝Ъф╗ех╝Вцнеф╗╗хКбчЪДх╜вх╝ПхРС pipeline чЪДцЬлх░╛ц╖╗хКа ServerBootstrapAcceptor я╝МшЗ│цнд NioServerSocketChannel ф╕н pipeline чЪДхИЭхзЛхМЦх╖еф╜Ьх░▒хЕищГихоМцИРф║ЖуАВ</p> <h3 id="_7-2-niosocketchannel-ф╕н-pipeline-чЪДхИЭхзЛхМЦ"><a href="#_7-2-niosocketchannel-ф╕н-pipeline-чЪДхИЭхзЛхМЦ" class="header-anchor">#</a> 7.2 NioSocketChannel ф╕н pipeline чЪДхИЭхзЛхМЦ</h3> <p>хЬи 7.1 х░ПшКВф╕нчмФшАЕф╕╛чЪДш┐Щф╕к pipeline хИЭхзЛхМЦчЪДф╛ЛхнРчЫ╕хп╣цЭешп┤цпФш╛ГхдНцЭВя╝Мх╜УцИСф╗мцККш┐Щф╕кхдНцЭВф╛ЛхнРчЪДхИЭхзЛхМЦщА╗ш╛СцРЮц╕ЕцеЪф╣ЛхРОя╝МNioSocketChannel ф╕н pipeline чЪДхИЭхзЛхМЦш┐ЗчиЛх░▒хПШчЪДх╛ИчоАхНХф║ЖуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span><span class="token comment">//щЕНч╜оф╕╗ф╗ОReactor</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>шЗкхоЪф╣ЙpipelineхИЭхзЛхМЦщА╗ш╛С<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>channelHandler1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>channelHandler2<span class="token punctuation">)</span><span class="token punctuation">;</span>
            p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>channelHandler3<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServerBootstrap</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractBootstrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerBootstrap</span><span class="token punctuation">,</span> <span class="token class-name">ServerChannel</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token comment">//ф┐ЭхнШчФицИ╖шЗкхоЪф╣ЙChannelInitializer</span>
        <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">ChannelHandler</span> childHandler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>хЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484184&amp;idx=1&amp;sn=726877ce28cf6e5d2ac3225fae687f19&amp;chksm=ce77c55ff9004c493b592288819dc4d4664b5949ee97fed977b6558bc517dad0e1f73fab0f46&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">уАКNetty хжВф╜ХщлШцХИцОецФ╢ч╜Сч╗Ьш┐ЮцОеуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕АцЦЗф╕нцИСф╗мф╗Лч╗Нш┐Зя╝Мх╜УховцИ╖члпхПСш╡╖ш┐ЮцОея╝МхоМцИРф╕ЙцмбцПбцЙЛф╣ЛхРОя╝МNioServerSocketChannel ф╕КчЪД OP_ACCEPT ф║Лф╗╢ц┤╗ш╖Гя╝МщЪПхРОф╝ЪхЬи NioServerSocketChannel чЪД pipeline ф╕ншзжхПС channelRead ф║Лф╗╢уАВх╣╢цЬАч╗ИхЬи ServerBootstrapAcceptor ф╕нхИЭхзЛхМЦховцИ╖члп NioSocketChannel уАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191115136.webp" alt="хЫ╛чЙЗ">ф╕╗ф╗О Reactor ч╗ДхоМцХ┤ч╗УцЮД.png</p> <div class="language- extra-class"><pre class="language-text"><code>private static class ServerBootstrapAcceptor extends ChannelInboundHandlerAdapter {

       @Override
        @SuppressWarnings(&quot;unchecked&quot;)
        public void channelRead(ChannelHandlerContext ctx, Object msg) {
            final Channel child = (Channel) msg;
            child.pipeline().addLast(childHandler);
                    ...........
       }
}
</code></pre></div><p>хЬиш┐ЩщЗМф╝Ъх░ЖчФицИ╖шЗкхоЪф╣ЙчЪД ChannelInitializer ц╖╗хКаш┐Ы NioSocketChannel ф╕нчЪД pipeline ф╕ня╝МчФ▒ф║ОцндцЧ╢ NioSocketChannel ш┐Шц▓бцЬЙхРС sub reactor х╝АхзЛц│ихЖМуАВцЙАф╗ехЬихРС pipeline ф╕нц╖╗хКа ChannelInitializer чЪДхРМцЧ╢ф╝Ъф╝┤щЪПчЭА PendingHandlerAddedTask швлц╖╗хКаш┐Ы pipeline чЪДф╗╗хКбхИЧшбиф╕нуАВ</p> <p>![хЫ╛чЙЗ](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)niosocketchannel ф╕н pipeline чЪДхИЭхзЛхМЦ.png</p> <p>хРОщЭвчЪДц╡БчиЛхдзхо╢х║Фшпех╛ИчЖЯцВЙф║Жя╝МхТМцИСф╗мхЬи 7.1 х░ПшКВф╕нф╗Лч╗НчЪДф╕Ацибф╕Аца╖я╝Мх╜У NioSocketChannel хЖНхРС sub reactor ц│ихЖМцИРхКЯф╣ЛхРОя╝Мф╝ЪцЙзшбМ pipeline ф╕нчЪДф╗╗хКбхИЧшбиф╕нчЪД PendingHandlerAddedTask ф╗╗хКбя╝МхЬи PendingHandlerAddedTask ф╗╗хКбф╕нф╝ЪхЫЮш░ГчФицИ╖шЗкхоЪф╣Й ChannelInitializer чЪД handelrAdded цЦ╣ц│Хя╝МхЬишпецЦ╣ц│Хф╕нцЙзшбМ initChannel цЦ╣ц│Хя╝МчФицИ╖шЗкхоЪф╣ЙчЪДхИЭхзЛхМЦщА╗ш╛Сх░▒х░БшгЕхЬиш┐ЩщЗМщЭвуАВхЬихИЭхзЛхМЦхоМ pipeline хРОя╝Мх░Ж ChannelInitializer ф╗О pipeline ф╕нхИащЩдя╝Мх╣╢хЫЮш░ГхЕ╢ handlerRemoved цЦ╣ц│ХуАВ</p> <p>шЗ│цндховцИ╖члп NioSocketChannel ф╕н pipeline хИЭхзЛхМЦх╖еф╜Ьх░▒хЕищГихоМцИРф║ЖуАВ</p> <h2 id="_8-ф║Лф╗╢ф╝ацТн"><a href="#_8-ф║Лф╗╢ф╝ацТн" class="header-anchor">#</a> 8. ф║Лф╗╢ф╝ацТн</h2> <p>хЬицЬмцЦЗчммф╕Йх░ПшКВуАК3. pipeline ф╕нчЪДф║Лф╗╢хИЖч▒╗уАЛф╕нцИСф╗мф╗Лч╗Нф║Ж Netty ф║Лф╗╢ч▒╗хЮЛхЕ▒хИЖф╕║ф╕Йхдзч▒╗я╝МхИЖхИлцШп Inbound ч▒╗ф║Лф╗╢я╝МOutbound ч▒╗ф║Лф╗╢я╝МExceptionCaught ф║Лф╗╢уАВх╣╢шпжч╗Жф╗Лч╗Нф║Жш┐Щф╕Йч▒╗ф║Лф╗╢чЪДцОйчаБшбичд║я╝МхТМшзжхПСцЧ╢цЬ║я╝Мф╗ехПКф║Лф╗╢ф╝ацТнчЪДцЦ╣хРСуАВ</p> <p>цЬмх░ПшКВцИСф╗мх░▒цЭецМЙчЕз Netty ф╕нх╝Вцнеф║Лф╗╢чЪДхИЖч▒╗ф╗Оц║РчаБшзТх║жхИЖцЮРф╕Лф║Лф╗╢цШпхжВф╜ХхЬи pipeline ф╕нш┐ЫшбМф╝ацТнчЪДуАВ</p> <h3 id="_8-1-inbound-ф║Лф╗╢чЪДф╝ацТн"><a href="#_8-1-inbound-ф║Лф╗╢чЪДф╝ацТн" class="header-anchor">#</a> 8.1 Inbound ф║Лф╗╢чЪДф╝ацТн</h3> <p>хЬичммф╕Йх░ПшКВф╕нцИСф╗мф╗Лч╗Нф║ЖцЙАцЬЙчЪД Inbound ч▒╗ф║Лф╗╢я╝Мш┐Щф║Ыф║Лф╗╢хЬи pipeline ф╕нчЪДф╝ацТнщА╗ш╛СхТМф╝ацТнцЦ╣хРСщГ╜цШпф╕Аца╖чЪДя╝МхФпф╕АчЪДхМ║хИлх░▒цШпцЙзшбМчЪДхЫЮш░ГцЦ╣ц│Хф╕НхРМуАВ</p> <p>цЬмх░ПшКВцИСф╗мх░▒ф╗е ChannelRead ф║Лф╗╢чЪДф╝ацТнф╕║ф╛Ля╝МцЭешп┤цШО Inbound ч▒╗ф║Лф╗╢цШпхжВф╜ХхЬи pipeline ф╕нш┐ЫшбМф╝ацТнчЪДуАВ</p> <p>чммф╕Йх░ПшКВф╕нцИСф╗мцПРхИ░ш┐Зя╝МхЬи NioSocketChannel ф╕ня╝МChannelRead ф║Лф╗╢чЪДшзжхПСцЧ╢цЬ║цШпхЬицпПф╕Ацмб read loop шп╗хПЦцХ░цНоф╣ЛхРОхЬи pipeline ф╕ншзжхПСчЪДуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        allocHandle<span class="token punctuation">.</span><span class="token function">lastBytesRead</span><span class="token punctuation">(</span><span class="token function">doReadBytes</span><span class="token punctuation">(</span>byteBuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment">// хЬиховцИ╖члпNioSocketChannelчЪДpipelineф╕ншзжхПСChannelReadф║Лф╗╢</span>
        pipeline<span class="token punctuation">.</span><span class="token function">fireChannelRead</span><span class="token punctuation">(</span>byteBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>allocHandle<span class="token punctuation">.</span><span class="token function">continueReading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ф╗Ош┐ЩщЗМхПпф╗ечЬЛхИ░я╝Мф╗╗ф╜Х Inbound ч▒╗ф║Лф╗╢хЬи pipeline ф╕нчЪДф╝ацТнш╡╖чВ╣щГ╜цШпф╗О HeadContext хд┤ч╗УчВ╣х╝АхзЛчЪДуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultChannelPipeline</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelPipeline</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">fireChannelRead</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AbstractChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">invokeChannelRead</span><span class="token punctuation">(</span>head<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ChannelRead ф║Лф╗╢ф╗О HeadContext х╝АхзЛхЬи pipeline ф╕нф╝ацТня╝МщжЦхЕИх░▒ф╝ЪхЫЮш░Г HeadContext ф╕нчЪД channelRead цЦ╣ц│ХуАВ</p> <blockquote><p>хЬицЙзшбМ ChannelHandler ф╕нчЪДчЫ╕х║Фф║Лф╗╢хЫЮш░ГцЦ╣ц│ХцЧ╢я╝МщЬАшжБчбоф┐ЭхЫЮш░ГцЦ╣ц│ХчЪДцЙзшбМхЬицМЗхоЪчЪД executor ф╕нш┐ЫшбМуАВ</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">invokeChannelRead</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">AbstractChannelHandlerContext</span> next<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Object</span> m <span class="token operator">=</span> next<span class="token punctuation">.</span>pipeline<span class="token punctuation">.</span><span class="token function">touch</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token string">&quot;msg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">EventExecutor</span> executor <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//щЬАшжБф┐ЭшпБchannelReadф║Лф╗╢хЫЮш░ГхЬиchannelHandlerцМЗхоЪчЪДexecutorф╕нш┐ЫшбМ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>executor<span class="token punctuation">.</span><span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        next<span class="token punctuation">.</span><span class="token function">invokeChannelRead</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                next<span class="token punctuation">.</span><span class="token function">invokeChannelRead</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeChannelRead</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">invokeHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ChannelInboundHandler</span><span class="token punctuation">)</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">invokeExceptionCaught</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">fireChannelRead</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хЬицЙзшбМ HeadContext чЪД channelRead цЦ╣ц│ХхПСчФЯх╝Вх╕╕цЧ╢я╝Мх░▒ф╝ЪхЫЮш░Г HeadContext чЪД exceptionCaught цЦ╣ц│ХуАВх╣╢хЬичЫ╕х║ФчЪДф║Лф╗╢хЫЮш░ГцЦ╣ц│Хф╕нхЖ│хоЪцШпхРжх░Жф║Лф╗╢ч╗зч╗нхЬи pipeline ф╕нф╝ацТнуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HeadContext</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractChannelHandlerContext</span>
    <span class="token keyword">implements</span> <span class="token class-name">ChannelOutboundHandler</span><span class="token punctuation">,</span> <span class="token class-name">ChannelInboundHandler</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">fireChannelRead</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exceptionCaught</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">fireExceptionCaught</span><span class="token punctuation">(</span>cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хЬи HeadContext ф╕нщАЪш┐З ctx.fireChannelRead(msg) ч╗зч╗нх░Ж ChannelRead ф║Лф╗╢хЬи pipeline ф╕нхРСхРОф╝ацТнуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractChannelHandlerContext</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">,</span> <span class="token class-name">ResourceLeakHint</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ChannelHandlerContext</span> <span class="token function">fireChannelRead</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">invokeChannelRead</span><span class="token punctuation">(</span><span class="token function">findContextInbound</span><span class="token punctuation">(</span><span class="token constant">MASK_CHANNEL_READ</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p><strong>ш┐ЩщЗМчЪД findContextInbound цЦ╣ц│ХцШпцХ┤ф╕к inbound ч▒╗ф║Лф╗╢хЬи pipeline ф╕нф╝ацТнчЪДца╕х┐ГцЙАхЬиуАВ</strong></p> <p>хЫаф╕║цИСф╗мчО░хЬищЬАшжБч╗зч╗нх░Ж ChannelRead ф║Лф╗╢хЬи pipeline ф╕нф╝ацТня╝МцЙАф╗ецИСф╗мчЫохЙНчЪДца╕х┐ГщЧощвШх░▒цШпщАЪш┐З findContextInbound цЦ╣ц│ХхЬи pipeline ф╕нцЙ╛хИ░ф╕Лф╕Аф╕кхп╣ ChannelRead ф║Лф╗╢цДЯхЕ┤ш╢гчЪД ChannelInboundHandler уАВчД╢хРОцЙзшбМшпе ChannelInboundHandler чЪД ChannelRead ф║Лф╗╢хЫЮш░ГуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">invokeChannelRead</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">AbstractChannelHandlerContext</span> next<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Object</span> m <span class="token operator">=</span> next<span class="token punctuation">.</span>pipeline<span class="token punctuation">.</span><span class="token function">touch</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token string">&quot;msg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">EventExecutor</span> executor <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//щЬАшжБф┐ЭшпБchannelReadф║Лф╗╢хЫЮш░ГхЬиchannelHandlerцМЗхоЪчЪДexecutorф╕нш┐ЫшбМ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>executor<span class="token punctuation">.</span><span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        next<span class="token punctuation">.</span><span class="token function">invokeChannelRead</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                next<span class="token punctuation">.</span><span class="token function">invokeChannelRead</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ChannelRead ф║Лф╗╢х░▒ш┐Щца╖х╛кчОпх╛АхдНчЪДф╕АчЫ┤хЬи pipeline ф╕нф╝ацТня╝МхЬиф╝ацТнчЪДш┐ЗчиЛф╕нхПкцЬЙхп╣ ChannelRead ф║Лф╗╢цДЯхЕ┤ш╢гчЪД ChannelInboundHandler цЙНхПпф╗ехУНх║ФуАВхЕ╢ф╗Цч▒╗хЮЛчЪД ChannelHandler хИЩчЫ┤цОеш╖│ш┐ЗуАВ</p> <p>хжВцЮЬ ChannelRead ф║Лф╗╢хЬи pipeline ф╕нф╝ацТнчЪДш┐ЗчиЛф╕ня╝Мц▓бцЬЙх╛ЧхИ░хЕ╢ф╗Ц ChannelInboundHandler чЪДцЬЙцХИхдДчРЖя╝МцЬАч╗Иф╝Ъшвлф╝ацТнхИ░ pipeline чЪДцЬлх░╛ TailContext ф╕нуАВшАМхЬицЬмцЦЗчммф║Мх░ПшКВф╕ня╝МцИСф╗мф╣ЯцПРхИ░ш┐З TailContext хп╣ф║О inbound ф║Лф╗╢хнШхЬичЪДцДПф╣Йх░▒цШпхБЪф╕Аф╕кхЕЬх║ХчЪДхдДчРЖуАВцпФхжВя╝ЪцЙУхН░цЧех┐Чя╝МщЗКцФ╛ bytebuffer уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">TailContext</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractChannelHandlerContext</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelInboundHandler</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">onUnhandledInboundMessage</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onUnhandledInboundMessage</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">onUnhandledInboundMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Discarded message pipeline : {}. Channel : {}.&quot;</span><span class="token punctuation">,</span>
                         ctx<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">names</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onUnhandledInboundMessage</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Discarded inbound message {} that reached at the tail of the pipeline. &quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;Please check your pipeline configuration.&quot;</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// щЗКцФ╛DirectByteBuffer</span>
            <span class="token class-name">ReferenceCountUtil</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="_8-2-findcontextinbound"><a href="#_8-2-findcontextinbound" class="header-anchor">#</a> 8.2 findContextInbound</h3> <p>цЬмх░ПшКВшжБф╗Лч╗НчЪД findContextInbound цЦ╣ц│ХхТМцИСф╗мхЬиф╕КчпЗцЦЗчла<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484532&amp;idx=1&amp;sn=c3a8b37a2eb09509d9914494ef108c68&amp;chksm=ce77c233f9004b25a29f9fdfb179e41646092d09bc89df2147a9fab66df13231e46dd6a5c26d&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">уАКф╕АцЦЗшБКщАП Netty хПСщАБцХ░цНохЕиц╡БчиЛуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕нф╗Лч╗НчЪД findContextOutbound цЦ╣ц│ХхЭЗцШп netty х╝Вцнеф║Лф╗╢хЬи pipeline ф╕нф╝ацТнчЪДца╕х┐ГцЙАхЬиуАВ</p> <p>ф║Лф╗╢ф╝ацТнчЪДца╕х┐ГщЧощвШх░▒цШпщЬАшжБщлШцХИчЪДхЬи pipeline ф╕нцМЙчЕзф║Лф╗╢чЪДф╝ацТнцЦ╣хРСя╝МцЙ╛хИ░ф╕Лф╕Аф╕кхЕ╖цЬЙхУНх║Фф║Лф╗╢ш╡Дца╝чЪД ChannelHandler уАВ</p> <p>цпФхжВя╝Ъш┐ЩщЗМцИСф╗мхЬи pipeline ф╕нф╝ацТнчЪД ChannelRead ф║Лф╗╢я╝МцИСф╗мх░▒щЬАшжБхЬи pipeline ф╕нцЙ╛хИ░ф╕Лф╕Аф╕кхп╣ ChannelRead ф║Лф╗╢цДЯхЕ┤ш╢гчЪД ChannelInboundHandler я╝Мх╣╢цЙзшбМшпе ChannelInboudnHandler чЪД ChannelRead ф║Лф╗╢хЫЮш░Гя╝МхЬи ChannelRead ф║Лф╗╢хЫЮш░Гф╕нхп╣ф║Лф╗╢ш┐ЫшбМф╕ЪхКбхдДчРЖя╝Мх╣╢хЖ│хоЪцШпхРжщАЪш┐З ctx.fireChannelRead(msg) х░Ж ChannelRead ф║Лф╗╢ч╗зч╗нхРСхРОф╝ацТнуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">AbstractChannelHandlerContext</span> <span class="token function">findContextInbound</span><span class="token punctuation">(</span><span class="token keyword">int</span> mask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AbstractChannelHandlerContext</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token class-name">EventExecutor</span> currentExecutor <span class="token operator">=</span> <span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        ctx <span class="token operator">=</span> ctx<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">skipContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> currentExecutor<span class="token punctuation">,</span> mask<span class="token punctuation">,</span> <span class="token constant">MASK_ONLY_INBOUND</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> ctx<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хПВцХ░ mask шбичд║цИСф╗мцнгхЬиф╝ацТнчЪД ChannelRead ф║Лф╗╢цОйчаБ MASK_CHANNEL_READ уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_EXCEPTION_CAUGHT</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_CHANNEL_REGISTERED</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_CHANNEL_UNREGISTERED</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_CHANNEL_ACTIVE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_CHANNEL_INACTIVE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_CHANNEL_READ</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_CHANNEL_READ_COMPLETE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_USER_EVENT_TRIGGERED</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_CHANNEL_WRITABILITY_CHANGED</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span>
</code></pre></div><p>щАЪш┐З ctx = ctx.next хЬи pipeline ф╕нцЙ╛хИ░ф╕Лф╕Аф╕к ChannelHandler я╝Мх╣╢щАЪш┐З skipContext цЦ╣ц│ХхИдцЦнф╕Лф╕Аф╕к ChannelHandler цШпхРжхЕ╖цЬЙхУНх║Фф║Лф╗╢чЪДш╡Дца╝уАВхжВцЮЬц▓бцЬЙхИЩш╖│ш┐Зч╗зч╗нхРСхРОцЯецЙ╛уАВ</p> <p>цпФхжВя╝Ъф╕Лф╕Аф╕к ChannelHandler хжВцЮЬцШпф╕Аф╕к ChannelOutboundHandlerя╝МцИЦшАЕф╕Лф╕Аф╕к ChannelInboundHandler хп╣ ChannelRead ф║Лф╗╢ф╕НцДЯхЕ┤ш╢гя╝МщВгф╣Их░▒чЫ┤цОеш╖│ш┐ЗуАВ</p> <h3 id="_8-3-skipcontext"><a href="#_8-3-skipcontext" class="header-anchor">#</a> 8.3 skipContext</h3> <p>шпецЦ╣ц│Хф╕╗шжБчФицЭехИдцЦнф╕Лф╕Аф╕к ChannelHandler цШпхРжхЕ╖цЬЙ mask ф╗гшбичЪДф║Лф╗╢чЪДхУНх║Фш╡Дца╝уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">skipContext</span><span class="token punctuation">(</span>
    <span class="token class-name">AbstractChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">EventExecutor</span> currentExecutor<span class="token punctuation">,</span> <span class="token keyword">int</span> mask<span class="token punctuation">,</span> <span class="token keyword">int</span> onlyMask<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>executionMask <span class="token operator">&amp;</span> <span class="token punctuation">(</span>onlyMask <span class="token operator">|</span> mask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> currentExecutor <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>executionMask <span class="token operator">&amp;</span> mask<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>хПВцХ░ onlyMask шбичд║цИСф╗мщЬАшжБцЯецЙ╛чЪД ChannelHandler ч▒╗хЮЛя╝МцпФхжВш┐ЩщЗМцИСф╗мцнгхЬиф╝ацТн ChannelRead ф║Лф╗╢я╝МхоГцШпф╕Аф╕к inbound ч▒╗ф║Лф╗╢я╝МщВгф╣Их┐Ещб╗хПкшГ╜чФ▒ ChannelInboundHandler цЭехУНх║ФхдДчРЖя╝МцЙАф╗еш┐ЩщЗМф╝ахЕечЪД onlyMask ф╕║ MASK_ONLY_INBOUND я╝И ChannelInboundHandler чЪДцОйчаБшбичд║я╝Й</li> <li>ctx.executionMask цИСф╗мх╖▓ч╗ПхЬиуАК5.3 ChanneHandlerContextуАЛх░ПшКВф╕ншпжч╗Жф╗Лч╗Нш┐Зф║Жя╝Мх╜У ChannelHandler швлц╖╗хКаш┐Ы pipeline ф╕нцЧ╢я╝МщЬАшжБшобчоЧхЗ║шпе ChannelHandler цДЯхЕ┤ш╢гчЪДф║Лф╗╢щЫЖхРИцОйчаБцЭея╝Мф┐ЭхнШхЬихп╣х║Ф ChannelHandlerContext чЪД executionMask хнЧцо╡ф╕нуАВ</li> <li>щжЦхЕИф╝ЪщАЪш┐З <code>ctx.executionMask &amp; (onlyMask | mask)) == 0</code> цЭехИдцЦнф╕Лф╕Аф╕к ChannelHandler ч▒╗хЮЛцШпхРжцнгчбоя╝МцпФхжВцИСф╗мцнгхЬиф╝ацТн inbound ч▒╗ф║Лф╗╢я╝Мф╕Лф╕Аф╕кхН┤цШпф╕Аф╕к ChannelOutboundHandler я╝МщВгф╣ИшВпхоЪцШпшжБш╖│ш┐ЗчЪДя╝Мч╗зч╗нхРСхРОцЯецЙ╛уАВ</li> <li>хжВцЮЬф╕Лф╕Аф╕к ChannelHandler чЪДч▒╗хЮЛцнгчбоя╝МщВгф╣Их░▒ф╝ЪщАЪш┐З <code>(ctx.executionMask &amp; mask) == 0</code> цЭехИдцЦншпе ChannelHandler цШпхРжхп╣цнгхЬиф╝ацТнчЪД mask ф║Лф╗╢цДЯхЕ┤ш╢гуАВхжВцЮЬшпе ChannelHandler ф╕ншжЖчЫЦф║Ж ChannelRead хЫЮш░ГхИЩцЙзшбМя╝МхжВцЮЬц▓бцЬЙшжЖчЫЦхп╣х║ФчЪДф║Лф╗╢хЫЮш░ГцЦ╣ц│ХхИЩш╖│ш┐Зя╝Мч╗зч╗нхРСхРОцЯецЙ╛я╝МчЫ┤хИ░ TailContext уАВ</li></ul> <p>ф╗еф╕Кх░▒цШп skipContext цЦ╣ц│ХчЪДца╕х┐ГщА╗ш╛Ся╝Мш┐ЩщЗМшбиш╛╛чЪДца╕х┐Гшпнф╣ЙцШпя╝Ъ</p> <ul><li>хжВцЮЬ pipeline ф╕нф╝ацТнчЪДцШп inbound ч▒╗ф║Лф╗╢я╝МхИЩх┐Ещб╗чФ▒ ChannelInboundHandler цЭехУНх║Фя╝Мх╣╢ф╕Фшпе ChannelHandler х┐Ещб╗шжЖчЫЦхоЮчО░хп╣х║ФчЪД inbound ф║Лф╗╢хЫЮш░ГуАВ</li> <li>хжВцЮЬ pipeline ф╕нф╝ацТнчЪДцШп outbound ч▒╗ф║Лф╗╢я╝МхИЩх┐Ещб╗чФ▒ ChannelOutboundHandler цЭехУНх║Фя╝Мх╣╢ф╕Фшпе ChannelHandler х┐Ещб╗шжЖчЫЦхоЮчО░хп╣х║ФчЪД outbound ф║Лф╗╢хЫЮш░ГуАВ</li></ul> <p>ш┐ЩщЗМхдзщГихИЖхРМхнжхПпшГ╜ф╝Ъхп╣ <code>ctx.executor() == currentExecutor</code>ш┐Щф╕кцЭбф╗╢цДЯхИ░х╛ИчЦСцГСуАВхКаф╕Кш┐Щф╕кцЭбф╗╢я╝МхЕ╢хоЮхп╣цИСф╗мш┐ЩщЗМчЪДца╕х┐Гшпнф╣Йх╣╢ц▓бцЬЙхдЪхдзх╜▒хУНуАВ</p> <ul><li>х╜У ctx.executor() == currentExecutor ф╣Ях░▒цШпшп┤хЙНхРОф╕дф╕к ChannelHandler цМЗхоЪчЪД executor чЫ╕хРМцЧ╢я╝МцИСф╗мца╕х┐Гшпнф╣Йф┐ЭцМБф╕НхПШуАВ</li> <li>х╜У <code>ctx.executor() != currentExecutor</code>ф╣Ях░▒цШпхЙНхРОф╕дф╕к ChannelHandler цМЗхоЪчЪД executor ф╕НхРМцЧ╢я╝М<strong>шпнф╣ЙхПШф╕║я╝ЪхПкшжБхЙНхРОф╕дф╕к ChannelHandler цМЗхоЪчЪД executor ф╕НхРМя╝Мф╕Нчобф╕Лф╕Аф╕к ChannelHandler цЬЙц▓бцЬЙшжЖчЫЦхоЮчО░цМЗхоЪф║Лф╗╢чЪДхЫЮш░ГцЦ╣ц│Хя╝МхЭЗф╕НшГ╜ш╖│ш┐ЗуАВ</strong> хЬиш┐ЩчзНцГЕхЖ╡ф╕Лф╝ЪцЙзшбМхИ░ ChannelHandler чЪДщ╗Шшодф║Лф╗╢хЫЮш░ГцЦ╣ц│Хя╝Мч╗зч╗нхЬи pipeline ф╕нф╝ащАТф║Лф╗╢уАВцИСф╗мхЬиуАК5.3 ChanneHandlerContextуАЛх░ПшКВцПРхИ░ш┐З ChannelInboundHandlerAdapter хТМ ChannelOutboundHandlerAdapter ф╝ЪхИЖхИлхп╣ inbound ч▒╗ф║Лф╗╢хЫЮш░ГцЦ╣ц│ХхТМ outbound ч▒╗ф║Лф╗╢хЫЮш░ГцЦ╣ц│Хш┐ЫшбМщ╗ШшодчЪДхоЮчО░уАВ</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChannelOutboundHandlerAdapter</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelHandlerAdapter</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelOutboundHandler</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Skip</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">,</span>
            <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>localAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Skip</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">SocketAddress</span> remoteAddress<span class="token punctuation">,</span>
            <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>remoteAddress<span class="token punctuation">,</span> localAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Skip</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Skip</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Skip</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deregister</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">deregister</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Skip</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Skip</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Skip</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>шАМш┐ЩщЗМф╣ЛцЙАф╗ещЬАшжБхКахЕе <code>ctx.executor() == currentExecutor</code> цЭбф╗╢чЪДхИдцЦня╝МцШпф╕║ф║ЖщШ▓цнв HttpContentCompressor хЬишвлцМЗхоЪф╕НхРМчЪД executor цГЕхЖ╡ф╕ЛцЧац│ХцнгчбочЪДхИЫх╗║хОЛч╝йхЖЕхо╣я╝Мхп╝шЗ┤чЪДф╕Аф║Ых╝Вх╕╕уАВф╜Жш┐Щф╕кф╕НцШпцЬмцЦЗчЪДщЗНчВ╣я╝Мхдзхо╢хПкщЬАшжБчРЖшзгш┐ЩщЗМчЪДца╕х┐Гшпнф╣Йх░▒хе╜я╝Мш┐ЩчзНчЙ╣цоКцГЕхЖ╡чЪДчЙ╣цоКхдДчРЖф║Жшзгф╕Аф╕Лх░▒хе╜уАВ</p> <h3 id="_8-4-outbound-ф║Лф╗╢чЪДф╝ацТн"><a href="#_8-4-outbound-ф║Лф╗╢чЪДф╝ацТн" class="header-anchor">#</a> 8.4 Outbound ф║Лф╗╢чЪДф╝ацТн</h3> <p>хЕ│ф║О Outbound ч▒╗ф║Лф╗╢чЪДф╝ацТня╝МчмФшАЕхЬиф╕КчпЗцЦЗчла<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484532&amp;idx=1&amp;sn=c3a8b37a2eb09509d9914494ef108c68&amp;chksm=ce77c233f9004b25a29f9fdfb179e41646092d09bc89df2147a9fab66df13231e46dd6a5c26d&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">уАКф╕АцЦЗцРЮцЗВ Netty хПСщАБцХ░цНохЕиц╡БчиЛуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕нх╖▓ч╗Пш┐ЫшбМф║Жшпжч╗ЖчЪДф╗Лч╗Ня╝МцЬмх░ПшКВх░▒ф╕НхЬиш╡Шш┐░уАВ</p> <h3 id="_8-5-exceptioncaught-ф║Лф╗╢чЪДф╝ацТн"><a href="#_8-5-exceptioncaught-ф║Лф╗╢чЪДф╝ацТн" class="header-anchor">#</a> 8.5 ExceptionCaught ф║Лф╗╢чЪДф╝ацТн</h3> <p>хЬицЬАхРОцИСф╗мцЭеф╗Лч╗Нф╕Лх╝Вх╕╕ф║Лф╗╢хЬи pipeline ф╕нчЪДф╝ацТня╝МExceptionCaught ф║Лф╗╢хТМ Inbound ч▒╗ф║Лф╗╢ф╕Аца╖щГ╜цШпхЬи pipeline ф╕нф╗ОхЙНх╛АхРОх╝АхзЛф╝ацТнуАВ</p> <p>ExceptionCaught ф║Лф╗╢чЪДшзжхПСцЬЙф╕дчзНцГЕхЖ╡я╝Ъф╕АчзНцШп netty цбЖцЮ╢хЖЕщГиф║зчФЯчЪДх╝Вх╕╕я╝Мш┐ЩцЧ╢ netty ф╝ЪчЫ┤цОехЬи pipeline ф╕ншзжхПС ExceptionCaught ф║Лф╗╢чЪДф╝ацТнуАВх╝Вх╕╕ф║Лф╗╢ф╝ЪхЬи pipeline ф╕нф╗О HeadContext х╝АхзЛф╕АчЫ┤хРСхРОф╝ацТнчЫ┤хИ░ TailContextуАВ</p> <p>цпФхжВ netty хЬи read loop ф╕ншп╗хПЦцХ░цНоцЧ╢хПСчФЯх╝Вх╕╕я╝Ъ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                allocHandle<span class="token punctuation">.</span><span class="token function">lastBytesRead</span><span class="token punctuation">(</span><span class="token function">doReadBytes</span><span class="token punctuation">(</span>byteBuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                <span class="token comment">//ховцИ╖члпNioSocketChannelчЪДpipelineф╕ншзжхПСChannelReadф║Лф╗╢</span>
                pipeline<span class="token punctuation">.</span><span class="token function">fireChannelRead</span><span class="token punctuation">(</span>byteBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>allocHandle<span class="token punctuation">.</span><span class="token function">continueReading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>  <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">handleReadException</span><span class="token punctuation">(</span>pipeline<span class="token punctuation">,</span> byteBuf<span class="token punctuation">,</span> t<span class="token punctuation">,</span> close<span class="token punctuation">,</span> allocHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ш┐ЩцЧ╢ф╝Ъ netty ф╝ЪчЫ┤цОеф╗О pipeline ф╕ншзжхПС ExceptionCaught ф║Лф╗╢чЪДф╝ацТнуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleReadException</span><span class="token punctuation">(</span><span class="token class-name">ChannelPipeline</span> pipeline<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> byteBuf<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">,</span> <span class="token keyword">boolean</span> close<span class="token punctuation">,</span>
                                 <span class="token class-name">RecvByteBufAllocator<span class="token punctuation">.</span>Handle</span> allocHandle<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        pipeline<span class="token punctuation">.</span><span class="token function">fireExceptionCaught</span><span class="token punctuation">(</span>cause<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token punctuation">}</span>
</code></pre></div><p>хТМ Inbound ч▒╗ф║Лф╗╢ф╕Аца╖я╝МExceptionCaught ф║Лф╗╢ф╝ЪхЬи pipeline ф╕нф╗О HeadContext х╝АхзЛф╕АчЫ┤хРСхРОф╝ацТнуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">fireExceptionCaught</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AbstractChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">invokeExceptionCaught</span><span class="token punctuation">(</span>head<span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>чммф║МчзНшзжхПС ExceptionCaught ф║Лф╗╢чЪДцГЕхЖ╡цШпя╝Мх╜У Inbound ч▒╗ф║Лф╗╢цИЦшАЕ flush ф║Лф╗╢хЬи pipeline ф╕нф╝ацТнчЪДш┐ЗчиЛф╕ня╝МхЬицЯРф╕к ChannelHandler ф╕нчЪДф║Лф╗╢хЫЮш░ГцЦ╣ц│ХхдДчРЖф╕нхПСчФЯх╝Вх╕╕я╝Мш┐ЩцЧ╢шпе ChannelHandler чЪД exceptionCaught цЦ╣ц│Хф╝ЪшвлхЫЮш░ГуАВчФицИ╖хПпф╗ехЬиш┐ЩщЗМхдДчРЖх╝Вх╕╕ф║Лф╗╢я╝Мх╣╢хЖ│хоЪцШпхРжщАЪш┐З ctx.fireExceptionCaught(cause) ч╗зч╗нхРСхРОф╝ацТнх╝Вх╕╕ф║Лф╗╢уАВ</p> <p>цпФхжВцИСф╗мхЬи ChannelInboundHandler ф╕нчЪД ChannelRead хЫЮш░Гф╕нхдДчРЖф╕ЪхКбшп╖ц▒ВцЧ╢хПСчФЯх╝Вх╕╕я╝Мх░▒ф╝ЪшзжхПСшпе ChannelInboundHandler чЪД exceptionCaught цЦ╣ц│ХуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeChannelRead</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">invokeHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ChannelInboundHandler</span><span class="token punctuation">)</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">invokeExceptionCaught</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">fireChannelRead</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeExceptionCaught</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">invokeHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//шзжхПСchannelHandlerчЪДexceptionCaughtхЫЮш░Г</span>
            <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exceptionCaught</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>хЖНцпФхжВя╝Ъх╜УцИСф╗мхЬи ChannelOutboundHandler ф╕нчЪД flush хЫЮш░Гф╕нхдДчРЖф╕ЪхКбч╗УцЮЬхПСщАБчЪДцЧ╢хАЩхПСчФЯх╝Вх╕╕я╝Мф╣Яф╝ЪшзжхПСшпе ChannelOutboundHandler чЪД exceptionCaught цЦ╣ц│ХуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeFlush0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ChannelOutboundHandler</span><span class="token punctuation">)</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">invokeExceptionCaught</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цИСф╗мхПпф╗ехЬи ChannelHandler чЪД exceptionCaught хЫЮш░Гф╕нш┐ЫшбМх╝Вх╕╕хдДчРЖя╝Мх╣╢хЖ│хоЪцШпхРжщАЪш┐З ctx.fireExceptionCaught(cause) ч╗зч╗нхРСхРОф╝ацТнх╝Вх╕╕ф║Лф╗╢уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exceptionCaught</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>х╝Вх╕╕хдДчРЖ<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        ctx<span class="token punctuation">.</span><span class="token function">fireExceptionCaught</span><span class="token punctuation">(</span>cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ChannelHandlerContext</span> <span class="token function">fireExceptionCaught</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">invokeExceptionCaught</span><span class="token punctuation">(</span><span class="token function">findContextInbound</span><span class="token punctuation">(</span><span class="token constant">MASK_EXCEPTION_CAUGHT</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">invokeExceptionCaught</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">AbstractChannelHandlerContext</span> next<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>cause<span class="token punctuation">,</span> <span class="token string">&quot;cause&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">EventExecutor</span> executor <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>executor<span class="token punctuation">.</span><span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        next<span class="token punctuation">.</span><span class="token function">invokeExceptionCaught</span><span class="token punctuation">(</span>cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    next<span class="token punctuation">.</span><span class="token function">invokeExceptionCaught</span><span class="token punctuation">(</span>cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to submit an exceptionCaught() event.&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;The exceptionCaught() event that was failed to submit was:&quot;</span><span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_8-6-exceptioncaught-ф║Лф╗╢хТМ-inbound-ч▒╗ф║Лф╗╢чЪДхМ║хИл"><a href="#_8-6-exceptioncaught-ф║Лф╗╢хТМ-inbound-ч▒╗ф║Лф╗╢чЪДхМ║хИл" class="header-anchor">#</a> 8.6 ExceptionCaught ф║Лф╗╢хТМ Inbound ч▒╗ф║Лф╗╢чЪДхМ║хИл</h3> <p>шЩ╜чД╢ ExceptionCaught ф║Лф╗╢хТМ Inbound ч▒╗ф║Лф╗╢хЬиф╝ацТнцЦ╣хРСщГ╜цШпхЬи pipeline ф╕нф╗ОхЙНхРСхРОф╝ацТнуАВф╜ЖцШпхдзхо╢ш┐ЩщЗМц│ицДПхМ║хИЖш┐Щф╕дф╕кф║Лф╗╢чЪДхМ║хИлуАВ</p> <p><strong>хЬи Inbound ч▒╗ф║Лф╗╢ф╝ацТнш┐ЗчиЛф╕нцШпф╝ЪцЯецЙ╛ф╕Лф╕Аф╕кхЕ╖цЬЙф║Лф╗╢хУНх║Фш╡Дца╝чЪД ChannelInboundHandler уАВщБЗхИ░ ChannelOutboundHandler ф╝ЪчЫ┤цОеш╖│ш┐ЗуАВ</strong></p> <p><strong>шАМ ExceptionCaught ф║Лф╗╢цЧашо║цШпхЬихУкчзНч▒╗хЮЛчЪД channelHandler ф╕ншзжхПСчЪДя╝МщГ╜ф╝Ъф╗Ох╜УхЙНх╝Вх╕╕ ChannelHandler х╝АхзЛф╕АчЫ┤хРСхРОф╝ацТня╝МChannelInboundHandler хПпф╗ехУНх║Фшпех╝Вх╕╕ф║Лф╗╢я╝МChannelOutboundHandler ф╣ЯхПпф╗ехУНх║Фшпех╝Вх╕╕ф║Лф╗╢уАВ</strong></p> <p>чФ▒ф║ОцЧашо║х╝Вх╕╕цШпхЬи ChannelInboundHandler ф╕нф║зчФЯчЪДш┐ШцШпхЬи ChannelOutboundHandler ф╕нф║зчФЯчЪДя╝М exceptionCaught ф║Лф╗╢щГ╜ф╝ЪхЬи pipeline ф╕нцШпф╗ОхЙНхРСхРОф╝ацТня╝Мх╣╢ф╕Фф╕НхЕ│х┐Г ChannelHandler чЪДч▒╗хЮЛуАВ<strong>цЙАф╗ецИСф╗мф╕АшИмх░Жш┤Яш┤гч╗Яф╕Ах╝Вх╕╕хдДчРЖчЪД ChannelHandler цФ╛хЬи pipeline чЪДцЬАхРО</strong>я╝Мш┐Щца╖хоГхп╣ф║О inbound ч▒╗х╝Вх╕╕хТМ outbound ч▒╗х╝Вх╕╕хЭЗхПпф╗ецНХшО╖х╛ЧхИ░уАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191116438.webp" alt="хЫ╛чЙЗ"></p> <hr> <h2 id="цА╗ч╗У"><a href="#цА╗ч╗У" class="header-anchor">#</a> цА╗ч╗У</h2> <p>цЬмцЦЗц╢ЙхПКхИ░чЪДхЖЕхо╣цпФш╛ГхдЪя╝МщАЪш┐З netty х╝Вцнеф║Лф╗╢хЬи pipeline ф╕нчЪДч╝ЦцОТхТМф╝ацТнш┐ЩцЭбф╕╗ч║┐я╝МцИСф╗мчЫ╕х╜Уф║Ох░Жф╣ЛхЙНчЪДцЦЗчлахЖЕхо╣щЗНцЦ░хПИхЫЮщб╛цА╗ч╗Уф║Жф╕АщБНуАВ</p> <p>цЬмцЦЗф╕нцИСф╗мшпжч╗Жф╗Лч╗Нф║Ж pipeline чЪДч╗ДцИРч╗УцЮДя╝МхоГф╕╗шжБцШпчФ▒ ChannelHandlerContext ч▒╗хЮЛшКВчВ╣ч╗ДцИРчЪДхПМхРСщУ╛шбиуАВChannelHandlerContext хМЕхРлф║Ж ChannelHandler цЙзшбМф╕Кф╕ЛцЦЗчЪДф┐бцБпя╝Мф╗ОшАМхПпф╗еф╜┐ ChannelHandler хПкхЕ│ц│иф║О IO ф║Лф╗╢чЪДхдДчРЖя╝МщБ╡х╛кф║ЖхНХф╕АхОЯхИЩхТМх╝АщЧнхОЯхИЩуАВ</p> <p>цндхдЦ pipeline ч╗УцЮДф╕нш┐ШхМЕхРлф║Жф╕Аф╕кф╗╗хКбщУ╛шбия╝МчФицЭехнШцФ╛цЙзшбМ ChannelHandler ф╕нчЪД handlerAdded хЫЮш░ГхТМ handlerRemoved хЫЮш░ГуАВpipeline ш┐ШцМБцЬЙф║ЖцЙАх▒Ю channel чЪДх╝ХчФиуАВ</p> <p>цИСф╗мш┐Шшпжч╗Жф╗Лч╗Нф║Ж Netty ф╕нх╝Вцнеф║Лф╗╢чЪДхИЖч▒╗я╝ЪInbound ч▒╗ф║Лф╗╢я╝МOutbound ч▒╗ф║Лф╗╢я╝МExceptionCaught ф║Лф╗╢уАВх╣╢шпжч╗Жф╗Лч╗Нф║ЖцпПчзНхИЖч▒╗ф╕ЛчЪДцЙАцЬЙф║Лф╗╢чЪДшзжхПСцЧ╢цЬ║хТМхЬи pipeline ф╕нчЪДф╝ацТнш╖пх╛ДуАВ</p> <p>цЬАхРОф╗Лч╗Нф║Ж pipeline чЪДч╗УцЮДф╗ехПКхИЫх╗║хТМхИЭхзЛхМЦш┐ЗчиЛя╝Мф╗ехПКхп╣ pipeline чЫ╕хЕ│цУНф╜ЬчЪДц║РчаБхоЮчО░уАВ</p> <p>ф╕нщЧ┤цИСф╗мхПИчй┐цПТф╗Лч╗Нф║Ж ChannelHanderContext чЪДч╗УцЮДя╝Мф╗Лч╗Нф║Ж ChannelHandlerContext хЕ╖ф╜Ух░БшгЕф║ЖхУкф║ЫхЕ│ф║О ChannelHandler цЙзшбМчЪДф╕Кф╕ЛцЦЗф┐бцБпуАВ</p> <p>цЬмцЦЗчЪДхЖЕхо╣хИ░ш┐ЩщЗМх░▒ч╗УцЭЯф║Жя╝МцДЯш░вхдзхо╢чЪДшзВчЬЛя╝МцИСф╗мф╕ЛчпЗцЦЗчлашзБ~~~</p> <h2 id="хПВшАГш╡ДцЦЩ"><a href="#хПВшАГш╡ДцЦЩ" class="header-anchor">#</a> хПВшАГш╡ДцЦЩ</h2> <p><a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484823&amp;idx=1&amp;sn=9396fb0f5dbac5e32d0fa1129d385fbc&amp;chksm=ce77c3d0f9004ac678283b7d178835e740eb5e5b80740cc624ae7a307be7a7eb0c7766842878&amp;scene=126&amp;sessionid=1726749878#rd" target="_blank" rel="noopener noreferrer">ф╕АцЦЗшБКщАП Netty IO ф║Лф╗╢чЪДч╝ЦцОТхИйхЩи pipeline | шпжшзгцЙАцЬЙ IO ф║Лф╗╢чЪДшзжхПСцЧ╢цЬ║ф╗ехПКф╝ацТнш╖пх╛Д (qq.com)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/echo-lxy/echo-system-design/edit/master/docs/Netty ч│╗ч╗Яшо╛шоб/25.хЫЫуАБц╖▒хЕе Netty ца╕х┐Г/25.чммхЕлшп╛я╝ЪNetty ф╕нIOф║Лф╗╢чЪДшзжхПСцЧ╢цЬ║хТМф╝ацТнц╡БчиЛ.md" target="_blank" rel="noopener noreferrer">ч╝Цш╛С</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">ф╕КцмбцЫ┤цЦ░ф║О:</span> <span class="time">2024/09/19, 14:54:12</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        тЖР
        <a href="/pages/a73206/" class="prev">чммхЕншп╛я╝ЪNetty хжВф╜ХщлШцХИхПСщАБч╜Сч╗ЬцХ░цНо</a></span> <span class="next"><a href="/pages/8be98a/">чммф╕Ашп╛я╝ЪByteBuf ф╜Уч│╗чЪДшо╛шобф╕ОхоЮчО░</a>тЖТ
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:lixinyang2002@163.com" title="хПСщВоф╗╢" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/echo-lxy" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="хРмщЯ│ф╣Р" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="цЬмчлЩф╕╗щвШ">Vdoing</a> 
    | Copyright ┬й 2024-2024
    <span>Xinyang Li | MIT License</span></div> <div class="buttons"><div title="ш┐ФхЫЮщб╢щГи" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="хО╗шпДшо║" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ф╕╗щвШцибх╝П" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          ш╖ЯщЪПч│╗ч╗Я
        </li><li class="iconfont icon-rijianmoshi">
          ц╡ЕшЙ▓цибх╝П
        </li><li class="iconfont icon-yejianmoshi">
          ц╖▒шЙ▓цибх╝П
        </li><li class="iconfont icon-yuedu">
          щШЕшп╗цибх╝П
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.78f2b9cc.js" defer></script><script src="/assets/js/2.933750c6.js" defer></script><script src="/assets/js/58.bb9706ba.js" defer></script><script src="/assets/js/7.7eb70372.js" defer></script>
  </body>
</html>
