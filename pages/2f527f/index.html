<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Netty Reactor хРпхКихЕиц╡БчиЛ | EchoDesign</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="ч│╗ч╗Яшо╛шобф╣ЛуАМшо▓шзг + щЭвшпХцМЗхНЧуАНя╝Мц░┤ц╗┤чЯ│чй┐я╝Мшо╛шобцЧащУ╢х╝╣я╝Б">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.f82a82e9.css" as="style"><link rel="preload" href="/assets/js/app.78f2b9cc.js" as="script"><link rel="preload" href="/assets/js/2.933750c6.js" as="script"><link rel="preload" href="/assets/js/53.6f165300.js" as="script"><link rel="preload" href="/assets/js/7.7eb70372.js" as="script"><link rel="prefetch" href="/assets/js/10.b313d17c.js"><link rel="prefetch" href="/assets/js/100.a9558091.js"><link rel="prefetch" href="/assets/js/101.007aa479.js"><link rel="prefetch" href="/assets/js/102.57bca734.js"><link rel="prefetch" href="/assets/js/11.c7521a10.js"><link rel="prefetch" href="/assets/js/12.f57a12da.js"><link rel="prefetch" href="/assets/js/13.d9d26d25.js"><link rel="prefetch" href="/assets/js/14.09cf8a64.js"><link rel="prefetch" href="/assets/js/15.d5a34c66.js"><link rel="prefetch" href="/assets/js/16.8cea924c.js"><link rel="prefetch" href="/assets/js/17.8d94c5e8.js"><link rel="prefetch" href="/assets/js/18.baad837c.js"><link rel="prefetch" href="/assets/js/19.571eaed1.js"><link rel="prefetch" href="/assets/js/20.d70e5281.js"><link rel="prefetch" href="/assets/js/21.0e0ed140.js"><link rel="prefetch" href="/assets/js/22.1ccaa6f3.js"><link rel="prefetch" href="/assets/js/23.623f0b5d.js"><link rel="prefetch" href="/assets/js/24.891fe6fb.js"><link rel="prefetch" href="/assets/js/25.41dca26b.js"><link rel="prefetch" href="/assets/js/26.6337eac0.js"><link rel="prefetch" href="/assets/js/27.de80589e.js"><link rel="prefetch" href="/assets/js/28.95a1fb6b.js"><link rel="prefetch" href="/assets/js/29.371a40e1.js"><link rel="prefetch" href="/assets/js/3.e62a71e4.js"><link rel="prefetch" href="/assets/js/30.e32f6b31.js"><link rel="prefetch" href="/assets/js/31.21bd2de1.js"><link rel="prefetch" href="/assets/js/32.f1174703.js"><link rel="prefetch" href="/assets/js/33.eab858f3.js"><link rel="prefetch" href="/assets/js/34.4ba0e53e.js"><link rel="prefetch" href="/assets/js/35.8287c9dc.js"><link rel="prefetch" href="/assets/js/36.b5f133ca.js"><link rel="prefetch" href="/assets/js/37.82be3556.js"><link rel="prefetch" href="/assets/js/38.40fe2658.js"><link rel="prefetch" href="/assets/js/39.6450065f.js"><link rel="prefetch" href="/assets/js/4.73518a0f.js"><link rel="prefetch" href="/assets/js/40.591baf2a.js"><link rel="prefetch" href="/assets/js/41.f961e422.js"><link rel="prefetch" href="/assets/js/42.b34f1599.js"><link rel="prefetch" href="/assets/js/43.5a509601.js"><link rel="prefetch" href="/assets/js/44.64fd3383.js"><link rel="prefetch" href="/assets/js/45.685623ac.js"><link rel="prefetch" href="/assets/js/46.b7523f9c.js"><link rel="prefetch" href="/assets/js/47.9bed4c1b.js"><link rel="prefetch" href="/assets/js/48.a1b270df.js"><link rel="prefetch" href="/assets/js/49.ee9681bc.js"><link rel="prefetch" href="/assets/js/5.b472a9bb.js"><link rel="prefetch" href="/assets/js/50.b424b2c0.js"><link rel="prefetch" href="/assets/js/51.53684c6e.js"><link rel="prefetch" href="/assets/js/52.a45a9bb1.js"><link rel="prefetch" href="/assets/js/54.61a6a81b.js"><link rel="prefetch" href="/assets/js/55.5391018d.js"><link rel="prefetch" href="/assets/js/56.e0b862ae.js"><link rel="prefetch" href="/assets/js/57.374534af.js"><link rel="prefetch" href="/assets/js/58.bb9706ba.js"><link rel="prefetch" href="/assets/js/59.6d5a538f.js"><link rel="prefetch" href="/assets/js/6.0b558b79.js"><link rel="prefetch" href="/assets/js/60.99b51260.js"><link rel="prefetch" href="/assets/js/61.33893dab.js"><link rel="prefetch" href="/assets/js/62.e6604fa3.js"><link rel="prefetch" href="/assets/js/63.e753bb13.js"><link rel="prefetch" href="/assets/js/64.59e76eda.js"><link rel="prefetch" href="/assets/js/65.66728f4b.js"><link rel="prefetch" href="/assets/js/66.30cbe3ea.js"><link rel="prefetch" href="/assets/js/67.9aea7c9b.js"><link rel="prefetch" href="/assets/js/68.79ee7ba7.js"><link rel="prefetch" href="/assets/js/69.a776cc2e.js"><link rel="prefetch" href="/assets/js/70.13d90b76.js"><link rel="prefetch" href="/assets/js/71.4f4c7733.js"><link rel="prefetch" href="/assets/js/72.b0948cb0.js"><link rel="prefetch" href="/assets/js/73.d7ed15dc.js"><link rel="prefetch" href="/assets/js/74.6884119c.js"><link rel="prefetch" href="/assets/js/75.b70b8a0c.js"><link rel="prefetch" href="/assets/js/76.2766fd7c.js"><link rel="prefetch" href="/assets/js/77.c9b76e03.js"><link rel="prefetch" href="/assets/js/78.9aa9da2e.js"><link rel="prefetch" href="/assets/js/79.ea5b4888.js"><link rel="prefetch" href="/assets/js/8.77b795dd.js"><link rel="prefetch" href="/assets/js/80.3c3f7534.js"><link rel="prefetch" href="/assets/js/81.76b7b1ed.js"><link rel="prefetch" href="/assets/js/82.7b7a2f1c.js"><link rel="prefetch" href="/assets/js/83.44c820ac.js"><link rel="prefetch" href="/assets/js/84.f53c8839.js"><link rel="prefetch" href="/assets/js/85.8c526118.js"><link rel="prefetch" href="/assets/js/86.e17eab25.js"><link rel="prefetch" href="/assets/js/87.a09f72d3.js"><link rel="prefetch" href="/assets/js/88.0f27b036.js"><link rel="prefetch" href="/assets/js/89.2fd11d59.js"><link rel="prefetch" href="/assets/js/9.36f81190.js"><link rel="prefetch" href="/assets/js/90.e60814ad.js"><link rel="prefetch" href="/assets/js/91.08cfa575.js"><link rel="prefetch" href="/assets/js/92.81c822a0.js"><link rel="prefetch" href="/assets/js/93.5f199263.js"><link rel="prefetch" href="/assets/js/94.266b7d71.js"><link rel="prefetch" href="/assets/js/95.0899dfb4.js"><link rel="prefetch" href="/assets/js/96.c1156914.js"><link rel="prefetch" href="/assets/js/97.18525931.js"><link rel="prefetch" href="/assets/js/98.ee554b1a.js"><link rel="prefetch" href="/assets/js/99.f0fb67c2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f82a82e9.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="чЫох╜Х" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="EchoDesign" class="logo"> <span class="site-name can-hide">EchoDesign</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">ЁЯПащжЦщб╡</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">тЬТя╕ПчГнщЧичоЧц│Х</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕шо╛шоб" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕шо╛шоб</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">JUC ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ч│╗ч╗Яшо╛шоб</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">тЭУщЧочнФ</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ЁЯСАхКицАБ</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">ЁЯПащжЦщб╡</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">тЬТя╕ПчГнщЧичоЧц│Х</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕шо╛шоб" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕шо╛шоб</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">JUC ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ч│╗ч╗Яшо╛шоб</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">тЭУщЧочнФ</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ЁЯСАхКицАБ</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ф╕АуАБхЙНшиА</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ф║МуАБхЯ║чбАчЯешпЖ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ф╕ЙуАБф╕╗ч║┐ф╗╗хКб</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>хЫЫуАБц╖▒хЕе Netty ца╕х┐Г</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/65674f/" class="sidebar-link">чммф╕Ашп╛я╝ЪщАПш┐З Netty ф╗ОхЖЕца╕шзТх║жчЬЛ IO цибхЮЛ</a></li><li><a href="/pages/440035/" class="sidebar-link">чммф║Мшп╛я╝ЪReactorхЬи Netty ф╕нчЪДхоЮчО░я╝ИхИЫх╗║чпЗя╝Й</a></li><li><a href="/pages/2f527f/" aria-current="page" class="active sidebar-link">Netty Reactor хРпхКихЕиц╡БчиЛ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/2f527f/#хЙНшиА" class="sidebar-link">хЙНшиА</a></li><li class="sidebar-sub-header level2"><a href="/pages/2f527f/#serverbootstrap" class="sidebar-link">ServerBootstrap</a></li><li class="sidebar-sub-header level2"><a href="/pages/2f527f/#_1-щЕНч╜оф╕╗ф╗О-reactor-ч║┐чиЛч╗Д" class="sidebar-link">1. щЕНч╜оф╕╗ф╗О Reactor ч║┐чиЛч╗Д</a></li><li class="sidebar-sub-header level2"><a href="/pages/2f527f/#_2-щЕНч╜оцЬНхКбчлп-serversocketchannel" class="sidebar-link">2. щЕНч╜оцЬНхКбчлп ServerSocketChannel</a></li><li class="sidebar-sub-header level2"><a href="/pages/2f527f/#_3-ф╕║-nioserversocketchannel-щЕНч╜о-channeloption" class="sidebar-link">3. ф╕║ NioServerSocketChannel щЕНч╜о ChannelOption</a></li><li class="sidebar-sub-header level2"><a href="/pages/2f527f/#_4-ф╕║цЬНхКбчлп-nioserversocketchannel-ф╕нчЪД-pipeline-щЕНч╜о-channelhandler" class="sidebar-link">4. ф╕║цЬНхКбчлп NioServerSocketChannel ф╕нчЪД Pipeline щЕНч╜о ChannelHandler</a></li><li class="sidebar-sub-header level2"><a href="/pages/2f527f/#_5-ф╕║ховцИ╖члп-niosocketchannel-ф╕нчЪД-pipeline-щЕНч╜о-channelhandler" class="sidebar-link">5. ф╕║ховцИ╖члп NioSocketChannel ф╕нчЪД Pipeline щЕНч╜о ChannelHandler</a></li><li class="sidebar-sub-header level2"><a href="/pages/2f527f/#channelinitializer" class="sidebar-link">ChannelInitializer</a></li><li class="sidebar-sub-header level2"><a href="/pages/2f527f/#netty-цЬНхКбчлпчЪДхРпхКи" class="sidebar-link">Netty цЬНхКбчлпчЪДхРпхКи</a></li><li class="sidebar-sub-header level2"><a href="/pages/2f527f/#цА╗ч╗У" class="sidebar-link">цА╗ч╗У</a></li><li class="sidebar-sub-header level2"><a href="/pages/2f527f/#хПВшАГш╡ДцЦЩ" class="sidebar-link">хПВшАГш╡ДцЦЩ</a></li></ul></li><li><a href="/pages/bb668a/" class="sidebar-link">чммф╕Йшп╛я╝ЪNetty ца╕х┐Гх╝ХцУО Reactor чЪДш┐Рш╜мцЮ╢цЮД</a></li><li><a href="/pages/be98dc/" class="sidebar-link">чммхЫЫшп╛я╝ЪNetty хжВф╜ХщлШцХИцОецФ╢ч╜Сч╗Ьш┐ЮцОе</a></li><li><a href="/pages/0938c1/" class="sidebar-link">чммф║Фшп╛я╝ЪNetty хжВф╜ХщлШцХИцОецФ╢ч╜Сч╗ЬцХ░цНо</a></li><li><a href="/pages/a73206/" class="sidebar-link">чммхЕншп╛я╝ЪNetty хжВф╜ХщлШцХИхПСщАБч╜Сч╗ЬцХ░цНо</a></li><li><a href="/pages/a1b0fe/" class="sidebar-link">чммф╕Гшп╛я╝ЪNetty ф╕нIOф║Лф╗╢чЪДшзжхПСцЧ╢цЬ║хТМф╝ацТнц╡БчиЛ</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ф║ФуАБц╖▒хЕе Netty хЖЕхнШчобчРЖ</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="щжЦщб╡" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>Netty ч│╗ч╗Яшо╛шоб</span></li><li data-v-06225672><span data-v-06225672>хЫЫуАБц╖▒хЕе Netty ца╕х┐Г</span></li></ul> <div class="info" data-v-06225672><div title="ф╜ЬшАЕ" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/brother-one" target="_blank" title="ф╜ЬшАЕ" class="beLink" data-v-06225672>echo</a></div> <div title="хИЫх╗║цЧ╢щЧ┤" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-09-19</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">чЫох╜Х</div> <div class="right-menu-content"></div></div></div> <h1><!---->Netty Reactor хРпхКихЕиц╡БчиЛ<!----></h1> <div class="page-slot page-slot-top">
    <div class="wwads-cn wwads-horizontal page-wwads" data-id="136"></div>
    <style>
      .page-wwads{
        width:100%!important;
        min-height: 0;
        margin: 0;
      }
      .page-wwads .wwads-img img{
        width:80px!important;
      }
      .page-wwads .wwads-poweredby{
        width: 40px;
        position: absolute;
        right: 25px;
        bottom: 3px;
      }
      .wwads-content .wwads-text, .page-wwads .wwads-text{
        height: 100%;
        padding-top: 5px;
        display: block;
      }
  </style>
  </div> <div class="theme-vdoing-content content__default"><h2 id="хЙНшиА"><a href="#хЙНшиА" class="header-anchor">#</a> хЙНшиА</h2> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192050578.webp" alt="хЫ╛чЙЗ"></p> <p>хдзхо╢чммф╕АчЬ╝чЬЛхИ░ш┐Щх╣Ец╡БчиЛхЫ╛я╝МцШпф╕НцШпшДСчУЬхнРхЧбхЧбчЪДхСвя╝Я</p> <p>хдзхо╢хЕИф╕НшжБцГКцЕМя╝МщЧощвШф╕Нхдзя╝МцЬмцЦЗчмФшАЕчЪДчЫочЪДх░▒цШпшжБшойхдзхо╢ц╕ЕцЩ░чЪДчРЖшзгш┐Щх╣Ец╡БчиЛхЫ╛я╝Мф╗ОшАМц╖▒хИ╗чЪДчРЖшзг Netty Reactor чЪДхРпхКихЕиц╡БчиЛя╝МхМЕцЛмхЕ╢ф╕нц╢ЙхПКхИ░чЪДхРДчзНф╗гчаБшо╛шобхоЮчО░ч╗ЖшКВ</p> <p>хЬиф╕КчпЗцЦЗчла<a href="/pages/440035/">уАКчммф║Мшп╛я╝ЪReator хЬи Netty ф╕нчЪДхоЮчО░я╝ИхИЫх╗║чпЗя╝ЙуАЛ</a>ф╕нцИСф╗мшпжч╗Жф╗Лч╗Нф║Ж Netty цЬНхКбчлпца╕х┐Гх╝ХцУОч╗Дф╗╢<code>ф╕╗ф╗ОReactorч╗ДцибхЮЛ NioEventLoopGroup</code>ф╗ехПК<code>ReactorцибхЮЛ NioEventLoop</code>чЪДхИЫх╗║ш┐ЗчиЛуАВцЬАч╗ИцИСф╗мх╛ЧхИ░ф║Ж netty Reactor цибхЮЛчЪДш┐РшбМщкицЮ╢хжВф╕Ля╝Ъ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192048631.webp" alt="хЫ╛чЙЗ"></p> <p>чО░хЬи Netty цЬНхКбчлпчиЛх║ПчЪДщкицЮ╢цШпцРнх╗║хе╜ф║Жя╝МцЬмцЦЗцИСф╗мх░▒хЯ║ф║Ош┐Щф╕кщкицЮ╢цЭец╖▒хЕехЙЦцЮРф╕Л Netty цЬНхКбчлпчЪДхРпхКиш┐ЗчиЛуАВ</p> <p>цИСф╗мч╗зч╗нхЫЮхИ░ф╕КчпЗцЦЗчлацПРхИ░чЪД Netty цЬНхКбчлпф╗гчаБцибцЭ┐ф╕ня╝МхЬихИЫх╗║хоМф╕╗ф╗О Reactor ч║┐чиЛч╗Дя╝Ъ<code>bossGroup</code>я╝М<code>workerGroup</code>хРОя╝МцОеф╕ЛцЭех░▒х╝АхзЛщЕНч╜о Netty цЬНхКбчлпчЪДхРпхКиш╛ЕхКйч▒╗<code>ServerBootstrap</code>ф║ЖуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">EchoServer</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">PORT</span> <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;port&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;8007&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// Configure the server.</span>
        <span class="token comment">//хИЫх╗║ф╕╗ф╗ОReactorч║┐чиЛч╗Д</span>
        <span class="token class-name">EventLoopGroup</span> bossGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EventLoopGroup</span> workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">EchoServerHandler</span> serverHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EchoServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span><span class="token comment">//щЕНч╜оф╕╗ф╗ОReactor</span>
             <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token comment">//щЕНч╜оф╕╗Reactorф╕нчЪДchannelч▒╗хЮЛ</span>
             <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_BACKLOG</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token comment">//шо╛ч╜оф╕╗Reactorф╕нchannelчЪДoptionщАЙщб╣</span>
             <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoggingHandler</span><span class="token punctuation">(</span><span class="token class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">INFO</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//шо╛ч╜оф╕╗Reactorф╕нChannel-&gt;pipline-&gt;handler</span>
             <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//шо╛ч╜оф╗ОReactorф╕нц│ихЖМchannelчЪДpipeline</span>
                 <span class="token annotation punctuation">@Override</span>
                 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                     <span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token comment">//p.addLast(new LoggingHandler(LogLevel.INFO));</span>
                     p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>serverHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token punctuation">}</span>
             <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Start the server. ч╗СхоЪчлпхПгхРпхКицЬНхКбя╝Мх╝АхзЛчЫСхРмacceptф║Лф╗╢</span>
            <span class="token class-name">ChannelFuture</span> f <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Wait until the server socket is closed.</span>
            f<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// Shut down all event loops to terminate all threads.</span>
            bossGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            workerGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хЬиф╕КчпЗцЦЗчлаф╕нцИСф╗мхп╣ф╗гчаБцибцЭ┐ф╕нц╢ЙхПКхИ░<code>ServerBootstrap</code>чЪДф╕Аф║ЫщЕНч╜оцЦ╣ц│ХхБЪф║ЖчоАхНХчЪДф╗Лч╗Ня╝Мхдзхо╢хжВцЮЬх┐Шшо░чЪДшпЭя╝МхПпф╗ехЬиш┐ФхЫЮхО╗хЫЮщб╛ф╕Аф╕ЛуАВ</p> <p><code>ServerBootstrapч▒╗</code>хЕ╢хоЮц▓бцЬЙф╗Аф╣ИчЙ╣хИлчЪДщА╗ш╛Ся╝Мф╕╗шжБцШпхп╣ Netty хРпхКиш┐ЗчиЛф╕нщЬАшжБчФихИ░чЪДф╕Аф║Ыца╕х┐Гф┐бцБпш┐ЫшбМщЕНч╜очобчРЖя╝МцпФхжВя╝Ъ</p> <p>![хЫ╛чЙЗ](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192048098.webp" alt="хЫ╛чЙЗ"></p> <ul><li>Netty чЪДца╕х┐Гх╝ХцУОч╗Дф╗╢<code>ф╕╗ф╗ОReactorч║┐чиЛч╗Дя╝ЪbossGroupя╝МworkerGroup</code>уАВщАЪш┐З<code>ServerBootstrap#groupцЦ╣ц│Х</code>щЕНч╜оуАВ</li> <li>Netty цЬНхКбчлпф╜┐чФихИ░чЪД Channel ч▒╗хЮЛя╝Ъ<code>NioServerSocketChannel</code> ,щАЪш┐З<code>ServerBootstrap#channelцЦ╣ц│Х</code>щЕНч╜оуАВф╗ехПКщЕНч╜о<code>NioServerSocketChannel</code>цЧ╢чФихИ░чЪД<code>SocketOption</code>уАВ<code>SocketOption</code>чФиф║Ошо╛ч╜ох║Хх▒В JDK NIO Socket чЪДф╕Аф║ЫщАЙщб╣уАВщАЪш┐З<code>ServerBootstrap#optionцЦ╣ц│Х</code>ш┐ЫшбМщЕНч╜оуАВ</li></ul> <blockquote><p>ф╕╗ ReactorGroup ф╕нчЪД MainReactor чобчРЖчЪД Channel ч▒╗хЮЛф╕║<code>NioServerSocketChannel</code>я╝МхжВхЫ╛цЙАчд║ф╕╗шжБчФицЭечЫСхРмчлпхПгя╝МцОецФ╢ховцИ╖члпш┐ЮцОея╝Мф╕║ховцИ╖члпхИЫх╗║хИЭхзЛхМЦ<code>NioSocketChannel</code>я╝МчД╢хРОщЗЗчФи<code>round-robin</code>ш╜ошпвчЪДцЦ╣х╝Пф╗ОхЫ╛ф╕нф╗О ReactorGroup ф╕нщАЙцЛйф╕Аф╕к SubReactor ф╕ОшпеховцИ╖члп<code>NioSocketChannel</code>ш┐ЫшбМч╗СхоЪуАВ</p></blockquote> <blockquote><p>ф╗О ReactorGroup ф╕нчЪД SubReactor чобчРЖчЪД Channel ч▒╗хЮЛф╕║<code>NioSocketChannel</code>я╝МхоГцШп netty ф╕нхоЪф╣ЙховцИ╖члпш┐ЮцОечЪДф╕Аф╕кцибхЮЛя╝МцпПф╕кш┐ЮцОехп╣х║Фф╕Аф╕куАВхжВхЫ╛цЙАчд║ SubReactor ш┤Яш┤гчЫСхРмхдДчРЖч╗СхоЪхЬихЕ╢ф╕КчЪДцЙАцЬЙ<code>NioSocketChannel</code>ф╕КчЪД IO ф║Лф╗╢уАВ</p></blockquote> <ul><li>ф┐ЭхнШцЬНхКбчлп<code>NioServerSocketChannel</code>хТМховцИ╖члп<code>NioSocketChannel</code>хп╣х║Ф<code>pipeline</code>ф╕нцМЗхоЪчЪД<code>ChannelHandler</code>уАВчФиф║ОхРОч╗н Channel хРС Reactor ц│ихЖМцИРхКЯф╣ЛхРОя╝МхИЭхзЛхМЦ Channel щЗМчЪД pipelineуАВ</li></ul> <blockquote><p>ф╕НчобцШпцЬНхКбчлпчФихИ░чЪД<code>NioServerSocketChannel</code>ш┐ШцШпховцИ╖члпчФихИ░чЪД<code>NioSocketChannel</code>я╝МцпПф╕к<code>ChannelхоЮф╛Л</code>щГ╜ф╝ЪцЬЙф╕Аф╕к<code>Pipeline</code>я╝М<code>Pipeline</code>ф╕нцЬЙхдЪф╕к<code>ChannelHandler</code>чФиф║Оч╝ЦцОТхдДчРЖхп╣х║Ф<code>Channel</code>ф╕КцДЯхЕ┤ш╢гчЪД<code>IOф║Лф╗╢</code>уАВ</p></blockquote> <p><code>ServerBootstrap</code>ч╗УцЮДф╕нхМЕхРлф║Ж netty цЬНхКбчлпчиЛх║ПхРпхКичЪДцЙАцЬЙщЕНч╜оф┐бцБпя╝МхЬицИСф╗мф╗Лч╗НхРпхКиц╡БчиЛф╣ЛхЙНя╝МхЕИцЭечЬЛф╕Л<code>ServerBootstrap</code>чЪДц║РчаБч╗УцЮДя╝Ъ</p> <h2 id="serverbootstrap"><a href="#serverbootstrap" class="header-anchor">#</a> ServerBootstrap</h2> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192050513.webp" alt="хЫ╛чЙЗ"></p> <p><code>ServerBootstrap</code>чЪДч╗зцЙ┐ч╗УцЮДцпФш╛ГчоАхНХя╝Мч╗зцЙ┐х▒ВцмбчЪДшБМш┤гхИЖх╖еф╣ЯцпФш╛ГцШОчбоуАВ</p> <p><code>ServerBootstrap</code>ф╕╗шжБш┤Яш┤гхп╣<code>ф╕╗ф╗ОReactorч║┐чиЛч╗Д</code>чЫ╕хЕ│чЪДщЕНч╜ош┐ЫшбМчобчРЖя╝МхЕ╢ф╕нх╕ж<code>childхЙНч╝АчЪДщЕНч╜оцЦ╣ц│Х</code>цШпхп╣<code>ф╗ОReactorч║┐чиЛч╗Д</code>чЪДчЫ╕хЕ│щЕНч╜очобчРЖуАВ<code>ф╗ОReactorч║┐чиЛч╗Д</code>ф╕нчЪД<code>Sub Reactor</code>ш┤Яш┤гчобчРЖчЪДховцИ╖члп<code>NioSocketChannel</code>чЫ╕хЕ│щЕНч╜охнШхВихЬи<code>ServerBootstrap</code>ч╗УцЮДф╕нуАВ</p> <p>чИ╢ч▒╗<code>AbstractBootstrap</code>хИЩцШпф╕╗шжБш┤Яш┤гхп╣<code>ф╕╗Reactorч║┐чиЛч╗Д</code>чЫ╕хЕ│чЪДщЕНч╜ош┐ЫшбМчобчРЖя╝Мф╗ехПК<code>ф╕╗Reactorч║┐чиЛч╗Д</code>ф╕нчЪД<code>Main Reactor</code>ш┤Яш┤гхдДчРЖчЪДцЬНхКбчлп<code>ServerSocketChannel</code>чЫ╕хЕ│чЪДщЕНч╜очобчРЖ</p> <h2 id="_1-щЕНч╜оф╕╗ф╗О-reactor-ч║┐чиЛч╗Д"><a href="#_1-щЕНч╜оф╕╗ф╗О-reactor-ч║┐чиЛч╗Д" class="header-anchor">#</a> 1. щЕНч╜оф╕╗ф╗О Reactor ч║┐чиЛч╗Д</h2> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span><span class="token comment">//щЕНч╜оф╕╗ф╗ОReactor</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServerBootstrap</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractBootstrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerBootstrap</span><span class="token punctuation">,</span> <span class="token class-name">ServerChannel</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token comment">//Main Reactor ч║┐чиЛч╗Д</span>
    <span class="token keyword">volatile</span> <span class="token class-name">EventLoopGroup</span> group<span class="token punctuation">;</span>

    <span class="token comment">//Sub Reactor ч║┐чиЛч╗Д</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">EventLoopGroup</span> childGroup<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ServerBootstrap</span> <span class="token function">group</span><span class="token punctuation">(</span><span class="token class-name">EventLoopGroup</span> parentGroup<span class="token punctuation">,</span> <span class="token class-name">EventLoopGroup</span> childGroup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//чИ╢ч▒╗чобчРЖф╕╗ Reactor ч║┐чиЛч╗Д</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>parentGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>childGroup <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;childGroup set already&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>childGroup <span class="token operator">=</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>childGroup<span class="token punctuation">,</span> <span class="token string">&quot;childGroup&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h2 id="_2-щЕНч╜оцЬНхКбчлп-serversocketchannel"><a href="#_2-щЕНч╜оцЬНхКбчлп-serversocketchannel" class="header-anchor">#</a> 2. щЕНч╜оцЬНхКбчлп ServerSocketChannel</h2> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServerBootstrap</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractBootstrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerBootstrap</span><span class="token punctuation">,</span> <span class="token class-name">ServerChannel</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token comment">//чФиф║ОхИЫх╗║ServerSocketChannel  ReflectiveChannelFactory</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">ChannelFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">C</span><span class="token punctuation">&gt;</span></span> channelFactory<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">B</span> <span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">C</span><span class="token punctuation">&gt;</span></span> channelClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">channelFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReflectiveChannelFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>channelClass<span class="token punctuation">,</span> <span class="token string">&quot;channelClass&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Deprecated</span>
    <span class="token keyword">public</span> <span class="token class-name">B</span> <span class="token function">channelFactory</span><span class="token punctuation">(</span><span class="token class-name">ChannelFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">C</span><span class="token punctuation">&gt;</span></span> channelFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>channelFactory<span class="token punctuation">,</span> <span class="token string">&quot;channelFactory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>channelFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;channelFactory set already&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>channelFactory <span class="token operator">=</span> channelFactory<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>хЬихРС<code>ServerBootstrap</code>щЕНч╜оцЬНхКбчлп<code>ServerSocketChannel</code>чЪД<code>channel</code>цЦ╣ц│Хф╕ня╝МхЕ╢хоЮцШпхИЫх╗║ф║Жф╕Аф╕к<code>ChannelFactory</code>х╖ехОВхоЮф╛Л<code>ReflectiveChannelFactory</code>я╝МхЬи Netty цЬНхКбчлпхРпхКичЪДш┐ЗчиЛф╕ня╝Мф╝ЪщАЪш┐Зш┐Щф╕к<code>ChannelFactory</code>хО╗хИЫх╗║чЫ╕х║ФчЪД<code>Channel</code>хоЮф╛ЛуАВ</p> <p>цИСф╗мхПпф╗ещАЪш┐Зш┐Щф╕кцЦ╣ц│ХцЭещЕНч╜о netty чЪД IO цибхЮЛя╝Мф╕ЛщЭвф╕║<code>ServerSocketChannel</code>хЬиф╕НхРМ IO цибхЮЛф╕ЛчЪДхоЮчО░я╝Ъ</p> <table><thead><tr><th style="text-align:center;">BIO</th> <th style="text-align:center;">NIO</th> <th style="text-align:center;">AIO</th></tr></thead> <tbody><tr><td style="text-align:center;">OioServerSocketChannel</td> <td style="text-align:center;">NioServerSocketChannel</td> <td style="text-align:center;">AioServerSocketChannel</td></tr></tbody></table> <p><code>EventLoopGroup</code>Reactor ч║┐чиЛч╗ДхЬиф╕НхРМ IO цибхЮЛф╕ЛчЪДхоЮчО░я╝Ъ</p> <table><thead><tr><th style="text-align:center;">BIO</th> <th style="text-align:center;">NIO</th> <th style="text-align:center;">AIO</th></tr></thead> <tbody><tr><td style="text-align:center;">ThreadPerChannelEventLoopGroup</td> <td style="text-align:center;">NioEventLoopGroup</td> <td style="text-align:center;">AioEventLoopGroup</td></tr></tbody></table> <p>цИСф╗мхПкщЬАшжБх░Ж<code>IOцибхЮЛ</code>чЪДш┐Щф║Ыца╕х┐ГцОехПгхп╣х║ФчЪДхоЮчО░ч▒╗<code>хЙНч╝А</code>цФ╣ф╕║хп╣х║Ф<code>IOцибхЮЛ</code>чЪДхЙНч╝Ая╝Мх░▒хПпф╗еш╜╗цЭ╛хЬи Netty ф╕нхоМцИРхп╣<code>IOцибхЮЛ</code>чЪДхИЗцНвуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192053959.webp" alt="хЫ╛чЙЗ"></p> <h3 id="_2-1-reflectivechannelfactory"><a href="#_2-1-reflectivechannelfactory" class="header-anchor">#</a> 2.1 ReflectiveChannelFactory</h3> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReflectiveChannelFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">ChannelFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">//NioServerSocketChannelde цЮДщАахЩи</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> constructor<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ReflectiveChannelFactory</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token string">&quot;clazz&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//хПНх░ДшО╖хПЦNioServerSocketChannelчЪДцЮДщАахЩи</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>constructor <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Class &quot;</span> <span class="token operator">+</span> <span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">simpleClassName</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span> <span class="token operator">+</span>
                    <span class="token string">&quot; does not have a public non-arg constructor&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">newChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//хИЫх╗║NioServerSocketChannelхоЮф╛Л</span>
            <span class="token keyword">return</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ChannelException</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to create Channel from class &quot;</span> <span class="token operator">+</span> constructor<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ф╗Оч▒╗чЪДчн╛хРНцИСф╗мхПпф╗ечЬЛхЗ║я╝Мш┐Щф╕кх╖ехОВч▒╗цШпщАЪш┐З<code>ц│ЫхЮЛ</code>хКа<code>хПНх░Д</code>чЪДцЦ╣х╝ПцЭехИЫх╗║хп╣х║ФчЪД<code>Channel</code>хоЮф╛ЛуАВ</p> <ul><li>ц│ЫхЮЛхПВцХ░<code>T extends Channel</code>шбичд║чЪДцШпшжБщАЪш┐Зх╖ехОВч▒╗хИЫх╗║чЪД<code>Channelч▒╗хЮЛ</code>я╝Мш┐ЩщЗМцИСф╗мхИЭхзЛхМЦчЪДцШп<code>NioServerSocketChannel</code>уАВ</li> <li>хЬи<code>ReflectiveChannelFactory</code>чЪДцЮДщАахЩиф╕нщАЪш┐З<code>хПНх░Д</code>чЪДцЦ╣х╝ПшО╖хПЦ<code>NioServerSocketChannel</code>чЪДцЮДщАахЩиуАВ</li> <li>хЬи<code>newChannel</code>цЦ╣ц│Хф╕нщАЪш┐ЗцЮДщАахЩихПНх░ДхИЫх╗║<code>NioServerSocketChannel</code>хоЮф╛ЛуАВ</li></ul> <p><strong>ц│ицДП</strong>ш┐ЩцЧ╢хПкцШпщЕНч╜ощШ╢цо╡я╝М<code>NioServerSocketChannel</code>цндцЧ╢х╣╢цЬкшвлхИЫх╗║уАВхоГцШпхЬихРпхКичЪДцЧ╢хАЩцЙНф╝ЪшвлхИЫх╗║хЗ║цЭеуАВ</p> <h2 id="_3-ф╕║-nioserversocketchannel-щЕНч╜о-channeloption"><a href="#_3-ф╕║-nioserversocketchannel-щЕНч╜о-channeloption" class="header-anchor">#</a> 3. ф╕║ NioServerSocketChannel щЕНч╜о ChannelOption</h2> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//шо╛ч╜ошвлMainReactorчобчРЖчЪДNioServerSocketChannelчЪДSocketщАЙщб╣</span>
b<span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_BACKLOG</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractBootstrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractBootstrap</span><span class="token punctuation">&lt;</span><span class="token class-name">B</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">C</span> <span class="token keyword">extends</span> <span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Cloneable</span> <span class="token punctuation">{</span>

    <span class="token comment">//serverSocketChannelф╕нчЪДChannelOptionщЕНч╜о</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelOption</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelOption</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">B</span> <span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> option<span class="token punctuation">,</span> <span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>option<span class="token punctuation">,</span> <span class="token string">&quot;option&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                options<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                options<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>option<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цЧашо║цШпцЬНхКбчлпчЪД<code>NioServerSocketChannel</code>ш┐ШцШпховцИ╖члпчЪД<code>NioSocketChannel</code>хоГф╗мчЪДчЫ╕хЕ│х║Хх▒В Socket щАЙщб╣<code>ChannelOption</code>щЕНч╜охЕищГихнШцФ╛ф║Оф╕Аф╕к<code>Map</code>ч▒╗хЮЛчЪДцХ░цНоч╗УцЮДф╕нуАВ</p> <p>чФ▒ф║ОховцИ╖члп<code>NioSocketChannel</code>цШпчФ▒<code>ф╗ОReactorч║┐чиЛч╗Д</code>ф╕нчЪД<code>Sub Reactor</code>цЭеш┤Яш┤гхдДчРЖя╝МцЙАф╗ец╢ЙхПКхИ░ховцИ╖члп<code>NioSocketChannel</code>цЙАцЬЙчЪДцЦ╣ц│ХхТМщЕНч╜охЕищГицШпф╗е<code>child</code>хЙНч╝Ах╝Ахд┤уАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token function">childOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">TCP_NODELAY</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServerBootstrap</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractBootstrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerBootstrap</span><span class="token punctuation">,</span> <span class="token class-name">ServerChannel</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

   <span class="token comment">//ховцИ╖члпSocketChannelхп╣х║ФчЪДChannelOptionщЕНч╜о</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelOption</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> childOptions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelOption</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">ServerBootstrap</span> <span class="token function">childOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> childOption<span class="token punctuation">,</span> <span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>childOption<span class="token punctuation">,</span> <span class="token string">&quot;childOption&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>childOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                childOptions<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>childOption<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                childOptions<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>childOption<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>чЫ╕хЕ│чЪДх║Хх▒В Socket щАЙщб╣я╝Мnetty хЕищГицЮЪф╕╛хЬи ChannelOption ч▒╗ф╕ня╝МчмФшАЕш┐ЩщЗМх░▒ф╕Нф╕Аф╕АхИЧф╕╛ф║Жя╝МхЬицЬмч│╗хИЧхРОч╗нчЫ╕хЕ│чЪДцЦЗчлаф╕ня╝МчмФшАЕш┐Шф╝Ъф╕║хдзхо╢шпжч╗ЖчЪДф╗Лч╗Нш┐Щф║ЫхПВцХ░чЪДф╜ЬчФиуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChannelOption</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractConstant</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelOption</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ChannelOption</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token constant">SO_BROADCAST</span> <span class="token operator">=</span> <span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;SO_BROADCAST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ChannelOption</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token constant">SO_KEEPALIVE</span> <span class="token operator">=</span> <span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;SO_KEEPALIVE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ChannelOption</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token constant">SO_SNDBUF</span> <span class="token operator">=</span> <span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;SO_SNDBUF&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ChannelOption</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token constant">SO_RCVBUF</span> <span class="token operator">=</span> <span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;SO_RCVBUF&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ChannelOption</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token constant">SO_REUSEADDR</span> <span class="token operator">=</span> <span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;SO_REUSEADDR&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ChannelOption</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token constant">SO_LINGER</span> <span class="token operator">=</span> <span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;SO_LINGER&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ChannelOption</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token constant">SO_BACKLOG</span> <span class="token operator">=</span> <span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;SO_BACKLOG&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ChannelOption</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token constant">SO_TIMEOUT</span> <span class="token operator">=</span> <span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;SO_TIMEOUT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token punctuation">}</span>
</code></pre></div><h2 id="_4-ф╕║цЬНхКбчлп-nioserversocketchannel-ф╕нчЪД-pipeline-щЕНч╜о-channelhandler"><a href="#_4-ф╕║цЬНхКбчлп-nioserversocketchannel-ф╕нчЪД-pipeline-щЕНч╜о-channelhandler" class="header-anchor">#</a> 4. ф╕║цЬНхКбчлп NioServerSocketChannel ф╕нчЪД Pipeline щЕНч╜о ChannelHandler</h2> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">//serverSocketChannel ф╕н pipeline щЗМчЪД handler(ф╕╗шжБцШп acceptor)</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">B</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>handler <span class="token operator">=</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> <span class="token string">&quot;handler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хРС<code>NioServerSocketChannel</code>ф╕нчЪД<code>Pipeline</code>ц╖╗хКа<code>ChannelHandler</code>хИЖф╕║ф╕дчзНцЦ╣х╝Пя╝Ъ</p> <ul><li><code>цШ╛х╝Пц╖╗хКая╝Ъ</code> цШ╛х╝Пц╖╗хКачЪДцЦ╣х╝ПцШпчФ▒чФицИ╖хЬи main ч║┐чиЛф╕нщАЪш┐З<code>ServerBootstrap#handler</code>чЪДцЦ╣х╝Пц╖╗хКауАВхжВцЮЬщЬАшжБц╖╗хКахдЪф╕к<code>ChannelHandler</code>я╝МхИЩхПпф╗ещАЪш┐З<code>ChannelInitializer</code>хРС<code>pipeline</code>ф╕нш┐ЫшбМц╖╗хКауАВ</li></ul> <blockquote><p>хЕ│ф║О<code>ChannelInitializer</code>хРОщЭвчмФшАЕф╝ЪцЬЙшпжч╗Жф╗Лч╗Ня╝Мш┐ЩщЗМхдзхо╢хПкщЬАшжБчЯещБУ<code>ChannelInitializer</code>цШпф╕АчзН<strong>чЙ╣цоКчЪД</strong><code>ChannelHandler</code>я╝МчФиф║ОхИЭхзЛхМЦ<code>pipeline</code>уАВщАВчФиф║ОхРС pipeline ф╕нц╖╗хКахдЪф╕к ChannelHandler чЪДхЬ║цЩпуАВ</p></blockquote> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span><span class="token comment">//щЕНч╜оф╕╗ф╗ОReactor</span>
    <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token comment">//щЕНч╜оф╕╗Reactorф╕нчЪДchannelч▒╗хЮЛ</span>
    <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>channelhandler1<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>channelHandler2<span class="token punctuation">)</span>

                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                <span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>channelHandler3<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><code>щЪРх╝Пц╖╗хКая╝Ъ</code>щЪРх╝Пц╖╗хКаф╕╗шжБц╖╗хКачЪДх░▒цШп<code>ф╕╗ReactorGroup</code>чЪДца╕х┐Гч╗Дф╗╢ф╣Ях░▒цШпф╕ЛхЫ╛ф╕нчЪД<code>acceptor</code>я╝МNetty ф╕нчЪДхоЮчО░ф╕║<code>ServerBootstrapAcceptor</code>я╝МцЬмш┤иф╕Кф╣ЯцШпф╕АчзН<code>ChannelHandler</code>я╝Мф╕╗шжБш┤Яш┤гхЬиховцИ╖члпш┐ЮцОех╗║члЛхе╜хРОя╝МхИЭхзЛхМЦховцИ╖члп<code>NioSocketChannel</code>я╝МхЬи<code>ф╗ОReactorч║┐чиЛч╗Дф╕н</code>щАЙхПЦф╕Аф╕к<code>Sub Reactor</code>я╝Мх░ЖховцИ╖члп<code>NioSocketChannel</code> ц│ихЖМхИ░<code>Sub Reactor</code>ф╕нчЪД<code>selector</code>ф╕КуАВ</li></ul> <blockquote><p>щЪРх╝Пц╖╗хКа<code>ServerBootstrapAcceptor</code>цШпчФ▒ Netty цбЖцЮ╢хЬихРпхКичЪДцЧ╢хАЩш┤Яш┤гц╖╗хКая╝МчФицИ╖цЧащЬАхЕ│х┐ГуАВ</p></blockquote> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192048576.webp" alt="хЫ╛чЙЗ"></p> <p>хЬицЬмф╛Лф╕ня╝М<code>NioServerSocketChannel</code>чЪД<code>PipeLine</code>ф╕нхПкцЬЙф╕дф╕к<code>ChannelHandler</code>,ф╕Аф╕кчФ▒чФицИ╖хЬихдЦщГицШ╛х╝Пц╖╗хКачЪД<code>LoggingHandler</code>,хПжф╕Аф╕кцШпчФ▒ Netty цбЖцЮ╢щЪРх╝Пц╖╗хКачЪД<code>ServerBootstrapAcceptor</code>уАВ</p> <blockquote><p>хЕ╢хоЮцИСф╗мхЬихоЮщЩЕщб╣чЫоф╜┐чФичЪДш┐ЗчиЛф╕ня╝Мф╕Нф╝ЪхРС netty цЬНхКбчлп<code>NioServerSocketChannel</code>ц╖╗хКащвЭхдЦчЪД ChannelHandlerя╝М<code>NioServerSocketChannel</code>хПкщЬАшжБф╕Ух┐ГхБЪхе╜шЗкх╖▒цЬАщЗНшжБчЪДцЬмшБМх╖еф╜ЬцОецФ╢ховцИ╖члпш┐ЮцОех░▒хе╜ф║ЖуАВш┐ЩщЗМщвЭхдЦц╖╗хКаф╕Аф╕к<code>LoggingHandler</code>хПкцШпф╕║ф║ЖхРСхдзхо╢х▒Хчд║<code>ServerBootstrap</code>чЪДщЕНч╜оцЦ╣ц│ХуАВ</p></blockquote> <h2 id="_5-ф╕║ховцИ╖члп-niosocketchannel-ф╕нчЪД-pipeline-щЕНч╜о-channelhandler"><a href="#_5-ф╕║ховцИ╖члп-niosocketchannel-ф╕нчЪД-pipeline-щЕНч╜о-channelhandler" class="header-anchor">#</a> 5. ф╕║ховцИ╖члп NioSocketChannel ф╕нчЪД Pipeline щЕНч╜о ChannelHandler</h2> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">EchoServerHandler</span> serverHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EchoServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

serverBootstrap<span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//шо╛ч╜оф╗ОReactorф╕нц│ихЖМchannelчЪДpipeline</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoggingHandler</span><span class="token punctuation">(</span><span class="token class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">INFO</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>serverHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//socketChannelф╕нpipelineф╕нчЪДхдДчРЖhandler</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">ChannelHandler</span> childHandler<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">ServerBootstrap</span> <span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> childHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>childHandler <span class="token operator">=</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>childHandler<span class="token punctuation">,</span> <span class="token string">&quot;childHandler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хРСховцИ╖члп<code>NioSocketChannel</code>ф╕нчЪД<code>Pipeline</code>щЗМц╖╗хКа<code>ChannelHandler</code>хоМхЕицШпчФ▒чФицИ╖шЗкх╖▒цОзхИ╢цШ╛х╝Пц╖╗хКая╝Мц╖╗хКачЪДцХ░щЗПф╕НхПЧщЩРхИ╢уАВ</p> <p>чФ▒ф║ОхЬи Netty чЪД<code>IOч║┐чиЛцибхЮЛ</code>ф╕ня╝МцШпчФ▒хНХф╕к<code>Sub Reactorч║┐чиЛ</code>ш┤Яш┤гцЙзшбМховцИ╖члп<code>NioSocketChannel</code>ф╕нчЪД<code>Pipeline</code>я╝Мф╕Аф╕к<code>Sub Reactorч║┐чиЛ</code>ш┤Яш┤гхдДчРЖхдЪф╕к<code>NioSocketChannel</code>ф╕КчЪД<code>IOф║Лф╗╢</code>я╝МхжВцЮЬ<code>Pipeline</code>ф╕нчЪД<code>ChannelHandler</code>ц╖╗хКачЪДхдкхдЪя╝Мх░▒ф╝Ъх╜▒хУН<code>Sub Reactorч║┐чиЛ</code>цЙзшбМхЕ╢ф╗Ц<code>NioSocketChannel</code>ф╕КчЪД<code>Pipeline</code>я╝Мф╗ОшАМщЩНф╜О<code>IOхдДчРЖцХИчОЗ</code>я╝МщЩНф╜ОхРЮхРРщЗПуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192057209.webp" alt="хЫ╛чЙЗ"></p> <p>цЙАф╗е<code>Pipeline</code>ф╕нчЪД<code>ChannelHandler</code>ф╕НцШУц╖╗хКаш┐ЗхдЪя╝Мх╣╢ф╕Фф╕НшГ╜хЖН<code>ChannelHandler</code>ф╕нцЙзшбМшАЧцЧ╢чЪДф╕ЪхКбхдДчРЖф╗╗хКбуАВ</p> <p>хЬицИСф╗мщАЪш┐З<code>ServerBootstrap</code>щЕНч╜о netty цЬНхКбчлпхРпхКиф┐бцБпчЪДцЧ╢хАЩя╝МцЧашо║цШпхРСцЬНхКбчлп<code>NioServerSocketChannel</code>чЪД pipeline ф╕нц╖╗хКа ChannelHandlerя╝Мш┐ШцШпхРСховцИ╖члп<code>NioSocketChannel</code>чЪД pipeline ф╕нц╖╗хКа ChannelHandlerя╝Мх╜Уц╢ЙхПКхИ░хдЪф╕к ChannelHandler ц╖╗хКачЪДцЧ╢хАЩя╝МцИСф╗мщГ╜ф╝ЪчФихИ░<code>ChannelInitializer</code>я╝МщВгф╣Иш┐Щф╕к<code>ChannelInitializer</code>чй╢члЯцШпф╜ХцЦ╣хЬгчеЮя╝Мф╕║ф╗Аф╣ИшжБш┐Щца╖хБЪхСвя╝ЯцИСф╗мцОечЭАх╛Аф╕ЛчЬЛ~~</p> <h2 id="channelinitializer"><a href="#channelinitializer" class="header-anchor">#</a> ChannelInitializer</h2> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192058761.webp" alt="хЫ╛чЙЗ"></p> <p>щжЦхЕИ<code>ChannelInitializer</code>хоГч╗зцЙ┐ф║О<code>ChannelHandler</code>я╝МхоГшЗкх╖▒цЬмш║лх░▒цШпф╕Аф╕к ChannelHandlerя╝МцЙАф╗ехоГхПпф╗ец╖╗хКахИ░<code>childHandler</code>ф╕нуАВ</p> <blockquote><p>хЕ╢ф╗ЦчЪДчИ╢ч▒╗хдзхо╢ш┐ЩщЗМхПпф╗еф╕НчФичобя╝МхРОщЭвцЦЗчлаф╕нчмФшАЕф╝Ъф╕Аф╕Аф╕║хдзхо╢шпжч╗Жф╗Лч╗НуАВ</p></blockquote> <p><strong>щВгф╕║ф╗Аф╣Иф╕НчЫ┤цОец╖╗хКа <code>ChannelHandler</code> шАМцШпщАЙцЛйчФи <code>ChannelInitializer</code> хСвя╝Я</strong></p> <p>ш┐ЩщЗМф╕╗шжБцЬЙф╕дчВ╣хОЯхЫая╝Ъ</p> <ul><li>хЙНш╛╣цИСф╗мцПРхИ░я╝МховцИ╖члп<code>NioSocketChannel</code>цШпхЬицЬНхКбчлп accept ш┐ЮцОехРОя╝МхЬицЬНхКбчлп<code>NioServerSocketChannel</code>ф╕ншвлхИЫх╗║хЗ║цЭечЪДуАВ<strong>ф╜ЖцШпцндцЧ╢цИСф╗мцнгхдДф║ОщЕНч╜о<code>ServerBootStrap</code>щШ╢цо╡я╝МцЬНхКбчлпш┐Шц▓бцЬЙхРпхКия╝МцЫ┤ц▓бцЬЙховцИ╖члпш┐ЮцОеф╕КцЭе</strong>я╝МцндцЧ╢ховцИ╖члп<code>NioSocketChannel</code>ш┐Шц▓бцЬЙшвлхИЫх╗║хЗ║цЭея╝МцЙАф╗еф╣Ях░▒ц▓бхКЮц│ХхРСховцИ╖члп<code>NioSocketChannel</code>чЪД pipeline ф╕нц╖╗хКа<code>ChannelHandler</code>уАВ</li> <li>ховцИ╖члп<code>NioSocketChannel</code>ф╕н<code>Pipeline</code>щЗМхПпф╗ец╖╗хКаф╗╗цДПхдЪф╕к<code>ChannelHandler</code>я╝Мф╜ЖцШп Netty цбЖцЮ╢цЧац│ХщвДчЯечФицИ╖хИ░х║ХщЬАшжБц╖╗хКахдЪх░Сф╕к<code>ChannelHandler</code>я╝МцЙАф╗е Netty цбЖцЮ╢цПРф╛Ыф║ЖхЫЮш░ГхЗ╜цХ░<code>ChannelInitializer#initChannel</code>я╝Мф╜┐чФицИ╖хПпф╗ешЗкхоЪф╣Й<code>ChannelHandler</code>чЪДц╖╗хКашбМф╕║уАВ</li></ul> <p>х╜УховцИ╖члп<code>NioSocketChannel</code>ц│ихЖМхИ░хп╣х║ФчЪД<code>Sub Reactor</code>ф╕КхРОя╝Мч┤зцОечЭАх░▒ф╝ЪхИЭхзЛхМЦ<code>NioSocketChannel</code>ф╕нчЪД<code>Pipeline</code>я╝МцндцЧ╢ Netty цбЖцЮ╢ф╝ЪхЫЮш░Г<code>ChannelInitializer#initChannel</code>цЙзшбМчФицИ╖шЗкхоЪф╣ЙчЪДц╖╗хКащА╗ш╛СуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span> <span class="token keyword">extends</span> <span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">channelRegistered</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//х╜УchannelRegisterф║Лф╗╢хПСчФЯцЧ╢я╝Мш░ГчФиinitChannelхИЭхзЛхМЦpipeline</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">initChannel</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>initMap<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Guard against re-entrance.</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//цндцЧ╢ховцИ╖хНХNioSocketChannelх╖▓ч╗ПхИЫх╗║х╣╢хИЭхзЛхМЦхе╜ф║Ж</span>
                <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">C</span><span class="token punctuation">)</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">C</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ш┐ЩщЗМчФ▒ netty цбЖцЮ╢хЫЮш░ГчЪД<code>ChannelInitializer#initChannelцЦ╣ц│Х</code>цнгцШпцИСф╗мшЗкхоЪф╣ЙчЪДц╖╗хКащА╗ш╛СуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">EchoServerHandler</span> serverHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EchoServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

serverBootstrap<span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//шо╛ч╜оф╗ОReactorф╕нц│ихЖМchannelчЪДpipeline</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoggingHandler</span><span class="token punctuation">(</span><span class="token class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">INFO</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>serverHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><hr> <p>хИ░цндф╕║цнвя╝МNetty цЬНхКбчлпхРпхКицЙАщЬАшжБчЪДх┐ЕшжБщЕНч╜оф┐бцБпя╝Мх╖▓ч╗ПхЕищГихнШхЕе<code>ServerBootStrap</code>хРпхКиш╛ЕхКйч▒╗ф╕нуАВ</p> <p>цОеф╕ЛцЭешжБхБЪчЪДф║ЛцГЕх░▒цШпцЬНхКбчлпчЪДхРпхКиф║ЖуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// Start the server. ч╗СхоЪчлпхПгхРпхКицЬНхКбя╝Мх╝АхзЛчЫСхРмacceptф║Лф╗╢</span>
<span class="token class-name">ChannelFuture</span> f <span class="token operator">=</span> serverBootStrap<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="netty-цЬНхКбчлпчЪДхРпхКи"><a href="#netty-цЬНхКбчлпчЪДхРпхКи" class="header-anchor">#</a> Netty цЬНхКбчлпчЪДхРпхКи</h2> <p>ч╗Пш┐ЗхЙНщЭвчЪДщУ║хЮлч╗Иф║ОцЭехИ░ф║ЖцЬмцЦЗчЪДца╕х┐ГхЖЕхо╣ ---- Netty цЬНхКбчлпчЪДхРпхКиш┐ЗчиЛуАВ</p> <p>хжВф╗гчаБцибцЭ┐ф╕нчЪДчд║ф╛ЛцЙАчд║я╝МNetty цЬНхКбчлпчЪДхРпхКиш┐ЗчиЛх░БшгЕхЬи<code>io.netty.bootstrap.AbstractBootstrap#bind(int)</code>хЗ╜цХ░ф╕нуАВ</p> <p><strong>цОеф╕ЛцЭецИСф╗мчЬЛф╕Аф╕Л Netty цЬНхКбчлпхЬихРпхКиш┐ЗчиЛф╕нчй╢члЯх╣▓ф║ЖхУкф║Ыф║ЛцГЕя╝Я</strong></p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192102676.webp" alt="хЫ╛чЙЗ"></p> <p>хдзхо╢чЬЛхИ░ш┐ЩхЙпхРпхКиц╡БчиЛхЫ╛хЕИф╕НшжБцЕМя╝МцОеф╕ЛцЭечЪДхЖЕхо╣чмФшАЕф╝Ъх╕жхдзхо╢хРДф╕кхЗ╗ча┤хоГя╝МхЬицЦЗчлачЪДцЬАхРОф┐ЭшпБшойхдзхо╢чЬЛцЗВш┐ЩхЙпц╡БчиЛхЫ╛уАВ</p> <p>цИСф╗мхЕИцЭеф╗О netty цЬНхКбчлпхРпхКичЪДхЕехПгхЗ╜цХ░х╝АхзЛцИСф╗мф╗КхдйчЪДц║РчаБшзгцЮРцЧЕчиЛя╝Ъ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">int</span> inetPort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span>inetPort<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//цабщкМNettyца╕х┐Гч╗Дф╗╢цШпхРжщЕНч╜ощ╜РхЕи</span>
    <span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//цЬНхКбчлпх╝АхзЛхРпхКия╝Мч╗СхоЪчлпхПгхЬ░хЭАя╝МцОецФ╢ховцИ╖члпш┐ЮцОе</span>
    <span class="token keyword">return</span> <span class="token function">doBind</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>localAddress<span class="token punctuation">,</span> <span class="token string">&quot;localAddress&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">ChannelFuture</span> <span class="token function">doBind</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//х╝ВцнехИЫх╗║я╝МхИЭхзЛхМЦя╝Мц│ихЖМServerSocketChannelхИ░main reactorф╕К</span>
    <span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> regFuture <span class="token operator">=</span> <span class="token function">initAndRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Channel</span> channel <span class="token operator">=</span> regFuture<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>regFuture<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> regFuture<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>regFuture<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>serverSocketChannel хРС <span class="token class-name">Main</span> <span class="token class-name">Reactor</span> ц│ихЖМцИРхКЯхРОх╝АхзЛч╗СхоЪчлпхПг<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//хжВцЮЬцндцЧ╢ц│ихЖМцУНф╜Ьц▓бцЬЙхоМцИРя╝МхИЩхРСregFutureц╖╗хКаoperationCompleteхЫЮш░ГхЗ╜цХ░я╝Мц│ихЖМцИРхКЯхРОхЫЮш░ГуАВ</span>
        regFuture<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelFutureListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelFuture</span> future<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>serverSocketChannelхРС<span class="token class-name">Main</span> <span class="token class-name">Reactor</span>ц│ихЖМцИРхКЯхРОх╝АхзЛч╗СхоЪчлпхПг<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>Netty цЬНхКбчлпчЪДхРпхКиц╡БчиЛцА╗ф╜УхжВф╕Ля╝Ъ</strong></p> <ul><li>хИЫх╗║цЬНхКбчлп<code>NioServerSocketChannel</code>х╣╢хИЭхзЛхМЦуАВ</li> <li>х░ЖцЬНхКбчлп<code>NioServerSocketChannel</code>ц│ихЖМхИ░<code>ф╕╗Reactorч║┐чиЛч╗Д</code>ф╕нуАВ</li> <li>ц│ихЖМцИРхКЯхРОя╝Мх╝АхзЛхИЭхзЛхМЦ<code>NioServerSocketChannel</code>ф╕нчЪД pipelineя╝МчД╢хРОхЬи pipeline ф╕ншзжхПС channelRegister ф║Лф╗╢уАВ</li> <li>щЪПхРОчФ▒<code>NioServerSocketChannel</code>ч╗СхоЪчлпхПгхЬ░хЭАуАВ</li> <li>ч╗СхоЪчлпхПгхЬ░хЭАцИРхКЯхРОя╝МхРС<code>NioServerSocketChannel</code>хп╣х║ФчЪД<code>Pipeline</code>ф╕ншзжхПСф╝ацТн<code>ChannelActiveф║Лф╗╢</code>я╝МхЬи<code>ChannelActiveф║Лф╗╢хЫЮш░Г</code>ф╕нхРС<code>Main Reactor</code>ц│ихЖМ<code>OP_ACCEPTф║Лф╗╢</code>я╝Мх╝АхзЛчнЙх╛ЕховцИ╖члпш┐ЮцОеуАВцЬНхКбчлпхРпхКихоМцИРуАВ</li></ul> <p>х╜У netty цЬНхКбчлпхРпхКицИРхКЯф╣ЛхРОя╝МцЬАч╗ИцИСф╗мф╝Ъх╛ЧхИ░хжВф╕Лч╗УцЮДчЪДщШ╡хЮЛя╝Мх╝АхзЛцЮХцИИх╛ЕцЧжя╝МхЗЖхдЗцОецФ╢ховцИ╖члпчЪДш┐ЮцОея╝МReactor х╝АхзЛш┐Рш╜муАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192103283.webp" alt="хЫ╛чЙЗ"></p> <p>цОеф╕ЛцЭея╝МцИСф╗мх░▒цЭечЬЛф╕Л Netty ц║РчаБцШпхжВф╜ХхоЮчО░ф╗еф╕КцнещкдчЪД~~</p> <h3 id="_1-initandregister"><a href="#_1-initandregister" class="header-anchor">#</a> 1. initAndRegister</h3> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192105313.webp" alt="хЫ╛чЙЗ"></p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> <span class="token function">initAndRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//хИЫх╗║NioServerSocketChannel</span>
        <span class="token comment">//ReflectiveChannelFactoryщАЪш┐Зц│ЫхЮЛя╝МхПНх░Дя╝Мх╖ехОВчЪДцЦ╣х╝ПчБ╡ц┤╗хИЫх╗║ф╕НхРМч▒╗хЮЛчЪДchannel</span>
        channel <span class="token operator">=</span> channelFactory<span class="token punctuation">.</span><span class="token function">newChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//хИЭхзЛхМЦNioServerSocketChannel</span>
        <span class="token function">init</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//хРСMainReactorц│ихЖМServerSocketChannel</span>
    <span class="token class-name">ChannelFuture</span> regFuture <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">return</span> regFuture<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ф╗ОхЗ╜цХ░хС╜хРНф╕нцИСф╗мхПпф╗ечЬЛхЗ║я╝Мш┐Щф╕кхЗ╜цХ░ф╕╗шжБхБЪчЪДф║ЛцГЕх░▒цШпщжЦхЕИхИЫх╗║<code>NioServerSocketChannel</code>я╝Мх╣╢хп╣<code>NioServerSocketChannel</code>ш┐ЫшбМхИЭхзЛхМЦя╝МцЬАхРОх░Ж<code>NioServerSocketChannel</code>ц│ихЖМхИ░<code>Main Reactor</code>ф╕нуАВ</p> <h4 id="_1-1-хИЫх╗║-nioserversocketchannel"><a href="#_1-1-хИЫх╗║-nioserversocketchannel" class="header-anchor">#</a> 1.1 хИЫх╗║ NioServerSocketChannel</h4> <p>ш┐Шшо░х╛ЧцИСф╗мхЬиф╗Лч╗Н<code>ServerBootstrap</code>хРпхКиш╛ЕхКйч▒╗щЕНч╜оцЬНхКбчлп<code>ServerSocketChannel</code>ч▒╗хЮЛчЪДцЧ╢хАЩцПРхИ░чЪДх╖ехОВч▒╗<code>ReflectiveChannelFactory</code>хРЧя╝Я</p> <p>хЫаф╕║х╜УцЧ╢цИСф╗мхЬищЕНч╜о<code>ServerBootstrap</code>хРпхКиш╛ЕхКйч▒╗чЪДцЧ╢хАЩя╝Мш┐Шц▓бхИ░хРпхКищШ╢цо╡я╝МшАМщЕНч╜ощШ╢цо╡х╣╢ф╕НцШпхИЫх╗║хЕ╖ф╜У<code>ServerSocketChannel</code>чЪДцЧ╢цЬ║уАВ</p> <p>цЙАф╗е Netty щАЪш┐З<code>х╖ехОВцибх╝П</code>х░ЖшжБхИЫх╗║чЪД<code>ServerSocketChannel</code>чЪДч▒╗хЮЛя╝ИщАЪш┐Зц│ЫхЮЛцМЗхоЪя╝Йф╗ехПК хИЫх╗║чЪДш┐ЗчиЛ(<code>х░БшгЕхЬиnewChannelхЗ╜цХ░ф╕н</code>)ч╗Яч╗ЯхЕИх░БшгЕхЬих╖ехОВч▒╗<code>ReflectiveChannelFactory</code>ф╕нуАВ</p> <blockquote><p><code>ReflectiveChannelFactory</code>щАЪш┐З<code>ц│ЫхЮЛ</code>я╝М<code>хПНх░Д</code>я╝М<code>х╖ехОВ</code>чЪДцЦ╣х╝П<code>чБ╡ц┤╗</code>хИЫх╗║ф╕НхРМч▒╗хЮЛчЪД<code>channel</code></p></blockquote> <p>чнЙх╛ЕхИЫх╗║цЧ╢цЬ║цЭеф╕┤я╝МцИСф╗мш░ГчФиф┐ЭхнШхЬи<code>ServerBootstrap</code>ф╕нчЪД<code>channelFactory</code>чЫ┤цОеш┐ЫшбМхИЫх╗║уАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReflectiveChannelFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">ChannelFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> constructor<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">newChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ChannelException</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to create Channel from class &quot;</span> <span class="token operator">+</span> constructor<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ф╕ЛщЭвцИСф╗мцЭечЬЛф╕Л<code>NioServerSocketChannel</code>чЪДцЮДх╗║ш┐ЗчиЛя╝Ъ</p> <h5 id="_1-1-1-nioserversocketchannel"><a href="#_1-1-1-nioserversocketchannel" class="header-anchor">#</a> 1.1.1 NioServerSocketChannel</h5> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NioServerSocketChannel</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractNioMessageChannel</span>
                             <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>socket<span class="token punctuation">.</span></span>ServerSocketChannel</span> <span class="token punctuation">{</span>

    <span class="token comment">//SelectorProvider(чФиф║ОхИЫх╗║SelectorхТМSelectable Channels)</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">SelectorProvider</span> <span class="token constant">DEFAULT_SELECTOR_PROVIDER</span> <span class="token operator">=</span> <span class="token class-name">SelectorProvider</span><span class="token punctuation">.</span><span class="token function">provider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token function">newSocket</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_SELECTOR_PROVIDER</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//хИЫх╗║JDK NIO ServerSocketChannel</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ServerSocketChannel</span> <span class="token function">newSocket</span><span class="token punctuation">(</span><span class="token class-name">SelectorProvider</span> provider<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> provider<span class="token punctuation">.</span><span class="token function">openServerSocketChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ChannelException</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;Failed to open a server socket.&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

     <span class="token comment">//ServerSocketChannelчЫ╕хЕ│чЪДщЕНч╜о</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ServerSocketChannelConfig</span> config<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">(</span><span class="token class-name">ServerSocketChannel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//чИ╢ч▒╗AbstractNioChannelф╕нф┐ЭхнШJDK NIOхОЯчФЯServerSocketChannelф╗ехПКшжБчЫСхРмчЪДф║Лф╗╢OP_ACCEPT</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> channel<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_ACCEPT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//DefaultChannelConfigф╕ншо╛ч╜очФиф║ОChannelцОецФ╢цХ░цНочФичЪДbuffer-&gt;AdaptiveRecvByteBufAllocator</span>
        config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioServerSocketChannelConfig</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><ul><li>щжЦхЕИш░ГчФи<code>newSocket</code>хИЫх╗║ JDK NIO хОЯчФЯ<code>ServerSocketChannel</code>я╝Мш┐ЩщЗМш░ГчФиф║Ж<code>SelectorProvider#openServerSocketChannel</code>цЭехИЫх╗║ JDK NIO хОЯчФЯ<code>ServerSocketChannel</code>я╝МцИСф╗мхЬиф╕КчпЗцЦЗчла<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247483907&amp;idx=1&amp;sn=084c470a8fe6234c2c9461b5f713ff30&amp;chksm=ce77c444f9004d52e7c6244bee83479070effb0bc59236df071f4d62e91e25f01715fca53696&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">уАКшБКшБК Netty щВгф║Ыф║ЛхД┐ф╣Л Reactor хЬи Netty ф╕нчЪДхоЮчО░(хИЫх╗║чпЗ)уАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕ншпжч╗ЖчЪДф╗Лч╗Нф║Ж<code>SelectorProvider</code>чЫ╕хЕ│хЖЕхо╣я╝Мх╜УцЧ╢цШпчФи<code>SelectorProvider</code>цЭехИЫх╗║<code>Reactor</code>ф╕нчЪД<code>Selector</code>уАВхдзхо╢ш┐Шшо░х╛ЧхРЧя╝Яя╝Я</li> <li>щАЪш┐ЗчИ╢ч▒╗цЮДщАахЩишо╛ч╜о<code>NioServerSocketChannel</code>цДЯхЕ┤ш╢гчЪД<code>IOф║Лф╗╢</code>,ш┐ЩщЗМшо╛ч╜очЪДцШп<code>SelectionKey.OP_ACCEPT</code>ф║Лф╗╢уАВх╣╢х░Ж JDK NIO хОЯчФЯ<code>ServerSocketChannel</code>х░БшгЕш╡╖цЭеуАВ</li> <li>хИЫх╗║<code>Channel</code>чЪДщЕНч╜оч▒╗<code>NioServerSocketChannelConfig</code>я╝МхЬищЕНч╜оч▒╗ф╕нх░БшгЕф║Жхп╣<code>Channelх║Хх▒В</code>чЪДф╕Аф║ЫщЕНч╜ошбМф╕║я╝Мф╗ехПК JDK ф╕нчЪД<code>ServerSocket</code>уАВф╗ехПКхИЫх╗║<code>NioServerSocketChannel</code>цОецФ╢цХ░цНочФичЪД<code>Buffer</code>хИЖщЕНхЩи<code>AdaptiveRecvByteBufAllocator</code>уАВ</li></ul> <blockquote><p><code>NioServerSocketChannelConfig</code> ц▓бф╗Аф╣ИщЗНшжБчЪДф╕Ьше┐я╝МцИСф╗мш┐ЩщЗМф╣Яф╕Нх┐Ец╖▒чй╢я╝МхоГх░▒цШпчобчРЖ<code>NioServerSocketChannel</code>чЫ╕хЕ│чЪДщЕНч╜оя╝Мш┐ЩщЗМхФпф╕АщЬАшжБхдзхо╢ц│ицДПчЪДцШпш┐Щф╕кчФиф║О<code>Channel</code>цОецФ╢цХ░цНочФичЪД<code>BufferхИЖщЕНхЩи</code> AdaptiveRecvByteBufAllocatorя╝МцИСф╗мхРОщЭвхЬиф╗Лч╗Н Netty хжВф╜ХцОецФ╢ш┐ЮцОечЪДцЧ╢хАЩш┐Шф╝ЪцПРхИ░</p></blockquote> <p><code>NioServerSocketChannel</code>чЪДцХ┤ф╜УцЮДх╗║ш┐ЗчиЛф╗Лч╗НхоМф║Жя╝МчО░хЬицИСф╗мцЭецМЙчЕзч╗зцЙ┐х▒ВцмбхЖНхЫЮш┐Зхд┤цЭечЬЛф╕Л<code>NioServerSocketChannel</code>чЪДх▒ВцмбцЮДх╗║я╝МцЭечЬЛф╕ЛцпПф╕Ах▒ВщГ╜хИЫх╗║ф║Жф╗Аф╣Ия╝Мх░БшгЕф║Жф╗Аф╣Ия╝Мш┐Щф║Ыф┐бцБпщГ╜цШп<code>Channel</code>чЪДца╕х┐Гф┐бцБпя╝МцЙАф╗ецЬЙх┐ЕшжБф║Жшзгф╕Аф╕ЛуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192109439.webp" alt="хЫ╛чЙЗ"></p> <p>хЬи<code>NioServerSocketChannel</code>чЪДхИЫх╗║ш┐ЗчиЛф╕ня╝МцИСф╗мф╕╗шжБхЕ│ц│ич╗зцЙ┐ч╗УцЮДхЫ╛ф╕нч║вцбЖцаЗц│ичЪДф╕Йф╕кч▒╗я╝МхЕ╢ф╗ЦчЪДцИСф╗мхНацЧ╢хЕИф╕НчФичобуАВ</p> <p>хЕ╢ф╕н<code>AbstractNioMessageChannelч▒╗</code>ф╕╗шжБцШпхп╣<code>NioServerSocketChannel</code>х║Хх▒Вшп╗хЖЩшбМф╕║чЪДх░БшгЕхТМхоЪф╣Йя╝МцпФхжВ accept цОецФ╢ховцИ╖члпш┐ЮцОеуАВш┐Щф╕кцИСф╗мхРОч╗нф╝Ъф╗Лч╗НхИ░я╝Мш┐ЩщЗМцИСф╗мх╣╢ф╕Нх▒Хх╝АуАВ</p> <h5 id="_1-1-2-abstractniochannel"><a href="#_1-1-2-abstractniochannel" class="header-anchor">#</a> 1.1.2 AbstractNioChannel</h5> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractNioChannel</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractChannel</span> <span class="token punctuation">{</span>
   <span class="token comment">//JDK NIOхОЯчФЯSelectable Channel</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SelectableChannel</span> ch<span class="token punctuation">;</span>
    <span class="token comment">// ChannelчЫСхРмф║Лф╗╢щЫЖхРИ ш┐ЩщЗМцШпSelectionKey.OP_ACCEPTф║Лф╗╢</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">int</span> readInterestOp<span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token class-name">AbstractNioChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> parent<span class="token punctuation">,</span> <span class="token class-name">SelectableChannel</span> ch<span class="token punctuation">,</span> <span class="token keyword">int</span> readInterestOp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ch <span class="token operator">=</span> ch<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>readInterestOp <span class="token operator">=</span> readInterestOp<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//шо╛ч╜оChannelф╕║щЭЮщШ╗хбЮ щЕНхРИIOхдЪш╖пхдНчФицибхЮЛ</span>
            ch<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>х░БшгЕчФ▒<code>SelectorProvider</code>хИЫх╗║хЗ║цЭечЪД JDK NIO хОЯчФЯ<code>ServerSocketChannel</code>уАВ</li> <li>х░БшгЕ<code>Channel</code>хЬихИЫх╗║цЧ╢цМЗхоЪцДЯхЕ┤ш╢гчЪД<code>IOф║Лф╗╢</code>я╝Мхп╣ф║О<code>NioServerSocketChannel</code>цЭешп┤цДЯхЕ┤ш╢гчЪД<code>IOф║Лф╗╢</code>ф╕║<code>OP_ACCEPTф║Лф╗╢</code>уАВ</li> <li>шо╛ч╜о JDK NIO хОЯчФЯ<code>ServerSocketChannel</code>ф╕║щЭЮщШ╗хбЮцибх╝Пя╝М щЕНхРИ IO хдЪш╖пхдНчФицибхЮЛуАВ</li></ul> <h5 id="_1-1-3-abstractchannel"><a href="#_1-1-3-abstractchannel" class="header-anchor">#</a> 1.1.3 AbstractChannel</h5> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractChannel</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultAttributeMap</span> <span class="token keyword">implements</span> <span class="token class-name">Channel</span> <span class="token punctuation">{</span>

    <span class="token comment">//channelцШпцЬЙхИЫх╗║х▒ВцмбчЪДя╝МцпФхжВServerSocketChannel цШп SocketChannelчЪД parent</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Channel</span> parent<span class="token punctuation">;</span>
    <span class="token comment">//channelхЕих▒АхФпф╕АID machineId+processId+sequence+timestamp+random</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ChannelId</span> id<span class="token punctuation">;</span>
    <span class="token comment">//unsafeчФиф║Ох░БшгЕхп╣х║Хх▒ВsocketчЪДчЫ╕хЕ│цУНф╜Ь</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Unsafe</span> unsafe<span class="token punctuation">;</span>
    <span class="token comment">//ф╕║channelхИЖщЕНчЛмчлЛчЪДpipelineчФиф║ОIOф║Лф╗╢ч╝ЦцОТ</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DefaultChannelPipeline</span> pipeline<span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token class-name">AbstractChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>
        <span class="token comment">//channelхЕих▒АхФпф╕АID machineId+processId+sequence+timestamp+random</span>
        id <span class="token operator">=</span> <span class="token function">newId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//unsafeчФиф║ОхоЪф╣ЙхоЮчО░хп╣ChannelчЪДх║Хх▒ВцУНф╜Ь</span>
        unsafe <span class="token operator">=</span> <span class="token function">newUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//ф╕║channelхИЖщЕНчЛмчлЛчЪДpipelineчФиф║ОIOф║Лф╗╢ч╝ЦцОТ</span>
        pipeline <span class="token operator">=</span> <span class="token function">newChannelPipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>Netty ф╕нчЪД<code>ChannelхИЫх╗║</code>цШпцЬЙх▒ВцмбчЪДя╝Мш┐ЩщЗМчЪД<code>parentх▒ЮцАз</code>чФицЭеф┐ЭхнШф╕Кф╕Ач║зчЪД<code>Channel</code>я╝МцпФхжВш┐ЩщЗМчЪД<code>NioServerSocketChannel</code>цШпщб╢ч║з<code>Channel</code>я╝МцЙАф╗ехоГчЪД<code>parent = null</code>уАВховцИ╖члп<code>NioSocketChannel</code>цШпчФ▒<code>NioServerSocketChannel</code>хИЫх╗║чЪДя╝МцЙАф╗ехоГчЪД<code>parent = NioServerSocketChannel</code>уАВ</li> <li>ф╕║<code>Channel</code>хИЖщЕНхЕих▒АхФпф╕АчЪД<code>ChannelId</code>уАВ<code>ChannelId</code>чФ▒цЬ║хЩи Id(<code>machineId</code>)я╝Мш┐ЫчиЛ Idя╝И<code>processId</code>я╝Йя╝Мх║ПхИЧхП╖я╝И<code>sequence</code>я╝Йя╝МцЧ╢щЧ┤цИ│я╝И<code>timestamp</code>я╝Йя╝МщЪПцЬ║цХ░я╝И<code>random</code>я╝ЙцЮДцИР</li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">DefaultChannelId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token constant">MACHINE_ID</span><span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token constant">PROCESS_ID_LEN</span> <span class="token operator">+</span> <span class="token constant">SEQUENCE_LEN</span> <span class="token operator">+</span> <span class="token constant">TIMESTAMP_LEN</span> <span class="token operator">+</span> <span class="token constant">RANDOM_LEN</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// machineId</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span><span class="token constant">MACHINE_ID</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token constant">MACHINE_ID</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    i <span class="token operator">+=</span> <span class="token constant">MACHINE_ID</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token comment">// processId</span>
    i <span class="token operator">=</span> <span class="token function">writeInt</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token constant">PROCESS_ID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// sequence</span>
    i <span class="token operator">=</span> <span class="token function">writeInt</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> nextSequence<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// timestamp (kind of)</span>
    i <span class="token operator">=</span> <span class="token function">writeLong</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// random</span>
    <span class="token keyword">int</span> random <span class="token operator">=</span> <span class="token class-name">PlatformDependent</span><span class="token punctuation">.</span><span class="token function">threadLocalRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    i <span class="token operator">=</span> <span class="token function">writeInt</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> random<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span> i <span class="token operator">==</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    hashCode <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>хИЫх╗║<code>NioServerSocketChannel</code>чЪДх║Хх▒ВцУНф╜Ьч▒╗<code>Unsafe</code>уАВш┐ЩщЗМхИЫх╗║чЪДцШп<code>io.netty.channel.nio.AbstractNioMessageChannel.NioMessageUnsafe</code>уАВ</li></ul> <blockquote><p><code>Unsafe</code>ф╕║<code>ChannelцОехПг</code>чЪДф╕Аф╕кхЖЕщГицОехПгя╝МчФиф║ОхоЪф╣ЙхоЮчО░хп╣ Channel х║Хх▒ВчЪДхРДчзНцУНф╜Ья╝М<code>UnsafeцОехПг</code>хоЪф╣ЙчЪДцУНф╜ЬшбМф╕║хПкшГ╜чФ▒ Netty цбЖцЮ╢чЪД<code>Reactorч║┐чиЛ</code>ш░ГчФия╝МчФицИ╖ч║┐чиЛчжБцнвш░ГчФиуАВ</p></blockquote> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">interface</span> <span class="token class-name">Unsafe</span> <span class="token punctuation">{</span>

    <span class="token comment">//хИЖщЕНцОецФ╢цХ░цНочФичЪДBuffer</span>
    <span class="token class-name">RecvByteBufAllocator<span class="token punctuation">.</span>Handle</span> <span class="token function">recvBufAllocHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//цЬНхКбчлпч╗СхоЪчЪДчлпхПгхЬ░хЭА</span>
    <span class="token class-name">SocketAddress</span> <span class="token function">localAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//ш┐ЬчлпхЬ░хЭА</span>
    <span class="token class-name">SocketAddress</span> <span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//channelхРСReactorц│ихЖМ</span>
    <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">EventLoop</span> eventLoop<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//цЬНхКбчлпч╗СхоЪчлпхПгхЬ░хЭА</span>
    <span class="token keyword">void</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//ховцИ╖члпш┐ЮцОецЬНхКбчлп</span>
    <span class="token keyword">void</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">SocketAddress</span> remoteAddress<span class="token punctuation">,</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//хЕ│щЧн channel</span>
    <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//шп╗цХ░цНо</span>
    <span class="token keyword">void</span> <span class="token function">beginRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//хЖЩцХ░цНо</span>
    <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><ul><li>ф╕║<code>NioServerSocketChannel</code>хИЖщЕНчЛмчлЛчЪД<code>pipeline</code>чФиф║О IO ф║Лф╗╢ч╝ЦцОТуАВ<code>pipeline</code>хЕ╢хоЮцШпф╕Аф╕к<code>ChannelHandlerContext</code>ч▒╗хЮЛчЪДхПМхРСщУ╛шбиуАВхд┤ч╗УчВ╣<code>HeadContext</code>,х░╛ч╗УчВ╣<code>TailContext</code>уАВ<code>ChannelHandlerContext</code>ф╕нхМЕшгЕчЭА<code>ChannelHandler</code>уАВ</li></ul> <blockquote><p><code>ChannelHandlerContext</code>ф┐ЭхнШ ChannelHandler ф╕Кф╕ЛцЦЗф┐бцБпя╝МчФиф║Оф║Лф╗╢ф╝ацТнуАВхРОщЭвчмФшАЕф╝ЪхНХчЛмх╝Аф╕АчпЗцЦЗчлаф╗Лч╗Ня╝Мш┐ЩщЗМцИСф╗мш┐ШцШпшБЪчДжф║ОхРпхКиф╕╗ч║┐уАВ</p></blockquote> <p>ш┐ЩщЗМхПкцШпф╕║ф║Жшойхдзхо╢чоАхНХчРЖшзг<code>pipeline</code>чЪДф╕Аф╕кхдзшЗ┤чЪДч╗УцЮДя╝МхРОщЭвф╝ЪхЖЩф╕АчпЗцЦЗчлаф╕УщЧишпжч╗Жшо▓шзг<code>pipeline</code>уАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">DefaultChannelPipeline</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>channel <span class="token operator">=</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token string">&quot;channel&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    succeededFuture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SucceededChannelFuture</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    voidPromise <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">VoidChannelPromise</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    tail <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TailContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    head <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HeadContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    head<span class="token punctuation">.</span>next <span class="token operator">=</span> tail<span class="token punctuation">;</span>
    tail<span class="token punctuation">.</span>prev <span class="token operator">=</span> head<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192045373.webp" alt="хЫ╛чЙЗ"></p> <hr> <p>хИ░ф║Жш┐ЩщЗМ<code>NioServerSocketChannel</code>х░▒хИЫх╗║хоМцпХф║Жя╝МцИСф╗мцЭехЫЮщб╛ф╕ЛхоГхИ░х║ХхМЕхРлф║ЖхУкф║Ыца╕х┐Гф┐бцБпуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192152874.webp" alt="хЫ╛чЙЗ"></p> <h4 id="_1-2-хИЭхзЛхМЦ-nioserversocketchannel"><a href="#_1-2-хИЭхзЛхМЦ-nioserversocketchannel" class="header-anchor">#</a> 1.2 хИЭхзЛхМЦ NioServerSocketChannel</h4> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//хРСNioServerSocketChannelConfigшо╛ч╜оServerSocketChannelOption</span>
    <span class="token function">setChannelOptions</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token function">newOptionsArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> logger<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//хРСnettyшЗкхоЪф╣ЙчЪДNioServerSocketChannelшо╛ч╜оattributes</span>
    <span class="token function">setAttributes</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token function">attrs0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token constant">EMPTY_ATTRIBUTE_ARRAY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//шО╖хПЦф╗ОReactorч║┐чиЛч╗Д</span>
    <span class="token keyword">final</span> <span class="token class-name">EventLoopGroup</span> currentChildGroup <span class="token operator">=</span> childGroup<span class="token punctuation">;</span>
    <span class="token comment">//шО╖хПЦчФиф║ОхИЭхзЛхМЦховцИ╖члпNioSocketChannelчЪДChannelInitializer</span>
    <span class="token keyword">final</span> <span class="token class-name">ChannelHandler</span> currentChildHandler <span class="token operator">=</span> childHandler<span class="token punctuation">;</span>
    <span class="token comment">//шО╖хПЦчФицИ╖щЕНч╜очЪДховцИ╖члпSocketChannelчЪДchannelOptionф╗ехПКattributes</span>
    <span class="token keyword">final</span> <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelOption</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> currentChildOptions<span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>childOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        currentChildOptions <span class="token operator">=</span> childOptions<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token constant">EMPTY_OPTION_ARRAY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">final</span> <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttributeKey</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> currentChildAttrs <span class="token operator">=</span> childAttrs<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token constant">EMPTY_ATTRIBUTE_ARRAY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//хРСNioServerSocketChannelф╕нчЪДpipelineц╖╗хКахИЭхзЛхМЦChannelHandlerчЪДщА╗ш╛С</span>
    p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Channel</span> ch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//ServerBootstrapф╕нчФицИ╖цМЗхоЪчЪДchannelHandler</span>
            <span class="token class-name">ChannelHandler</span> handler <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//LoggingHandler</span>
                pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//ц╖╗хКачФиф║ОцОецФ╢ховцИ╖члпш┐ЮцОечЪДacceptor</span>
            ch<span class="token punctuation">.</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServerBootstrapAcceptor</span><span class="token punctuation">(</span>
                        ch<span class="token punctuation">,</span> currentChildGroup<span class="token punctuation">,</span> currentChildHandler<span class="token punctuation">,</span> currentChildOptions<span class="token punctuation">,</span> currentChildAttrs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>хРС<code>NioServerSocketChannelConfig</code>шо╛ч╜о<code>ServerSocketChannelOption</code>уАВ</li> <li>хРС netty шЗкхоЪф╣ЙчЪД<code>NioServerSocketChannel</code>шо╛ч╜о<code>ChannelAttributes</code></li></ul> <p>Netty шЗкхоЪф╣ЙчЪД<code>SocketChannel</code>ч▒╗хЮЛхЭЗч╗зцЙ┐<code>AttributeMap</code>цОехПгф╗ехПК<code>DefaultAttributeMap</code>ч▒╗я╝МцнгцШпхоГф╗мхоЪф╣Йф║Ж<code>ChannelAttributes</code>уАВчФиф║ОхРС<code>Channel</code>ц╖╗хКачФицИ╖шЗкхоЪф╣ЙчЪДф╕Аф║Ыф┐бцБпуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192113913.webp" alt="хЫ╛чЙЗ"></p> <blockquote><p>ш┐Щф╕к<code>ChannelAttributes</code>чЪДчФихдДхдзцЬЙхПпф╕║я╝МNetty хРОш╛╣чЪДшо╕хдЪчЙ╣цАзщГ╜цШпф╛ЭщЭаш┐Щф╕к<code>ChannelAttributes</code>цЭехоЮчО░чЪДуАВш┐ЩщЗМхЕИхНЦф╕кхЕ│хнРя╝Мхдзхо╢хПпф╗ешЗкх╖▒хЕИцГ│ф╕Аф╕ЛхПпф╗ечФиш┐Щф╕к<code>ChannelAttributes</code>хБЪхУкф║Ыф║ЛцГЕя╝Я</p></blockquote> <ul><li>шО╖хПЦф╗О Reactor ч║┐чиЛч╗Д<code>childGroup</code>я╝Мф╗ехПКчФиф║ОхИЭхзЛхМЦховцИ╖члп<code>NioSocketChannel</code>чЪД<code>ChannelInitializer</code>,<code>ChannelOption</code>,<code>ChannelAttributes</code>я╝Мш┐Щф║Ыф┐бцБпхЭЗцШпчФ▒чФицИ╖хЬихРпхКичЪДцЧ╢хАЩхРС<code>ServerBootstrap</code>ц╖╗хКачЪДховцИ╖члп<code>NioServerChannel</code>щЕНч╜оф┐бцБпуАВш┐ЩщЗМчФиш┐Щф║Ыф┐бцБпцЭехИЭхзЛхМЦ<code>ServerBootstrapAcceptor</code>уАВхЫаф╕║хРОч╗нф╝ЪхЬи<code>ServerBootstrapAcceptor</code>ф╕нцОецФ╢ховцИ╖члпш┐ЮцОеф╗ехПКхИЫх╗║<code>NioServerChannel</code>уАВ</li> <li>хРС<code>NioServerSocketChannel</code>ф╕нчЪД<code>pipeline</code>ц╖╗хКачФиф║ОхИЭхзЛхМЦ<code>pipeline</code>чЪД<code>ChannelInitializer</code>уАВ</li></ul> <p><strong>щЧощвШцЭеф║Жя╝Мш┐ЩщЗМф╕║ф╗Аф╣Иф╕Нх╣▓шДЖчЫ┤цОех░Ж<code>ChannelHandler</code>ц╖╗хКахИ░<code>pipeline</code>ф╕ня╝МшАМцШпхПИф╜┐чФихИ░ф║Ж<code>ChannelInitializer</code>хСвя╝Я</strong></p> <p>хЕ╢хоЮхОЯхЫацЬЙф╕дчВ╣я╝Ъ</p> <ul><li>ф╕║ф║Жф┐ЭшпБ<code>ч║┐чиЛхоЙхЕи</code>хЬ░хИЭхзЛхМЦ<code>pipeline</code>я╝МцЙАф╗ехИЭхзЛхМЦчЪДхКиф╜ЬщЬАшжБчФ▒<code>Reactorч║┐чиЛ</code>ш┐ЫшбМя╝МшАМх╜УхЙНч║┐чиЛцШп<code>чФицИ╖чиЛх║П</code>чЪД<code>хРпхКиMainч║┐чиЛ</code> х╣╢<code>ф╕НцШп</code>Reactor ч║┐чиЛуАВш┐ЩщЗМф╕НшГ╜члЛхН│хИЭхзЛхМЦуАВ</li> <li>хИЭхзЛхМЦ<code>Channel</code>ф╕н<code>pipeline</code>чЪДхКиф╜Ья╝МщЬАшжБчнЙхИ░<code>Channel</code>ц│ихЖМхИ░хп╣х║ФчЪД<code>Reactor</code>ф╕нцЙНхПпф╗еш┐ЫшбМхИЭхзЛхМЦя╝Мх╜УхЙНхПкцШпхИЫх╗║хе╜ф║Ж<code>NioServerSocketChannel</code>я╝Мф╜Жх╣╢цЬкц│ихЖМхИ░<code>Main Reactor</code>ф╕КуАВ</li></ul> <blockquote><p>хИЭхзЛхМЦ<code>NioServerSocketChannel</code>ф╕н<code>pipeline</code>чЪДцЧ╢цЬ║цШпя╝Ъх╜У<code>NioServerSocketChannel</code>ц│ихЖМхИ░<code>Main Reactor</code>ф╣ЛхРОя╝Мч╗СхоЪчлпхПгхЬ░хЭАф╣ЛхЙНуАВ</p></blockquote> <blockquote><p>хЙНш╛╣хЬиф╗Лч╗Н<code>ServerBootstrap</code>щЕНч╜о<code>childHandler</code>цЧ╢ф╣ЯчФихИ░ф║Ж<code>ChannelInitializer</code>я╝Мш┐Шшо░х╛ЧхРЧя╝Яя╝Я</p></blockquote> <p><strong>щЧощвШхПИцЭеф║Жя╝Мхдзхо╢ц│ицДПф╕Л<code>ChannelInitializer#initChannel</code>цЦ╣ц│Хя╝МхЬишпехИЭхзЛхМЦхЫЮш░ГцЦ╣ц│Хф╕ня╝Мц╖╗хКа LoggingHandler цШпчЫ┤цОехРС pipeline ф╕нц╖╗хКая╝МшАМц╖╗хКа Acceptor ф╕║ф╗Аф╣Иф╕НцШпчЫ┤цОец╖╗хКашАМцШпх░БшгЕцИРх╝Вцнеф╗╗хКбхСвя╝Я</strong></p> <p>ш┐ЩщЗМхЕИч╗Щхдзхо╢хНЦф╕кхЕ│хнРя╝МчмФшАЕф╝ЪхЬихРОч╗нц╡БчиЛф╕нф╕║хдзхо╢шзгчнФ</p> <p>цндцЧ╢<code>NioServerSocketChannel</code>ф╕нчЪД<code>pipeline</code>ч╗УцЮДхжВф╕ЛхЫ╛цЙАчд║я╝Ъ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192116825.webp" alt="хЫ╛чЙЗ"></p> <h4 id="_1-3-хРС-main-reactor-ц│ихЖМ-nioserversocketchannel"><a href="#_1-3-хРС-main-reactor-ц│ихЖМ-nioserversocketchannel" class="header-anchor">#</a> 1.3 хРС Main Reactor ц│ихЖМ NioServerSocketChannel</h4> <p>ф╗О<code>ServerBootstrap</code>шО╖хПЦф╕╗ Reactor ч║┐чиЛч╗Д<code>NioEventLoopGroup</code>я╝Мх░Ж<code>NioServerSocketChannel</code>ц│ихЖМхИ░<code>NioEventLoopGroup</code>ф╕нуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">ChannelFuture</span> regFuture <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ф╕ЛщЭвцИСф╗мцЭечЬЛф╕ЛхЕ╖ф╜УчЪДц│ихЖМш┐ЗчиЛя╝Ъ</p> <h5 id="_1-3-1-ф╕╗-reactor-ч║┐чиЛч╗Дф╕нщАЙхПЦф╕Аф╕к-main-reactor-ш┐ЫшбМц│ихЖМ"><a href="#_1-3-1-ф╕╗-reactor-ч║┐чиЛч╗Дф╕нщАЙхПЦф╕Аф╕к-main-reactor-ш┐ЫшбМц│ихЖМ" class="header-anchor">#</a> 1.3.1 ф╕╗ Reactor ч║┐чиЛч╗Дф╕нщАЙхПЦф╕Аф╕к Main Reactor ш┐ЫшбМц│ихЖМ</h5> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192118790.webp" alt="хЫ╛чЙЗ"></p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">EventExecutor</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> chooser<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//шО╖хПЦч╗СхоЪчнЦчХе</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">EventExecutorChooser</span> <span class="token function">newChooser</span><span class="token punctuation">(</span><span class="token class-name">EventExecutor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> executors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPowerOfTwo</span><span class="token punctuation">(</span>executors<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PowerOfTwoEventExecutorChooser</span><span class="token punctuation">(</span>executors<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">GenericEventExecutorChooser</span><span class="token punctuation">(</span>executors<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//щЗЗчФиш╜ошпвround-robinчЪДцЦ╣х╝ПщАЙцЛйReactor</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">EventExecutor</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> executors<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>idx<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> executors<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Netty щАЪш┐З<code>next()</code>цЦ╣ц│Хца╣цНоф╕КчпЗцЦЗчла<a href="/pages/440035/">уАКчммф║Мшп╛я╝ЪReator хЬи Netty ф╕нчЪДхоЮчО░я╝ИхИЫх╗║чпЗя╝ЙуАЛ</a>цПРхИ░чЪД<code>channelхИ░reactorчЪДч╗СхоЪчнЦчХе</code>я╝Мф╗О<code>ReactorGroup</code>ф╕нщАЙхПЦф╕Аф╕к Reactor ш┐ЫшбМц│ихЖМч╗СхоЪуАВф╣ЛхРО<code>Channel</code>чФЯхС╜хСицЬЯхЖЕчЪДцЙАцЬЙ<code>IO ф║Лф╗╢</code>щГ╜чФ▒ш┐Щф╕к<code>Reactor</code> ш┤Яш┤гхдДчРЖя╝МхжВ <code>acceptуАБconnectуАБreadуАБwrite</code>чнЙ IO ф║Лф╗╢уАВ</p> <blockquote><p>ф╕Аф╕к<code>channel</code>хПкшГ╜ч╗СхоЪхИ░ф╕Аф╕к<code>Reactor</code>ф╕Кя╝Мф╕Аф╕к<code>Reactor</code>ш┤Яш┤гчЫСхРм<code>хдЪф╕кchannel</code>уАВ</p></blockquote> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192120627.webp" alt="хЫ╛чЙЗ"></p> <blockquote><p>чФ▒ф║Ош┐ЩщЗМцШп<code>NioServerSocketChannle</code>хРС<code>Main Reactor</code>ш┐ЫшбМц│ихЖМч╗СхоЪя╝МцЙАф╗е<code>Main Reactor</code>ф╕╗шжБш┤Яш┤гхдДчРЖчЪД<code>IOф║Лф╗╢</code>цШп<code>OP_ACCEPT</code>ф║Лф╗╢уАВ</p></blockquote> <h5 id="_1-3-2-хРСч╗СхоЪхРОчЪД-main-reactor-ш┐ЫшбМц│ихЖМ"><a href="#_1-3-2-хРСч╗СхоЪхРОчЪД-main-reactor-ш┐ЫшбМц│ихЖМ" class="header-anchor">#</a> 1.3.2 хРСч╗СхоЪхРОчЪД Main Reactor ш┐ЫшбМц│ихЖМ</h5> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192121925.webp" alt="хЫ╛чЙЗ"></p> <p>хРС<code>Reactor</code>ш┐ЫшбМц│ихЖМчЪДшбМф╕║хоЪф╣ЙхЬи<code>NioEventLoop</code>чЪДчИ╢ч▒╗<code>SingleThreadEventLoop</code>ф╕ня╝МхН░ш▒бцибч│КчЪДхРМхнжхПпф╗ехЬихЫЮчЬЛф╕Лф╕КчпЗцЦЗчлаф╕нчЪД<code>NioEventLoopч╗зцЙ┐ч╗УцЮД</code>х░ПшКВхЖЕхо╣</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SingleThreadEventLoop</span> <span class="token keyword">extends</span> <span class="token class-name">SingleThreadEventExecutor</span> <span class="token keyword">implements</span> <span class="token class-name">EventLoop</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//ц│ихЖМchannelхИ░ч╗СхоЪчЪДReactorф╕К</span>
        <span class="token keyword">return</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultChannelPromise</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> <span class="token string">&quot;promise&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//unsafeш┤Яш┤гchannelх║Хх▒ВчЪДхРДчзНцУНф╜Ь</span>
        promise<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>щАЪш┐З<code>NioServerSocketChannel</code>ф╕нчЪД<code>Unsafeч▒╗</code>цЙзшбМх║Хх▒ВхЕ╖ф╜УчЪДц│ихЖМхКиф╜ЬуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractUnsafe</span> <span class="token keyword">implements</span> <span class="token class-name">Unsafe</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
    * ц│ихЖМChannelхИ░ч╗СхоЪчЪДReactorф╕К
    * */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">EventLoop</span> eventLoop<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>eventLoop<span class="token punctuation">,</span> <span class="token string">&quot;eventLoop&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            promise<span class="token punctuation">.</span><span class="token function">setFailure</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;registered to an event loop already&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//EventLoopчЪДч▒╗хЮЛшжБф╕ОChannelчЪДч▒╗хЮЛф╕Аца╖  Nio Oio Aio</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isCompatible</span><span class="token punctuation">(</span>eventLoop<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            promise<span class="token punctuation">.</span><span class="token function">setFailure</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;incompatible event loop type: &quot;</span> <span class="token operator">+</span> eventLoop<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//хЬиchannelф╕Кшо╛ч╜оч╗СхоЪчЪДReactor</span>
        <span class="token class-name">AbstractChannel</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventLoop <span class="token operator">=</span> eventLoop<span class="token punctuation">;</span>

        <span class="token comment">/**
         * цЙзшбМchannelц│ихЖМчЪДцУНф╜Ьх┐Ещб╗цШпReactorч║┐чиЛцЭехоМцИР
         *
         * 1: хжВцЮЬх╜УхЙНцЙзшбМч║┐чиЛцШпReactorч║┐чиЛя╝МхИЩчЫ┤цОецЙзшбМregister0ш┐ЫшбМц│ихЖМ
         * 2я╝ЪхжВцЮЬх╜УхЙНцЙзшбМч║┐чиЛцШпхдЦщГич║┐чиЛя╝МхИЩщЬАшжБх░Жregister0ц│ихЖМцУНф╜Ь х░БшгЕчиЛх╝ВцнеTask чФ▒Reactorч║┐чиЛцЙзшбМ
         **/</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>eventLoop<span class="token punctuation">.</span><span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">register0</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                eventLoop<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">register0</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>щжЦхЕИцгАцЯе <code>NioServerSocketChannel</code> цШпхРжх╖▓ч╗ПхоМцИРц│ихЖМуАВхжВцЮЬф╗ехоМцИРц│ихЖМя╝МхИЩчЫ┤цОешо╛ч╜оф╗гшбиц│ихЖМцУНф╜Ьч╗УцЮЬчЪД<code>ChannelPromise</code>ф╕║<code>failчК╢цАБ</code>уАВ</li> <li>щАЪш┐З<code>isCompatible</code>цЦ╣ц│ХщкМшпБ Reactor цибхЮЛ<code>EventLoop</code>цШпхРжф╕О<code>Channel</code>чЪДч▒╗хЮЛхМ╣щЕНуАВ<code>NioEventLoop</code>хп╣х║Фф║О<code>NioServerSocketChannel</code>уАВ</li></ul> <blockquote><p>ф╕КчпЗцЦЗчлацИСф╗мф╗Лч╗Нш┐З Netty хп╣ф╕ЙчзН<code>IOцибхЮЛ</code>я╝Ъ<code>Oio,Nio,Aio</code>чЪДцФпцМБя╝МчФицИ╖хПпф╗ещАЪш┐ЗцФ╣хПШ Netty ца╕х┐Гч▒╗чЪДхЙНч╝Аш╜╗цЭ╛хИЗцНв<code>IOцибхЮЛ</code>уАВ<code>isCompatible</code>цЦ╣ц│ХчЫочЪДх░▒цШпщЬАшжБф┐ЭшпБ<code>Reactor</code>хТМ<code>Channel</code>ф╜┐чФичЪДцШпхРМф╕АчзН<code>IOцибхЮЛ</code>уАВ</p></blockquote> <ul><li><p>хЬи<code>Channel</code>ф╕нф┐ЭхнШхЕ╢ч╗СхоЪчЪД<code>ReactorхоЮф╛Л</code>уАВ</p></li> <li><p>цЙзшбМ<code>Channel</code>хРС<code>Reactor</code>ц│ихЖМчЪДхКиф╜Ьх┐Ещб╗шжБчбоф┐ЭцШпхЬи<code>Reactorч║┐чиЛ</code>ф╕нцЙзшбМуАВ</p></li> <li><ul><li>хжВцЮЬх╜УхЙНч║┐чиЛцШп<code>Reactorч║┐чиЛ</code>хИЩчЫ┤цОецЙзшбМц│ихЖМхКиф╜Ь<code>register0</code></li> <li>хжВцЮЬх╜УхЙНч║┐чиЛф╕НцШп<code>Reactorч║┐чиЛ</code>я╝МхИЩщЬАшжБх░Жц│ихЖМхКиф╜Ь<code>register0</code>х░БшгЕцИРх╝Вцнеф╗╗хКбя╝МхнШцФ╛хЬи<code>Reactor</code>ф╕нчЪД<code>taskQueue</code>ф╕ня╝МчнЙх╛Е<code>Reactorч║┐чиЛ</code>цЙзшбМуАВ</li></ul></li></ul> <blockquote><p>х╜УхЙНцЙзшбМч║┐чиЛх╣╢ф╕НцШп<code>Reactorч║┐чиЛ</code>я╝МшАМцШпчФицИ╖чиЛх║ПчЪДхРпхКич║┐чиЛ<code>Mainч║┐чиЛ</code>уАВ</p></blockquote> <h5 id="_1-3-3-reactor-ч║┐чиЛчЪДхРпхКи"><a href="#_1-3-3-reactor-ч║┐чиЛчЪДхРпхКи" class="header-anchor">#</a> 1.3.3 Reactor ч║┐чиЛчЪДхРпхКи</h5> <p>ф╕КчпЗцЦЗчлаф╕нцИСф╗мхЬиф╗Лч╗Н<code>NioEventLoopGroup</code>чЪДхИЫх╗║ш┐ЗчиЛф╕нцПРхИ░ф║Жф╕Аф╕кцЮДщАахЩихПВцХ░<code>executor</code>я╝МхоГчФиф║ОхРпхКи<code>Reactorч║┐чиЛ</code>я╝Мч▒╗хЮЛф╕║<code>ThreadPerTaskExecutor</code>уАВ</p> <p>х╜УцЧ╢чмФшАЕхРСхдзхо╢хНЦф║Жф╕Аф╕кхЕ│хнР~~<code>тАЬReactor ч║┐чиЛцШпф╜ХцЧ╢хРпхКичЪД?тАЭ</code></p> <p>щВгф╣ИчО░хЬих░▒хИ░ф║Жф╕║хдзхо╢цПнцЩУш░Ьх║ХчЪДцЧ╢хАЩф║Ж~~</p> <p><strong><code>Reactorч║┐чиЛ</code> чЪДхРпхКицШпхЬихРС <code>Reactor</code> цПРф║дчммф╕Аф╕кх╝Вцнеф╗╗хКбчЪДцЧ╢хАЩхРпхКичЪДуАВ</strong></p> <p>Netty ф╕нчЪДф╕╗ Reactor ч║┐чиЛч╗Д<code>NioEventLoopGroup</code>ф╕нчЪД Main Reactor <code>NioEventLoop</code>цШпхЬичФицИ╖чиЛх║П<code>Mainч║┐чиЛ</code>хРС<code>Main Reactor</code>цПРф║дчФиф║Оц│ихЖМ<code>NioServerSocketChannel</code>чЪДх╝Вцнеф╗╗хКбцЧ╢х╝АхзЛхРпхКи</p> <div class="language-Java extra-class"><pre class="language-java"><code>eventLoop<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">register0</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>цОеф╕ЛцЭецИСф╗мхЕ│ц│иф╕Л<code>NioEventLoop</code>чЪД<code>executeцЦ╣ц│Х</code></p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SingleThreadEventExecutor</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractScheduledEventExecutor</span> <span class="token keyword">implements</span> <span class="token class-name">OrderedEventExecutor</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token string">&quot;task&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">execute</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token operator">!</span><span class="token punctuation">(</span>task <span class="token keyword">instanceof</span> <span class="token class-name">LazyRunnable</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">wakesUpForTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> task<span class="token punctuation">,</span> <span class="token keyword">boolean</span> immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//х╜УхЙНч║┐чиЛцШпхРжф╕║Reactorч║┐чиЛ</span>
        <span class="token keyword">boolean</span> inEventLoop <span class="token operator">=</span> <span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//addTaskWakesUp = true addTaskхФдщЖТReactorч║┐чиЛцЙзшбМф╗╗хКб</span>
        <span class="token function">addTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inEventLoop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//хжВцЮЬх╜УхЙНч║┐чиЛф╕НцШпReactorч║┐чиЛя╝МхИЩхРпхКиReactorч║┐чиЛ</span>
            <span class="token comment">//ш┐ЩщЗМхПпф╗ечЬЛхЗ║Reactorч║┐чиЛчЪДхРпхКицШпщАЪш┐З хРСNioEventLoopц╖╗хКах╝Вцнеф╗╗хКбцЧ╢хРпхКичЪД</span>
            <span class="token function">startThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><ul><li>щжЦхЕИх░Жх╝Вцнеф╗╗хКб<code>task</code>ц╖╗хКахИ░<code>Reactor</code>ф╕нчЪД<code>taskQueue</code>ф╕нуАВ</li> <li>хИдцЦнх╜УхЙНч║┐чиЛцШпхРжф╕║<code>Reactorч║┐чиЛ</code>я╝МцндцЧ╢х╜УхЙНцЙзшбМч║┐чиЛф╕║чФицИ╖чиЛх║ПхРпхКич║┐чиЛя╝МцЙАф╗еш┐ЩщЗМш░ГчФи<code>startThread</code>хРпхКи<code>Reactorч║┐чиЛ</code>уАВ</li></ul> <h5 id="_1-3-4-startthread"><a href="#_1-3-4-startthread" class="header-anchor">#</a> 1.3.4 startThread</h5> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SingleThreadEventExecutor</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractScheduledEventExecutor</span> <span class="token keyword">implements</span> <span class="token class-name">OrderedEventExecutor</span> <span class="token punctuation">{</span>
    <span class="token comment">//хоЪф╣ЙReactorч║┐чиЛчК╢цАБ</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">ST_NOT_STARTED</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">ST_STARTED</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">ST_SHUTTING_DOWN</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">ST_SHUTDOWN</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">ST_TERMINATED</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

     <span class="token comment">//Reactorч║┐чиЛчК╢цАБ  хИЭхзЛф╕║ цЬкхРпхКичК╢цАБ</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> state <span class="token operator">=</span> <span class="token constant">ST_NOT_STARTED</span><span class="token punctuation">;</span>

    <span class="token comment">//Reactorч║┐чиЛчК╢цАБхнЧцо╡ state хОЯхнРцЫ┤цЦ░хЩи</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AtomicIntegerFieldUpdater</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SingleThreadEventExecutor</span><span class="token punctuation">&gt;</span></span> <span class="token constant">STATE_UPDATER</span> <span class="token operator">=</span>
    <span class="token class-name">AtomicIntegerFieldUpdater</span><span class="token punctuation">.</span><span class="token function">newUpdater</span><span class="token punctuation">(</span><span class="token class-name">SingleThreadEventExecutor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;state&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token constant">ST_NOT_STARTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">STATE_UPDATER</span><span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">ST_NOT_STARTED</span><span class="token punctuation">,</span> <span class="token constant">ST_STARTED</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">boolean</span> success <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token function">doStartThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    success <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token constant">STATE_UPDATER</span><span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">ST_STARTED</span><span class="token punctuation">,</span> <span class="token constant">ST_NOT_STARTED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>Reactorч║┐чиЛ</code>хИЭхзЛхМЦчК╢цАБф╕║<code>ST_NOT_STARTED</code>,щжЦхЕИ<code>CAS</code>цЫ┤цЦ░чК╢цАБф╕║<code>ST_STARTED</code></li> <li><code>doStartThread</code>хРпхКи<code>Reactorч║┐чиЛ</code></li> <li>хРпхКихд▒ш┤ечЪДшпЭя╝МщЬАшжБх░Ж<code>Reactorч║┐чиЛ</code>чК╢цАБцФ╣хЫЮ<code>ST_NOT_STARTED</code></li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">//ThreadPerTaskExecutor чФиф║ОхРпхКиReactorч║┐чиЛ</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doStartThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span> thread <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            thread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>interrupted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                thread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">boolean</span> success <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token function">updateLastExecutionTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//Reactor ч║┐чиЛх╝АхзЛхРпхКи</span>
                <span class="token class-name">SingleThreadEventExecutor</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                success <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ш┐ЩщЗМх░▒цЭехИ░ф║Ж<code>ThreadPerTaskExecutor</code>ч▒╗хЮЛчЪД<code>executor</code>чЪДчФицнжф╣ЛхЬ░ф║ЖуАВ</p> <ul><li><code>Reactorч║┐чиЛ</code>чЪДца╕х┐Гх╖еф╜Ьф╣ЛхЙНф╗Лч╗Нш┐Зя╝Ъ<code>ш╜ошпвцЙАцЬЙц│ихЖМхЕ╢ф╕КчЪДChannelф╕нчЪДIOх░▒ч╗кф║Лф╗╢</code>я╝М<code>хдДчРЖхп╣х║ФChannelф╕КчЪДIOф║Лф╗╢</code>я╝М<code>цЙзшбМх╝Вцнеф╗╗хКб</code>уАВNetty х░Жш┐Щф║Ыца╕х┐Гх╖еф╜Ьх░БшгЕхЬи<code>io.netty.channel.nio.NioEventLoop#run</code>цЦ╣ц│Хф╕нуАВ</li></ul> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192046829.webp" alt="хЫ╛чЙЗ"></p> <ul><li>х░Ж<code>NioEventLoop#run</code>х░БшгЕхЬих╝Вцнеф╗╗хКбф╕ня╝МцПРф║дч╗Щ<code>executor</code>цЙзшбМя╝М<code>Reactor</code>ч║┐чиЛшЗ│цндх╝АхзЛх╖еф╜Ьф║Жх░▒уАВ</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPerTaskExecutor</span> <span class="token keyword">implements</span> <span class="token class-name">Executor</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//хРпхКиReactorч║┐чиЛ</span>
        threadFactory<span class="token punctuation">.</span><span class="token function">newThread</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цндцЧ╢<code>Reactorч║┐чиЛ</code>х╖▓ч╗ПхРпхКия╝М<strong>хРОщЭвчЪДх╖еф╜ЬхЕищГищГ╜чФ▒ш┐Щф╕к<code>Reactorч║┐чиЛ</code>цЭеш┤Яш┤гцЙзшбМф║ЖуАВ</strong></p> <p>шАМчФицИ╖хРпхКич║┐чиЛхЬихРС<code>Reactor</code>цПРф║дхоМ<code>NioServerSocketChannel</code>чЪДц│ихЖМф╗╗хКб<code>register0</code>хРОя╝Мх░▒щАРцнещААхЗ║ш░ГчФихаЖцаИя╝МхЫЮщААхИ░цЬАх╝АхзЛчЪДхРпхКихЕехПгхдД<code>ChannelFuture f = b.bind(PORT).sync()</code></p> <p>цндцЧ╢<code>Reactor</code>ф╕нчЪДф╗╗хКбщШЯхИЧф╕нхПкцЬЙф╕Аф╕кф╗╗хКб<code>register0</code>я╝М<code>Reactorч║┐чиЛ</code>хРпхКихРОя╝Мф╝Ъф╗Оф╗╗хКбщШЯхИЧф╕нхПЦхЗ║ф╗╗хКбцЙзшбМуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192046152.webp" alt="хЫ╛чЙЗ"></p> <p>шЗ│цнд<code>NioServerSocketChannel</code>чЪДц│ихЖМх╖еф╜Ьцнгх╝ПцЛЙх╝Ах╕╖х╣Х~~</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192046799.webp" alt="хЫ╛чЙЗ"></p> <h5 id="_1-3-5-register0"><a href="#_1-3-5-register0" class="header-anchor">#</a> 1.3.5 register0</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//true if the channel has never been registered, false otherwise</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> neverRegistered <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">register0</span><span class="token punctuation">(</span><span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//цЯечЬЛц│ихЖМцУНф╜ЬцШпхРжх╖▓ч╗ПхПЦц╢Ия╝МцИЦшАЕхп╣х║Фchannelх╖▓ч╗ПхЕ│щЧн</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>promise<span class="token punctuation">.</span><span class="token function">setUncancellable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">ensureOpen</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">boolean</span> firstRegistration <span class="token operator">=</span> neverRegistered<span class="token punctuation">;</span>
        <span class="token comment">//цЙзшбМчЬЯцнгчЪДц│ихЖМцУНф╜Ь</span>
        <span class="token function">doRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//ф┐оцФ╣ц│ихЖМчК╢цАБ</span>
        neverRegistered <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        registered <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">//хЫЮш░Г pipeline ф╕нц╖╗хКачЪДChannelInitializerчЪДhandlerAddedцЦ╣ц│Хя╝МхЬиш┐ЩщЗМхИЭхзЛхМЦchannelPipeline</span>
        pipeline<span class="token punctuation">.</span><span class="token function">invokeHandlerAddedIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//шо╛ч╜оregFutureф╕║successя╝МшзжхПСoperationCompleteхЫЮш░Г,х░ЖbindцУНф╜ЬцФ╛хЕеReactorчЪДф╗╗хКбщШЯхИЧф╕ня╝МчнЙх╛ЕReactorч║┐чиЛцЙзшбМуАВ</span>
        <span class="token function">safeSetSuccess</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//шзжхПСchannelRegisterф║Лф╗╢</span>
        pipeline<span class="token punctuation">.</span><span class="token function">fireChannelRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//хп╣ф║ОцЬНхКбчлпServerSocketChannelцЭешп┤ хПкцЬЙч╗СхоЪчлпхПгхЬ░хЭАцИРхКЯхРО channelчЪДчК╢цАБцЙНцШпactiveчЪДуАВ</span>
        <span class="token comment">//цндцЧ╢ч╗СхоЪцУНф╜Ьф╜Ьф╕║х╝Вцнеф╗╗хКбхЬи Reactor чЪДф╗╗хКбщШЯхИЧф╕ня╝Мч╗СхоЪцУНф╜Ьш┐Шц▓бх╝АхзЛя╝МцЙАф╗еш┐ЩщЗМчЪД isActive() цШпfalse</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>firstRegistration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//шзжхПСchannelActiveф║Лф╗╢</span>
                pipeline<span class="token punctuation">.</span><span class="token function">fireChannelActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAutoRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">beginRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>register0</code>цШпщй▒хКицХ┤ф╕к<code>Channel</code>ц│ихЖМч╗СхоЪц╡БчиЛчЪДхЕ│щФоцЦ╣ц│Хя╝Мф╕ЛщЭвцИСф╗мцЭечЬЛф╕ЛхоГчЪДца╕х┐ГщА╗ш╛Ся╝Ъ</p> <ul><li>щжЦхЕИщЬАшжБцгАцЯе<code>Channel</code>чЪДц│ихЖМхКиф╜ЬцШпхРжхЬи<code>Reactorч║┐чиЛ</code>хдЦшвлхПЦц╢Иф║Жх╖▓ч╗П<code>!promise.setUncancellable()</code>уАВцгАцЯешжБц│ихЖМчЪД<code>Channel</code>цШпхРжх╖▓ч╗ПхЕ│щЧн<code>!ensureOpen(promise)</code>уАВхжВцЮЬ<code>Channel</code>х╖▓ч╗ПхЕ│щЧнцИЦшАЕц│ихЖМцУНф╜Ьх╖▓ч╗ПшвлхПЦц╢Ия╝МщВгф╣Их░▒чЫ┤цОеш┐ФхЫЮя╝МхБЬцнвц│ихЖМц╡БчиЛуАВ</li> <li>ш░ГчФи<code>doRegister()</code>цЦ╣ц│Хя╝МцЙзшбМчЬЯцнгчЪДц│ихЖМцУНф╜ЬуАВцЬАч╗ИхоЮчО░хЬи<code>AbstractChannel</code>чЪДхнРч▒╗<code>AbstractNioChannel</code>ф╕ня╝Мш┐Щф╕кцИСф╗мф╕Аф╝ЪхЬиф╗Лч╗Ня╝МхЕИхЕ│ц│ицХ┤ф╜Уц╡БчиЛуАВ</li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractChannel</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultAttributeMap</span> <span class="token keyword">implements</span> <span class="token class-name">Channel</span> <span class="token punctuation">{</span>

   <span class="token comment">/**
     * Is called after the {@link Channel} is registered with its {@link EventLoop} as part of the register process.
     *
     * Sub-classes may override this method
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// NOOP</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><ul><li>х╜У<code>Channel</code>хРС<code>Reactor</code>ц│ихЖМхоМцпХхРОя╝Мш░ГчФи<code>pipeline.invokeHandlerAddedIfNeeded()</code>цЦ╣ц│Хя╝МшзжхПСхЫЮш░Г pipeline ф╕нц╖╗хКачЪД ChannelInitializer чЪД handlerAdded цЦ╣ц│Хя╝МхЬи handlerAdded цЦ╣ц│Хф╕нхИйчФихЙНщЭвцПРхИ░чЪД<code>ChannelInitializer</code>хИЭхзЛхМЦ<code>ChannelPipeline</code>уАВ</li></ul> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192046152.webp" alt="хЫ╛чЙЗ"></p> <blockquote><p>хИЭхзЛхМЦ<code>ChannelPipeline</code>чЪДцЧ╢цЬ║цШпх╜У<code>Channel</code>хРСхп╣х║ФчЪД<code>Reactor</code>ц│ихЖМцИРхКЯхРОя╝МхЬи<code>handlerAddedф║Лф╗╢хЫЮш░Г</code>ф╕нхИйчФи<code>ChannelInitializer</code>ш┐ЫшбМхИЭхзЛхМЦуАВ</p></blockquote> <ul><li>шо╛ч╜о<code>regFuture</code>ф╕║<code>Success</code>я╝Мх╣╢хЫЮш░Гц│ихЖМхЬи<code>regFuture</code>ф╕КчЪД<code>ChannelFutureListener#operationComplete</code>цЦ╣ц│Хя╝МхЬи<code>operationComplete</code>хЫЮш░ГцЦ╣ц│Хф╕нх░Ж<code>ч╗СхоЪцУНф╜Ь</code>х░БшгЕцИРх╝Вцнеф╗╗хКбя╝МцПРф║дхИ░<code>Reactor</code>чЪД<code>taskQueue</code>ф╕нуАВчнЙх╛Е<code>Reactor</code>чЪДцЙзшбМуАВ</li></ul> <blockquote><p>ш┐Шшо░х╛Чш┐Щф╕к<code>regFuture</code>хЬихУкщЗМхЗ║чО░чЪДхРЧя╝ЯхоГцШпхЬихУкщЗМшвлхИЫх╗║я╝МхПИцШпхЬихУкщЗМц╖╗хКачЪД<code>ChannelFutureListener</code>хСвя╝Яхдзхо╢ш┐ШцЬЙхН░ш▒бхРЧя╝ЯхЫЮх┐Жф╕Нш╡╖цЭеф╣Яц▓бхЕ│ч│╗я╝МчмФшАЕхРОщЭвш┐Шф╝ЪцПРхИ░</p></blockquote> <ul><li>щАЪш┐З<code>pipeline.fireChannelRegistered()</code>хЬи<code>pipeline</code>ф╕ншзжхПС<code>channelRegisterф║Лф╗╢</code>уАВ</li></ul> <blockquote><p><code>pipeline</code>ф╕н<code>channelHandler</code>чЪД<code>channelRegisteredцЦ╣ц│Х</code>швлхЫЮш░ГуАВ</p></blockquote> <ul><li>хп╣ф║О Netty цЬНхКбчлп<code>NioServerSocketChannel</code>цЭешп┤я╝М хПкцЬЙ<code>ч╗СхоЪчлпхПгхЬ░хЭАцИРхКЯ</code>хРО channel чЪДчК╢цАБцЙНцШп<code>active</code>чЪДуАВцндцЧ╢<code>ч╗СхоЪцУНф╜Ь</code>хЬи<code>regFuture</code>ф╕Кц│ихЖМчЪД<code>ChannelFutureListener#operationComplete</code>хЫЮш░ГцЦ╣ц│Хф╕ншвлф╜Ьф╕║х╝Вцнеф╗╗хКбцПРф║дхИ░ф║Ж<code>Reactor</code>чЪДф╗╗хКбщШЯхИЧф╕ня╝М<code>Reactorч║┐чиЛ</code>ш┐Ш<code>ц▓бх╝АхзЛ</code>цЙзшбМ<code>ч╗СхоЪф╗╗хКб</code>уАВцЙАф╗еш┐ЩщЗМчЪД<code>isActive()</code>цШп<code>false</code>уАВ</li></ul> <blockquote><p>х╜У<code>Reactorч║┐чиЛ</code>цЙзшбМхоМ<code>register0цЦ╣ц│Х</code>хРОя╝МцЙНф╝ЪхО╗цЙзшбМ<code>ч╗СхоЪф╗╗хКб</code>уАВ</p></blockquote> <p>ф╕ЛщЭвцИСф╗мцЭечЬЛф╕Л<code>register0</code>цЦ╣ц│Хф╕нш┐Щф║Ы<code>ца╕х┐Гцнещкд</code>чЪДхЕ╖ф╜УхоЮчО░я╝Ъ</p> <h5 id="_1-3-6-doregister"><a href="#_1-3-6-doregister" class="header-anchor">#</a> 1.3.6 doRegister()</h5> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractNioChannel</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractChannel</span> <span class="token punctuation">{</span>

    <span class="token comment">//channelц│ихЖМхИ░SelectorхРОшО╖х╛ЧчЪДSelectKey</span>
    <span class="token keyword">volatile</span> <span class="token class-name">SelectionKey</span> selectionKey<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> selected <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                selectionKey <span class="token operator">=</span> <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrappedSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CancelledKeyException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>ш░ГчФих║Хх▒В<code>JDK NIO Channel</code>цЦ╣ц│Х<code>java.nio.channels.SelectableChannel#register(java.nio.channels.Selector, int, java.lang.Object)</code>я╝Мх░Ж Netty<code>NioServerSocketChannel</code>ф╕нхМЕшгЕчЪД<code>JDK NIO ServerSocketChannel</code>ц│ихЖМхИ░<code>Reactor</code>ф╕нчЪД<code>JDK NIO Selector</code>ф╕КуАВ</p> <p>чоАхНХф╗Лч╗Нф╕Л<code>SelectableChannel#register</code>цЦ╣ц│ХхПВцХ░чЪДхРлф╣Йя╝Ъ</p> <ul><li><code>Selectorя╝Ъ</code>шбичд║<code>JDK NIO Channel</code>х░ЖшжБхРСхУкф╕к<code>Selector</code>ш┐ЫшбМц│ихЖМуАВ</li> <li><code>int opsя╝Ъ</code> шбичд║<code>Channel</code>ф╕КцДЯхЕ┤ш╢гчЪД<code>IOф║Лф╗╢</code>я╝Мх╜Ухп╣х║ФчЪД<code>IOф║Лф╗╢х░▒ч╗к</code>цЧ╢я╝М<code>Selector</code>ф╝Ъш┐ФхЫЮ<code>Channel</code>хп╣х║ФчЪД<code>SelectionKey</code>уАВ</li></ul> <blockquote><p><code>SelectionKey</code>хПпф╗ечРЖшзгф╕║<code>Channel</code>хЬи<code>Selector</code>ф╕КчЪДчЙ╣цоКшбичд║х╜вх╝Пя╝М <code>SelectionKey</code>ф╕нх░БшгЕф║Ж<code>Channel</code>цДЯхЕ┤ш╢гчЪД<code>IOф║Лф╗╢щЫЖхРИ~~~interestOps</code>я╝Мф╗ехПК<code>IOх░▒ч╗кчЪДф║Лф╗╢щЫЖхРИ~~readyOps</code>я╝М хРМцЧ╢ф╣Ях░БшгЕф║Жхп╣х║ФчЪД<code>JDK NIO Channel</code>ф╗ехПКц│ихЖМчЪД<code>Selector</code>уАВцЬАхРОш┐ШцЬЙф╕Аф╕кщЗНшжБчЪДх▒ЮцАз<code>attachment</code>я╝МхПпф╗ехЕБшо╕цИСф╗мхЬи<code>SelectionKey</code>ф╕КщЩДхКаф╕Аф║ЫшЗкхоЪф╣ЙчЪДхп╣ш▒буАВ</p></blockquote> <ul><li><code>Object attachmentя╝Ъ</code>хРС<code>SelectionKey</code>ф╕нц╖╗хКачФицИ╖шЗкхоЪф╣ЙчЪДщЩДхКахп╣ш▒буАВ</li></ul> <blockquote><p>ш┐ЩщЗМ<code>NioServerSocketChannel</code>хРС<code>Reactor</code>ф╕нчЪД<code>Selector</code>ц│ихЖМчЪД<code>IOф║Лф╗╢</code>ф╕║<code>0</code>я╝Мш┐Щф╕кцУНф╜ЬчЪДф╕╗шжБчЫочЪДцШпхЕИшО╖хПЦхИ░<code>Channel</code>хЬи<code>Selector</code>ф╕нхп╣х║ФчЪД<code>SelectionKey</code>я╝МхоМцИРц│ихЖМуАВх╜Уч╗СхоЪцУНф╜ЬхоМцИРхРОя╝МхЬихО╗хРС<code>SelectionKey</code>ц╖╗хКацДЯхЕ┤ш╢гчЪД<code>IOф║Лф╗╢</code>~~~<code>OP_ACCEPTф║Лф╗╢</code>уАВ</p></blockquote> <blockquote><p>хРМцЧ╢щАЪш┐З<code>SelectableChannel#register</code>цЦ╣ц│Хх░Ж Netty шЗкхоЪф╣ЙчЪД<code>NioServerSocketChannel</code>я╝Иш┐ЩщЗМчЪД<code>this</code>цМЗщТИя╝ЙщЩДчЭАхЬи<code>SelectionKey</code>чЪД<code>attechment</code>х▒ЮцАзф╕Кя╝М<strong>хоМцИР Netty шЗкхоЪф╣Й<code>Channel</code>ф╕О JDK NIO <code>Channel</code>чЪДхЕ│ч│╗ч╗СхоЪ</strong>уАВш┐Щца╖хЬицпПцмбхп╣<code>Selector</code>ш┐ЫшбМ<code>IOх░▒ч╗кф║Лф╗╢</code>ш╜ошпвцЧ╢я╝МNetty щГ╜хПпф╗еф╗О <code>JDK NIO Selector</code>ш┐ФхЫЮчЪД<code>SelectionKey</code>ф╕ншО╖хПЦхИ░шЗкхоЪф╣ЙчЪД<code>Channel</code>хп╣ш▒бя╝Иш┐ЩщЗМцМЗчЪДх░▒цШп<code>NioServerSocketChannel</code>я╝ЙуАВ</p></blockquote> <h5 id="_1-3-7-handleradded-ф║Лф╗╢хЫЮш░Гф╕нхИЭхзЛхМЦ-channelpipeline"><a href="#_1-3-7-handleradded-ф║Лф╗╢хЫЮш░Гф╕нхИЭхзЛхМЦ-channelpipeline" class="header-anchor">#</a> 1.3.7 HandlerAdded ф║Лф╗╢хЫЮш░Гф╕нхИЭхзЛхМЦ ChannelPipeline</h5> <p>х╜У<code>NioServerSocketChannel</code>ц│ихЖМхИ░<code>Main Reactor</code>ф╕КчЪД<code>Selector</code>хРОя╝МNetty щАЪш┐Зш░ГчФи<code>pipeline.invokeHandlerAddedIfNeeded()</code>х╝АхзЛхЫЮш░Г<code>NioServerSocketChannel</code>ф╕н<code>pipeline</code>щЗМчЪД ChannelHandler чЪД<code>handlerAddedцЦ╣ц│Х</code>уАВ</p> <p>цндцЧ╢<code>NioServerSocketChannel</code>чЪД<code>pipeline</code>ч╗УцЮДхжВф╕Ля╝Ъ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192046152.webp" alt="хЫ╛чЙЗ"></p> <p>цндцЧ╢<code>pipeline</code>ф╕нхПкцЬЙхЬихИЭхзЛхМЦ<code>NioServerSocketChannel</code>цЧ╢ц╖╗хКачЪД<code>ChannelInitializer</code>уАВ</p> <p>цИСф╗мцЭечЬЛф╕Л<code>ChannelInitializer</code>ф╕н<code>handlerAddedхЫЮш░ГцЦ╣ц│Х</code>хЕ╖ф╜Уф╜Ьф║ЖхУкф║Ыф║ЛцГЕ~~</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span> <span class="token keyword">extends</span> <span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handlerAdded</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">initChannel</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//хИЭхзЛхМЦх╖еф╜ЬхоМцИРхРОя╝МщЬАшжБх░ЖшЗкш║лф╗Оpipelineф╕нчз╗щЩд</span>
                <span class="token function">removeState</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//ChannelInitializerхоЮф╛ЛцШпшвлцЙАцЬЙчЪДChannelхЕ▒ф║лчЪДя╝МчФиф║ОхИЭхзЛхМЦChannelPipeline</span>
    <span class="token comment">//щАЪш┐ЗSetщЫЖхРИф┐ЭхнШх╖▓ч╗ПхИЭхзЛхМЦчЪДChannelPipelineя╝МщБ┐хЕНщЗНхдНхИЭхзЛхМЦхРМф╕АChannelPipeline</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">&gt;</span></span> initMap <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">newSetFromMap</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>initMap<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Guard against re-entrance.</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">C</span><span class="token punctuation">)</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">exceptionCaught</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pipeline<span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                     <span class="token comment">//хИЭхзЛхМЦхоМцпХхРОя╝Мф╗Оpipelineф╕нчз╗щЩдшЗкш║л</span>
                    pipeline<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//хМ┐хРНч▒╗хоЮчО░я╝Мш┐ЩщЗМцМЗхоЪхЕ╖ф╜УчЪДхИЭхзЛхМЦщА╗ш╛С</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">C</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">removeState</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//ф╗ОinitMapщШ▓щЗНSetщЫЖхРИф╕нхИащЩдChannelInitializer</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">isRemoved</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            initMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    initMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>ChannelInitializer</code>ф╕нчЪДхИЭхзЛхМЦщА╗ш╛СцпФш╛ГчоАхНХцШОф║Жя╝Ъ</p> <ul><li>щжЦхЕИшжБхИдцЦнх┐Ещб╗цШпх╜УхЙН<code>Channel</code>х╖▓ч╗ПхоМцИРц│ихЖМхРОя╝МцЙНхПпф╗еш┐ЫшбМ<code>pipeline</code>чЪДхИЭхзЛхМЦуАВ<code>ctx.channel().isRegistered()</code></li> <li>ш░ГчФи<code>ChannelInitializer</code>чЪДхМ┐хРНч▒╗цМЗхоЪчЪД<code>initChannel</code>цЙзшбМшЗкхоЪф╣ЙчЪДхИЭхзЛхМЦщА╗ш╛СуАВ</li></ul> <div class="language-Java extra-class"><pre class="language-java"><code>p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Channel</span> ch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//ServerBootstrapф╕нчФицИ╖цМЗхоЪчЪДchannelHandler</span>
        <span class="token class-name">ChannelHandler</span> handler <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        ch<span class="token punctuation">.</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServerBootstrapAcceptor</span><span class="token punctuation">(</span>
                    ch<span class="token punctuation">,</span> currentChildGroup<span class="token punctuation">,</span> currentChildHandler<span class="token punctuation">,</span> currentChildOptions<span class="token punctuation">,</span> currentChildAttrs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>ш┐Шшо░х╛ЧхЬихИЭхзЛхМЦ<code>NioServerSocketChannel</code>цЧ╢уАВ<code>io.netty.bootstrap.ServerBootstrap#init</code>цЦ╣ц│Хф╕нхРС<code>pipeline</code>ф╕нц╖╗хКачЪД<code>ChannelInitializer</code>хРЧя╝Я</p></blockquote> <ul><li>х╜УцЙзшбМхоМ<code>initChannel цЦ╣ц│Х</code>хРОя╝М<code>ChannelPipeline</code>чЪДхИЭхзЛхМЦх░▒ч╗УцЭЯф║Жя╝МцндцЧ╢<code>ChannelInitializer</code>х░▒ц▓бх┐ЕшжБхЖНч╗зч╗нхСЖхЬи<code>pipelineф╕нф║Ж</code>я╝МцЙАщЬАшжБх░Ж<code>ChannelInitializer</code>ф╗О<code>pipeline</code>ф╕нхИащЩдуАВ<code>pipeline.remove(this)</code></li></ul> <p>х╜УхИЭхзЛхМЦхоМ<code>pipeline</code>цЧ╢я╝МцндцЧ╢<code>pipeline</code>чЪДч╗УцЮДхЖНцмбхПСчФЯф║ЖхПШхМЦя╝Ъ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192147362.webp" alt="хЫ╛чЙЗ"></p> <p>цндцЧ╢<code>Main Reactor</code>ф╕нчЪДф╗╗хКбщШЯхИЧ<code>taskQueue</code>ч╗УцЮДхПШхМЦф╕║я╝Ъ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192046068.webp" alt="хЫ╛чЙЗ"></p> <p>ц╖╗хКа<code>ServerBootstrapAcceptor</code>чЪДф╗╗хКбцШпхЬихИЭхзЛхМЦ<code>NioServerSocketChannel</code>чЪДцЧ╢хАЩхРС main reactor цПРф║дш┐ЗхО╗чЪДуАВш┐Шшо░х╛ЧхРЧя╝Я</p> <h5 id="_1-3-8-хЫЮш░Г-regfuture-чЪД-channelfuturelistener"><a href="#_1-3-8-хЫЮш░Г-regfuture-чЪД-channelfuturelistener" class="header-anchor">#</a> 1.3.8 хЫЮш░Г regFuture чЪД ChannelFutureListener</h5> <p>хЬицЬмх░ПшКВуАКNetty цЬНхКбчлпчЪДхРпхКиуАЛчЪДцЬАх╝АхзЛя╝МцИСф╗мф╗Лч╗Нф║ЖцЬНхКбчлпхРпхКичЪДхЕехПгхЗ╜цХ░<code>io.netty.bootstrap.AbstractBootstrap#doBind</code>я╝МхЬихЗ╜цХ░чЪДцЬАх╝Ахд┤ш░ГчФиф║Ж<code>initAndRegister()</code>цЦ╣ц│ХчФицЭехИЫх╗║х╣╢хИЭхзЛхМЦ<code>NioServerSocketChannel</code>я╝Мф╣ЛхРОф╛┐ф╝Ъх░Ж<code>NioServerSocketChannel</code>ц│ихЖМхИ░<code>Main Reactor</code>ф╕нуАВ</p> <p>ц│ихЖМчЪДцУНф╜ЬцШпф╕Аф╕кх╝ВцнечЪДш┐ЗчиЛя╝МцЙАф╗ехЬи<code>initAndRegister()</code>цЦ╣ц│Хш░ГчФихРОш┐ФхЫЮф╕Аф╕кф╗гшбиц│ихЖМч╗УцЮЬчЪД<code>ChannelFuture regFuture</code>уАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractBootstrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractBootstrap</span><span class="token punctuation">&lt;</span><span class="token class-name">B</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">C</span> <span class="token keyword">extends</span> <span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Cloneable</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">ChannelFuture</span> <span class="token function">doBind</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//х╝ВцнехИЫх╗║я╝МхИЭхзЛхМЦя╝Мц│ихЖМServerSocketChannel</span>
        <span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> regFuture <span class="token operator">=</span> <span class="token function">initAndRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">Channel</span> channel <span class="token operator">=</span> regFuture<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>regFuture<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> regFuture<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>regFuture<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//хжВцЮЬц│ихЖМхоМцИРя╝МхИЩш┐ЫшбМч╗СхоЪцУНф╜Ь</span>
            <span class="token class-name">ChannelPromise</span> promise <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">newPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">doBind0</span><span class="token punctuation">(</span>regFuture<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> localAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">PendingRegistrationPromise</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PendingRegistrationPromise</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//ц╖╗хКац│ихЖМхоМцИР хЫЮш░ГхЗ╜цХ░</span>
            regFuture<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelFutureListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelFuture</span> future<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                        <span class="token comment">// ц│ихЖМхоМцИРхРОя╝МReactorч║┐чиЛхЫЮш░Гш┐ЩщЗМ</span>
                        <span class="token function">doBind0</span><span class="token punctuation">(</span>regFuture<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> localAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
                                  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ф╣ЛхРОф╝ЪхРС<code>ChannelFuture regFuture</code>ц╖╗хКаф╕Аф╕к<code>ц│ихЖМхоМцИРхРОчЪДхЫЮш░ГхЗ╜цХ░~~~~ ChannelFutureListener</code>уАВхЬихЫЮш░ГхЗ╜цХ░<code>operationComplete</code>ф╕нх╝АхзЛхПСш╡╖<code>ч╗СчлпхПгхЬ░хЭАц╡БчиЛ</code>уАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192152233.webp" alt="хЫ╛чЙЗ"></p> <p><strong>щВгф╣Иш┐Щф╕кхЫЮш░ГхЗ╜цХ░хЬиф╗Аф╣ИцЧ╢хАЩя╝Яф╗Аф╣ИхЬ░цЦ╣хПСш╡╖чЪДхСвя╝Яя╝Я</strong></p> <p>шойцИСф╗мхЬихЫЮхИ░цЬмх░ПшКВчЪДф╕╗щвШ<code>register0</code>цЦ╣ц│ХчЪДц╡БчиЛф╕ня╝Ъ</p> <p>х╜Уш░ГчФи<code>doRegister()</code>цЦ╣ц│ХхоМцИР<code>NioServerSocketChannel</code>хРС<code>Main Reactor</code>чЪДц│ихЖМхРОя╝Мч┤зцОечЭАф╝Ъш░ГчФи<code>pipeline.invokeHandlerAddedIfNeeded()</code>цЦ╣ц│Хф╕ншзжхПС<code>ChannelInitializer#handlerAdded</code>хЫЮш░Гф╕нхп╣<code>pipeline</code>ш┐ЫшбМхИЭхзЛхМЦуАВ</p> <p>цЬАхРОхЬи<code>safeSetSuccess</code>цЦ╣ц│Хф╕ня╝Мх╝АхзЛхЫЮш░Гц│ихЖМхЬи<code>regFuture</code>ф╕КчЪД<code>ChannelFutureListener</code>уАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">safeSetSuccess</span><span class="token punctuation">(</span><span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>promise <span class="token keyword">instanceof</span> <span class="token class-name">VoidChannelPromise</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>promise<span class="token punctuation">.</span><span class="token function">trySuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to mark a promise as success because it is done already: {}&quot;</span><span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">trySuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">trySuccess</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">trySuccess</span><span class="token punctuation">(</span><span class="token class-name">V</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">setSuccess0</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">setSuccess0</span><span class="token punctuation">(</span><span class="token class-name">V</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">setValue0</span><span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token constant">SUCCESS</span> <span class="token operator">:</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">setValue0</span><span class="token punctuation">(</span><span class="token class-name">Object</span> objResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">RESULT_UPDATER</span><span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> objResult<span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token constant">RESULT_UPDATER</span><span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">UNCANCELLABLE</span><span class="token punctuation">,</span> objResult<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkNotifyWaiters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//хЫЮш░Гц│ихЖМхЬиpromiseф╕КчЪДlisteners</span>
            <span class="token function">notifyListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>safeSetSuccess</code>чЪДщА╗ш╛СцпФш╛ГчоАхНХя╝МщжЦхЕИшо╛ч╜о<code>regFuture</code>ч╗УцЮЬф╕║<code>success</code>я╝Мх╣╢ф╕ФхЫЮш░Гц│ихЖМхЬи<code>regFuture</code>ф╕КчЪД<code>ChannelFutureListener</code>уАВ</p> <blockquote><p>щЬАшжБцПРщЖТчЪДцШпя╝МцЙзшбМ<code>safeSetSuccess</code>цЦ╣ц│Хя╝Мф╗ехПКхРОш╛╣хЫЮш░Г<code>regFuture</code>ф╕КчЪД<code>ChannelFutureListener</code><strong>ш┐Щф║ЫхКиф╜ЬщГ╜цШпчФ▒<code>Reactorч║┐чиЛ</code>цЙзшбМчЪДуАВ</strong></p></blockquote> <blockquote><p>хЕ│ф║О Netty ф╕нчЪД<code>PromiseцибхЮЛ</code>хРОш╛╣цИСф╝ЪхЬихЖЩф╕АчпЗф╕УщЧичЪДцЦЗчлаш┐ЫшбМхИЖцЮРя╝Мш┐ЩщЗМхдзхо╢хПкщЬАц╕ЕцеЪхдзф╜УчЪДц╡БчиЛхН│хПпуАВф╕Нх┐ЕхЬицДПш┐ЗхдЪчЪДч╗ЖшКВуАВ</p></blockquote> <p>ф╕ЛщЭвцИСф╗мцККшзЖшзТхИЗцНвхИ░<code>regFuture</code>ф╕КчЪД<code>ChannelFutureListener</code>хЫЮш░Гф╕ня╝МчЬЛчЬЛхЬи<code>Channel</code>ц│ихЖМхоМцИРхРОя╝МNetty хПИф╝ЪхБЪхУкф║Ыф║ЛцГЕя╝Я</p> <h3 id="_2-dobind0"><a href="#_2-dobind0" class="header-anchor">#</a> 2. doBind0</h3> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractBootstrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractBootstrap</span><span class="token punctuation">&lt;</span><span class="token class-name">B</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">C</span> <span class="token keyword">extends</span> <span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Cloneable</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">doBind0</span><span class="token punctuation">(</span>
            <span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> regFuture<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        channel<span class="token punctuation">.</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>regFuture<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    channel<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>localAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token class-name">ChannelFutureListener</span><span class="token punctuation">.</span><span class="token constant">CLOSE_ON_FAILURE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    promise<span class="token punctuation">.</span><span class="token function">setFailure</span><span class="token punctuation">(</span>regFuture<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>ш┐ЩщЗМ Netty хПИх░Ж<code>ч╗СхоЪчлпхПгхЬ░хЭА</code>чЪДцУНф╜Ьх░БшгЕцИРх╝Вцнеф╗╗хКбя╝МцПРф║дч╗Щ<code>Reactor</code>цЙзшбМуАВ</p> <p><strong>ф╜ЖцШпш┐ЩщЗМцЬЙф╕Аф╕кщЧощвШя╝МхЕ╢хоЮцндцЧ╢цЙзшбМ<code>doBind0</code>цЦ╣ц│ХчЪДч║┐чиЛцнгцШп<code>Reactorч║┐чиЛ</code>я╝МщВгф╕║ф╗Аф╣Иф╕НчЫ┤цОехЬиш┐ЩщЗМхО╗цЙзшбМ<code>bindцУНф╜Ь</code>я╝МшАМцШпхЖНцмбх░БшгЕцИРх╝Вцнеф╗╗хКбцПРф║дч╗Щ<code>Reactor</code>ф╕нчЪД<code>taskQueue</code>хСвя╝Я</strong></p> <p><strong>хПНцнгцЬАч╗ИщГ╜цШпчФ▒<code>Reactorч║┐чиЛ</code>цЙзшбМя╝Мш┐ЩхЕ╢ф╕нхПИцЬЙф╗Аф╣ИхИЖхИлхСвя╝Я</strong></p> <p>ч╗Пш┐Зф╕Кх░ПшКВчЪДф╗Лч╗НцИСф╗мчЯещБУя╝М<code>bind0</code>цЦ╣ц│ХчЪДш░ГчФицШпчФ▒<code>io.netty.channel.AbstractChannel.AbstractUnsafe#register0</code>цЦ╣ц│ХхЬих░Ж<code>NioServerSocketChannel</code>ц│ихЖМхИ░<code>Main Reactor</code>ф╣ЛхРОя╝Мх╣╢ф╕Ф<code>NioServerSocketChannel</code>чЪД<code>pipeline</code>х╖▓ч╗ПхИЭхзЛхМЦхоМцпХхРОя╝МщАЪш┐З<code>safeSetSuccess</code>цЦ╣ц│ХхЫЮш░Гш┐ЗцЭечЪДуАВ</p> <p>ш┐Щф╕кш┐ЗчиЛхЕичиЛцШпчФ▒<code>Reactorч║┐чиЛ</code>цЭеш┤Яш┤гцЙзшбМчЪДя╝Мф╜ЖцШпцндцЧ╢<code>register0</code>цЦ╣ц│Хх╣╢ц▓бцЬЙцЙзшбМхоМцпХя╝Мш┐ШщЬАшжБцЙзшбМхРОщЭвчЪДщА╗ш╛СуАВ</p> <p><strong>шАМч╗СхоЪщА╗ш╛СщЬАшжБхЬиц│ихЖМщА╗ш╛СцЙзшбМхоМф╣ЛхРОцЙзшбМ</strong>я╝МцЙАф╗ехЬи<code>doBind0</code>цЦ╣ц│Хф╕н<code>Reactorч║┐чиЛ</code>ф╝Ъх░Ж<code>ч╗СхоЪцУНф╜Ь</code>х░БшгЕцИРх╝Вцнеф╗╗хКбхЕИцПРф║дч╗Щ<code>taskQueue</code>ф╕нф┐ЭхнШя╝Мш┐Щца╖хПпф╗еф╜┐<code>Reactorч║┐чиЛ</code>члЛщймф╗О<code>safeSetSuccess</code>ф╕нш┐ФхЫЮя╝Мч╗зч╗нцЙзшбМхЙйф╕ЛчЪД<code>register0</code>цЦ╣ц│ХщА╗ш╛СуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">register0</span><span class="token punctuation">(</span><span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token function">doRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pipeline<span class="token punctuation">.</span><span class="token function">invokeHandlerAddedIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">safeSetSuccess</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//шзжхПСchannelRegisterф║Лф╗╢</span>
        pipeline<span class="token punctuation">.</span><span class="token function">fireChannelRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>х╜У<code>Reactorч║┐чиЛ</code>цЙзшбМхоМ<code>register0</code>цЦ╣ц│ХхРОя╝Мх░▒ф╝Ъф╗О<code>taskQueue</code>ф╕нхПЦхЗ║х╝Вцнеф╗╗хКбцЙзшбМуАВ</p> <p>цндцЧ╢<code>Reactorч║┐чиЛ</code>ф╕нчЪД<code>taskQueue</code>ч╗УцЮДхжВф╕Ля╝Ъ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192046393.webp" alt="хЫ╛чЙЗ">regFuture хЫЮш░ГхРО taksQueue чЪДч╗УцЮД.png</p> <ul><li><code>Reactorч║┐чиЛ</code>ф╝ЪхЕИхПЦхЗ║ф╜Нф║О<code>taskQueue</code>щШЯщжЦчЪДф╗╗хКбцЙзшбМя╝Мш┐ЩщЗМцШпцМЗхРС<code>NioServerSocketChannel</code>чЪД<code>pipeline</code>ф╕нц╖╗хКа<code>ServerBootstrapAcceptor</code>чЪДх╝Вцнеф╗╗хКбуАВ</li></ul> <p>цндцЧ╢<code>NioServerSocketChannel</code>ф╕н<code>pipeline</code>чЪДч╗УцЮДхжВф╕Ля╝Ъ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192047986.webp" alt="хЫ╛чЙЗ">ServerChannelPipeline хоМцХ┤ч╗УцЮД.png</p> <ul><li><code>Reactorч║┐чиЛ</code>цЙзшбМч╗СхоЪф╗╗хКбуАВ</li></ul> <h3 id="_3-ч╗СхоЪчлпхПгхЬ░хЭА"><a href="#_3-ч╗СхоЪчлпхПгхЬ░хЭА" class="header-anchor">#</a> 3. ч╗СхоЪчлпхПгхЬ░хЭА</h3> <p>хп╣<code>Channel</code>чЪДцУНф╜ЬшбМф╕║хЕищГихоЪф╣ЙхЬи<code>ChannelOutboundInvokerцОехПгф╕н</code>уАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192047841.webp" alt="хЫ╛чЙЗ">image.png</p> <div class="language- extra-class"><pre class="language-text"><code>public interface ChannelOutboundInvoker {

    /**
     * Request to bind to the given {@link SocketAddress} and notify the {@link ChannelFuture} once the operation
     * completes, either because the operation was successful or because of an error.
     *
     */
    ChannelFuture bind(SocketAddress localAddress, ChannelPromise promise);
}
</code></pre></div><p><code>bind</code>цЦ╣ц│ХчФ▒хнРч▒╗<code>AbstractChannel</code>хоЮчО░уАВ</p> <div class="language- extra-class"><pre class="language-text"><code>public abstract class AbstractChannel extends DefaultAttributeMap implements Channel {

   @Override
    public ChannelFuture bind(SocketAddress localAddress, ChannelPromise promise) {
        return pipeline.bind(localAddress, promise);
    }

}
</code></pre></div><p>ш░ГчФи<code>pipeline.bind(localAddress, promise)</code>хЬи<code>pipeline</code>ф╕нф╝ацТн<code>bindф║Лф╗╢</code>я╝МшзжхПСхЫЮш░Г<code>pipeline</code>ф╕нцЙАцЬЙ<code>ChannelHandler</code>чЪД<code>bindцЦ╣ц│Х</code>уАВ</p> <p>ф║Лф╗╢хЬи<code>pipeline</code>ф╕нчЪДф╝ацТнхЕ╖цЬЙцЦ╣хРСцАзя╝Ъ</p> <ul><li><code>inboundф║Лф╗╢</code>ф╗О<code>HeadContext</code>х╝АхзЛщАРф╕кхРСхРОф╝ацТнчЫ┤хИ░<code>TailContext</code>уАВ</li> <li><code>outboundф║Лф╗╢</code>хИЩцШпхПНхРСф╝ацТня╝Мф╗О<code>TailContext</code>х╝АхзЛхПНхРСхРСхЙНф╝ацТнчЫ┤хИ░<code>HeadContext</code>уАВ</li></ul> <blockquote><p><code>inboundф║Лф╗╢</code>хПкшГ╜швл<code>pipeline</code>ф╕нчЪД<code>ChannelInboundHandler</code>хУНх║ФхдДчРЖ<code>outboundф║Лф╗╢</code>хПкшГ╜швл<code>pipeline</code>ф╕нчЪД<code>ChannelOutboundHandler</code>хУНх║ФхдДчРЖ</p></blockquote> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192047175.webp" alt="хЫ╛чЙЗ">pipeline ф╕нчЪДф╝ацТнцЦ╣хРС.png</p> <p>чД╢шАМш┐ЩщЗМчЪД<code>bindф║Лф╗╢</code>хЬи Netty ф╕ншвлхоЪф╣Йф╕║<code>outboundф║Лф╗╢</code>я╝МцЙАф╗ехоГхЬи<code>pipeline</code>ф╕нцШпхПНхРСф╝ацТнуАВхЕИф╗О<code>TailContext</code>х╝АхзЛхПНхРСф╝ацТнчЫ┤хИ░<code>HeadContext</code>уАВ</p> <p>чД╢шАМ<code>bind</code>чЪДца╕х┐ГщА╗ш╛Сф╣ЯцнгцШпхоЮчО░хЬи<code>HeadContext</code>ф╕нуАВ</p> <h4 id="_3-1-headcontext"><a href="#_3-1-headcontext" class="header-anchor">#</a> 3.1 HeadContext</h4> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HeadContext</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractChannelHandlerContext</span>
    <span class="token keyword">implements</span> <span class="token class-name">ChannelOutboundHandler</span><span class="token punctuation">,</span> <span class="token class-name">ChannelInboundHandler</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">bind</span><span class="token punctuation">(</span>
        <span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//шзжхПСAbstractChannel-&gt;bindцЦ╣ц│Х цЙзшбМ JDK NIO SelectableChannel цЙзшбМх║Хх▒Вч╗СхоЪцУНф╜Ь</span>
        unsafe<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>localAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>хЬи<code>HeadContext#bind</code>хЫЮш░ГцЦ╣ц│Хф╕ня╝Мш░ГчФи<code>Channel</code>щЗМчЪД<code>unsafe</code>цУНф╜Ьч▒╗цЙзшбМчЬЯцнгчЪДч╗СхоЪцУНф╜ЬуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractUnsafe</span> <span class="token keyword">implements</span> <span class="token class-name">Unsafe</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token comment">//ш┐ЩцЧ╢channelш┐ШцЬкц┐Ац┤╗  wasActive = false</span>
            <span class="token keyword">boolean</span> wasActive <span class="token operator">=</span> <span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//io.netty.channel.socket.nio.NioServerSocketChannel.doBind</span>
            <span class="token comment">//ш░ГчФихЕ╖ф╜УchannelхоЮчО░ч▒╗</span>
            <span class="token function">doBind</span><span class="token punctuation">(</span>localAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//ч╗СхоЪцИРхКЯхРО channelц┐Ац┤╗ шзжхПСchannelActiveф║Лф╗╢ф╝ацТн</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>wasActive <span class="token operator">&amp;&amp;</span> <span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">invokeLater</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//pipelineф╕ншзжхПСchannelActiveф║Лф╗╢</span>
                    pipeline<span class="token punctuation">.</span><span class="token function">fireChannelActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//хЫЮш░Гц│ихЖМхЬиpromiseф╕КчЪДChannelFutureListener</span>
        <span class="token function">safeSetSuccess</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">doBind</span><span class="token punctuation">(</span><span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>щжЦхЕИцЙзшбМхнРч▒╗<code>NioServerSocketChannel</code>хЕ╖ф╜УхоЮчО░чЪД<code>doBind</code>цЦ╣ц│Хя╝МщАЪш┐З<code>JDK NIO хОЯчФЯ ServerSocketChannel</code>цЙзшбМх║Хх▒ВчЪДч╗СхоЪцУНф╜ЬуАВ</li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doBind</span><span class="token punctuation">(</span><span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">//ш░ГчФиJDK NIO х║Хх▒ВSelectableChannel цЙзшбМч╗СхоЪцУНф╜Ь</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">PlatformDependent</span><span class="token punctuation">.</span><span class="token function">javaVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>localAddress<span class="token punctuation">,</span> config<span class="token punctuation">.</span><span class="token function">getBacklog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>localAddress<span class="token punctuation">,</span> config<span class="token punctuation">.</span><span class="token function">getBacklog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>хИдцЦнцШпхРжф╕║щжЦцмбч╗СхоЪя╝МхжВцЮЬцШпчЪДшпЭх░Ж<code>шзжхПСpipelineф╕нчЪДChannelActiveф║Лф╗╢</code>х░БшгЕцИРх╝Вцнеф╗╗хКбцФ╛хЕе<code>Reactor</code>ф╕нчЪД<code>taskQueue</code>ф╕нуАВ</li> <li>цЙзшбМ<code>safeSetSuccess(promise)</code>,хЫЮш░Гц│ихЖМхЬи<code>promise</code>ф╕КчЪД<code>ChannelFutureListener</code>уАВ</li></ul> <p><strong>ш┐ШцШпхРМца╖чЪДщЧощвШя╝Мх╜УхЙНцЙзшбМч║┐чиЛх╖▓ч╗ПцШп<code>Reactorч║┐чиЛ</code>ф║Жя╝МщВгф╣Иф╕║ф╜Хф╕НчЫ┤цОешзжхПС<code>pipeline</code>ф╕нчЪД<code>ChannelActive</code>ф║Лф╗╢шАМцШпхПИх░БшгЕцИРх╝Вцнеф╗╗хКбхСвя╝Яя╝Я</strong></p> <p>хЫаф╕║хжВцЮЬчЫ┤цОехЬиш┐ЩщЗМшзжхПС<code>ChannelActiveф║Лф╗╢</code>я╝МщВгф╣И<code>Reactorч║┐чиЛ</code>х░▒ф╝ЪхО╗цЙзшбМ<code>pipeline</code>ф╕нчЪД<code>ChannelHandler</code>чЪД<code>channelActiveф║Лф╗╢хЫЮш░Г</code>уАВ</p> <p>ш┐Щца╖чЪДшпЭх░▒х╜▒хУНф║Ж<code>safeSetSuccess(promise)</code>чЪДцЙзшбМя╝М<code>х╗╢ш┐Яф║Ж</code>ц│ихЖМхЬи<code>promise</code>ф╕КчЪД<code>ChannelFutureListener</code>чЪДхЫЮш░ГуАВ</p> <p>хИ░чО░хЬиф╕║цнвя╝МNetty цЬНхКбчлпх░▒х╖▓ч╗ПхоМцИРф║Жч╗СхоЪчлпхПгхЬ░хЭАчЪДцУНф╜Ья╝М<code>NioServerSocketChannel</code>чЪДчК╢цАБчО░хЬихПШф╕║<code>Active</code>уАВ</p> <p>цЬАхРОш┐ШцЬЙф╕Аф╗╢щЗНшжБчЪДф║ЛцГЕшжБхБЪя╝МцИСф╗мцОечЭАцЭечЬЛ<code>pipeline</code>ф╕нхп╣<code>channelActiveф║Лф╗╢</code>хдДчРЖуАВ</p> <h4 id="_3-2-channelactive-ф║Лф╗╢хдДчРЖ"><a href="#_3-2-channelactive-ф║Лф╗╢хдДчРЖ" class="header-anchor">#</a> 3.2 channelActive ф║Лф╗╢хдДчРЖ</h4> <p><code>channelActiveф║Лф╗╢</code>хЬи Netty ф╕нхоЪф╣Йф╕║<code>inboundф║Лф╗╢</code>я╝МцЙАф╗ехоГхЬи<code>pipeline</code>ф╕нчЪДф╝ацТнф╕║цнгхРСф╝ацТня╝Мф╗О<code>HeadContext</code>ф╕АчЫ┤хИ░<code>TailContext</code>ф╕║цнвуАВ</p> <p>хЬи<code>channelActiveф║Лф╗╢</code>хЫЮш░Гф╕нщЬАшжБшзжхПСхРС<code>Selector</code>цМЗхоЪщЬАшжБчЫСхРмчЪД<code>IOф║Лф╗╢</code>~~<code>OP_ACCEPTф║Лф╗╢</code>уАВ</p> <p>ш┐ЩхЭЧчЪДщА╗ш╛Сф╕╗шжБхЬи<code>HeadContext</code>ф╕нхоЮчО░уАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HeadContext</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractChannelHandlerContext</span>
    <span class="token keyword">implements</span> <span class="token class-name">ChannelOutboundHandler</span><span class="token punctuation">,</span> <span class="token class-name">ChannelInboundHandler</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelActive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//pipelineф╕нч╗зч╗нхРСхРОф╝ацТнchannelActiveф║Лф╗╢</span>
        ctx<span class="token punctuation">.</span><span class="token function">fireChannelActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//хжВцЮЬцШпautoRead хИЩшЗкхКишзжхПСreadф║Лф╗╢ф╝ацТн</span>
        <span class="token comment">//хЬиreadхЫЮш░ГхЗ╜цХ░ф╕н шзжхПСOP_ACCEPTц│ихЖМ</span>
        <span class="token function">readIfIsAutoRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readIfIsAutoRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAutoRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//хжВцЮЬцШпautoRead хИЩшзжхПСreadф║Лф╗╢ф╝ацТн</span>
            channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//AbstractChannel</span>
    <span class="token keyword">public</span> <span class="token class-name">Channel</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//шзжхПСreadф║Лф╗╢</span>
        pipeline<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//шзжхПСц│ихЖМOP_ACCEPTцИЦшАЕOP_READф║Лф╗╢</span>
        unsafe<span class="token punctuation">.</span><span class="token function">beginRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>хЬи<code>HeadContext</code>ф╕нчЪД<code>channelActive</code>хЫЮш░Гф╕ншзжхПС<code>pipeline</code>ф╕нчЪД<code>readф║Лф╗╢</code>уАВ</li> <li>х╜У<code>readф║Лф╗╢</code>хЖНцмбф╝ацТнхИ░<code>HeadContext</code>цЧ╢я╝МшзжхПС<code>HeadContext#read</code>цЦ╣ц│ХчЪДхЫЮш░ГуАВхЬи<code>readхЫЮш░Г</code>ф╕нш░ГчФи<code>channel</code>х║Хх▒ВцУНф╜Ьч▒╗<code>unsafe</code>чЪД<code>beginRead</code>цЦ╣ц│ХхРС<code>selector</code>ц│ихЖМчЫСхРм<code>OP_ACCEPTф║Лф╗╢</code>уАВ</li></ul> <h4 id="_3-3-beginread"><a href="#_3-3-beginread" class="header-anchor">#</a> 3.3 beginRead</h4> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractUnsafe</span> <span class="token keyword">implements</span> <span class="token class-name">Unsafe</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">beginRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">assertEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//channelх┐Ещб╗цШпActive</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// шзжхПСхЬиselectorф╕Кц│ихЖМchannelцДЯхЕ┤ш╢гчЪДчЫСхРмф║Лф╗╢</span>
            <span class="token function">doBeginRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractChannel</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultAttributeMap</span> <span class="token keyword">implements</span> <span class="token class-name">Channel</span> <span class="token punctuation">{</span>
    <span class="token comment">//хнРч▒╗ш┤Яш┤гч╗зцЙ┐хоЮчО░</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">doBeginRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><ul><li>цЦншиАхИдцЦнцЙзшбМшпецЦ╣ц│ХчЪДч║┐чиЛх┐Ещб╗цШп<code>Reactorч║┐чиЛ</code>уАВ</li> <li>цндцЧ╢<code>NioServerSocketChannel</code>х╖▓ч╗ПхоМцИРчлпхПгхЬ░хЭАчЪДч╗СхоЪцУНф╜Ья╝М<code>isActive() = true</code></li> <li>ш░ГчФи<code>doBeginRead</code>хоЮчО░хРС<code>Selector</code>ц│ихЖМчЫСхРмф║Лф╗╢<code>OP_ACCEPT</code></li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractNioChannel</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractChannel</span> <span class="token punctuation">{</span>

    <span class="token comment">//channelц│ихЖМхИ░SelectorхРОшО╖х╛ЧчЪДSelectKey</span>
    <span class="token keyword">volatile</span> <span class="token class-name">SelectionKey</span> selectionKey<span class="token punctuation">;</span>
    <span class="token comment">// ChannelчЫСхРмф║Лф╗╢щЫЖхРИ</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">int</span> readInterestOp<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doBeginRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token keyword">final</span> <span class="token class-name">SelectionKey</span> selectionKey <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>selectionKey<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>selectionKey<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        readPending <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> interestOps <span class="token operator">=</span> selectionKey<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/**
         * 1я╝ЪServerSocketChannel хИЭхзЛхМЦцЧ╢ readInterestOpшо╛ч╜очЪДцШпOP_ACCEPTф║Лф╗╢
         * */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>interestOps <span class="token operator">&amp;</span> readInterestOp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//ц╖╗хКаOP_ACCEPTф║Лф╗╢хИ░interestOpsщЫЖхРИф╕н</span>
            selectionKey<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span>interestOps <span class="token operator">|</span> readInterestOp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>хЙНш╛╣цПРхИ░хЬи<code>NioServerSocketChannel</code>хЬихРС<code>Main Reactor</code>ф╕нчЪД<code>Selector</code>ц│ихЖМхРОя╝Мф╝ЪшО╖х╛Чф╕Аф╕к<code>SelectionKey</code>уАВш┐ЩщЗМщжЦхЕИшжБшО╖хПЦш┐Щф╕к<code>SelectionKey</code>уАВ</li> <li>ф╗О<code>SelectionKey</code>ф╕ншО╖хПЦ<code>NioServerSocketChannel</code>цДЯхЕ┤ш╢гчЪД<code>IOф║Лф╗╢щЫЖхРИ interestOps</code>я╝Мх╜УцЧ╢хЬиц│ихЖМчЪДцЧ╢хАЩ<code>interestOps</code>шо╛ч╜оф╕║<code>0</code>уАВ</li> <li>х░ЖхЬи<code>NioServerSocketChannel</code>хИЭхзЛхМЦцЧ╢шо╛ч╜очЪД<code>readInterestOp = OP_ACCEPT</code>я╝Мшо╛ч╜охИ░<code>SelectionKey</code>ф╕нчЪД<code>interestOps</code>щЫЖхРИф╕нуАВш┐Щца╖<code>Reactor</code>ф╕нчЪД<code>Selector</code>х░▒х╝АхзЛчЫСхРм<code>interestOps</code>щЫЖхРИф╕нхМЕхРлчЪД<code>IOф║Лф╗╢</code>ф║ЖуАВ</li></ul> <blockquote><p><code>Main Reactor</code>ф╕нф╕╗шжБчЫСхРмчЪДцШп<code>OP_ACCEPTф║Лф╗╢</code>уАВ</p></blockquote> <p>ц╡БчиЛш╡░хИ░ш┐ЩщЗМя╝МNetty цЬНхКбчлпх░▒чЬЯцнгчЪДхРпхКиш╡╖цЭеф║Жя╝Мф╕Лф╕Ацнех░▒х╝АхзЛчнЙх╛ЕцОецФ╢ховцИ╖члпш┐ЮцОеф║ЖуАВхдзхо╢цндхИ╗хЬицЭехЫЮчЬЛш┐ЩхЙпхРпхКиц╡БчиЛхЫ╛я╝МцШпф╕НцШпц╕ЕцЩ░ф║Жх╛ИхдЪхСвя╝Я</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192151677.webp" alt="хЫ╛чЙЗ"></p> <p>цндцЧ╢ Netty чЪД<code>ReactorцибхЮЛ</code>ч╗УцЮДхжВф╕Ля╝Ъ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192047090.webp" alt="хЫ╛чЙЗ"></p> <hr> <h2 id="цА╗ч╗У"><a href="#цА╗ч╗У" class="header-anchor">#</a> цА╗ч╗У</h2> <p>цЬмцЦЗцИСф╗мщАЪш┐ЗхЫ╛шзгц║РчаБчЪДцЦ╣х╝ПхоМцХ┤хЬ░ф╗Лч╗Нф║ЖцХ┤ф╕к Netty цЬНхКбчлпхРпхКиц╡БчиЛя╝Мх╣╢ф╗Лч╗Нф║ЖхЬихРпхКиш┐ЗчиЛф╕нц╢ЙхПКхИ░чЪД<code>ServerBootstrap</code>чЫ╕хЕ│чЪДх▒ЮцАзф╗ехПКщЕНч╜оцЦ╣х╝ПуАВ<code>NioServerSocketChannel</code>чЪДхИЫх╗║хИЭхзЛхМЦш┐ЗчиЛф╗ехПКч▒╗чЪДч╗зцЙ┐ч╗УцЮДуАВ</p> <p>хЕ╢ф╕нщЗНчВ╣ф╗Лч╗Нф║Ж<code>NioServerSocketChannel</code>хРС<code>Reactor</code>чЪДц│ихЖМш┐ЗчиЛф╗ехПК<code>Reactorч║┐чиЛ</code>чЪДхРпхКицЧ╢цЬ║хТМ<code>pipeline</code>чЪДхИЭхзЛхМЦцЧ╢цЬ║уАВ</p> <p>цЬАхРОф╗Лч╗Нф║Ж<code>NioServerSocketChannel</code>ч╗СхоЪчлпхПгхЬ░хЭАчЪДцХ┤ф╕кц╡БчиЛуАВ</p> <p>ф╕Кш┐░ф╗Лч╗НчЪДш┐Щф║Ыц╡БчиЛхЕищГицШпх╝ВцнецУНф╜Ья╝МхРДчзНхЫЮш░Гч╗ХцЭеч╗ХхО╗чЪДя╝МщЬАшжБхПНхдНхЫЮцГ│ф╕Ля╝Мшп╗х╝Вцнеф╗гчаБх░▒цШпш┐Щца╖я╝МщЬАшжБчРЖц╕ЕхРДчзНхЫЮш░Гф╣ЛщЧ┤чЪДхЕ│ч│╗я╝М<strong>х╣╢ф╕ФцЧ╢хИ╗цПРщЖТшЗкх╖▒х╜УхЙНчЪДцЙзшбМч║┐чиЛцШпф╗Аф╣Ия╝Я</strong></p> <p>хе╜ф║Жя╝МчО░хЬи Netty цЬНхКбчлпх╖▓ч╗ПхРпхКиш╡╖цЭея╝МцОечЭАх░▒шпецОецФ╢ховцИ╖члпш┐ЮцОеф║Жя╝МцИСф╗мф╕ЛчпЗцЦЗчлашзБ~~~~</p> <h2 id="хПВшАГш╡ДцЦЩ"><a href="#хПВшАГш╡ДцЦЩ" class="header-anchor">#</a> хПВшАГш╡ДцЦЩ</h2> <p><a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484005&amp;idx=1&amp;sn=52f51269902a58f40d33208421109bc3&amp;chksm=ce77c422f9004d340e5b385ef6ba24dfba1f802076ace80ad6390e934173a10401e64e13eaeb&amp;scene=126&amp;sessionid=1726749878#rd" target="_blank" rel="noopener noreferrer">шпжч╗ЖхЫ╛шзг Netty Reactor хРпхКихЕиц╡БчиЛ | ф╕ЗхнЧщХ┐цЦЗ | хдЪхЫ╛щвДшнж (qq.com)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/echo-lxy/echo-system-design/edit/master/docs/Netty ч│╗ч╗Яшо╛шоб/25.хЫЫуАБц╖▒хЕе Netty ца╕х┐Г/11.чммф╕Йшп╛я╝ЪNetty Reactor хРпхКихЕиц╡БчиЛ.md" target="_blank" rel="noopener noreferrer">ч╝Цш╛С</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">ф╕КцмбцЫ┤цЦ░ф║О:</span> <span class="time">2024/09/19, 18:48:08</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        тЖР
        <a href="/pages/440035/" class="prev">чммф║Мшп╛я╝ЪReactorхЬи Netty ф╕нчЪДхоЮчО░я╝ИхИЫх╗║чпЗя╝Й</a></span> <span class="next"><a href="/pages/bb668a/">чммф╕Йшп╛я╝ЪNetty ца╕х┐Гх╝ХцУО Reactor чЪДш┐Рш╜мцЮ╢цЮД</a>тЖТ
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:lixinyang2002@163.com" title="хПСщВоф╗╢" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/echo-lxy" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="хРмщЯ│ф╣Р" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="цЬмчлЩф╕╗щвШ">Vdoing</a> 
    | Copyright ┬й 2024-2024
    <span>Xinyang Li | MIT License</span></div> <div class="buttons"><div title="ш┐ФхЫЮщб╢щГи" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="хО╗шпДшо║" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ф╕╗щвШцибх╝П" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          ш╖ЯщЪПч│╗ч╗Я
        </li><li class="iconfont icon-rijianmoshi">
          ц╡ЕшЙ▓цибх╝П
        </li><li class="iconfont icon-yejianmoshi">
          ц╖▒шЙ▓цибх╝П
        </li><li class="iconfont icon-yuedu">
          щШЕшп╗цибх╝П
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.78f2b9cc.js" defer></script><script src="/assets/js/2.933750c6.js" defer></script><script src="/assets/js/53.6f165300.js" defer></script><script src="/assets/js/7.7eb70372.js" defer></script>
  </body>
</html>
