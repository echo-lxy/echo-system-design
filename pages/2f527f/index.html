<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Netty Reactor å¯åŠ¨å…¨æµç¨‹ | EchoDesign</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="ç³»ç»Ÿè®¾è®¡ä¹‹ã€Œè®²è§£ + é¢è¯•æŒ‡å—ã€ï¼Œæ°´æ»´çŸ³ç©¿ï¼Œè®¾è®¡æ— é“¶å¼¹ï¼">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.f82a82e9.css" as="style"><link rel="preload" href="/assets/js/app.78f2b9cc.js" as="script"><link rel="preload" href="/assets/js/2.933750c6.js" as="script"><link rel="preload" href="/assets/js/53.6f165300.js" as="script"><link rel="preload" href="/assets/js/7.7eb70372.js" as="script"><link rel="prefetch" href="/assets/js/10.b313d17c.js"><link rel="prefetch" href="/assets/js/100.a9558091.js"><link rel="prefetch" href="/assets/js/101.007aa479.js"><link rel="prefetch" href="/assets/js/102.57bca734.js"><link rel="prefetch" href="/assets/js/11.c7521a10.js"><link rel="prefetch" href="/assets/js/12.f57a12da.js"><link rel="prefetch" href="/assets/js/13.d9d26d25.js"><link rel="prefetch" href="/assets/js/14.09cf8a64.js"><link rel="prefetch" href="/assets/js/15.d5a34c66.js"><link rel="prefetch" href="/assets/js/16.8cea924c.js"><link rel="prefetch" href="/assets/js/17.8d94c5e8.js"><link rel="prefetch" href="/assets/js/18.baad837c.js"><link rel="prefetch" href="/assets/js/19.571eaed1.js"><link rel="prefetch" href="/assets/js/20.d70e5281.js"><link rel="prefetch" href="/assets/js/21.0e0ed140.js"><link rel="prefetch" href="/assets/js/22.1ccaa6f3.js"><link rel="prefetch" href="/assets/js/23.623f0b5d.js"><link rel="prefetch" href="/assets/js/24.891fe6fb.js"><link rel="prefetch" href="/assets/js/25.41dca26b.js"><link rel="prefetch" href="/assets/js/26.6337eac0.js"><link rel="prefetch" href="/assets/js/27.de80589e.js"><link rel="prefetch" href="/assets/js/28.95a1fb6b.js"><link rel="prefetch" href="/assets/js/29.371a40e1.js"><link rel="prefetch" href="/assets/js/3.e62a71e4.js"><link rel="prefetch" href="/assets/js/30.e32f6b31.js"><link rel="prefetch" href="/assets/js/31.21bd2de1.js"><link rel="prefetch" href="/assets/js/32.f1174703.js"><link rel="prefetch" href="/assets/js/33.eab858f3.js"><link rel="prefetch" href="/assets/js/34.4ba0e53e.js"><link rel="prefetch" href="/assets/js/35.8287c9dc.js"><link rel="prefetch" href="/assets/js/36.b5f133ca.js"><link rel="prefetch" href="/assets/js/37.82be3556.js"><link rel="prefetch" href="/assets/js/38.40fe2658.js"><link rel="prefetch" href="/assets/js/39.6450065f.js"><link rel="prefetch" href="/assets/js/4.73518a0f.js"><link rel="prefetch" href="/assets/js/40.591baf2a.js"><link rel="prefetch" href="/assets/js/41.f961e422.js"><link rel="prefetch" href="/assets/js/42.b34f1599.js"><link rel="prefetch" href="/assets/js/43.5a509601.js"><link rel="prefetch" href="/assets/js/44.64fd3383.js"><link rel="prefetch" href="/assets/js/45.685623ac.js"><link rel="prefetch" href="/assets/js/46.b7523f9c.js"><link rel="prefetch" href="/assets/js/47.9bed4c1b.js"><link rel="prefetch" href="/assets/js/48.a1b270df.js"><link rel="prefetch" href="/assets/js/49.ee9681bc.js"><link rel="prefetch" href="/assets/js/5.b472a9bb.js"><link rel="prefetch" href="/assets/js/50.b424b2c0.js"><link rel="prefetch" href="/assets/js/51.53684c6e.js"><link rel="prefetch" href="/assets/js/52.a45a9bb1.js"><link rel="prefetch" href="/assets/js/54.61a6a81b.js"><link rel="prefetch" href="/assets/js/55.5391018d.js"><link rel="prefetch" href="/assets/js/56.e0b862ae.js"><link rel="prefetch" href="/assets/js/57.374534af.js"><link rel="prefetch" href="/assets/js/58.bb9706ba.js"><link rel="prefetch" href="/assets/js/59.6d5a538f.js"><link rel="prefetch" href="/assets/js/6.0b558b79.js"><link rel="prefetch" href="/assets/js/60.99b51260.js"><link rel="prefetch" href="/assets/js/61.33893dab.js"><link rel="prefetch" href="/assets/js/62.e6604fa3.js"><link rel="prefetch" href="/assets/js/63.e753bb13.js"><link rel="prefetch" href="/assets/js/64.59e76eda.js"><link rel="prefetch" href="/assets/js/65.66728f4b.js"><link rel="prefetch" href="/assets/js/66.30cbe3ea.js"><link rel="prefetch" href="/assets/js/67.9aea7c9b.js"><link rel="prefetch" href="/assets/js/68.79ee7ba7.js"><link rel="prefetch" href="/assets/js/69.a776cc2e.js"><link rel="prefetch" href="/assets/js/70.13d90b76.js"><link rel="prefetch" href="/assets/js/71.4f4c7733.js"><link rel="prefetch" href="/assets/js/72.b0948cb0.js"><link rel="prefetch" href="/assets/js/73.d7ed15dc.js"><link rel="prefetch" href="/assets/js/74.6884119c.js"><link rel="prefetch" href="/assets/js/75.b70b8a0c.js"><link rel="prefetch" href="/assets/js/76.2766fd7c.js"><link rel="prefetch" href="/assets/js/77.c9b76e03.js"><link rel="prefetch" href="/assets/js/78.9aa9da2e.js"><link rel="prefetch" href="/assets/js/79.ea5b4888.js"><link rel="prefetch" href="/assets/js/8.77b795dd.js"><link rel="prefetch" href="/assets/js/80.3c3f7534.js"><link rel="prefetch" href="/assets/js/81.76b7b1ed.js"><link rel="prefetch" href="/assets/js/82.7b7a2f1c.js"><link rel="prefetch" href="/assets/js/83.44c820ac.js"><link rel="prefetch" href="/assets/js/84.f53c8839.js"><link rel="prefetch" href="/assets/js/85.8c526118.js"><link rel="prefetch" href="/assets/js/86.e17eab25.js"><link rel="prefetch" href="/assets/js/87.a09f72d3.js"><link rel="prefetch" href="/assets/js/88.0f27b036.js"><link rel="prefetch" href="/assets/js/89.2fd11d59.js"><link rel="prefetch" href="/assets/js/9.36f81190.js"><link rel="prefetch" href="/assets/js/90.e60814ad.js"><link rel="prefetch" href="/assets/js/91.08cfa575.js"><link rel="prefetch" href="/assets/js/92.81c822a0.js"><link rel="prefetch" href="/assets/js/93.5f199263.js"><link rel="prefetch" href="/assets/js/94.266b7d71.js"><link rel="prefetch" href="/assets/js/95.0899dfb4.js"><link rel="prefetch" href="/assets/js/96.c1156914.js"><link rel="prefetch" href="/assets/js/97.18525931.js"><link rel="prefetch" href="/assets/js/98.ee554b1a.js"><link rel="prefetch" href="/assets/js/99.f0fb67c2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f82a82e9.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="ç›®å½•" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="EchoDesign" class="logo"> <span class="site-name can-hide">EchoDesign</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">ğŸ é¦–é¡µ</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">âœ’ï¸çƒ­é—¨ç®—æ³•</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ğŸ–ï¸èµæç»å…¸è®¾è®¡" class="dropdown-title"><!----> <span class="title" style="display:;">ğŸ–ï¸èµæç»å…¸è®¾è®¡</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">JUC ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ç³»ç»Ÿè®¾è®¡</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ğŸ§‘â€ğŸ’»å®æˆ˜ç³»ç»Ÿè®¾è®¡</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">â“é—®ç­”</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ğŸ‘€åŠ¨æ€</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">ğŸ é¦–é¡µ</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">âœ’ï¸çƒ­é—¨ç®—æ³•</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ğŸ–ï¸èµæç»å…¸è®¾è®¡" class="dropdown-title"><!----> <span class="title" style="display:;">ğŸ–ï¸èµæç»å…¸è®¾è®¡</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">JUC ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ç³»ç»Ÿè®¾è®¡</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ğŸ§‘â€ğŸ’»å®æˆ˜ç³»ç»Ÿè®¾è®¡</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">â“é—®ç­”</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ğŸ‘€åŠ¨æ€</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ä¸€ã€å‰è¨€</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>äºŒã€åŸºç¡€çŸ¥è¯†</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ä¸‰ã€ä¸»çº¿ä»»åŠ¡</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>å››ã€æ·±å…¥ Netty æ ¸å¿ƒ</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/65674f/" class="sidebar-link">ç¬¬ä¸€è¯¾ï¼šé€è¿‡ Netty ä»å†…æ ¸è§’åº¦çœ‹ IO æ¨¡å‹</a></li><li><a href="/pages/440035/" class="sidebar-link">ç¬¬äºŒè¯¾ï¼šReactoråœ¨ Netty ä¸­çš„å®ç°ï¼ˆåˆ›å»ºç¯‡ï¼‰</a></li><li><a href="/pages/2f527f/" aria-current="page" class="active sidebar-link">Netty Reactor å¯åŠ¨å…¨æµç¨‹</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/2f527f/#å‰è¨€" class="sidebar-link">å‰è¨€</a></li><li class="sidebar-sub-header level2"><a href="/pages/2f527f/#serverbootstrap" class="sidebar-link">ServerBootstrap</a></li><li class="sidebar-sub-header level2"><a href="/pages/2f527f/#_1-é…ç½®ä¸»ä»-reactor-çº¿ç¨‹ç»„" class="sidebar-link">1. é…ç½®ä¸»ä» Reactor çº¿ç¨‹ç»„</a></li><li class="sidebar-sub-header level2"><a href="/pages/2f527f/#_2-é…ç½®æœåŠ¡ç«¯-serversocketchannel" class="sidebar-link">2. é…ç½®æœåŠ¡ç«¯ ServerSocketChannel</a></li><li class="sidebar-sub-header level2"><a href="/pages/2f527f/#_3-ä¸º-nioserversocketchannel-é…ç½®-channeloption" class="sidebar-link">3. ä¸º NioServerSocketChannel é…ç½® ChannelOption</a></li><li class="sidebar-sub-header level2"><a href="/pages/2f527f/#_4-ä¸ºæœåŠ¡ç«¯-nioserversocketchannel-ä¸­çš„-pipeline-é…ç½®-channelhandler" class="sidebar-link">4. ä¸ºæœåŠ¡ç«¯ NioServerSocketChannel ä¸­çš„ Pipeline é…ç½® ChannelHandler</a></li><li class="sidebar-sub-header level2"><a href="/pages/2f527f/#_5-ä¸ºå®¢æˆ·ç«¯-niosocketchannel-ä¸­çš„-pipeline-é…ç½®-channelhandler" class="sidebar-link">5. ä¸ºå®¢æˆ·ç«¯ NioSocketChannel ä¸­çš„ Pipeline é…ç½® ChannelHandler</a></li><li class="sidebar-sub-header level2"><a href="/pages/2f527f/#channelinitializer" class="sidebar-link">ChannelInitializer</a></li><li class="sidebar-sub-header level2"><a href="/pages/2f527f/#netty-æœåŠ¡ç«¯çš„å¯åŠ¨" class="sidebar-link">Netty æœåŠ¡ç«¯çš„å¯åŠ¨</a></li><li class="sidebar-sub-header level2"><a href="/pages/2f527f/#æ€»ç»“" class="sidebar-link">æ€»ç»“</a></li><li class="sidebar-sub-header level2"><a href="/pages/2f527f/#å‚è€ƒèµ„æ–™" class="sidebar-link">å‚è€ƒèµ„æ–™</a></li></ul></li><li><a href="/pages/bb668a/" class="sidebar-link">ç¬¬ä¸‰è¯¾ï¼šNetty æ ¸å¿ƒå¼•æ“ Reactor çš„è¿è½¬æ¶æ„</a></li><li><a href="/pages/be98dc/" class="sidebar-link">ç¬¬å››è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œè¿æ¥</a></li><li><a href="/pages/0938c1/" class="sidebar-link">ç¬¬äº”è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œæ•°æ®</a></li><li><a href="/pages/a73206/" class="sidebar-link">ç¬¬å…­è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆå‘é€ç½‘ç»œæ•°æ®</a></li><li><a href="/pages/a1b0fe/" class="sidebar-link">ç¬¬ä¸ƒè¯¾ï¼šNetty ä¸­IOäº‹ä»¶çš„è§¦å‘æ—¶æœºå’Œä¼ æ’­æµç¨‹</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>äº”ã€æ·±å…¥ Netty å†…å­˜ç®¡ç†</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="é¦–é¡µ" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>Netty ç³»ç»Ÿè®¾è®¡</span></li><li data-v-06225672><span data-v-06225672>å››ã€æ·±å…¥ Netty æ ¸å¿ƒ</span></li></ul> <div class="info" data-v-06225672><div title="ä½œè€…" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/brother-one" target="_blank" title="ä½œè€…" class="beLink" data-v-06225672>echo</a></div> <div title="åˆ›å»ºæ—¶é—´" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-09-19</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">ç›®å½•</div> <div class="right-menu-content"></div></div></div> <h1><!---->Netty Reactor å¯åŠ¨å…¨æµç¨‹<!----></h1> <div class="page-slot page-slot-top">
    <div class="wwads-cn wwads-horizontal page-wwads" data-id="136"></div>
    <style>
      .page-wwads{
        width:100%!important;
        min-height: 0;
        margin: 0;
      }
      .page-wwads .wwads-img img{
        width:80px!important;
      }
      .page-wwads .wwads-poweredby{
        width: 40px;
        position: absolute;
        right: 25px;
        bottom: 3px;
      }
      .wwads-content .wwads-text, .page-wwads .wwads-text{
        height: 100%;
        padding-top: 5px;
        display: block;
      }
  </style>
  </div> <div class="theme-vdoing-content content__default"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="header-anchor">#</a> å‰è¨€</h2> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192050578.webp" alt="å›¾ç‰‡"></p> <p>å¤§å®¶ç¬¬ä¸€çœ¼çœ‹åˆ°è¿™å¹…æµç¨‹å›¾ï¼Œæ˜¯ä¸æ˜¯è„‘ç“œå­å—¡å—¡çš„å‘¢ï¼Ÿ</p> <p>å¤§å®¶å…ˆä¸è¦æƒŠæ…Œï¼Œé—®é¢˜ä¸å¤§ï¼Œæœ¬æ–‡ç¬”è€…çš„ç›®çš„å°±æ˜¯è¦è®©å¤§å®¶æ¸…æ™°çš„ç†è§£è¿™å¹…æµç¨‹å›¾ï¼Œä»è€Œæ·±åˆ»çš„ç†è§£ Netty Reactor çš„å¯åŠ¨å…¨æµç¨‹ï¼ŒåŒ…æ‹¬å…¶ä¸­æ¶‰åŠåˆ°çš„å„ç§ä»£ç è®¾è®¡å®ç°ç»†èŠ‚</p> <p>åœ¨ä¸Šç¯‡æ–‡ç« <a href="/pages/440035/">ã€Šç¬¬äºŒè¯¾ï¼šReator åœ¨ Netty ä¸­çš„å®ç°ï¼ˆåˆ›å»ºç¯‡ï¼‰ã€‹</a>ä¸­æˆ‘ä»¬è¯¦ç»†ä»‹ç»äº† Netty æœåŠ¡ç«¯æ ¸å¿ƒå¼•æ“ç»„ä»¶<code>ä¸»ä»Reactorç»„æ¨¡å‹ NioEventLoopGroup</code>ä»¥åŠ<code>Reactoræ¨¡å‹ NioEventLoop</code>çš„åˆ›å»ºè¿‡ç¨‹ã€‚æœ€ç»ˆæˆ‘ä»¬å¾—åˆ°äº† netty Reactor æ¨¡å‹çš„è¿è¡Œéª¨æ¶å¦‚ä¸‹ï¼š</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192048631.webp" alt="å›¾ç‰‡"></p> <p>ç°åœ¨ Netty æœåŠ¡ç«¯ç¨‹åºçš„éª¨æ¶æ˜¯æ­å»ºå¥½äº†ï¼Œæœ¬æ–‡æˆ‘ä»¬å°±åŸºäºè¿™ä¸ªéª¨æ¶æ¥æ·±å…¥å‰–æä¸‹ Netty æœåŠ¡ç«¯çš„å¯åŠ¨è¿‡ç¨‹ã€‚</p> <p>æˆ‘ä»¬ç»§ç»­å›åˆ°ä¸Šç¯‡æ–‡ç« æåˆ°çš„ Netty æœåŠ¡ç«¯ä»£ç æ¨¡æ¿ä¸­ï¼Œåœ¨åˆ›å»ºå®Œä¸»ä» Reactor çº¿ç¨‹ç»„ï¼š<code>bossGroup</code>ï¼Œ<code>workerGroup</code>åï¼Œæ¥ä¸‹æ¥å°±å¼€å§‹é…ç½® Netty æœåŠ¡ç«¯çš„å¯åŠ¨è¾…åŠ©ç±»<code>ServerBootstrap</code>äº†ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">EchoServer</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">PORT</span> <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;port&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;8007&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// Configure the server.</span>
        <span class="token comment">//åˆ›å»ºä¸»ä»Reactorçº¿ç¨‹ç»„</span>
        <span class="token class-name">EventLoopGroup</span> bossGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EventLoopGroup</span> workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">EchoServerHandler</span> serverHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EchoServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span><span class="token comment">//é…ç½®ä¸»ä»Reactor</span>
             <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token comment">//é…ç½®ä¸»Reactorä¸­çš„channelç±»å‹</span>
             <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_BACKLOG</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token comment">//è®¾ç½®ä¸»Reactorä¸­channelçš„optioné€‰é¡¹</span>
             <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoggingHandler</span><span class="token punctuation">(</span><span class="token class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">INFO</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//è®¾ç½®ä¸»Reactorä¸­Channel-&gt;pipline-&gt;handler</span>
             <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//è®¾ç½®ä»Reactorä¸­æ³¨å†Œchannelçš„pipeline</span>
                 <span class="token annotation punctuation">@Override</span>
                 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                     <span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token comment">//p.addLast(new LoggingHandler(LogLevel.INFO));</span>
                     p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>serverHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token punctuation">}</span>
             <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Start the server. ç»‘å®šç«¯å£å¯åŠ¨æœåŠ¡ï¼Œå¼€å§‹ç›‘å¬acceptäº‹ä»¶</span>
            <span class="token class-name">ChannelFuture</span> f <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Wait until the server socket is closed.</span>
            f<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// Shut down all event loops to terminate all threads.</span>
            bossGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            workerGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨ä¸Šç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å¯¹ä»£ç æ¨¡æ¿ä¸­æ¶‰åŠåˆ°<code>ServerBootstrap</code>çš„ä¸€äº›é…ç½®æ–¹æ³•åšäº†ç®€å•çš„ä»‹ç»ï¼Œå¤§å®¶å¦‚æœå¿˜è®°çš„è¯ï¼Œå¯ä»¥åœ¨è¿”å›å»å›é¡¾ä¸€ä¸‹ã€‚</p> <p><code>ServerBootstrapç±»</code>å…¶å®æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„é€»è¾‘ï¼Œä¸»è¦æ˜¯å¯¹ Netty å¯åŠ¨è¿‡ç¨‹ä¸­éœ€è¦ç”¨åˆ°çš„ä¸€äº›æ ¸å¿ƒä¿¡æ¯è¿›è¡Œé…ç½®ç®¡ç†ï¼Œæ¯”å¦‚ï¼š</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192048098.webp" alt="å›¾ç‰‡"></p> <ul><li>Netty çš„æ ¸å¿ƒå¼•æ“ç»„ä»¶<code>ä¸»ä»Reactorçº¿ç¨‹ç»„ï¼šbossGroupï¼ŒworkerGroup</code>ã€‚é€šè¿‡<code>ServerBootstrap#groupæ–¹æ³•</code>é…ç½®ã€‚</li> <li>Netty æœåŠ¡ç«¯ä½¿ç”¨åˆ°çš„ Channel ç±»å‹ï¼š<code>NioServerSocketChannel</code> ,é€šè¿‡<code>ServerBootstrap#channelæ–¹æ³•</code>é…ç½®ã€‚ä»¥åŠé…ç½®<code>NioServerSocketChannel</code>æ—¶ç”¨åˆ°çš„<code>SocketOption</code>ã€‚<code>SocketOption</code>ç”¨äºè®¾ç½®åº•å±‚ JDK NIO Socket çš„ä¸€äº›é€‰é¡¹ã€‚é€šè¿‡<code>ServerBootstrap#optionæ–¹æ³•</code>è¿›è¡Œé…ç½®ã€‚</li></ul> <blockquote><p>ä¸» ReactorGroup ä¸­çš„ MainReactor ç®¡ç†çš„ Channel ç±»å‹ä¸º<code>NioServerSocketChannel</code>ï¼Œå¦‚å›¾æ‰€ç¤ºä¸»è¦ç”¨æ¥ç›‘å¬ç«¯å£ï¼Œæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ï¼Œä¸ºå®¢æˆ·ç«¯åˆ›å»ºåˆå§‹åŒ–<code>NioSocketChannel</code>ï¼Œç„¶åé‡‡ç”¨<code>round-robin</code>è½®è¯¢çš„æ–¹å¼ä»å›¾ä¸­ä» ReactorGroup ä¸­é€‰æ‹©ä¸€ä¸ª SubReactor ä¸è¯¥å®¢æˆ·ç«¯<code>NioSocketChannel</code>è¿›è¡Œç»‘å®šã€‚</p></blockquote> <blockquote><p>ä» ReactorGroup ä¸­çš„ SubReactor ç®¡ç†çš„ Channel ç±»å‹ä¸º<code>NioSocketChannel</code>ï¼Œå®ƒæ˜¯ netty ä¸­å®šä¹‰å®¢æˆ·ç«¯è¿æ¥çš„ä¸€ä¸ªæ¨¡å‹ï¼Œæ¯ä¸ªè¿æ¥å¯¹åº”ä¸€ä¸ªã€‚å¦‚å›¾æ‰€ç¤º SubReactor è´Ÿè´£ç›‘å¬å¤„ç†ç»‘å®šåœ¨å…¶ä¸Šçš„æ‰€æœ‰<code>NioSocketChannel</code>ä¸Šçš„ IO äº‹ä»¶ã€‚</p></blockquote> <ul><li>ä¿å­˜æœåŠ¡ç«¯<code>NioServerSocketChannel</code>å’Œå®¢æˆ·ç«¯<code>NioSocketChannel</code>å¯¹åº”<code>pipeline</code>ä¸­æŒ‡å®šçš„<code>ChannelHandler</code>ã€‚ç”¨äºåç»­ Channel å‘ Reactor æ³¨å†ŒæˆåŠŸä¹‹åï¼Œåˆå§‹åŒ– Channel é‡Œçš„ pipelineã€‚</li></ul> <blockquote><p>ä¸ç®¡æ˜¯æœåŠ¡ç«¯ç”¨åˆ°çš„<code>NioServerSocketChannel</code>è¿˜æ˜¯å®¢æˆ·ç«¯ç”¨åˆ°çš„<code>NioSocketChannel</code>ï¼Œæ¯ä¸ª<code>Channelå®ä¾‹</code>éƒ½ä¼šæœ‰ä¸€ä¸ª<code>Pipeline</code>ï¼Œ<code>Pipeline</code>ä¸­æœ‰å¤šä¸ª<code>ChannelHandler</code>ç”¨äºç¼–æ’å¤„ç†å¯¹åº”<code>Channel</code>ä¸Šæ„Ÿå…´è¶£çš„<code>IOäº‹ä»¶</code>ã€‚</p></blockquote> <p><code>ServerBootstrap</code>ç»“æ„ä¸­åŒ…å«äº† netty æœåŠ¡ç«¯ç¨‹åºå¯åŠ¨çš„æ‰€æœ‰é…ç½®ä¿¡æ¯ï¼Œåœ¨æˆ‘ä»¬ä»‹ç»å¯åŠ¨æµç¨‹ä¹‹å‰ï¼Œå…ˆæ¥çœ‹ä¸‹<code>ServerBootstrap</code>çš„æºç ç»“æ„ï¼š</p> <h2 id="serverbootstrap"><a href="#serverbootstrap" class="header-anchor">#</a> ServerBootstrap</h2> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192050513.webp" alt="å›¾ç‰‡"></p> <p><code>ServerBootstrap</code>çš„ç»§æ‰¿ç»“æ„æ¯”è¾ƒç®€å•ï¼Œç»§æ‰¿å±‚æ¬¡çš„èŒè´£åˆ†å·¥ä¹Ÿæ¯”è¾ƒæ˜ç¡®ã€‚</p> <p><code>ServerBootstrap</code>ä¸»è¦è´Ÿè´£å¯¹<code>ä¸»ä»Reactorçº¿ç¨‹ç»„</code>ç›¸å…³çš„é…ç½®è¿›è¡Œç®¡ç†ï¼Œå…¶ä¸­å¸¦<code>childå‰ç¼€çš„é…ç½®æ–¹æ³•</code>æ˜¯å¯¹<code>ä»Reactorçº¿ç¨‹ç»„</code>çš„ç›¸å…³é…ç½®ç®¡ç†ã€‚<code>ä»Reactorçº¿ç¨‹ç»„</code>ä¸­çš„<code>Sub Reactor</code>è´Ÿè´£ç®¡ç†çš„å®¢æˆ·ç«¯<code>NioSocketChannel</code>ç›¸å…³é…ç½®å­˜å‚¨åœ¨<code>ServerBootstrap</code>ç»“æ„ä¸­ã€‚</p> <p>çˆ¶ç±»<code>AbstractBootstrap</code>åˆ™æ˜¯ä¸»è¦è´Ÿè´£å¯¹<code>ä¸»Reactorçº¿ç¨‹ç»„</code>ç›¸å…³çš„é…ç½®è¿›è¡Œç®¡ç†ï¼Œä»¥åŠ<code>ä¸»Reactorçº¿ç¨‹ç»„</code>ä¸­çš„<code>Main Reactor</code>è´Ÿè´£å¤„ç†çš„æœåŠ¡ç«¯<code>ServerSocketChannel</code>ç›¸å…³çš„é…ç½®ç®¡ç†</p> <h2 id="_1-é…ç½®ä¸»ä»-reactor-çº¿ç¨‹ç»„"><a href="#_1-é…ç½®ä¸»ä»-reactor-çº¿ç¨‹ç»„" class="header-anchor">#</a> 1. é…ç½®ä¸»ä» Reactor çº¿ç¨‹ç»„</h2> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span><span class="token comment">//é…ç½®ä¸»ä»Reactor</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServerBootstrap</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractBootstrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerBootstrap</span><span class="token punctuation">,</span> <span class="token class-name">ServerChannel</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token comment">//Main Reactor çº¿ç¨‹ç»„</span>
    <span class="token keyword">volatile</span> <span class="token class-name">EventLoopGroup</span> group<span class="token punctuation">;</span>

    <span class="token comment">//Sub Reactor çº¿ç¨‹ç»„</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">EventLoopGroup</span> childGroup<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ServerBootstrap</span> <span class="token function">group</span><span class="token punctuation">(</span><span class="token class-name">EventLoopGroup</span> parentGroup<span class="token punctuation">,</span> <span class="token class-name">EventLoopGroup</span> childGroup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//çˆ¶ç±»ç®¡ç†ä¸» Reactor çº¿ç¨‹ç»„</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>parentGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>childGroup <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;childGroup set already&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>childGroup <span class="token operator">=</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>childGroup<span class="token punctuation">,</span> <span class="token string">&quot;childGroup&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h2 id="_2-é…ç½®æœåŠ¡ç«¯-serversocketchannel"><a href="#_2-é…ç½®æœåŠ¡ç«¯-serversocketchannel" class="header-anchor">#</a> 2. é…ç½®æœåŠ¡ç«¯ ServerSocketChannel</h2> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServerBootstrap</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractBootstrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerBootstrap</span><span class="token punctuation">,</span> <span class="token class-name">ServerChannel</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token comment">//ç”¨äºåˆ›å»ºServerSocketChannel  ReflectiveChannelFactory</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">ChannelFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">C</span><span class="token punctuation">&gt;</span></span> channelFactory<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">B</span> <span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">C</span><span class="token punctuation">&gt;</span></span> channelClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">channelFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReflectiveChannelFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>channelClass<span class="token punctuation">,</span> <span class="token string">&quot;channelClass&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Deprecated</span>
    <span class="token keyword">public</span> <span class="token class-name">B</span> <span class="token function">channelFactory</span><span class="token punctuation">(</span><span class="token class-name">ChannelFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">C</span><span class="token punctuation">&gt;</span></span> channelFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>channelFactory<span class="token punctuation">,</span> <span class="token string">&quot;channelFactory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>channelFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;channelFactory set already&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>channelFactory <span class="token operator">=</span> channelFactory<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨å‘<code>ServerBootstrap</code>é…ç½®æœåŠ¡ç«¯<code>ServerSocketChannel</code>çš„<code>channel</code>æ–¹æ³•ä¸­ï¼Œå…¶å®æ˜¯åˆ›å»ºäº†ä¸€ä¸ª<code>ChannelFactory</code>å·¥å‚å®ä¾‹<code>ReflectiveChannelFactory</code>ï¼Œåœ¨ Netty æœåŠ¡ç«¯å¯åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œä¼šé€šè¿‡è¿™ä¸ª<code>ChannelFactory</code>å»åˆ›å»ºç›¸åº”çš„<code>Channel</code>å®ä¾‹ã€‚</p> <p>æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªæ–¹æ³•æ¥é…ç½® netty çš„ IO æ¨¡å‹ï¼Œä¸‹é¢ä¸º<code>ServerSocketChannel</code>åœ¨ä¸åŒ IO æ¨¡å‹ä¸‹çš„å®ç°ï¼š</p> <table><thead><tr><th style="text-align:center;">BIO</th> <th style="text-align:center;">NIO</th> <th style="text-align:center;">AIO</th></tr></thead> <tbody><tr><td style="text-align:center;">OioServerSocketChannel</td> <td style="text-align:center;">NioServerSocketChannel</td> <td style="text-align:center;">AioServerSocketChannel</td></tr></tbody></table> <p><code>EventLoopGroup</code>Reactor çº¿ç¨‹ç»„åœ¨ä¸åŒ IO æ¨¡å‹ä¸‹çš„å®ç°ï¼š</p> <table><thead><tr><th style="text-align:center;">BIO</th> <th style="text-align:center;">NIO</th> <th style="text-align:center;">AIO</th></tr></thead> <tbody><tr><td style="text-align:center;">ThreadPerChannelEventLoopGroup</td> <td style="text-align:center;">NioEventLoopGroup</td> <td style="text-align:center;">AioEventLoopGroup</td></tr></tbody></table> <p>æˆ‘ä»¬åªéœ€è¦å°†<code>IOæ¨¡å‹</code>çš„è¿™äº›æ ¸å¿ƒæ¥å£å¯¹åº”çš„å®ç°ç±»<code>å‰ç¼€</code>æ”¹ä¸ºå¯¹åº”<code>IOæ¨¡å‹</code>çš„å‰ç¼€ï¼Œå°±å¯ä»¥è½»æ¾åœ¨ Netty ä¸­å®Œæˆå¯¹<code>IOæ¨¡å‹</code>çš„åˆ‡æ¢ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192053959.webp" alt="å›¾ç‰‡"></p> <h3 id="_2-1-reflectivechannelfactory"><a href="#_2-1-reflectivechannelfactory" class="header-anchor">#</a> 2.1 ReflectiveChannelFactory</h3> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReflectiveChannelFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">ChannelFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">//NioServerSocketChannelde æ„é€ å™¨</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> constructor<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ReflectiveChannelFactory</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token string">&quot;clazz&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//åå°„è·å–NioServerSocketChannelçš„æ„é€ å™¨</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>constructor <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Class &quot;</span> <span class="token operator">+</span> <span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">simpleClassName</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span> <span class="token operator">+</span>
                    <span class="token string">&quot; does not have a public non-arg constructor&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">newChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//åˆ›å»ºNioServerSocketChannelå®ä¾‹</span>
            <span class="token keyword">return</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ChannelException</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to create Channel from class &quot;</span> <span class="token operator">+</span> constructor<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä»ç±»çš„ç­¾åæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªå·¥å‚ç±»æ˜¯é€šè¿‡<code>æ³›å‹</code>åŠ <code>åå°„</code>çš„æ–¹å¼æ¥åˆ›å»ºå¯¹åº”çš„<code>Channel</code>å®ä¾‹ã€‚</p> <ul><li>æ³›å‹å‚æ•°<code>T extends Channel</code>è¡¨ç¤ºçš„æ˜¯è¦é€šè¿‡å·¥å‚ç±»åˆ›å»ºçš„<code>Channelç±»å‹</code>ï¼Œè¿™é‡Œæˆ‘ä»¬åˆå§‹åŒ–çš„æ˜¯<code>NioServerSocketChannel</code>ã€‚</li> <li>åœ¨<code>ReflectiveChannelFactory</code>çš„æ„é€ å™¨ä¸­é€šè¿‡<code>åå°„</code>çš„æ–¹å¼è·å–<code>NioServerSocketChannel</code>çš„æ„é€ å™¨ã€‚</li> <li>åœ¨<code>newChannel</code>æ–¹æ³•ä¸­é€šè¿‡æ„é€ å™¨åå°„åˆ›å»º<code>NioServerSocketChannel</code>å®ä¾‹ã€‚</li></ul> <p><strong>æ³¨æ„</strong>è¿™æ—¶åªæ˜¯é…ç½®é˜¶æ®µï¼Œ<code>NioServerSocketChannel</code>æ­¤æ—¶å¹¶æœªè¢«åˆ›å»ºã€‚å®ƒæ˜¯åœ¨å¯åŠ¨çš„æ—¶å€™æ‰ä¼šè¢«åˆ›å»ºå‡ºæ¥ã€‚</p> <h2 id="_3-ä¸º-nioserversocketchannel-é…ç½®-channeloption"><a href="#_3-ä¸º-nioserversocketchannel-é…ç½®-channeloption" class="header-anchor">#</a> 3. ä¸º NioServerSocketChannel é…ç½® ChannelOption</h2> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//è®¾ç½®è¢«MainReactorç®¡ç†çš„NioServerSocketChannelçš„Socketé€‰é¡¹</span>
b<span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_BACKLOG</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractBootstrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractBootstrap</span><span class="token punctuation">&lt;</span><span class="token class-name">B</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">C</span> <span class="token keyword">extends</span> <span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Cloneable</span> <span class="token punctuation">{</span>

    <span class="token comment">//serverSocketChannelä¸­çš„ChannelOptioné…ç½®</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelOption</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelOption</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">B</span> <span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> option<span class="token punctuation">,</span> <span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>option<span class="token punctuation">,</span> <span class="token string">&quot;option&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                options<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                options<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>option<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ— è®ºæ˜¯æœåŠ¡ç«¯çš„<code>NioServerSocketChannel</code>è¿˜æ˜¯å®¢æˆ·ç«¯çš„<code>NioSocketChannel</code>å®ƒä»¬çš„ç›¸å…³åº•å±‚ Socket é€‰é¡¹<code>ChannelOption</code>é…ç½®å…¨éƒ¨å­˜æ”¾äºä¸€ä¸ª<code>Map</code>ç±»å‹çš„æ•°æ®ç»“æ„ä¸­ã€‚</p> <p>ç”±äºå®¢æˆ·ç«¯<code>NioSocketChannel</code>æ˜¯ç”±<code>ä»Reactorçº¿ç¨‹ç»„</code>ä¸­çš„<code>Sub Reactor</code>æ¥è´Ÿè´£å¤„ç†ï¼Œæ‰€ä»¥æ¶‰åŠåˆ°å®¢æˆ·ç«¯<code>NioSocketChannel</code>æ‰€æœ‰çš„æ–¹æ³•å’Œé…ç½®å…¨éƒ¨æ˜¯ä»¥<code>child</code>å‰ç¼€å¼€å¤´ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token function">childOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">TCP_NODELAY</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServerBootstrap</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractBootstrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerBootstrap</span><span class="token punctuation">,</span> <span class="token class-name">ServerChannel</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

   <span class="token comment">//å®¢æˆ·ç«¯SocketChannelå¯¹åº”çš„ChannelOptioné…ç½®</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelOption</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> childOptions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelOption</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">ServerBootstrap</span> <span class="token function">childOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> childOption<span class="token punctuation">,</span> <span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>childOption<span class="token punctuation">,</span> <span class="token string">&quot;childOption&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>childOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                childOptions<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>childOption<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                childOptions<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>childOption<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ç›¸å…³çš„åº•å±‚ Socket é€‰é¡¹ï¼Œnetty å…¨éƒ¨æšä¸¾åœ¨ ChannelOption ç±»ä¸­ï¼Œç¬”è€…è¿™é‡Œå°±ä¸ä¸€ä¸€åˆ—ä¸¾äº†ï¼Œåœ¨æœ¬ç³»åˆ—åç»­ç›¸å…³çš„æ–‡ç« ä¸­ï¼Œç¬”è€…è¿˜ä¼šä¸ºå¤§å®¶è¯¦ç»†çš„ä»‹ç»è¿™äº›å‚æ•°çš„ä½œç”¨ã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChannelOption</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractConstant</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelOption</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ChannelOption</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token constant">SO_BROADCAST</span> <span class="token operator">=</span> <span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;SO_BROADCAST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ChannelOption</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token constant">SO_KEEPALIVE</span> <span class="token operator">=</span> <span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;SO_KEEPALIVE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ChannelOption</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token constant">SO_SNDBUF</span> <span class="token operator">=</span> <span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;SO_SNDBUF&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ChannelOption</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token constant">SO_RCVBUF</span> <span class="token operator">=</span> <span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;SO_RCVBUF&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ChannelOption</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token constant">SO_REUSEADDR</span> <span class="token operator">=</span> <span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;SO_REUSEADDR&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ChannelOption</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token constant">SO_LINGER</span> <span class="token operator">=</span> <span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;SO_LINGER&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ChannelOption</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token constant">SO_BACKLOG</span> <span class="token operator">=</span> <span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;SO_BACKLOG&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ChannelOption</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token constant">SO_TIMEOUT</span> <span class="token operator">=</span> <span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;SO_TIMEOUT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token punctuation">}</span>
</code></pre></div><h2 id="_4-ä¸ºæœåŠ¡ç«¯-nioserversocketchannel-ä¸­çš„-pipeline-é…ç½®-channelhandler"><a href="#_4-ä¸ºæœåŠ¡ç«¯-nioserversocketchannel-ä¸­çš„-pipeline-é…ç½®-channelhandler" class="header-anchor">#</a> 4. ä¸ºæœåŠ¡ç«¯ NioServerSocketChannel ä¸­çš„ Pipeline é…ç½® ChannelHandler</h2> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">//serverSocketChannel ä¸­ pipeline é‡Œçš„ handler(ä¸»è¦æ˜¯ acceptor)</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">B</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>handler <span class="token operator">=</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> <span class="token string">&quot;handler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å‘<code>NioServerSocketChannel</code>ä¸­çš„<code>Pipeline</code>æ·»åŠ <code>ChannelHandler</code>åˆ†ä¸ºä¸¤ç§æ–¹å¼ï¼š</p> <ul><li><code>æ˜¾å¼æ·»åŠ ï¼š</code> æ˜¾å¼æ·»åŠ çš„æ–¹å¼æ˜¯ç”±ç”¨æˆ·åœ¨ main çº¿ç¨‹ä¸­é€šè¿‡<code>ServerBootstrap#handler</code>çš„æ–¹å¼æ·»åŠ ã€‚å¦‚æœéœ€è¦æ·»åŠ å¤šä¸ª<code>ChannelHandler</code>ï¼Œåˆ™å¯ä»¥é€šè¿‡<code>ChannelInitializer</code>å‘<code>pipeline</code>ä¸­è¿›è¡Œæ·»åŠ ã€‚</li></ul> <blockquote><p>å…³äº<code>ChannelInitializer</code>åé¢ç¬”è€…ä¼šæœ‰è¯¦ç»†ä»‹ç»ï¼Œè¿™é‡Œå¤§å®¶åªéœ€è¦çŸ¥é“<code>ChannelInitializer</code>æ˜¯ä¸€ç§<strong>ç‰¹æ®Šçš„</strong><code>ChannelHandler</code>ï¼Œç”¨äºåˆå§‹åŒ–<code>pipeline</code>ã€‚é€‚ç”¨äºå‘ pipeline ä¸­æ·»åŠ å¤šä¸ª ChannelHandler çš„åœºæ™¯ã€‚</p></blockquote> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span><span class="token comment">//é…ç½®ä¸»ä»Reactor</span>
    <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token comment">//é…ç½®ä¸»Reactorä¸­çš„channelç±»å‹</span>
    <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>channelhandler1<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>channelHandler2<span class="token punctuation">)</span>

                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

                <span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>channelHandler3<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><code>éšå¼æ·»åŠ ï¼š</code>éšå¼æ·»åŠ ä¸»è¦æ·»åŠ çš„å°±æ˜¯<code>ä¸»ReactorGroup</code>çš„æ ¸å¿ƒç»„ä»¶ä¹Ÿå°±æ˜¯ä¸‹å›¾ä¸­çš„<code>acceptor</code>ï¼ŒNetty ä¸­çš„å®ç°ä¸º<code>ServerBootstrapAcceptor</code>ï¼Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ç§<code>ChannelHandler</code>ï¼Œä¸»è¦è´Ÿè´£åœ¨å®¢æˆ·ç«¯è¿æ¥å»ºç«‹å¥½åï¼Œåˆå§‹åŒ–å®¢æˆ·ç«¯<code>NioSocketChannel</code>ï¼Œåœ¨<code>ä»Reactorçº¿ç¨‹ç»„ä¸­</code>é€‰å–ä¸€ä¸ª<code>Sub Reactor</code>ï¼Œå°†å®¢æˆ·ç«¯<code>NioSocketChannel</code> æ³¨å†Œåˆ°<code>Sub Reactor</code>ä¸­çš„<code>selector</code>ä¸Šã€‚</li></ul> <blockquote><p>éšå¼æ·»åŠ <code>ServerBootstrapAcceptor</code>æ˜¯ç”± Netty æ¡†æ¶åœ¨å¯åŠ¨çš„æ—¶å€™è´Ÿè´£æ·»åŠ ï¼Œç”¨æˆ·æ— éœ€å…³å¿ƒã€‚</p></blockquote> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192048576.webp" alt="å›¾ç‰‡"></p> <p>åœ¨æœ¬ä¾‹ä¸­ï¼Œ<code>NioServerSocketChannel</code>çš„<code>PipeLine</code>ä¸­åªæœ‰ä¸¤ä¸ª<code>ChannelHandler</code>,ä¸€ä¸ªç”±ç”¨æˆ·åœ¨å¤–éƒ¨æ˜¾å¼æ·»åŠ çš„<code>LoggingHandler</code>,å¦ä¸€ä¸ªæ˜¯ç”± Netty æ¡†æ¶éšå¼æ·»åŠ çš„<code>ServerBootstrapAcceptor</code>ã€‚</p> <blockquote><p>å…¶å®æˆ‘ä»¬åœ¨å®é™…é¡¹ç›®ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œä¸ä¼šå‘ netty æœåŠ¡ç«¯<code>NioServerSocketChannel</code>æ·»åŠ é¢å¤–çš„ ChannelHandlerï¼Œ<code>NioServerSocketChannel</code>åªéœ€è¦ä¸“å¿ƒåšå¥½è‡ªå·±æœ€é‡è¦çš„æœ¬èŒå·¥ä½œæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥å°±å¥½äº†ã€‚è¿™é‡Œé¢å¤–æ·»åŠ ä¸€ä¸ª<code>LoggingHandler</code>åªæ˜¯ä¸ºäº†å‘å¤§å®¶å±•ç¤º<code>ServerBootstrap</code>çš„é…ç½®æ–¹æ³•ã€‚</p></blockquote> <h2 id="_5-ä¸ºå®¢æˆ·ç«¯-niosocketchannel-ä¸­çš„-pipeline-é…ç½®-channelhandler"><a href="#_5-ä¸ºå®¢æˆ·ç«¯-niosocketchannel-ä¸­çš„-pipeline-é…ç½®-channelhandler" class="header-anchor">#</a> 5. ä¸ºå®¢æˆ·ç«¯ NioSocketChannel ä¸­çš„ Pipeline é…ç½® ChannelHandler</h2> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">EchoServerHandler</span> serverHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EchoServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

serverBootstrap<span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//è®¾ç½®ä»Reactorä¸­æ³¨å†Œchannelçš„pipeline</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoggingHandler</span><span class="token punctuation">(</span><span class="token class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">INFO</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>serverHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//socketChannelä¸­pipelineä¸­çš„å¤„ç†handler</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">ChannelHandler</span> childHandler<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">ServerBootstrap</span> <span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> childHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>childHandler <span class="token operator">=</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>childHandler<span class="token punctuation">,</span> <span class="token string">&quot;childHandler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å‘å®¢æˆ·ç«¯<code>NioSocketChannel</code>ä¸­çš„<code>Pipeline</code>é‡Œæ·»åŠ <code>ChannelHandler</code>å®Œå…¨æ˜¯ç”±ç”¨æˆ·è‡ªå·±æ§åˆ¶æ˜¾å¼æ·»åŠ ï¼Œæ·»åŠ çš„æ•°é‡ä¸å—é™åˆ¶ã€‚</p> <p>ç”±äºåœ¨ Netty çš„<code>IOçº¿ç¨‹æ¨¡å‹</code>ä¸­ï¼Œæ˜¯ç”±å•ä¸ª<code>Sub Reactorçº¿ç¨‹</code>è´Ÿè´£æ‰§è¡Œå®¢æˆ·ç«¯<code>NioSocketChannel</code>ä¸­çš„<code>Pipeline</code>ï¼Œä¸€ä¸ª<code>Sub Reactorçº¿ç¨‹</code>è´Ÿè´£å¤„ç†å¤šä¸ª<code>NioSocketChannel</code>ä¸Šçš„<code>IOäº‹ä»¶</code>ï¼Œå¦‚æœ<code>Pipeline</code>ä¸­çš„<code>ChannelHandler</code>æ·»åŠ çš„å¤ªå¤šï¼Œå°±ä¼šå½±å“<code>Sub Reactorçº¿ç¨‹</code>æ‰§è¡Œå…¶ä»–<code>NioSocketChannel</code>ä¸Šçš„<code>Pipeline</code>ï¼Œä»è€Œé™ä½<code>IOå¤„ç†æ•ˆç‡</code>ï¼Œé™ä½ååé‡ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192057209.webp" alt="å›¾ç‰‡"></p> <p>æ‰€ä»¥<code>Pipeline</code>ä¸­çš„<code>ChannelHandler</code>ä¸æ˜“æ·»åŠ è¿‡å¤šï¼Œå¹¶ä¸”ä¸èƒ½å†<code>ChannelHandler</code>ä¸­æ‰§è¡Œè€—æ—¶çš„ä¸šåŠ¡å¤„ç†ä»»åŠ¡ã€‚</p> <p>åœ¨æˆ‘ä»¬é€šè¿‡<code>ServerBootstrap</code>é…ç½® netty æœåŠ¡ç«¯å¯åŠ¨ä¿¡æ¯çš„æ—¶å€™ï¼Œæ— è®ºæ˜¯å‘æœåŠ¡ç«¯<code>NioServerSocketChannel</code>çš„ pipeline ä¸­æ·»åŠ  ChannelHandlerï¼Œè¿˜æ˜¯å‘å®¢æˆ·ç«¯<code>NioSocketChannel</code>çš„ pipeline ä¸­æ·»åŠ  ChannelHandlerï¼Œå½“æ¶‰åŠåˆ°å¤šä¸ª ChannelHandler æ·»åŠ çš„æ—¶å€™ï¼Œæˆ‘ä»¬éƒ½ä¼šç”¨åˆ°<code>ChannelInitializer</code>ï¼Œé‚£ä¹ˆè¿™ä¸ª<code>ChannelInitializer</code>ç©¶ç«Ÿæ˜¯ä½•æ–¹åœ£ç¥ï¼Œä¸ºä»€ä¹ˆè¦è¿™æ ·åšå‘¢ï¼Ÿæˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹~~</p> <h2 id="channelinitializer"><a href="#channelinitializer" class="header-anchor">#</a> ChannelInitializer</h2> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192058761.webp" alt="å›¾ç‰‡"></p> <p>é¦–å…ˆ<code>ChannelInitializer</code>å®ƒç»§æ‰¿äº<code>ChannelHandler</code>ï¼Œå®ƒè‡ªå·±æœ¬èº«å°±æ˜¯ä¸€ä¸ª ChannelHandlerï¼Œæ‰€ä»¥å®ƒå¯ä»¥æ·»åŠ åˆ°<code>childHandler</code>ä¸­ã€‚</p> <blockquote><p>å…¶ä»–çš„çˆ¶ç±»å¤§å®¶è¿™é‡Œå¯ä»¥ä¸ç”¨ç®¡ï¼Œåé¢æ–‡ç« ä¸­ç¬”è€…ä¼šä¸€ä¸€ä¸ºå¤§å®¶è¯¦ç»†ä»‹ç»ã€‚</p></blockquote> <p><strong>é‚£ä¸ºä»€ä¹ˆä¸ç›´æ¥æ·»åŠ  <code>ChannelHandler</code> è€Œæ˜¯é€‰æ‹©ç”¨ <code>ChannelInitializer</code> å‘¢ï¼Ÿ</strong></p> <p>è¿™é‡Œä¸»è¦æœ‰ä¸¤ç‚¹åŸå› ï¼š</p> <ul><li>å‰è¾¹æˆ‘ä»¬æåˆ°ï¼Œå®¢æˆ·ç«¯<code>NioSocketChannel</code>æ˜¯åœ¨æœåŠ¡ç«¯ accept è¿æ¥åï¼Œåœ¨æœåŠ¡ç«¯<code>NioServerSocketChannel</code>ä¸­è¢«åˆ›å»ºå‡ºæ¥çš„ã€‚<strong>ä½†æ˜¯æ­¤æ—¶æˆ‘ä»¬æ­£å¤„äºé…ç½®<code>ServerBootStrap</code>é˜¶æ®µï¼ŒæœåŠ¡ç«¯è¿˜æ²¡æœ‰å¯åŠ¨ï¼Œæ›´æ²¡æœ‰å®¢æˆ·ç«¯è¿æ¥ä¸Šæ¥</strong>ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯<code>NioSocketChannel</code>è¿˜æ²¡æœ‰è¢«åˆ›å»ºå‡ºæ¥ï¼Œæ‰€ä»¥ä¹Ÿå°±æ²¡åŠæ³•å‘å®¢æˆ·ç«¯<code>NioSocketChannel</code>çš„ pipeline ä¸­æ·»åŠ <code>ChannelHandler</code>ã€‚</li> <li>å®¢æˆ·ç«¯<code>NioSocketChannel</code>ä¸­<code>Pipeline</code>é‡Œå¯ä»¥æ·»åŠ ä»»æ„å¤šä¸ª<code>ChannelHandler</code>ï¼Œä½†æ˜¯ Netty æ¡†æ¶æ— æ³•é¢„çŸ¥ç”¨æˆ·åˆ°åº•éœ€è¦æ·»åŠ å¤šå°‘ä¸ª<code>ChannelHandler</code>ï¼Œæ‰€ä»¥ Netty æ¡†æ¶æä¾›äº†å›è°ƒå‡½æ•°<code>ChannelInitializer#initChannel</code>ï¼Œä½¿ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰<code>ChannelHandler</code>çš„æ·»åŠ è¡Œä¸ºã€‚</li></ul> <p>å½“å®¢æˆ·ç«¯<code>NioSocketChannel</code>æ³¨å†Œåˆ°å¯¹åº”çš„<code>Sub Reactor</code>ä¸Šåï¼Œç´§æ¥ç€å°±ä¼šåˆå§‹åŒ–<code>NioSocketChannel</code>ä¸­çš„<code>Pipeline</code>ï¼Œæ­¤æ—¶ Netty æ¡†æ¶ä¼šå›è°ƒ<code>ChannelInitializer#initChannel</code>æ‰§è¡Œç”¨æˆ·è‡ªå®šä¹‰çš„æ·»åŠ é€»è¾‘ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span> <span class="token keyword">extends</span> <span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">channelRegistered</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//å½“channelRegisteräº‹ä»¶å‘ç”Ÿæ—¶ï¼Œè°ƒç”¨initChannelåˆå§‹åŒ–pipeline</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">initChannel</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>initMap<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Guard against re-entrance.</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//æ­¤æ—¶å®¢æˆ·å•NioSocketChannelå·²ç»åˆ›å»ºå¹¶åˆå§‹åŒ–å¥½äº†</span>
                <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">C</span><span class="token punctuation">)</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">C</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¿™é‡Œç”± netty æ¡†æ¶å›è°ƒçš„<code>ChannelInitializer#initChannelæ–¹æ³•</code>æ­£æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„æ·»åŠ é€»è¾‘ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">EchoServerHandler</span> serverHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EchoServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

serverBootstrap<span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//è®¾ç½®ä»Reactorä¸­æ³¨å†Œchannelçš„pipeline</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoggingHandler</span><span class="token punctuation">(</span><span class="token class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">INFO</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>serverHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><hr> <p>åˆ°æ­¤ä¸ºæ­¢ï¼ŒNetty æœåŠ¡ç«¯å¯åŠ¨æ‰€éœ€è¦çš„å¿…è¦é…ç½®ä¿¡æ¯ï¼Œå·²ç»å…¨éƒ¨å­˜å…¥<code>ServerBootStrap</code>å¯åŠ¨è¾…åŠ©ç±»ä¸­ã€‚</p> <p>æ¥ä¸‹æ¥è¦åšçš„äº‹æƒ…å°±æ˜¯æœåŠ¡ç«¯çš„å¯åŠ¨äº†ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// Start the server. ç»‘å®šç«¯å£å¯åŠ¨æœåŠ¡ï¼Œå¼€å§‹ç›‘å¬acceptäº‹ä»¶</span>
<span class="token class-name">ChannelFuture</span> f <span class="token operator">=</span> serverBootStrap<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="netty-æœåŠ¡ç«¯çš„å¯åŠ¨"><a href="#netty-æœåŠ¡ç«¯çš„å¯åŠ¨" class="header-anchor">#</a> Netty æœåŠ¡ç«¯çš„å¯åŠ¨</h2> <p>ç»è¿‡å‰é¢çš„é“ºå«ç»ˆäºæ¥åˆ°äº†æœ¬æ–‡çš„æ ¸å¿ƒå†…å®¹ ---- Netty æœåŠ¡ç«¯çš„å¯åŠ¨è¿‡ç¨‹ã€‚</p> <p>å¦‚ä»£ç æ¨¡æ¿ä¸­çš„ç¤ºä¾‹æ‰€ç¤ºï¼ŒNetty æœåŠ¡ç«¯çš„å¯åŠ¨è¿‡ç¨‹å°è£…åœ¨<code>io.netty.bootstrap.AbstractBootstrap#bind(int)</code>å‡½æ•°ä¸­ã€‚</p> <p><strong>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹ Netty æœåŠ¡ç«¯åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ç©¶ç«Ÿå¹²äº†å“ªäº›äº‹æƒ…ï¼Ÿ</strong></p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192102676.webp" alt="å›¾ç‰‡"></p> <p>å¤§å®¶çœ‹åˆ°è¿™å‰¯å¯åŠ¨æµç¨‹å›¾å…ˆä¸è¦æ…Œï¼Œæ¥ä¸‹æ¥çš„å†…å®¹ç¬”è€…ä¼šå¸¦å¤§å®¶å„ä¸ªå‡»ç ´å®ƒï¼Œåœ¨æ–‡ç« çš„æœ€åä¿è¯è®©å¤§å®¶çœ‹æ‡‚è¿™å‰¯æµç¨‹å›¾ã€‚</p> <p>æˆ‘ä»¬å…ˆæ¥ä» netty æœåŠ¡ç«¯å¯åŠ¨çš„å…¥å£å‡½æ•°å¼€å§‹æˆ‘ä»¬ä»Šå¤©çš„æºç è§£ææ—…ç¨‹ï¼š</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">int</span> inetPort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span>inetPort<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//æ ¡éªŒNettyæ ¸å¿ƒç»„ä»¶æ˜¯å¦é…ç½®é½å…¨</span>
    <span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//æœåŠ¡ç«¯å¼€å§‹å¯åŠ¨ï¼Œç»‘å®šç«¯å£åœ°å€ï¼Œæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥</span>
    <span class="token keyword">return</span> <span class="token function">doBind</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>localAddress<span class="token punctuation">,</span> <span class="token string">&quot;localAddress&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">ChannelFuture</span> <span class="token function">doBind</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//å¼‚æ­¥åˆ›å»ºï¼Œåˆå§‹åŒ–ï¼Œæ³¨å†ŒServerSocketChannelåˆ°main reactorä¸Š</span>
    <span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> regFuture <span class="token operator">=</span> <span class="token function">initAndRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Channel</span> channel <span class="token operator">=</span> regFuture<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>regFuture<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> regFuture<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>regFuture<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>serverSocketChannel å‘ <span class="token class-name">Main</span> <span class="token class-name">Reactor</span> æ³¨å†ŒæˆåŠŸåå¼€å§‹ç»‘å®šç«¯å£<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//å¦‚æœæ­¤æ—¶æ³¨å†Œæ“ä½œæ²¡æœ‰å®Œæˆï¼Œåˆ™å‘regFutureæ·»åŠ operationCompleteå›è°ƒå‡½æ•°ï¼Œæ³¨å†ŒæˆåŠŸåå›è°ƒã€‚</span>
        regFuture<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelFutureListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelFuture</span> future<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>serverSocketChannelå‘<span class="token class-name">Main</span> <span class="token class-name">Reactor</span>æ³¨å†ŒæˆåŠŸåå¼€å§‹ç»‘å®šç«¯å£<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>Netty æœåŠ¡ç«¯çš„å¯åŠ¨æµç¨‹æ€»ä½“å¦‚ä¸‹ï¼š</strong></p> <ul><li>åˆ›å»ºæœåŠ¡ç«¯<code>NioServerSocketChannel</code>å¹¶åˆå§‹åŒ–ã€‚</li> <li>å°†æœåŠ¡ç«¯<code>NioServerSocketChannel</code>æ³¨å†Œåˆ°<code>ä¸»Reactorçº¿ç¨‹ç»„</code>ä¸­ã€‚</li> <li>æ³¨å†ŒæˆåŠŸåï¼Œå¼€å§‹åˆå§‹åŒ–<code>NioServerSocketChannel</code>ä¸­çš„ pipelineï¼Œç„¶ååœ¨ pipeline ä¸­è§¦å‘ channelRegister äº‹ä»¶ã€‚</li> <li>éšåç”±<code>NioServerSocketChannel</code>ç»‘å®šç«¯å£åœ°å€ã€‚</li> <li>ç»‘å®šç«¯å£åœ°å€æˆåŠŸåï¼Œå‘<code>NioServerSocketChannel</code>å¯¹åº”çš„<code>Pipeline</code>ä¸­è§¦å‘ä¼ æ’­<code>ChannelActiveäº‹ä»¶</code>ï¼Œåœ¨<code>ChannelActiveäº‹ä»¶å›è°ƒ</code>ä¸­å‘<code>Main Reactor</code>æ³¨å†Œ<code>OP_ACCEPTäº‹ä»¶</code>ï¼Œå¼€å§‹ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ã€‚æœåŠ¡ç«¯å¯åŠ¨å®Œæˆã€‚</li></ul> <p>å½“ netty æœåŠ¡ç«¯å¯åŠ¨æˆåŠŸä¹‹åï¼Œæœ€ç»ˆæˆ‘ä»¬ä¼šå¾—åˆ°å¦‚ä¸‹ç»“æ„çš„é˜µå‹ï¼Œå¼€å§‹æ•æˆˆå¾…æ—¦ï¼Œå‡†å¤‡æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥ï¼ŒReactor å¼€å§‹è¿è½¬ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192103283.webp" alt="å›¾ç‰‡"></p> <p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥çœ‹ä¸‹ Netty æºç æ˜¯å¦‚ä½•å®ç°ä»¥ä¸Šæ­¥éª¤çš„~~</p> <h3 id="_1-initandregister"><a href="#_1-initandregister" class="header-anchor">#</a> 1. initAndRegister</h3> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192105313.webp" alt="å›¾ç‰‡"></p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> <span class="token function">initAndRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//åˆ›å»ºNioServerSocketChannel</span>
        <span class="token comment">//ReflectiveChannelFactoryé€šè¿‡æ³›å‹ï¼Œåå°„ï¼Œå·¥å‚çš„æ–¹å¼çµæ´»åˆ›å»ºä¸åŒç±»å‹çš„channel</span>
        channel <span class="token operator">=</span> channelFactory<span class="token punctuation">.</span><span class="token function">newChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//åˆå§‹åŒ–NioServerSocketChannel</span>
        <span class="token function">init</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//å‘MainReactoræ³¨å†ŒServerSocketChannel</span>
    <span class="token class-name">ChannelFuture</span> regFuture <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">return</span> regFuture<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä»å‡½æ•°å‘½åä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦åšçš„äº‹æƒ…å°±æ˜¯é¦–å…ˆåˆ›å»º<code>NioServerSocketChannel</code>ï¼Œå¹¶å¯¹<code>NioServerSocketChannel</code>è¿›è¡Œåˆå§‹åŒ–ï¼Œæœ€åå°†<code>NioServerSocketChannel</code>æ³¨å†Œåˆ°<code>Main Reactor</code>ä¸­ã€‚</p> <h4 id="_1-1-åˆ›å»º-nioserversocketchannel"><a href="#_1-1-åˆ›å»º-nioserversocketchannel" class="header-anchor">#</a> 1.1 åˆ›å»º NioServerSocketChannel</h4> <p>è¿˜è®°å¾—æˆ‘ä»¬åœ¨ä»‹ç»<code>ServerBootstrap</code>å¯åŠ¨è¾…åŠ©ç±»é…ç½®æœåŠ¡ç«¯<code>ServerSocketChannel</code>ç±»å‹çš„æ—¶å€™æåˆ°çš„å·¥å‚ç±»<code>ReflectiveChannelFactory</code>å—ï¼Ÿ</p> <p>å› ä¸ºå½“æ—¶æˆ‘ä»¬åœ¨é…ç½®<code>ServerBootstrap</code>å¯åŠ¨è¾…åŠ©ç±»çš„æ—¶å€™ï¼Œè¿˜æ²¡åˆ°å¯åŠ¨é˜¶æ®µï¼Œè€Œé…ç½®é˜¶æ®µå¹¶ä¸æ˜¯åˆ›å»ºå…·ä½“<code>ServerSocketChannel</code>çš„æ—¶æœºã€‚</p> <p>æ‰€ä»¥ Netty é€šè¿‡<code>å·¥å‚æ¨¡å¼</code>å°†è¦åˆ›å»ºçš„<code>ServerSocketChannel</code>çš„ç±»å‹ï¼ˆé€šè¿‡æ³›å‹æŒ‡å®šï¼‰ä»¥åŠ åˆ›å»ºçš„è¿‡ç¨‹(<code>å°è£…åœ¨newChannelå‡½æ•°ä¸­</code>)ç»Ÿç»Ÿå…ˆå°è£…åœ¨å·¥å‚ç±»<code>ReflectiveChannelFactory</code>ä¸­ã€‚</p> <blockquote><p><code>ReflectiveChannelFactory</code>é€šè¿‡<code>æ³›å‹</code>ï¼Œ<code>åå°„</code>ï¼Œ<code>å·¥å‚</code>çš„æ–¹å¼<code>çµæ´»</code>åˆ›å»ºä¸åŒç±»å‹çš„<code>channel</code></p></blockquote> <p>ç­‰å¾…åˆ›å»ºæ—¶æœºæ¥ä¸´ï¼Œæˆ‘ä»¬è°ƒç”¨ä¿å­˜åœ¨<code>ServerBootstrap</code>ä¸­çš„<code>channelFactory</code>ç›´æ¥è¿›è¡Œåˆ›å»ºã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReflectiveChannelFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">ChannelFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> constructor<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">newChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ChannelException</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to create Channel from class &quot;</span> <span class="token operator">+</span> constructor<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹<code>NioServerSocketChannel</code>çš„æ„å»ºè¿‡ç¨‹ï¼š</p> <h5 id="_1-1-1-nioserversocketchannel"><a href="#_1-1-1-nioserversocketchannel" class="header-anchor">#</a> 1.1.1 NioServerSocketChannel</h5> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NioServerSocketChannel</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractNioMessageChannel</span>
                             <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>socket<span class="token punctuation">.</span></span>ServerSocketChannel</span> <span class="token punctuation">{</span>

    <span class="token comment">//SelectorProvider(ç”¨äºåˆ›å»ºSelectorå’ŒSelectable Channels)</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">SelectorProvider</span> <span class="token constant">DEFAULT_SELECTOR_PROVIDER</span> <span class="token operator">=</span> <span class="token class-name">SelectorProvider</span><span class="token punctuation">.</span><span class="token function">provider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token function">newSocket</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_SELECTOR_PROVIDER</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//åˆ›å»ºJDK NIO ServerSocketChannel</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ServerSocketChannel</span> <span class="token function">newSocket</span><span class="token punctuation">(</span><span class="token class-name">SelectorProvider</span> provider<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> provider<span class="token punctuation">.</span><span class="token function">openServerSocketChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ChannelException</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;Failed to open a server socket.&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

     <span class="token comment">//ServerSocketChannelç›¸å…³çš„é…ç½®</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ServerSocketChannelConfig</span> config<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">(</span><span class="token class-name">ServerSocketChannel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//çˆ¶ç±»AbstractNioChannelä¸­ä¿å­˜JDK NIOåŸç”ŸServerSocketChannelä»¥åŠè¦ç›‘å¬çš„äº‹ä»¶OP_ACCEPT</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> channel<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_ACCEPT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//DefaultChannelConfigä¸­è®¾ç½®ç”¨äºChannelæ¥æ”¶æ•°æ®ç”¨çš„buffer-&gt;AdaptiveRecvByteBufAllocator</span>
        config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioServerSocketChannelConfig</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><ul><li>é¦–å…ˆè°ƒç”¨<code>newSocket</code>åˆ›å»º JDK NIO åŸç”Ÿ<code>ServerSocketChannel</code>ï¼Œè¿™é‡Œè°ƒç”¨äº†<code>SelectorProvider#openServerSocketChannel</code>æ¥åˆ›å»º JDK NIO åŸç”Ÿ<code>ServerSocketChannel</code>ï¼Œæˆ‘ä»¬åœ¨ä¸Šç¯‡æ–‡ç« <a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247483907&amp;idx=1&amp;sn=084c470a8fe6234c2c9461b5f713ff30&amp;chksm=ce77c444f9004d52e7c6244bee83479070effb0bc59236df071f4d62e91e25f01715fca53696&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">ã€ŠèŠèŠ Netty é‚£äº›äº‹å„¿ä¹‹ Reactor åœ¨ Netty ä¸­çš„å®ç°(åˆ›å»ºç¯‡)ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸­è¯¦ç»†çš„ä»‹ç»äº†<code>SelectorProvider</code>ç›¸å…³å†…å®¹ï¼Œå½“æ—¶æ˜¯ç”¨<code>SelectorProvider</code>æ¥åˆ›å»º<code>Reactor</code>ä¸­çš„<code>Selector</code>ã€‚å¤§å®¶è¿˜è®°å¾—å—ï¼Ÿï¼Ÿ</li> <li>é€šè¿‡çˆ¶ç±»æ„é€ å™¨è®¾ç½®<code>NioServerSocketChannel</code>æ„Ÿå…´è¶£çš„<code>IOäº‹ä»¶</code>,è¿™é‡Œè®¾ç½®çš„æ˜¯<code>SelectionKey.OP_ACCEPT</code>äº‹ä»¶ã€‚å¹¶å°† JDK NIO åŸç”Ÿ<code>ServerSocketChannel</code>å°è£…èµ·æ¥ã€‚</li> <li>åˆ›å»º<code>Channel</code>çš„é…ç½®ç±»<code>NioServerSocketChannelConfig</code>ï¼Œåœ¨é…ç½®ç±»ä¸­å°è£…äº†å¯¹<code>Channelåº•å±‚</code>çš„ä¸€äº›é…ç½®è¡Œä¸ºï¼Œä»¥åŠ JDK ä¸­çš„<code>ServerSocket</code>ã€‚ä»¥åŠåˆ›å»º<code>NioServerSocketChannel</code>æ¥æ”¶æ•°æ®ç”¨çš„<code>Buffer</code>åˆ†é…å™¨<code>AdaptiveRecvByteBufAllocator</code>ã€‚</li></ul> <blockquote><p><code>NioServerSocketChannelConfig</code> æ²¡ä»€ä¹ˆé‡è¦çš„ä¸œè¥¿ï¼Œæˆ‘ä»¬è¿™é‡Œä¹Ÿä¸å¿…æ·±ç©¶ï¼Œå®ƒå°±æ˜¯ç®¡ç†<code>NioServerSocketChannel</code>ç›¸å…³çš„é…ç½®ï¼Œè¿™é‡Œå”¯ä¸€éœ€è¦å¤§å®¶æ³¨æ„çš„æ˜¯è¿™ä¸ªç”¨äº<code>Channel</code>æ¥æ”¶æ•°æ®ç”¨çš„<code>Bufferåˆ†é…å™¨</code> AdaptiveRecvByteBufAllocatorï¼Œæˆ‘ä»¬åé¢åœ¨ä»‹ç» Netty å¦‚ä½•æ¥æ”¶è¿æ¥çš„æ—¶å€™è¿˜ä¼šæåˆ°</p></blockquote> <p><code>NioServerSocketChannel</code>çš„æ•´ä½“æ„å»ºè¿‡ç¨‹ä»‹ç»å®Œäº†ï¼Œç°åœ¨æˆ‘ä»¬æ¥æŒ‰ç…§ç»§æ‰¿å±‚æ¬¡å†å›è¿‡å¤´æ¥çœ‹ä¸‹<code>NioServerSocketChannel</code>çš„å±‚æ¬¡æ„å»ºï¼Œæ¥çœ‹ä¸‹æ¯ä¸€å±‚éƒ½åˆ›å»ºäº†ä»€ä¹ˆï¼Œå°è£…äº†ä»€ä¹ˆï¼Œè¿™äº›ä¿¡æ¯éƒ½æ˜¯<code>Channel</code>çš„æ ¸å¿ƒä¿¡æ¯ï¼Œæ‰€ä»¥æœ‰å¿…è¦äº†è§£ä¸€ä¸‹ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192109439.webp" alt="å›¾ç‰‡"></p> <p>åœ¨<code>NioServerSocketChannel</code>çš„åˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨ç»§æ‰¿ç»“æ„å›¾ä¸­çº¢æ¡†æ ‡æ³¨çš„ä¸‰ä¸ªç±»ï¼Œå…¶ä»–çš„æˆ‘ä»¬å æ—¶å…ˆä¸ç”¨ç®¡ã€‚</p> <p>å…¶ä¸­<code>AbstractNioMessageChannelç±»</code>ä¸»è¦æ˜¯å¯¹<code>NioServerSocketChannel</code>åº•å±‚è¯»å†™è¡Œä¸ºçš„å°è£…å’Œå®šä¹‰ï¼Œæ¯”å¦‚ accept æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ã€‚è¿™ä¸ªæˆ‘ä»¬åç»­ä¼šä»‹ç»åˆ°ï¼Œè¿™é‡Œæˆ‘ä»¬å¹¶ä¸å±•å¼€ã€‚</p> <h5 id="_1-1-2-abstractniochannel"><a href="#_1-1-2-abstractniochannel" class="header-anchor">#</a> 1.1.2 AbstractNioChannel</h5> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractNioChannel</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractChannel</span> <span class="token punctuation">{</span>
   <span class="token comment">//JDK NIOåŸç”ŸSelectable Channel</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SelectableChannel</span> ch<span class="token punctuation">;</span>
    <span class="token comment">// Channelç›‘å¬äº‹ä»¶é›†åˆ è¿™é‡Œæ˜¯SelectionKey.OP_ACCEPTäº‹ä»¶</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">int</span> readInterestOp<span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token class-name">AbstractNioChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> parent<span class="token punctuation">,</span> <span class="token class-name">SelectableChannel</span> ch<span class="token punctuation">,</span> <span class="token keyword">int</span> readInterestOp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ch <span class="token operator">=</span> ch<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>readInterestOp <span class="token operator">=</span> readInterestOp<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//è®¾ç½®Channelä¸ºéé˜»å¡ é…åˆIOå¤šè·¯å¤ç”¨æ¨¡å‹</span>
            ch<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>å°è£…ç”±<code>SelectorProvider</code>åˆ›å»ºå‡ºæ¥çš„ JDK NIO åŸç”Ÿ<code>ServerSocketChannel</code>ã€‚</li> <li>å°è£…<code>Channel</code>åœ¨åˆ›å»ºæ—¶æŒ‡å®šæ„Ÿå…´è¶£çš„<code>IOäº‹ä»¶</code>ï¼Œå¯¹äº<code>NioServerSocketChannel</code>æ¥è¯´æ„Ÿå…´è¶£çš„<code>IOäº‹ä»¶</code>ä¸º<code>OP_ACCEPTäº‹ä»¶</code>ã€‚</li> <li>è®¾ç½® JDK NIO åŸç”Ÿ<code>ServerSocketChannel</code>ä¸ºéé˜»å¡æ¨¡å¼ï¼Œ é…åˆ IO å¤šè·¯å¤ç”¨æ¨¡å‹ã€‚</li></ul> <h5 id="_1-1-3-abstractchannel"><a href="#_1-1-3-abstractchannel" class="header-anchor">#</a> 1.1.3 AbstractChannel</h5> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractChannel</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultAttributeMap</span> <span class="token keyword">implements</span> <span class="token class-name">Channel</span> <span class="token punctuation">{</span>

    <span class="token comment">//channelæ˜¯æœ‰åˆ›å»ºå±‚æ¬¡çš„ï¼Œæ¯”å¦‚ServerSocketChannel æ˜¯ SocketChannelçš„ parent</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Channel</span> parent<span class="token punctuation">;</span>
    <span class="token comment">//channelå…¨å±€å”¯ä¸€ID machineId+processId+sequence+timestamp+random</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ChannelId</span> id<span class="token punctuation">;</span>
    <span class="token comment">//unsafeç”¨äºå°è£…å¯¹åº•å±‚socketçš„ç›¸å…³æ“ä½œ</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Unsafe</span> unsafe<span class="token punctuation">;</span>
    <span class="token comment">//ä¸ºchannelåˆ†é…ç‹¬ç«‹çš„pipelineç”¨äºIOäº‹ä»¶ç¼–æ’</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DefaultChannelPipeline</span> pipeline<span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token class-name">AbstractChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>
        <span class="token comment">//channelå…¨å±€å”¯ä¸€ID machineId+processId+sequence+timestamp+random</span>
        id <span class="token operator">=</span> <span class="token function">newId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//unsafeç”¨äºå®šä¹‰å®ç°å¯¹Channelçš„åº•å±‚æ“ä½œ</span>
        unsafe <span class="token operator">=</span> <span class="token function">newUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//ä¸ºchannelåˆ†é…ç‹¬ç«‹çš„pipelineç”¨äºIOäº‹ä»¶ç¼–æ’</span>
        pipeline <span class="token operator">=</span> <span class="token function">newChannelPipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>Netty ä¸­çš„<code>Channelåˆ›å»º</code>æ˜¯æœ‰å±‚æ¬¡çš„ï¼Œè¿™é‡Œçš„<code>parentå±æ€§</code>ç”¨æ¥ä¿å­˜ä¸Šä¸€çº§çš„<code>Channel</code>ï¼Œæ¯”å¦‚è¿™é‡Œçš„<code>NioServerSocketChannel</code>æ˜¯é¡¶çº§<code>Channel</code>ï¼Œæ‰€ä»¥å®ƒçš„<code>parent = null</code>ã€‚å®¢æˆ·ç«¯<code>NioSocketChannel</code>æ˜¯ç”±<code>NioServerSocketChannel</code>åˆ›å»ºçš„ï¼Œæ‰€ä»¥å®ƒçš„<code>parent = NioServerSocketChannel</code>ã€‚</li> <li>ä¸º<code>Channel</code>åˆ†é…å…¨å±€å”¯ä¸€çš„<code>ChannelId</code>ã€‚<code>ChannelId</code>ç”±æœºå™¨ Id(<code>machineId</code>)ï¼Œè¿›ç¨‹ Idï¼ˆ<code>processId</code>ï¼‰ï¼Œåºåˆ—å·ï¼ˆ<code>sequence</code>ï¼‰ï¼Œæ—¶é—´æˆ³ï¼ˆ<code>timestamp</code>ï¼‰ï¼Œéšæœºæ•°ï¼ˆ<code>random</code>ï¼‰æ„æˆ</li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">DefaultChannelId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token constant">MACHINE_ID</span><span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token constant">PROCESS_ID_LEN</span> <span class="token operator">+</span> <span class="token constant">SEQUENCE_LEN</span> <span class="token operator">+</span> <span class="token constant">TIMESTAMP_LEN</span> <span class="token operator">+</span> <span class="token constant">RANDOM_LEN</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// machineId</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span><span class="token constant">MACHINE_ID</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token constant">MACHINE_ID</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    i <span class="token operator">+=</span> <span class="token constant">MACHINE_ID</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token comment">// processId</span>
    i <span class="token operator">=</span> <span class="token function">writeInt</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token constant">PROCESS_ID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// sequence</span>
    i <span class="token operator">=</span> <span class="token function">writeInt</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> nextSequence<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// timestamp (kind of)</span>
    i <span class="token operator">=</span> <span class="token function">writeLong</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// random</span>
    <span class="token keyword">int</span> random <span class="token operator">=</span> <span class="token class-name">PlatformDependent</span><span class="token punctuation">.</span><span class="token function">threadLocalRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    i <span class="token operator">=</span> <span class="token function">writeInt</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> random<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span> i <span class="token operator">==</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    hashCode <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>åˆ›å»º<code>NioServerSocketChannel</code>çš„åº•å±‚æ“ä½œç±»<code>Unsafe</code>ã€‚è¿™é‡Œåˆ›å»ºçš„æ˜¯<code>io.netty.channel.nio.AbstractNioMessageChannel.NioMessageUnsafe</code>ã€‚</li></ul> <blockquote><p><code>Unsafe</code>ä¸º<code>Channelæ¥å£</code>çš„ä¸€ä¸ªå†…éƒ¨æ¥å£ï¼Œç”¨äºå®šä¹‰å®ç°å¯¹ Channel åº•å±‚çš„å„ç§æ“ä½œï¼Œ<code>Unsafeæ¥å£</code>å®šä¹‰çš„æ“ä½œè¡Œä¸ºåªèƒ½ç”± Netty æ¡†æ¶çš„<code>Reactorçº¿ç¨‹</code>è°ƒç”¨ï¼Œç”¨æˆ·çº¿ç¨‹ç¦æ­¢è°ƒç”¨ã€‚</p></blockquote> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">interface</span> <span class="token class-name">Unsafe</span> <span class="token punctuation">{</span>

    <span class="token comment">//åˆ†é…æ¥æ”¶æ•°æ®ç”¨çš„Buffer</span>
    <span class="token class-name">RecvByteBufAllocator<span class="token punctuation">.</span>Handle</span> <span class="token function">recvBufAllocHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//æœåŠ¡ç«¯ç»‘å®šçš„ç«¯å£åœ°å€</span>
    <span class="token class-name">SocketAddress</span> <span class="token function">localAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//è¿œç«¯åœ°å€</span>
    <span class="token class-name">SocketAddress</span> <span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//channelå‘Reactoræ³¨å†Œ</span>
    <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">EventLoop</span> eventLoop<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//æœåŠ¡ç«¯ç»‘å®šç«¯å£åœ°å€</span>
    <span class="token keyword">void</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//å®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯</span>
    <span class="token keyword">void</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">SocketAddress</span> remoteAddress<span class="token punctuation">,</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//å…³é—­ channel</span>
    <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//è¯»æ•°æ®</span>
    <span class="token keyword">void</span> <span class="token function">beginRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//å†™æ•°æ®</span>
    <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><ul><li>ä¸º<code>NioServerSocketChannel</code>åˆ†é…ç‹¬ç«‹çš„<code>pipeline</code>ç”¨äº IO äº‹ä»¶ç¼–æ’ã€‚<code>pipeline</code>å…¶å®æ˜¯ä¸€ä¸ª<code>ChannelHandlerContext</code>ç±»å‹çš„åŒå‘é“¾è¡¨ã€‚å¤´ç»“ç‚¹<code>HeadContext</code>,å°¾ç»“ç‚¹<code>TailContext</code>ã€‚<code>ChannelHandlerContext</code>ä¸­åŒ…è£…ç€<code>ChannelHandler</code>ã€‚</li></ul> <blockquote><p><code>ChannelHandlerContext</code>ä¿å­˜ ChannelHandler ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œç”¨äºäº‹ä»¶ä¼ æ’­ã€‚åé¢ç¬”è€…ä¼šå•ç‹¬å¼€ä¸€ç¯‡æ–‡ç« ä»‹ç»ï¼Œè¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯èšç„¦äºå¯åŠ¨ä¸»çº¿ã€‚</p></blockquote> <p>è¿™é‡Œåªæ˜¯ä¸ºäº†è®©å¤§å®¶ç®€å•ç†è§£<code>pipeline</code>çš„ä¸€ä¸ªå¤§è‡´çš„ç»“æ„ï¼Œåé¢ä¼šå†™ä¸€ç¯‡æ–‡ç« ä¸“é—¨è¯¦ç»†è®²è§£<code>pipeline</code>ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">DefaultChannelPipeline</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>channel <span class="token operator">=</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token string">&quot;channel&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    succeededFuture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SucceededChannelFuture</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    voidPromise <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">VoidChannelPromise</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    tail <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TailContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    head <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HeadContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    head<span class="token punctuation">.</span>next <span class="token operator">=</span> tail<span class="token punctuation">;</span>
    tail<span class="token punctuation">.</span>prev <span class="token operator">=</span> head<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192045373.webp" alt="å›¾ç‰‡"></p> <hr> <p>åˆ°äº†è¿™é‡Œ<code>NioServerSocketChannel</code>å°±åˆ›å»ºå®Œæ¯•äº†ï¼Œæˆ‘ä»¬æ¥å›é¡¾ä¸‹å®ƒåˆ°åº•åŒ…å«äº†å“ªäº›æ ¸å¿ƒä¿¡æ¯ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192152874.webp" alt="å›¾ç‰‡"></p> <h4 id="_1-2-åˆå§‹åŒ–-nioserversocketchannel"><a href="#_1-2-åˆå§‹åŒ–-nioserversocketchannel" class="header-anchor">#</a> 1.2 åˆå§‹åŒ– NioServerSocketChannel</h4> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//å‘NioServerSocketChannelConfigè®¾ç½®ServerSocketChannelOption</span>
    <span class="token function">setChannelOptions</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token function">newOptionsArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> logger<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//å‘nettyè‡ªå®šä¹‰çš„NioServerSocketChannelè®¾ç½®attributes</span>
    <span class="token function">setAttributes</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token function">attrs0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token constant">EMPTY_ATTRIBUTE_ARRAY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//è·å–ä»Reactorçº¿ç¨‹ç»„</span>
    <span class="token keyword">final</span> <span class="token class-name">EventLoopGroup</span> currentChildGroup <span class="token operator">=</span> childGroup<span class="token punctuation">;</span>
    <span class="token comment">//è·å–ç”¨äºåˆå§‹åŒ–å®¢æˆ·ç«¯NioSocketChannelçš„ChannelInitializer</span>
    <span class="token keyword">final</span> <span class="token class-name">ChannelHandler</span> currentChildHandler <span class="token operator">=</span> childHandler<span class="token punctuation">;</span>
    <span class="token comment">//è·å–ç”¨æˆ·é…ç½®çš„å®¢æˆ·ç«¯SocketChannelçš„channelOptionä»¥åŠattributes</span>
    <span class="token keyword">final</span> <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelOption</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> currentChildOptions<span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>childOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        currentChildOptions <span class="token operator">=</span> childOptions<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token constant">EMPTY_OPTION_ARRAY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">final</span> <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttributeKey</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> currentChildAttrs <span class="token operator">=</span> childAttrs<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token constant">EMPTY_ATTRIBUTE_ARRAY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//å‘NioServerSocketChannelä¸­çš„pipelineæ·»åŠ åˆå§‹åŒ–ChannelHandlerçš„é€»è¾‘</span>
    p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Channel</span> ch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//ServerBootstrapä¸­ç”¨æˆ·æŒ‡å®šçš„channelHandler</span>
            <span class="token class-name">ChannelHandler</span> handler <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//LoggingHandler</span>
                pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//æ·»åŠ ç”¨äºæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥çš„acceptor</span>
            ch<span class="token punctuation">.</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServerBootstrapAcceptor</span><span class="token punctuation">(</span>
                        ch<span class="token punctuation">,</span> currentChildGroup<span class="token punctuation">,</span> currentChildHandler<span class="token punctuation">,</span> currentChildOptions<span class="token punctuation">,</span> currentChildAttrs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>å‘<code>NioServerSocketChannelConfig</code>è®¾ç½®<code>ServerSocketChannelOption</code>ã€‚</li> <li>å‘ netty è‡ªå®šä¹‰çš„<code>NioServerSocketChannel</code>è®¾ç½®<code>ChannelAttributes</code></li></ul> <p>Netty è‡ªå®šä¹‰çš„<code>SocketChannel</code>ç±»å‹å‡ç»§æ‰¿<code>AttributeMap</code>æ¥å£ä»¥åŠ<code>DefaultAttributeMap</code>ç±»ï¼Œæ­£æ˜¯å®ƒä»¬å®šä¹‰äº†<code>ChannelAttributes</code>ã€‚ç”¨äºå‘<code>Channel</code>æ·»åŠ ç”¨æˆ·è‡ªå®šä¹‰çš„ä¸€äº›ä¿¡æ¯ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192113913.webp" alt="å›¾ç‰‡"></p> <blockquote><p>è¿™ä¸ª<code>ChannelAttributes</code>çš„ç”¨å¤„å¤§æœ‰å¯ä¸ºï¼ŒNetty åè¾¹çš„è®¸å¤šç‰¹æ€§éƒ½æ˜¯ä¾é è¿™ä¸ª<code>ChannelAttributes</code>æ¥å®ç°çš„ã€‚è¿™é‡Œå…ˆå–ä¸ªå…³å­ï¼Œå¤§å®¶å¯ä»¥è‡ªå·±å…ˆæƒ³ä¸€ä¸‹å¯ä»¥ç”¨è¿™ä¸ª<code>ChannelAttributes</code>åšå“ªäº›äº‹æƒ…ï¼Ÿ</p></blockquote> <ul><li>è·å–ä» Reactor çº¿ç¨‹ç»„<code>childGroup</code>ï¼Œä»¥åŠç”¨äºåˆå§‹åŒ–å®¢æˆ·ç«¯<code>NioSocketChannel</code>çš„<code>ChannelInitializer</code>,<code>ChannelOption</code>,<code>ChannelAttributes</code>ï¼Œè¿™äº›ä¿¡æ¯å‡æ˜¯ç”±ç”¨æˆ·åœ¨å¯åŠ¨çš„æ—¶å€™å‘<code>ServerBootstrap</code>æ·»åŠ çš„å®¢æˆ·ç«¯<code>NioServerChannel</code>é…ç½®ä¿¡æ¯ã€‚è¿™é‡Œç”¨è¿™äº›ä¿¡æ¯æ¥åˆå§‹åŒ–<code>ServerBootstrapAcceptor</code>ã€‚å› ä¸ºåç»­ä¼šåœ¨<code>ServerBootstrapAcceptor</code>ä¸­æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ä»¥åŠåˆ›å»º<code>NioServerChannel</code>ã€‚</li> <li>å‘<code>NioServerSocketChannel</code>ä¸­çš„<code>pipeline</code>æ·»åŠ ç”¨äºåˆå§‹åŒ–<code>pipeline</code>çš„<code>ChannelInitializer</code>ã€‚</li></ul> <p><strong>é—®é¢˜æ¥äº†ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆä¸å¹²è„†ç›´æ¥å°†<code>ChannelHandler</code>æ·»åŠ åˆ°<code>pipeline</code>ä¸­ï¼Œè€Œæ˜¯åˆä½¿ç”¨åˆ°äº†<code>ChannelInitializer</code>å‘¢ï¼Ÿ</strong></p> <p>å…¶å®åŸå› æœ‰ä¸¤ç‚¹ï¼š</p> <ul><li>ä¸ºäº†ä¿è¯<code>çº¿ç¨‹å®‰å…¨</code>åœ°åˆå§‹åŒ–<code>pipeline</code>ï¼Œæ‰€ä»¥åˆå§‹åŒ–çš„åŠ¨ä½œéœ€è¦ç”±<code>Reactorçº¿ç¨‹</code>è¿›è¡Œï¼Œè€Œå½“å‰çº¿ç¨‹æ˜¯<code>ç”¨æˆ·ç¨‹åº</code>çš„<code>å¯åŠ¨Mainçº¿ç¨‹</code> å¹¶<code>ä¸æ˜¯</code>Reactor çº¿ç¨‹ã€‚è¿™é‡Œä¸èƒ½ç«‹å³åˆå§‹åŒ–ã€‚</li> <li>åˆå§‹åŒ–<code>Channel</code>ä¸­<code>pipeline</code>çš„åŠ¨ä½œï¼Œéœ€è¦ç­‰åˆ°<code>Channel</code>æ³¨å†Œåˆ°å¯¹åº”çš„<code>Reactor</code>ä¸­æ‰å¯ä»¥è¿›è¡Œåˆå§‹åŒ–ï¼Œå½“å‰åªæ˜¯åˆ›å»ºå¥½äº†<code>NioServerSocketChannel</code>ï¼Œä½†å¹¶æœªæ³¨å†Œåˆ°<code>Main Reactor</code>ä¸Šã€‚</li></ul> <blockquote><p>åˆå§‹åŒ–<code>NioServerSocketChannel</code>ä¸­<code>pipeline</code>çš„æ—¶æœºæ˜¯ï¼šå½“<code>NioServerSocketChannel</code>æ³¨å†Œåˆ°<code>Main Reactor</code>ä¹‹åï¼Œç»‘å®šç«¯å£åœ°å€ä¹‹å‰ã€‚</p></blockquote> <blockquote><p>å‰è¾¹åœ¨ä»‹ç»<code>ServerBootstrap</code>é…ç½®<code>childHandler</code>æ—¶ä¹Ÿç”¨åˆ°äº†<code>ChannelInitializer</code>ï¼Œè¿˜è®°å¾—å—ï¼Ÿï¼Ÿ</p></blockquote> <p><strong>é—®é¢˜åˆæ¥äº†ï¼Œå¤§å®¶æ³¨æ„ä¸‹<code>ChannelInitializer#initChannel</code>æ–¹æ³•ï¼Œåœ¨è¯¥åˆå§‹åŒ–å›è°ƒæ–¹æ³•ä¸­ï¼Œæ·»åŠ  LoggingHandler æ˜¯ç›´æ¥å‘ pipeline ä¸­æ·»åŠ ï¼Œè€Œæ·»åŠ  Acceptor ä¸ºä»€ä¹ˆä¸æ˜¯ç›´æ¥æ·»åŠ è€Œæ˜¯å°è£…æˆå¼‚æ­¥ä»»åŠ¡å‘¢ï¼Ÿ</strong></p> <p>è¿™é‡Œå…ˆç»™å¤§å®¶å–ä¸ªå…³å­ï¼Œç¬”è€…ä¼šåœ¨åç»­æµç¨‹ä¸­ä¸ºå¤§å®¶è§£ç­”</p> <p>æ­¤æ—¶<code>NioServerSocketChannel</code>ä¸­çš„<code>pipeline</code>ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192116825.webp" alt="å›¾ç‰‡"></p> <h4 id="_1-3-å‘-main-reactor-æ³¨å†Œ-nioserversocketchannel"><a href="#_1-3-å‘-main-reactor-æ³¨å†Œ-nioserversocketchannel" class="header-anchor">#</a> 1.3 å‘ Main Reactor æ³¨å†Œ NioServerSocketChannel</h4> <p>ä»<code>ServerBootstrap</code>è·å–ä¸» Reactor çº¿ç¨‹ç»„<code>NioEventLoopGroup</code>ï¼Œå°†<code>NioServerSocketChannel</code>æ³¨å†Œåˆ°<code>NioEventLoopGroup</code>ä¸­ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">ChannelFuture</span> regFuture <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹å…·ä½“çš„æ³¨å†Œè¿‡ç¨‹ï¼š</p> <h5 id="_1-3-1-ä¸»-reactor-çº¿ç¨‹ç»„ä¸­é€‰å–ä¸€ä¸ª-main-reactor-è¿›è¡Œæ³¨å†Œ"><a href="#_1-3-1-ä¸»-reactor-çº¿ç¨‹ç»„ä¸­é€‰å–ä¸€ä¸ª-main-reactor-è¿›è¡Œæ³¨å†Œ" class="header-anchor">#</a> 1.3.1 ä¸» Reactor çº¿ç¨‹ç»„ä¸­é€‰å–ä¸€ä¸ª Main Reactor è¿›è¡Œæ³¨å†Œ</h5> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192118790.webp" alt="å›¾ç‰‡"></p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">EventExecutor</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> chooser<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//è·å–ç»‘å®šç­–ç•¥</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">EventExecutorChooser</span> <span class="token function">newChooser</span><span class="token punctuation">(</span><span class="token class-name">EventExecutor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> executors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPowerOfTwo</span><span class="token punctuation">(</span>executors<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PowerOfTwoEventExecutorChooser</span><span class="token punctuation">(</span>executors<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">GenericEventExecutorChooser</span><span class="token punctuation">(</span>executors<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//é‡‡ç”¨è½®è¯¢round-robinçš„æ–¹å¼é€‰æ‹©Reactor</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">EventExecutor</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> executors<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>idx<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> executors<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Netty é€šè¿‡<code>next()</code>æ–¹æ³•æ ¹æ®ä¸Šç¯‡æ–‡ç« <a href="/pages/440035/">ã€Šç¬¬äºŒè¯¾ï¼šReator åœ¨ Netty ä¸­çš„å®ç°ï¼ˆåˆ›å»ºç¯‡ï¼‰ã€‹</a>æåˆ°çš„<code>channelåˆ°reactorçš„ç»‘å®šç­–ç•¥</code>ï¼Œä»<code>ReactorGroup</code>ä¸­é€‰å–ä¸€ä¸ª Reactor è¿›è¡Œæ³¨å†Œç»‘å®šã€‚ä¹‹å<code>Channel</code>ç”Ÿå‘½å‘¨æœŸå†…çš„æ‰€æœ‰<code>IO äº‹ä»¶</code>éƒ½ç”±è¿™ä¸ª<code>Reactor</code> è´Ÿè´£å¤„ç†ï¼Œå¦‚ <code>acceptã€connectã€readã€write</code>ç­‰ IO äº‹ä»¶ã€‚</p> <blockquote><p>ä¸€ä¸ª<code>channel</code>åªèƒ½ç»‘å®šåˆ°ä¸€ä¸ª<code>Reactor</code>ä¸Šï¼Œä¸€ä¸ª<code>Reactor</code>è´Ÿè´£ç›‘å¬<code>å¤šä¸ªchannel</code>ã€‚</p></blockquote> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192120627.webp" alt="å›¾ç‰‡"></p> <blockquote><p>ç”±äºè¿™é‡Œæ˜¯<code>NioServerSocketChannle</code>å‘<code>Main Reactor</code>è¿›è¡Œæ³¨å†Œç»‘å®šï¼Œæ‰€ä»¥<code>Main Reactor</code>ä¸»è¦è´Ÿè´£å¤„ç†çš„<code>IOäº‹ä»¶</code>æ˜¯<code>OP_ACCEPT</code>äº‹ä»¶ã€‚</p></blockquote> <h5 id="_1-3-2-å‘ç»‘å®šåçš„-main-reactor-è¿›è¡Œæ³¨å†Œ"><a href="#_1-3-2-å‘ç»‘å®šåçš„-main-reactor-è¿›è¡Œæ³¨å†Œ" class="header-anchor">#</a> 1.3.2 å‘ç»‘å®šåçš„ Main Reactor è¿›è¡Œæ³¨å†Œ</h5> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192121925.webp" alt="å›¾ç‰‡"></p> <p>å‘<code>Reactor</code>è¿›è¡Œæ³¨å†Œçš„è¡Œä¸ºå®šä¹‰åœ¨<code>NioEventLoop</code>çš„çˆ¶ç±»<code>SingleThreadEventLoop</code>ä¸­ï¼Œå°è±¡æ¨¡ç³Šçš„åŒå­¦å¯ä»¥åœ¨å›çœ‹ä¸‹ä¸Šç¯‡æ–‡ç« ä¸­çš„<code>NioEventLoopç»§æ‰¿ç»“æ„</code>å°èŠ‚å†…å®¹</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SingleThreadEventLoop</span> <span class="token keyword">extends</span> <span class="token class-name">SingleThreadEventExecutor</span> <span class="token keyword">implements</span> <span class="token class-name">EventLoop</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//æ³¨å†Œchannelåˆ°ç»‘å®šçš„Reactorä¸Š</span>
        <span class="token keyword">return</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultChannelPromise</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> <span class="token string">&quot;promise&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//unsafeè´Ÿè´£channelåº•å±‚çš„å„ç§æ“ä½œ</span>
        promise<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>é€šè¿‡<code>NioServerSocketChannel</code>ä¸­çš„<code>Unsafeç±»</code>æ‰§è¡Œåº•å±‚å…·ä½“çš„æ³¨å†ŒåŠ¨ä½œã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractUnsafe</span> <span class="token keyword">implements</span> <span class="token class-name">Unsafe</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
    * æ³¨å†ŒChannelåˆ°ç»‘å®šçš„Reactorä¸Š
    * */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">EventLoop</span> eventLoop<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>eventLoop<span class="token punctuation">,</span> <span class="token string">&quot;eventLoop&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            promise<span class="token punctuation">.</span><span class="token function">setFailure</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;registered to an event loop already&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//EventLoopçš„ç±»å‹è¦ä¸Channelçš„ç±»å‹ä¸€æ ·  Nio Oio Aio</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isCompatible</span><span class="token punctuation">(</span>eventLoop<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            promise<span class="token punctuation">.</span><span class="token function">setFailure</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;incompatible event loop type: &quot;</span> <span class="token operator">+</span> eventLoop<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//åœ¨channelä¸Šè®¾ç½®ç»‘å®šçš„Reactor</span>
        <span class="token class-name">AbstractChannel</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventLoop <span class="token operator">=</span> eventLoop<span class="token punctuation">;</span>

        <span class="token comment">/**
         * æ‰§è¡Œchannelæ³¨å†Œçš„æ“ä½œå¿…é¡»æ˜¯Reactorçº¿ç¨‹æ¥å®Œæˆ
         *
         * 1: å¦‚æœå½“å‰æ‰§è¡Œçº¿ç¨‹æ˜¯Reactorçº¿ç¨‹ï¼Œåˆ™ç›´æ¥æ‰§è¡Œregister0è¿›è¡Œæ³¨å†Œ
         * 2ï¼šå¦‚æœå½“å‰æ‰§è¡Œçº¿ç¨‹æ˜¯å¤–éƒ¨çº¿ç¨‹ï¼Œåˆ™éœ€è¦å°†register0æ³¨å†Œæ“ä½œ å°è£…ç¨‹å¼‚æ­¥Task ç”±Reactorçº¿ç¨‹æ‰§è¡Œ
         **/</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>eventLoop<span class="token punctuation">.</span><span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">register0</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                eventLoop<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">register0</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>é¦–å…ˆæ£€æŸ¥ <code>NioServerSocketChannel</code> æ˜¯å¦å·²ç»å®Œæˆæ³¨å†Œã€‚å¦‚æœä»¥å®Œæˆæ³¨å†Œï¼Œåˆ™ç›´æ¥è®¾ç½®ä»£è¡¨æ³¨å†Œæ“ä½œç»“æœçš„<code>ChannelPromise</code>ä¸º<code>failçŠ¶æ€</code>ã€‚</li> <li>é€šè¿‡<code>isCompatible</code>æ–¹æ³•éªŒè¯ Reactor æ¨¡å‹<code>EventLoop</code>æ˜¯å¦ä¸<code>Channel</code>çš„ç±»å‹åŒ¹é…ã€‚<code>NioEventLoop</code>å¯¹åº”äº<code>NioServerSocketChannel</code>ã€‚</li></ul> <blockquote><p>ä¸Šç¯‡æ–‡ç« æˆ‘ä»¬ä»‹ç»è¿‡ Netty å¯¹ä¸‰ç§<code>IOæ¨¡å‹</code>ï¼š<code>Oio,Nio,Aio</code>çš„æ”¯æŒï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡æ”¹å˜ Netty æ ¸å¿ƒç±»çš„å‰ç¼€è½»æ¾åˆ‡æ¢<code>IOæ¨¡å‹</code>ã€‚<code>isCompatible</code>æ–¹æ³•ç›®çš„å°±æ˜¯éœ€è¦ä¿è¯<code>Reactor</code>å’Œ<code>Channel</code>ä½¿ç”¨çš„æ˜¯åŒä¸€ç§<code>IOæ¨¡å‹</code>ã€‚</p></blockquote> <ul><li><p>åœ¨<code>Channel</code>ä¸­ä¿å­˜å…¶ç»‘å®šçš„<code>Reactorå®ä¾‹</code>ã€‚</p></li> <li><p>æ‰§è¡Œ<code>Channel</code>å‘<code>Reactor</code>æ³¨å†Œçš„åŠ¨ä½œå¿…é¡»è¦ç¡®ä¿æ˜¯åœ¨<code>Reactorçº¿ç¨‹</code>ä¸­æ‰§è¡Œã€‚</p></li> <li><ul><li>å¦‚æœå½“å‰çº¿ç¨‹æ˜¯<code>Reactorçº¿ç¨‹</code>åˆ™ç›´æ¥æ‰§è¡Œæ³¨å†ŒåŠ¨ä½œ<code>register0</code></li> <li>å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯<code>Reactorçº¿ç¨‹</code>ï¼Œåˆ™éœ€è¦å°†æ³¨å†ŒåŠ¨ä½œ<code>register0</code>å°è£…æˆå¼‚æ­¥ä»»åŠ¡ï¼Œå­˜æ”¾åœ¨<code>Reactor</code>ä¸­çš„<code>taskQueue</code>ä¸­ï¼Œç­‰å¾…<code>Reactorçº¿ç¨‹</code>æ‰§è¡Œã€‚</li></ul></li></ul> <blockquote><p>å½“å‰æ‰§è¡Œçº¿ç¨‹å¹¶ä¸æ˜¯<code>Reactorçº¿ç¨‹</code>ï¼Œè€Œæ˜¯ç”¨æˆ·ç¨‹åºçš„å¯åŠ¨çº¿ç¨‹<code>Mainçº¿ç¨‹</code>ã€‚</p></blockquote> <h5 id="_1-3-3-reactor-çº¿ç¨‹çš„å¯åŠ¨"><a href="#_1-3-3-reactor-çº¿ç¨‹çš„å¯åŠ¨" class="header-anchor">#</a> 1.3.3 Reactor çº¿ç¨‹çš„å¯åŠ¨</h5> <p>ä¸Šç¯‡æ–‡ç« ä¸­æˆ‘ä»¬åœ¨ä»‹ç»<code>NioEventLoopGroup</code>çš„åˆ›å»ºè¿‡ç¨‹ä¸­æåˆ°äº†ä¸€ä¸ªæ„é€ å™¨å‚æ•°<code>executor</code>ï¼Œå®ƒç”¨äºå¯åŠ¨<code>Reactorçº¿ç¨‹</code>ï¼Œç±»å‹ä¸º<code>ThreadPerTaskExecutor</code>ã€‚</p> <p>å½“æ—¶ç¬”è€…å‘å¤§å®¶å–äº†ä¸€ä¸ªå…³å­~~<code>â€œReactor çº¿ç¨‹æ˜¯ä½•æ—¶å¯åŠ¨çš„?â€</code></p> <p>é‚£ä¹ˆç°åœ¨å°±åˆ°äº†ä¸ºå¤§å®¶æ­æ™“è°œåº•çš„æ—¶å€™äº†~~</p> <p><strong><code>Reactorçº¿ç¨‹</code> çš„å¯åŠ¨æ˜¯åœ¨å‘ <code>Reactor</code> æäº¤ç¬¬ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡çš„æ—¶å€™å¯åŠ¨çš„ã€‚</strong></p> <p>Netty ä¸­çš„ä¸» Reactor çº¿ç¨‹ç»„<code>NioEventLoopGroup</code>ä¸­çš„ Main Reactor <code>NioEventLoop</code>æ˜¯åœ¨ç”¨æˆ·ç¨‹åº<code>Mainçº¿ç¨‹</code>å‘<code>Main Reactor</code>æäº¤ç”¨äºæ³¨å†Œ<code>NioServerSocketChannel</code>çš„å¼‚æ­¥ä»»åŠ¡æ—¶å¼€å§‹å¯åŠ¨</p> <div class="language-Java extra-class"><pre class="language-java"><code>eventLoop<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">register0</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>æ¥ä¸‹æ¥æˆ‘ä»¬å…³æ³¨ä¸‹<code>NioEventLoop</code>çš„<code>executeæ–¹æ³•</code></p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SingleThreadEventExecutor</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractScheduledEventExecutor</span> <span class="token keyword">implements</span> <span class="token class-name">OrderedEventExecutor</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token string">&quot;task&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">execute</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token operator">!</span><span class="token punctuation">(</span>task <span class="token keyword">instanceof</span> <span class="token class-name">LazyRunnable</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">wakesUpForTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> task<span class="token punctuation">,</span> <span class="token keyword">boolean</span> immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//å½“å‰çº¿ç¨‹æ˜¯å¦ä¸ºReactorçº¿ç¨‹</span>
        <span class="token keyword">boolean</span> inEventLoop <span class="token operator">=</span> <span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//addTaskWakesUp = true addTaskå”¤é†’Reactorçº¿ç¨‹æ‰§è¡Œä»»åŠ¡</span>
        <span class="token function">addTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inEventLoop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯Reactorçº¿ç¨‹ï¼Œåˆ™å¯åŠ¨Reactorçº¿ç¨‹</span>
            <span class="token comment">//è¿™é‡Œå¯ä»¥çœ‹å‡ºReactorçº¿ç¨‹çš„å¯åŠ¨æ˜¯é€šè¿‡ å‘NioEventLoopæ·»åŠ å¼‚æ­¥ä»»åŠ¡æ—¶å¯åŠ¨çš„</span>
            <span class="token function">startThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><ul><li>é¦–å…ˆå°†å¼‚æ­¥ä»»åŠ¡<code>task</code>æ·»åŠ åˆ°<code>Reactor</code>ä¸­çš„<code>taskQueue</code>ä¸­ã€‚</li> <li>åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦ä¸º<code>Reactorçº¿ç¨‹</code>ï¼Œæ­¤æ—¶å½“å‰æ‰§è¡Œçº¿ç¨‹ä¸ºç”¨æˆ·ç¨‹åºå¯åŠ¨çº¿ç¨‹ï¼Œæ‰€ä»¥è¿™é‡Œè°ƒç”¨<code>startThread</code>å¯åŠ¨<code>Reactorçº¿ç¨‹</code>ã€‚</li></ul> <h5 id="_1-3-4-startthread"><a href="#_1-3-4-startthread" class="header-anchor">#</a> 1.3.4 startThread</h5> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SingleThreadEventExecutor</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractScheduledEventExecutor</span> <span class="token keyword">implements</span> <span class="token class-name">OrderedEventExecutor</span> <span class="token punctuation">{</span>
    <span class="token comment">//å®šä¹‰Reactorçº¿ç¨‹çŠ¶æ€</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">ST_NOT_STARTED</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">ST_STARTED</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">ST_SHUTTING_DOWN</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">ST_SHUTDOWN</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">ST_TERMINATED</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

     <span class="token comment">//Reactorçº¿ç¨‹çŠ¶æ€  åˆå§‹ä¸º æœªå¯åŠ¨çŠ¶æ€</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> state <span class="token operator">=</span> <span class="token constant">ST_NOT_STARTED</span><span class="token punctuation">;</span>

    <span class="token comment">//Reactorçº¿ç¨‹çŠ¶æ€å­—æ®µ state åŸå­æ›´æ–°å™¨</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AtomicIntegerFieldUpdater</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SingleThreadEventExecutor</span><span class="token punctuation">&gt;</span></span> <span class="token constant">STATE_UPDATER</span> <span class="token operator">=</span>
    <span class="token class-name">AtomicIntegerFieldUpdater</span><span class="token punctuation">.</span><span class="token function">newUpdater</span><span class="token punctuation">(</span><span class="token class-name">SingleThreadEventExecutor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;state&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token constant">ST_NOT_STARTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">STATE_UPDATER</span><span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">ST_NOT_STARTED</span><span class="token punctuation">,</span> <span class="token constant">ST_STARTED</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">boolean</span> success <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token function">doStartThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    success <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token constant">STATE_UPDATER</span><span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">ST_STARTED</span><span class="token punctuation">,</span> <span class="token constant">ST_NOT_STARTED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>Reactorçº¿ç¨‹</code>åˆå§‹åŒ–çŠ¶æ€ä¸º<code>ST_NOT_STARTED</code>,é¦–å…ˆ<code>CAS</code>æ›´æ–°çŠ¶æ€ä¸º<code>ST_STARTED</code></li> <li><code>doStartThread</code>å¯åŠ¨<code>Reactorçº¿ç¨‹</code></li> <li>å¯åŠ¨å¤±è´¥çš„è¯ï¼Œéœ€è¦å°†<code>Reactorçº¿ç¨‹</code>çŠ¶æ€æ”¹å›<code>ST_NOT_STARTED</code></li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">//ThreadPerTaskExecutor ç”¨äºå¯åŠ¨Reactorçº¿ç¨‹</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doStartThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span> thread <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            thread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>interrupted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                thread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">boolean</span> success <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token function">updateLastExecutionTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//Reactor çº¿ç¨‹å¼€å§‹å¯åŠ¨</span>
                <span class="token class-name">SingleThreadEventExecutor</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                success <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¿™é‡Œå°±æ¥åˆ°äº†<code>ThreadPerTaskExecutor</code>ç±»å‹çš„<code>executor</code>çš„ç”¨æ­¦ä¹‹åœ°äº†ã€‚</p> <ul><li><code>Reactorçº¿ç¨‹</code>çš„æ ¸å¿ƒå·¥ä½œä¹‹å‰ä»‹ç»è¿‡ï¼š<code>è½®è¯¢æ‰€æœ‰æ³¨å†Œå…¶ä¸Šçš„Channelä¸­çš„IOå°±ç»ªäº‹ä»¶</code>ï¼Œ<code>å¤„ç†å¯¹åº”Channelä¸Šçš„IOäº‹ä»¶</code>ï¼Œ<code>æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡</code>ã€‚Netty å°†è¿™äº›æ ¸å¿ƒå·¥ä½œå°è£…åœ¨<code>io.netty.channel.nio.NioEventLoop#run</code>æ–¹æ³•ä¸­ã€‚</li></ul> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192046829.webp" alt="å›¾ç‰‡"></p> <ul><li>å°†<code>NioEventLoop#run</code>å°è£…åœ¨å¼‚æ­¥ä»»åŠ¡ä¸­ï¼Œæäº¤ç»™<code>executor</code>æ‰§è¡Œï¼Œ<code>Reactor</code>çº¿ç¨‹è‡³æ­¤å¼€å§‹å·¥ä½œäº†å°±ã€‚</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPerTaskExecutor</span> <span class="token keyword">implements</span> <span class="token class-name">Executor</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//å¯åŠ¨Reactorçº¿ç¨‹</span>
        threadFactory<span class="token punctuation">.</span><span class="token function">newThread</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ­¤æ—¶<code>Reactorçº¿ç¨‹</code>å·²ç»å¯åŠ¨ï¼Œ<strong>åé¢çš„å·¥ä½œå…¨éƒ¨éƒ½ç”±è¿™ä¸ª<code>Reactorçº¿ç¨‹</code>æ¥è´Ÿè´£æ‰§è¡Œäº†ã€‚</strong></p> <p>è€Œç”¨æˆ·å¯åŠ¨çº¿ç¨‹åœ¨å‘<code>Reactor</code>æäº¤å®Œ<code>NioServerSocketChannel</code>çš„æ³¨å†Œä»»åŠ¡<code>register0</code>åï¼Œå°±é€æ­¥é€€å‡ºè°ƒç”¨å †æ ˆï¼Œå›é€€åˆ°æœ€å¼€å§‹çš„å¯åŠ¨å…¥å£å¤„<code>ChannelFuture f = b.bind(PORT).sync()</code></p> <p>æ­¤æ—¶<code>Reactor</code>ä¸­çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ªä»»åŠ¡<code>register0</code>ï¼Œ<code>Reactorçº¿ç¨‹</code>å¯åŠ¨åï¼Œä¼šä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡æ‰§è¡Œã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192046152.webp" alt="å›¾ç‰‡"></p> <p>è‡³æ­¤<code>NioServerSocketChannel</code>çš„æ³¨å†Œå·¥ä½œæ­£å¼æ‹‰å¼€å¸·å¹•~~</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192046799.webp" alt="å›¾ç‰‡"></p> <h5 id="_1-3-5-register0"><a href="#_1-3-5-register0" class="header-anchor">#</a> 1.3.5 register0</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//true if the channel has never been registered, false otherwise</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> neverRegistered <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">register0</span><span class="token punctuation">(</span><span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//æŸ¥çœ‹æ³¨å†Œæ“ä½œæ˜¯å¦å·²ç»å–æ¶ˆï¼Œæˆ–è€…å¯¹åº”channelå·²ç»å…³é—­</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>promise<span class="token punctuation">.</span><span class="token function">setUncancellable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">ensureOpen</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">boolean</span> firstRegistration <span class="token operator">=</span> neverRegistered<span class="token punctuation">;</span>
        <span class="token comment">//æ‰§è¡ŒçœŸæ­£çš„æ³¨å†Œæ“ä½œ</span>
        <span class="token function">doRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//ä¿®æ”¹æ³¨å†ŒçŠ¶æ€</span>
        neverRegistered <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        registered <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">//å›è°ƒ pipeline ä¸­æ·»åŠ çš„ChannelInitializerçš„handlerAddedæ–¹æ³•ï¼Œåœ¨è¿™é‡Œåˆå§‹åŒ–channelPipeline</span>
        pipeline<span class="token punctuation">.</span><span class="token function">invokeHandlerAddedIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//è®¾ç½®regFutureä¸ºsuccessï¼Œè§¦å‘operationCompleteå›è°ƒ,å°†bindæ“ä½œæ”¾å…¥Reactorçš„ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…Reactorçº¿ç¨‹æ‰§è¡Œã€‚</span>
        <span class="token function">safeSetSuccess</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//è§¦å‘channelRegisteräº‹ä»¶</span>
        pipeline<span class="token punctuation">.</span><span class="token function">fireChannelRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//å¯¹äºæœåŠ¡ç«¯ServerSocketChannelæ¥è¯´ åªæœ‰ç»‘å®šç«¯å£åœ°å€æˆåŠŸå channelçš„çŠ¶æ€æ‰æ˜¯activeçš„ã€‚</span>
        <span class="token comment">//æ­¤æ—¶ç»‘å®šæ“ä½œä½œä¸ºå¼‚æ­¥ä»»åŠ¡åœ¨ Reactor çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œç»‘å®šæ“ä½œè¿˜æ²¡å¼€å§‹ï¼Œæ‰€ä»¥è¿™é‡Œçš„ isActive() æ˜¯false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>firstRegistration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//è§¦å‘channelActiveäº‹ä»¶</span>
                pipeline<span class="token punctuation">.</span><span class="token function">fireChannelActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAutoRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">beginRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>register0</code>æ˜¯é©±åŠ¨æ•´ä¸ª<code>Channel</code>æ³¨å†Œç»‘å®šæµç¨‹çš„å…³é”®æ–¹æ³•ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒçš„æ ¸å¿ƒé€»è¾‘ï¼š</p> <ul><li>é¦–å…ˆéœ€è¦æ£€æŸ¥<code>Channel</code>çš„æ³¨å†ŒåŠ¨ä½œæ˜¯å¦åœ¨<code>Reactorçº¿ç¨‹</code>å¤–è¢«å–æ¶ˆäº†å·²ç»<code>!promise.setUncancellable()</code>ã€‚æ£€æŸ¥è¦æ³¨å†Œçš„<code>Channel</code>æ˜¯å¦å·²ç»å…³é—­<code>!ensureOpen(promise)</code>ã€‚å¦‚æœ<code>Channel</code>å·²ç»å…³é—­æˆ–è€…æ³¨å†Œæ“ä½œå·²ç»è¢«å–æ¶ˆï¼Œé‚£ä¹ˆå°±ç›´æ¥è¿”å›ï¼Œåœæ­¢æ³¨å†Œæµç¨‹ã€‚</li> <li>è°ƒç”¨<code>doRegister()</code>æ–¹æ³•ï¼Œæ‰§è¡ŒçœŸæ­£çš„æ³¨å†Œæ“ä½œã€‚æœ€ç»ˆå®ç°åœ¨<code>AbstractChannel</code>çš„å­ç±»<code>AbstractNioChannel</code>ä¸­ï¼Œè¿™ä¸ªæˆ‘ä»¬ä¸€ä¼šåœ¨ä»‹ç»ï¼Œå…ˆå…³æ³¨æ•´ä½“æµç¨‹ã€‚</li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractChannel</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultAttributeMap</span> <span class="token keyword">implements</span> <span class="token class-name">Channel</span> <span class="token punctuation">{</span>

   <span class="token comment">/**
     * Is called after the {@link Channel} is registered with its {@link EventLoop} as part of the register process.
     *
     * Sub-classes may override this method
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// NOOP</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><ul><li>å½“<code>Channel</code>å‘<code>Reactor</code>æ³¨å†Œå®Œæ¯•åï¼Œè°ƒç”¨<code>pipeline.invokeHandlerAddedIfNeeded()</code>æ–¹æ³•ï¼Œè§¦å‘å›è°ƒ pipeline ä¸­æ·»åŠ çš„ ChannelInitializer çš„ handlerAdded æ–¹æ³•ï¼Œåœ¨ handlerAdded æ–¹æ³•ä¸­åˆ©ç”¨å‰é¢æåˆ°çš„<code>ChannelInitializer</code>åˆå§‹åŒ–<code>ChannelPipeline</code>ã€‚</li></ul> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192046152.webp" alt="å›¾ç‰‡"></p> <blockquote><p>åˆå§‹åŒ–<code>ChannelPipeline</code>çš„æ—¶æœºæ˜¯å½“<code>Channel</code>å‘å¯¹åº”çš„<code>Reactor</code>æ³¨å†ŒæˆåŠŸåï¼Œåœ¨<code>handlerAddedäº‹ä»¶å›è°ƒ</code>ä¸­åˆ©ç”¨<code>ChannelInitializer</code>è¿›è¡Œåˆå§‹åŒ–ã€‚</p></blockquote> <ul><li>è®¾ç½®<code>regFuture</code>ä¸º<code>Success</code>ï¼Œå¹¶å›è°ƒæ³¨å†Œåœ¨<code>regFuture</code>ä¸Šçš„<code>ChannelFutureListener#operationComplete</code>æ–¹æ³•ï¼Œåœ¨<code>operationComplete</code>å›è°ƒæ–¹æ³•ä¸­å°†<code>ç»‘å®šæ“ä½œ</code>å°è£…æˆå¼‚æ­¥ä»»åŠ¡ï¼Œæäº¤åˆ°<code>Reactor</code>çš„<code>taskQueue</code>ä¸­ã€‚ç­‰å¾…<code>Reactor</code>çš„æ‰§è¡Œã€‚</li></ul> <blockquote><p>è¿˜è®°å¾—è¿™ä¸ª<code>regFuture</code>åœ¨å“ªé‡Œå‡ºç°çš„å—ï¼Ÿå®ƒæ˜¯åœ¨å“ªé‡Œè¢«åˆ›å»ºï¼Œåˆæ˜¯åœ¨å“ªé‡Œæ·»åŠ çš„<code>ChannelFutureListener</code>å‘¢ï¼Ÿå¤§å®¶è¿˜æœ‰å°è±¡å—ï¼Ÿå›å¿†ä¸èµ·æ¥ä¹Ÿæ²¡å…³ç³»ï¼Œç¬”è€…åé¢è¿˜ä¼šæåˆ°</p></blockquote> <ul><li>é€šè¿‡<code>pipeline.fireChannelRegistered()</code>åœ¨<code>pipeline</code>ä¸­è§¦å‘<code>channelRegisteräº‹ä»¶</code>ã€‚</li></ul> <blockquote><p><code>pipeline</code>ä¸­<code>channelHandler</code>çš„<code>channelRegisteredæ–¹æ³•</code>è¢«å›è°ƒã€‚</p></blockquote> <ul><li>å¯¹äº Netty æœåŠ¡ç«¯<code>NioServerSocketChannel</code>æ¥è¯´ï¼Œ åªæœ‰<code>ç»‘å®šç«¯å£åœ°å€æˆåŠŸ</code>å channel çš„çŠ¶æ€æ‰æ˜¯<code>active</code>çš„ã€‚æ­¤æ—¶<code>ç»‘å®šæ“ä½œ</code>åœ¨<code>regFuture</code>ä¸Šæ³¨å†Œçš„<code>ChannelFutureListener#operationComplete</code>å›è°ƒæ–¹æ³•ä¸­è¢«ä½œä¸ºå¼‚æ­¥ä»»åŠ¡æäº¤åˆ°äº†<code>Reactor</code>çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œ<code>Reactorçº¿ç¨‹</code>è¿˜<code>æ²¡å¼€å§‹</code>æ‰§è¡Œ<code>ç»‘å®šä»»åŠ¡</code>ã€‚æ‰€ä»¥è¿™é‡Œçš„<code>isActive()</code>æ˜¯<code>false</code>ã€‚</li></ul> <blockquote><p>å½“<code>Reactorçº¿ç¨‹</code>æ‰§è¡Œå®Œ<code>register0æ–¹æ³•</code>åï¼Œæ‰ä¼šå»æ‰§è¡Œ<code>ç»‘å®šä»»åŠ¡</code>ã€‚</p></blockquote> <p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹<code>register0</code>æ–¹æ³•ä¸­è¿™äº›<code>æ ¸å¿ƒæ­¥éª¤</code>çš„å…·ä½“å®ç°ï¼š</p> <h5 id="_1-3-6-doregister"><a href="#_1-3-6-doregister" class="header-anchor">#</a> 1.3.6 doRegister()</h5> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractNioChannel</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractChannel</span> <span class="token punctuation">{</span>

    <span class="token comment">//channelæ³¨å†Œåˆ°Selectoråè·å¾—çš„SelectKey</span>
    <span class="token keyword">volatile</span> <span class="token class-name">SelectionKey</span> selectionKey<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> selected <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                selectionKey <span class="token operator">=</span> <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrappedSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CancelledKeyException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>è°ƒç”¨åº•å±‚<code>JDK NIO Channel</code>æ–¹æ³•<code>java.nio.channels.SelectableChannel#register(java.nio.channels.Selector, int, java.lang.Object)</code>ï¼Œå°† Netty<code>NioServerSocketChannel</code>ä¸­åŒ…è£…çš„<code>JDK NIO ServerSocketChannel</code>æ³¨å†Œåˆ°<code>Reactor</code>ä¸­çš„<code>JDK NIO Selector</code>ä¸Šã€‚</p> <p>ç®€å•ä»‹ç»ä¸‹<code>SelectableChannel#register</code>æ–¹æ³•å‚æ•°çš„å«ä¹‰ï¼š</p> <ul><li><code>Selectorï¼š</code>è¡¨ç¤º<code>JDK NIO Channel</code>å°†è¦å‘å“ªä¸ª<code>Selector</code>è¿›è¡Œæ³¨å†Œã€‚</li> <li><code>int opsï¼š</code> è¡¨ç¤º<code>Channel</code>ä¸Šæ„Ÿå…´è¶£çš„<code>IOäº‹ä»¶</code>ï¼Œå½“å¯¹åº”çš„<code>IOäº‹ä»¶å°±ç»ª</code>æ—¶ï¼Œ<code>Selector</code>ä¼šè¿”å›<code>Channel</code>å¯¹åº”çš„<code>SelectionKey</code>ã€‚</li></ul> <blockquote><p><code>SelectionKey</code>å¯ä»¥ç†è§£ä¸º<code>Channel</code>åœ¨<code>Selector</code>ä¸Šçš„ç‰¹æ®Šè¡¨ç¤ºå½¢å¼ï¼Œ <code>SelectionKey</code>ä¸­å°è£…äº†<code>Channel</code>æ„Ÿå…´è¶£çš„<code>IOäº‹ä»¶é›†åˆ~~~interestOps</code>ï¼Œä»¥åŠ<code>IOå°±ç»ªçš„äº‹ä»¶é›†åˆ~~readyOps</code>ï¼Œ åŒæ—¶ä¹Ÿå°è£…äº†å¯¹åº”çš„<code>JDK NIO Channel</code>ä»¥åŠæ³¨å†Œçš„<code>Selector</code>ã€‚æœ€åè¿˜æœ‰ä¸€ä¸ªé‡è¦çš„å±æ€§<code>attachment</code>ï¼Œå¯ä»¥å…è®¸æˆ‘ä»¬åœ¨<code>SelectionKey</code>ä¸Šé™„åŠ ä¸€äº›è‡ªå®šä¹‰çš„å¯¹è±¡ã€‚</p></blockquote> <ul><li><code>Object attachmentï¼š</code>å‘<code>SelectionKey</code>ä¸­æ·»åŠ ç”¨æˆ·è‡ªå®šä¹‰çš„é™„åŠ å¯¹è±¡ã€‚</li></ul> <blockquote><p>è¿™é‡Œ<code>NioServerSocketChannel</code>å‘<code>Reactor</code>ä¸­çš„<code>Selector</code>æ³¨å†Œçš„<code>IOäº‹ä»¶</code>ä¸º<code>0</code>ï¼Œè¿™ä¸ªæ“ä½œçš„ä¸»è¦ç›®çš„æ˜¯å…ˆè·å–åˆ°<code>Channel</code>åœ¨<code>Selector</code>ä¸­å¯¹åº”çš„<code>SelectionKey</code>ï¼Œå®Œæˆæ³¨å†Œã€‚å½“ç»‘å®šæ“ä½œå®Œæˆåï¼Œåœ¨å»å‘<code>SelectionKey</code>æ·»åŠ æ„Ÿå…´è¶£çš„<code>IOäº‹ä»¶</code>~~~<code>OP_ACCEPTäº‹ä»¶</code>ã€‚</p></blockquote> <blockquote><p>åŒæ—¶é€šè¿‡<code>SelectableChannel#register</code>æ–¹æ³•å°† Netty è‡ªå®šä¹‰çš„<code>NioServerSocketChannel</code>ï¼ˆè¿™é‡Œçš„<code>this</code>æŒ‡é’ˆï¼‰é™„ç€åœ¨<code>SelectionKey</code>çš„<code>attechment</code>å±æ€§ä¸Šï¼Œ<strong>å®Œæˆ Netty è‡ªå®šä¹‰<code>Channel</code>ä¸ JDK NIO <code>Channel</code>çš„å…³ç³»ç»‘å®š</strong>ã€‚è¿™æ ·åœ¨æ¯æ¬¡å¯¹<code>Selector</code>è¿›è¡Œ<code>IOå°±ç»ªäº‹ä»¶</code>è½®è¯¢æ—¶ï¼ŒNetty éƒ½å¯ä»¥ä» <code>JDK NIO Selector</code>è¿”å›çš„<code>SelectionKey</code>ä¸­è·å–åˆ°è‡ªå®šä¹‰çš„<code>Channel</code>å¯¹è±¡ï¼ˆè¿™é‡ŒæŒ‡çš„å°±æ˜¯<code>NioServerSocketChannel</code>ï¼‰ã€‚</p></blockquote> <h5 id="_1-3-7-handleradded-äº‹ä»¶å›è°ƒä¸­åˆå§‹åŒ–-channelpipeline"><a href="#_1-3-7-handleradded-äº‹ä»¶å›è°ƒä¸­åˆå§‹åŒ–-channelpipeline" class="header-anchor">#</a> 1.3.7 HandlerAdded äº‹ä»¶å›è°ƒä¸­åˆå§‹åŒ– ChannelPipeline</h5> <p>å½“<code>NioServerSocketChannel</code>æ³¨å†Œåˆ°<code>Main Reactor</code>ä¸Šçš„<code>Selector</code>åï¼ŒNetty é€šè¿‡è°ƒç”¨<code>pipeline.invokeHandlerAddedIfNeeded()</code>å¼€å§‹å›è°ƒ<code>NioServerSocketChannel</code>ä¸­<code>pipeline</code>é‡Œçš„ ChannelHandler çš„<code>handlerAddedæ–¹æ³•</code>ã€‚</p> <p>æ­¤æ—¶<code>NioServerSocketChannel</code>çš„<code>pipeline</code>ç»“æ„å¦‚ä¸‹ï¼š</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192046152.webp" alt="å›¾ç‰‡"></p> <p>æ­¤æ—¶<code>pipeline</code>ä¸­åªæœ‰åœ¨åˆå§‹åŒ–<code>NioServerSocketChannel</code>æ—¶æ·»åŠ çš„<code>ChannelInitializer</code>ã€‚</p> <p>æˆ‘ä»¬æ¥çœ‹ä¸‹<code>ChannelInitializer</code>ä¸­<code>handlerAddedå›è°ƒæ–¹æ³•</code>å…·ä½“ä½œäº†å“ªäº›äº‹æƒ…~~</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span> <span class="token keyword">extends</span> <span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handlerAdded</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">initChannel</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//åˆå§‹åŒ–å·¥ä½œå®Œæˆåï¼Œéœ€è¦å°†è‡ªèº«ä»pipelineä¸­ç§»é™¤</span>
                <span class="token function">removeState</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//ChannelInitializerå®ä¾‹æ˜¯è¢«æ‰€æœ‰çš„Channelå…±äº«çš„ï¼Œç”¨äºåˆå§‹åŒ–ChannelPipeline</span>
    <span class="token comment">//é€šè¿‡Seté›†åˆä¿å­˜å·²ç»åˆå§‹åŒ–çš„ChannelPipelineï¼Œé¿å…é‡å¤åˆå§‹åŒ–åŒä¸€ChannelPipeline</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">&gt;</span></span> initMap <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">newSetFromMap</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>initMap<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Guard against re-entrance.</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">C</span><span class="token punctuation">)</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">exceptionCaught</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pipeline<span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                     <span class="token comment">//åˆå§‹åŒ–å®Œæ¯•åï¼Œä»pipelineä¸­ç§»é™¤è‡ªèº«</span>
                    pipeline<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//åŒ¿åç±»å®ç°ï¼Œè¿™é‡ŒæŒ‡å®šå…·ä½“çš„åˆå§‹åŒ–é€»è¾‘</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">C</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">removeState</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//ä»initMapé˜²é‡Seté›†åˆä¸­åˆ é™¤ChannelInitializer</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">isRemoved</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            initMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    initMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>ChannelInitializer</code>ä¸­çš„åˆå§‹åŒ–é€»è¾‘æ¯”è¾ƒç®€å•æ˜äº†ï¼š</p> <ul><li>é¦–å…ˆè¦åˆ¤æ–­å¿…é¡»æ˜¯å½“å‰<code>Channel</code>å·²ç»å®Œæˆæ³¨å†Œåï¼Œæ‰å¯ä»¥è¿›è¡Œ<code>pipeline</code>çš„åˆå§‹åŒ–ã€‚<code>ctx.channel().isRegistered()</code></li> <li>è°ƒç”¨<code>ChannelInitializer</code>çš„åŒ¿åç±»æŒ‡å®šçš„<code>initChannel</code>æ‰§è¡Œè‡ªå®šä¹‰çš„åˆå§‹åŒ–é€»è¾‘ã€‚</li></ul> <div class="language-Java extra-class"><pre class="language-java"><code>p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Channel</span> ch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//ServerBootstrapä¸­ç”¨æˆ·æŒ‡å®šçš„channelHandler</span>
        <span class="token class-name">ChannelHandler</span> handler <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        ch<span class="token punctuation">.</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServerBootstrapAcceptor</span><span class="token punctuation">(</span>
                    ch<span class="token punctuation">,</span> currentChildGroup<span class="token punctuation">,</span> currentChildHandler<span class="token punctuation">,</span> currentChildOptions<span class="token punctuation">,</span> currentChildAttrs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>è¿˜è®°å¾—åœ¨åˆå§‹åŒ–<code>NioServerSocketChannel</code>æ—¶ã€‚<code>io.netty.bootstrap.ServerBootstrap#init</code>æ–¹æ³•ä¸­å‘<code>pipeline</code>ä¸­æ·»åŠ çš„<code>ChannelInitializer</code>å—ï¼Ÿ</p></blockquote> <ul><li>å½“æ‰§è¡Œå®Œ<code>initChannel æ–¹æ³•</code>åï¼Œ<code>ChannelPipeline</code>çš„åˆå§‹åŒ–å°±ç»“æŸäº†ï¼Œæ­¤æ—¶<code>ChannelInitializer</code>å°±æ²¡å¿…è¦å†ç»§ç»­å‘†åœ¨<code>pipelineä¸­äº†</code>ï¼Œæ‰€éœ€è¦å°†<code>ChannelInitializer</code>ä»<code>pipeline</code>ä¸­åˆ é™¤ã€‚<code>pipeline.remove(this)</code></li></ul> <p>å½“åˆå§‹åŒ–å®Œ<code>pipeline</code>æ—¶ï¼Œæ­¤æ—¶<code>pipeline</code>çš„ç»“æ„å†æ¬¡å‘ç”Ÿäº†å˜åŒ–ï¼š</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192147362.webp" alt="å›¾ç‰‡"></p> <p>æ­¤æ—¶<code>Main Reactor</code>ä¸­çš„ä»»åŠ¡é˜Ÿåˆ—<code>taskQueue</code>ç»“æ„å˜åŒ–ä¸ºï¼š</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192046068.webp" alt="å›¾ç‰‡"></p> <p>æ·»åŠ <code>ServerBootstrapAcceptor</code>çš„ä»»åŠ¡æ˜¯åœ¨åˆå§‹åŒ–<code>NioServerSocketChannel</code>çš„æ—¶å€™å‘ main reactor æäº¤è¿‡å»çš„ã€‚è¿˜è®°å¾—å—ï¼Ÿ</p> <h5 id="_1-3-8-å›è°ƒ-regfuture-çš„-channelfuturelistener"><a href="#_1-3-8-å›è°ƒ-regfuture-çš„-channelfuturelistener" class="header-anchor">#</a> 1.3.8 å›è°ƒ regFuture çš„ ChannelFutureListener</h5> <p>åœ¨æœ¬å°èŠ‚ã€ŠNetty æœåŠ¡ç«¯çš„å¯åŠ¨ã€‹çš„æœ€å¼€å§‹ï¼Œæˆ‘ä»¬ä»‹ç»äº†æœåŠ¡ç«¯å¯åŠ¨çš„å…¥å£å‡½æ•°<code>io.netty.bootstrap.AbstractBootstrap#doBind</code>ï¼Œåœ¨å‡½æ•°çš„æœ€å¼€å¤´è°ƒç”¨äº†<code>initAndRegister()</code>æ–¹æ³•ç”¨æ¥åˆ›å»ºå¹¶åˆå§‹åŒ–<code>NioServerSocketChannel</code>ï¼Œä¹‹åä¾¿ä¼šå°†<code>NioServerSocketChannel</code>æ³¨å†Œåˆ°<code>Main Reactor</code>ä¸­ã€‚</p> <p>æ³¨å†Œçš„æ“ä½œæ˜¯ä¸€ä¸ªå¼‚æ­¥çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥åœ¨<code>initAndRegister()</code>æ–¹æ³•è°ƒç”¨åè¿”å›ä¸€ä¸ªä»£è¡¨æ³¨å†Œç»“æœçš„<code>ChannelFuture regFuture</code>ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractBootstrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractBootstrap</span><span class="token punctuation">&lt;</span><span class="token class-name">B</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">C</span> <span class="token keyword">extends</span> <span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Cloneable</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">ChannelFuture</span> <span class="token function">doBind</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//å¼‚æ­¥åˆ›å»ºï¼Œåˆå§‹åŒ–ï¼Œæ³¨å†ŒServerSocketChannel</span>
        <span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> regFuture <span class="token operator">=</span> <span class="token function">initAndRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">Channel</span> channel <span class="token operator">=</span> regFuture<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>regFuture<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> regFuture<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>regFuture<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//å¦‚æœæ³¨å†Œå®Œæˆï¼Œåˆ™è¿›è¡Œç»‘å®šæ“ä½œ</span>
            <span class="token class-name">ChannelPromise</span> promise <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">newPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">doBind0</span><span class="token punctuation">(</span>regFuture<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> localAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">PendingRegistrationPromise</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PendingRegistrationPromise</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//æ·»åŠ æ³¨å†Œå®Œæˆ å›è°ƒå‡½æ•°</span>
            regFuture<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelFutureListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelFuture</span> future<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                        <span class="token comment">// æ³¨å†Œå®Œæˆåï¼ŒReactorçº¿ç¨‹å›è°ƒè¿™é‡Œ</span>
                        <span class="token function">doBind0</span><span class="token punctuation">(</span>regFuture<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> localAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
                                  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¹‹åä¼šå‘<code>ChannelFuture regFuture</code>æ·»åŠ ä¸€ä¸ª<code>æ³¨å†Œå®Œæˆåçš„å›è°ƒå‡½æ•°~~~~ ChannelFutureListener</code>ã€‚åœ¨å›è°ƒå‡½æ•°<code>operationComplete</code>ä¸­å¼€å§‹å‘èµ·<code>ç»‘ç«¯å£åœ°å€æµç¨‹</code>ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192152233.webp" alt="å›¾ç‰‡"></p> <p><strong>é‚£ä¹ˆè¿™ä¸ªå›è°ƒå‡½æ•°åœ¨ä»€ä¹ˆæ—¶å€™ï¼Ÿä»€ä¹ˆåœ°æ–¹å‘èµ·çš„å‘¢ï¼Ÿï¼Ÿ</strong></p> <p>è®©æˆ‘ä»¬åœ¨å›åˆ°æœ¬å°èŠ‚çš„ä¸»é¢˜<code>register0</code>æ–¹æ³•çš„æµç¨‹ä¸­ï¼š</p> <p>å½“è°ƒç”¨<code>doRegister()</code>æ–¹æ³•å®Œæˆ<code>NioServerSocketChannel</code>å‘<code>Main Reactor</code>çš„æ³¨å†Œåï¼Œç´§æ¥ç€ä¼šè°ƒç”¨<code>pipeline.invokeHandlerAddedIfNeeded()</code>æ–¹æ³•ä¸­è§¦å‘<code>ChannelInitializer#handlerAdded</code>å›è°ƒä¸­å¯¹<code>pipeline</code>è¿›è¡Œåˆå§‹åŒ–ã€‚</p> <p>æœ€ååœ¨<code>safeSetSuccess</code>æ–¹æ³•ä¸­ï¼Œå¼€å§‹å›è°ƒæ³¨å†Œåœ¨<code>regFuture</code>ä¸Šçš„<code>ChannelFutureListener</code>ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">safeSetSuccess</span><span class="token punctuation">(</span><span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>promise <span class="token keyword">instanceof</span> <span class="token class-name">VoidChannelPromise</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>promise<span class="token punctuation">.</span><span class="token function">trySuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to mark a promise as success because it is done already: {}&quot;</span><span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">trySuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">trySuccess</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">trySuccess</span><span class="token punctuation">(</span><span class="token class-name">V</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">setSuccess0</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">setSuccess0</span><span class="token punctuation">(</span><span class="token class-name">V</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">setValue0</span><span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token constant">SUCCESS</span> <span class="token operator">:</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">setValue0</span><span class="token punctuation">(</span><span class="token class-name">Object</span> objResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">RESULT_UPDATER</span><span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> objResult<span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token constant">RESULT_UPDATER</span><span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">UNCANCELLABLE</span><span class="token punctuation">,</span> objResult<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkNotifyWaiters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//å›è°ƒæ³¨å†Œåœ¨promiseä¸Šçš„listeners</span>
            <span class="token function">notifyListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>safeSetSuccess</code>çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆè®¾ç½®<code>regFuture</code>ç»“æœä¸º<code>success</code>ï¼Œå¹¶ä¸”å›è°ƒæ³¨å†Œåœ¨<code>regFuture</code>ä¸Šçš„<code>ChannelFutureListener</code>ã€‚</p> <blockquote><p>éœ€è¦æé†’çš„æ˜¯ï¼Œæ‰§è¡Œ<code>safeSetSuccess</code>æ–¹æ³•ï¼Œä»¥åŠåè¾¹å›è°ƒ<code>regFuture</code>ä¸Šçš„<code>ChannelFutureListener</code><strong>è¿™äº›åŠ¨ä½œéƒ½æ˜¯ç”±<code>Reactorçº¿ç¨‹</code>æ‰§è¡Œçš„ã€‚</strong></p></blockquote> <blockquote><p>å…³äº Netty ä¸­çš„<code>Promiseæ¨¡å‹</code>åè¾¹æˆ‘ä¼šåœ¨å†™ä¸€ç¯‡ä¸“é—¨çš„æ–‡ç« è¿›è¡Œåˆ†æï¼Œè¿™é‡Œå¤§å®¶åªéœ€æ¸…æ¥šå¤§ä½“çš„æµç¨‹å³å¯ã€‚ä¸å¿…åœ¨æ„è¿‡å¤šçš„ç»†èŠ‚ã€‚</p></blockquote> <p>ä¸‹é¢æˆ‘ä»¬æŠŠè§†è§’åˆ‡æ¢åˆ°<code>regFuture</code>ä¸Šçš„<code>ChannelFutureListener</code>å›è°ƒä¸­ï¼Œçœ‹çœ‹åœ¨<code>Channel</code>æ³¨å†Œå®Œæˆåï¼ŒNetty åˆä¼šåšå“ªäº›äº‹æƒ…ï¼Ÿ</p> <h3 id="_2-dobind0"><a href="#_2-dobind0" class="header-anchor">#</a> 2. doBind0</h3> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractBootstrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractBootstrap</span><span class="token punctuation">&lt;</span><span class="token class-name">B</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">C</span> <span class="token keyword">extends</span> <span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Cloneable</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">doBind0</span><span class="token punctuation">(</span>
            <span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> regFuture<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        channel<span class="token punctuation">.</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>regFuture<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    channel<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>localAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token class-name">ChannelFutureListener</span><span class="token punctuation">.</span><span class="token constant">CLOSE_ON_FAILURE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    promise<span class="token punctuation">.</span><span class="token function">setFailure</span><span class="token punctuation">(</span>regFuture<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>è¿™é‡Œ Netty åˆå°†<code>ç»‘å®šç«¯å£åœ°å€</code>çš„æ“ä½œå°è£…æˆå¼‚æ­¥ä»»åŠ¡ï¼Œæäº¤ç»™<code>Reactor</code>æ‰§è¡Œã€‚</p> <p><strong>ä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå…¶å®æ­¤æ—¶æ‰§è¡Œ<code>doBind0</code>æ–¹æ³•çš„çº¿ç¨‹æ­£æ˜¯<code>Reactorçº¿ç¨‹</code>ï¼Œé‚£ä¸ºä»€ä¹ˆä¸ç›´æ¥åœ¨è¿™é‡Œå»æ‰§è¡Œ<code>bindæ“ä½œ</code>ï¼Œè€Œæ˜¯å†æ¬¡å°è£…æˆå¼‚æ­¥ä»»åŠ¡æäº¤ç»™<code>Reactor</code>ä¸­çš„<code>taskQueue</code>å‘¢ï¼Ÿ</strong></p> <p><strong>åæ­£æœ€ç»ˆéƒ½æ˜¯ç”±<code>Reactorçº¿ç¨‹</code>æ‰§è¡Œï¼Œè¿™å…¶ä¸­åˆæœ‰ä»€ä¹ˆåˆ†åˆ«å‘¢ï¼Ÿ</strong></p> <p>ç»è¿‡ä¸Šå°èŠ‚çš„ä»‹ç»æˆ‘ä»¬çŸ¥é“ï¼Œ<code>bind0</code>æ–¹æ³•çš„è°ƒç”¨æ˜¯ç”±<code>io.netty.channel.AbstractChannel.AbstractUnsafe#register0</code>æ–¹æ³•åœ¨å°†<code>NioServerSocketChannel</code>æ³¨å†Œåˆ°<code>Main Reactor</code>ä¹‹åï¼Œå¹¶ä¸”<code>NioServerSocketChannel</code>çš„<code>pipeline</code>å·²ç»åˆå§‹åŒ–å®Œæ¯•åï¼Œé€šè¿‡<code>safeSetSuccess</code>æ–¹æ³•å›è°ƒè¿‡æ¥çš„ã€‚</p> <p>è¿™ä¸ªè¿‡ç¨‹å…¨ç¨‹æ˜¯ç”±<code>Reactorçº¿ç¨‹</code>æ¥è´Ÿè´£æ‰§è¡Œçš„ï¼Œä½†æ˜¯æ­¤æ—¶<code>register0</code>æ–¹æ³•å¹¶æ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œè¿˜éœ€è¦æ‰§è¡Œåé¢çš„é€»è¾‘ã€‚</p> <p><strong>è€Œç»‘å®šé€»è¾‘éœ€è¦åœ¨æ³¨å†Œé€»è¾‘æ‰§è¡Œå®Œä¹‹åæ‰§è¡Œ</strong>ï¼Œæ‰€ä»¥åœ¨<code>doBind0</code>æ–¹æ³•ä¸­<code>Reactorçº¿ç¨‹</code>ä¼šå°†<code>ç»‘å®šæ“ä½œ</code>å°è£…æˆå¼‚æ­¥ä»»åŠ¡å…ˆæäº¤ç»™<code>taskQueue</code>ä¸­ä¿å­˜ï¼Œè¿™æ ·å¯ä»¥ä½¿<code>Reactorçº¿ç¨‹</code>ç«‹é©¬ä»<code>safeSetSuccess</code>ä¸­è¿”å›ï¼Œç»§ç»­æ‰§è¡Œå‰©ä¸‹çš„<code>register0</code>æ–¹æ³•é€»è¾‘ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">register0</span><span class="token punctuation">(</span><span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token function">doRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pipeline<span class="token punctuation">.</span><span class="token function">invokeHandlerAddedIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">safeSetSuccess</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//è§¦å‘channelRegisteräº‹ä»¶</span>
        pipeline<span class="token punctuation">.</span><span class="token function">fireChannelRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å½“<code>Reactorçº¿ç¨‹</code>æ‰§è¡Œå®Œ<code>register0</code>æ–¹æ³•åï¼Œå°±ä¼šä»<code>taskQueue</code>ä¸­å–å‡ºå¼‚æ­¥ä»»åŠ¡æ‰§è¡Œã€‚</p> <p>æ­¤æ—¶<code>Reactorçº¿ç¨‹</code>ä¸­çš„<code>taskQueue</code>ç»“æ„å¦‚ä¸‹ï¼š</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192046393.webp" alt="å›¾ç‰‡">regFuture å›è°ƒå taksQueue çš„ç»“æ„.png</p> <ul><li><code>Reactorçº¿ç¨‹</code>ä¼šå…ˆå–å‡ºä½äº<code>taskQueue</code>é˜Ÿé¦–çš„ä»»åŠ¡æ‰§è¡Œï¼Œè¿™é‡Œæ˜¯æŒ‡å‘<code>NioServerSocketChannel</code>çš„<code>pipeline</code>ä¸­æ·»åŠ <code>ServerBootstrapAcceptor</code>çš„å¼‚æ­¥ä»»åŠ¡ã€‚</li></ul> <p>æ­¤æ—¶<code>NioServerSocketChannel</code>ä¸­<code>pipeline</code>çš„ç»“æ„å¦‚ä¸‹ï¼š</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192047986.webp" alt="å›¾ç‰‡">ServerChannelPipeline å®Œæ•´ç»“æ„.png</p> <ul><li><code>Reactorçº¿ç¨‹</code>æ‰§è¡Œç»‘å®šä»»åŠ¡ã€‚</li></ul> <h3 id="_3-ç»‘å®šç«¯å£åœ°å€"><a href="#_3-ç»‘å®šç«¯å£åœ°å€" class="header-anchor">#</a> 3. ç»‘å®šç«¯å£åœ°å€</h3> <p>å¯¹<code>Channel</code>çš„æ“ä½œè¡Œä¸ºå…¨éƒ¨å®šä¹‰åœ¨<code>ChannelOutboundInvokeræ¥å£ä¸­</code>ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192047841.webp" alt="å›¾ç‰‡">image.png</p> <div class="language- extra-class"><pre class="language-text"><code>public interface ChannelOutboundInvoker {

    /**
     * Request to bind to the given {@link SocketAddress} and notify the {@link ChannelFuture} once the operation
     * completes, either because the operation was successful or because of an error.
     *
     */
    ChannelFuture bind(SocketAddress localAddress, ChannelPromise promise);
}
</code></pre></div><p><code>bind</code>æ–¹æ³•ç”±å­ç±»<code>AbstractChannel</code>å®ç°ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public abstract class AbstractChannel extends DefaultAttributeMap implements Channel {

   @Override
    public ChannelFuture bind(SocketAddress localAddress, ChannelPromise promise) {
        return pipeline.bind(localAddress, promise);
    }

}
</code></pre></div><p>è°ƒç”¨<code>pipeline.bind(localAddress, promise)</code>åœ¨<code>pipeline</code>ä¸­ä¼ æ’­<code>bindäº‹ä»¶</code>ï¼Œè§¦å‘å›è°ƒ<code>pipeline</code>ä¸­æ‰€æœ‰<code>ChannelHandler</code>çš„<code>bindæ–¹æ³•</code>ã€‚</p> <p>äº‹ä»¶åœ¨<code>pipeline</code>ä¸­çš„ä¼ æ’­å…·æœ‰æ–¹å‘æ€§ï¼š</p> <ul><li><code>inboundäº‹ä»¶</code>ä»<code>HeadContext</code>å¼€å§‹é€ä¸ªå‘åä¼ æ’­ç›´åˆ°<code>TailContext</code>ã€‚</li> <li><code>outboundäº‹ä»¶</code>åˆ™æ˜¯åå‘ä¼ æ’­ï¼Œä»<code>TailContext</code>å¼€å§‹åå‘å‘å‰ä¼ æ’­ç›´åˆ°<code>HeadContext</code>ã€‚</li></ul> <blockquote><p><code>inboundäº‹ä»¶</code>åªèƒ½è¢«<code>pipeline</code>ä¸­çš„<code>ChannelInboundHandler</code>å“åº”å¤„ç†<code>outboundäº‹ä»¶</code>åªèƒ½è¢«<code>pipeline</code>ä¸­çš„<code>ChannelOutboundHandler</code>å“åº”å¤„ç†</p></blockquote> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192047175.webp" alt="å›¾ç‰‡">pipeline ä¸­çš„ä¼ æ’­æ–¹å‘.png</p> <p>ç„¶è€Œè¿™é‡Œçš„<code>bindäº‹ä»¶</code>åœ¨ Netty ä¸­è¢«å®šä¹‰ä¸º<code>outboundäº‹ä»¶</code>ï¼Œæ‰€ä»¥å®ƒåœ¨<code>pipeline</code>ä¸­æ˜¯åå‘ä¼ æ’­ã€‚å…ˆä»<code>TailContext</code>å¼€å§‹åå‘ä¼ æ’­ç›´åˆ°<code>HeadContext</code>ã€‚</p> <p>ç„¶è€Œ<code>bind</code>çš„æ ¸å¿ƒé€»è¾‘ä¹Ÿæ­£æ˜¯å®ç°åœ¨<code>HeadContext</code>ä¸­ã€‚</p> <h4 id="_3-1-headcontext"><a href="#_3-1-headcontext" class="header-anchor">#</a> 3.1 HeadContext</h4> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HeadContext</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractChannelHandlerContext</span>
    <span class="token keyword">implements</span> <span class="token class-name">ChannelOutboundHandler</span><span class="token punctuation">,</span> <span class="token class-name">ChannelInboundHandler</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">bind</span><span class="token punctuation">(</span>
        <span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//è§¦å‘AbstractChannel-&gt;bindæ–¹æ³• æ‰§è¡Œ JDK NIO SelectableChannel æ‰§è¡Œåº•å±‚ç»‘å®šæ“ä½œ</span>
        unsafe<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>localAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨<code>HeadContext#bind</code>å›è°ƒæ–¹æ³•ä¸­ï¼Œè°ƒç”¨<code>Channel</code>é‡Œçš„<code>unsafe</code>æ“ä½œç±»æ‰§è¡ŒçœŸæ­£çš„ç»‘å®šæ“ä½œã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractUnsafe</span> <span class="token keyword">implements</span> <span class="token class-name">Unsafe</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token comment">//è¿™æ—¶channelè¿˜æœªæ¿€æ´»  wasActive = false</span>
            <span class="token keyword">boolean</span> wasActive <span class="token operator">=</span> <span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//io.netty.channel.socket.nio.NioServerSocketChannel.doBind</span>
            <span class="token comment">//è°ƒç”¨å…·ä½“channelå®ç°ç±»</span>
            <span class="token function">doBind</span><span class="token punctuation">(</span>localAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//ç»‘å®šæˆåŠŸå channelæ¿€æ´» è§¦å‘channelActiveäº‹ä»¶ä¼ æ’­</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>wasActive <span class="token operator">&amp;&amp;</span> <span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">invokeLater</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//pipelineä¸­è§¦å‘channelActiveäº‹ä»¶</span>
                    pipeline<span class="token punctuation">.</span><span class="token function">fireChannelActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//å›è°ƒæ³¨å†Œåœ¨promiseä¸Šçš„ChannelFutureListener</span>
        <span class="token function">safeSetSuccess</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">doBind</span><span class="token punctuation">(</span><span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>é¦–å…ˆæ‰§è¡Œå­ç±»<code>NioServerSocketChannel</code>å…·ä½“å®ç°çš„<code>doBind</code>æ–¹æ³•ï¼Œé€šè¿‡<code>JDK NIO åŸç”Ÿ ServerSocketChannel</code>æ‰§è¡Œåº•å±‚çš„ç»‘å®šæ“ä½œã€‚</li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doBind</span><span class="token punctuation">(</span><span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">//è°ƒç”¨JDK NIO åº•å±‚SelectableChannel æ‰§è¡Œç»‘å®šæ“ä½œ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">PlatformDependent</span><span class="token punctuation">.</span><span class="token function">javaVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>localAddress<span class="token punctuation">,</span> config<span class="token punctuation">.</span><span class="token function">getBacklog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>localAddress<span class="token punctuation">,</span> config<span class="token punctuation">.</span><span class="token function">getBacklog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>åˆ¤æ–­æ˜¯å¦ä¸ºé¦–æ¬¡ç»‘å®šï¼Œå¦‚æœæ˜¯çš„è¯å°†<code>è§¦å‘pipelineä¸­çš„ChannelActiveäº‹ä»¶</code>å°è£…æˆå¼‚æ­¥ä»»åŠ¡æ”¾å…¥<code>Reactor</code>ä¸­çš„<code>taskQueue</code>ä¸­ã€‚</li> <li>æ‰§è¡Œ<code>safeSetSuccess(promise)</code>,å›è°ƒæ³¨å†Œåœ¨<code>promise</code>ä¸Šçš„<code>ChannelFutureListener</code>ã€‚</li></ul> <p><strong>è¿˜æ˜¯åŒæ ·çš„é—®é¢˜ï¼Œå½“å‰æ‰§è¡Œçº¿ç¨‹å·²ç»æ˜¯<code>Reactorçº¿ç¨‹</code>äº†ï¼Œé‚£ä¹ˆä¸ºä½•ä¸ç›´æ¥è§¦å‘<code>pipeline</code>ä¸­çš„<code>ChannelActive</code>äº‹ä»¶è€Œæ˜¯åˆå°è£…æˆå¼‚æ­¥ä»»åŠ¡å‘¢ï¼Ÿï¼Ÿ</strong></p> <p>å› ä¸ºå¦‚æœç›´æ¥åœ¨è¿™é‡Œè§¦å‘<code>ChannelActiveäº‹ä»¶</code>ï¼Œé‚£ä¹ˆ<code>Reactorçº¿ç¨‹</code>å°±ä¼šå»æ‰§è¡Œ<code>pipeline</code>ä¸­çš„<code>ChannelHandler</code>çš„<code>channelActiveäº‹ä»¶å›è°ƒ</code>ã€‚</p> <p>è¿™æ ·çš„è¯å°±å½±å“äº†<code>safeSetSuccess(promise)</code>çš„æ‰§è¡Œï¼Œ<code>å»¶è¿Ÿäº†</code>æ³¨å†Œåœ¨<code>promise</code>ä¸Šçš„<code>ChannelFutureListener</code>çš„å›è°ƒã€‚</p> <p>åˆ°ç°åœ¨ä¸ºæ­¢ï¼ŒNetty æœåŠ¡ç«¯å°±å·²ç»å®Œæˆäº†ç»‘å®šç«¯å£åœ°å€çš„æ“ä½œï¼Œ<code>NioServerSocketChannel</code>çš„çŠ¶æ€ç°åœ¨å˜ä¸º<code>Active</code>ã€‚</p> <p>æœ€åè¿˜æœ‰ä¸€ä»¶é‡è¦çš„äº‹æƒ…è¦åšï¼Œæˆ‘ä»¬æ¥ç€æ¥çœ‹<code>pipeline</code>ä¸­å¯¹<code>channelActiveäº‹ä»¶</code>å¤„ç†ã€‚</p> <h4 id="_3-2-channelactive-äº‹ä»¶å¤„ç†"><a href="#_3-2-channelactive-äº‹ä»¶å¤„ç†" class="header-anchor">#</a> 3.2 channelActive äº‹ä»¶å¤„ç†</h4> <p><code>channelActiveäº‹ä»¶</code>åœ¨ Netty ä¸­å®šä¹‰ä¸º<code>inboundäº‹ä»¶</code>ï¼Œæ‰€ä»¥å®ƒåœ¨<code>pipeline</code>ä¸­çš„ä¼ æ’­ä¸ºæ­£å‘ä¼ æ’­ï¼Œä»<code>HeadContext</code>ä¸€ç›´åˆ°<code>TailContext</code>ä¸ºæ­¢ã€‚</p> <p>åœ¨<code>channelActiveäº‹ä»¶</code>å›è°ƒä¸­éœ€è¦è§¦å‘å‘<code>Selector</code>æŒ‡å®šéœ€è¦ç›‘å¬çš„<code>IOäº‹ä»¶</code>~~<code>OP_ACCEPTäº‹ä»¶</code>ã€‚</p> <p>è¿™å—çš„é€»è¾‘ä¸»è¦åœ¨<code>HeadContext</code>ä¸­å®ç°ã€‚</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HeadContext</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractChannelHandlerContext</span>
    <span class="token keyword">implements</span> <span class="token class-name">ChannelOutboundHandler</span><span class="token punctuation">,</span> <span class="token class-name">ChannelInboundHandler</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelActive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//pipelineä¸­ç»§ç»­å‘åä¼ æ’­channelActiveäº‹ä»¶</span>
        ctx<span class="token punctuation">.</span><span class="token function">fireChannelActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//å¦‚æœæ˜¯autoRead åˆ™è‡ªåŠ¨è§¦å‘readäº‹ä»¶ä¼ æ’­</span>
        <span class="token comment">//åœ¨readå›è°ƒå‡½æ•°ä¸­ è§¦å‘OP_ACCEPTæ³¨å†Œ</span>
        <span class="token function">readIfIsAutoRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readIfIsAutoRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAutoRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//å¦‚æœæ˜¯autoRead åˆ™è§¦å‘readäº‹ä»¶ä¼ æ’­</span>
            channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//AbstractChannel</span>
    <span class="token keyword">public</span> <span class="token class-name">Channel</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//è§¦å‘readäº‹ä»¶</span>
        pipeline<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//è§¦å‘æ³¨å†ŒOP_ACCEPTæˆ–è€…OP_READäº‹ä»¶</span>
        unsafe<span class="token punctuation">.</span><span class="token function">beginRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>åœ¨<code>HeadContext</code>ä¸­çš„<code>channelActive</code>å›è°ƒä¸­è§¦å‘<code>pipeline</code>ä¸­çš„<code>readäº‹ä»¶</code>ã€‚</li> <li>å½“<code>readäº‹ä»¶</code>å†æ¬¡ä¼ æ’­åˆ°<code>HeadContext</code>æ—¶ï¼Œè§¦å‘<code>HeadContext#read</code>æ–¹æ³•çš„å›è°ƒã€‚åœ¨<code>readå›è°ƒ</code>ä¸­è°ƒç”¨<code>channel</code>åº•å±‚æ“ä½œç±»<code>unsafe</code>çš„<code>beginRead</code>æ–¹æ³•å‘<code>selector</code>æ³¨å†Œç›‘å¬<code>OP_ACCEPTäº‹ä»¶</code>ã€‚</li></ul> <h4 id="_3-3-beginread"><a href="#_3-3-beginread" class="header-anchor">#</a> 3.3 beginRead</h4> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractUnsafe</span> <span class="token keyword">implements</span> <span class="token class-name">Unsafe</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">beginRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">assertEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//channelå¿…é¡»æ˜¯Active</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// è§¦å‘åœ¨selectorä¸Šæ³¨å†Œchannelæ„Ÿå…´è¶£çš„ç›‘å¬äº‹ä»¶</span>
            <span class="token function">doBeginRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>çœç•¥<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractChannel</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultAttributeMap</span> <span class="token keyword">implements</span> <span class="token class-name">Channel</span> <span class="token punctuation">{</span>
    <span class="token comment">//å­ç±»è´Ÿè´£ç»§æ‰¿å®ç°</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">doBeginRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><ul><li>æ–­è¨€åˆ¤æ–­æ‰§è¡Œè¯¥æ–¹æ³•çš„çº¿ç¨‹å¿…é¡»æ˜¯<code>Reactorçº¿ç¨‹</code>ã€‚</li> <li>æ­¤æ—¶<code>NioServerSocketChannel</code>å·²ç»å®Œæˆç«¯å£åœ°å€çš„ç»‘å®šæ“ä½œï¼Œ<code>isActive() = true</code></li> <li>è°ƒç”¨<code>doBeginRead</code>å®ç°å‘<code>Selector</code>æ³¨å†Œç›‘å¬äº‹ä»¶<code>OP_ACCEPT</code></li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractNioChannel</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractChannel</span> <span class="token punctuation">{</span>

    <span class="token comment">//channelæ³¨å†Œåˆ°Selectoråè·å¾—çš„SelectKey</span>
    <span class="token keyword">volatile</span> <span class="token class-name">SelectionKey</span> selectionKey<span class="token punctuation">;</span>
    <span class="token comment">// Channelç›‘å¬äº‹ä»¶é›†åˆ</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">int</span> readInterestOp<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doBeginRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token keyword">final</span> <span class="token class-name">SelectionKey</span> selectionKey <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>selectionKey<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>selectionKey<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        readPending <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> interestOps <span class="token operator">=</span> selectionKey<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/**
         * 1ï¼šServerSocketChannel åˆå§‹åŒ–æ—¶ readInterestOpè®¾ç½®çš„æ˜¯OP_ACCEPTäº‹ä»¶
         * */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>interestOps <span class="token operator">&amp;</span> readInterestOp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//æ·»åŠ OP_ACCEPTäº‹ä»¶åˆ°interestOpsé›†åˆä¸­</span>
            selectionKey<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span>interestOps <span class="token operator">|</span> readInterestOp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>å‰è¾¹æåˆ°åœ¨<code>NioServerSocketChannel</code>åœ¨å‘<code>Main Reactor</code>ä¸­çš„<code>Selector</code>æ³¨å†Œåï¼Œä¼šè·å¾—ä¸€ä¸ª<code>SelectionKey</code>ã€‚è¿™é‡Œé¦–å…ˆè¦è·å–è¿™ä¸ª<code>SelectionKey</code>ã€‚</li> <li>ä»<code>SelectionKey</code>ä¸­è·å–<code>NioServerSocketChannel</code>æ„Ÿå…´è¶£çš„<code>IOäº‹ä»¶é›†åˆ interestOps</code>ï¼Œå½“æ—¶åœ¨æ³¨å†Œçš„æ—¶å€™<code>interestOps</code>è®¾ç½®ä¸º<code>0</code>ã€‚</li> <li>å°†åœ¨<code>NioServerSocketChannel</code>åˆå§‹åŒ–æ—¶è®¾ç½®çš„<code>readInterestOp = OP_ACCEPT</code>ï¼Œè®¾ç½®åˆ°<code>SelectionKey</code>ä¸­çš„<code>interestOps</code>é›†åˆä¸­ã€‚è¿™æ ·<code>Reactor</code>ä¸­çš„<code>Selector</code>å°±å¼€å§‹ç›‘å¬<code>interestOps</code>é›†åˆä¸­åŒ…å«çš„<code>IOäº‹ä»¶</code>äº†ã€‚</li></ul> <blockquote><p><code>Main Reactor</code>ä¸­ä¸»è¦ç›‘å¬çš„æ˜¯<code>OP_ACCEPTäº‹ä»¶</code>ã€‚</p></blockquote> <p>æµç¨‹èµ°åˆ°è¿™é‡Œï¼ŒNetty æœåŠ¡ç«¯å°±çœŸæ­£çš„å¯åŠ¨èµ·æ¥äº†ï¼Œä¸‹ä¸€æ­¥å°±å¼€å§‹ç­‰å¾…æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥äº†ã€‚å¤§å®¶æ­¤åˆ»åœ¨æ¥å›çœ‹è¿™å‰¯å¯åŠ¨æµç¨‹å›¾ï¼Œæ˜¯ä¸æ˜¯æ¸…æ™°äº†å¾ˆå¤šå‘¢ï¼Ÿ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192151677.webp" alt="å›¾ç‰‡"></p> <p>æ­¤æ—¶ Netty çš„<code>Reactoræ¨¡å‹</code>ç»“æ„å¦‚ä¸‹ï¼š</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409192047090.webp" alt="å›¾ç‰‡"></p> <hr> <h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="header-anchor">#</a> æ€»ç»“</h2> <p>æœ¬æ–‡æˆ‘ä»¬é€šè¿‡å›¾è§£æºç çš„æ–¹å¼å®Œæ•´åœ°ä»‹ç»äº†æ•´ä¸ª Netty æœåŠ¡ç«¯å¯åŠ¨æµç¨‹ï¼Œå¹¶ä»‹ç»äº†åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­æ¶‰åŠåˆ°çš„<code>ServerBootstrap</code>ç›¸å…³çš„å±æ€§ä»¥åŠé…ç½®æ–¹å¼ã€‚<code>NioServerSocketChannel</code>çš„åˆ›å»ºåˆå§‹åŒ–è¿‡ç¨‹ä»¥åŠç±»çš„ç»§æ‰¿ç»“æ„ã€‚</p> <p>å…¶ä¸­é‡ç‚¹ä»‹ç»äº†<code>NioServerSocketChannel</code>å‘<code>Reactor</code>çš„æ³¨å†Œè¿‡ç¨‹ä»¥åŠ<code>Reactorçº¿ç¨‹</code>çš„å¯åŠ¨æ—¶æœºå’Œ<code>pipeline</code>çš„åˆå§‹åŒ–æ—¶æœºã€‚</p> <p>æœ€åä»‹ç»äº†<code>NioServerSocketChannel</code>ç»‘å®šç«¯å£åœ°å€çš„æ•´ä¸ªæµç¨‹ã€‚</p> <p>ä¸Šè¿°ä»‹ç»çš„è¿™äº›æµç¨‹å…¨éƒ¨æ˜¯å¼‚æ­¥æ“ä½œï¼Œå„ç§å›è°ƒç»•æ¥ç»•å»çš„ï¼Œéœ€è¦åå¤å›æƒ³ä¸‹ï¼Œè¯»å¼‚æ­¥ä»£ç å°±æ˜¯è¿™æ ·ï¼Œéœ€è¦ç†æ¸…å„ç§å›è°ƒä¹‹é—´çš„å…³ç³»ï¼Œ<strong>å¹¶ä¸”æ—¶åˆ»æé†’è‡ªå·±å½“å‰çš„æ‰§è¡Œçº¿ç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p> <p>å¥½äº†ï¼Œç°åœ¨ Netty æœåŠ¡ç«¯å·²ç»å¯åŠ¨èµ·æ¥ï¼Œæ¥ç€å°±è¯¥æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥äº†ï¼Œæˆ‘ä»¬ä¸‹ç¯‡æ–‡ç« è§~~~~</p> <h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="header-anchor">#</a> å‚è€ƒèµ„æ–™</h2> <p><a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484005&amp;idx=1&amp;sn=52f51269902a58f40d33208421109bc3&amp;chksm=ce77c422f9004d340e5b385ef6ba24dfba1f802076ace80ad6390e934173a10401e64e13eaeb&amp;scene=126&amp;sessionid=1726749878#rd" target="_blank" rel="noopener noreferrer">è¯¦ç»†å›¾è§£ Netty Reactor å¯åŠ¨å…¨æµç¨‹ | ä¸‡å­—é•¿æ–‡ | å¤šå›¾é¢„è­¦ (qq.com)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/echo-lxy/echo-system-design/edit/master/docs/Netty ç³»ç»Ÿè®¾è®¡/25.å››ã€æ·±å…¥ Netty æ ¸å¿ƒ/11.ç¬¬ä¸‰è¯¾ï¼šNetty Reactor å¯åŠ¨å…¨æµç¨‹.md" target="_blank" rel="noopener noreferrer">ç¼–è¾‘</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°äº:</span> <span class="time">2024/09/19, 18:48:08</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        â†
        <a href="/pages/440035/" class="prev">ç¬¬äºŒè¯¾ï¼šReactoråœ¨ Netty ä¸­çš„å®ç°ï¼ˆåˆ›å»ºç¯‡ï¼‰</a></span> <span class="next"><a href="/pages/bb668a/">ç¬¬ä¸‰è¯¾ï¼šNetty æ ¸å¿ƒå¼•æ“ Reactor çš„è¿è½¬æ¶æ„</a>â†’
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:lixinyang2002@163.com" title="å‘é‚®ä»¶" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/echo-lxy" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="å¬éŸ³ä¹" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="æœ¬ç«™ä¸»é¢˜">Vdoing</a> 
    | Copyright Â© 2024-2024
    <span>Xinyang Li | MIT License</span></div> <div class="buttons"><div title="è¿”å›é¡¶éƒ¨" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="å»è¯„è®º" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ä¸»é¢˜æ¨¡å¼" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          è·Ÿéšç³»ç»Ÿ
        </li><li class="iconfont icon-rijianmoshi">
          æµ…è‰²æ¨¡å¼
        </li><li class="iconfont icon-yejianmoshi">
          æ·±è‰²æ¨¡å¼
        </li><li class="iconfont icon-yuedu">
          é˜…è¯»æ¨¡å¼
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.78f2b9cc.js" defer></script><script src="/assets/js/2.933750c6.js" defer></script><script src="/assets/js/53.6f165300.js" defer></script><script src="/assets/js/7.7eb70372.js" defer></script>
  </body>
</html>
