<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>чммхЕншп╛я╝ЪNetty хжВф╜ХщлШцХИхПСщАБч╜Сч╗ЬцХ░цНо | EchoDesign</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="ч│╗ч╗Яшо╛шобф╣ЛуАМшо▓шзг + щЭвшпХцМЗхНЧуАНя╝Мц░┤ц╗┤чЯ│чй┐я╝Мшо╛шобцЧащУ╢х╝╣я╝Б">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.c76c3453.css" as="style"><link rel="preload" href="/assets/js/app.59640afe.js" as="script"><link rel="preload" href="/assets/js/2.933750c6.js" as="script"><link rel="preload" href="/assets/js/56.9df87e2e.js" as="script"><link rel="preload" href="/assets/js/7.7eb70372.js" as="script"><link rel="prefetch" href="/assets/js/10.2cc95be8.js"><link rel="prefetch" href="/assets/js/100.2b21dce5.js"><link rel="prefetch" href="/assets/js/101.96ca71f6.js"><link rel="prefetch" href="/assets/js/11.21625d3b.js"><link rel="prefetch" href="/assets/js/12.915fdd22.js"><link rel="prefetch" href="/assets/js/13.8ddd597e.js"><link rel="prefetch" href="/assets/js/14.1141ec27.js"><link rel="prefetch" href="/assets/js/15.d5a34c66.js"><link rel="prefetch" href="/assets/js/16.e52ba8b4.js"><link rel="prefetch" href="/assets/js/17.acb3bf3d.js"><link rel="prefetch" href="/assets/js/18.e491edb6.js"><link rel="prefetch" href="/assets/js/19.a22c1d8c.js"><link rel="prefetch" href="/assets/js/20.fe7d08c7.js"><link rel="prefetch" href="/assets/js/21.24c0f101.js"><link rel="prefetch" href="/assets/js/22.dd779f94.js"><link rel="prefetch" href="/assets/js/23.4d814163.js"><link rel="prefetch" href="/assets/js/24.891fe6fb.js"><link rel="prefetch" href="/assets/js/25.41dca26b.js"><link rel="prefetch" href="/assets/js/26.6337eac0.js"><link rel="prefetch" href="/assets/js/27.de80589e.js"><link rel="prefetch" href="/assets/js/28.6922a65b.js"><link rel="prefetch" href="/assets/js/29.7325b5ce.js"><link rel="prefetch" href="/assets/js/3.e62a71e4.js"><link rel="prefetch" href="/assets/js/30.e32f6b31.js"><link rel="prefetch" href="/assets/js/31.a532917f.js"><link rel="prefetch" href="/assets/js/32.13b70e91.js"><link rel="prefetch" href="/assets/js/33.d10d51bb.js"><link rel="prefetch" href="/assets/js/34.6671ead6.js"><link rel="prefetch" href="/assets/js/35.2760ed8d.js"><link rel="prefetch" href="/assets/js/36.5b9e5792.js"><link rel="prefetch" href="/assets/js/37.51145580.js"><link rel="prefetch" href="/assets/js/38.cddf1060.js"><link rel="prefetch" href="/assets/js/39.8a83e688.js"><link rel="prefetch" href="/assets/js/4.73518a0f.js"><link rel="prefetch" href="/assets/js/40.591baf2a.js"><link rel="prefetch" href="/assets/js/41.f961e422.js"><link rel="prefetch" href="/assets/js/42.b34f1599.js"><link rel="prefetch" href="/assets/js/43.5a509601.js"><link rel="prefetch" href="/assets/js/44.64fd3383.js"><link rel="prefetch" href="/assets/js/45.685623ac.js"><link rel="prefetch" href="/assets/js/46.7624d38c.js"><link rel="prefetch" href="/assets/js/47.5646b068.js"><link rel="prefetch" href="/assets/js/48.8de239a3.js"><link rel="prefetch" href="/assets/js/49.15d8e916.js"><link rel="prefetch" href="/assets/js/5.94727770.js"><link rel="prefetch" href="/assets/js/50.4fb0caa1.js"><link rel="prefetch" href="/assets/js/51.ef213b56.js"><link rel="prefetch" href="/assets/js/52.18c75eba.js"><link rel="prefetch" href="/assets/js/53.f76e624c.js"><link rel="prefetch" href="/assets/js/54.3098ec9f.js"><link rel="prefetch" href="/assets/js/55.0edcba5d.js"><link rel="prefetch" href="/assets/js/57.be37bfce.js"><link rel="prefetch" href="/assets/js/58.ca1aa081.js"><link rel="prefetch" href="/assets/js/59.7b7e3faf.js"><link rel="prefetch" href="/assets/js/6.0b558b79.js"><link rel="prefetch" href="/assets/js/60.96815912.js"><link rel="prefetch" href="/assets/js/61.f48524d4.js"><link rel="prefetch" href="/assets/js/62.82fff0c9.js"><link rel="prefetch" href="/assets/js/63.41ff19e4.js"><link rel="prefetch" href="/assets/js/64.9b3def35.js"><link rel="prefetch" href="/assets/js/65.0b2ab47d.js"><link rel="prefetch" href="/assets/js/66.2ae7a107.js"><link rel="prefetch" href="/assets/js/67.196ec80b.js"><link rel="prefetch" href="/assets/js/68.cab1ea3b.js"><link rel="prefetch" href="/assets/js/69.5f61d937.js"><link rel="prefetch" href="/assets/js/70.7279b1df.js"><link rel="prefetch" href="/assets/js/71.4f744076.js"><link rel="prefetch" href="/assets/js/72.44c999da.js"><link rel="prefetch" href="/assets/js/73.526febf1.js"><link rel="prefetch" href="/assets/js/74.26f8d9a5.js"><link rel="prefetch" href="/assets/js/75.7c86d41a.js"><link rel="prefetch" href="/assets/js/76.15d5bea9.js"><link rel="prefetch" href="/assets/js/77.7b3f6980.js"><link rel="prefetch" href="/assets/js/78.31a353ef.js"><link rel="prefetch" href="/assets/js/79.173bbc8c.js"><link rel="prefetch" href="/assets/js/8.7a3679f1.js"><link rel="prefetch" href="/assets/js/80.78a31e84.js"><link rel="prefetch" href="/assets/js/81.8d6c43d2.js"><link rel="prefetch" href="/assets/js/82.3b90a7cc.js"><link rel="prefetch" href="/assets/js/83.f3a9ee0c.js"><link rel="prefetch" href="/assets/js/84.eeb423e8.js"><link rel="prefetch" href="/assets/js/85.4cd3a775.js"><link rel="prefetch" href="/assets/js/86.931cbb70.js"><link rel="prefetch" href="/assets/js/87.47ba635a.js"><link rel="prefetch" href="/assets/js/88.93192130.js"><link rel="prefetch" href="/assets/js/89.b5690031.js"><link rel="prefetch" href="/assets/js/9.36f81190.js"><link rel="prefetch" href="/assets/js/90.cdc8eb8f.js"><link rel="prefetch" href="/assets/js/91.87a85466.js"><link rel="prefetch" href="/assets/js/92.6b777d4b.js"><link rel="prefetch" href="/assets/js/93.f8975bc4.js"><link rel="prefetch" href="/assets/js/94.1eade7f0.js"><link rel="prefetch" href="/assets/js/95.96f5db04.js"><link rel="prefetch" href="/assets/js/96.fc68b295.js"><link rel="prefetch" href="/assets/js/97.0a9a6187.js"><link rel="prefetch" href="/assets/js/98.10f4b27a.js"><link rel="prefetch" href="/assets/js/99.4a895015.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c76c3453.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="чЫох╜Х" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="EchoDesign" class="logo"> <span class="site-name can-hide">EchoDesign</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">ЁЯПащжЦщб╡</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">тЬТя╕ПчГнщЧичоЧц│Х</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕шо╛шоб" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕шо╛шоб</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ч│╗ч╗Яшо╛шоб</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">тЭУщЧочнФ</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ЁЯСАхКицАБ</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">ЁЯПащжЦщб╡</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">тЬТя╕ПчГнщЧичоЧц│Х</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕шо╛шоб" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕шо╛шоб</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ч│╗ч╗Яшо╛шоб</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">тЭУщЧочнФ</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ЁЯСАхКицАБ</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ф╕АуАБхЙНшиА</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ф║МуАБхЯ║чбАчЯешпЖ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ф╕ЙуАБф╕╗ч║┐ф╗╗хКб</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>хЫЫуАБц╖▒хЕе Netty ца╕х┐Г</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/65674f/" class="sidebar-link">чммф╕Ашп╛я╝ЪщАПш┐З Netty чЬЛ IO цибхЮЛ</a></li><li><a href="/pages/440035/" class="sidebar-link">чммф║Мшп╛я╝ЪReactorхЬи Netty ф╕нчЪДхоЮчО░я╝ИхИЫх╗║чпЗя╝Й</a></li><li><a href="/pages/bb668a/" class="sidebar-link">чммф╕Йшп╛я╝ЪNetty ца╕х┐Гх╝ХцУО Reactor чЪДш┐Рш╜мцЮ╢цЮД</a></li><li><a href="/pages/be98dc/" class="sidebar-link">чммхЫЫшп╛я╝ЪNetty хжВф╜ХщлШцХИцОецФ╢ч╜Сч╗Ьш┐ЮцОе</a></li><li><a href="/pages/d711b1/" class="sidebar-link">чммф║Фшп╛я╝ЪNetty хжВф╜ХщлШцХИцОецФ╢ч╜Сч╗ЬцХ░цНо</a></li><li><a href="/pages/a73206/" aria-current="page" class="active sidebar-link">чммхЕншп╛я╝ЪNetty хжВф╜ХщлШцХИхПСщАБч╜Сч╗ЬцХ░цНо</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/a73206/#хЙНшиА" class="sidebar-link">хЙНшиА</a></li><li class="sidebar-sub-header level2"><a href="/pages/a73206/#_1-channelhandlercontext" class="sidebar-link">1. ChannelHandlerContext</a></li><li class="sidebar-sub-header level2"><a href="/pages/a73206/#_2-write-ф║Лф╗╢чЪДф╝ацТн" class="sidebar-link">2. write ф║Лф╗╢чЪДф╝ацТн</a></li><li class="sidebar-sub-header level2"><a href="/pages/a73206/#_3-write-цЦ╣ц│ХхПСщАБцХ░цНо" class="sidebar-link">3. write цЦ╣ц│ХхПСщАБцХ░цНо</a></li><li class="sidebar-sub-header level2"><a href="/pages/a73206/#_3-2-headcontext" class="sidebar-link">3.2 HeadContext</a></li><li class="sidebar-sub-header level2"><a href="/pages/a73206/#_3-3-channeloutboundbuffer" class="sidebar-link">3.3 ChannelOutboundBuffer</a></li><li class="sidebar-sub-header level2"><a href="/pages/a73206/#_4-flush" class="sidebar-link">4. flush</a></li><li class="sidebar-sub-header level2"><a href="/pages/a73206/#_5-ч╗Иф║Ох╝АхзЛчЬЯцнгхЬ░хПСщАБцХ░цНоф║Ж" class="sidebar-link">5. ч╗Иф║Ох╝АхзЛчЬЯцнгхЬ░хПСщАБцХ░цНоф║Жя╝Б</a></li><li class="sidebar-sub-header level2"><a href="/pages/a73206/#_6-хдДчРЖsocketхПпхЖЩф╜Жх╖▓ч╗ПхЖЩц╗б16цмбш┐Шц▓бхЖЩхоМчЪДцГЕхЖ╡" class="sidebar-link">6. хдДчРЖSocketхПпхЖЩф╜Жх╖▓ч╗ПхЖЩц╗б16цмбш┐Шц▓бхЖЩхоМчЪДцГЕхЖ╡</a></li><li class="sidebar-sub-header level2"><a href="/pages/a73206/#_7-op-writeф║Лф╗╢чЪДхдДчРЖ" class="sidebar-link">7. OP_WRITEф║Лф╗╢чЪДхдДчРЖ</a></li><li class="sidebar-sub-header level2"><a href="/pages/a73206/#_8-writeandflush" class="sidebar-link">8. writeAndFlush</a></li><li class="sidebar-sub-header level2"><a href="/pages/a73206/#цА╗ч╗У" class="sidebar-link">цА╗ч╗У</a></li><li class="sidebar-sub-header level2"><a href="/pages/a73206/#хПВшАГш╡ДцЦЩ" class="sidebar-link">хПВшАГш╡ДцЦЩ</a></li></ul></li><li><a href="/pages/a1b0fe/" class="sidebar-link">чммф╕Гшп╛я╝ЪNetty ф╕нIOф║Лф╗╢чЪДшзжхПСцЧ╢цЬ║хТМф╝ацТнц╡БчиЛ</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ф║ФуАБц╖▒хЕе Netty хЖЕхнШчобчРЖ</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="щжЦщб╡" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>Netty ч│╗ч╗Яшо╛шоб</span></li><li data-v-06225672><span data-v-06225672>хЫЫуАБц╖▒хЕе Netty ца╕х┐Г</span></li></ul> <div class="info" data-v-06225672><div title="ф╜ЬшАЕ" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/brother-one" target="_blank" title="ф╜ЬшАЕ" class="beLink" data-v-06225672>echo</a></div> <div title="хИЫх╗║цЧ╢щЧ┤" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-09-19</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">чЫох╜Х</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">чммхЕншп╛я╝ЪNetty хжВф╜ХщлШцХИхПСщАБч╜Сч╗ЬцХ░цНо<!----></h1> <div class="page-slot page-slot-top">
    <div class="wwads-cn wwads-horizontal page-wwads" data-id="136"></div>
    <style>
      .page-wwads{
        width:100%!important;
        min-height: 0;
        margin: 0;
      }
      .page-wwads .wwads-img img{
        width:80px!important;
      }
      .page-wwads .wwads-poweredby{
        width: 40px;
        position: absolute;
        right: 25px;
        bottom: 3px;
      }
      .wwads-content .wwads-text, .page-wwads .wwads-text{
        height: 100%;
        padding-top: 5px;
        display: block;
      }
  </style>
  </div> <div class="theme-vdoing-content content__default"><h2 id="хЙНшиА"><a href="#хЙНшиА" class="header-anchor">#</a> хЙНшиА</h2> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191113813.png" alt="хЫ╛чЙЗ"></p> <p>хЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484244&amp;idx=1&amp;sn=831060fc38caa201d69f87305de7f86a&amp;chksm=ce77c513f9004c05b48f849ff99997d6d7252453135ae856a029137b88aa70b8e046013d596e&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">уАКNettyхжВф╜ХщлШцХИцОецФ╢ч╜Сч╗ЬцХ░цНоуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕АцЦЗф╕ня╝МцИСф╗мф╗Лч╗Нф║Ж Netty чЪД SubReactor хдДчРЖч╜Сч╗ЬцХ░цНошп╗хПЦчЪДхоМцХ┤ш┐ЗчиЛя╝Мх╜У Netty ф╕║цИСф╗мшп╗хПЦф║Жч╜Сч╗Ьшп╖ц▒ВцХ░цНоя╝Мх╣╢ф╕ФцИСф╗мхЬишЗкх╖▒чЪДф╕ЪхКбч║┐чиЛф╕нхоМцИРф║Жф╕ЪхКбхдДчРЖхРОя╝Мх░▒щЬАшжБх░Жф╕ЪхКбхдДчРЖч╗УцЮЬш┐ФхЫЮч╗ЩховцИ╖члпф║Жя╝МщВгф╣ИцЬмцЦЗцИСф╗мх░▒цЭеф╗Лч╗Нф╕Л SubReactor хжВф╜ХхдДчРЖч╜Сч╗ЬцХ░цНохПСщАБчЪДцХ┤ф╕кш┐ЗчиЛуАВ</p> <p>цИСф╗мщГ╜чЯещБУ Netty цШпф╕Ацм╛щлШцАзшГ╜чЪДх╝Вцнеф║Лф╗╢щй▒хКичЪДч╜Сч╗ЬщАЪшопцбЖцЮ╢я╝МцЧвчД╢цШпч╜Сч╗ЬщАЪшопцбЖцЮ╢щВгф╣ИхоГф╕╗шжБхБЪчЪДф║ЛцГЕх░▒цШпя╝Ъ</p> <ul><li>цОецФ╢ховцИ╖члпш┐ЮцОеуАВ</li> <li>шп╗хПЦш┐ЮцОеф╕КчЪДч╜Сч╗Ьшп╖ц▒ВцХ░цНоуАВ</li> <li>хРСш┐ЮцОехПСщАБч╜Сч╗ЬхУНх║ФцХ░цНоуАВ</li></ul> <p>хЙНш╛╣ч│╗хИЧцЦЗчлахЬиф╗Лч╗Н<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484005&amp;idx=1&amp;sn=52f51269902a58f40d33208421109bc3&amp;chksm=ce77c422f9004d340e5b385ef6ba24dfba1f802076ace80ad6390e934173a10401e64e13eaeb&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">NettyчЪДхРпхКи<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╗ехПК<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484184&amp;idx=1&amp;sn=726877ce28cf6e5d2ac3225fae687f19&amp;chksm=ce77c55ff9004c493b592288819dc4d4664b5949ee97fed977b6558bc517dad0e1f73fab0f46&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">цОецФ╢ш┐ЮцОе<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>чЪДш┐ЗчиЛф╕ня╝МцИСф╗мхПкчЬЛхИ░ OP_ACCEPT ф║Лф╗╢ф╗ехПК OP_READ ф║Лф╗╢чЪДц│ихЖМя╝Мх╣╢цЬкчЬЛхИ░ OP_WRITE ф║Лф╗╢чЪДц│ихЖМуАВ</p> <ul><li>щВгф╣ИхЬиф╗Аф╣ИцГЕхЖ╡ф╕Л Netty цЙНф╝ЪхРС SubReactor хО╗ц│ихЖМ OP_WRITE ф║Лф╗╢хСвя╝Я</li> <li>Netty хПИцШпцАОф╣Ихп╣хЖЩцУНф╜ЬхБЪхИ░х╝ВцнехдДчРЖчЪДхСвя╝Я</li></ul> <p>цЬмцЦЗчмФшАЕх░Жф╝Ъф╕║хдзхо╢ф╕Аф╕АцПнцЩУш┐Щф║Ыш░Ьх║ХуАВцИСф╗мш┐ШцШпф╗еф╣ЛхЙНчЪД EchoServer ф╕║ф╛Лш┐ЫшбМшп┤цШОуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Sharable</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//цндхдДчЪДmsgх░▒цШпNettyхЬиread loopф╕нф╗ОNioSocketChannelф╕ншп╗хПЦхИ░чЪДByteBuffer</span>
        ctx<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>цИСф╗мх░ЖхЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484244&amp;idx=1&amp;sn=831060fc38caa201d69f87305de7f86a&amp;chksm=ce77c513f9004c05b48f849ff99997d6d7252453135ae856a029137b88aa70b8e046013d596e&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">уАКNettyхжВф╜ХщлШцХИцОецФ╢ч╜Сч╗ЬцХ░цНоуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕АцЦЗф╕ншп╗хПЦхИ░чЪД ByteBuffer (ш┐ЩщЗМчЪД Object msg)я╝МчЫ┤цОехПСщАБхЫЮч╗ЩховцИ╖члпя╝МчФиш┐Щф╕кчоАхНХчЪДф╛ЛхнРцЭецПнх╝А Netty хжВф╜ХхПСщАБцХ░цНочЪДх║Пх╣Х~~</p> <blockquote><p>хЬихоЮщЩЕх╝АхПСф╕ня╝МцИСф╗мщжЦхЕИшжБщАЪш┐ЗшзгчаБхЩих░Жшп╗хПЦхИ░чЪД ByteBuffer шзгчаБш╜мцНвф╕║цИСф╗мчЪДф╕ЪхКб Request ч▒╗я╝МчД╢хРОхЬиф╕ЪхКбч║┐чиЛф╕нхБЪф╕ЪхКбхдДчРЖя╝МхЬищАЪш┐Зч╝ЦчаБхЩихп╣ф╕ЪхКб Response ч▒╗ч╝ЦчаБф╕║ ByteBuffer я╝МцЬАхРОхИйчФи ChannelHandlerContext ctx чЪДх╝ХчФихПСщАБхУНх║ФцХ░цНоуАВ</p></blockquote> <blockquote><p>цЬмцЦЗцИСф╗мхПкшБЪчДж Netty хЖЩцХ░цНочЪДш┐ЗчиЛя╝Мхп╣ф║О Netty ч╝ЦшзгчаБчЫ╕хЕ│чЪДхЖЕхо╣я╝МчмФшАЕф╝ЪхЬихРОч╗нчЪДцЦЗчлаф╕нф╕УщЧиф╗Лч╗НуАВ</p></blockquote> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191113734.png" alt="хЫ╛чЙЗ"></p> <h2 id="_1-channelhandlercontext"><a href="#_1-channelhandlercontext" class="header-anchor">#</a> 1. ChannelHandlerContext</h2> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191601888.webp" alt="хЫ╛чЙЗ"></p> <p>щАЪш┐ЗхЙНщЭвхЗачпЗцЦЗчлачЪДф╗Лч╗Ня╝МцИСф╗мчЯещБУ Netty ф╝Ъф╕║цпПф╕к Channel хИЖщЕНф╕Аф╕к pipeline я╝Мpipeline цШпф╕Аф╕кхПМхРСщУ╛шбичЪДч╗УцЮДуАВNetty ф╕нф║зчФЯчЪД IO х╝Вцнеф║Лф╗╢ф╝ЪхЬиш┐Щф╕к pipeline ф╕нф╝ацТнуАВ</p> <p>Netty ф╕нчЪД IO х╝Вцнеф║Лф╗╢хдзф╜Уф╕КхИЖф╕║ф╕дч▒╗я╝Ъ</p> <ul><li>inboundф║Лф╗╢я╝ЪхЕечлЩф║Лф╗╢я╝МцпФхжВхЙНш╛╣ф╗Лч╗НчЪД ChannelActive ф║Лф╗╢я╝М ChannelRead ф║Лф╗╢я╝МхоГф╗мф╝Ъф╗О pipeline чЪДхд┤ч╗УчВ╣ HeadContext х╝АхзЛф╕АчЫ┤хРСхРОф╝ацТн</li> <li>outboundф║Лф╗╢я╝ЪхЗ║члЩф║Лф╗╢я╝МцпФхжВцЬмцЦЗф╕нхН│х░ЖшжБф╗Лч╗НхИ░чЪД writeф║Лф╗╢ ф╗ехПК flush ф║Лф╗╢я╝МхЗ║члЩф║Лф╗╢ф╝Ъф╗ОчЫ╕хПНчЪДцЦ╣хРСф╗ОхРОх╛АхЙНф╝ацТнчЫ┤хИ░ HeadContext уАВцЬАч╗Иф╝ЪхЬи HeadContext ф╕нхоМцИРхЗ║члЩф║Лф╗╢чЪДхдДчРЖуАВ
<ul><li>цЬмф╛Лф╕нчФихИ░чЪД channelHandlerContext.write()  ф╝Ъф╜┐ write ф║Лф╗╢ф╗Ох╜УхЙН ChannelHandler ф╣Ях░▒цШпш┐ЩщЗМчЪД EchoServerHandler х╝АхзЛц▓┐чЭА pipeline хРСхЙНф╝ацТн</li> <li>шАМ channelHandlerContext.channel().write() хИЩф╝Ъф╜┐ write ф║Лф╗╢ф╗О pipeline чЪДх░╛ч╗УчВ╣ TailContext х╝АхзЛхРСхЙНф╝ацТнчЫ┤хИ░ HeadContext</li></ul></li></ul> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191603271.webp" alt="хЫ╛чЙЗ"></p> <p>шАМ pipeline ш┐Щца╖ф╕Аф╕кхПМхРСщУ╛шбицХ░цНоч╗УцЮДф╕нчЪДч▒╗хЮЛцнгцШп ChannelHandlerContext  я╝МчФ▒ ChannelHandlerContext хМЕшг╣цИСф╗мшЗкхоЪф╣ЙчЪД IO хдДчРЖщА╗ш╛С ChannelHandler</p> <blockquote><p>ChannelHandler х╣╢ф╕НщЬАшжБцДЯчЯехИ░хоГцЙАхдДчЪД pipeline ф╕нчЪДф╕Кф╕ЛцЦЗф┐бцБпя╝МхПкщЬАшжБф╕Ух┐ГхдДчРЖхе╜ IO щА╗ш╛СхН│хПпя╝МхЕ│ф║О pipeline чЪДф╕Кф╕ЛцЦЗф┐бцБпхЕищГих░БшгЕхЬи ChannelHandlerContextф╕нуАВ</p></blockquote> <p>ChannelHandler хЬи Netty ф╕нчЪДф╜ЬчФихПкцШпш┤Яш┤гхдДчРЖ IO щА╗ш╛Ся╝МцпФхжВч╝ЦчаБя╝МшзгчаБуАВхоГх╣╢ф╕Нф╝ЪцДЯчЯехИ░хоГхЬи pipeline ф╕нчЪДф╜Нч╜оя╝МцЫ┤ф╕Нф╝ЪцДЯчЯехТМхоГчЫ╕щВ╗чЪДф╕дф╕к ChannelHandlerуАВ<strong>ф║ЛхоЮф╕К ChannelHandlerф╣Ях╣╢ф╕НщЬАшжБхО╗хЕ│х┐Гш┐Щф║Ыя╝МхоГхФпф╕АщЬАшжБхЕ│ц│ичЪДх░▒цШпхдДчРЖцЙАхЕ│х┐ГчЪДх╝Вцнеф║Лф╗╢</strong></p> <p>шАМ ChannelHandlerContext ф╕нч╗┤цКдф║Ж pipeline ш┐Щф╕кхПМхРСщУ╛шбиф╕нчЪД pre ф╗ехПК next цМЗщТИя╝Мш┐Щца╖хПпф╗ецЦ╣ф╛┐чЪДцЙ╛хИ░ф╕ОхЕ╢чЫ╕щВ╗чЪД ChannelHandler я╝Мх╣╢хПпф╗еш┐Зц╗дхЗ║ф╕Аф║ЫчмжхРИцЙзшбМцЭбф╗╢чЪД ChannelHandlerуАВцнгхжВхоГчЪДхС╜хРНф╕Аца╖я╝М ChannelHandlerContext  цнгцШпш╡╖хИ░ф║Жч╗┤цКд ChannelHandler ф╕Кф╕ЛцЦЗчЪДф╕Аф╕кф╜ЬчФиуАВшАМ Netty ф╕нчЪДх╝Вцнеф║Лф╗╢хЬи pipeline ф╕нчЪДф╝ацТнщЭачЪДх░▒цШпш┐Щф╕к ChannelHandlerContext уАВ</p> <blockquote><p>ш┐Щца╖шо╛шобх░▒ф╜┐х╛Ч ChannelHandlerContext хТМ ChannelHandler чЪДшБМш┤гхНХф╕Ая╝МхРДхП╕хЕ╢шБМя╝МхЕ╖цЬЙщлШх║жчЪДхПпцЙйх▒ХцАзуАВ</p></blockquote> <h2 id="_2-write-ф║Лф╗╢чЪДф╝ацТн"><a href="#_2-write-ф║Лф╗╢чЪДф╝ацТн" class="header-anchor">#</a> 2. write ф║Лф╗╢чЪДф╝ацТн</h2> <p>цИСф╗мцЧашо║цШпхЬиф╕ЪхКбч║┐чиЛцИЦшАЕцШпхЬи SubReactor ч║┐чиЛф╕нхоМцИРф╕ЪхКбхдДчРЖхРОя╝МщГ╜щЬАшжБщАЪш┐З channelHandlerContext чЪДх╝ХчФих░Ж writeф║Лф╗╢хЬи pipeline ф╕нш┐ЫшбМф╝ацТнуАВчД╢хРОхЬи pipeline ф╕нчЫ╕х║ФчЪД ChannelHandler ф╕нчЫСхРм write ф║Лф╗╢ф╗ОшАМхПпф╗ехп╣ write ф║Лф╗╢ш┐ЫшбМшЗкхоЪф╣Йч╝ЦцОТхдДчРЖя╝ИцпФхжВцИСф╗мх╕╕чФичЪДч╝ЦчаБхЩия╝Йя╝МцЬАч╗Иф╝ацТнхИ░ HeadContext ф╕нцЙзшбМхПСщАБцХ░цНочЪДщА╗ш╛СцУНф╜ЬуАВ</p> <p>хЙНш╛╣ф╣ЯцПРхИ░ Netty ф╕нцЬЙф╕дф╕кшзжхПС write ф║Лф╗╢ф╝ацТнчЪДцЦ╣ц│Хя╝МхоГф╗мчЪДф╝ацТнхдДчРЖщА╗ш╛СщГ╜цШпф╕Аца╖чЪДя╝МхПкф╕Нш┐ЗхоГф╗мхЬи pipeline ф╕нчЪД<strong>ф╝ацТнш╡╖чВ╣</strong>цШпф╕НхРМчЪДуАВ</p> <ul><li>channelHandlerContext.write() цЦ╣ц│Хф╝Ъф╗Ох╜УхЙН ChannelHandler х╝АхзЛхЬи pipeline ф╕нхРСхЙНф╝ацТн write ф║Лф╗╢чЫ┤хИ░ HeadContextуАВ</li> <li>channelHandlerContext.channel().write() цЦ╣ц│ХхИЩф╝Ъф╗О pipeline чЪДх░╛ч╗УчВ╣ TailContext х╝АхзЛхЬи pipeline ф╕нхРСхЙНф╝ацТн write ф║Лф╗╢чЫ┤хИ░ HeadContext уАВ</li></ul> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191113159.png" alt="хЫ╛чЙЗ"></p> <p>хЬицИСф╗мц╕ЕцеЪф║Ж write ф║Лф╗╢чЪДцА╗ф╜Уф╝ацТнц╡БчиЛхРОя╝МцОеф╕ЛцЭех░▒цЭечЬЛчЬЛхЬи write ф║Лф╗╢ф╝ацТнчЪДш┐ЗчиЛф╕нNettyф╕║цИСф╗мф╜Ьф║Жф║Ыф╗Аф╣Ия╝Яш┐ЩщЗМцИСф╗мф╗е channelHandlerContext.write() цЦ╣ц│Хф╕║ф╛Лшп┤цШОуАВ</p> <h2 id="_3-write-цЦ╣ц│ХхПСщАБцХ░цНо"><a href="#_3-write-цЦ╣ц│ХхПСщАБцХ░цНо" class="header-anchor">#</a> 3. write цЦ╣ц│ХхПСщАБцХ░цНо</h2> <p>![хЫ╛чЙЗ](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)<img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191605531.webp" alt="хЫ╛чЙЗ"></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractChannelHandlerContext</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">,</span> <span class="token class-name">ResourceLeakHint</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token function">newPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>ш┐ЩщЗМцИСф╗мчЬЛхИ░ Netty чЪДхЖЩцУНф╜ЬцШпф╕Аф╕кх╝ВцнецУНф╜Ья╝Мх╜УцИСф╗мхЬиф╕ЪхКбч║┐чиЛф╕нш░ГчФи channelHandlerContext.write() хРОя╝МNetty ф╝Ъч╗ЩцИСф╗мш┐ФхЫЮф╕Аф╕к ChannelFutureя╝МцИСф╗мхПпф╗ехЬиш┐Щф╕к ChannelFutrue ф╕нц╖╗хКа ChannelFutureListener я╝Мш┐Щца╖х╜У Netty х░ЖцИСф╗мшжБхПСщАБчЪДцХ░цНохПСщАБхИ░х║Хх▒В Socket ф╕нцЧ╢я╝МNetty ф╝ЪщАЪш┐З ChannelFutureListener щАЪчЯецИСф╗мхЖЩхЕеч╗УцЮЬуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//цндхдДчЪДmsgх░▒цШпNettyхЬиread loopф╕нф╗ОNioSocketChannelф╕ншп╗хПЦхИ░чЪДByteBuffer</span>
    <span class="token class-name">ChannelFuture</span> future <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    future<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelFutureListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelFuture</span> future<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token class-name">Throwable</span> cause <span class="token operator">=</span> future<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cause <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                хдДчРЖх╝Вх╕╕цГЕхЖ╡
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    
                хЖЩхЕе<span class="token class-name">Socket</span>цИРхКЯхРОя╝М<span class="token class-name">Netty</span>ф╝ЪщАЪчЯехИ░ш┐ЩщЗМ
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>х╜Ух╝Вцнеф║Лф╗╢хЬи pipeline ф╝ацТнчЪДш┐ЗчиЛф╕нхПСчФЯх╝Вх╕╕цЧ╢я╝Мх╝Вцнеф║Лф╗╢х░▒ф╝ЪхБЬцнвхЬи pipeline ф╕нф╝ацТнуАВцЙАф╗ецИСф╗мхЬицЧех╕╕х╝АхПСф╕ня╝МщЬАшжБхп╣хЖЩцУНф╜Ьх╝Вх╕╕цГЕхЖ╡ш┐ЫшбМхдДчРЖуАВ</p> <ul><li>хЕ╢ф╕н inbound ч▒╗х╝Вцнеф║Лф╗╢хПСчФЯх╝Вх╕╕цЧ╢я╝М<strong>ф╝ЪшзжхПСexceptionCaughtф║Лф╗╢ф╝ацТн</strong>уАВexceptionCaught ф║Лф╗╢цЬмш║лф╣ЯцШпф╕АчзН inbound ф║Лф╗╢я╝Мф╝ацТнцЦ╣хРСф╝Ъф╗Ох╜УхЙНхПСчФЯх╝Вх╕╕чЪД ChannelHandler х╝АхзЛф╕АчЫ┤хРСхРОф╝ацТнчЫ┤хИ░ TailContextуАВ</li> <li>шАМ outbound ч▒╗х╝Вцнеф║Лф╗╢хПСчФЯх╝Вх╕╕цЧ╢я╝М<strong>хИЩф╕Нф╝ЪшзжхПСexceptionCaughtф║Лф╗╢ф╝ацТн</strong>уАВф╕АшИмхПкцШпщАЪчЯечЫ╕хЕ│ ChannelFutureуАВф╜ЖхжВцЮЬцШп flush ф║Лф╗╢хЬиф╝ацТнш┐ЗчиЛф╕нхПСчФЯх╝Вх╕╕я╝МхИЩф╝ЪшзжхПСх╜УхЙНхПСчФЯх╝Вх╕╕чЪД ChannelHandler ф╕н exceptionCaught ф║Лф╗╢хЫЮш░ГуАВ</li></ul> <p>цИСф╗мч╗зч╗нхЫЮх╜ТхИ░хЖЩцУНф╜ЬчЪДф╕╗ч║┐ф╕КцЭе~~~</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token keyword">boolean</span> flush<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token string">&quot;msg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХецгАцЯеpromiseчЪДцЬЙцХИцАз<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment">//flush = true шбичд║channelHandlerф╕нш░ГчФичЪДцШпwriteAndFlushцЦ╣ц│Хя╝Мш┐ЩщЗМщЬАшжБцЙ╛хИ░pipelineф╕ншжЖчЫЦwriteцИЦшАЕflushцЦ╣ц│ХчЪДchannelHandler</span>
        <span class="token comment">//flush = false шбичд║ш░ГчФичЪДцШпwriteцЦ╣ц│Хя╝МхПкщЬАшжБцЙ╛хИ░pipelineф╕ншжЖчЫЦwriteцЦ╣ц│ХчЪДchannelHandler</span>
        <span class="token keyword">final</span> <span class="token class-name">AbstractChannelHandlerContext</span> next <span class="token operator">=</span> <span class="token function">findContextOutbound</span><span class="token punctuation">(</span>flush <span class="token operator">?</span>
                                                                       <span class="token punctuation">(</span><span class="token constant">MASK_WRITE</span> <span class="token operator">|</span> <span class="token constant">MASK_FLUSH</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token constant">MASK_WRITE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//чФиф║ОцгАцЯехЖЕхнШц│ДщЬ▓</span>
    <span class="token keyword">final</span> <span class="token class-name">Object</span> m <span class="token operator">=</span> pipeline<span class="token punctuation">.</span><span class="token function">touch</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//шО╖хПЦpipelineф╕нф╕Лф╕Аф╕кшжБшвлцЙзшбМчЪДchannelHandlerчЪДexecutor</span>
    <span class="token class-name">EventExecutor</span> executor <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//чбоф┐ЭOutBoundф║Лф╗╢чФ▒ChannelHandlerцМЗхоЪчЪДexecutorцЙзшбМ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>executor<span class="token punctuation">.</span><span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//хжВцЮЬх╜УхЙНч║┐чиЛцнгцШпchannelHandlerцМЗхоЪчЪДexecutorхИЩчЫ┤цОецЙзшбМ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flush<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            next<span class="token punctuation">.</span><span class="token function">invokeWriteAndFlush</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            next<span class="token punctuation">.</span><span class="token function">invokeWrite</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//хжВцЮЬх╜УхЙНч║┐чиЛф╕НцШпChannelHandlerцМЗхоЪчЪДexecutor,хИЩх░БшгЕцИРх╝Вцнеф╗╗хКбцПРф║дч╗ЩцМЗхоЪexecutorцЙзшбМя╝Мц│ицДПш┐ЩщЗМчЪДexecutorф╕Нф╕АхоЪцШпreactorч║┐чиЛуАВ</span>
        <span class="token keyword">final</span> <span class="token class-name">WriteTask</span> task <span class="token operator">=</span> <span class="token class-name">WriteTask</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> m<span class="token punctuation">,</span> promise<span class="token punctuation">,</span> flush<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">safeExecute</span><span class="token punctuation">(</span>executor<span class="token punctuation">,</span> task<span class="token punctuation">,</span> promise<span class="token punctuation">,</span> m<span class="token punctuation">,</span> <span class="token operator">!</span>flush<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            task<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>write ф║Лф╗╢шжБхРСхЙНхЬи pipeline ф╕нф╝ацТня╝Мх░▒щЬАшжБхЬи pipeline ф╕КцЙ╛хИ░ф╕Лф╕Аф╕кхЕ╖цЬЙцЙзшбМш╡Дца╝чЪД ChannelHandlerя╝МхЫаф╕║ф╜Нф║Ох╜УхЙН ChannelHandler хЙНш╛╣чЪДхПпшГ╜цШп ChannelInboundHandler ч▒╗хЮЛчЪДф╣ЯхПпшГ╜цШп ChannelOutboundHandler ч▒╗хЮЛчЪД ChannelHandler я╝МцИЦшАЕцЬЙхПпшГ╜хОЛца╣х░▒ф╕НхЕ│х┐Г write ф║Лф╗╢чЪД ChannelHandlerя╝Иц▓бцЬЙхоЮчО░writeхЫЮш░ГцЦ╣ц│Хя╝ЙуАВ![хЫ╛чЙЗ](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)<img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191605556.webp" alt="хЫ╛чЙЗ"></p> <p>ш┐ЩщЗМцИСф╗мх░▒щЬАшжБщАЪш┐З findContextOutbound цЦ╣ц│ХхЬих╜УхЙН ChannelHandler чЪДхЙНш╛╣цЙ╛хИ░ ChannelOutboundHandler ч▒╗хЮЛх╣╢ф╕ФшжЖчЫЦхоЮчО░ write хЫЮш░ГцЦ╣ц│ХчЪД ChannelHandler ф╜Ьф╕║ф╕Лф╕Аф╕кшжБцЙзшбМчЪДхп╣ш▒буАВ</p> <h3 id="_3-1-findcontextoutbound"><a href="#_3-1-findcontextoutbound" class="header-anchor">#</a> 3.1 findContextOutbound</h3> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">AbstractChannelHandlerContext</span> <span class="token function">findContextOutbound</span><span class="token punctuation">(</span><span class="token keyword">int</span> mask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AbstractChannelHandlerContext</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">//шО╖хПЦх╜УхЙНChannelHandlerчЪДexecutor</span>
    <span class="token class-name">EventExecutor</span> currentExecutor <span class="token operator">=</span> <span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token comment">//шО╖хПЦхЙНф╕Аф╕кChannelHandler</span>
        ctx <span class="token operator">=</span> ctx<span class="token punctuation">.</span>prev<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">skipContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> currentExecutor<span class="token punctuation">,</span> mask<span class="token punctuation">,</span> <span class="token constant">MASK_ONLY_OUTBOUND</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ctx<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//хИдцЦнхЙНф╕Аф╕кChannelHandlerцШпхРжхЕ╖цЬЙхУНх║ФWriteф║Лф╗╢чЪДш╡Дца╝</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">skipContext</span><span class="token punctuation">(</span>
    <span class="token class-name">AbstractChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">EventExecutor</span> currentExecutor<span class="token punctuation">,</span> <span class="token keyword">int</span> mask<span class="token punctuation">,</span> <span class="token keyword">int</span> onlyMask<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>executionMask <span class="token operator">&amp;</span> <span class="token punctuation">(</span>onlyMask <span class="token operator">|</span> mask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> currentExecutor <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>executionMask <span class="token operator">&amp;</span> mask<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>findContextOutbound цЦ╣ц│ХцОецФ╢чЪДхПВцХ░цШпф╕Аф╕кцОйчаБя╝Мш┐Щф╕кцОйчаБшбичд║шжБхРСхЙНцЯецЙ╛хЕ╖цЬЙф╗Аф╣Ица╖цЙзшбМш╡Дца╝чЪД ChannelHandlerуАВхЫаф╕║цИСф╗мш┐ЩщЗМш░ГчФичЪДцШп ChannelHandlerContext чЪД write цЦ╣ц│ХцЙАф╗е flush = falseя╝Мф╝ащАТш┐ЫцЭечЪДцОйчаБф╕║ MASK_WRITEя╝Мшбичд║цИСф╗мшжБхРСхЙНцЯецЙ╛шжЖчЫЦхоЮчО░ф║Ж write хЫЮш░ГцЦ╣ц│ХчЪД ChannelOutboundHandlerуАВ</p> <h4 id="_3-1-1-цОйчаБчЪДх╖зхжЩх║ФчФи"><a href="#_3-1-1-цОйчаБчЪДх╖зхжЩх║ФчФи" class="header-anchor">#</a> 3.1.1 цОйчаБчЪДх╖зхжЩх║ФчФи</h4> <p>Netty ф╕нх░Ж ChannelHandler шжЖчЫЦхоЮчО░чЪДф╕Аф║Ых╝Вцнеф║Лф╗╢хЫЮш░ГцЦ╣ц│ХчФи int хЮЛчЪДцОйчаБцЭешбичд║я╝Мш┐Щца╖цИСф╗мх░▒хПпф╗ещАЪш┐Зш┐Щф╕кцОйчаБцЭехИдцЦнх╜УхЙН ChannelHandler хЕ╖цЬЙф╗Аф╣Ица╖чЪДцЙзшбМш╡Дца╝уАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ChannelHandlerMask</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_CHANNEL_ACTIVE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_CHANNEL_READ</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_CHANNEL_READ_COMPLETE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_WRITE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">15</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_FLUSH</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span>

   <span class="token comment">//outboundф║Лф╗╢цОйчаБщЫЖхРИ</span>
   <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_ONLY_OUTBOUND</span> <span class="token operator">=</span>  <span class="token constant">MASK_BIND</span> <span class="token operator">|</span> <span class="token constant">MASK_CONNECT</span> <span class="token operator">|</span> <span class="token constant">MASK_DISCONNECT</span> <span class="token operator">|</span>
            <span class="token constant">MASK_CLOSE</span> <span class="token operator">|</span> <span class="token constant">MASK_DEREGISTER</span> <span class="token operator">|</span> <span class="token constant">MASK_READ</span> <span class="token operator">|</span> <span class="token constant">MASK_WRITE</span> <span class="token operator">|</span> <span class="token constant">MASK_FLUSH</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хЬи ChannelHandler швлц╖╗хКаш┐Ы pipeline чЪДцЧ╢хАЩя╝МNetty ф╝Ъца╣цНох╜УхЙН ChannelHandler чЪДч▒╗хЮЛф╗ехПКхЕ╢шжЖчЫЦхоЮчО░чЪДх╝Вцнеф║Лф╗╢хЫЮш░ГцЦ╣ц│Хя╝МщАЪш┐З <code>| ш┐РчоЧ</code> хРС ChannelHandlerContext#executionMask хнЧцо╡ц╖╗хКашпе ChannelHandler чЪДцЙзшбМш╡Дца╝уАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractChannelHandlerContext</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">,</span> <span class="token class-name">ResourceLeakHint</span> <span class="token punctuation">{</span>

    <span class="token comment">//ChannelHandlerцЙзшбМш╡Дца╝цОйчаБ</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> executionMask<span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ч▒╗ф╝╝чЪДцОйчаБчФиц│ХхЕ╢хоЮцИСф╗мхЬихЙНш╛╣чЪДцЦЗчла<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484087&amp;idx=1&amp;sn=0c065780e0f05c23c8e6465ede86cba0&amp;chksm=ce77c4f0f9004de63be369a664105708bc5975b52993f4a6df223caed34cc1ef6185a16acd75&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКф╕АцЦЗшБКщАПNettyца╕х┐Гх╝ХцУОReactorчЪДш┐Рш╜мцЮ╢цЮДуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕нф╣ЯцПРхИ░ш┐Зя╝МхЬи Channel хРСхп╣х║ФчЪД Reactor ц│ихЖМшЗкх╖▒цДЯхЕ┤ш╢гчЪД IO ф║Лф╗╢цЧ╢я╝Мф╣ЯцШпчФихИ░ф║Жф╕Аф╕к int хЮЛчЪДцОйчаБ interestOps цЭешбичд║ Channel цДЯхЕ┤ш╢гчЪД IO ф║Лф╗╢щЫЖхРИуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doBeginRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

    <span class="token keyword">final</span> <span class="token class-name">SelectionKey</span> selectionKey <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>selectionKey<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>selectionKey<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    readPending <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token keyword">int</span> interestOps <span class="token operator">=</span> selectionKey<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 1я╝ЪServerSocketChannel хИЭхзЛхМЦцЧ╢ readInterestOpшо╛ч╜очЪДцШпOP_ACCEPTф║Лф╗╢
     * 2я╝ЪSocketChannel хИЭхзЛхМЦцЧ╢ readInterestOpшо╛ч╜очЪДцШпOP_READф║Лф╗╢
     * */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>interestOps <span class="token operator">&amp;</span> readInterestOp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//ц│ихЖМчЫСхРмOP_ACCEPTцИЦшАЕOP_READф║Лф╗╢</span>
        selectionKey<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span>interestOps <span class="token operator">|</span> readInterestOp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>чФи &amp; цУНф╜ЬхИдцЦня╝МцЯРф╕кф║Лф╗╢цШпхРжхЬиф║Лф╗╢щЫЖхРИф╕ня╝Ъ<code>(readyOps &amp; SelectionKey.OP_CONNECT) != 0</code></li> <li>чФи | цУНф╜ЬхРСф║Лф╗╢щЫЖхРИф╕нц╖╗хКаф║Лф╗╢я╝Ъ<code>interestOps | readInterestOp</code></li> <li>ф╗Оф║Лф╗╢щЫЖхРИф╕нхИащЩдцЯРф╕кф║Лф╗╢я╝МцШпщАЪш┐ЗхЕИх░ЖшжБхИащЩдф║Лф╗╢хПЦхПН ~ я╝МчД╢хРОхЬихТМф║Лф╗╢щЫЖхРИхБЪ &amp; цУНф╜Ья╝Ъ<code>ops &amp;= ~SelectionKey.OP_CONNECT</code></li></ul> <blockquote><p>ш┐ЩщГихИЖхЖЕхо╣чмФшАЕф╝ЪхЬиф╕ЛчпЗцЦЗчлахЕищЭвф╗Лч╗Н pipeline чЪДцЧ╢хАЩшпжч╗Жшо▓шзгя╝Мхдзхо╢ш┐ЩщЗМхПкщЬАшжБчЯещБУш┐ЩщЗМчЪДцОйчаБх░▒цШпшбичд║ф╕Аф╕кцЙзшбМш╡Дца╝чЪДщЫЖхРИуАВх╜УхЙН ChannelHandler чЪДцЙзшбМш╡Дца╝хнШцФ╛хЬихоГчЪД ChannelHandlerContext ф╕нчЪД executionMask хнЧцо╡ф╕нуАВ</p></blockquote> <h4 id="_3-1-2-хРСхЙНцЯецЙ╛хЕ╖цЬЙцЙзшбМш╡Дца╝чЪД-channeloutboundhandler"><a href="#_3-1-2-хРСхЙНцЯецЙ╛хЕ╖цЬЙцЙзшбМш╡Дца╝чЪД-channeloutboundhandler" class="header-anchor">#</a> 3.1.2 хРСхЙНцЯецЙ╛хЕ╖цЬЙцЙзшбМш╡Дца╝чЪД ChannelOutboundHandler</h4> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">AbstractChannelHandlerContext</span> <span class="token function">findContextOutbound</span><span class="token punctuation">(</span><span class="token keyword">int</span> mask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//х╜УхЙНChannelHandler</span>
    <span class="token class-name">AbstractChannelHandlerContext</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">//шО╖хПЦх╜УхЙНChannelHandlerчЪДexecutor</span>
    <span class="token class-name">EventExecutor</span> currentExecutor <span class="token operator">=</span> <span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token comment">//шО╖хПЦхЙНф╕Аф╕кChannelHandler</span>
        ctx <span class="token operator">=</span> ctx<span class="token punctuation">.</span>prev<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">skipContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> currentExecutor<span class="token punctuation">,</span> mask<span class="token punctuation">,</span> <span class="token constant">MASK_ONLY_OUTBOUND</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ctx<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//хИдцЦнхЙНф╕Аф╕кChannelHandlerцШпхРжхЕ╖цЬЙхУНх║ФWriteф║Лф╗╢чЪДш╡Дца╝</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">skipContext</span><span class="token punctuation">(</span>
    <span class="token class-name">AbstractChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">EventExecutor</span> currentExecutor<span class="token punctuation">,</span> <span class="token keyword">int</span> mask<span class="token punctuation">,</span> <span class="token keyword">int</span> onlyMask<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>executionMask <span class="token operator">&amp;</span> <span class="token punctuation">(</span>onlyMask <span class="token operator">|</span> mask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> currentExecutor <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>executionMask <span class="token operator">&amp;</span> mask<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хЙНш╛╣цИСф╗мцПРхИ░ ChannelHandlerContext ф╕Нф╗Ех░БшгЕф║Ж ChannelHandler чЪДцЙзшбМш╡Дца╝цОйчаБш┐ШхПпф╗ецДЯчЯехИ░х╜УхЙН ChannelHandler хЬи pipeline ф╕нчЪДф╜Нч╜оя╝МхЫаф╕║ ChannelHandlerContext ф╕нч╗┤цКдф║ЖхЙНщй▒цМЗщТИ prev ф╗ехПКхРОщй▒цМЗщТИ nextуАВ</p> <p>ш┐ЩщЗМцИСф╗мщЬАшжБхЬи pipeline ф╕нф╝ацТн write ф║Лф╗╢я╝МхоГцШпф╕АчзН outbound ф║Лф╗╢я╝МцЙАф╗ещЬАшжБхРСхЙНф╝ацТня╝Мш┐ЩщЗМщАЪш┐З ChannelHandlerContext чЪДхЙНщй▒цМЗщТИ prev цЛ┐хИ░х╜УхЙН ChannelHandler хЬи pipeline ф╕нчЪДхЙНф╕Аф╕кшКВчВ╣уАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code>ctx <span class="token operator">=</span> ctx<span class="token punctuation">.</span>prev<span class="token punctuation">;</span>
</code></pre></div><p>щАЪш┐З skipContext цЦ╣ц│ХхИдцЦнхЙНщй▒шКВчВ╣цШпхРжхЕ╖цЬЙцЙзшбМчЪДш╡Дца╝уАВхжВцЮЬц▓бцЬЙцЙзшбМш╡Дца╝хИЩш╖│ш┐Зч╗зч╗нхРСхЙНцЯецЙ╛уАВхжВцЮЬхЕ╖цЬЙцЙзшбМш╡Дца╝хИЩш┐ФхЫЮх╣╢хУНх║Ф write ф║Лф╗╢уАВ</p> <p>хЬи write ф║Лф╗╢ф╝ацТнхЬ║цЩпф╕ня╝МцЙзшбМш╡Дца╝цМЗчЪДцШпхЙНщй▒ ChannelHandler цШпхРжцШпChannelOutboundHandler ч▒╗хЮЛчЪДя╝Мх╣╢ф╕ФхоГцШпхРжшжЖчЫЦхоЮчО░ф║Ж write ф║Лф╗╢хЫЮш░ГцЦ╣ц│ХуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoChannelHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelOutboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_3-1-3-skipcontext"><a href="#_3-1-3-skipcontext" class="header-anchor">#</a> 3.1.3 skipContext</h4> <p>шпецЦ╣ц│Хф╕╗шжБчФицЭехИдцЦнх╜УхЙН ChannelHandler чЪДхЙНщй▒шКВчВ╣цШпхРжхЕ╖цЬЙ mask цОйчаБф╕нхМЕхРлчЪДф║Лф╗╢хУНх║Фш╡Дца╝уАВ</p> <p>цЦ╣ц│ХхПВцХ░ф╕нцЬЙф╕дф╕кцпФш╛ГщЗНшжБчЪДцОйчаБя╝Ъ</p> <ul><li><code>int onlyMask</code>я╝ЪчФицЭецМЗхоЪх╜УхЙН ChannelHandler щЬАшжБчмжхРИчЪДч▒╗хЮЛуАВхЕ╢ф╕нMASK_ONLY_OUTBOUND ф╕║ ChannelOutboundHandler ч▒╗хЮЛчЪДцОйчаБя╝М MASK_ONLY_INBOUND ф╕║ ChannelInboundHandler ч▒╗хЮЛчЪДцОйчаБуАВ</li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ChannelHandlerMask</span> <span class="token punctuation">{</span>

    <span class="token comment">//outboundф║Лф╗╢чЪДцОйчаБщЫЖхРИ</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_ONLY_OUTBOUND</span> <span class="token operator">=</span>  <span class="token constant">MASK_BIND</span> <span class="token operator">|</span> <span class="token constant">MASK_CONNECT</span> <span class="token operator">|</span> <span class="token constant">MASK_DISCONNECT</span> <span class="token operator">|</span>
            <span class="token constant">MASK_CLOSE</span> <span class="token operator">|</span> <span class="token constant">MASK_DEREGISTER</span> <span class="token operator">|</span> <span class="token constant">MASK_READ</span> <span class="token operator">|</span> <span class="token constant">MASK_WRITE</span> <span class="token operator">|</span> <span class="token constant">MASK_FLUSH</span><span class="token punctuation">;</span>

    <span class="token comment">//inboundф║Лф╗╢чЪДцОйчаБщЫЖхРИ</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MASK_ONLY_INBOUND</span> <span class="token operator">=</span>  <span class="token constant">MASK_CHANNEL_REGISTERED</span> <span class="token operator">|</span>
            <span class="token constant">MASK_CHANNEL_UNREGISTERED</span> <span class="token operator">|</span> <span class="token constant">MASK_CHANNEL_ACTIVE</span> <span class="token operator">|</span> <span class="token constant">MASK_CHANNEL_INACTIVE</span> <span class="token operator">|</span> <span class="token constant">MASK_CHANNEL_READ</span> <span class="token operator">|</span>
            <span class="token constant">MASK_CHANNEL_READ_COMPLETE</span> <span class="token operator">|</span> <span class="token constant">MASK_USER_EVENT_TRIGGERED</span> <span class="token operator">|</span> <span class="token constant">MASK_CHANNEL_WRITABILITY_CHANGED</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цпФхжВцЬмх░ПшКВф╕нцИСф╗мцШпхЬиф╗Лч╗Н write ф║Лф╗╢чЪДф╝ацТня╝МщВгф╣Их░▒щЬАшжБхЬих╜УхЙНChannelHandler хЙНш╛╣щжЦхЕИцШпцЙ╛хИ░ф╕Аф╕к ChannelOutboundHandler ч▒╗хЮЛчЪДChannelHandlerуАВ</p> <p><code>ctx.executionMask &amp; (onlyMask | mask)) == 0</code> чФиф║ОхИдцЦнхЙНф╕Аф╕к ChannelHandler цШпхРжф╕║цИСф╗мцМЗхоЪчЪД ChannelHandler ч▒╗хЮЛя╝МхЬицЬмх░ПшКВф╕нцИСф╗мцМЗхоЪчЪДцШп <code>onluMask = MASK_ONLY_OUTBOUND</code> хН│ ChannelOutboundHandler ч▒╗хЮЛуАВхжВцЮЬф╕НцШпя╝Мш┐ЩщЗМх░▒ф╝ЪчЫ┤цОеш╖│ш┐Зя╝Мч╗зч╗нхЬи pipeline ф╕нхРСхЙНцЯецЙ╛уАВ</p> <ul><li><code>int mask</code>я╝ЪчФиф║ОцМЗхоЪхЙНф╕Аф╕к ChannelHandler щЬАшжБхоЮчО░чЪДчЫ╕хЕ│х╝Вцнеф║Лф╗╢хдДчРЖхЫЮш░ГуАВхЬицЬмх░ПшКВф╕нш┐ЩщЗМцМЗхоЪчЪДцШп MASK_WRITE я╝МхН│щЬАшжБхоЮчО░ write хЫЮш░ГцЦ╣ц│ХуАВщАЪш┐З <code>(ctx.executionMask &amp; mask) == 0</code> цЭбф╗╢цЭехИдцЦнхЙНф╕Аф╕кChannelHandler цШпхРжхоЮчО░ф║Ж write хЫЮш░Гя╝МхжВцЮЬц▓бцЬЙхоЮчО░ш┐ЩщЗМх░▒ш╖│ш┐Зя╝Мч╗зч╗нхЬи pipeline ф╕нхРСхЙНцЯецЙ╛уАВ</li></ul> <blockquote><p>хЕ│ф║О skipContext цЦ╣ц│ХчЪДшпжч╗Жф╗Лч╗Ня╝МчмФшАЕш┐Шф╝ЪхЬиф╕ЛчпЗцЦЗчлахЕищЭвф╗Лч╗Н pipelineчЪДцЧ╢хАЩхЖНцмбш┐ЫшбМф╗Лч╗Ня╝Мш┐ЩщЗМхдзхо╢хПкщЬАшжБцШОчЩ╜шпецЦ╣ц│ХчЪДца╕х┐ГщА╗ш╛СхН│хПпуАВ</p></blockquote> <h4 id="_3-1-4-хРСхЙНф╝ацТнwriteф║Лф╗╢"><a href="#_3-1-4-хРСхЙНф╝ацТнwriteф║Лф╗╢" class="header-anchor">#</a> 3.1.4 хРСхЙНф╝ацТнwriteф║Лф╗╢</h4> <p>щАЪш┐З findContextOutbound цЦ╣ц│ХцИСф╗мхЬи pipeline ф╕нцЙ╛хИ░ф║Жф╕Лф╕Аф╕кхЕ╖цЬЙцЙзшбМш╡Дца╝чЪД ChannelHandlerя╝Мш┐ЩщЗМцМЗчЪДцШпф╕Лф╕Аф╕к ChannelOutboundHandler ч▒╗хЮЛх╣╢ф╕ФшжЖчЫЦхоЮчО░ф║Ж write цЦ╣ц│ХчЪД ChannelHandlerуАВ</p> <p>Netty ч┤зцОечЭАф╝Ъш░ГчФиш┐Щф╕к nextChannelHandler чЪД write цЦ╣ц│ХхоЮчО░ write ф║Лф╗╢хЬи pipeline ф╕нчЪДф╝ацТнуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">//шО╖хПЦф╕Лф╕Аф╕кшжБшвлцЙзшбМчЪДchannelHandlerцМЗхоЪчЪДexecutor</span>
<span class="token class-name">EventExecutor</span> executor <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//чбоф┐Эoutboundф║Лф╗╢чЪДцЙзшбМ цШпчФ▒ channelHandlerцМЗхоЪчЪДexecutorцЙзшбМчЪД</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>executor<span class="token punctuation">.</span><span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//хжВцЮЬх╜УхЙНч║┐чиЛцШпцМЗхоЪчЪДexecutor хИЩчЫ┤цОецУНф╜Ь</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flush<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        next<span class="token punctuation">.</span><span class="token function">invokeWriteAndFlush</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        next<span class="token punctuation">.</span><span class="token function">invokeWrite</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//хжВцЮЬх╜УхЙНч║┐чиЛф╕НцШпchannelHandlerцМЗхоЪчЪДexecutorя╝МхИЩх░БшгЕчиЛх╝Вцнеф╗╗хКб цПРф║дч╗ЩцМЗхоЪчЪДexecutorцЙзшбМ</span>
    <span class="token keyword">final</span> <span class="token class-name">WriteTask</span> task <span class="token operator">=</span> <span class="token class-name">WriteTask</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> m<span class="token punctuation">,</span> promise<span class="token punctuation">,</span> flush<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">safeExecute</span><span class="token punctuation">(</span>executor<span class="token punctuation">,</span> task<span class="token punctuation">,</span> promise<span class="token punctuation">,</span> m<span class="token punctuation">,</span> <span class="token operator">!</span>flush<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        task<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хЬицИСф╗мхРС pipeline ц╖╗хКа ChannelHandler чЪДцЧ╢хАЩхПпф╗ещАЪш┐З<code>ChannelPipeline#addLast(EventExecutorGroup,ChannelHandler......)</code> цЦ╣ц│ХцМЗхоЪцЙзшбМшпе ChannelHandler чЪДexecutorуАВхжВцЮЬф╕НчЙ╣цоКцМЗхоЪя╝МщВгф╣ИцЙзшбМшпе ChannelHandler чЪДexecutorщ╗Шшодф╕║шпе Channel ч╗СхоЪчЪД Reactor ч║┐чиЛуАВ</p> <blockquote><p>цЙзшбМ ChannelHandler ф╕нх╝Вцнеф║Лф╗╢хЫЮш░ГцЦ╣ц│ХчЪДч║┐чиЛх┐Ещб╗цШп ChannelHandler цМЗхоЪчЪДexecutorуАВ</p></blockquote> <p>цЙАф╗еш┐ЩщЗМщжЦхЕИцИСф╗мщЬАшжБшО╖хПЦхЬи findContextOutbound цЦ╣ц│ХцЯецЙ╛хЗ║цЭечЪДф╕Лф╕Аф╕кчмжхРИцЙзшбМцЭбф╗╢чЪД ChannelHandler цМЗхоЪчЪДexecutorуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">EventExecutor</span> executor <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>х╣╢щАЪш┐З <code>executor.inEventLoop()</code> цЦ╣ц│ХхИдцЦнх╜УхЙНч║┐чиЛцШпхРжцШпшпе ChannelHandler цМЗхоЪчЪД executorуАВ</p> <p>хжВцЮЬцШпя╝МщВгф╣ИцИСф╗мчЫ┤цОехЬих╜УхЙНч║┐чиЛф╕нцЙзшбМ ChannelHandler ф╕нчЪД write цЦ╣ц│ХуАВ</p> <p>хжВцЮЬф╕НцШпя╝МцИСф╗мх░▒щЬАшжБх░Ж ChannelHandler хп╣ write ф║Лф╗╢чЪДхЫЮш░ГцУНф╜Ьх░БшгЕцИРх╝Вцнеф╗╗хКб WriteTask х╣╢цПРф║дч╗Щ ChannelHandler цМЗхоЪчЪД executor ф╕ня╝МчФ▒ executor ш┤Яш┤гцЙзшбМуАВ</p> <blockquote><p>ш┐ЩщЗМщЬАшжБц│ицДПчЪДцШпш┐Щф╕к executor х╣╢ф╕Нф╕АхоЪцШп channel ч╗СхоЪчЪД reactor ч║┐чиЛуАВхоГхПпф╗ецШпцИСф╗мшЗкхоЪф╣ЙчЪДч║┐чиЛц▒ая╝Мф╕Нш┐ЗщЬАшжБцИСф╗мщАЪш┐З ChannelPipeline#addLast цЦ╣ц│Хш┐ЫшбМцМЗхоЪя╝МхжВцЮЬцИСф╗мф╕НцМЗхоЪя╝Мщ╗ШшодцГЕхЖ╡ф╕ЛцЙзшбМ ChannelHandler чЪД executor цЙНцШп channel ч╗СхоЪчЪД reactor ч║┐чиЛуАВ</p></blockquote> <blockquote><p>ш┐ЩщЗМNettyщЬАшжБчбоф┐Э outbound ф║Лф╗╢цШпчФ▒ channelHandler цМЗхоЪчЪД executor цЙзшбМчЪДуАВ</p></blockquote> <p><strong>ш┐ЩщЗМцЬЙф║ЫхРМхнжхПпшГ╜ф╝ЪцЬЙчЦСщЧоя╝МхжВцЮЬцИСф╗мхРСpipielineц╖╗хКаChannelHandlerчЪДцЧ╢хАЩя╝Мф╕║цпПф╕кChannelHandlerцМЗхоЪф╕НхРМчЪДexecutorцЧ╢я╝МNettyхжВцЮЬчбоф┐Эч║┐чиЛхоЙхЕихСв</strong>я╝Яя╝Я</p> <p>хдзхо╢ш┐Шшо░х╛Чpipelineф╕нчЪДч╗УцЮДхРЧя╝Я</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191113159.png" alt="хЫ╛чЙЗ">ховцИ╖члпchannel pipelineч╗УцЮД.png</p> <p>outbound ф║Лф╗╢хЬи pipeline ф╕нчЪДф╝ацТнцЬАч╗Иф╝Ъф╝ацТнхИ░ HeadContext ф╕ня╝Мф╣ЛхЙНчЪДч│╗хИЧцЦЗчлацИСф╗мцПРхИ░ш┐Зя╝МHeadContext ф╕нх░БшгЕф║Ж Channel чЪД Unsafe ч▒╗ш┤Яш┤г Channel х║Хх▒ВчЪД IO цУНф╜ЬуАВшАМ HeadContext цМЗхоЪчЪД executor цнгцШпхп╣х║Ф channel ч╗СхоЪчЪД reactor ч║┐чиЛуАВ</p> <p>![хЫ╛чЙЗ](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>цЙАф╗ецЬАч╗ИхЬи netty хЖЕца╕ф╕нцЙзшбМхЖЩцУНф╜ЬчЪДч║┐чиЛф╕АхоЪцШп reactor ч║┐чиЛф╗ОшАМф┐ЭшпБф║Жч║┐чиЛхоЙхЕицАзуАВ</p> <blockquote><p>х┐Шшо░ш┐Щцо╡хЖЕхо╣чЪДхРМхнжхПпф╗ехЬихЫЮщб╛ф╕Л<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247483907&amp;idx=1&amp;sn=084c470a8fe6234c2c9461b5f713ff30&amp;chksm=ce77c444f9004d52e7c6244bee83479070effb0bc59236df071f4d62e91e25f01715fca53696&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКReactorхЬиNettyф╕нчЪДхоЮчО░(хИЫх╗║чпЗ)уАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>я╝Мч▒╗ф╝╝чЪДхеЧш╖пцИСф╗мхЬиф╗Лч╗Н NioServerSocketChannel ш┐ЫшбМ bind ч╗СхоЪф╗ехПК register ц│ихЖМчЪДцЧ╢хАЩщГ╜ф╗Лч╗Нш┐Зя╝МхПкф╕Нш┐Зш┐ЩщЗМх░Ж executor цЙйх▒ХхИ░ф║ЖшЗкхоЪф╣Йч║┐чиЛц▒ачЪДшМГхЫ┤уАВ</p></blockquote> <h3 id="_3-1-5-шзжхПСnextchannelhandlerчЪДwriteцЦ╣ц│ХхЫЮш░Г"><a href="#_3-1-5-шзжхПСnextchannelhandlerчЪДwriteцЦ╣ц│ХхЫЮш░Г" class="header-anchor">#</a> 3.1.5 шзжхПСnextChannelHandlerчЪДwriteцЦ╣ц│ХхЫЮш░Г</h3> <p>![хЫ╛чЙЗ](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)writeф║Лф╗╢чЪДф╝ацТн1.png</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">//хжВцЮЬх╜УхЙНч║┐чиЛцШпцМЗхоЪчЪДexecutor хИЩчЫ┤цОецУНф╜Ь</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>flush<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    next<span class="token punctuation">.</span><span class="token function">invokeWriteAndFlush</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    next<span class="token punctuation">.</span><span class="token function">invokeWrite</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>чФ▒ф║ОцИСф╗мхЬичд║ф╛Л ChannelHandler ф╕нш░ГчФичЪДцШп ChannelHandlerContext#write цЦ╣ц│Хя╝МцЙАф╗еш┐ЩщЗМчЪД flush = false уАВшзжхПСш░ГчФи nextChannelHandler чЪД write цЦ╣ц│ХуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">invokeWrite</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">invokeHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">invokeWrite0</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// х╜УхЙНchannelHandlerшЩ╜чД╢ц╖╗хКахИ░pipelineф╕ня╝Мф╜ЖцШпх╣╢ц▓бцЬЙш░ГчФиhandlerAdded</span>
        <span class="token comment">// цЙАф╗еф╕НшГ╜ш░ГчФих╜УхЙНchannelHandlerф╕нчЪДхЫЮш░ГцЦ╣ц│Хя╝МхПкшГ╜ч╗зч╗нхРСхЙНф╝ащАТwriteф║Лф╗╢</span>
        <span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ш┐ЩщЗМщжЦхЕИщЬАшжБщАЪш┐З invokeHandler() цЦ╣ц│ХхИдцЦнш┐Щф╕к nextChannelHandler ф╕нчЪД handlerAdded цЦ╣ц│ХцШпхРжшвлхЫЮш░Гш┐ЗуАВхЫаф╕║ ChannelHandler хПкцЬЙшвлцнгчбочЪДц╖╗хКахИ░хп╣х║ФчЪД ChannelHandlerContext ф╕нх╣╢ф╕ФхЗЖхдЗхе╜хдДчРЖх╝Вцнеф║Лф╗╢цЧ╢я╝М ChannelHandler#handlerAdded цЦ╣ц│ХцЙНф╝ЪшвлхЫЮш░ГуАВ</p> <blockquote><p>ш┐Щф╕АщГихИЖхЖЕхо╣чмФшАЕф╝ЪхЬиф╕Лф╕АчпЗцЦЗчлаф╕ншпжч╗Жф╕║хдзхо╢ф╗Лч╗Ня╝Мш┐ЩщЗМхдзхо╢хПкщЬАшжБф║Жшзгш░ГчФи invokeHandler() цЦ╣ц│ХчЪДчЫочЪДх░▒цШпф╕║ф║ЖчбохоЪ ChannelHandler цШпхРжшвлцнгчбочЪДхИЭхзЛхМЦуАВ</p></blockquote> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">invokeHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Store in local variable to reduce volatile reads.</span>
    <span class="token keyword">int</span> handlerState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handlerState<span class="token punctuation">;</span>
    <span class="token keyword">return</span> handlerState <span class="token operator">==</span> <span class="token constant">ADD_COMPLETE</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>ordered <span class="token operator">&amp;&amp;</span> handlerState <span class="token operator">==</span> <span class="token constant">ADD_PENDING</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хПкцЬЙшзжхПСф║Ж handlerAdded хЫЮш░Гя╝МChannelHandler чЪДчК╢цАБцЙНшГ╜хПШцИР ADD_COMPLETE уАВ</p> <p>хжВцЮЬ invokeHandler() цЦ╣ц│Хш┐ФхЫЮ falseя╝МщВгф╣ИцИСф╗мх░▒щЬАшжБш╖│ш┐Зш┐Щф╕кnextChannelHandlerя╝Мх╣╢ш░ГчФи ChannelHandlerContext#write цЦ╣ц│Хч╗зч╗нхРСхЙНф╝ацТн write ф║Лф╗╢уАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//ч╗зч╗нхРСхЙНф╝ацТнwriteф║Лф╗╢я╝МхЫЮхИ░ц╡БчиЛш╡╖чВ╣</span>
    <span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хжВцЮЬ invokeHandler() ш┐ФхЫЮ true я╝Мшп┤цШОш┐Щф╕к nextChannelHandler х╖▓ч╗ПхЬи pipeline ф╕ншвлцнгчбочЪДхИЭхзЛхМЦф║Жя╝МNetty чЫ┤цОеш░ГчФиш┐Щф╕к ChannelHandler чЪД write цЦ╣ц│Хя╝Мш┐Щца╖х░▒хоЮчО░ф║Ж write ф║Лф╗╢ф╗Ох╜УхЙН ChannelHandler ф╝ацТнхИ░ф║ЖnextChannelHandlerуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeWrite0</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//ш░ГчФих╜УхЙНChannelHandlerф╕нчЪДwriteцЦ╣ц│Х</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ChannelOutboundHandler</span><span class="token punctuation">)</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">notifyOutboundHandlerException</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>ш┐ЩщЗМцИСф╗мчЬЛхИ░хЬи write ф║Лф╗╢чЪДф╝ацТнш┐ЗчиЛф╕нхжВцЮЬхПСчФЯх╝Вх╕╕я╝МщВгф╣И write ф║Лф╗╢х░▒ф╝ЪхБЬцнвхЬи pipeline ф╕нф╝ацТня╝Мх╣╢щАЪчЯец│ихЖМчЪД ChannelFutureListenerуАВ</p></blockquote> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191113159.png" alt="хЫ╛чЙЗ">ховцИ╖члпchannel pipelineч╗УцЮД.png</p> <p>ф╗ОцЬмцЦЗчд║ф╛ЛчЪД pipeline ч╗УцЮДф╕нцИСф╗мхПпф╗ечЬЛхИ░я╝Мх╜УхЬи EchoServerHandler ш░ГчФи ChannelHandlerContext#write цЦ╣ц│ХхРОя╝Мwrite ф║Лф╗╢ф╝ЪхЬи pipeline ф╕нхРСхЙНф╝ацТнхИ░ HeadContext ф╕ня╝МшАМхЬи HeadContext ф╕нцЙНцШп Netty чЬЯцнгхдДчРЖ write ф║Лф╗╢чЪДхЬ░цЦ╣уАВ</p> <h2 id="_3-2-headcontext"><a href="#_3-2-headcontext" class="header-anchor">#</a> 3.2 HeadContext</h2> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HeadContext</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractChannelHandlerContext</span>
            <span class="token keyword">implements</span> <span class="token class-name">ChannelOutboundHandler</span><span class="token punctuation">,</span> <span class="token class-name">ChannelInboundHandler</span> <span class="token punctuation">{</span>
          
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            unsafe<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre></div><p>write ф║Лф╗╢цЬАч╗Иф╝ЪхЬи pipeline ф╕нф╝ацТнхИ░ HeadContext щЗМх╣╢хЫЮш░Г HeadContext чЪД write цЦ╣ц│ХуАВх╣╢хЬи write хЫЮш░Гф╕нш░ГчФи channel чЪД unsafe ч▒╗цЙзшбМх║Хх▒ВчЪД write цУНф╜ЬуАВш┐ЩщЗМцнгцШп write ф║Лф╗╢хЬи pipeline ф╕нчЪДф╝ацТнч╗ИчВ╣уАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191113121.png" alt="хЫ╛чЙЗ">ChannelOutboundBufferф╕нч╝УхнШх╛ЕхПСщАБцХ░цНо.png</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractUnsafe</span> <span class="token keyword">implements</span> <span class="token class-name">Unsafe</span> <span class="token punctuation">{</span>
    <span class="token comment">//х╛ЕхПСщАБцХ░цНоч╝УхЖ▓щШЯхИЧ  NettyцШпхЕих╝ВцнецбЖцЮ╢я╝МцЙАф╗еш┐ЩщЗМщЬАшжБф╕Аф╕кч╝УхЖ▓щШЯхИЧцЭеч╝УхнШчФицИ╖щЬАшжБхПСщАБчЪДцХ░цНо </span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">ChannelOutboundBuffer</span> outboundBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChannelOutboundBuffer</span><span class="token punctuation">(</span><span class="token class-name">AbstractChannel</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">assertEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//шО╖хПЦх╜УхЙНchannelхп╣х║ФчЪДх╛ЕхПСщАБцХ░цНоч╝УхЖ▓щШЯхИЧя╝ИцФпцМБчФицИ╖х╝ВцнехЖЩхЕечЪДца╕х┐ГхЕ│щФоя╝Й</span>
        <span class="token class-name">ChannelOutboundBuffer</span> outboundBuffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>outboundBuffer<span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token keyword">int</span> size<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//ш┐Зц╗дmessageч▒╗хЮЛ ш┐ЩщЗМхПкф╝ЪцОехПЧDirectBufferцИЦшАЕfileRegionч▒╗хЮЛчЪДmsg</span>
            msg <span class="token operator">=</span> <span class="token function">filterOutboundMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//шобчоЧх╜УхЙНmsgчЪДхдзх░П</span>
            size <span class="token operator">=</span> pipeline<span class="token punctuation">.</span><span class="token function">estimatorHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//х░Жmsg хКахЕехИ░Nettyф╕нчЪДх╛ЕхЖЩхЕецХ░цНоч╝УхЖ▓щШЯхИЧChannelOutboundBufferф╕н</span>
        outboundBuffer<span class="token punctuation">.</span><span class="token function">addMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> size<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>ф╝ЧцЙАхСичЯе Netty цШпф╕Аф╕кх╝Вцнеф║Лф╗╢щй▒хКичЪДч╜Сч╗ЬцбЖцЮ╢я╝МхЬи Netty ф╕нцЙАцЬЙчЪД IO цУНф╜ЬхЕищГищГ╜цШпх╝ВцнечЪДя╝Мх╜УчД╢ф╣ЯхМЕцЛмцЬмх░ПшКВф╗Лч╗НчЪД write цУНф╜Ья╝Мф╕║ф║Жф┐ЭшпБх╝ВцнецЙзшбМ write цУНф╜Ья╝МNetty хоЪф╣Йф║Жф╕Аф╕кх╛ЕхПСщАБцХ░цНоч╝УхЖ▓щШЯхИЧ ChannelOutboundBuffer я╝МNetty х░Жш┐Щф║ЫчФицИ╖щЬАшжБхПСщАБчЪДч╜Сч╗ЬцХ░цНохЬихЖЩхЕехИ░ Socket ф╣ЛхЙНя╝МхЕИцФ╛хЬи ChannelOutboundBuffer ф╕нч╝УхнШуАВ</p> <blockquote><p>цпПф╕кховцИ╖члп NioSocketChannel хп╣х║Фф╕Аф╕к ChannelOutboundBuffer х╛ЕхПСщАБцХ░цНоч╝УхЖ▓щШЯхИЧ</p></blockquote> <h3 id="_3-2-1-filteroutboundmessage"><a href="#_3-2-1-filteroutboundmessage" class="header-anchor">#</a> 3.2.1 filterOutboundMessage</h3> <p>ChannelOutboundBuffer хПкф╝ЪцОехПЧ ByteBuffer ч▒╗хЮЛф╗ехПК FileRegion ч▒╗хЮЛчЪД msg цХ░цНоуАВ</p> <blockquote><p>FileRegion цШпNettyхоЪф╣ЙчЪДчФицЭещАЪш┐ЗщЫ╢цЛ╖ш┤ЭчЪДцЦ╣х╝Пч╜Сч╗Ьф╝аш╛УцЦЗф╗╢цХ░цНоуАВцЬмцЦЗцИСф╗мф╕╗шжБшБЪчДжцЩощАЪч╜Сч╗ЬцХ░цНо ByteBuffer чЪДхПСщАБуАВ</p></blockquote> <p>цЙАф╗ехЬих░Ж msg хЖЩхЕехИ░ ChannelOutboundBuffer ф╣ЛхЙНя╝МцИСф╗мщЬАшжБцгАцЯех╛ЕхЖЩхЕе msg чЪДч▒╗хЮЛуАВчбоф┐ЭцШп ChannelOutboundBuffer хПпцОехПЧчЪДч▒╗хЮЛуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> <span class="token function">filterOutboundMessage</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ByteBuf</span> buf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">isDirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> msg<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> <span class="token function">newDirectBuffer</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">FileRegion</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> msg<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;unsupported message type: &quot;</span> <span class="token operator">+</span> <span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">simpleClassName</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">EXPECTED_TYPES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>хЬич╜Сч╗ЬцХ░цНоф╝аш╛УчЪДш┐ЗчиЛф╕ня╝МNettyф╕║ф║ЖхЗПх░СцХ░цНоф╗О хаЖхЖЕхЖЕхнШ хИ░ хаЖхдЦхЖЕхнШ чЪДцЛ╖ш┤Эф╗ехПКч╝УшзгGCчЪДхОЛхКЫя╝МцЙАф╗еш┐ЩщЗМх┐Ещб╗щЗЗчФи DirectByteBuffer ф╜┐чФихаЖхдЦхЖЕхнШцЭехнШцФ╛ч╜Сч╗ЬхПСщАБцХ░цНоуАВ</p> <h3 id="_3-2-2-estimatorhandleшобчоЧх╜УхЙНmsgчЪДхдзх░П"><a href="#_3-2-2-estimatorhandleшобчоЧх╜УхЙНmsgчЪДхдзх░П" class="header-anchor">#</a> 3.2.2 estimatorHandleшобчоЧх╜УхЙНmsgчЪДхдзх░П</h3> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultChannelPipeline</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelPipeline</span> <span class="token punctuation">{</span>
    <span class="token comment">//хОЯхнРцЫ┤цЦ░estimatorHandleхнЧцо╡</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AtomicReferenceFieldUpdater</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultChannelPipeline</span><span class="token punctuation">,</span> <span class="token class-name">MessageSizeEstimator<span class="token punctuation">.</span>Handle</span><span class="token punctuation">&gt;</span></span> <span class="token constant">ESTIMATOR</span> <span class="token operator">=</span>
            <span class="token class-name">AtomicReferenceFieldUpdater</span><span class="token punctuation">.</span><span class="token function">newUpdater</span><span class="token punctuation">(</span>
                    <span class="token class-name">DefaultChannelPipeline</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">MessageSizeEstimator<span class="token punctuation">.</span>Handle</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;estimatorHandle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//шобчоЧшжБхПСщАБmsgхдзх░ПчЪДhandler</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">MessageSizeEstimator<span class="token punctuation">.</span>Handle</span> estimatorHandle<span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token class-name">MessageSizeEstimator<span class="token punctuation">.</span>Handle</span> <span class="token function">estimatorHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MessageSizeEstimator<span class="token punctuation">.</span>Handle</span> handle <span class="token operator">=</span> estimatorHandle<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            handle <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMessageSizeEstimator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token constant">ESTIMATOR</span><span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                handle <span class="token operator">=</span> estimatorHandle<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> handle<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хЬи pipeline ф╕нф╝ЪцЬЙф╕Аф╕к estimatorHandle ф╕УщЧичФицЭешобчоЧх╛ЕхПСщАБ ByteBuffer чЪДхдзх░ПуАВш┐Щф╕к estimatorHandle ф╝ЪхЬи pipeline хп╣х║ФчЪД Channel ф╕нчЪДщЕНч╜оч▒╗хИЫх╗║чЪДцЧ╢хАЩшвлхИЭхзЛхМЦуАВ</p> <p>ш┐ЩщЗМ estimatorHandle чЪДхоЮщЩЕч▒╗хЮЛф╕║<code>DefaultMessageSizeEstimator#HandleImpl</code>уАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">DefaultMessageSizeEstimator</span> <span class="token keyword">implements</span> <span class="token class-name">MessageSizeEstimator</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HandleImpl</span> <span class="token keyword">implements</span> <span class="token class-name">Handle</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> unknownSize<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">HandleImpl</span><span class="token punctuation">(</span><span class="token keyword">int</span> unknownSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>unknownSize <span class="token operator">=</span> unknownSize<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> msg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">ByteBufHolder</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ByteBufHolder</span><span class="token punctuation">)</span> msg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">FileRegion</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> unknownSize<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>ш┐ЩщЗМцИСф╗мчЬЛхИ░ ByteBuffer чЪДхдзх░ПхН│ф╕║ Buffer ф╕нцЬкшп╗хПЦчЪДхнЧшКВцХ░ writerIndex - readerIndex уАВ</p> <p>х╜УцИСф╗мщкМшпБф║Жх╛ЕхЖЩхЕецХ░цНо msg чЪДч▒╗хЮЛф╗ехПКшобчоЧф║Ж msg чЪДхдзх░ПхРОя╝МцИСф╗мх░▒хПпф╗ещАЪш┐З <code>ChannelOutboundBuffer#addMessage</code>цЦ╣ц│Хх░Ж msg хЖЩхЕехИ░ChannelOutboundBufferя╝Их╛ЕхПСщАБцХ░цНоч╝УхЖ▓щШЯхИЧя╝Йф╕нуАВ</p> <p>write ф║Лф╗╢хдДчРЖчЪДцЬАч╗ИщА╗ш╛Сх░▒цШпх░Жх╛ЕхПСщАБцХ░цНохЖЩхЕехИ░ ChannelOutboundBuffer ф╕ня╝Мф╕ЛщЭвцИСф╗мх░▒цЭечЬЛф╕Лш┐Щф╕к ChannelOutboundBuffer хЖЕщГич╗УцЮДхИ░х║ХцШпф╗Аф╣Ица╖хнРчЪДя╝Я</p> <h2 id="_3-3-channeloutboundbuffer"><a href="#_3-3-channeloutboundbuffer" class="header-anchor">#</a> 3.3 ChannelOutboundBuffer</h2> <p>ChannelOutboundBuffer хЕ╢хоЮцШпф╕Аф╕кхНХщУ╛шбич╗УцЮДчЪДч╝УхЖ▓щШЯхИЧя╝МщУ╛шбиф╕нчЪДшКВчВ╣ч▒╗хЮЛф╕║ Entry я╝МчФ▒ф║О ChannelOutboundBuffer хЬи Netty ф╕нчЪДф╜ЬчФих░▒цШпч╝УхнШх║ФчФичиЛх║Пх╛ЕхПСщАБчЪДч╜Сч╗ЬцХ░цНоя╝МцЙАф╗е Entry ф╕нх░БшгЕчЪДх░▒цШпх╛ЕхЖЩхЕе Socket ф╕нчЪДч╜Сч╗ЬхПСщАБцХ░цНочЫ╕хЕ│чЪДф┐бцБпя╝Мф╗ехПК ChannelHandlerContext#write цЦ╣ц│Хф╕нш┐ФхЫЮч╗ЩчФицИ╖чЪД ChannelPromise уАВш┐Щца╖хПпф╗ехЬицХ░цНохЖЩхЕеSocketф╣ЛхРОх╝ВцнещАЪчЯех║ФчФичиЛх║ПуАВ</p> <p>цндхдЦ ChannelOutboundBuffer ф╕нш┐Шх░БшгЕф║Жф╕Йф╕кщЗНшжБчЪДцМЗщТИя╝Ъ</p> <ul><li><code>unflushedEntry</code> я╝ЪшпецМЗщТИцМЗхРС ChannelOutboundBuffer ф╕нчммф╕Аф╕кх╛ЕхПСщАБцХ░цНочЪД EntryуАВ</li> <li><code>tailEntry</code>я╝ЪшпецМЗщТИцМЗхРС ChannelOutboundBuffer ф╕нцЬАхРОф╕Аф╕кх╛ЕхПСщАБцХ░цНочЪД EntryуАВщАЪш┐З unflushedEntry хТМ tailEntry ш┐Щф╕дф╕кцМЗщТИя╝МцИСф╗мхПпф╗ех╛ИцЦ╣ф╛┐чЪДхоЪф╜НхИ░х╛ЕхПСщАБцХ░цНочЪД Entry шМГхЫ┤уАВ</li> <li><code>flushedEntry</code>я╝Ъх╜УцИСф╗мщАЪш┐З flush цУНф╜ЬщЬАшжБх░Ж ChannelOutboundBuffer ф╕нч╝УхнШчЪДх╛ЕхПСщАБцХ░цНохПСщАБхИ░ Socket ф╕нцЧ╢я╝МflushedEntry цМЗщТИф╝ЪцМЗхРС unflushedEntry чЪДф╜Нч╜оя╝Мш┐Щца╖ flushedEntry цМЗщТИхТМ tailEntry цМЗщТИф╣ЛщЧ┤чЪД Entry х░▒цШпцИСф╗мхН│х░ЖхПСщАБхИ░ Socket ф╕нчЪДч╜Сч╗ЬцХ░цНоуАВ</li></ul> <p>ш┐Щф╕Йф╕кцМЗщТИхЬихИЭхзЛхМЦчЪДцЧ╢хАЩхЭЗф╕║ null уАВ</p> <p>![хЫ╛чЙЗ](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)ChannelOutboundBufferч╗УцЮД.png</p> <h3 id="_3-3-1-entry"><a href="#_3-3-1-entry" class="header-anchor">#</a> 3.3.1 Entry</h3> <p>Entry ф╜Ьф╕║ ChannelOutboundBuffer щУ╛шбич╗УцЮДф╕нчЪДшКВчВ╣хЕГч┤ач▒╗хЮЛя╝МщЗМш╛╣х░БшгЕф║Жх╛ЕхПСщАБцХ░цНочЪДхРДчзНф┐бцБпя╝МChannelOutboundBuffer хЕ╢хоЮх░▒цШпхп╣ Entry ч╗УцЮДчЪДч╗Дч╗ЗхТМцУНф╜ЬуАВхЫацндчРЖшзг Entry ч╗УцЮДцШпчРЖшзгцХ┤ф╕к ChannelOutboundBuffer ш┐Рф╜Ьц╡БчиЛчЪДхЯ║чбАуАВ</p> <p>ф╕ЛщЭвцИСф╗мх░▒цЭечЬЛф╕Л Entry ч╗УцЮДхЕ╖ф╜Ух░БшгЕф║ЖхУкф║Ых╛ЕхПСщАБцХ░цНочЪДф┐бцБпуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Entry</span> <span class="token punctuation">{</span>
    <span class="token comment">//EntryчЪДхп╣ш▒бц▒ая╝МчФицЭехИЫх╗║хТМхЫЮцФ╢Entryхп╣ш▒б</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ObjectPool</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&gt;</span></span> <span class="token constant">RECYCLER</span> <span class="token operator">=</span> <span class="token class-name">ObjectPool</span><span class="token punctuation">.</span><span class="token function">newPool</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ObjectCreator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Entry</span> <span class="token function">newObject</span><span class="token punctuation">(</span><span class="token class-name">Handle</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&gt;</span></span> handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//DefaultHandleчФиф║ОхЫЮцФ╢хп╣ш▒б</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Handle</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&gt;</span></span> handle<span class="token punctuation">;</span>
    <span class="token comment">//ChannelOutboundBufferф╕Лф╕Аф╕кшКВчВ╣</span>
    <span class="token class-name">Entry</span> next<span class="token punctuation">;</span>
    <span class="token comment">//х╛ЕхПСщАБцХ░цНо</span>
    <span class="token class-name">Object</span> msg<span class="token punctuation">;</span>
    <span class="token comment">//msg ш╜мцНвф╕║ jdk nio ф╕нчЪДbyteBuffer</span>
    <span class="token class-name">ByteBuffer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bufs<span class="token punctuation">;</span>
    <span class="token class-name">ByteBuffer</span> buf<span class="token punctuation">;</span>
    <span class="token comment">//х╝ВцнеwriteцУНф╜ЬчЪДfuture</span>
    <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">;</span>
    <span class="token comment">//х╖▓хПСщАБф║ЖхдЪх░С</span>
    <span class="token keyword">long</span> progress<span class="token punctuation">;</span>
    <span class="token comment">//цА╗хЕ▒щЬАшжБхПСщАБхдЪх░Ся╝Мф╕НхМЕхРлentryхп╣ш▒бхдзх░ПуАВ</span>
    <span class="token keyword">long</span> total<span class="token punctuation">;</span>
    <span class="token comment">//pendingSizeшбичд║entryхп╣ш▒бхЬихаЖф╕нщЬАшжБчЪДхЖЕхнШцА╗щЗП х╛ЕхПСщАБцХ░цНохдзх░П + entryхп╣ш▒бцЬмш║лхЬихаЖф╕нхНачФихЖЕхнШхдзх░Пя╝И96я╝Й</span>
    <span class="token keyword">int</span> pendingSize<span class="token punctuation">;</span>
    <span class="token comment">//msgф╕нхМЕхРлф║ЖхЗаф╕кjdk nio bytebuffer</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">//writeцУНф╜ЬцШпхРжшвлхПЦц╢И</span>
    <span class="token keyword">boolean</span> cancelled<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>цИСф╗мчЬЛхИ░Entryч╗УцЮДф╕нф╕АхЕ▒цЬЙ12ф╕кхнЧцо╡я╝МхЕ╢ф╕н1ф╕кщЭЩцАБхнЧцо╡хТМ11ф╕кхоЮф╛ЛхнЧцо╡уАВ</strong></p> <p>ф╕ЛщЭвчмФшАЕх░▒ф╕║хдзхо╢ф╗Лч╗Нф╕Лш┐Щ12ф╕кхнЧцо╡чЪДхРлф╣ЙхПКхЕ╢ф╜ЬчФия╝МхЕ╢ф╕нцЬЙф║ЫхнЧцо╡ф╝ЪхЬихРОщЭвчЪДхЬ║цЩпф╕нф╜┐чФихИ░я╝Мш┐ЩщЗМхдзхо╢хПпшГ╜хп╣цЬЙф║ЫхнЧцо╡чРЖшзгш╡╖цЭецпФш╛Гцибч│Кя╝Мф╕Нш┐Зц▓бхЕ│ч│╗я╝Мш┐ЩщЗМшГ╜чЬЛцЗВхдЪх░СцШпхдЪх░Ся╝Мф╕НчРЖшзгф╣Яц▓бхЕ│ч│╗я╝Мш┐ЩщЗМф╗Лч╗НхПкцШпф╕║ф║Жшойхдзхо╢ц╖╖ф╕кчЬ╝чЖЯя╝МхЬихРОщЭвц╡БчиЛчЪДшо▓шзгф╕ня╝МчмФшАЕш┐Шф╝ЪщЗНцЦ░цПРхИ░ш┐Щф║ЫхнЧцо╡уАВ</p> <ul><li><code>ObjectPool&lt;Entry&gt; RECYCLER</code>я╝ЪEntry чЪДхп╣ш▒бц▒ая╝Мш┤Яш┤гхИЫх╗║чобчРЖ Entry хоЮф╛Ля╝МчФ▒ф║О Netty цШпф╕Аф╕кч╜Сч╗ЬцбЖцЮ╢я╝МцЙАф╗е IO шп╗хЖЩх░▒цИРф║ЖхоГчЪДца╕х┐ГцУНф╜Ья╝МхЬиф╕Аф╕кцФпцМБщлШцАзшГ╜щлШхРЮхРРчЪДч╜Сч╗ЬцбЖцЮ╢ф╕ня╝Мф╝ЪцЬЙхдзщЗПчЪД IO шп╗хЖЩцУНф╜Ья╝МщВгф╣Их░▒ф╝Ъхп╝шЗ┤щвСч╣БчЪДхИЫх╗║ Entry хп╣ш▒буАВцИСф╗мщГ╜чЯещБУя╝МхИЫх╗║ф╕Аф╕кхоЮф╛Лхп╣ш▒бф╗ехПК GC хЫЮцФ╢ш┐Щф║ЫхоЮф╛Лхп╣ш▒бщГ╜цШпщЬАшжБцАзшГ╜х╝АщФАчЪДя╝МщВгф╣ИхЬихдзщЗПщвСч╣БхИЫх╗║ Entry хп╣ш▒бчЪДхЬ║цЩпф╕Ля╝Мх╝ХхЕехп╣ш▒бц▒ацЭехдНчФихИЫх╗║хе╜чЪД Entry хп╣ш▒бхоЮф╛ЛхПпф╗ецК╡ц╢ИцОЙчФ▒щвСч╣БхИЫх╗║хп╣ш▒бф╗ехПКGCхЫЮцФ╢хп╣ш▒бцЙАх╕жцЭечЪДцАзшГ╜х╝АщФАуАВ</li></ul> <blockquote><p>хЕ│ф║Охп╣ш▒бц▒ачЪДшпжч╗ЖхЖЕхо╣я╝МцДЯхЕ┤ш╢гчЪДхРМхнжхПпф╗ехЫЮчЬЛф╕ЛчмФшАЕчЪДш┐ЩчпЗцЦЗчла<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484419&amp;idx=1&amp;sn=3a75a495f0f117cca1548da1e0f3e6e6&amp;chksm=ce77c244f9004b52d74b8ffce149ea64e5a8f0ba6713b105d003fdaef8eaa9ad3a5a65d20427&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКшпжшзгRecyclerхп╣ш▒бц▒ачЪДч▓╛хжЩшо╛шобф╕ОхоЮчО░уАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <ul><li><p><code>Handle&lt;Entry&gt; handle</code>я╝Ъщ╗ШшодхоЮчО░ч▒╗хЮЛф╕║ DefaultHandle я╝МчФиф║ОцХ░цНохПСщАБхоМцпХхРОя╝Мхп╣ш▒бц▒ахЫЮцФ╢ Entry хп╣ш▒буАВчФ▒хп╣ш▒бц▒а RECYCLER хЬихИЫх╗║ Entry хп╣ш▒бчЪДцЧ╢хАЩф╝ащАТш┐ЫцЭеуАВ</p></li> <li><p><code>Entry next</code>я╝ЪChannelOutboundBuffer цШпф╕Аф╕кхНХщУ╛шбичЪДч╗УцЮДя╝Мш┐ЩщЗМчЪД next цМЗщТИчФиф║ОцМЗхРСх╜УхЙН Entry шКВчВ╣чЪДхРОч╗зшКВчВ╣уАВ</p></li> <li><p><code>Object msg</code>я╝Ъх║ФчФичиЛх║Пх╛ЕхПСщАБчЪДч╜Сч╗ЬцХ░цНоя╝Мш┐ЩщЗМ msg чЪДч▒╗хЮЛф╕║ DirectByteBuffer цИЦшАЕ FileRegionя╝ИчФиф║ОщАЪш┐ЗщЫ╢цЛ╖ш┤ЭчЪДцЦ╣х╝Пч╜Сч╗Ьф╝аш╛УцЦЗф╗╢я╝ЙуАВ</p></li> <li><p><code>ByteBuffer[] bufs</code>я╝Ъш┐ЩщЗМчЪД ByteBuffer ч▒╗хЮЛф╕║ JDK NIO хОЯчФЯчЪД ByteBuffer ч▒╗хЮЛя╝МхЫаф╕║ Netty цЬАч╗ИхПСщАБцХ░цНоцШпщАЪш┐З JDK NIO х║Хх▒ВчЪД SocketChannel ш┐ЫшбМхПСщАБя╝МцЙАф╗ещЬАшжБх░Ж Netty ф╕нхоЮчО░чЪД ByteBuffer ч▒╗хЮЛш╜мцНвф╕║ JDK NIO ByteBuffer ч▒╗хЮЛуАВх║ФчФичиЛх║ПхПСщАБчЪД ByteBuffer хПпшГ╜цШпф╕Аф╕кф╣ЯхПпшГ╜цШпхдЪф╕кя╝МхжВцЮЬхПСщАБхдЪф╕кх░▒чФи ByteBuffer[] bufs х░БшгЕхЬи Entry хп╣ш▒бф╕ня╝МхжВцЮЬцШпф╕Аф╕кх░▒чФи ByteBuffer buf х░БшгЕуАВ</p></li> <li><p><code>int count</code>я╝Ъшбичд║х╛ЕхПСщАБцХ░цНо msg ф╕нф╕АхЕ▒хМЕхРлф║ЖхдЪх░Сф╕к ByteBuffer щЬАшжБхПСщАБуАВ</p></li> <li><p><code>ChannelPromise promise</code>я╝ЪChannelHandlerContext#write х╝ВцнехЖЩцУНф╜Ьш┐ФхЫЮчЪД ChannelFutureуАВх╜У Netty х░Жх╛ЕхПСщАБцХ░цНохЖЩхЕехИ░ Socket ф╕нцЧ╢ф╝ЪщАЪш┐Зш┐Щф╕к ChannelPromise щАЪчЯех║ФчФичиЛх║ПхПСщАБч╗УцЮЬуАВ</p></li> <li><p><code>long progress</code>я╝Ъшбичд║х╜УхЙНчЪДф╕Аф╕кхПСщАБш┐Ых║жя╝Мх╖▓ч╗ПхПСщАБф║ЖхдЪх░СцХ░цНоуАВ</p></li> <li><p><code>long total</code>я╝ЪEntryф╕нцА╗хЕ▒щЬАшжБхПСщАБхдЪх░СцХ░цНоуАВц│ицДПя╝Ъш┐Щф╕кхнЧцо╡х╣╢ф╕НхМЕхРл Entry хп╣ш▒бчЪДхЖЕхнШхНачФихдзх░ПуАВхПкцШпшбичд║х╛ЕхПСщАБч╜Сч╗ЬцХ░цНочЪДхдзх░ПуАВ</p></li> <li><p><code>boolean cancelled</code>я╝Ъх║ФчФичиЛх║Пш░ГчФичЪД write цУНф╜ЬцШпхРжшвлхПЦц╢ИуАВ</p></li> <li><p><code>int pendingSize</code>я╝Ъшбичд║х╛ЕхПСщАБцХ░цНочЪДхЖЕхнШхНачФицА╗щЗПуАВх╛ЕхПСщАБцХ░цНохЬихЖЕхнШф╕нчЪДхНачФищЗПхИЖф╕║ф╕дщГихИЖя╝Ъ</p></li> <li><ul><li>Entryхп╣ш▒бф╕нцЙАх░БшгЕчЪДх╛ЕхПСщАБч╜Сч╗ЬцХ░цНохдзх░ПуАВ</li> <li>Entryхп╣ш▒бцЬмш║лхЬихЖЕхнШф╕нчЪДхНачФищЗПуАВ</li></ul></li></ul> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191113752.png" alt="хЫ╛чЙЗ">EntryхЖЕхнШхНачФицА╗щЗП.png</p> <h3 id="_3-3-2-pendingsizeчЪДф╜ЬчФи"><a href="#_3-3-2-pendingsizeчЪДф╜ЬчФи" class="header-anchor">#</a> 3.3.2 pendingSizeчЪДф╜ЬчФи</h3> <p>цГ│ш▒бф╕Аф╕Лш┐Щца╖чЪДф╕Аф╕кхЬ║цЩпя╝Мх╜УчФ▒ф║Оч╜Сч╗ЬцЛехбЮцИЦшАЕ Netty ховцИ╖члпш┤Яш╜╜х╛ИщлШхп╝шЗ┤ч╜Сч╗ЬцХ░цНочЪДцОецФ╢щАЯх║жф╗ехПКхдДчРЖщАЯх║жш╢КцЭеш╢КцЕвя╝МTCP чЪДц╗СхКичкЧхПгф╕НцЦнч╝йх░Пф╗ехЗПх░Сч╜Сч╗ЬцХ░цНочЪДхПСщАБчЫ┤хИ░ф╕║ 0я╝МшАМ Netty цЬНхКбчлпхН┤цЬЙхдзщЗПщвСч╣БчЪДхЖЩцУНф╜Ья╝Мф╕НцЦнчЪДхЖЩхЕехИ░ ChannelOutboundBuffer ф╕нуАВ</p> <p>ш┐Щца╖х░▒хп╝шЗ┤ф║ЖцХ░цНохПСщАБф╕НхЗ║хО╗ф╜ЖцШп Netty цЬНхКбчлпхПИхЬиф╕НхБЬчЪДхЖЩцХ░цНоя╝МцЕвцЕвчЪДх░▒ф╝ЪцТСчИЖ ChannelOutboundBuffer хп╝шЗ┤OOMуАВш┐ЩщЗМф╕╗шжБцМЗчЪДцШпхаЖхдЦхЖЕхнШчЪД OOMя╝МхЫаф╕║ ChannelOutboundBuffer ф╕нхМЕшг╣чЪДх╛ЕхПСщАБцХ░цНохЕищГихнШхВихЬихаЖхдЦхЖЕхнШф╕нуАВ</p> <p>цЙАф╗е Netty х░▒х┐Ещб╗щЩРхИ╢ ChannelOutboundBuffer ф╕нчЪДх╛ЕхПСщАБцХ░цНочЪДхЖЕхнШхНачФицА╗щЗПя╝Мф╕НшГ╜шойхоГцЧащЩРхвЮщХ┐уАВNetty ф╕нхоЪф╣Йф║ЖщлШф╜Оц░┤ф╜Нч║┐чФицЭешбичд║ ChannelOutboundBuffer ф╕нчЪДх╛ЕхПСщАБцХ░цНочЪДхЖЕхнШхНачФищЗПчЪДф╕КщЩРхТМф╕ЛщЩРуАВц│ицДПя╝Ъш┐ЩщЗМчЪДхЖЕхнШцЧвхМЕцЛм JVM хаЖхЖЕхнШхНачФиф╣ЯхМЕцЛмхаЖхдЦхЖЕхнШхНачФиуАВ</p> <ul><li>х╜Ух╛ЕхПСщАБцХ░цНочЪДхЖЕхнШхНачФицА╗щЗПш╢Еш┐ЗщлШц░┤ф╜Нч║┐чЪДцЧ╢хАЩя╝МNetty х░▒ф╝Ъх░Ж NioSocketChannel чЪДчК╢цАБцаЗшо░ф╕║ф╕НхПпхЖЩчК╢цАБуАВхРжхИЩх░▒хПпшГ╜хп╝шЗ┤ OOMуАВ</li> <li>х╜Ух╛ЕхПСщАБцХ░цНочЪДхЖЕхнШхНачФицА╗щЗПф╜Оф║Оф╜Оц░┤ф╜Нч║┐чЪДцЧ╢хАЩя╝МNetty ф╝ЪхЖНцмбх░Ж NioSocketChannel чЪДчК╢цАБцаЗшо░ф╕║хПпхЖЩчК╢цАБуАВ</li></ul> <p><strong>щВгф╣ИцИСф╗мчФиф╗Аф╣Ишо░х╜ХChannelOutboundBufferф╕нчЪДх╛ЕхПСщАБцХ░цНочЪДхЖЕхнШхНачФицА╗щЗПхСв</strong>я╝Я</p> <p>чнФцбИх░▒цШпцЬмх░ПшКВшжБф╗Лч╗НчЪД pendingSize хнЧцо╡уАВ<strong>хЬиш░ИхИ░х╛ЕхПСщАБцХ░цНочЪДхЖЕхнШхНачФищЗПцЧ╢хдзщГихИЖхРМхнжцЩощБНщГ╜ф╝ЪцЬЙф╕Аф╕кшппшзгх░▒цШпхПкшобчоЧх╛ЕхПСщАБцХ░цНочЪДхдзх░Пя╝Иmsgф╕нхМЕхРлчЪДхнЧшКВцХ░я╝Й</strong> шАМх┐╜чХеф║Ж Entry хоЮф╛Лхп╣ш▒бцЬмш║лхЬихЖЕхнШф╕нчЪДхНачФищЗПуАВ</p> <p>хЫаф╕║ Netty ф╝Ъх░Жх╛ЕхПСщАБцХ░цНох░БшгЕхЬи Entry хоЮф╛Лхп╣ш▒бф╕ня╝МхЬихдзщЗПщвСч╣БчЪДхЖЩцУНф╜Ьф╕нф╝Ъф║зчФЯхдзщЗПчЪД Entry хоЮф╛Лхп╣ш▒бя╝МцЙАф╗е Entry хоЮф╛Лхп╣ш▒бчЪДхЖЕхнШхНачФицШпф╕НхПпх┐╜шзЖчЪДуАВ</p> <p>хРжхИЩх░▒ф╝Ъхп╝шЗ┤цШОцШОш┐Шц▓бцЬЙхИ░ш╛╛щлШц░┤ф╜Нч║┐я╝Мф╜ЖцШпчФ▒ф║ОхдзщЗПчЪД Entry хоЮф╛Лхп╣ш▒бхнШхЬия╝Мф╗ОшАМхПСчФЯOOMуАВ</p> <p>цЙАф╗е pendingSize чЪДшобчоЧцЧвшжБхМЕхРлх╛ЕхПСщАБцХ░цНочЪДхдзх░Пф╣ЯшжБхМЕхРлхЕ╢ Entry хоЮф╛Лхп╣ш▒бчЪДхЖЕхнШхНачФихдзх░Пя╝Мш┐Щца╖цЙНшГ╜хЗЖчбошобчоЧхЗ║ ChannelOutboundBuffer ф╕нх╛ЕхПСщАБцХ░цНочЪДхЖЕхнШхНачФицА╗щЗПуАВ</p> <p>ChannelOutboundBuffer ф╕нцЙАцЬЙчЪД Entry хоЮф╛Лф╕нчЪД pendingSize ф╣ЛхТМх░▒цШпх╛ЕхПСщАБцХ░цНоцА╗чЪДхЖЕхнШхНачФищЗПуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ChannelOutboundBuffer</span> <span class="token punctuation">{</span>
  <span class="token comment">//ChannelOutboundBufferф╕нчЪДх╛ЕхПСщАБцХ░цНочЪДхЖЕхнШхНачФицА╗щЗП</span>
  <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> totalPendingSize<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-3-3-щлШф╜Оц░┤ф╜Нч║┐"><a href="#_3-3-3-щлШф╜Оц░┤ф╜Нч║┐" class="header-anchor">#</a> 3.3.3 щлШф╜Оц░┤ф╜Нч║┐</h3> <p>ф╕Кх░ПшКВцПРхИ░ Netty ф╕║ф║ЖщШ▓цнв ChannelOutboundBuffer ф╕нчЪДх╛ЕхПСщАБцХ░цНохЖЕхнШхНачФицЧащЩРхИ╢чЪДхвЮщХ┐ф╗ОшАМхп╝шЗ┤ OOM я╝МцЙАф╗ех╝ХхЕеф║ЖщлШф╜Оц░┤ф╜Нч║┐я╝Мф╜Ьф╕║х╛ЕхПСщАБцХ░цНохЖЕхнШхНачФичЪДф╕КщЩРхТМф╕ЛщЩРуАВ</p> <p><strong>щВгф╣ИщлШф╜Оц░┤ф╜Нч║┐хЕ╖ф╜Ушо╛ч╜охдЪхдзхСв</strong> ? цИСф╗мцЭечЬЛф╕Аф╕Л DefaultChannelConfig ф╕нчЪДщЕНч╜оуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultChannelConfig</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelConfig</span> <span class="token punctuation">{</span>

    <span class="token comment">//ChannelOutboundBufferф╕нчЪДщлШф╜Оц░┤ф╜Нч║┐</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">WriteBufferWaterMark</span> writeBufferWaterMark <span class="token operator">=</span> <span class="token class-name">WriteBufferWaterMark</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">WriteBufferWaterMark</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_LOW_WATER_MARK</span> <span class="token operator">=</span> <span class="token number">32</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_HIGH_WATER_MARK</span> <span class="token operator">=</span> <span class="token number">64</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">WriteBufferWaterMark</span> <span class="token constant">DEFAULT</span> <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">WriteBufferWaterMark</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_LOW_WATER_MARK</span><span class="token punctuation">,</span> <span class="token constant">DEFAULT_HIGH_WATER_MARK</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">WriteBufferWaterMark</span><span class="token punctuation">(</span><span class="token keyword">int</span> low<span class="token punctuation">,</span> <span class="token keyword">int</span> high<span class="token punctuation">,</span> <span class="token keyword">boolean</span> validate<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХецабщкМщА╗ш╛С<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>low <span class="token operator">=</span> low<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>high <span class="token operator">=</span> high<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цИСф╗мчЬЛхИ░ ChannelOutboundBuffer ф╕нчЪДщлШц░┤ф╜Нч║┐шо╛ч╜очЪДхдзх░Пф╕║ 64 KBя╝Мф╜Оц░┤ф╜Нч║┐шо╛ч╜очЪДцШп 32 KBуАВ</p> <p>ш┐Щф╣Ях░▒цДПхС│чЭАцпПф╕к Channel ф╕нчЪДх╛ЕхПСщАБцХ░цНохжВцЮЬш╢Еш┐З 64 KBуАВChannel чЪДчК╢цАБх░▒ф╝ЪхПШф╕║ф╕НхПпхЖЩчК╢цАБуАВх╜УхЖЕхнШхНачФищЗПф╜Оф║О 32 KBцЧ╢я╝МChannel чЪДчК╢цАБф╝ЪхЖНцмбхПШф╕║хПпхЖЩчК╢цАБуАВ</p> <h3 id="_3-3-4-entryхоЮф╛Лхп╣ш▒бхЬиjvmф╕нхНачФихЖЕхнШхдзх░П"><a href="#_3-3-4-entryхоЮф╛Лхп╣ш▒бхЬиjvmф╕нхНачФихЖЕхнШхдзх░П" class="header-anchor">#</a> 3.3.4 EntryхоЮф╛Лхп╣ш▒бхЬиJVMф╕нхНачФихЖЕхнШхдзх░П</h3> <p>хЙНш╛╣цПРхИ░ pendingSize чЪДф╜ЬчФиф╕╗шжБцШпшо░х╜Хх╜УхЙНх╛ЕхПСщАБцХ░цНочЪДхЖЕхнШхНачФицА╗щЗПф╗ОшАМхПпф╗ещвДшнж OOM чЪДхПСчФЯуАВ</p> <p>х╛ЕхПСщАБцХ░цНочЪДхЖЕхнШхНачФихИЖф╕║я╝Ъх╛ЕхПСщАБцХ░цНо msg чЪДхЖЕхнШхНачФихдзх░Пф╗ехПК Entry хп╣ш▒бцЬмш║лхЬиJVMф╕нчЪДхЖЕхнШхНачФиуАВ</p> <p>щВгф╣И Entry хп╣ш▒бцЬмш║лчЪДхЖЕхнШхНачФицИСф╗мшпехжВф╜ХшобчоЧхСвя╝Я</p> <p>шжБцГ│цРЮц╕ЕцеЪш┐Щф╕кщЧощвШя╝Мхдзхо╢щЬАшжБхЕИф║Жшзгф╕Аф╕Л Java хп╣ш▒бхЖЕхнШх╕Гх▒АчЪДчЫ╕хЕ│чЯешпЖуАВхЕ│ф║Ош┐ЩщГихИЖшГМцЩпчЯешпЖя╝МчмФшАЕх╖▓ч╗ПхЬи <a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484304&amp;idx=1&amp;sn=54bf0d07e69c5621c145afaece8f50d6&amp;chksm=ce77c5d7f9004cc1249a03dfd0fb12b7d75171f1b87acea1fa44bbb11ca374b6f42a66fa274d&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКф╕АцЦЗшБКщАПхп╣ш▒бхЬиJVMф╕нчЪДхЖЕхнШх╕Гх▒Ая╝Мф╗ехПКхЖЕхнШхп╣щ╜РхТМхОЛч╝йцМЗщТИчЪДхОЯчРЖхПКх║ФчФиуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ш┐ЩчпЗцЦЗчлаф╕нч╗ЩхЗ║ф║Жшпжх░╜чЪДщШРш┐░я╝МцГ│ц╖▒хЕеф║Жшзгш┐ЩхЭЧчЪДхРМхнжхПпф╗ечЬЛф╕Лш┐ЩчпЗцЦЗчлауАВ</p> <p>ш┐ЩщЗМчмФшАЕхПкф╗Ош┐ЩчпЗцЦЗчлаф╕нцПРчВ╝ф╕Аф║ЫхЕ│ф║ОшобчоЧ Java хп╣ш▒бхНачФихЖЕхнШхдзх░ПчЫ╕хЕ│чЪДхЖЕхо╣уАВ</p> <p>хЬихЕ│ф║О Java хп╣ш▒бхЖЕхнШх╕Гх▒Аш┐ЩчпЗцЦЗчлаф╕нцИСф╗мцПРхИ░я╝Мхп╣ф║ОJavaцЩощАЪхп╣ш▒бцЭешп┤хЖЕхнШф╕нчЪДх╕Гх▒АчФ▒я╝Ъ<code>хп╣ш▒бхд┤ + хоЮф╛ЛцХ░цНохМ║ + Padding</code>я╝Мш┐Щф╕ЙщГихИЖч╗ДцИРуАВ</p> <p>хЕ╢ф╕нхп╣ш▒бхд┤чФ▒хнШхВихп╣ш▒бш┐РшбМцЧ╢ф┐бцБпчЪД MarkWord ф╗ехПКцМЗхРСхп╣ш▒бч▒╗хЮЛхЕГф┐бцБпчЪДч▒╗хЮЛцМЗщТИч╗ДцИРуАВ</p> <blockquote><p>MarkWord чФицЭехнШцФ╛я╝Ъhashcodeя╝МGC хИЖф╗гх╣┤щ╛Дя╝МщФБчК╢цАБцаЗх┐Чя╝Мч║┐чиЛцМБцЬЙчЪДщФБя╝МхБПхРСч║┐чиЛ Idя╝МхБПхРСцЧ╢щЧ┤цИ│чнЙуАВхЬи 32 ф╜НцУНф╜Ьч│╗ч╗ЯхТМ 64 ф╜НцУНф╜Ьч│╗ч╗Яф╕н MarkWord хИЖхИлхНачФи 4B хТМ 8B хдзх░ПчЪДхЖЕхнШуАВ</p></blockquote> <blockquote><p>Java хп╣ш▒бхд┤ф╕нчЪДч▒╗хЮЛцМЗщТИш┐ШцЬЙхоЮф╛ЛцХ░цНохМ║чЪДхп╣ш▒бх╝ХчФия╝МхЬи64 ф╜Нч│╗ч╗Яф╕нх╝АхРпхОЛч╝йцМЗщТИчЪДцГЕхЖ╡ф╕Ля╝И-XX:+UseCompressedOopsя╝ЙхНачФи 4B хдзх░ПуАВхЬихЕ│щЧнхОЛч╝йцМЗщТИчЪДцГЕхЖ╡ф╕Ля╝И-XX:-UseCompressedOopsя╝ЙхНачФи 8B хдзх░ПуАВ</p></blockquote> <p>хоЮф╛ЛцХ░цНохМ║чФиф║ОхнШхВи Java ч▒╗ф╕нхоЪф╣ЙчЪДхоЮф╛ЛхнЧцо╡я╝МхМЕцЛмцЙАцЬЙчИ╢ч▒╗ф╕нчЪДхоЮф╛ЛхнЧцо╡ф╗ехПКхп╣ш▒бх╝ХчФиуАВ</p> <p>хЬихоЮф╛ЛцХ░цНохМ║ф╕нхп╣ш▒бхнЧцо╡ф╣ЛщЧ┤чЪДцОТхИЧф╗ехПКхЖЕхнШхп╣щ╜РщЬАшжБщБ╡х╛кф╕Йф╕кхнЧцо╡щЗНцОТхИЧшзДхИЩя╝Ъ</p> <ul><li><code>шзДхИЩ1</code>я╝ЪхжВцЮЬф╕Аф╕кхнЧцо╡хНачФи<code>X</code>ф╕кхнЧшКВя╝МщВгф╣Иш┐Щф╕кхнЧцо╡чЪДхБПчз╗щЗПOFFSETщЬАшжБхп╣щ╜РшЗ│<code>NX</code>уАВ</li> <li><code>шзДхИЩ2</code>я╝ЪхЬих╝АхРпф║ЖхОЛч╝йцМЗщТИчЪД 64 ф╜Н JVM ф╕ня╝МJava ч▒╗ф╕нчЪДчммф╕Аф╕кхнЧцо╡чЪД OFFSET щЬАшжБхп╣щ╜РшЗ│ <code>4N</code>я╝МхЬихЕ│щЧнхОЛч╝йцМЗщТИчЪДцГЕхЖ╡ф╕Лч▒╗ф╕нчммф╕Аф╕кхнЧцо╡чЪДOFFSETщЬАшжБхп╣щ╜РшЗ│ <code>8N</code>уАВ</li> <li><code>шзДхИЩ3</code>я╝ЪJVM щ╗ШшодхИЖщЕНхнЧцо╡чЪДщб║х║Пф╕║я╝Ъlong / doubleя╝Мint / floatя╝Мshort / charя╝Мbyte / booleanя╝Мoops(Ordianry Object Point х╝ХчФич▒╗хЮЛцМЗщТИ)я╝Мх╣╢ф╕ФчИ╢ч▒╗ф╕нхоЪф╣ЙчЪДхоЮф╛ЛхПШщЗПф╝ЪхЗ║чО░хЬихнРч▒╗хоЮф╛ЛхПШщЗПф╣ЛхЙНуАВх╜Ушо╛ч╜оJVMхПВцХ░ <code>-XX +CompactFields</code> цЧ╢я╝Ищ╗Шшодя╝Йя╝МхНачФихЖЕхнШх░Пф║О long / double чЪДхнЧцо╡ф╝ЪхЕБшо╕швлцПТхЕехИ░хп╣ш▒бф╕нчммф╕Аф╕к long / double хнЧцо╡ф╣ЛхЙНчЪДщЧ┤щЪЩф╕ня╝Мф╗ещБ┐хЕНф╕Нх┐ЕшжБчЪДхЖЕхнШхблхЕЕуАВ</li></ul> <p>ш┐ШцЬЙф╕Аф╕кщЗНшжБшзДхИЩх░▒цШп Java шЩЪцЛЯцЬ║хаЖф╕нхп╣ш▒бчЪДш╡╖хзЛхЬ░хЭАщЬАшжБхп╣щ╜РшЗ│ 8 чЪДхАНцХ░я╝ИхПпчФ▒JVMхПВцХ░ -XX:ObjectAlignmentInBytes цОзхИ╢я╝Мщ╗Шшодф╕║ 8 я╝ЙуАВ</p> <p>хЬиф║Жшзгф╕Кш┐░хнЧцо╡цОТхИЧф╗ехПКхп╣ш▒бф╣ЛщЧ┤чЪДхЖЕхнШхп╣щ╜РшзДхИЩхРОя╝МцИСф╗мхИЖхИлф╗ех╝АхРпхОЛч╝йцМЗщТИхТМхЕ│щЧнхОЛч╝йцМЗщТИф╕дчзНцГЕхЖ╡я╝МцЭехп╣ Entry хп╣ш▒бчЪДхЖЕхнШх╕Гх▒Аш┐ЫшбМхИЖцЮРх╣╢шобчоЧхп╣ш▒бхНачФихЖЕхнШхдзх░ПуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Entry</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token keyword">static</span>хнЧцо╡<span class="token constant">RECYCLER</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

   	<span class="token comment">//DefaultHandleчФиф║ОхЫЮцФ╢хп╣ш▒б</span>
   	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Handle</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&gt;</span></span> handle<span class="token punctuation">;</span>
    <span class="token comment">//ChannelOutboundBufferф╕Лф╕Аф╕кшКВчВ╣</span>
    <span class="token class-name">Entry</span> next<span class="token punctuation">;</span>
    <span class="token comment">//х╛ЕхПСщАБцХ░цНо</span>
    <span class="token class-name">Object</span> msg<span class="token punctuation">;</span>
    <span class="token comment">//msg ш╜мцНвф╕║ jdk nio ф╕нчЪДbyteBuffer</span>
    <span class="token class-name">ByteBuffer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bufs<span class="token punctuation">;</span>
    <span class="token class-name">ByteBuffer</span> buf<span class="token punctuation">;</span>
    <span class="token comment">//х╝ВцнеwriteцУНф╜ЬчЪДfuture</span>
    <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">;</span>
    <span class="token comment">//х╖▓хПСщАБф║ЖхдЪх░С</span>
    <span class="token keyword">long</span> progress<span class="token punctuation">;</span>
    <span class="token comment">//цА╗хЕ▒щЬАшжБхПСщАБхдЪх░Ся╝Мф╕НхМЕхРлentryхп╣ш▒бхдзх░ПуАВ</span>
    <span class="token keyword">long</span> total<span class="token punctuation">;</span>
    <span class="token comment">//pendingSizeшбичд║entryхп╣ш▒бхЬихаЖф╕нщЬАшжБчЪДхЖЕхнШцА╗щЗП х╛ЕхПСщАБцХ░цНохдзх░П + entryхп╣ш▒бцЬмш║лхЬихаЖф╕нхНачФихЖЕхнШхдзх░Пя╝И96я╝Й</span>
    <span class="token keyword">int</span> pendingSize<span class="token punctuation">;</span>
    <span class="token comment">//msgф╕нхМЕхРлф║ЖхЗаф╕кjdk nio bytebuffer</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">//writeцУНф╜ЬцШпхРжшвлхПЦц╢И</span>
    <span class="token keyword">boolean</span> cancelled<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цИСф╗мчЬЛхИ░ Entry хп╣ш▒бф╕нф╕АхЕ▒цЬЙ 11 ф╕кхоЮф╛ЛхнЧцо╡я╝МхЕ╢ф╕н 2 ф╕к long хЮЛхнЧцо╡я╝М2 ф╕к int хЮЛхнЧцо╡я╝М1 ф╕к boolean хЮЛхнЧцо╡я╝М6 ф╕кхп╣ш▒бх╝ХчФиуАВ</p> <p>щ╗ШшодцГЕхЖ╡ф╕ЛJVMхПВцХ░ <code>-XX +CompactFields</code> цШпх╝АхРпчЪДуАВ</p> <h4 id="х╝АхРпцМЗщТИхОЛч╝й-xx-usecompressedoops"><a href="#х╝АхРпцМЗщТИхОЛч╝й-xx-usecompressedoops" class="header-anchor">#</a> х╝АхРпцМЗщТИхОЛч╝й -XX:+UseCompressedOops</h4> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191114206.png" alt="хЫ╛чЙЗ">image.png</p> <p>Entry хп╣ш▒бчЪДхЖЕхнШх╕Гх▒Аф╕нх╝Ахд┤хЕИцШп 8 ф╕кхнЧшКВчЪД MarkWordя╝МчД╢хРОцШп 4 ф╕кхнЧшКВчЪДч▒╗хЮЛцМЗщТИя╝Их╝АхРпхОЛч╝йцМЗщТИя╝ЙуАВ</p> <p>хЬихоЮф╛ЛцХ░цНохМ║ф╕нхп╣ш▒бчЪДцОТхИЧшзДхИЩщЬАшжБчмжхРИшзДхИЩ3я╝Мф╣Ях░▒цШпхнЧцо╡ф╣ЛщЧ┤чЪДцОТхИЧщб║х║ПщЬАшжБщБ╡х╛к <code>long &gt; int &gt; boolean &gt; oop(хп╣ш▒бх╝ХчФи)</code>уАВ</p> <p>ца╣цНошзДхИЩ 3 Entryхп╣ш▒бхоЮф╛ЛцХ░цНохМ║чммф╕Аф╕кхнЧцо╡х║ФшпецШп long progressя╝Мф╜Жца╣цНошзДхИЩ1 long хЮЛхнЧцо╡чЪД OFFSET щЬАшжБхп╣щ╜РшЗ│ 8 чЪДхАНцХ░я╝Мх╣╢ф╕Фца╣цНо шзДхИЩ2 хЬих╝АхРпхОЛч╝йцМЗщТИчЪДцГЕхЖ╡ф╕Ля╝Мхп╣ш▒бчЪДчммф╕Аф╕кхнЧцо╡ OFFSET щЬАшжБхп╣щ╜РшЗ│ 4 чЪДхАНцХ░уАВцЙАф╗ехнЧцо╡long progress чЪД OFFET  = 16я╝Мш┐Щх░▒х┐ЕчД╢хп╝шЗ┤ф║ЖхЬихп╣ш▒бхд┤ф╕ОхнЧцо╡ long progress ф╣ЛщЧ┤щЬАшжБчФ▒ 4 хнЧшКВчЪДхнЧшКВхблхЕЕя╝ИOFFET = 12хдДхПСчФЯхнЧшКВхблхЕЕя╝ЙуАВ</p> <p>ф╜ЖцШп JVM щ╗Шшодх╝АхРпф║Ж <code>-XX +CompactFields</code>я╝Мца╣цНо шзДхИЩ3 хНачФихЖЕхнШх░Пф║О long / double чЪДхнЧцо╡ф╝ЪхЕБшо╕швлцПТхЕехИ░хп╣ш▒бф╕нчммф╕Аф╕к long / double хнЧцо╡ф╣ЛхЙНчЪДщЧ┤щЪЩф╕ня╝Мф╗ещБ┐хЕНф╕Нх┐ЕшжБчЪДхЖЕхнШхблхЕЕуАВ</p> <p>цЙАф╗еф╜Нф║ОхРОш╛╣чЪДхнЧцо╡ int pendingSize цПТхЕехИ░ф║Ж OFFET = 12 ф╜Нч╜охдДя╝МщБ┐хЕНф║Жф╕Нх┐ЕшжБчЪДхнЧшКВхблхЕЕуАВ</p> <p>хЬи Entry хп╣ш▒бчЪДхоЮф╛ЛцХ░цНохМ║ф╕нч┤зцОечЭАхЯ║чбАч▒╗хЮЛхнЧцо╡хРОщЭвш╖ЯчЭАчЪДх░▒цШп 6 ф╕кхп╣ш▒бх╝ХчФихнЧцо╡(х╝АхРпхОЛч╝йцМЗщТИхНачФи 4 ф╕кхнЧшКВ)уАВ</p> <p>хдзхо╢ф╕АхоЪц│ицДПхИ░ OFFSET = 37 хдДцЬмх║ФшпехнШцФ╛чЪДцШпхнЧцо╡ <code>private final Handle&lt;Entry&gt; handle</code> ф╜ЖцШпхН┤швлхблхЕЕф║Ж 3 ф╕кхнЧшКВуАВш┐ЩцШпф╕║ф╗Аф╣ИхСвя╝Я</p> <p>ца╣цНохнЧцо╡щЗНцОТхИЧшзДхИЩ1я╝Ъх╝ХчФихнЧцо╡ <code>private final Handle&lt;Entry&gt; handle</code> хНачФи 4 ф╕кхнЧшКВя╝Их╝АхРпхОЛч╝йцМЗщТИчЪДцГЕхЖ╡я╝Йя╝МцЙАф╗ещЬАшжБхп╣щ╜РшЗ│4чЪДхАНцХ░уАВцЙАф╗ещЬАшжБхблхЕЕ3ф╕кхнЧшКВя╝Мф╜┐х╛Чх╝ХчФихнЧцо╡ <code>private final Handle&lt;Entry&gt; handle</code> ф╜Нф║О OFFSET = 40 хдДуАВ</p> <p><strong>ца╣цНоф╗еф╕Кш┐Щф║ЫшзДхИЩцЬАч╗ИшобчоЧхЗ║цЭехЬих╝АхРпхОЛч╝йцМЗщТИчЪДцГЕхЖ╡ф╕ЛEntryхп╣ш▒бхЬихаЖф╕нхНачФихЖЕхнШхдзх░Пф╕║64хнЧшКВ</strong></p> <h4 id="хЕ│щЧнцМЗщТИхОЛч╝й-xx-usecompressedoops"><a href="#хЕ│щЧнцМЗщТИхОЛч╝й-xx-usecompressedoops" class="header-anchor">#</a> хЕ│щЧнцМЗщТИхОЛч╝й -XX:-UseCompressedOops</h4> <p>хЬихИЖцЮРхоМ Entry хп╣ш▒бхЬих╝АхРпхОЛч╝йцМЗщТИцГЕхЖ╡ф╕ЛчЪДхЖЕхнШх╕Гх▒АцГЕхЖ╡хРОя╝МцИСцГ│хдзхо╢чО░хЬихп╣хЙНш╛╣ф╗Лч╗НчЪДхнЧцо╡щЗНцОТхИЧчЪДф╕Йф╕кшзДхИЩчРЖшзгцЫ┤хКац╕ЕцЩ░ф║Жя╝МщВгф╣ИцИСф╗мхЯ║ф║Ош┐Щф╕кхЯ║чбАцЭехИЖцЮРф╕ЛхЬихЕ│щЧнхОЛч╝йцМЗщТИчЪДцГЕхЖ╡ф╕Л Entry хп╣ш▒бчЪДхЖЕхнШх╕Гх▒АуАВ</p> <p>![хЫ╛чЙЗ](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>щжЦхЕИ Entry хп╣ш▒бхЬихЖЕхнШх╕Гх▒Аф╕нчЪДх╝Ахд┤ф╛ЭчД╢цШпчФ▒ 8 ф╕кхнЧшКВчЪД MarkWord ш┐ШцЬЙ 8 ф╕кхнЧшКВчЪДч▒╗хЮЛцМЗщТИя╝ИхЕ│щЧнхОЛч╝йцМЗщТИя╝Йч╗ДцИРчЪДхп╣ш▒бхд┤уАВ</p> <p>цИСф╗мчЬЛхИ░хЬи OFFSET = 41 хдДхПСчФЯф║ЖхнЧшКВхблхЕЕя╝МхОЯхЫацШпхЬихЕ│щЧнхОЛч╝йцМЗщТИчЪДцГЕхЖ╡ф╕Ля╝Мхп╣ш▒бх╝ХчФихНачФихЖЕхнШхдзх░ПхПШф╕║ 8 ф╕кхнЧшКВя╝Мца╣цНошзДхИЩ1: х╝ХчФихнЧцо╡ <code>private final Handle&lt;Entry&gt; handle</code> чЪД OFFET щЬАшжБхп╣щ╜РшЗ│ 8 чЪДхАНцХ░я╝МцЙАф╗ещЬАшжБхЬишпех╝ХчФихнЧцо╡ф╣ЛхЙНхблхЕЕ 7 ф╕кхнЧшКВя╝Мф╜┐х╛Чх╝ХчФихнЧцо╡ <code>private final Handle&lt;Entry&gt; handle</code> чЪДOFFET = 48 уАВ</p> <p><strong>ч╗╝хРИхнЧцо╡щЗНцОТхИЧчЪДф╕Йф╕кшзДхИЩцЬАч╗ИшобчоЧхЗ║цЭехЬихЕ│щЧнхОЛч╝йцМЗщТИчЪДцГЕхЖ╡ф╕ЛEntryхп╣ш▒бхЬихаЖф╕нхНачФихЖЕхнШхдзх░Пф╕║96хнЧшКВ</strong></p> <h3 id="_3-3-5-хРСchanneloutboundbufferф╕нч╝УхнШх╛ЕхПСщАБцХ░цНо"><a href="#_3-3-5-хРСchanneloutboundbufferф╕нч╝УхнШх╛ЕхПСщАБцХ░цНо" class="header-anchor">#</a> 3.3.5 хРСChannelOutboundBufferф╕нч╝УхнШх╛ЕхПСщАБцХ░цНо</h3> <p>хЬиф╗Лч╗НхоМ ChannelOutboundBuffer чЪДхЯ║цЬмч╗УцЮДф╣ЛхРОя╝Мф╕ЛщЭвх░▒цЭехИ░ф║Ж Netty хдДчРЖ write ф║Лф╗╢чЪДцЬАхРОф╕Ацнея╝МцИСф╗мцЭечЬЛф╕ЛчФицИ╖чЪДх╛ЕхПСщАБцХ░цНоцШпхжВф╜Хшвлц╖╗хКаш┐Ы ChannelOutboundBuffer ф╕нчЪДуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addMessage</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Entry</span> entry <span class="token operator">=</span> <span class="token class-name">Entry</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token function">total</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tailEntry <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        flushedEntry <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">Entry</span> tail <span class="token operator">=</span> tailEntry<span class="token punctuation">;</span>
        tail<span class="token punctuation">.</span>next <span class="token operator">=</span> entry<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    tailEntry <span class="token operator">=</span> entry<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>unflushedEntry <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        unflushedEntry <span class="token operator">=</span> entry<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">incrementPendingOutboundBytes</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>pendingSize<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_3-3-5-1-хИЫх╗║entryхп╣ш▒бцЭех░БшгЕх╛ЕхПСщАБцХ░цНоф┐бцБп"><a href="#_3-3-5-1-хИЫх╗║entryхп╣ш▒бцЭех░БшгЕх╛ЕхПСщАБцХ░цНоф┐бцБп" class="header-anchor">#</a> 3.3.5.1 хИЫх╗║Entryхп╣ш▒бцЭех░БшгЕх╛ЕхПСщАБцХ░цНоф┐бцБп</h4> <p>щАЪш┐ЗхЙНш╛╣чЪДф╗Лч╗НцИСф╗мф║ЖшзгхИ░х╜УчФицИ╖ш░ГчФи ctx.write(msg) ф╣ЛхРОя╝Мwrite ф║Лф╗╢х╝АхзЛхЬиpipelineф╕нф╗Ох╜УхЙН ChannelHandlerх╝АхзЛф╕АчЫ┤хРСхЙНш┐ЫшбМф╝ацТня╝МцЬАч╗ИхЬи HeadContext ф╕нх░Жх╛ЕхПСщАБцХ░цНохЖЩхЕехИ░ channel хп╣х║ФчЪДхЖЩч╝УхЖ▓хМ║ ChannelOutboundBuffer ф╕нуАВ</p> <p>шАМ ChannelOutboundBuffer цШпчФ▒ Entry ч╗УцЮДч╗ДцИРчЪДф╕Аф╕кхНХщУ╛шбия╝МEntry ч╗УцЮДх░БшгЕф║ЖчФицИ╖х╛ЕхПСщАБцХ░цНочЪДхРДчзНф┐бцБпуАВ</p> <p>ш┐ЩщЗМщжЦхЕИцИСф╗мщЬАшжБф╕║х╛ЕхПСщАБцХ░цНохИЫх╗║ Entry хп╣ш▒бя╝МшАМхЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484419&amp;idx=1&amp;sn=3a75a495f0f117cca1548da1e0f3e6e6&amp;chksm=ce77c244f9004b52d74b8ffce149ea64e5a8f0ba6713b105d003fdaef8eaa9ad3a5a65d20427&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКшпжшзгRecyclerхп╣ш▒бц▒ачЪДч▓╛хжЩшо╛шобф╕ОхоЮчО░уАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕АцЦЗф╕нцИСф╗мф╗Лч╗Нхп╣ш▒бц▒ацЧ╢я╝МцПРхИ░ Netty ф╜Ьф╕║ф╕Аф╕кщлШцАзшГ╜щлШхРЮхРРчЪДч╜Сч╗ЬцбЖцЮ╢шжБщЭвхп╣ц╡╖щЗПчЪД IO хдДчРЖцУНф╜Ья╝Мш┐ЩчзНхЬ║цЩпф╕Лф╝ЪщвСч╣БчЪДхИЫх╗║хдзщЗПчЪД Entry хп╣ш▒бя╝МшАМхп╣ш▒бчЪДхИЫх╗║хПКхЕ╢хЫЮцФ╢цЧ╢щЬАшжБцАзшГ╜х╝АщФАчЪДя╝Мх░дхЕ╢цШпхЬищЭвхп╣хдзщЗПщвСч╣БчЪДхИЫх╗║хп╣ш▒бхЬ║цЩпф╕Ля╝Мш┐ЩчзНх╝АщФАф╝Ъш┐Ыф╕АцнешвлцФ╛хдзя╝МцЙАф╗е Netty х╝ХхЕеф║Жхп╣ш▒бц▒ацЭечобчРЖ Entry хп╣ш▒бхоЮф╛Лф╗ОшАМщБ┐хЕН Entry хп╣ш▒бщвСч╣БхИЫх╗║ф╗ехПК GC х╕жцЭечЪДцАзшГ╜х╝АщФАуАВ</p> <p>цЧвчД╢ Entry хп╣ш▒бх╖▓ч╗Пшвлхп╣ш▒бц▒ацОечобя╝МщВгф╣ИхоГхЬихп╣ш▒бц▒ахдЦщЭвцШпф╕НшГ╜швлчЫ┤цОехИЫх╗║чЪДя╝МхЕ╢цЮДщАахЗ╜цХ░цШпчзБцЬЙч▒╗хЮЛя╝Мх╣╢цПРф╛Ыф╕Аф╕кщЭЩцАБцЦ╣ц│Х newInstance ф╛ЫхдЦщГич║┐чиЛф╗Охп╣ш▒бц▒аф╕ншО╖хПЦ Entry хп╣ш▒буАВш┐ЩхЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484419&amp;idx=1&amp;sn=3a75a495f0f117cca1548da1e0f3e6e6&amp;chksm=ce77c244f9004b52d74b8ffce149ea64e5a8f0ba6713b105d003fdaef8eaa9ad3a5a65d20427&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКшпжшзгRecyclerхп╣ш▒бц▒ачЪДч▓╛хжЩшо╛шобф╕ОхоЮчО░уАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕АцЦЗф╕нф╗Лч╗Нц▒ахМЦхп╣ш▒бчЪДшо╛шобцЧ╢ф╣ЯцЬЙцПРхИ░ш┐ЗуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Entry</span> <span class="token punctuation">{</span>
    <span class="token comment">//щЭЩцАБхПШщЗПх╝ХчФич▒╗хЮЛхЬ░хЭА ш┐Щф╕кцШпхЬиKlass Point(ч▒╗хЮЛцМЗщТИ)ф╕нхоЪф╣Й 8хнЧшКВя╝Их╝АхРпцМЗщТИхОЛч╝й ф╕║4хнЧшКВя╝Й</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ObjectPool</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&gt;</span></span> <span class="token constant">RECYCLER</span> <span class="token operator">=</span> <span class="token class-name">ObjectPool</span><span class="token punctuation">.</span><span class="token function">newPool</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ObjectCreator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Entry</span> <span class="token function">newObject</span><span class="token punctuation">(</span><span class="token class-name">Handle</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&gt;</span></span> handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//Entryхп╣ш▒бхПкшГ╜щАЪш┐Зхп╣ш▒бц▒ашО╖хПЦя╝Мф╕НхПпхдЦщГишЗкшбМхИЫх╗║</span>
    <span class="token keyword">private</span> <span class="token class-name">Entry</span><span class="token punctuation">(</span><span class="token class-name">Handle</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&gt;</span></span> handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>handle <span class="token operator">=</span> handle<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//ф╕НшАГшЩСцМЗщТИхОЛч╝йчЪДхдзх░П entryхп╣ш▒бхЬихаЖф╕нхНачФичЪДхЖЕхнШхдзх░Пф╕║96</span>
    <span class="token comment">//хжВцЮЬх╝АхРпцМЗщТИхОЛч╝йя╝Мentryхп╣ш▒бхЬихаЖф╕нхНачФичЪДхЖЕхнШхдзх░П ф╝ЪцШп64  </span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CHANNEL_OUTBOUND_BUFFER_ENTRY_OVERHEAD</span> <span class="token operator">=</span>
        <span class="token class-name">SystemPropertyUtil</span><span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">&quot;io.netty.transport.outboundBufferEntrySizeOverhead&quot;</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token class-name">Entry</span> <span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span> <span class="token keyword">long</span> total<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Entry</span> entry <span class="token operator">=</span> <span class="token constant">RECYCLER</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        entry<span class="token punctuation">.</span>msg <span class="token operator">=</span> msg<span class="token punctuation">;</span>
        <span class="token comment">//х╛ЕхПСцХ░цНоцХ░цНохдзх░П + entryхп╣ш▒бхдзх░П</span>
        entry<span class="token punctuation">.</span>pendingSize <span class="token operator">=</span> size <span class="token operator">+</span> <span class="token constant">CHANNEL_OUTBOUND_BUFFER_ENTRY_OVERHEAD</span><span class="token punctuation">;</span>
        entry<span class="token punctuation">.</span>total <span class="token operator">=</span> total<span class="token punctuation">;</span>
        entry<span class="token punctuation">.</span>promise <span class="token operator">=</span> promise<span class="token punctuation">;</span>
        <span class="token keyword">return</span> entry<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token punctuation">}</span>
</code></pre></div><ol><li>щАЪш┐Зц▒ахМЦхп╣ш▒б Entry ф╕нцМБцЬЙчЪДхп╣ш▒бц▒а RECYCLER я╝Мф╗Охп╣ш▒бц▒аф╕ншО╖хПЦ Entry хп╣ш▒бхоЮф╛ЛуАВ</li> <li>х░ЖчФицИ╖х╛ЕхПСщАБцХ░цНо msgя╝ИDirectByteBufferя╝Йя╝Мх╛ЕхПСщАБцХ░цНохдзх░Пя╝Ъtotal я╝МцЬмцмбхПСщАБцХ░цНочЪД channelFutureя╝Мф╗ехПКшпе Entry хп╣ш▒бчЪД pendingSize ч╗Яч╗Ях░БшгЕхЬи Entry хп╣ш▒бхоЮф╛ЛчЪДчЫ╕х║ФхнЧцо╡ф╕нуАВ</li></ol> <p>ш┐ЩщЗМщЬАшжБчЙ╣цоКшп┤цШОф╕АчВ╣чЪДцШпхЕ│ф║О pendingSize чЪДшобчоЧцЦ╣х╝Пя╝Мф╣ЛхЙНцИСф╗мцПРхИ░ pendingSize ф╕нцЙАшобчоЧчЪДхЖЕхнШхНачФиф╕АхЕ▒хМЕхРлф╕дщГихИЖя╝Ъ</p> <ul><li>х╛ЕхПСщАБч╜Сч╗ЬцХ░цНохдзх░П</li> <li>Entry хп╣ш▒бцЬмш║лхЬихЖЕхнШф╕нчЪДхНачФищЗП</li></ul> <p>![хЫ╛чЙЗ](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)EntryхЖЕхнШхНачФицА╗щЗП.png</p> <p>шАМхЬиуАК3.3.4 EntryхоЮф╛Лхп╣ш▒бхЬиJVMф╕нхНачФихЖЕхнШхдзх░ПуАЛх░ПшКВф╕нцИСф╗мф╗Лч╗НхИ░я╝МEntry хп╣ш▒бхЬихЖЕхнШф╕нчЪДхНачФихдзх░ПхЬих╝АхРпхОЛч╝йцМЗщТИчЪДцГЕхЖ╡ф╕Ля╝И-XX:+UseCompressedOopsя╝ЙхНачФи 64 хнЧшКВя╝МхЬихЕ│щЧнхОЛч╝йцМЗщТИчЪДцГЕхЖ╡ф╕Ля╝И-XX:-UseCompressedOopsя╝ЙхНачФи 96 хнЧшКВуАВ</p> <p>хнЧцо╡ <code>CHANNEL_OUTBOUND_BUFFER_ENTRY_OVERHEAD</code> шбичд║чЪДх░▒цШп Entry хп╣ш▒бхЬихЖЕхнШф╕нчЪДхНачФихдзх░Пя╝МNettyш┐ЩщЗМщ╗ШшодцШп 96 хнЧшКВя╝Мх╜УчД╢хжВцЮЬцИСф╗мчЪДх║ФчФичиЛх║Пх╝АхРпф║ЖцМЗщТИхОЛч╝йя╝МцИСф╗мхПпф╗ещАЪш┐З JVM хРпхКихПВцХ░ <code>-D io.netty.transport.outboundBufferEntrySizeOverhead</code> цМЗхоЪф╕║ 64 хнЧшКВуАВ</p> <h4 id="_3-3-5-2-х░Жentryхп╣ш▒бц╖╗хКаш┐Ыchanneloutboundbufferф╕н"><a href="#_3-3-5-2-х░Жentryхп╣ш▒бц╖╗хКаш┐Ыchanneloutboundbufferф╕н" class="header-anchor">#</a> 3.3.5.2 х░ЖEntryхп╣ш▒бц╖╗хКаш┐ЫChannelOutboundBufferф╕н</h4> <p>![хЫ╛чЙЗ](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)ChannelOutboundBufferч╗УцЮД.png</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>tailEntry <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    flushedEntry <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token class-name">Entry</span> tail <span class="token operator">=</span> tailEntry<span class="token punctuation">;</span>
    tail<span class="token punctuation">.</span>next <span class="token operator">=</span> entry<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
tailEntry <span class="token operator">=</span> entry<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>unflushedEntry <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unflushedEntry <span class="token operator">=</span> entry<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хЬиуАК3.3 ChannelOutboundBufferуАЛх░ПшКВф╕Ах╝АхзЛя╝МцИСф╗мф╗Лч╗Нф║Ж ChannelOutboundBuffer ф╕нцЬАщЗНшжБчЪДф╕Йф╕кцМЗщТИя╝Мш┐ЩщЗМц╢ЙхПКхИ░чЪДф╕дф╕кцМЗщТИхИЖхИлцШпя╝Ъ</p> <ul><li><code>unflushedEntry</code> я╝ЪцМЗхРС ChannelOutboundBuffer ф╕нчммф╕Аф╕кцЬкшвл flush ш┐Ы Socket чЪДх╛ЕхПСщАБцХ░цНоуАВчФицЭецМЗчд║ ChannelOutboundBuffer чЪДчммф╕Аф╕кшКВчВ╣уАВ</li> <li><code>tailEntry</code>я╝ЪцМЗхРС ChannelOutboundBuffer ф╕нцЬАхРОф╕Аф╕кшКВчВ╣уАВ</li></ul> <p>щАЪш┐З unflushedEntry хТМ tailEntry хПпф╗ехоЪф╜НхЗ║х╛ЕхПСщАБцХ░цНочЪДшМГхЫ┤уАВChannel ф╕нчЪДцпПф╕Ацмб write ф║Лф╗╢я╝МцЬАч╗ИщГ╜ф╝Ъх░Жх╛ЕхПСщАБцХ░цНоцПТхЕехИ░ ChannelOutboundBuffer чЪДх░╛ч╗УчВ╣хдДуАВ</p> <h4 id="_3-3-5-3-incrementpendingoutboundbytes"><a href="#_3-3-5-3-incrementpendingoutboundbytes" class="header-anchor">#</a> 3.3.5.3 incrementPendingOutboundBytes</h4> <p>хЬих░Ж Entry хп╣ш▒бц╖╗хКаш┐Ы ChannelOutboundBuffer ф╣ЛхРОя╝Мх░▒щЬАшжБцЫ┤цЦ░чФиф║Ошо░х╜Хх╜УхЙН ChannelOutboundBuffer ф╕нхЕ│ф║Ох╛ЕхПСщАБцХ░цНоцЙАхНахЖЕхнШцА╗щЗПчЪДц░┤ф╜Нч║┐цМЗчд║уАВ</p> <p>хжВцЮЬцЫ┤цЦ░хРОчЪДц░┤ф╜Нч║┐ш╢Еш┐Зф║Ж Netty цМЗхоЪчЪДщлШц░┤ф╜Нч║┐ <code>DEFAULT_HIGH_WATER_MARK = 64 * 1024</code>я╝МхИЩщЬАшжБх░Жх╜УхЙН Channel чЪДчК╢цАБшо╛ч╜оф╕║ф╕НхПпхЖЩя╝Мх╣╢хЬи pipeline ф╕нф╝ацТн ChannelWritabilityChanged ф║Лф╗╢я╝Мц│ицДПшпеф║Лф╗╢цШпф╕Аф╕к inbound ф║Лф╗╢уАВ</p> <p>![хЫ╛чЙЗ](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)хУНх║ФchannelWritabilityChangedф║Лф╗╢.png</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ChannelOutboundBuffer</span> <span class="token punctuation">{</span>

    <span class="token comment">//ChannelOutboundBufferф╕нчЪДх╛ЕхПСщАБцХ░цНочЪДхЖЕхнШхНачФицА╗щЗП : цЙАцЬЙEntryхп╣ш▒бцЬмш║лцЙАхНачФихЖЕхнШхдзх░П + цЙАцЬЙх╛ЕхПСщАБцХ░цНочЪДхдзх░П</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> totalPendingSize<span class="token punctuation">;</span>

    <span class="token comment">//ц░┤ф╜Нч║┐цМЗщТИ</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AtomicLongFieldUpdater</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelOutboundBuffer</span><span class="token punctuation">&gt;</span></span> <span class="token constant">TOTAL_PENDING_SIZE_UPDATER</span> <span class="token operator">=</span>
        <span class="token class-name">AtomicLongFieldUpdater</span><span class="token punctuation">.</span><span class="token function">newUpdater</span><span class="token punctuation">(</span><span class="token class-name">ChannelOutboundBuffer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;totalPendingSize&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">incrementPendingOutboundBytes</span><span class="token punctuation">(</span><span class="token keyword">long</span> size<span class="token punctuation">,</span> <span class="token keyword">boolean</span> invokeLater<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//цЫ┤цЦ░цА╗хЕ▒х╛ЕхЖЩхЕецХ░цНочЪДхдзх░П</span>
        <span class="token keyword">long</span> newWriteBufferSize <span class="token operator">=</span> <span class="token constant">TOTAL_PENDING_SIZE_UPDATER</span><span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//хжВцЮЬх╛ЕхЖЩхЕечЪДцХ░цНо хдзф║О щлШц░┤ф╜Нч║┐ 64 * 1024  хИЩшо╛ч╜ох╜УхЙНchannelф╕║ф╕НхПпхЖЩ чФ▒чФицИ╖шЗкх╖▒хЖ│хоЪцШпхРжч╗зч╗нхЖЩхЕе</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newWriteBufferSize <span class="token operator">&gt;</span> channel<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWriteBufferHighWaterMark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//шо╛ч╜ох╜УхЙНchannelчК╢цАБф╕║ф╕НхПпхЖЩя╝Мх╣╢шзжхПСfireChannelWritabilityChangedф║Лф╗╢</span>
            <span class="token function">setUnwritable</span><span class="token punctuation">(</span>invokeLater<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>volatile хЕ│щФохнЧхЬи Java хЖЕхнШцибхЮЛф╕нхПкшГ╜ф┐ЭшпБхПШщЗПчЪДхПпшзБцАзя╝Мф╗ехПКчжБцнвцМЗф╗дщЗНцОТх║ПуАВф╜ЖцЧац│Хф┐ЭшпБхдЪч║┐чиЛцЫ┤цЦ░чЪДхОЯхнРцАзя╝Мш┐ЩщЗМцИСф╗мхПпф╗ещАЪш┐ЗAtomicLongFieldUpdater цЭех╕охКй totalPendingSize хнЧцо╡хоЮчО░хОЯхнРцАзчЪДцЫ┤цЦ░уАВ</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 0шбичд║channelхПпхЖЩя╝М1шбичд║channelф╕НхПпхЖЩ</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> unwritable<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AtomicIntegerFieldUpdater</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelOutboundBuffer</span><span class="token punctuation">&gt;</span></span> <span class="token constant">UNWRITABLE_UPDATER</span> <span class="token operator">=</span>
    <span class="token class-name">AtomicIntegerFieldUpdater</span><span class="token punctuation">.</span><span class="token function">newUpdater</span><span class="token punctuation">(</span><span class="token class-name">ChannelOutboundBuffer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;unwritable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setUnwritable</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> invokeLater<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> oldValue <span class="token operator">=</span> unwritable<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> newValue <span class="token operator">=</span> oldValue <span class="token operator">|</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">UNWRITABLE_UPDATER</span><span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldValue <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//шзжхПСfireChannelWritabilityChangedф║Лф╗╢ шбичд║х╜УхЙНchannelхПШф╕║ф╕НхПпхЖЩ</span>
                <span class="token function">fireChannelWritabilityChanged</span><span class="token punctuation">(</span>invokeLater<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>х╜У ChannelOutboundBuffer ф╕нчЪДхЖЕхнШхНачФиц░┤ф╜Нч║┐ totalPendingSize х╖▓ч╗Пш╢Еш┐ЗщлШц░┤ф╜Нч║┐цЧ╢я╝Мш░ГчФишпецЦ╣ц│Хх░Жх╜УхЙН Channel чЪДчК╢цАБшо╛ч╜оф╕║ф╕НхПпхЖЩчК╢цАБуАВ</p> <blockquote><p>unwritable == 0 шбичд║х╜УхЙНchannelхПпхЖЩя╝Мunwritable == 1 шбичд║х╜УхЙНchannelф╕НхПпхЖЩуАВ</p></blockquote> <p>channel хПпф╗ещАЪш┐Зш░ГчФи isWritable цЦ╣ц│ХцЭехИдцЦншЗкш║лх╜УхЙНчК╢цАБцШпхРжхПпхЖЩуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isWritable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> unwritable <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>х╜У Channel чЪДчК╢цАБцШпщжЦцмбф╗ОхПпхЖЩчК╢цАБхПШф╕║ф╕НхПпхЖЩчК╢цАБцЧ╢я╝Мх░▒ф╝ЪхЬи channel хп╣х║ФчЪД pipeline ф╕нф╝ацТн ChannelWritabilityChanged ф║Лф╗╢уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">fireChannelWritabilityChanged</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> invokeLater<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>invokeLater<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Runnable</span> task <span class="token operator">=</span> fireChannelWritabilityChangedTask<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fireChannelWritabilityChangedTask <span class="token operator">=</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    pipeline<span class="token punctuation">.</span><span class="token function">fireChannelWritabilityChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        channel<span class="token punctuation">.</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        pipeline<span class="token punctuation">.</span><span class="token function">fireChannelWritabilityChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>чФицИ╖хПпф╗ехЬишЗкхоЪф╣ЙчЪД ChannelHandler ф╕нхоЮчО░ channelWritabilityChanged ф║Лф╗╢хЫЮш░ГцЦ╣ц│Хя╝МцЭещТИхп╣ Channel чЪДхПпхЖЩчК╢цАБхПШхМЦхБЪхЗ║ф╕НхРМчЪДхдДчРЖуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelWritabilityChanged</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isWritable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>х╜УхЙНchannelхПпхЖЩ<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>х╜УхЙНchannelф╕НхПпхЖЩ<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>хИ░ш┐ЩщЗМ write ф║Лф╗╢хЬи pipeline ф╕нчЪДф╝ацТня╝МчмФшАЕх░▒ф╕║хдзхо╢ф╗Лч╗НхоМф║Жя╝Мф╕ЛщЭвцИСф╗мцЭечЬЛф╕ЛхПжф╕Аф╕кщЗНшжБчЪД flush ф║Лф╗╢чЪДхдДчРЖш┐ЗчиЛуАВ</p> <h2 id="_4-flush"><a href="#_4-flush" class="header-anchor">#</a> 4. flush</h2> <p>ф╗ОхЙНщЭв Netty хп╣ write ф║Лф╗╢чЪДхдДчРЖш┐ЗчиЛф╕ня╝МцИСф╗мхПпф╗ечЬЛхИ░х╜УчФицИ╖ш░ГчФи ctx.write(msg) цЦ╣ц│Хф╣ЛхРОя╝МNetty хПкцШпх░ЖчФицИ╖шжБхПСщАБчЪДцХ░цНоф╕┤цЧ╢хЖЩхИ░ channel хп╣х║ФчЪДх╛ЕхПСщАБч╝УхЖ▓щШЯхИЧ ChannelOutboundBuffer ф╕ня╝МчД╢шАМх╣╢ф╕Нф╝Ъх░ЖцХ░цНохЖЩхЕе Socket ф╕нуАВ</p> <p>шАМх╜Уф╕Ацмб read ф║Лф╗╢хоМцИРф╣ЛхРОя╝МцИСф╗мф╝Ъш░ГчФи ctx.flush() цЦ╣ц│Хх░Ж ChannelOutboundBuffer ф╕нчЪДх╛ЕхПСщАБцХ░цНохЖЩхЕе Socket ф╕нчЪДхПСщАБч╝УхЖ▓хМ║ф╕ня╝Мф╗ОшАМх░ЖцХ░цНохПСщАБхЗ║хО╗уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelReadComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//цЬмцмбOP_READф║Лф╗╢хдДчРЖхоМцпХ</span>
        ctx<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-1-flushф║Лф╗╢чЪДф╝ацТн"><a href="#_4-1-flushф║Лф╗╢чЪДф╝ацТн" class="header-anchor">#</a> 4.1 flushф║Лф╗╢чЪДф╝ацТн</h3> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZwcdibKiceeWADsv1WFuEtvGFmptNuug6aLYJAs07c8dI3kylenu64goxtX7WlmUXPMRAdPOjbbAZw/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="хЫ╛чЙЗ">pipelineч╗УцЮД.png</p> <p>flush ф║Лф╗╢хТМ write ф║Лф╗╢ф╕Аца╖щГ╜цШп oubound ф║Лф╗╢я╝МцЙАф╗ехоГф╗мчЪДф╝ацТнцЦ╣хРСщГ╜цШпф╗ОхРОх╛АхЙНхЬи pipeline ф╕нф╝ацТнуАВ</p> <p>шзжхПС flush ф║Лф╗╢ф╝ацТнчЪДхРМца╖ф╣ЯцЬЙф╕дф╕кцЦ╣ц│Хя╝Ъ</p> <ul><li><code>channelHandlerContext.flush()</code>я╝Ъflushф║Лф╗╢ф╝Ъф╗Ох╜УхЙН channelHandler х╝АхзЛхЬи pipeline ф╕нхРСхЙНф╝ацТнчЫ┤хИ░ headContextуАВ</li> <li><code>channelHandlerContext.channel().flush()</code>я╝Ъflush ф║Лф╗╢ф╝Ъф╗О pipeline чЪДх░╛ч╗УчВ╣ tailContext хдДх╝АхзЛхРСхЙНф╝ацТнчЫ┤хИ░ headContextуАВ</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractChannelHandlerContext</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">,</span> <span class="token class-name">ResourceLeakHint</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ChannelHandlerContext</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//хРСхЙНцЯецЙ╛шжЖчЫЦflushцЦ╣ц│ХчЪДOutboundч▒╗хЮЛчЪДChannelHandler</span>
        <span class="token keyword">final</span> <span class="token class-name">AbstractChannelHandlerContext</span> next <span class="token operator">=</span> <span class="token function">findContextOutbound</span><span class="token punctuation">(</span><span class="token constant">MASK_FLUSH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//шО╖хПЦцЙзшбМChannelHandlerчЪДexecutor,хЬихИЭхзЛхМЦpipelineчЪДцЧ╢хАЩшо╛ч╜оя╝Мщ╗Шшодф╕║Reactorч║┐чиЛ</span>
        <span class="token class-name">EventExecutor</span> executor <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>executor<span class="token punctuation">.</span><span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            next<span class="token punctuation">.</span><span class="token function">invokeFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">Tasks</span> tasks <span class="token operator">=</span> next<span class="token punctuation">.</span>invokeTasks<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tasks <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                next<span class="token punctuation">.</span>invokeTasks <span class="token operator">=</span> tasks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tasks</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">safeExecute</span><span class="token punctuation">(</span>executor<span class="token punctuation">,</span> tasks<span class="token punctuation">.</span>invokeFlushTask<span class="token punctuation">,</span> <span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">voidPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>ш┐ЩщЗМчЪДщА╗ш╛СхТМ write ф║Лф╗╢ф╝ацТнчЪДщА╗ш╛СхЯ║цЬмф╕Аца╖я╝Мф╣ЯцШпщжЦхЕИщАЪш┐ЗfindContextOutbound(MASK_FLUSH)  цЦ╣ц│Хф╗Ох╜УхЙН ChannelHandler х╝АхзЛф╗О pipeline ф╕нхРСхЙНцЯецЙ╛хЗ║чммф╕Аф╕к ChannelOutboundHandler ч▒╗хЮЛчЪДх╣╢ф╕ФхоЮчО░ flush ф║Лф╗╢хЫЮш░ГцЦ╣ц│ХчЪД ChannelHandler уАВц│ицДПш┐ЩщЗМф╝ахЕечЪДцЙзшбМш╡Дца╝цОйчаБф╕║ MASK_FLUSHуАВ</p> <p>цЙзшбМChannelHandlerф╕нф║Лф╗╢хЫЮш░ГцЦ╣ц│ХчЪДч║┐чиЛх┐Ещб╗цШпщАЪш┐З<code>pipeline#addLast(EventExecutorGroup group, ChannelHandler... handlers)</code>ф╕║ ChannelHandler цМЗхоЪчЪД executorуАВхжВцЮЬф╕НцМЗхоЪя╝Мщ╗ШшодчЪД executor ф╕║ channel ч╗СхоЪчЪД  reactor ч║┐чиЛуАВ</p> <p>хжВцЮЬх╜УхЙНч║┐чиЛф╕НцШп ChannelHandler цМЗхоЪчЪД executorя╝МхИЩщЬАшжБх░Ж invokeFlush() цЦ╣ц│ХчЪДш░ГчФих░БшгЕцИР Task ф║дч╗ЩцМЗхоЪчЪД executor цЙзшбМуАВ</p> <h3 id="_4-1-1-шзжхПСnextchannelhandlerчЪДflushцЦ╣ц│ХхЫЮш░Г"><a href="#_4-1-1-шзжхПСnextchannelhandlerчЪДflushцЦ╣ц│ХхЫЮш░Г" class="header-anchor">#</a> 4.1.1 шзжхПСnextChannelHandlerчЪДflushцЦ╣ц│ХхЫЮш░Г</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">invokeHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">invokeFlush0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//хжВцЮЬшпеChannelHandlerх╣╢ц▓бцЬЙхКахЕехИ░pipelineф╕нхИЩч╗зч╗нхРСхЙНф╝ащАТflushф║Лф╗╢</span>
        <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ш┐ЩщЗМхТМ write ф║Лф╗╢чЪДчЫ╕хЕ│хдДчРЖф╕Аца╖я╝МщжЦхЕИф╣ЯцШпщЬАшжБш░ГчФи invokeHandler() цЦ╣ц│ХцЭехИдцЦнш┐Щф╕к nextChannelHandler цШпхРжхЬи pipeline ф╕ншвлцнгчбочЪДхИЭхзЛхМЦуАВ</p> <p>хжВцЮЬ nextChannelHandler ф╕нчЪД handlerAdded цЦ╣ц│Хх╣╢ц▓бцЬЙшвлхЫЮш░Гш┐Зя╝МщВгф╣Иш┐ЩщЗМх░▒хПкшГ╜ш╖│ш┐З nextChannelHandlerя╝Мх╣╢ш░ГчФи ChannelHandlerContext#flush цЦ╣ц│Хч╗зч╗нхРСхЙНф╝ацТнflushф║Лф╗╢уАВ</p> <p>хжВцЮЬ nextChannelHandler ф╕нчЪД handlerAdded цЦ╣ц│Хх╖▓ч╗ПшвлхЫЮш░Гш┐Зя╝Мшп┤цШО nextChannelHandler хЬи pipeline ф╕нх╖▓ч╗ПшвлцнгчбочЪДхИЭхзЛхМЦхе╜я╝МхИЩчЫ┤цОеш░ГчФиnextChannelHandler чЪД flush ф║Лф╗╢хЫЮш░ГцЦ╣ц│ХуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeFlush0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ChannelOutboundHandler</span><span class="token punctuation">)</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">invokeExceptionCaught</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ш┐ЩщЗМцЬЙф╕АчВ╣хТМ write ф║Лф╗╢хдДчРЖф╕НхРМчЪДцШпя╝Мх╜Уш░ГчФи nextChannelHandler чЪД flush хЫЮш░ГхЗ║чО░х╝Вх╕╕чЪДцЧ╢хАЩя╝Мф╝ЪшзжхПС nextChannelHandler чЪД exceptionCaught хЫЮш░ГуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeExceptionCaught</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">invokeHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exceptionCaught</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЫ╕хЕ│цЧех┐ЧцЙУхН░<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЫ╕хЕ│цЧех┐ЧцЙУхН░<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">fireExceptionCaught</span><span class="token punctuation">(</span>cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>шАМхЕ╢ф╗Ц outbound ч▒╗ф║Лф╗╢цпФхжВ write ф║Лф╗╢хЬиф╝ацТнчЪДш┐ЗчиЛф╕нхПСчФЯх╝Вх╕╕я╝МхПкцШпхЫЮш░ГщАЪчЯечЫ╕хЕ│чЪД ChannelFutureуАВх╣╢ф╕Нф╝ЪшзжхПС exceptionCaught ф║Лф╗╢чЪДф╝ацТнуАВ</p> <h3 id="_4-2-flushф║Лф╗╢чЪДхдДчРЖ"><a href="#_4-2-flushф║Лф╗╢чЪДхдДчРЖ" class="header-anchor">#</a> 4.2 flushф║Лф╗╢чЪДхдДчРЖ</h3> <p>![хЫ╛чЙЗ](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)ховцИ╖члпchannel pipelineч╗УцЮД.png</p> <p>цЬАч╗Иflushф║Лф╗╢ф╝ЪхЬиpipelineф╕нф╕АчЫ┤хРСхЙНф╝ацТншЗ│HeadContextф╕ня╝Мх╣╢хЬи HeadContext щЗМш░ГчФи channel чЪД unsafe ч▒╗хоМцИР flush ф║Лф╗╢чЪДцЬАч╗ИхдДчРЖщА╗ш╛СуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HeadContext</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractChannelHandlerContext</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        unsafe<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>ф╕ЛщЭвх░▒чЬЯцнгхИ░ф║Ж Netty хдДчРЖ flush ф║Лф╗╢чЪДхЬ░цЦ╣уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractUnsafe</span> <span class="token keyword">implements</span> <span class="token class-name">Unsafe</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">assertEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ChannelOutboundBuffer</span> outboundBuffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>outboundBuffer<span class="token punctuation">;</span>
        <span class="token comment">//channelф╗ехЕ│щЧн</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>outboundBuffer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//х░ЖflushedEntryцМЗщТИцМЗхРСChannelOutboundBufferхд┤ч╗УчВ╣я╝МцндцЧ╢хПШф╕║хН│х░ЖшжБflushш┐ЫSocketчЪДцХ░цНощШЯхИЧ</span>
        outboundBuffer<span class="token punctuation">.</span><span class="token function">addFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//х░Жх╛ЕхЖЩцХ░цНохЖЩш┐ЫSocket</span>
        <span class="token function">flush0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h4 id="_4-2-1-channeloutboundbuffer-addflush"><a href="#_4-2-1-channeloutboundbuffer-addflush" class="header-anchor">#</a> 4.2.1 ChannelOutboundBuffer#addFlush</h4> <p>![хЫ╛чЙЗ](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)ChannelOutboundBufferч╗УцЮД.png</p> <p>ш┐ЩщЗМх░▒хИ░ф║ЖчЬЯцнгшжБхПСщАБцХ░цНочЪДцЧ╢хАЩф║Жя╝МхЬи addFlush цЦ╣ц│Хф╕нф╝Ъх░Ж flushedEntry цМЗщТИцМЗхРС unflushedEntry цМЗщТИшбичд║чЪДчммф╕Аф╕кцЬкшвл flush чЪД Entry шКВчВ╣уАВх╣╢х░Ж unflushedEntry цМЗщТИч╜оф╕║чй║я╝МхЗЖхдЗх╝АхзЛ flush хПСщАБцХ░цНоц╡БчиЛуАВ</p> <blockquote><p>цндцЧ╢ ChannelOutboundBuffer чФ▒х╛ЕхПСщАБцХ░цНочЪДч╝УхЖ▓щШЯхИЧхПШф╕║ф║ЖхН│х░ЖшжБ flush ш┐Ы Socket чЪДцХ░цНощШЯхИЧ</p></blockquote> <p>ш┐Щца╖хЬи flushedEntry ф╕О tailEntry ф╣ЛщЧ┤чЪД Entry шКВчВ╣хН│ф╕║цЬмцмб flush цУНф╜ЬщЬАшжБхПСщАБчЪДцХ░цНошМГхЫ┤уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Entry</span> entry <span class="token operator">=</span> unflushedEntry<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flushedEntry <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            flushedEntry <span class="token operator">=</span> entry<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            flushed <span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token comment">//хжВцЮЬх╜УхЙНentryхп╣х║ФчЪДwriteцУНф╜ЬшвлчФицИ╖хПЦц╢Ия╝МхИЩщЗКцФ╛msgя╝Мх╣╢щЩНф╜ОchannelOutboundBufferц░┤ф╜Нч║┐</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entry<span class="token punctuation">.</span>promise<span class="token punctuation">.</span><span class="token function">setUncancellable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> pending <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">decrementPendingOutboundBytes</span><span class="token punctuation">(</span>pending<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            entry <span class="token operator">=</span> entry<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>entry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// All flushed so reset unflushedEntry</span>
        unflushedEntry <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хЬи flush хПСщАБцХ░цНоц╡БчиЛх╝АхзЛцЧ╢я╝МцХ░цНочЪДхПСщАБц╡БчиЛх░▒ф╕НшГ╜швлхПЦц╢Иф║Жя╝МхЬиш┐Щф╣ЛхЙНцИСф╗мщГ╜цШпхПпф╗ещАЪш┐З ChannelPromise хПЦц╢ИцХ░цНохПСщАБц╡БчиЛчЪДуАВ</p> <p>цЙАф╗еш┐ЩщЗМщЬАшжБхп╣ ChannelOutboundBuffer ф╕нцЙАцЬЙ Entry шКВчВ╣хМЕшг╣чЪД ChannelPromise шо╛ч╜оф╕║ф╕НхПпхПЦц╢ИчК╢цАБуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Promise</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * шо╛ч╜ох╜УхЙНfutureф╕║ф╕НхПпхПЦц╢ИчК╢цАБ
     * 
     * ш┐ФхЫЮtrueчЪДцГЕхЖ╡я╝Ъ
     * 1я╝ЪцИРхКЯчЪДх░Жfutureшо╛ч╜оф╕║uncancellable
     * 2я╝Ъх╜Уfutureх╖▓ч╗ПцИРхКЯхоМцИР
     * 
     * ш┐ФхЫЮfalseчЪДцГЕхЖ╡я╝Ъ
     * 1я╝Ъfutureх╖▓ч╗ПшвлхПЦц╢Ия╝МхИЩф╕НшГ╜хЬишо╛ч╜о uncancellable чК╢цАБ
     *
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">setUncancellable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><p>хжВцЮЬш┐ЩщЗМчЪД setUncancellable() цЦ╣ц│Хш┐ФхЫЮ false хИЩшп┤цШОхЬиш┐Щф╣ЛхЙНчФицИ╖х╖▓ч╗Пх░Ж ChannelPromise хПЦц╢ИцОЙф║Жя╝МцОеф╕ЛцЭех░▒щЬАшжБш░ГчФи entry.cancel() цЦ╣ц│ХцЭещЗКцФ╛ф╕║х╛ЕхПСщАБцХ░цНо msg хИЖщЕНчЪДхаЖхдЦхЖЕхнШуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Entry</span> <span class="token punctuation">{</span>
    <span class="token comment">//writeцУНф╜ЬцШпхРжшвлхПЦц╢И</span>
    <span class="token keyword">boolean</span> cancelled<span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cancelled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cancelled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> pSize <span class="token operator">=</span> pendingSize<span class="token punctuation">;</span>

            <span class="token comment">// release message and replace with an empty buffer</span>
            <span class="token class-name">ReferenceCountUtil</span><span class="token punctuation">.</span><span class="token function">safeRelease</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            msg <span class="token operator">=</span> <span class="token class-name">Unpooled</span><span class="token punctuation">.</span><span class="token constant">EMPTY_BUFFER</span><span class="token punctuation">;</span>

            pendingSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            progress <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            bufs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            buf <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> pSize<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>х╜У Entry хп╣ш▒бшвлхПЦц╢ИхРОя╝Мх░▒щЬАшжБхЗПх░С ChannelOutboundBuffer чЪДхЖЕхнШхНачФицА╗щЗПчЪДц░┤ф╜Нч║┐ totalPendingSizeуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AtomicLongFieldUpdater</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelOutboundBuffer</span><span class="token punctuation">&gt;</span></span> <span class="token constant">TOTAL_PENDING_SIZE_UPDATER</span> <span class="token operator">=</span>
    <span class="token class-name">AtomicLongFieldUpdater</span><span class="token punctuation">.</span><span class="token function">newUpdater</span><span class="token punctuation">(</span><span class="token class-name">ChannelOutboundBuffer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;totalPendingSize&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//ц░┤ф╜Нч║┐цМЗщТИ.ChannelOutboundBufferф╕нчЪДх╛ЕхПСщАБцХ░цНочЪДхЖЕхнШхНачФицА╗щЗП : цЙАцЬЙEntryхп╣ш▒бцЬмш║лцЙАхНачФихЖЕхнШхдзх░П + цЙАцЬЙх╛ЕхПСщАБцХ░цНочЪДхдзх░П</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> totalPendingSize<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">decrementPendingOutboundBytes</span><span class="token punctuation">(</span><span class="token keyword">long</span> size<span class="token punctuation">,</span> <span class="token keyword">boolean</span> invokeLater<span class="token punctuation">,</span> <span class="token keyword">boolean</span> notifyWritability<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">long</span> newWriteBufferSize <span class="token operator">=</span> <span class="token constant">TOTAL_PENDING_SIZE_UPDATER</span><span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">-</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>notifyWritability <span class="token operator">&amp;&amp;</span> newWriteBufferSize <span class="token operator">&lt;</span> channel<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWriteBufferLowWaterMark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setWritable</span><span class="token punctuation">(</span>invokeLater<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>х╜УцЫ┤цЦ░хРОчЪДц░┤ф╜Нч║┐ф╜Оф║Оф╜Оц░┤ф╜Нч║┐ <code>DEFAULT_LOW_WATER_MARK = 32 * 1024</code> цЧ╢я╝Мх░▒х░Жх╜УхЙН channel шо╛ч╜оф╕║хПпхЖЩчК╢цАБуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setWritable</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> invokeLater<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> oldValue <span class="token operator">=</span> unwritable<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> newValue <span class="token operator">=</span> oldValue <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">UNWRITABLE_UPDATER</span><span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldValue <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> newValue <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">fireChannelWritabilityChanged</span><span class="token punctuation">(</span>invokeLater<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>х╜У Channel чЪДчК╢цАБцШпчммф╕Ацмбф╗Оф╕НхПпхЖЩчК╢цАБхПШф╕║хПпхЖЩчК╢цАБцЧ╢я╝МNetty ф╝ЪхЬи pipeline ф╕нхЖНцмбшзжхПС ChannelWritabilityChanged ф║Лф╗╢чЪДф╝ацТнуАВ</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZwcdibKiceeWADsv1WFuEtvGG2ibZXOVtmljrxSR8t3dib7vt87o8DVibHKt09BIu9tcpPsOdZ62XeLeA/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="хЫ╛чЙЗ">хУНх║ФchannelWritabilityChangedф║Лф╗╢.png</p> <h3 id="_4-2-2-хПСщАБцХ░цНохЙНчЪДцЬАхРОцгАцЯе-flush0"><a href="#_4-2-2-хПСщАБцХ░цНохЙНчЪДцЬАхРОцгАцЯе-flush0" class="header-anchor">#</a> 4.2.2 хПСщАБцХ░цНохЙНчЪДцЬАхРОцгАцЯе---flush0</h3> <p>flush0 цЦ╣ц│Хш┐ЩщЗМф╕╗шжБхБЪчЪДф║ЛцГЕх░▒цШпцгАцЯех╜У channel чЪДчК╢цАБцШпхРжцнгх╕╕я╝МхжВцЮЬ channel чК╢цАБф╕АхИЗцнгх╕╕я╝МхИЩш░ГчФи doWrite цЦ╣ц│ХхПСщАБцХ░цНоуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractUnsafe</span> <span class="token keyword">implements</span> <span class="token class-name">Unsafe</span> <span class="token punctuation">{</span>

    <span class="token comment">//цШпхРжцнгхЬиш┐ЫшбМflushцУНф╜Ь</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> inFlush0<span class="token punctuation">;</span> 

    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">flush0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>inFlush0<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Avoid re-entrance</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token class-name">ChannelOutboundBuffer</span> outboundBuffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>outboundBuffer<span class="token punctuation">;</span>
        <span class="token comment">//channelх╖▓ч╗ПхЕ│щЧнцИЦшАЕoutboundBufferф╕║чй║</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>outboundBuffer <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> outboundBuffer<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        inFlush0 <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>outboundBuffer<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">//х╜УхЙНchannelхдДф║ОdisConnectedчК╢цАБ  щАЪчЯеpromise хЖЩхЕехд▒ш┤е х╣╢шзжхПСchannelWritabilityChangedф║Лф╗╢</span>
                        outboundBuffer<span class="token punctuation">.</span><span class="token function">failFlushed</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NotYetConnectedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment">//х╜УхЙНchannelхдДф║ОхЕ│щЧнчК╢цАБ щАЪчЯеpromise хЖЩхЕехд▒ш┤е ф╜Жф╕НшзжхПСchannelWritabilityChangedф║Лф╗╢</span>
                        outboundBuffer<span class="token punctuation">.</span><span class="token function">failFlushed</span><span class="token punctuation">(</span><span class="token function">newClosedChannelException</span><span class="token punctuation">(</span>initialCloseCause<span class="token punctuation">,</span> <span class="token string">&quot;flush0()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                inFlush0 <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//хЖЩхЕеSocket</span>
            <span class="token function">doWrite</span><span class="token punctuation">(</span>outboundBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">handleWriteError</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            inFlush0 <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>outboundBuffer == null || outboundBuffer.isEmpty()</code> я╝ЪхжВцЮЬ channel х╖▓ч╗ПхЕ│щЧнф║ЖцИЦшАЕхп╣х║ФхЖЩч╝УхЖ▓хМ║ф╕нц▓бцЬЙф╗╗ф╜ХцХ░цНоя╝МщВгф╣Их░▒хБЬцнвхПСщАБц╡БчиЛя╝МчЫ┤цОе returnуАВ</li> <li><code>!isActive()</code> я╝ЪхжВцЮЬх╜УхЙНchannelхдДф║ОщЭЮц┤╗ш╖ГчК╢цАБя╝МхИЩщЬАшжБш░ГчФи <code>outboundBuffer#failFlushed</code> щАЪчЯе ChannelOutboundBuffer ф╕нцЙАцЬЙх╛ЕхПСщАБцУНф╜Ьхп╣х║ФчЪД channelPromise хРСчФицИ╖ч║┐чиЛцКехСКхПСщАБхд▒ш┤еуАВх╣╢х░Жх╛ЕхПСщАБцХ░цНо Entry хп╣ш▒бф╗О ChannelOutboundBuffer ф╕нхИащЩдя╝Мх╣╢щЗКцФ╛х╛ЕхПСщАБцХ░цНочй║щЧ┤я╝МхЫЮцФ╢ Entry хп╣ш▒бхоЮф╛ЛуАВ</li></ul> <p>ш┐Шшо░х╛ЧцИСф╗мхЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484184&amp;idx=1&amp;sn=726877ce28cf6e5d2ac3225fae687f19&amp;chksm=ce77c55ff9004c493b592288819dc4d4664b5949ee97fed977b6558bc517dad0e1f73fab0f46&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКNettyхжВф╜ХщлШцХИцОецФ╢ч╜Сч╗Ьш┐ЮцОеуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕АцЦЗф╕нцПРхИ░ш┐ЗчЪД NioSocketChannel чЪД active чК╢цАБцЬЙхУкф║ЫцЭбф╗╢хРЧя╝Яя╝Я</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SocketChannel</span> ch <span class="token operator">=</span> <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ch<span class="token punctuation">.</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> ch<span class="token punctuation">.</span><span class="token function">isConnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>NioSocketChannel хдДф║О active чК╢цАБчЪДцЭбф╗╢х┐Ещб╗цШпх╜УхЙН NioSocketChannel цШп open чЪДхРМцЧ╢хдДф║О connected чК╢цАБуАВ</p> <ul><li><code>!isActive() &amp;&amp; isOpen()</code>я╝Ъшп┤цШОх╜УхЙН channel хдДф║О disConnected чК╢цАБя╝Мш┐ЩцЧ╢щАЪчЯеч╗ЩчФицИ╖ channelPromise чЪДх╝Вх╕╕ч▒╗хЮЛф╕║ NotYetConnectedException ,х╣╢щЗКцФ╛цЙАцЬЙх╛ЕхПСщАБцХ░цНохНачФичЪДхаЖхдЦхЖЕхнШя╝МхжВцЮЬцндцЧ╢хЖЕхнШхНачФищЗПф╜Оф║Оф╜Оц░┤ф╜Нч║┐я╝МхИЩшо╛ч╜о channel ф╕║хПпхЖЩчК╢цАБя╝Мх╣╢шзжхПС channelWritabilityChanged ф║Лф╗╢уАВ</li></ul> <blockquote><p>х╜У channel хдДф║О disConnected чК╢цАБцЧ╢я╝МчФицИ╖хПпф╗еш┐ЫшбМ write цУНф╜Ьф╜Жф╕НшГ╜ш┐ЫшбМ flush цУНф╜ЬуАВ</p></blockquote> <ul><li><code>!isActive() &amp;&amp; !isOpen()</code> я╝Ъшп┤цШОх╜УхЙН channel хдДф║ОхЕ│щЧнчК╢цАБя╝Мш┐ЩцЧ╢щАЪчЯеч╗ЩчФицИ╖ channelPromise чЪДх╝Вх╕╕ч▒╗хЮЛф╕║ newClosedChannelException я╝МхЫаф╕║ channel х╖▓ч╗ПхЕ│щЧня╝МцЙАф╗еш┐ЩщЗМх╣╢ф╕Нф╝ЪшзжхПС channelWritabilityChanged ф║Лф╗╢уАВ</li> <li>х╜У channel чЪДш┐Щф║Ых╝Вх╕╕чК╢цАБцабщкМщАЪш┐Зф╣ЛхРОя╝МхИЩш░ГчФи doWrite цЦ╣ц│Хх░Ж ChannelOutboundBuffer ф╕нчЪДх╛ЕхПСщАБцХ░цНохЖЩш┐Ых║Хх▒В Socket ф╕нуАВ</li></ul> <h4 id="_4-2-2-1-channeloutboundbuffer-failflushed"><a href="#_4-2-2-1-channeloutboundbuffer-failflushed" class="header-anchor">#</a> 4.2.2.1  ChannelOutboundBuffer#failFlushed</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ChannelOutboundBuffer</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> inFail<span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">failFlushed</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> cause<span class="token punctuation">,</span> <span class="token keyword">boolean</span> notify<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>inFail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            inFail <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">remove0</span><span class="token punctuation">(</span>cause<span class="token punctuation">,</span> notify<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            inFail <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>шпецЦ╣ц│ХчФиф║ОхЬи Netty хЬихПСщАБцХ░цНочЪДцЧ╢хАЩя╝МхжВцЮЬхПСчО░х╜УхЙН channel хдДф║ОщЭЮц┤╗ш╖ГчК╢цАБя╝МхИЩх░Ж ChannelOutboundBuffer ф╕н flushedEntry ф╕ОtailEntry ф╣ЛщЧ┤чЪД Entry хп╣ш▒бшКВчВ╣хЕищГихИащЩдя╝Мх╣╢щЗКцФ╛хПСщАБцХ░цНохНачФичЪДхЖЕхнШчй║щЧ┤я╝МхРМцЧ╢хЫЮцФ╢ Entry хп╣ш▒бхоЮф╛ЛуАВ</p> <h4 id="_4-2-2-2-channeloutboundbuffer-remove0"><a href="#_4-2-2-2-channeloutboundbuffer-remove0" class="header-anchor">#</a> 4.2.2.2  ChannelOutboundBuffer#remove0</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">remove0</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> cause<span class="token punctuation">,</span> <span class="token keyword">boolean</span> notifyWritability<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Entry</span> e <span class="token operator">=</span> flushedEntry<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//ц╕Ечй║х╜УхЙНreactorч║┐чиЛч╝УхнШчЪДцЙАцЬЙх╛ЕхПСщАБцХ░цНо</span>
        <span class="token function">clearNioBuffers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Object</span> msg <span class="token operator">=</span> e<span class="token punctuation">.</span>msg<span class="token punctuation">;</span>

    <span class="token class-name">ChannelPromise</span> promise <span class="token operator">=</span> e<span class="token punctuation">.</span>promise<span class="token punctuation">;</span>
    <span class="token keyword">int</span> size <span class="token operator">=</span> e<span class="token punctuation">.</span>pendingSize<span class="token punctuation">;</span>
    <span class="token comment">//ф╗ОchannelOutboundBufferф╕нхИащЩдшпеEntryшКВчВ╣</span>
    <span class="token function">removeEntry</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>e<span class="token punctuation">.</span>cancelled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// only release message, fail and decrement if it was not canceled before.</span>
        <span class="token comment">//щЗКцФ╛msgцЙАхНачФичЪДхЖЕхнШчй║щЧ┤</span>
        <span class="token class-name">ReferenceCountUtil</span><span class="token punctuation">.</span><span class="token function">safeRelease</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//ч╝Цш╛СpromiseхПСщАБхд▒ш┤ея╝Мх╣╢щАЪчЯечЫ╕х║ФчЪДLisener</span>
        <span class="token function">safeFail</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//чФ▒ф║Оmsgх╛ЧхИ░щЗКцФ╛я╝МцЙАф╗ещЬАшжБщЩНф╜ОchannelOutboundBufferф╕нчЪДхЖЕхнШхНачФиц░┤ф╜Нч║┐я╝Мх╣╢ца╣цНоnotifyWritabilityхЖ│хоЪцШпхРжшзжхПСChannelWritabilityChangedф║Лф╗╢</span>
        <span class="token function">decrementPendingOutboundBytes</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> notifyWritability<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// recycle the entry</span>
    <span class="token comment">//хЫЮцФ╢EntryхоЮф╛Лхп╣ш▒б</span>
    e<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>х╜Уф╕Аф╕к Entry шКВчВ╣щЬАшжБф╗О ChannelOutboundBuffer ф╕нц╕ЕщЩдцЧ╢я╝МNetty щЬАшжБщЗКцФ╛шпе Entry шКВчВ╣ф╕нхМЕшг╣чЪДхПСщАБцХ░цНо msg цЙАхНачФичЪДхЖЕхнШчй║щЧ┤уАВх╣╢цаЗшо░хп╣х║ФчЪД promise ф╕║хд▒ш┤ехРМцЧ╢щАЪчЯехп╣х║ФчЪД listener я╝МчФ▒ф║О msg х╛ЧхИ░щЗКцФ╛я╝МцЙАф╗ещЬАшжБщЩНф╜О channelOutboundBuffer ф╕нчЪДхЖЕхнШхНачФиц░┤ф╜Нч║┐я╝Мх╣╢ца╣цНо <code>boolean notifyWritability</code> хЖ│хоЪцШпхРжшзжхПС ChannelWritabilityChanged ф║Лф╗╢уАВцЬАхРОщЬАшжБх░Жшпе Entry хоЮф╛ЛхЫЮцФ╢шЗ│ Recycler хп╣ш▒бц▒аф╕нуАВ</p> <h2 id="_5-ч╗Иф║Ох╝АхзЛчЬЯцнгхЬ░хПСщАБцХ░цНоф║Ж"><a href="#_5-ч╗Иф║Ох╝АхзЛчЬЯцнгхЬ░хПСщАБцХ░цНоф║Ж" class="header-anchor">#</a> 5. ч╗Иф║Ох╝АхзЛчЬЯцнгхЬ░хПСщАБцХ░цНоф║Жя╝Б</h2> <p>цЭехИ░ш┐ЩщЗМцИСф╗мх░▒чЬЯцнгш┐ЫхЕехИ░ф║Ж Netty хПСщАБцХ░цНочЪДца╕х┐ГхдДчРЖщА╗ш╛Ся╝МхЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484244&amp;idx=1&amp;sn=831060fc38caa201d69f87305de7f86a&amp;chksm=ce77c513f9004c05b48f849ff99997d6d7252453135ae856a029137b88aa70b8e046013d596e&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКNettyхжВф╜ХщлШцХИцОецФ╢ч╜Сч╗ЬцХ░цНоуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕АцЦЗф╕ня╝МчмФшАЕшпжч╗Жф╗Лч╗Нф║Ж Netty шп╗хПЦцХ░цНочЪДца╕х┐Гц╡БчиЛя╝МNetty ф╝ЪхЬиф╕Аф╕к read loop ф╕нф╕НцЦнх╛кчОпшп╗хПЦ Socket ф╕нчЪДцХ░цНочЫ┤хИ░цХ░цНошп╗хПЦхоМцпХцИЦшАЕшп╗хПЦцмбцХ░х╖▓ц╗б 16 цмбя╝Мх╜Ух╛кчОпшп╗хПЦф║Ж 16 цмбш┐Шц▓бцЬЙшп╗хПЦхоМцпХцЧ╢я╝МNetty х░▒ф╕НшГ╜хЬич╗зч╗ншп╗ф║Жя╝МхЫаф╕║ Netty шжБф┐ЭшпБ Reactor ч║┐чиЛхПпф╗ехЭЗхМАчЪДхдДчРЖц│ихЖМхЬихоГф╕Кш╛╣чЪДцЙАцЬЙ Channel ф╕нчЪД IO ф║Лф╗╢уАВхЙйф╕ЛцЬкшп╗хПЦчЪДцХ░цНочнЙхИ░ф╕Лф╕Ацмб read loop хЬих╝АхзЛшп╗хПЦуАВ</p> <p>щЩдцндф╣ЛхдЦя╝МхЬицпПцмб read loop х╝АхзЛф╣ЛхЙНя╝МNetty щГ╜ф╝ЪхИЖщЕНф╕Аф╕кхИЭхзЛхМЦхдзх░Пф╕║ 2048 чЪД DirectByteBuffer цЭешгЕш╜╜ф╗О Socket ф╕ншп╗хПЦхИ░чЪДцХ░цНоя╝Мх╜УцХ┤ф╕к read loop ч╗УцЭЯцЧ╢я╝Мф╝Ъца╣цНоцЬмцмбшп╗хПЦцХ░цНочЪДцА╗щЗПцЭехИдцЦнцШпхРжф╕║шпе DirectByteBuffer ш┐ЫшбМцЙйхо╣цИЦшАЕч╝йхо╣я╝МчЫочЪДцШпхЬиф╕Лф╕Ацмб read loop чЪДцЧ╢хАЩхПпф╗еф╕║хЕ╢хИЖщЕНф╕Аф╕кхо╣щЗПхдзх░ПхРИщАВчЪД DirectByteBuffer уАВ</p> <p>хЕ╢хоЮ Netty хп╣хПСщАБцХ░цНочЪДхдДчРЖхТМхп╣шп╗хПЦцХ░цНочЪДхдДчРЖца╕х┐ГщА╗ш╛СщГ╜цШпф╕Аца╖чЪДя╝Мш┐ЩщЗМхдзхо╢хПпф╗ех░Жш┐Щф╕дчпЗцЦЗчлач╗УхРИхп╣цпФчЭАчЬЛуАВ</p> <p>ф╜ЖхПСщАБцХ░цНочЪДч╗ЖшКВф╝ЪхдЪф╕Аф║Ыя╝Мф╣Яф╝ЪцЫ┤хдНцЭВф╕Аф║Ыя╝МчФ▒ф║Ош┐ЩхЭЧщА╗ш╛СцХ┤ф╜УчиНх╛оцпФш╛ГхдНцЭВя╝МцЙАф╗ецИСф╗мцОеф╕ЛцЭеш┐ШцШпхИЖцибхЭЧш┐ЫшбМшзгцЮРя╝Ъ</p> <h3 id="_5-1-хПСщАБцХ░цНохЙНчЪДхЗЖхдЗх╖еф╜Ь"><a href="#_5-1-хПСщАБцХ░цНохЙНчЪДхЗЖхдЗх╖еф╜Ь" class="header-anchor">#</a> 5.1 хПСщАБцХ░цНохЙНчЪДхЗЖхдЗх╖еф╜Ь</h3> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doWrite</span><span class="token punctuation">(</span><span class="token class-name">ChannelOutboundBuffer</span> in<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">//шО╖хПЦNioSocketChannelф╕нх░БшгЕчЪДjdk nioх║Хх▒ВsocketChannel</span>
    <span class="token class-name">SocketChannel</span> ch <span class="token operator">=</span> <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//цЬАхдзхЖЩхЕецмбцХ░ щ╗Шшодф╕║16 чЫочЪДцШпф╕║ф║Жф┐ЭшпБSubReactorхПпф╗ех╣│хЭЗчЪДхдДчРЖц│ихЖМхЕ╢ф╕КчЪДцЙАцЬЙChannel</span>
    <span class="token keyword">int</span> writeSpinCount <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWriteSpinCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// хжВцЮЬхЕищГицХ░цНох╖▓ч╗ПхЖЩхоМ хИЩчз╗щЩдOP_WRITEф║Лф╗╢х╣╢чЫ┤цОещААхЗ║writeLoop</span>
            <span class="token function">clearOpWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//  SO_SNDBUFшо╛ч╜очЪДхПСщАБч╝УхЖ▓хМ║хдзх░П * 2 ф╜Ьф╕║ цЬАхдзхЖЩхЕехнЧшКВцХ░  293976 = 146988 &lt;&lt; 1</span>
        <span class="token keyword">int</span> maxBytesPerGatheringWrite <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannelConfig</span><span class="token punctuation">)</span> config<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxBytesPerGatheringWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// х░ЖChannelOutboundBufferф╕нч╝УхнШчЪДDirectBufferш╜мцНвцИРJDK NIO чЪД ByteBuffer</span>
        <span class="token class-name">ByteBuffer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nioBuffers <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">nioBuffers</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> maxBytesPerGatheringWrite<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ChannelOutboundBufferф╕нцА╗хЕ▒чЪДDirectBufferцХ░</span>
        <span class="token keyword">int</span> nioBufferCnt <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">nioBufferCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">switch</span> <span class="token punctuation">(</span>nioBufferCnt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>хРСх║Хх▒Вjdk nio socketChannelхПСщАБцХ░цНо<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>writeSpinCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>хдДчРЖцЬмш╜оwrite loopцЬкхЖЩхоМчЪДцГЕхЖ╡<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ш┐ЩщГихИЖхЖЕхо╣ф╕║ Netty х╝АхзЛхПСщАБцХ░цНоф╣ЛхЙНчЪДхЗЖхдЗх╖еф╜Ья╝Ъ</p> <h4 id="_5-1-1-шО╖хПЦwrite-loopцЬАхдзхПСщАБх╛кчОпцмбцХ░"><a href="#_5-1-1-шО╖хПЦwrite-loopцЬАхдзхПСщАБх╛кчОпцмбцХ░" class="header-anchor">#</a> 5.1.1 шО╖хПЦwrite loopцЬАхдзхПСщАБх╛кчОпцмбцХ░</h4> <p>ф╗Ох╜УхЙН NioSocketChannel чЪДщЕНч╜оч▒╗ NioSocketChannelConfig ф╕ншО╖хПЦ write loop цЬАхдзх╛кчОпхЖЩхЕецмбцХ░я╝Мщ╗Шшодф╕║ 16уАВф╜Жф╣ЯхПпф╗ещАЪш┐Зф╕ЛщЭвчЪДцЦ╣х╝Пш┐ЫшбМшЗкхоЪф╣Йшо╛ч╜оуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">.</span><span class="token function">childOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">WRITE_SPIN_COUNT</span><span class="token punctuation">,</span>шЗкхоЪф╣ЙцХ░хА╝<span class="token punctuation">)</span>
</code></pre></div><h4 id="_5-1-2-хдДчРЖхЬиф╕Аш╜оwrite-loopф╕нх░▒хПСщАБхоМцХ░цНочЪДцГЕхЖ╡"><a href="#_5-1-2-хдДчРЖхЬиф╕Аш╜оwrite-loopф╕нх░▒хПСщАБхоМцХ░цНочЪДцГЕхЖ╡" class="header-anchor">#</a> 5.1.2 хдДчРЖхЬиф╕Аш╜оwrite loopф╕нх░▒хПСщАБхоМцХ░цНочЪДцГЕхЖ╡</h4> <p>ш┐ЫхЕе write loop ф╣ЛхРОщжЦхЕИщЬАшжБхИдцЦнх╜УхЙН ChannelOutboundBuffer ф╕нчЪДцХ░цНоцШпхРжх╖▓ч╗ПхЖЩхоМф║Ж <code>in.isEmpty())</code> я╝МхжВцЮЬхЕищГихЖЩхоМх░▒щЬАшжБц╕ЕщЩдх╜УхЙН Channel хЬи Reactor ф╕Кц│ихЖМчЪД OP_WRITE ф║Лф╗╢уАВ</p> <blockquote><p>ш┐ЩщЗМхдзхо╢хПпшГ╜ф╝ЪцЬЙчЦСщЧоя╝МчЫохЙНцИСф╗мш┐Шц▓бцЬЙц│ихЖМ OP_WRITE ф║Лф╗╢хИ░ Reactor ф╕Кя╝Мф╕║хХешжБц╕ЕщЩдхСвя╝ЯхИлчЭАцАея╝МчмФшАЕф╝ЪхЬихРОщЭвф╕║хдзхо╢цПнцЩУчнФцбИуАВ</p></blockquote> <h4 id="_5-1-3-шО╖хПЦцЬмцмбwrite-loop-цЬАхдзхЕБшо╕хПСщАБхнЧшКВцХ░"><a href="#_5-1-3-шО╖хПЦцЬмцмбwrite-loop-цЬАхдзхЕБшо╕хПСщАБхнЧшКВцХ░" class="header-anchor">#</a> 5.1.3 шО╖хПЦцЬмцмбwrite loop цЬАхдзхЕБшо╕хПСщАБхнЧшКВцХ░</h4> <p>ф╗О ChannelConfig ф╕ншО╖хПЦцЬмцмб write loop цЬАхдзхЕБшо╕хПСщАБчЪДхнЧшКВцХ░ maxBytesPerGatheringWrite уАВхИЭхзЛхА╝ф╕║ <code>SO_SNDBUFхдзх░П * 2 = 293976 = 146988 &lt;&lt; 1</code>я╝МцЬАх░ПхА╝ф╕║ 2048уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">NioSocketChannelConfig</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultSocketChannelConfig</span> <span class="token punctuation">{</span>
    <span class="token comment">//293976 = 146988 &lt;&lt; 1</span>
    <span class="token comment">//SO_SNDBUFшо╛ч╜очЪДхПСщАБч╝УхЖ▓хМ║хдзх░П * 2 ф╜Ьф╕║ цЬАхдзхЖЩхЕехнЧшКВцХ░</span>
    <span class="token comment">//цЬАх░ПхА╝ф╕║2048 </span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> maxBytesPerGatheringWrite <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">NioSocketChannelConfig</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannel</span> channel<span class="token punctuation">,</span> <span class="token class-name">Socket</span> javaSocket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> javaSocket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">calculateMaxBytesPerGatheringWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">calculateMaxBytesPerGatheringWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 293976 = 146988 &lt;&lt; 1</span>
        <span class="token comment">// SO_SNDBUFшо╛ч╜очЪДхПСщАБч╝УхЖ▓хМ║хдзх░П * 2 ф╜Ьф╕║ цЬАхдзхЖЩхЕехнЧшКВцХ░</span>
        <span class="token keyword">int</span> newSendBufferSize <span class="token operator">=</span> <span class="token function">getSendBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newSendBufferSize <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">setMaxBytesPerGatheringWrite</span><span class="token punctuation">(</span>newSendBufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цИСф╗мхПпф╗ещАЪш┐ЗхжВф╕ЛчЪДцЦ╣х╝ПшЗкхоЪф╣ЙщЕНч╜о Socket хПСщАБч╝УхЖ▓хМ║хдзх░ПуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">.</span><span class="token function">childOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_SNDBUF</span><span class="token punctuation">,</span>шЗкхоЪф╣ЙцХ░хА╝<span class="token punctuation">)</span>
</code></pre></div><h4 id="_5-1-4-х░Жх╛ЕхПСщАБцХ░цНош╜мцНвцИР-jdk-nio-bytebuffer"><a href="#_5-1-4-х░Жх╛ЕхПСщАБцХ░цНош╜мцНвцИР-jdk-nio-bytebuffer" class="header-anchor">#</a> 5.1.4 х░Жх╛ЕхПСщАБцХ░цНош╜мцНвцИР JDK NIO ByteBuffer</h4> <p>чФ▒ф║ОцЬАч╗И Netty ф╝Ъш░ГчФи JDK NIO чЪД SocketChannel хПСщАБцХ░цНоя╝МцЙАф╗еш┐ЩщЗМщЬАшжБщжЦхЕИх░Жх╜УхЙН Channel ф╕нчЪДхЖЩч╝УхЖ▓щШЯхИЧ ChannelOutboundBuffer щЗМхнШхВичЪД DirectByteBufferя╝И Netty ф╕нчЪД ByteBuffer хоЮчО░я╝Йш╜мцНвцИР JDK NIO чЪД ByteBuffer ч▒╗хЮЛуАВцЬАч╗Их░Жш╜мцНвхРОчЪДх╛ЕхПСщАБцХ░цНохнШхВихЬи ByteBuffer[] nioBuffers цХ░ч╗Дф╕нуАВш┐ЩщЗМщАЪш┐Зш░ГчФи <code>ChannelOutboundBuffer#nioBuffers</code> цЦ╣ц│ХхоМцИРф╗еф╕К ByteBuffer ч▒╗хЮЛчЪДш╜мцНвуАВ</p> <ul><li><code>maxBytesPerGatheringWrite</code>я╝Ъшбичд║цЬмцмб write loop ф╕нцЬАхдЪф╗О ChannelOutboundBuffer ф╕нш╜мцНв maxBytesPerGatheringWrite ф╕кхнЧшКВхЗ║цЭеуАВф╣Ях░▒цШпцЬмцмб write loop цЬАхдЪшГ╜хПСщАБхдЪх░СхнЧшКВуАВ</li> <li><code>1024</code>: цЬмцмб write loop цЬАхдЪш╜мцНв 1024 ф╕к ByteBufferя╝И JDK NIO хоЮчО░я╝ЙуАВф╣Ях░▒цШпшп┤цЬмцмб write loop цЬАхдЪцЙ╣щЗПхПСщАБхдЪх░Сф╕к ByteBuffer уАВ</li></ul> <p>щАЪш┐З <code>ChannelOutboundBuffer#nioBufferCount()</code> шО╖хПЦцЬмцмб write loop цА╗хЕ▒щЬАшжБхПСщАБчЪД ByteBuffer цХ░щЗП nioBufferCnt уАВц│ицДПш┐ЩщЗМх╖▓ч╗ПхПШцИРф║Ж JDK NIO хоЮчО░чЪД ByteBuffer ф║ЖуАВ</p> <blockquote><p>шпжч╗ЖчЪД ByteBuffer ч▒╗хЮЛш╜мцНвш┐ЗчиЛя╝МчмФшАЕф╝ЪхЬиф╕УщЧишо▓шзг Buffer шо╛шобчЪДцЧ╢хАЩф╕║хдзхо╢хЕищЭвч╗ЖшЗ┤хЬ░шо▓шзгя╝Мш┐ЩщЗМцИСф╗мш┐ШцШпф╕╗шжБшБЪчДжф║ОхПСщАБцХ░цНоц╡БчиЛчЪДф╕╗ч║┐уАВ</p></blockquote> <p>х╜УхБЪхоМш┐Щф║ЫхПСщАБхЙНчЪДхЗЖхдЗх╖еф╜Ьф╣ЛхРОя╝МцОеф╕ЛцЭе Netty х░▒х╝АхзЛхРС JDK NIO SocketChannel хПСщАБш┐Щф║Ых╖▓ч╗Пш╜мцНвхе╜чЪД JDK NIO ByteBuffer ф║ЖуАВ</p> <h3 id="_5-2-хРСjdk-nio-socketchannelхПСщАБцХ░цНо"><a href="#_5-2-хРСjdk-nio-socketchannelхПСщАБцХ░цНо" class="header-anchor">#</a> 5.2 хРСJDK NIO SocketChannelхПСщАБцХ░цНо</h3> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZwcdibKiceeWADsv1WFuEtvGRWOLdwZGibSMcXVzyJmI5ribtNJr1kjwwB1MM5mGH0icIWXLGPE4OEbvw/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="хЫ╛чЙЗ">flushц╡БчиЛ.png</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doWrite</span><span class="token punctuation">(</span><span class="token class-name">ChannelOutboundBuffer</span> in<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      
    <span class="token class-name">SocketChannel</span> ch <span class="token operator">=</span> <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> writeSpinCount <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWriteSpinCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>х░Жх╛ЕхПСщАБцХ░цНош╜мцНвхИ░<span class="token constant">JDK</span> <span class="token constant">NIO</span> <span class="token class-name">ByteBuffer</span>ф╕н<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token comment">//цЬмцмбwrite loopф╕нщЬАшжБхПСщАБчЪД JDK ByteBufferф╕кцХ░</span>
            <span class="token keyword">int</span> nioBufferCnt <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">nioBufferCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">switch</span> <span class="token punctuation">(</span>nioBufferCnt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
                <span class="token comment">//ш┐ЩщЗМф╕╗шжБцШпщТИхп╣ ч╜Сч╗Ьф╝аш╛УцЦЗф╗╢цХ░цНо чЪДхдДчРЖ FileRegion                 </span>
                writeSpinCount <span class="token operator">-=</span> <span class="token function">doWrite0</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>хдДчРЖхНХф╕к<span class="token class-name">NioByteBuffer</span>хПСщАБчЪДцГЕхЖ╡<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>цЙ╣щЗПхдДчРЖхдЪф╕к<span class="token class-name">NioByteBuffers</span>хПСщАБчЪДцГЕхЖ╡<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>            
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>writeSpinCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>хдДчРЖцЬмш╜оwrite loopцЬкхЖЩхоМчЪДцГЕхЖ╡<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ш┐ЩщЗМхдзхо╢хПпшГ╜хп╣ <code>nioBufferCnt == 0</code> чЪДцГЕхЖ╡цпФш╛ГцЬЙчЦСцГСя╝МцШОцШОф╣ЛхЙНх╖▓ч╗ПцабщкМш┐ЗChannelOutboundBuffer ф╕Нф╕║чй║ф║Жя╝М<strong>ф╕║ф╗Аф╣Иш┐ЩщЗМф╗О ChannelOutboundBuffer ф╕ншО╖хПЦхИ░чЪД nioBuffer ф╕кцХ░ф╛ЭчД╢ф╕║ 0 хСв</strong>я╝Я</p> <p>хЬихЙНш╛╣цИСф╗мф╗Лч╗Н Netty хп╣ write ф║Лф╗╢чЪДхдДчРЖш┐ЗчиЛцЧ╢цПРш┐Зя╝М ChannelOutboundBuffer ф╕нхПкцФпцМБ ByteBuf ч▒╗хЮЛхТМ FileRegion ч▒╗хЮЛя╝МхЕ╢ф╕н ByteBuf ч▒╗хЮЛчФиф║ОшгЕш╜╜цЩощАЪчЪДхПСщАБцХ░цНоя╝МшАМ FileRegion ч▒╗хЮЛчФиф║ОщАЪш┐ЗщЫ╢цЛ╖ш┤ЭчЪДцЦ╣х╝Пч╜Сч╗Ьф╝аш╛УцЦЗф╗╢уАВ</p> <p>шАМш┐ЩщЗМ ChannelOutboundBuffer шЩ╜чД╢ф╕Нф╕║чй║я╝Мф╜ЖцШпшгЕш╜╜чЪД NioByteBuffer ф╕кцХ░хН┤ф╕║ 0 шп┤цШО ChannelOutboundBuffer ф╕ншгЕш╜╜чЪДцШп FileRegion ч▒╗хЮЛя╝Мх╜УхЙНцнгхЬиш┐ЫшбМч╜Сч╗ЬцЦЗф╗╢чЪДф╝аш╛УуАВ</p> <p><code>case 0</code> чЪДхИЖцФпф╕╗шжБх░▒цШпчФиф║ОхдДчРЖч╜Сч╗ЬцЦЗф╗╢ф╝аш╛УчЪДцГЕхЖ╡уАВ</p> <h4 id="_5-2-1-щЫ╢цЛ╖ш┤ЭхПСщАБч╜Сч╗ЬцЦЗф╗╢"><a href="#_5-2-1-щЫ╢цЛ╖ш┤ЭхПСщАБч╜Сч╗ЬцЦЗф╗╢" class="header-anchor">#</a> 5.2.1 щЫ╢цЛ╖ш┤ЭхПСщАБч╜Сч╗ЬцЦЗф╗╢</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">doWrite0</span><span class="token punctuation">(</span><span class="token class-name">ChannelOutboundBuffer</span> in<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> msg <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">doWriteInternal</span><span class="token punctuation">(</span>in<span class="token punctuation">,</span> in<span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ш┐ЩщЗМщЬАшжБчЙ╣хИлц│ицДПчЪДцШпчФиф║ОцЦЗф╗╢ф╝аш╛УчЪДцЦ╣ц│Х doWriteInternal ф╕нчЪДш┐ФхЫЮхА╝я╝МчРЖшзгш┐Щф║Ыш┐ФхЫЮхА╝чЪДхЕ╖ф╜УцГЕхЖ╡цЬЙхКйф║ОцИСф╗мчРЖшзгхРОщЭв write loop чЪДщА╗ш╛Сш╡░хРСуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">doWriteInternal</span><span class="token punctuation">(</span><span class="token class-name">ChannelOutboundBuffer</span> in<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>х┐╜чХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">FileRegion</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">FileRegion</span> region <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FileRegion</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
        <span class="token comment">//цЦЗф╗╢х╖▓ч╗Пф╝аш╛УхоМцпХ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>region<span class="token punctuation">.</span><span class="token function">transferred</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> region<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            in<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//щЫ╢цЛ╖ш┤ЭчЪДцЦ╣х╝Пф╝аш╛УцЦЗф╗╢</span>
        <span class="token keyword">long</span> localFlushedAmount <span class="token operator">=</span> <span class="token function">doWriteFileRegion</span><span class="token punctuation">(</span>region<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>localFlushedAmount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            in<span class="token punctuation">.</span><span class="token function">progress</span><span class="token punctuation">(</span>localFlushedAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>region<span class="token punctuation">.</span><span class="token function">transferred</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> region<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                in<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Should not reach here.</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//ш╡░хИ░ш┐ЩщЗМшбичд║ цндцЧ╢Socketх╖▓ч╗ПхЖЩф╕Нш┐ЫхО╗ф║Ж щААхЗ║writeLoopя╝Мц│ихЖМOP_WRITEф║Лф╗╢</span>
    <span class="token keyword">return</span> <span class="token constant">WRITE_STATUS_SNDBUF_FULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цЬАч╗Иф╝ЪхЬи doWriteFileRegion цЦ╣ц│Хф╕нщАЪш┐З <code>FileChannel#transferTo</code> цЦ╣ц│Хх║Хх▒ВчФихИ░чЪДч│╗ч╗Яш░ГчФиф╕║ <code>sendFile</code> хоЮчО░щЫ╢цЛ╖ш┤Эч╜Сч╗ЬцЦЗф╗╢чЪДф╝аш╛УуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NioSocketChannel</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractNioByteChannel</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>socket<span class="token punctuation">.</span></span>SocketChannel</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">long</span> <span class="token function">doWriteFileRegion</span><span class="token punctuation">(</span><span class="token class-name">FileRegion</span> region<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> position <span class="token operator">=</span> region<span class="token punctuation">.</span><span class="token function">transferred</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> region<span class="token punctuation">.</span><span class="token function">transferTo</span><span class="token punctuation">(</span><span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> position<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>хЕ│ф║О Netty ф╕нц╢ЙхПКхИ░чЪДщЫ╢цЛ╖ш┤Эя╝МчмФшАЕф╝ЪцЬЙф╕АчпЗф╕УщЧичЪДцЦЗчлаф╕║хдзхо╢шо▓шзгя╝МцЬмцЦЗчЪДф╕╗щвШцИСф╗мш┐ШцШпхЕИшБЪчДжф║ОцККхПСщАБц╡БчиЛчЪДф╕╗ч║┐цЙУщАЪуАВ</p></blockquote> <p>цИСф╗мч╗зч╗нхЫЮхИ░хПСщАБцХ░цНоц╡БчиЛф╕╗ч║┐ф╕КцЭе~~</p> <div class="language-java extra-class"><pre class="language-java"><code>                <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
                    <span class="token comment">//ш┐ЩщЗМф╕╗шжБцШпщТИхп╣ ч╜Сч╗Ьф╝аш╛УцЦЗф╗╢цХ░цНо чЪДхдДчРЖ FileRegion                 </span>
                    writeSpinCount <span class="token operator">-=</span> <span class="token function">doWrite0</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><code>region.transferred() &gt;= region.count()</code> я╝Ъшбичд║х╜УхЙН FileRegion ф╕нчЪДцЦЗф╗╢цХ░цНох╖▓ч╗Пф╝аш╛УхоМцпХуАВщВгф╣ИхЬиш┐ЩчзНцГЕхЖ╡ф╕ЛцЬмцмб write loop ц▓бцЬЙхЖЩхЕеф╗╗ф╜ХцХ░цНохИ░ Socket я╝МцЙАф╗еш┐ФхЫЮ 0 я╝МwriteSpinCount - 0 цДПцАЭх░▒цШпцЬмцмб write loop ф╕НчоЧя╝Мч╗зч╗нх╛кчОпуАВ</li> <li><code>localFlushedAmount &gt; 0</code> я╝Ъшбичд║цЬм write loop ф╕нхЖЩхЕеф║Жф╕Аф║ЫцХ░цНохИ░ Socket ф╕ня╝Мф╝ЪцЬЙш┐ФхЫЮ 1я╝МwriteSpinCount - 1 хЗПх░Сф╕Ацмб write loop цмбцХ░уАВ</li> <li><code>localFlushedAmount &lt;= 0</code> я╝Ъшбичд║х╜УхЙН Socket хПСщАБч╝УхЖ▓хМ║х╖▓ц╗бя╝МцЧац│ХхЖЩхЕецХ░цНоя╝МщВгф╣Их░▒ш┐ФхЫЮ <code>WRITE_STATUS_SNDBUF_FULL = Integer.MAX_VALUE</code>уАВ<code>writeSpinCount - Integer.MAX_VALUE</code> х┐ЕчД╢цШпш┤ЯцХ░я╝МчЫ┤цОещААхЗ║х╛кчОпя╝МхРС Reactor ц│ихЖМ OP_WRITE ф║Лф╗╢х╣╢щААхЗ║ flush ц╡БчиЛуАВчнЙ Socket хПСщАБч╝УхЖ▓хМ║хПпхЖЩф║Жя╝МReactor ф╝ЪщАЪчЯе channel ч╗зч╗нхПСщАБцЦЗф╗╢цХ░цНоуАВ<strong>шо░ф╜Пш┐ЩщЗМя╝МцИСф╗мхРОщЭвш┐Шф╝ЪцПРхИ░</strong>уАВ</li></ul> <h4 id="_5-2-2-хПСщАБцЩощАЪцХ░цНо"><a href="#_5-2-2-хПСщАБцЩощАЪцХ░цНо" class="header-anchor">#</a> 5.2.2 хПСщАБцЩощАЪцХ░цНо</h4> <p>хЙйф╕Лф╕дф╕к case 1 хТМ default хИЖцФпф╕╗шжБх░▒цШпхдДчРЖ ByteBuffer шгЕш╜╜чЪДцЩощАЪцХ░цНохПСщАБщА╗ш╛СуАВ</p> <p>хЕ╢ф╕н case 1 шбичд║х╜УхЙН Channel чЪД ChannelOutboundBuffer ф╕нхПкхМЕхРлф║Жф╕Аф╕к NioByteBuffer чЪДцГЕхЖ╡уАВ</p> <p>default шбичд║х╜УхЙН Channel чЪД ChannelOutboundBuffer ф╕нхМЕхРлф║ЖхдЪф╕к NioByteBuffers чЪДцГЕхЖ╡уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doWrite</span><span class="token punctuation">(</span><span class="token class-name">ChannelOutboundBuffer</span> in<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      
    <span class="token class-name">SocketChannel</span> ch <span class="token operator">=</span> <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> writeSpinCount <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWriteSpinCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>х░Жх╛ЕхПСщАБцХ░цНош╜мцНвхИ░<span class="token constant">JDK</span> <span class="token constant">NIO</span> <span class="token class-name">ByteBuffer</span>ф╕н<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token comment">//цЬмцмбwrite loopф╕нщЬАшжБхПСщАБчЪД JDK ByteBufferф╕кцХ░</span>
            <span class="token keyword">int</span> nioBufferCnt <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">nioBufferCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">switch</span> <span class="token punctuation">(</span>nioBufferCnt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>хдДчРЖч╜Сч╗ЬцЦЗф╗╢ф╝аш╛У<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> nioBuffers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token keyword">int</span> attemptedBytes <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">final</span> <span class="token keyword">int</span> localWrittenBytes <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>localWrittenBytes <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">//хжВцЮЬх╜УхЙНSocketхПСщАБч╝УхЖ▓хМ║ц╗бф║ЖхЖЩф╕Нш┐ЫхО╗ф║Жя╝МхИЩц│ихЖМOP_WRITEф║Лф╗╢я╝МчнЙх╛ЕSocketхПСщАБч╝УхЖ▓хМ║хПпхЖЩцЧ╢ хЬихЖЩ</span>
                            <span class="token comment">// SubReactorхЬихдДчРЖOP_WRITEф║Лф╗╢цЧ╢я╝МчЫ┤цОеш░ГчФиflushцЦ╣ц│Х</span>
                            <span class="token function">incompleteWrite</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment">//ца╣цНох╜УхЙНхоЮщЩЕхЖЩхЕецГЕхЖ╡ш░ГцХ┤ maxBytesPerGatheringWriteцХ░хА╝</span>
                        <span class="token function">adjustMaxBytesPerGatheringWrite</span><span class="token punctuation">(</span>attemptedBytes<span class="token punctuation">,</span> localWrittenBytes<span class="token punctuation">,</span> maxBytesPerGatheringWrite<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//хжВцЮЬChannelOutboundBufferф╕нчЪДцЯРф╕кEntryшвлхЕищГихЖЩхЕе хИЩхИащЩдшпеEntry</span>
                        <span class="token comment">// хжВцЮЬEntryшвлхЖЩхЕеф║Жф╕АщГихИЖ ш┐ШцЬЙф╕АщГихИЖцЬкхЖЩхЕе  хИЩцЫ┤цЦ░Entryф╕нчЪДreadIndex чнЙх╛Еф╕ЛцмбwriteLoopч╗зч╗нхЖЩхЕе</span>
                        in<span class="token punctuation">.</span><span class="token function">removeBytes</span><span class="token punctuation">(</span>localWrittenBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token operator">--</span>writeSpinCount<span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
            <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token comment">// ChannelOutboundBufferф╕нцА╗хЕ▒х╛ЕхЖЩхЕецХ░цНочЪДхнЧшКВцХ░</span>
                <span class="token keyword">long</span> attemptedBytes <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">nioBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//цЙ╣щЗПхЖЩхЕе</span>
                <span class="token keyword">final</span> <span class="token keyword">long</span> localWrittenBytes <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>nioBuffers<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> nioBufferCnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>localWrittenBytes <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">incompleteWrite</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//ца╣цНохоЮщЩЕхЖЩхЕецГЕхЖ╡ш░ГцХ┤ф╕АцмбхЖЩхЕецХ░цНохдзх░ПчЪДцЬАхдзхА╝</span>
                <span class="token comment">// maxBytesPerGatheringWriteхЖ│хоЪцпПцмбхПпф╗еф╗ОchannelOutboundBufferф╕ншО╖хПЦхдЪх░СхПСщАБцХ░цНо</span>
                <span class="token function">adjustMaxBytesPerGatheringWrite</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> attemptedBytes<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> localWrittenBytes<span class="token punctuation">,</span>
                                                maxBytesPerGatheringWrite<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//чз╗щЩдхЕищГихЖЩхоМчЪДBUfferя╝МхжВцЮЬхПкхЖЩф║ЖщГихИЖцХ░цНохИЩцЫ┤цЦ░bufferчЪДreaderIndexя╝Мф╕Лф╕Аф╕кwriteLoopхЖЩхЕе</span>
                in<span class="token punctuation">.</span><span class="token function">removeBytes</span><span class="token punctuation">(</span>localWrittenBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">--</span>writeSpinCount<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>            
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>writeSpinCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>хдДчРЖцЬмш╜оwrite loopцЬкхЖЩхоМчЪДцГЕхЖ╡<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>case 1 хТМ default ш┐Щф╕дф╕кхИЖцФпхЬихдДчРЖхПСщАБцХ░цНоцЧ╢чЪДщА╗ш╛СцШпф╕Аца╖чЪДя╝МхФпф╕АчЪДхМ║хИлх░▒цШп case 1 цШпхдДчРЖхНХф╕к NioByteBuffer чЪДхПСщАБя╝МшАМ default хИЖцФпцШпцЙ╣щЗПхдДчРЖхдЪф╕к NioByteBuffers чЪДхПСщАБуАВ</p> <p>ф╕ЛщЭвчмФшАЕх░▒ф╗еч╗Пх╕╕швлшзжхПСхИ░чЪД default хИЖцФпф╕║ф╛ЛцЭеф╕║хдзхо╢шо▓ш┐░ Netty хЬихдДчРЖцХ░цНохПСщАБцЧ╢чЪДщА╗ш╛Сч╗ЖшКВя╝Ъ</p> <ol><li>щжЦхЕИф╗Ох╜УхЙН NioSocketChannel ф╕нчЪД ChannelOutboundBuffer ф╕ншО╖хПЦцЬмцмб write loop щЬАшжБхПСщАБчЪДхнЧшКВцА╗щЗП attemptedBytes уАВш┐Щф╕к nioBufferSize цШпхЬихЙНш╛╣ф╗Лч╗Н <code>ChannelOutboundBuffer#nioBuffers</code> цЦ╣ц│Хш╜мцНв JDK NIO ByteBuffer ч▒╗хЮЛцЧ╢швлшобчоЧхЗ║цЭечЪДуАВ</li> <li>ш░ГчФи JDK NIO хОЯчФЯ SocketChannel цЙ╣щЗПхПСщАБ nioBuffers ф╕нчЪДцХ░цНоуАВх╣╢шО╖хПЦхИ░цЬмцмб write loop ф╕АхЕ▒цЙ╣щЗПхПСщАБф║ЖхдЪх░СхнЧшКВ localWrittenBytes уАВ</li></ol> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token comment">/**
     * @throws  NotYetConnectedException
     *          If this channel is not yet connected
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">long</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> srcs<span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
</code></pre></div><ol><li><code>localWrittenBytes &lt;= 0</code> шбичд║х╜УхЙН Socket чЪДхЖЩч╝УхнШхМ║ SEND_BUF х╖▓ц╗бя╝МхЖЩф╕Нш┐ЫцХ░цНоф║ЖуАВщВгф╣Их░▒щЬАшжБхРСх╜УхЙН NioSocketChannel хп╣х║ФчЪД Reactor ц│ихЖМ OP_WRITE ф║Лф╗╢я╝Мх╣╢хБЬцнвх╜УхЙН flush ц╡БчиЛуАВх╜У Socket чЪДхЖЩч╝УхЖ▓хМ║цЬЙхо╣щЗПхПпхЖЩцЧ╢я╝Мepoll ф╝ЪщАЪчЯе reactor ч║┐чиЛч╗зч╗нхЖЩхЕеуАВ</li></ol> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">incompleteWrite</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> setOpWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Did not write completely.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>setOpWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//ш┐ЩщЗМхдДчРЖш┐Шц▓бхЖЩц╗б16цмб ф╜ЖцШпsocketч╝УхЖ▓хМ║х╖▓ц╗бхЖЩф╕Нш┐ЫхО╗чЪДцГЕхЖ╡ ц│ихЖМwriteф║Лф╗╢</span>
            <span class="token comment">//ф╗Аф╣ИцЧ╢хАЩsocketхПпхЖЩф║Жя╝М epollф╝ЪщАЪчЯеreactorч║┐чиЛч╗зч╗нхЖЩ</span>
            <span class="token function">setOpWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЫохЙНш┐Шф╕НщЬАшжБхЕ│ц│иш┐ЩщЗМ<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>хРС Reactor ц│ихЖМ OP_WRITE ф║Лф╗╢я╝Ъ</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">setOpWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">SelectionKey</span> key <span class="token operator">=</span> <span class="token function">selectionKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>key<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> interestOps <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>interestOps <span class="token operator">&amp;</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_WRITE</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            key<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span>interestOps <span class="token operator">|</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_WRITE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><blockquote><p>хЕ│ф║ОщАЪш┐Зф╜Нш┐РчоЧцЭехРС IO ф║Лф╗╢щЫЖхРИ interestOps ц╖╗хКачЫСхРм IO ф║Лф╗╢чЪДчФиц│Хя╝МхЬихЙНш╛╣чЪДцЦЗчлаф╕ня╝МчмФшАЕх╖▓ч╗ПхдЪцмбф╗Лч╗Нш┐Зф║Жя╝Мш┐ЩщЗМф╕НхЖНщЗНхдНуАВ</p></blockquote> <ol><li>ца╣цНоцЬмцмб write loop хРС Socket хЖЩч╝УхЖ▓хМ║хЖЩхЕецХ░цНочЪДцГЕхЖ╡я╝МцЭеш░ГцХ┤ф╕Лцмб write loop цЬАхдзхЖЩхЕехнЧшКВцХ░уАВmaxBytesPerGatheringWrite хЖ│хоЪцпПцмб write loop хПпф╗еф╗О channelOutboundBuffer ф╕нцЬАхдЪшО╖хПЦхдЪх░СхПСщАБцХ░цНоуАВхИЭхзЛхА╝ф╕║ <code>SO_SNDBUFхдзх░П * 2 = 293976 = 146988 &lt;&lt; 1</code>я╝МцЬАх░ПхА╝ф╕║ 2048уАВ</li></ol> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MAX_BYTES_PER_GATHERING_WRITE_ATTEMPTED_LOW_THRESHOLD</span> <span class="token operator">=</span> <span class="token number">4096</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">adjustMaxBytesPerGatheringWrite</span><span class="token punctuation">(</span><span class="token keyword">int</span> attempted<span class="token punctuation">,</span> <span class="token keyword">int</span> written<span class="token punctuation">,</span> <span class="token keyword">int</span> oldMaxBytesPerGatheringWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>attempted <span class="token operator">==</span> written<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>attempted <span class="token operator">&lt;</span><span class="token generics"><span class="token punctuation">&lt;</span> 1 <span class="token punctuation">&gt;</span></span> oldMaxBytesPerGatheringWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannelConfig</span><span class="token punctuation">)</span> config<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMaxBytesPerGatheringWrite</span><span class="token punctuation">(</span>attempted <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>attempted <span class="token operator">&gt;</span> <span class="token constant">MAX_BYTES_PER_GATHERING_WRITE_ATTEMPTED_LOW_THRESHOLD</span> <span class="token operator">&amp;&amp;</span> written <span class="token generics"><span class="token punctuation">&lt;</span> attempted <span class="token punctuation">&gt;</span></span><span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannelConfig</span><span class="token punctuation">)</span> config<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMaxBytesPerGatheringWrite</span><span class="token punctuation">(</span>attempted <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><blockquote><p>чФ▒ф║ОцУНф╜Ьч│╗ч╗Яф╝ЪхКицАБш░ГцХ┤ SO_SNDBUF чЪДхдзх░Пя╝МцЙАф╗еш┐ЩщЗМ netty ф╣ЯщЬАшжБца╣цНоцУНф╜Ьч│╗ч╗ЯчЪДхКицАБш░ГцХ┤хБЪхЗ║чЫ╕х║ФчЪДш░ГцХ┤я╝МчЫочЪДцШпх░╜щЗПхдЪчЪДхО╗хЖЩхЕецХ░цНоуАВ</p></blockquote> <p><code>attempted == written</code> шбичд║цЬмцмб write loop х░ЭшпХхЖЩхЕечЪДцХ░цНошГ╜хЕищГихЖЩхЕехИ░ Socket чЪДхЖЩч╝УхЖ▓хМ║ф╕ня╝МщВгф╣Иф╕Лцмб write loop х░▒х║Фшпех░ЭшпХхО╗хЖЩхЕецЫ┤хдЪчЪДцХ░цНоуАВ</p> <p><strong>щВгф╣Иш┐ЩщЗМчЪДцЫ┤хдЪхЕ╖ф╜УцШпхдЪх░СхСвя╝Я</strong></p> <p>Netty ф╝Ъх░ЖцЬмцмбхЖЩхЕечЪДцХ░цНощЗП written цЙйхдзф╕дхАНя╝МхжВцЮЬцЙйхдзф╕дхАНхРОчЪДхЖЩхЕещЗПхдзф║ОцЬмцмб write loop чЪДцЬАхдзщЩРхИ╢хЖЩхЕещЗП maxBytesPerGatheringWriteя╝Мшп┤цШОчФицИ╖чЪДхЖЩхЕещЬАц▒Вх╛ИчМЫчГИя╝МNettyх╜УчД╢шжБц╗бш╢│ш┐Щца╖чЪДчМЫчГИщЬАц▒Вя╝МщВгф╣Их░▒х░Жх╜УхЙН NioSocketChannelConfig ф╕нчЪД maxBytesPerGatheringWrite цЫ┤цЦ░ф╕║цЬмцмб write loop ф╕дхАНчЪДхЖЩхЕещЗПхдзх░ПуАВ</p> <p>хЬиф╕Лцмб write loop хЖЩхЕецХ░цНочЪДцЧ╢хАЩя╝Мх░▒ф╝Ъх░ЭшпХф╗О ChannelOutboundBuffer ф╕нхКаш╜╜цЬАхдЪ <code>written * 2</code> хдзх░ПчЪДхнЧшКВцХ░уАВ</p> <p>хжВцЮЬцЙйхдзф╕дхАНхРОчЪДхЖЩхЕещЗПф╛ЭчД╢х░Пф║ОчнЙф║ОцЬмцмб write loop чЪДцЬАхдзщЩРхИ╢хЖЩхЕещЗП maxBytesPerGatheringWriteя╝Мшп┤цШОчФицИ╖чЪДхЖЩхЕещЬАц▒Вш┐Шф╕НцШпх╛ИчМЫчГИя╝МNetty ч╗зч╗нч╗┤цМБцЬмцмб maxBytesPerGatheringWrite цХ░хА╝ф╕НхПШуАВ</p> <p><strong>хжВцЮЬцЬмцмбхЖЩхЕечЪДцХ░цНош┐Шф╕НхПКх░ЭшпХхЖЩхЕецХ░цНочЪД 1 / 2</strong> я╝Ъ<code>written &lt; attempted &gt;&gt;&gt; 1</code>уАВшп┤цШОх╜УхЙН Socket хЖЩч╝УхЖ▓хМ║чЪДхПпхЖЩхо╣щЗПф╕НцШпх╛ИхдЪф║Жя╝Мф╕Лф╕Ацмб write loop х░▒ф╕НшжБхЖЩш┐Щф╣ИхдЪф║Жх░ЭшпХхЗПх░Сф╕ЛцмбхЖЩхЕечЪДщЗПх░Жф╕Лцмб write loop шжБхЖЩхЕечЪДцХ░цНохЗПх░Пф╕║ attempted чЪД1 / 2уАВх╜УчД╢ф╣Яф╕НшГ╜цЧащЩРхИ╢чЪДхЗПх░Пя╝МцЬАх░ПхА╝ф╕НшГ╜ф╜Оф║О 2048уАВ</p> <blockquote><p>ш┐ЩщЗМхПпф╗еч╗УхРИчмФшАЕхЙНш╛╣чЪДцЦЗчла<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484244&amp;idx=1&amp;sn=831060fc38caa201d69f87305de7f86a&amp;chksm=ce77c513f9004c05b48f849ff99997d6d7252453135ae856a029137b88aa70b8e046013d596e&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКф╕АцЦЗшБКщАПByteBufferхКицАБшЗкщАВх║ФцЙйч╝йхо╣цЬ║хИ╢уАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕нф╗Лч╗НхИ░чЪД read loop хЬ║цЩпф╕нчЪДцЙйч╝йхо╣ф╕Аш╡╖хп╣цпФчЭАчЬЛуАВ</p></blockquote> <blockquote><p>read loop ф╕нчЪДцЙйч╝йхо╣шзжхПСцЧ╢цЬ║цШпхЬиф╕Аф╕кхоМцХ┤чЪД read loop ч╗УцЭЯцЧ╢хАЩшзжхПСуАВшАМ write loop ф╕нцЙйч╝йхо╣чЪДшзжхПСцЧ╢цЬ║цШпхЬицпПцмб write loop хПСщАБхоМцХ░цНохРОя╝МчлЛхН│шзжхПСцЙйч╝йхо╣хИдцЦнуАВ</p></blockquote> <ol><li>х╜УцЬмцмб write loop цЙ╣щЗПхПСщАБхоМ ChannelOutboundBuffer ф╕нчЪДцХ░цНоф╣ЛхРОя╝МцЬАхРОш░ГчФи<code>in.removeBytes(localWrittenBytes)</code> ф╗О ChannelOutboundBuffer ф╕нчз╗щЩдхЕищГихЖЩхоМчЪД Entry я╝МхжВцЮЬхПкхПСщАБф║Ж Entry чЪДщГихИЖцХ░цНохИЩцЫ┤цЦ░ Entry хп╣ш▒бф╕нх░БшгЕчЪД DirectByteBuffer чЪД readerIndexя╝МчнЙх╛Еф╕Лф╕Ацмб write loop хЖЩхЕеуАВ</li></ol> <p>хИ░ш┐ЩщЗМя╝Мwrite loop ф╕нчЪДхПСщАБцХ░цНочЪДщА╗ш╛Сх░▒ф╗Лч╗НхоМф║Жя╝МцОеф╕ЛцЭе Netty ф╝ЪхЬи write loop ф╕нх╛кчОпхЬ░хПСщАБцХ░цНочЫ┤хИ░хЖЩц╗б 16 цмбцИЦшАЕцХ░цНохПСщАБхоМцпХуАВ</p> <p>ш┐ШцЬЙф╕АчзНщААхЗ║ write loop чЪДцГЕхЖ╡х░▒цШпх╜У Socket ф╕нчЪДхЖЩч╝УхЖ▓хМ║ц╗бф║Жя╝МцЧац│ХхЬихЖЩхЕецЧ╢уАВNetty ф╝ЪщААхЗ║ write loop х╣╢хРС reactor ц│ихЖМ OP_WRITE ф║Лф╗╢уАВ</p> <p>ф╜Жш┐ЩхЕ╢ф╕нш┐ШщЪРшЧПчЭАф╕АчзНцГЕхЖ╡х░▒цШпхжВцЮЬ write loop х╖▓ч╗ПхЖЩц╗б 16 цмбф╜Жш┐Шц▓бхЖЩхоМцХ░цНох╣╢ф╕ФцндцЧ╢ Socket хЖЩч╝УхЖ▓хМ║ш┐Шц▓бцЬЙц╗бя╝Мш┐ШхПпф╗еч╗зч╗нхЬихЖЩуАВщВг Netty ф╝ЪхжВф╜ХхдДчРЖш┐ЩчзНцГЕхЖ╡хСвя╝Я</p> <h2 id="_6-хдДчРЖsocketхПпхЖЩф╜Жх╖▓ч╗ПхЖЩц╗б16цмбш┐Шц▓бхЖЩхоМчЪДцГЕхЖ╡"><a href="#_6-хдДчРЖsocketхПпхЖЩф╜Жх╖▓ч╗ПхЖЩц╗б16цмбш┐Шц▓бхЖЩхоМчЪДцГЕхЖ╡" class="header-anchor">#</a> 6. хдДчРЖSocketхПпхЖЩф╜Жх╖▓ч╗ПхЖЩц╗б16цмбш┐Шц▓бхЖЩхоМчЪДцГЕхЖ╡</h2> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doWrite</span><span class="token punctuation">(</span><span class="token class-name">ChannelOutboundBuffer</span> in<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      
        <span class="token class-name">SocketChannel</span> ch <span class="token operator">=</span> <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> writeSpinCount <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWriteSpinCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
  
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>х░Жх╛ЕхПСщАБцХ░цНош╜мцНвхИ░<span class="token constant">JDK</span> <span class="token constant">NIO</span> <span class="token class-name">ByteBuffer</span>ф╕н<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token keyword">int</span> nioBufferCnt <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">nioBufferCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">switch</span> <span class="token punctuation">(</span>nioBufferCnt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
                    <span class="token comment">//ш┐ЩщЗМф╕╗шжБцШпщТИхп╣ ч╜Сч╗Ьф╝аш╛УцЦЗф╗╢цХ░цНо чЪДхдДчРЖ FileRegion                 </span>
                    writeSpinCount <span class="token operator">-=</span> <span class="token function">doWrite0</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>хПСщАБхНХф╕кnioBuffer<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>цЙ╣щЗПхПСщАБхдЪф╕кnioBuffers<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>            
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>writeSpinCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//хдДчРЖwrite loopч╗УцЭЯ ф╜ЖцХ░цНош┐Шц▓бхЖЩхоМчЪДцГЕхЖ╡</span>
        <span class="token function">incompleteWrite</span><span class="token punctuation">(</span>writeSpinCount <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>х╜У write loop ч╗УцЭЯхРОя╝Мш┐ЩцЧ╢ writeSpinCount чЪДхА╝ф╝ЪцЬЙф╕дчзНцГЕхЖ╡я╝Ъ</p> <ul><li><code>writeSpinCount &lt; 0</code>я╝Ъш┐ЩчзНцГЕхЖ╡цЬЙчВ╣ф╕Нхе╜чРЖшзгя╝МцИСф╗мхЬиф╗Лч╗Н Netty щАЪш┐ЗщЫ╢цЛ╖ш┤ЭчЪДцЦ╣х╝Пф╝аш╛Уч╜Сч╗ЬцЦЗф╗╢ф╣Ях░▒цШпш┐ЩщЗМчЪД case 0 хИЖцФпщА╗ш╛СцЧ╢я╝Мшпжч╗Жф╗Лч╗Нф║Ж doWrite0 цЦ╣ц│ХчЪДхЗачзНш┐ФхЫЮхА╝я╝Мх╜У Netty хЬиф╝аш╛УцЦЗф╗╢чЪДш┐ЗчиЛф╕нхПСчО░ Socket ч╝УхЖ▓хМ║х╖▓ц╗бцЧац│ХхЬич╗зч╗нхЖЩхЕецХ░цНоцЧ╢я╝Мф╝Ъш┐ФхЫЮ <code>WRITE_STATUS_SNDBUF_FULL = Integer.MAX_VALUE</code>я╝Мш┐Щх░▒ф╜┐х╛Ч <code>writeSpinCountчЪДхА╝ &lt; 0</code>уАВщЪПхРО break цОЙ write loop цЭехИ░ <code>incompleteWrite(writeSpinCount &lt; 0)</code> цЦ╣ц│Хф╕ня╝МцЬАхРОф╝ЪхЬи incompleteWrite цЦ╣ц│Хф╕нхРС reactor ц│ихЖМ OP_WRITE ф║Лф╗╢уАВх╜У Socket ч╝УхЖ▓хМ║хПШх╛ЧхПпхЖЩцЧ╢я╝Мepoll ф╝ЪщАЪчЯе reactor ч║┐чиЛч╗зч╗нхПСщАБцЦЗф╗╢уАВ</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">incompleteWrite</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> setOpWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Did not write completely.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>setOpWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//ш┐ЩщЗМхдДчРЖш┐Шц▓бхЖЩц╗б16цмб ф╜ЖцШпsocketч╝УхЖ▓хМ║х╖▓ц╗бхЖЩф╕Нш┐ЫхО╗чЪДцГЕхЖ╡ ц│ихЖМwriteф║Лф╗╢</span>
            <span class="token comment">// ф╗Аф╣ИцЧ╢хАЩsocketхПпхЖЩф║Жя╝М epollф╝ЪщАЪчЯеreactorч║┐чиЛч╗зч╗нхЖЩ</span>
            <span class="token function">setOpWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><ul><li><code>writeSpinCount == 0</code>я╝Ъш┐ЩчзНцГЕхЖ╡х╛Ихе╜чРЖшзгя╝Мх░▒цШпх╖▓ч╗ПхЖЩц╗бф║Ж 16 цмбя╝Мф╜ЖцШпш┐Шц▓бхЖЩхоМя╝МхРМцЧ╢ Socket чЪДхЖЩч╝УхЖ▓хМ║цЬкц╗бя╝Мш┐ШхПпф╗еч╗зч╗нхЖЩхЕеуАВш┐ЩчзНцГЕхЖ╡ф╕ЛхН│ф╜┐ Socket ш┐ШхПпф╗еч╗зч╗нхЖЩхЕея╝МNetty ф╣Яф╕Нф╝ЪхЖНхО╗хЖЩф║Жя╝МхЫаф╕║цЙзшбМ flush цУНф╜ЬчЪДцШп reactor ч║┐чиЛя╝МшАМ reactor ч║┐чиЛш┤Яш┤гцЙзшбМц│ихЖМхЬихоГф╕Кш╛╣чЪДцЙАцЬЙ channel чЪД IO цУНф╜Ья╝МNetty ф╕Нф╝ЪхЕБшо╕ reactor ч║┐чиЛф╕АчЫ┤хЬиф╕Аф╕к channel ф╕КцЙзшбМ IO цУНф╜Ья╝Мreactor ч║┐чиЛчЪДцЙзшбМцЧ╢щЧ┤щЬАшжБхЭЗхМАчЪДхИЖщЕНхИ░цпПф╕к channel ф╕КуАВцЙАф╗еш┐ЩщЗМ Netty ф╝ЪхБЬф╕Ля╝Мш╜мшАМхО╗хдДчРЖхЕ╢ф╗Ц channel ф╕КчЪД IO ф║Лф╗╢уАВ</li></ul> <p><strong>щВгф╣Иш┐Шц▓бхЖЩхоМчЪДцХ░цНоя╝МNettyф╝ЪхжВф╜ХхдДчРЖхСв</strong>я╝Я</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">incompleteWrite</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> setOpWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Did not write completely.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>setOpWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//ш┐ЩщЗМхдДчРЖш┐Шц▓бхЖЩц╗б16цмб ф╜ЖцШпsocketч╝УхЖ▓хМ║х╖▓ц╗бхЖЩф╕Нш┐ЫхО╗чЪДцГЕхЖ╡ ц│ихЖМwriteф║Лф╗╢</span>
            <span class="token comment">// ф╗Аф╣ИцЧ╢хАЩsocketхПпхЖЩф║Жя╝М epollф╝ЪщАЪчЯеreactorч║┐чиЛч╗зч╗нхЖЩ</span>
            <span class="token function">setOpWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//ш┐ЩщЗМхдДчРЖчЪДцШпsocketч╝УхЖ▓хМ║ф╛ЭчД╢хПпхЖЩя╝Мф╜ЖцШпхЖЩф║Ж16цмбш┐Шц▓бхЖЩхоМя╝Мш┐ЩцЧ╢х░▒ф╕НшГ╜хЬихЖЩф║Жя╝Мreactorч║┐чиЛщЬАшжБхдДчРЖхЕ╢ф╗Цchannelф╕КчЪДioф║Лф╗╢</span>

            <span class="token comment">//хЫаф╕║цндцЧ╢socketцШпхПпхЖЩчЪДя╝Мх┐Ещб╗ц╕ЕщЩдop_writeф║Лф╗╢я╝МхРжхИЩф╝Ъф╕АчЫ┤ф╕НхБЬхЬ░швлщАЪчЯе</span>
            <span class="token function">clearOpWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//хжВцЮЬцЬмцмбwriteLoopш┐Шц▓бхЖЩхоМя╝МхИЩцПРф║дflushTaskхИ░reactor           </span>
            <span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>flushTask<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
</code></pre></div><p>ш┐Щф╕кцЦ╣ц│ХчЪД if хИЖцФпщА╗ш╛Ся╝МцИСф╗мхЬиф╗Лч╗Н<code>do {.....}while()</code>х╛кчОпф╜У write loop ф╕нхПСщАБщА╗ш╛СцЧ╢х╖▓ч╗ПцПРш┐Зя╝МхЬи write loop х╛кчОпхПСщАБцХ░цНочЪДш┐ЗчиЛф╕ня╝МхжВцЮЬхПСчО░ Socket ч╝УхЖ▓хМ║х╖▓ц╗бя╝МцЧац│ХхЖЩхЕецХ░цНоцЧ╢я╝И localWrittenBytes &lt;= 0я╝Йя╝МхИЩщЬАшжБхРС reactor ц│ихЖМ OP_WRITE ф║Лф╗╢я╝МчнЙхИ░ Socket ч╝УхЖ▓хМ║хПШф╕║хПпхЖЩчК╢цАБцЧ╢я╝Мepoll ф╝ЪщАЪчЯе reactor ч║┐чиЛч╗зч╗нхЖЩхЕехЙйф╕ЛчЪДцХ░цНоуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code>       <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>х░Жх╛ЕхПСщАБцХ░цНош╜мцНвхИ░<span class="token constant">JDK</span> <span class="token constant">NIO</span> <span class="token class-name">ByteBuffer</span>ф╕н<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token keyword">int</span> nioBufferCnt <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">nioBufferCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">switch</span> <span class="token punctuation">(</span>nioBufferCnt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
                    writeSpinCount <span class="token operator">-=</span> <span class="token function">doWrite0</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>хПСщАБхНХф╕кnioBuffer<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">final</span> <span class="token keyword">int</span> localWrittenBytes <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>localWrittenBytes <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">incompleteWrite</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>цЙ╣щЗПхПСщАБхдЪф╕кnioBuffers<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">final</span> <span class="token keyword">long</span> localWrittenBytes <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>nioBuffers<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> nioBufferCnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>localWrittenBytes <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">incompleteWrite</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>writeSpinCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>ц│ицДП if хИЖцФпхдДчРЖчЪДцГЕхЖ╡цШпш┐Шц▓бхЖЩц╗б 16 цмбя╝Мф╜ЖцШп Socket ч╝УхЖ▓хМ║х╖▓ц╗бя╝МцЧац│ХхЖЩхЕечЪДцГЕхЖ╡уАВ</p></blockquote> <p>шАМ else хИЖцФпцнгцШпхдДчРЖцИСф╗мш┐ЩщЗМцнгхЬишоишо║чЪДцГЕхЖ╡хН│ Socket ч╝УхЖ▓хМ║цШпхПпхЖЩчЪДя╝Мф╜ЖцШпх╖▓ч╗ПхЖЩц╗б 16 цмбя╝МхЬицЬмш╜о write loop ф╕нф╕НшГ╜хЖНч╗зч╗нхЖЩхЕечЪДцГЕхЖ╡уАВ</p> <p>ш┐ЩцЧ╢ Netty ф╝Ъх░Ж channel ф╕нхЙйф╕ЛчЪДх╛ЕхЖЩцХ░цНочЪД flush цУНф╜Ьх░БшгЕчиЛ flushTaskя╝Мф╕вш┐Ы reactor чЪДцЩощАЪф╗╗хКбщШЯхИЧф╕ня╝МчнЙх╛Е reactor цЙзшбМхоМхЕ╢ф╗Ц channel ф╕КчЪД io цУНф╜ЬхРОхЬихЫЮш┐Зхд┤цЭецЙзшбМцЬкхЖЩхоМчЪД flush ф╗╗хКбуАВ</p> <blockquote><p>х┐Шшо░ Reactor цХ┤ф╜Уш┐РшбМщА╗ш╛СчЪДхРМхнжя╝МхПпф╗ехЬихЫЮчЬЛф╕ЛчмФшАЕчЪДш┐ЩчпЗцЦЗчла<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484087&amp;idx=1&amp;sn=0c065780e0f05c23c8e6465ede86cba0&amp;chksm=ce77c4f0f9004de63be369a664105708bc5975b52993f4a6df223caed34cc1ef6185a16acd75&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКф╕АцЦЗшБКщАПNettyца╕х┐Гх╝ХцУОReactorчЪДш┐Рш╜мцЮ╢цЮДуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Runnable</span> flushTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractNioUnsafe</span><span class="token punctuation">)</span> <span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flush0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>ш┐ЩщЗМцИСф╗мчЬЛхИ░ flushTask ф╕нчЪДф╗╗хКбцШпчЫ┤цОехЖНцмбш░ГчФи flush0 ч╗зч╗нхЫЮхИ░хПСщАБцХ░цНочЪДщА╗ш╛Сц╡БчиЛф╕нуАВ</p> <p><strong>ч╗Жх┐ГчЪДхРМхнжхПпшГ╜ф╝ЪцЬЙчЦСщЧоя╝Мф╕║ф╗Аф╣Иш┐ЩщЗМф╕НхЬич╗зч╗нц│ихЖМ OP_WRITE ф║Лф╗╢шАМцШпщАЪш┐ЗхРС reactor цПРф║дф╕Аф╕к flushTask цЭехоМцИР channel ф╕нхЙйф╕ЛцХ░цНочЪДхЖЩхЕехСвя╝Я</strong></p> <p>хОЯхЫацШпш┐ЩщЗМцИСф╗мшо▓чЪД else хИЖцФпцШпчФицЭехдДчРЖ Socket ч╝УхЖ▓хМ║цЬкц╗бш┐ШцШпхПпхЖЩчЪДя╝Мф╜ЖцШпчФ▒ф║ОчФицИ╖цЬмцмбшжБхПСщАБчЪДцХ░цНохдкхдЪя╝Мхп╝шЗ┤хЖЩф║Ж 16 цмбш┐Шц▓бхЖЩхоМчЪДцГЕх╜вуАВ</p> <p><strong>цЧвчД╢х╜УхЙН Socket ч╝УхЖ▓хМ║цШпхПпхЖЩчЪДя╝МцИСф╗мх░▒ф╕НшГ╜ц│ихЖМ OP_WRITE ф║Лф╗╢я╝МхРжхИЩш┐ЩщЗМф╕АчЫ┤ф╝Ъф╕НхБЬхЬ░цФ╢хИ░ epoll чЪДщАЪчЯеуАВхЫаф╕║ JDK NIO Selector щ╗ШшодчЪДцШп epoll чЪДц░┤х╣│шзжхПСуАВ</strong></p> <blockquote><p>х┐Шшо░ц░┤х╣│шзжхПСхТМш╛╣ч╝ШшзжхПСш┐Щф╕дчзН epoll х╖еф╜Ьцибх╝ПчЪДхРМхнжя╝МхПпф╗ехЬихЫЮчЬЛф╕ЛчмФшАЕчЪДш┐ЩчпЗцЦЗчла<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247483737&amp;idx=1&amp;sn=7ef3afbb54289c6e839eed724bb8a9d6&amp;chksm=ce77c71ef9004e08e3d164561e3a2708fc210c05408fa41f7fe338d8e85f39c1ad57519b614e&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКшБКшБКNettyщВгф║Ыф║ЛхД┐ф╣Лф╗ОхЖЕца╕шзТх║жчЬЛIOцибхЮЛуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>цЙАф╗еш┐ЩщЗМхПкшГ╜хРС reactor цПРф║д flushTask цЭеч╗зч╗нхоМцИРхЙйф╕ЛцХ░цНочЪДхЖЩхЕея╝МшАМф╕НшГ╜ц│ихЖМ OP_WRITE ф║Лф╗╢уАВ</p> <blockquote><p>ц│ицДПя╝ЪхПкцЬЙх╜У Socket ч╝УхЖ▓хМ║х╖▓ц╗бхп╝шЗ┤цЧац│ХхЖЩхЕецЧ╢я╝МNetty цЙНф╝ЪхО╗ц│ихЖМ OP_WRITE ф║Лф╗╢уАВш┐ЩхТМцИСф╗мф╣ЛхЙНф╗Лч╗НчЪД OP_ACCEPT ф║Лф╗╢хТМ OP_READ ф║Лф╗╢чЪДц│ихЖМцЧ╢цЬ║цШпф╕НхРМчЪДуАВ</p></blockquote> <p><strong>ш┐ЩщЗМхдзхо╢хПпшГ╜ш┐Шф╝ЪцЬЙхПжф╕Аф╕кчЦСщЧоя╝Мх░▒цШпф╕║ф╗Аф╣ИхЬихРС reactor цПРф║д flushTask ф╣ЛхЙНщЬАшжБц╕ЕчРЖ OP_WRITE ф║Лф╗╢хСвя╝Я</strong> цИСф╗мх╣╢ц▓бцЬЙц│ихЖМ OP_WRITE ф║Лф╗╢хСА~~</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">incompleteWrite</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> setOpWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>setOpWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">clearOpWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>flushTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre></div><p>хЬиф╕║хдзхо╢шзгчнФш┐Щф╕кчЦСщЧоф╣ЛхЙНя╝МчмФшАЕхЕИф╕║хдзхо╢ф╗Лч╗Нф╕Л Netty цШпхжВф╜ХхдДчРЖ OP_WRITE ф║Лф╗╢чЪДя╝Мх╜Ухдзхо╢цШОчЩ╜ф║Ж OP_WRITE ф║Лф╗╢чЪДхдДчРЖщА╗ш╛СхРОя╝Мш┐Щф╕кчЦСщЧох░▒шЗкчД╢шзгх╝Аф║ЖуАВ</p> <h2 id="_7-op-writeф║Лф╗╢чЪДхдДчРЖ"><a href="#_7-op-writeф║Лф╗╢чЪДхдДчРЖ" class="header-anchor">#</a> 7. OP_WRITEф║Лф╗╢чЪДхдДчРЖ</h2> <p>хЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484087&amp;idx=1&amp;sn=0c065780e0f05c23c8e6465ede86cba0&amp;chksm=ce77c4f0f9004de63be369a664105708bc5975b52993f4a6df223caed34cc1ef6185a16acd75&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКф╕АцЦЗшБКщАПNettyца╕х┐Гх╝ХцУОReactorчЪДш┐Рш╜мцЮ╢цЮДуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕АцЦЗф╕ня╝МцИСф╗мф╗Лч╗Нш┐Зя╝Мх╜У Reactor чЫСхРмхИ░ channel ф╕КцЬЙ IO ф║Лф╗╢хПСчФЯхРОя╝МцЬАч╗Иф╝ЪхЬи processSelectedKey цЦ╣ц│Хф╕нхдДчРЖ channel ф╕КчЪД IO ф║Лф╗╢я╝МхЕ╢ф╕н OP_ACCEPT ф║Лф╗╢хТМ OP_READ ф║Лф╗╢чЪДхдДчРЖш┐ЗчиЛя╝МчмФшАЕх╖▓ч╗ПхЬиф╣ЛхЙНчЪДч│╗хИЧцЦЗчлаф╕нф╗Лч╗Нш┐Зф║Жя╝Мш┐ЩщЗМцИСф╗мшБЪчДжф║О OP_WRITE ф║Лф╗╢чЪДхдДчРЖуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">NioEventLoop</span> <span class="token keyword">extends</span> <span class="token class-name">SingleThreadEventLoop</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processSelectedKey</span><span class="token punctuation">(</span><span class="token class-name">SelectionKey</span> k<span class="token punctuation">,</span> <span class="token class-name">AbstractNioChannel</span> ch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">AbstractNioChannel<span class="token punctuation">.</span>NioUnsafe</span> unsafe <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> readyOps <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">readyOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readyOps <span class="token operator">&amp;</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_CONNECT</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>хдДчРЖconnectф║Лф╗╢<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readyOps <span class="token operator">&amp;</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_WRITE</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ch<span class="token punctuation">.</span><span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forceFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
 
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readyOps <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_READ</span> <span class="token operator">|</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_ACCEPT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> readyOps <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>хдДчРЖacceptхТМreadф║Лф╗╢<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CancelledKeyException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            unsafe<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">voidPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>ш┐ЩщЗМцИСф╗мчЬЛхИ░х╜У OP_WRITE ф║Лф╗╢хПСчФЯхРОя╝МNetty чЫ┤цОеш░ГчФи channel чЪД forceFlush цЦ╣ц│ХуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code>       <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">forceFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// directly call super.flush0() to force a flush now</span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">flush0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre></div><p>хЕ╢хоЮ forceFlush цЦ╣ц│Хф╕нх╣╢ц▓бцЬЙф╗Аф╣ИчЙ╣цоКчЪДщА╗ш╛Ся╝МчЫ┤цОеш░ГчФи flush0 цЦ╣ц│ХхЖНцмбхПСш╡╖ flush цУНф╜Ьч╗зч╗н channel ф╕нхЙйф╕ЛцХ░цНочЪДхЖЩхЕеуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doWrite</span><span class="token punctuation">(</span><span class="token class-name">ChannelOutboundBuffer</span> in<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      
        <span class="token class-name">SocketChannel</span> ch <span class="token operator">=</span> <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> writeSpinCount <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWriteSpinCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">clearOpWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>х░Жх╛ЕхПСщАБцХ░цНош╜мцНвхИ░<span class="token constant">JDK</span> <span class="token constant">NIO</span> <span class="token class-name">ByteBuffer</span>ф╕н<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token keyword">int</span> nioBufferCnt <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">nioBufferCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">switch</span> <span class="token punctuation">(</span>nioBufferCnt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
                      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>ф╝аш╛Уч╜Сч╗ЬцЦЗф╗╢<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>хПСщАБхНХф╕кnioBuffer<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>цЙ╣щЗПхПСщАБхдЪф╕кnioBuffers<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>            
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>writeSpinCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//хдДчРЖwrite loopч╗УцЭЯ ф╜ЖцХ░цНош┐Шц▓бхЖЩхоМчЪДцГЕхЖ╡</span>
        <span class="token function">incompleteWrite</span><span class="token punctuation">(</span>writeSpinCount <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>ц│ицДПш┐ЩщЗМчЪД clearOpWrite() цЦ╣ц│Хя╝МчФ▒ф║О channel ф╕КчЪД OP_WRITE ф║Лф╗╢х░▒ч╗кя╝МшбицШОцндцЧ╢ Socket ч╝УхЖ▓хМ║хПШф╕║хПпхЖЩчК╢цАБя╝Мф╗ОшАМ Reactor ч║┐чиЛхЖНцмбцЭехИ░ф║Ж flush ц╡БчиЛф╕нуАВ</p> <p>х╜У ChannelOutboundBuffer ф╕нчЪДцХ░цНохЕищГихЖЩхоМхРО in.isEmpty() я╝Мх░▒щЬАшжБц╕ЕчРЖ OP_WRITE ф║Лф╗╢я╝МхЫаф╕║цндцЧ╢ Socket ч╝УхЖ▓хМ║цШпхПпхЖЩчЪДя╝Мш┐ЩчзНцГЕхЖ╡ф╕Лх╜УцХ░цНохЕищГихЖЩхоМхРОя╝Мх░▒щЬАшжБхПЦц╢Ихп╣ OP_WRITE ф║Лф╗╢чЪДчЫСхРмя╝МхРжхИЩ epoll ф╝Ъф╕НцЦнчЪДщАЪчЯе ReactorуАВ</p> <p>хРМчРЖхЬи incompleteWrite цЦ╣ц│ХчЪД else хИЖцФпф╣ЯщЬАшжБцЙзшбМ clearOpWrite() цЦ╣ц│ХхПЦц╢Ихп╣ OP_WRITE ф║Лф╗╢чЪДчЫСхРмуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">incompleteWrite</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> setOpWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>setOpWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ш┐ЩщЗМхдДчРЖш┐Шц▓бхЖЩц╗б16цмб ф╜ЖцШпsocketч╝УхЖ▓хМ║х╖▓ц╗бхЖЩф╕Нш┐ЫхО╗чЪДцГЕхЖ╡ ц│ихЖМwriteф║Лф╗╢</span>
            <span class="token comment">// ф╗Аф╣ИцЧ╢хАЩsocketхПпхЖЩф║Жя╝М epollф╝ЪщАЪчЯеreactorч║┐чиЛч╗зч╗нхЖЩ</span>
            <span class="token function">setOpWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// х┐Ещб╗ц╕ЕщЩдOP_WRITEф║Лф╗╢я╝МцндцЧ╢Socketхп╣х║ФчЪДч╝УхЖ▓хМ║ф╛ЭчД╢цШпхПпхЖЩчЪДя╝МхПкф╕Нш┐Зх╜УхЙНchannelхЖЩхдЯф║Ж16цмбя╝МшвлSubReactorщЩРхИ╢ф║ЖуАВ</span>
            <span class="token comment">// ш┐Щца╖SubReactorхПпф╗ешЕ╛хЗ║цЙЛцЭехдДчРЖхЕ╢ф╗Цchannelф╕КчЪДIOф║Лф╗╢уАВш┐ЩщЗМхжВцЮЬф╕Нц╕ЕщЩдOP_WRITEф║Лф╗╢я╝МхИЩф╝Ъф╕АчЫ┤швлщАЪчЯеуАВ</span>
            <span class="token function">clearOpWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//хжВцЮЬцЬмцмбwriteLoopш┐Шц▓бхЖЩхоМя╝МхИЩцПРф║дflushTaskхИ░SubReactor</span>
            <span class="token comment">//щЗКцФ╛SubReactorшойхЕ╢хПпф╗еч╗зч╗нхдДчРЖхЕ╢ф╗ЦChannelф╕КчЪДIOф║Лф╗╢</span>
            <span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>flushTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><h2 id="_8-writeandflush"><a href="#_8-writeandflush" class="header-anchor">#</a> 8. writeAndFlush</h2> <p>хЬицИСф╗мшо▓хоМф║Ж write ф║Лф╗╢хТМ flush ф║Лф╗╢чЪДхдДчРЖш┐ЗчиЛф╣ЛхРОя╝МwriteAndFlush х░▒хПШх╛Чх╛ИчоАхНХф║Жя╝МхоГх░▒цШпцКК write хТМ flush ц╡БчиЛч╗УхРИш╡╖цЭея╝МхЕИшзжхПС write ф║Лф╗╢чД╢хРОхЬишзжхПС flush ф║Лф╗╢уАВ</p> <p>ф╕ЛщЭвцИСф╗мцЭечЬЛф╕Л writeAndFlush чЪДхЕ╖ф╜УщА╗ш╛СхдДчРЖя╝Ъ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//цндхдДчЪДmsgх░▒цШпNettyхЬиread loopф╕нф╗ОNioSocketChannelф╕ншп╗хПЦхИ░ByteBuffer</span>
        ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractChannelHandlerContext</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">,</span> <span class="token class-name">ResourceLeakHint</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">writeAndFlush</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token function">newPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>ш┐ЩщЗМхПпф╗ечЬЛхИ░ writeAndFlush цЦ╣ц│ХчЪДхдДчРЖхЕехПгхТМ write ф║Лф╗╢чЪДхдДчРЖхЕехПгцШпф╕Аца╖чЪДуАВхФпф╕Аф╕НхРМчЪДцШпхЕехПгхдДчРЖхЗ╜цХ░ write цЦ╣ц│ХчЪД boolean flush хЕехПВф╕НхРМя╝МхЬи writeAndFlush чЪДхдДчРЖф╕н flush = trueуАВ</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token keyword">boolean</span> flush<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token string">&quot;msg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХецгАцЯеpromiseчЪДцЬЙцХИцАз<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment">//flush = true шбичд║channelHandlerф╕нш░ГчФичЪДцШпwriteAndFlushцЦ╣ц│Хя╝Мш┐ЩщЗМщЬАшжБцЙ╛хИ░pipelineф╕ншжЖчЫЦwriteцИЦшАЕflushцЦ╣ц│ХчЪДchannelHandler</span>
        <span class="token comment">//flush = false шбичд║ш░ГчФичЪДцШпwriteцЦ╣ц│Хя╝МхПкщЬАшжБцЙ╛хИ░pipelineф╕ншжЖчЫЦwriteцЦ╣ц│ХчЪДchannelHandler</span>
        <span class="token keyword">final</span> <span class="token class-name">AbstractChannelHandlerContext</span> next <span class="token operator">=</span> <span class="token function">findContextOutbound</span><span class="token punctuation">(</span>flush <span class="token operator">?</span>
                <span class="token punctuation">(</span><span class="token constant">MASK_WRITE</span> <span class="token operator">|</span> <span class="token constant">MASK_FLUSH</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token constant">MASK_WRITE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//чФиф║ОцгАцЯехЖЕхнШц│ДщЬ▓</span>
        <span class="token keyword">final</span> <span class="token class-name">Object</span> m <span class="token operator">=</span> pipeline<span class="token punctuation">.</span><span class="token function">touch</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//шО╖хПЦф╕Лф╕Аф╕кшжБшвлцЙзшбМчЪДchannelHandlerчЪДexecutor</span>
        <span class="token class-name">EventExecutor</span> executor <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//чбоф┐ЭOutBoundф║Лф╗╢чФ▒ChannelHandlerцМЗхоЪчЪДexecutorцЙзшбМ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>executor<span class="token punctuation">.</span><span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//хжВцЮЬх╜УхЙНч║┐чиЛцнгцШпchannelHandlerцМЗхоЪчЪДexecutorхИЩчЫ┤цОецЙзшбМ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>flush<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                next<span class="token punctuation">.</span><span class="token function">invokeWriteAndFlush</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                next<span class="token punctuation">.</span><span class="token function">invokeWrite</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//хжВцЮЬх╜УхЙНч║┐чиЛф╕НцШпChannelHandlerцМЗхоЪчЪДexecutor,хИЩх░БшгЕцИРх╝Вцнеф╗╗хКбцПРф║дч╗ЩцМЗхоЪexecutorцЙзшбМя╝Мц│ицДПш┐ЩщЗМчЪДexecutorф╕Нф╕АхоЪцШпreactorч║┐чиЛуАВ</span>
            <span class="token keyword">final</span> <span class="token class-name">WriteTask</span> task <span class="token operator">=</span> <span class="token class-name">WriteTask</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> m<span class="token punctuation">,</span> promise<span class="token punctuation">,</span> flush<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">safeExecute</span><span class="token punctuation">(</span>executor<span class="token punctuation">,</span> task<span class="token punctuation">,</span> promise<span class="token punctuation">,</span> m<span class="token punctuation">,</span> <span class="token operator">!</span>flush<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                task<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>чФ▒ф║ОхЬи writeAndFlush ц╡БчиЛчЪДхдДчРЖф╕ня╝Мflush цаЗх┐Чшвлшо╛ч╜оф╕║ trueя╝МцЙАф╗еш┐ЩщЗМцЬЙф╕дф╕кхЬ░цЦ╣ф╝ЪхТМ write ф║Лф╗╢чЪДхдДчРЖцЬЙцЙАф╕НхРМуАВ</p> <ul><li><code>findContextOutbound( MASK_WRITE | MASK_FLUSH )</code>я╝Ъш┐ЩщЗМхЬи pipeline ф╕нхРСхЙНцЯецЙ╛чЪД ChanneOutboundHandler щЬАшжБхоЮчО░ write цЦ╣ц│ХцИЦшАЕ flush цЦ╣ц│ХуАВш┐ЩщЗМщЬАшжБц│ицДПчЪДцШп write цЦ╣ц│ХхТМ flush цЦ╣ц│ХхПкщЬАшжБхоЮчО░хЕ╢ф╕нф╕Аф╕кхН│хПпц╗бш╢│цЯецЙ╛цЭбф╗╢уАВхЫаф╕║ф╕АшИмцИСф╗мшЗкхоЪф╣Й ChannelOutboundHandler цЧ╢я╝МщГ╜ф╝Ъч╗зцЙ┐ ChannelOutboundHandlerAdapter ч▒╗я╝МшАМхЬи ChannelInboundHandlerAdapter ч▒╗ф╕нхп╣ф║Ош┐Щф║Ы outbound ф║Лф╗╢щГ╜ф╝ЪцЬЙщ╗ШшодчЪДхоЮчО░уАВ</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChannelOutboundHandlerAdapter</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelHandlerAdapter</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelOutboundHandler</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Skip</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Skip</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>ш┐Щца╖хЬихРОщЭвф╝ацТн write ф║Лф╗╢цИЦшАЕ flush ф║Лф╗╢чЪДцЧ╢хАЩя╝МцИСф╗мщАЪш┐Зф╕КщЭвщА╗ш╛СцЙ╛хЗ║чЪД ChannelOutboundHandler ф╕нхПпшГ╜хПкхоЮчО░ф║Жф╕Аф╕к flush цЦ╣ц│ХцИЦшАЕ write цЦ╣ц│ХуАВф╕Нш┐Зш┐Щца╖ц▓бхЕ│ч│╗я╝МхжВцЮЬш┐ЩщЗМхЬиф╝ацТн outbound ф║Лф╗╢чЪДш┐ЗчиЛф╕ня╝МхПСчО░цЙ╛хЗ║чЪД ChannelOutboundHandler ф╕нх╣╢ц▓бцЬЙхоЮчО░хп╣х║ФчЪД outbound ф║Лф╗╢хЫЮш░ГхЗ╜цХ░я╝МщВгф╣Их░▒чЫ┤цОеш░ГчФихЬи ChannelOutboundHandlerAdapter ф╕нчЪДщ╗ШшодхоЮчО░уАВ</p> <ul><li>хЬихРСхЙНф╝ацТн writeAndFlush ф║Лф╗╢чЪДцЧ╢хАЩф╝ЪщАЪш┐Зш░ГчФи ChannelHandlerContext чЪД invokeWriteAndFlush цЦ╣ц│Хя╝МхЕИф╝ацТн write ф║Лф╗╢ чД╢хРОхЬиф╝ацТн flush ф║Лф╗╢уАВ</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">invokeWriteAndFlush</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">invokeHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//хРСхЙНф╝ащАТwriteф║Лф╗╢</span>
        <span class="token function">invokeWrite0</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//хРСхЙНф╝ащАТflushф║Лф╗╢</span>
        <span class="token function">invokeFlush0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">writeAndFlush</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeWrite0</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//ш░ГчФих╜УхЙНChannelHandlerф╕нчЪДwriteцЦ╣ц│Х</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ChannelOutboundHandler</span><span class="token punctuation">)</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">notifyOutboundHandlerException</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeFlush0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ChannelOutboundHandler</span><span class="token punctuation">)</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">invokeExceptionCaught</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ш┐ЩщЗМцИСф╗мчЬЛхИ░ф║Ж writeAndFlush чЪДца╕х┐ГхдДчРЖщА╗ш╛Ся╝М<strong>щжЦхЕИхРСхЙНф╝ацТн write ф║Лф╗╢я╝Мч╗Пш┐З write ф║Лф╗╢чЪДц╡БчиЛхдДчРЖхРОя╝МцЬАхРОхРСхЙНф╝ацТн flush ф║Лф╗╢уАВ</strong></p> <p>ца╣цНохЙНш╛╣чЪДф╗Лч╗Ня╝Мш┐ЩщЗМхЬихРСхЙНф╝ацТн write ф║Лф╗╢чЪДцЧ╢хАЩя╝МхПпшГ╜цЯецЙ╛хЗ║чЪД ChannelOutboundHandler хПкцШпхоЮчО░ф║Ж flush цЦ╣ц│Хя╝Мф╕Нш┐Зц▓бхЕ│ч│╗я╝Мш┐ЩщЗМф╝ЪчЫ┤цОеш░ГчФи write цЦ╣ц│ХхЬи ChannelOutboundHandlerAdapter чИ╢ч▒╗ф╕нчЪДщ╗ШшодхоЮчО░уАВхРМчРЖ flush ф╣ЯцШпф╕Аца╖уАВ</p> <hr> <h2 id="цА╗ч╗У"><a href="#цА╗ч╗У" class="header-anchor">#</a> цА╗ч╗У</h2> <p>хИ░ш┐ЩщЗМя╝МNetty хдДчРЖцХ░цНохПСщАБчЪДцХ┤ф╕кхоМцХ┤ц╡БчиЛя╝МчмФшАЕх░▒ф╕║хдзхо╢шпжч╗ЖхЬ░ф╗Лч╗НхоМф║Жя╝МхПпф╗ечЬЛхИ░ Netty хЬихдДчРЖшп╗хПЦцХ░цНохТМхдДчРЖхПСщАБцХ░цНочЪДш┐ЗчиЛф╕ня╝МшЩ╜чД╢ца╕х┐ГщА╗ш╛СщГ╜х╖оф╕НхдЪя╝Мф╜ЖцШпхПСщАБцХ░цНочЪДш┐ЗчиЛцШОцШ╛ч╗ЖшКВцпФш╛ГхдЪя╝МшАМф╕ФцЫ┤хКахдНцЭВф╕Аф║ЫуАВ</p> <p>ш┐ЩщЗМчмФшАЕх░Жшп╗хПЦцХ░цНохТМхПСщАБцХ░цНочЪДф╕НхРМф╣ЛхдДцА╗ч╗УхжВф╕ЛхЗачВ╣ф╛Ыхдзхо╢хЫЮх┐Жхп╣цпФя╝Ъ</p> <ul><li><p>хЬицпПцмб read loop ф╣ЛхЙНя╝Мф╝ЪхИЖщЕНф╕Аф╕кхдзх░ПхЫ║хоЪчЪД diretByteBuffer чФицЭешгЕш╜╜шп╗хПЦцХ░цНоуАВцпПш╜о read loop хоМхЕич╗УцЭЯф╣ЛхРОя╝МцЙНф╝ЪхЖ│хоЪцШпхРжхп╣ф╕Лф╕Аш╜очЪДшп╗хПЦш┐ЗчиЛхИЖщЕНчЪД directByteBuffer ш┐ЫшбМцЙйхо╣цИЦшАЕч╝йхо╣уАВ</p></li> <li><p>хЬицпПцмб write loop ф╣ЛхЙНя╝МщГ╜ф╝ЪшО╖хПЦцЬмцмб write loop цЬАхдзшГ╜хдЯхЖЩхЕечЪДхнЧшКВцХ░я╝Мца╣цНош┐Щф╕кцЬАхдзхЖЩхЕехнЧшКВцХ░ф╗О ChannelOutboundBuffer ф╕нш╜мцНв JDK NIO ByteBuffer уАВцпПцмбхЖЩхЕе Socket ф╣ЛхРОщГ╜щЬАшжБщЗНцЦ░шпДф╝░цШпхРжхп╣ш┐Щф╕кцЬАхдзхЖЩхЕехнЧшКВцХ░ш┐ЫшбМцЙйхо╣цИЦшАЕч╝йхо╣уАВ</p></li> <li><p>read loop хТМ write loop щГ╜швлщ╗ШшодщЩРхоЪцЬАхдЪцЙзшбМ 16 цмбуАВ</p></li> <li><p>хЬиф╕Аф╕кхоМцХ┤чЪД read loop ф╕ня╝МхжВцЮЬш┐Шшп╗хПЦф╕НхоМцХ░цНоя╝МчЫ┤цОещААхЗ║уАВчнЙхИ░ reactor ч║┐чиЛцЙзшбМхоМхЕ╢ф╗Ц channel ф╕КчЪД IO ф║Лф╗╢хЖНцЭешп╗хПЦцЬкшп╗хоМчЪДцХ░цНоуАВ</p></li> <li><p>шАМхЬиф╕Аф╕кхоМцХ┤чЪД write loop ф╕ня╝МцХ░цНохПСщАБф╕НхоМя╝МхИЩхИЖф╕дчзНцГЕхЖ╡уАВ</p> <ul><li>Socket ч╝УхЖ▓хМ║ц╗бцЧац│ХхЬич╗зч╗нхЖЩхЕеуАВш┐ЩцЧ╢х░▒щЬАшжБхРС reactor ц│ихЖМ OP_WRITE ф║Лф╗╢уАВчнЙ Socket ч╝УхЖ▓хМ║хПШчЪДхПпхЖЩцЧ╢я╝Мepoll щАЪчЯе reactor ч║┐чиЛч╗зч╗нхПСщАБуАВ</li> <li>Socket ч╝УхЖ▓хМ║хПпхЖЩя╝Мф╜ЖцШпчФ▒ф║ОхПСщАБцХ░цНохдкхдЪя╝Мхп╝шЗ┤шЩ╜чД╢хЖЩц╗б 16 цмбф╜Жф╛ЭчД╢ц▓бцЬЙхЖЩхоМуАВш┐ЩцЧ╢х░▒чЫ┤цОехРС reactor ф╕вф╕Аф╕к flushTask ш┐ЫхО╗я╝МчнЙхИ░ reactor ч║┐чиЛцЙзшбМхоМхЕ╢ф╗Ц channel ф╕КчЪД IO ф║Лф╗╢я╝МхЬихЫЮш┐Зхд┤цЭецЙзшбМ flushTaskуАВ</li></ul></li> <li><p>OP_READ ф║Лф╗╢чЪДц│ихЖМцШпхЬи NioSocketChannel швлц│ихЖМхИ░хп╣х║ФчЪД Reactor ф╕нцЧ╢х░▒ф╝Ъц│ихЖМуАВ<strong>шАМ OP_WRITE ф║Лф╗╢хПкф╝ЪхЬи Socket ч╝УхЖ▓хМ║ц╗бчЪДцЧ╢хАЩцЙНф╝Ъшвлц│ихЖМуАВх╜У Socket ч╝УхЖ▓хМ║хЖНцмбхПШх╛ЧхПпхЖЩцЧ╢я╝МшжБшо░х╛ЧхПЦц╢И OP_WRITE ф║Лф╗╢чЪДчЫСхРмуАВхРжхИЩчЪДшпЭх░▒ф╝Ъф╕АчЫ┤швлщАЪчЯе</strong>уАВ</p></li></ul> <p>хе╜ф║Жя╝МцЬмцЦЗчЪДхЕищГихЖЕхо╣х░▒хИ░ш┐ЩщЗМф║Жя╝МцИСф╗мф╕ЛчпЗцЦЗчлашзБ~~~~</p> <h2 id="хПВшАГш╡ДцЦЩ"><a href="#хПВшАГш╡ДцЦЩ" class="header-anchor">#</a> хПВшАГш╡ДцЦЩ</h2> <p><a href="https://mp.weixin.qq.com/s/RsFUwyYyqQODFBItpL4DkA" target="_blank" rel="noopener noreferrer">ф╕АцЦЗцРЮцЗВNettyхПСщАБцХ░цНохЕиц╡БчиЛ | ф╜ацГ│чЯещБУчЪДч╗ЖшКВхЕихЬиш┐ЩщЗМ (qq.com)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/echo-lxy/echo-system-design/edit/master/docs/Netty ч│╗ч╗Яшо╛шоб/25.хЫЫуАБц╖▒хЕе Netty ца╕х┐Г/20.чммхЕншп╛я╝ЪNetty хжВф╜ХщлШцХИхПСщАБч╜Сч╗ЬцХ░цНо.md" target="_blank" rel="noopener noreferrer">ч╝Цш╛С</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">ф╕КцмбцЫ┤цЦ░ф║О:</span> <span class="time">2024/09/19, 08:16:36</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        тЖР
        <a href="/pages/d711b1/" class="prev">чммф║Фшп╛я╝ЪNetty хжВф╜ХщлШцХИцОецФ╢ч╜Сч╗ЬцХ░цНо</a></span> <span class="next"><a href="/pages/a1b0fe/">чммф╕Гшп╛я╝ЪNetty ф╕нIOф║Лф╗╢чЪДшзжхПСцЧ╢цЬ║хТМф╝ацТнц╡БчиЛ</a>тЖТ
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:lixinyang2002@163.com" title="хПСщВоф╗╢" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/echo-lxy" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="хРмщЯ│ф╣Р" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="цЬмчлЩф╕╗щвШ">Vdoing</a> 
    | Copyright ┬й 2024-2024
    <span>Xinyang Li | MIT License</span></div> <div class="buttons"><div title="ш┐ФхЫЮщб╢щГи" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="хО╗шпДшо║" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ф╕╗щвШцибх╝П" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          ш╖ЯщЪПч│╗ч╗Я
        </li><li class="iconfont icon-rijianmoshi">
          ц╡ЕшЙ▓цибх╝П
        </li><li class="iconfont icon-yejianmoshi">
          ц╖▒шЙ▓цибх╝П
        </li><li class="iconfont icon-yuedu">
          щШЕшп╗цибх╝П
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.59640afe.js" defer></script><script src="/assets/js/2.933750c6.js" defer></script><script src="/assets/js/56.9df87e2e.js" defer></script><script src="/assets/js/7.7eb70372.js" defer></script>
  </body>
</html>
