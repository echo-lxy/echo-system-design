<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>чммхЫЫшп╛я╝ЪNetty хжВф╜ХщлШцХИцОецФ╢ч╜Сч╗Ьш┐ЮцОе | EchoDesign</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="ч│╗ч╗Яшо╛шобф╣ЛуАМшо▓шзг + щЭвшпХцМЗхНЧуАНя╝Мц░┤ц╗┤чЯ│чй┐я╝Мшо╛шобцЧащУ╢х╝╣я╝Б">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.c76c3453.css" as="style"><link rel="preload" href="/assets/js/app.bdcc6820.js" as="script"><link rel="preload" href="/assets/js/2.933750c6.js" as="script"><link rel="preload" href="/assets/js/54.8604fc24.js" as="script"><link rel="preload" href="/assets/js/7.7eb70372.js" as="script"><link rel="prefetch" href="/assets/js/10.2cc95be8.js"><link rel="prefetch" href="/assets/js/100.152e23f6.js"><link rel="prefetch" href="/assets/js/101.99b73fec.js"><link rel="prefetch" href="/assets/js/11.c7521a10.js"><link rel="prefetch" href="/assets/js/12.38d1989d.js"><link rel="prefetch" href="/assets/js/13.850793b0.js"><link rel="prefetch" href="/assets/js/14.1141ec27.js"><link rel="prefetch" href="/assets/js/15.8f1b4081.js"><link rel="prefetch" href="/assets/js/16.e52ba8b4.js"><link rel="prefetch" href="/assets/js/17.acb3bf3d.js"><link rel="prefetch" href="/assets/js/18.5df2a013.js"><link rel="prefetch" href="/assets/js/19.571eaed1.js"><link rel="prefetch" href="/assets/js/20.fe7d08c7.js"><link rel="prefetch" href="/assets/js/21.0e0ed140.js"><link rel="prefetch" href="/assets/js/22.dd779f94.js"><link rel="prefetch" href="/assets/js/23.4d814163.js"><link rel="prefetch" href="/assets/js/24.e94253bb.js"><link rel="prefetch" href="/assets/js/25.1d172890.js"><link rel="prefetch" href="/assets/js/26.6337eac0.js"><link rel="prefetch" href="/assets/js/27.eeee1d20.js"><link rel="prefetch" href="/assets/js/28.6fa848cf.js"><link rel="prefetch" href="/assets/js/29.4ff6fa35.js"><link rel="prefetch" href="/assets/js/3.08ee786a.js"><link rel="prefetch" href="/assets/js/30.892b2994.js"><link rel="prefetch" href="/assets/js/31.df4cc39d.js"><link rel="prefetch" href="/assets/js/32.f1174703.js"><link rel="prefetch" href="/assets/js/33.64ab8d0c.js"><link rel="prefetch" href="/assets/js/34.405ab364.js"><link rel="prefetch" href="/assets/js/35.8287c9dc.js"><link rel="prefetch" href="/assets/js/36.be98cc35.js"><link rel="prefetch" href="/assets/js/37.82be3556.js"><link rel="prefetch" href="/assets/js/38.40fe2658.js"><link rel="prefetch" href="/assets/js/39.6e2f31a6.js"><link rel="prefetch" href="/assets/js/4.73518a0f.js"><link rel="prefetch" href="/assets/js/40.0ada49bd.js"><link rel="prefetch" href="/assets/js/41.fcee3e0f.js"><link rel="prefetch" href="/assets/js/42.f5fdb401.js"><link rel="prefetch" href="/assets/js/43.5a509601.js"><link rel="prefetch" href="/assets/js/44.64fd3383.js"><link rel="prefetch" href="/assets/js/45.685623ac.js"><link rel="prefetch" href="/assets/js/46.7624d38c.js"><link rel="prefetch" href="/assets/js/47.cc86aae6.js"><link rel="prefetch" href="/assets/js/48.ba7dfd47.js"><link rel="prefetch" href="/assets/js/49.15d8e916.js"><link rel="prefetch" href="/assets/js/5.94727770.js"><link rel="prefetch" href="/assets/js/50.b424b2c0.js"><link rel="prefetch" href="/assets/js/51.ef213b56.js"><link rel="prefetch" href="/assets/js/52.24cc5c91.js"><link rel="prefetch" href="/assets/js/53.16def11d.js"><link rel="prefetch" href="/assets/js/55.78a9171b.js"><link rel="prefetch" href="/assets/js/56.94e28708.js"><link rel="prefetch" href="/assets/js/57.9f8a974b.js"><link rel="prefetch" href="/assets/js/58.24008d78.js"><link rel="prefetch" href="/assets/js/59.28ca51b4.js"><link rel="prefetch" href="/assets/js/6.0b558b79.js"><link rel="prefetch" href="/assets/js/60.1714dba8.js"><link rel="prefetch" href="/assets/js/61.08b4acf0.js"><link rel="prefetch" href="/assets/js/62.cc8fdced.js"><link rel="prefetch" href="/assets/js/63.41ff19e4.js"><link rel="prefetch" href="/assets/js/64.9b3def35.js"><link rel="prefetch" href="/assets/js/65.0b2ab47d.js"><link rel="prefetch" href="/assets/js/66.2ae7a107.js"><link rel="prefetch" href="/assets/js/67.79dd6daf.js"><link rel="prefetch" href="/assets/js/68.c27f5109.js"><link rel="prefetch" href="/assets/js/69.5f61d937.js"><link rel="prefetch" href="/assets/js/70.b920a5f7.js"><link rel="prefetch" href="/assets/js/71.f44644ed.js"><link rel="prefetch" href="/assets/js/72.9a370df8.js"><link rel="prefetch" href="/assets/js/73.bc16a468.js"><link rel="prefetch" href="/assets/js/74.d9ad1a67.js"><link rel="prefetch" href="/assets/js/75.7c86d41a.js"><link rel="prefetch" href="/assets/js/76.15a7bb60.js"><link rel="prefetch" href="/assets/js/77.c89b4964.js"><link rel="prefetch" href="/assets/js/78.c0a4ffae.js"><link rel="prefetch" href="/assets/js/79.0906d2fb.js"><link rel="prefetch" href="/assets/js/8.0ec7f6e8.js"><link rel="prefetch" href="/assets/js/80.fdcb5fa1.js"><link rel="prefetch" href="/assets/js/81.711911b1.js"><link rel="prefetch" href="/assets/js/82.e54c087e.js"><link rel="prefetch" href="/assets/js/83.65db62ac.js"><link rel="prefetch" href="/assets/js/84.e5207e82.js"><link rel="prefetch" href="/assets/js/85.4cd3a775.js"><link rel="prefetch" href="/assets/js/86.931cbb70.js"><link rel="prefetch" href="/assets/js/87.47ba635a.js"><link rel="prefetch" href="/assets/js/88.93192130.js"><link rel="prefetch" href="/assets/js/89.e05e3a70.js"><link rel="prefetch" href="/assets/js/9.6e274fca.js"><link rel="prefetch" href="/assets/js/90.ca1ff100.js"><link rel="prefetch" href="/assets/js/91.8ad18b18.js"><link rel="prefetch" href="/assets/js/92.ec3a28ed.js"><link rel="prefetch" href="/assets/js/93.f8975bc4.js"><link rel="prefetch" href="/assets/js/94.1eade7f0.js"><link rel="prefetch" href="/assets/js/95.96f5db04.js"><link rel="prefetch" href="/assets/js/96.5ed2d348.js"><link rel="prefetch" href="/assets/js/97.4d4bfff5.js"><link rel="prefetch" href="/assets/js/98.18f62eb7.js"><link rel="prefetch" href="/assets/js/99.7d84cc97.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c76c3453.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="чЫох╜Х" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="EchoDesign" class="logo"> <span class="site-name can-hide">EchoDesign</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">ЁЯПащжЦщб╡</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">тЬТя╕ПчГнщЧичоЧц│Х</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕шо╛шоб" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕шо╛шоб</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ч│╗ч╗Яшо╛шоб</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">тЭУщЧочнФ</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ЁЯСАхКицАБ</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">ЁЯПащжЦщб╡</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">тЬТя╕ПчГнщЧичоЧц│Х</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕шо╛шоб" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕шо╛шоб</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ч│╗ч╗Яшо╛шоб</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">тЭУщЧочнФ</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ЁЯСАхКицАБ</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ф╕АуАБхЙНшиА</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ф║МуАБхЯ║чбАчЯешпЖ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ф╕ЙуАБф╕╗ч║┐ф╗╗хКб</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>хЫЫуАБц╖▒хЕе Netty ца╕х┐Г</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/65674f/" class="sidebar-link">чммф╕Ашп╛я╝ЪщАПш┐З Netty чЬЛ IO цибхЮЛ</a></li><li><a href="/pages/440035/" class="sidebar-link">чммф║Мшп╛я╝ЪReactorхЬи Netty ф╕нчЪДхоЮчО░я╝ИхИЫх╗║чпЗя╝Й</a></li><li><a href="/pages/bb668a/" class="sidebar-link">чммф╕Йшп╛я╝ЪNetty ца╕х┐Гх╝ХцУО Reactor чЪДш┐Рш╜мцЮ╢цЮД</a></li><li><a href="/pages/be98dc/" aria-current="page" class="active sidebar-link">чммхЫЫшп╛я╝ЪNetty хжВф╜ХщлШцХИцОецФ╢ч╜Сч╗Ьш┐ЮцОе</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/be98dc/#хЙНшиА" class="sidebar-link">хЙНшиА</a></li><li class="sidebar-sub-header level2"><a href="/pages/be98dc/#_1-main-reactor-хдДчРЖ-op-accept-ф║Лф╗╢" class="sidebar-link">1. Main Reactor хдДчРЖ OP_ACCEPT ф║Лф╗╢</a></li><li class="sidebar-sub-header level2"><a href="/pages/be98dc/#_2-цОецФ╢ховцИ╖члпш┐ЮцОеца╕х┐Гц╡БчиЛцбЖцЮ╢цА╗шзИ" class="sidebar-link">2. цОецФ╢ховцИ╖члпш┐ЮцОеца╕х┐Гц╡БчиЛцбЖцЮ╢цА╗шзИ</a></li><li class="sidebar-sub-header level2"><a href="/pages/be98dc/#_3-recvbytebufallocator-чоАф╗Л" class="sidebar-link">3. RecvByteBufAllocator чоАф╗Л</a></li><li class="sidebar-sub-header level2"><a href="/pages/be98dc/#_4-хХКхУИ-bug" class="sidebar-link">4. хХКхУИя╝Бя╝БBug ! !</a></li><li class="sidebar-sub-header level2"><a href="/pages/be98dc/#_5-doreadmessages-цОецФ╢ховцИ╖члпш┐ЮцОе" class="sidebar-link">5. doReadMessages цОецФ╢ховцИ╖члпш┐ЮцОе</a></li><li class="sidebar-sub-header level2"><a href="/pages/be98dc/#_6-channelread-ф║Лф╗╢чЪДхУНх║Ф" class="sidebar-link">6. ChannelRead ф║Лф╗╢чЪДхУНх║Ф</a></li><li class="sidebar-sub-header level2"><a href="/pages/be98dc/#_7-хРСsubreactorgroupф╕нц│ихЖМniosocketchannel" class="sidebar-link">7. хРСSubReactorGroupф╕нц│ихЖМNioSocketChannel</a></li><li class="sidebar-sub-header level2"><a href="/pages/be98dc/#цА╗ч╗У" class="sidebar-link">цА╗ч╗У</a></li><li class="sidebar-sub-header level2"><a href="/pages/be98dc/#хПВшАГш╡ДцЦЩ" class="sidebar-link">хПВшАГш╡ДцЦЩ</a></li></ul></li><li><a href="/pages/0938c1/" class="sidebar-link">чммф║Фшп╛я╝ЪNetty хжВф╜ХщлШцХИцОецФ╢ч╜Сч╗ЬцХ░цНо</a></li><li><a href="/pages/8ed7b8/" class="sidebar-link">чммхЕншп╛я╝ЪNetty хжВф╜ХщлШцХИхПСщАБч╜Сч╗ЬцХ░цНо</a></li><li><a href="/pages/a1b0fe/" class="sidebar-link">чммф╕Гшп╛я╝ЪNetty ф╕нIOф║Лф╗╢чЪДшзжхПСцЧ╢цЬ║хТМф╝ацТнц╡БчиЛ</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ф║ФуАБц╖▒хЕе Netty хЖЕхнШчобчРЖ</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="щжЦщб╡" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>Netty ч│╗ч╗Яшо╛шоб</span></li><li data-v-06225672><span data-v-06225672>хЫЫуАБц╖▒хЕе Netty ца╕х┐Г</span></li></ul> <div class="info" data-v-06225672><div title="ф╜ЬшАЕ" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/brother-one" target="_blank" title="ф╜ЬшАЕ" class="beLink" data-v-06225672>echo</a></div> <div title="хИЫх╗║цЧ╢щЧ┤" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-09-19</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">чЫох╜Х</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">чммхЫЫшп╛я╝ЪNetty хжВф╜ХщлШцХИцОецФ╢ч╜Сч╗Ьш┐ЮцОе<!----></h1> <div class="page-slot page-slot-top">
    <div class="wwads-cn wwads-horizontal page-wwads" data-id="136"></div>
    <style>
      .page-wwads{
        width:100%!important;
        min-height: 0;
        margin: 0;
      }
      .page-wwads .wwads-img img{
        width:80px!important;
      }
      .page-wwads .wwads-poweredby{
        width: 40px;
        position: absolute;
        right: 25px;
        bottom: 3px;
      }
      .wwads-content .wwads-text, .page-wwads .wwads-text{
        height: 100%;
        padding-top: 5px;
        display: block;
      }
  </style>
  </div> <div class="theme-vdoing-content content__default"><h2 id="хЙНшиА"><a href="#хЙНшиА" class="header-anchor">#</a> хЙНшиА</h2> <p>хп╣ф║Оф╕Аф╕кщлШцАзшГ╜ч╜Сч╗ЬщАЪшопцбЖцЮ╢цЭешп┤я╝МцЬАцЬАщЗНшжБф╣ЯцШпцЬАца╕х┐ГчЪДх╖еф╜Ьх░▒цШпхжВф╜ХщлШцХИчЪДцОецФ╢ховцИ╖члпш┐ЮцОея╝Мш┐Щх░▒хе╜цпФцИСф╗мх╝Аф║Жф╕Аф╕кщенх║Чя╝МщВгф╣Иш┐ОцОеховф║║х░▒цШпщенх║ЧцЬАщЗНшжБчЪДх╖еф╜Ья╝МцИСф╗мшжБхЕИцККховф║║ш┐ОцОеш┐ЫцЭея╝Мф╕НшГ╜шойховф║║ф╕АчЬЛф║║хдЪх░▒ш╡░цОЙя╝МхПкшжБховф║║ш┐ЫцЭеф║Жя╝МхУкцАХшПЬхБЪчЪДцЕвф╕АчВ╣ф╣Яц▓бхЕ│ч│╗уАВ</p> <p>цЬмцЦЗчмФшАЕх░▒цЭеф╕║хдзхо╢ф╗Лч╗Нф╕Лnettyш┐ЩхЭЧцЬАца╕х┐ГчЪДхЖЕхо╣я╝МчЬЛчЬЛnettyцШпхжВф╜ХщлШцХИчЪДцОецФ╢ховцИ╖члпш┐ЮцОечЪДуАВ</p> <p>ф╕ЛхЫ╛ф╕║чмФшАЕхЬиф╕Аф╕кцЬИщ╗СщгОщлШхдйчй║цШ╛х╛ЧщВгф╣Иц╖▒щВГщБеш┐ЬчЪДхдЬцЩЪя╝МщЧ▓цЭецЧаф║Ля╝Мф║ОцШпцНзш╡╖NettyхЕ│ф║ОхжВф╜ХцОецФ╢ш┐ЮцОеш┐ЩщГихИЖц║РчаБч╗Жч╗ЖхУБшп╗чЪДцЧ╢хАЩя╝МцДПхдЦчЪДхПСчО░ф║Жф╕Аф╕кх╜▒хУНNettyцОецФ╢ш┐ЮцОехРЮхРРчЪДф╕Аф╕кBugуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191110731.webp" alt="хЫ╛чЙЗ"></p> <p>ф║ОцШпчмФшАЕх░▒хЬиGithubцПРф║Жф╕Аф╕к?Issue#11708я╝МщШРш┐░ф║Жф╕Лш┐Щф╕кBugф║зчФЯчЪДхОЯхЫаф╗ехПКхп╝шЗ┤чЪДч╗УцЮЬх╣╢хТМNettyчЪДф╜ЬшАЕф╕Аш╡╖шоишо║ф║Жф╕Лф┐охдНцОкцЦ╜уАВхжВф╕КхЫ╛цЙАчд║уАВ</p> <blockquote><p>Issue#11708я╝Ъhttps://github.com/netty/netty/issues/11708</p></blockquote> <p>ш┐ЩщЗМхЕИф╕Ншпжч╗ЖшзгщЗКш┐Щф╕кIssueя╝Мф╣Яф╕Нх╗║шоохдзхо╢чО░хЬих░▒цЙУх╝Аш┐Щф╕кIssueцЯечЬЛя╝МчмФшАЕф╝ЪхЬицЬмцЦЗчЪДф╗Лч╗Нф╕нщЪПчЭАц║РчаБц╖▒хЕечЪДшзгшп╗цЕвцЕвчЪДф╕║хдзхо╢ф╕Ах▒Вф╕Ах▒ВхЬ░цЛих╝Аш┐╖щЫ╛уАВ</p> <p>ф╣ЛцЙАф╗ехЬицЦЗчлачЪДх╝Ахд┤цККш┐Щф╕кцЛОхЗ║цЭея╝МчмФшАЕцШпцГ│шойхдзхо╢х╕жчЭАцААчЦСя╝МхобшзЖя╝Мцмгш╡Пя╝Мх┤ЗцХмя╝МцХмчХПчЪДцАБх║жцЭеф╕Аш╡╖хУБшп╗ф╕ЦчХМщб╢ч║зчиЛх║ПхСШч╝ЦхЖЩчЪДф╗гчаБуАВчФ▒шб╖чЪДцДЯш░вф╗Цф╗мхЬиш┐Щф╕АщвЖхЯЯхБЪхЗ║чЪДш┤бчМоуАВ</p> <p>хе╜ф║Жя╝МщЧощвШцКЫхЗ║цЭехРОя╝МцИСф╗мх░▒х╕жчЭАш┐Щф╕кчЦСщЧоцЭех╝АхзЛцЬмцЦЗчЪДхЖЕхо╣хРз~~~</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191110723.webp" alt="хЫ╛чЙЗ"></p> <h3 id="хЙНцЦЗхЫЮщб╛"><a href="#хЙНцЦЗхЫЮщб╛" class="header-anchor">#</a> хЙНцЦЗхЫЮщб╛</h3> <p>цМЙчЕзшАБшзДчЯйя╝МхЖНх╝АхзЛцЬмцЦЗчЪДхЖЕхо╣ф╣ЛхЙНя╝МцИСф╗мхЕИцЭехЫЮщб╛ф╕ЛхЙНш╛╣хЗачпЗцЦЗчлачЪДцжВшжБхЖЕхо╣х╕охКйхдзхо╢цв│чРЖф╕Аф╕кцбЖцЮ╢хЕиш▓МхЗ║цЭеуАВ</p> <blockquote><p>чмФшАЕш┐ЩщЗМхЖНцмбцГ│хТМшп╗шАЕцЬЛхПЛф╗мх╝║ш░ГчЪДцШпцЬмцЦЗхПпф╗ечЛмчлЛшзВчЬЛя╝Мх╣╢ф╕Нф╛Эш╡ЦхЙНш╛╣ч│╗хИЧцЦЗчлачЪДхЖЕхо╣я╝МхПкцШпхдзхо╢хжВцЮЬхп╣чЫ╕хЕ│ч╗ЖшКВщГихИЖцДЯхЕ┤ш╢гчЪДшпЭя╝МхПпф╗ехЬищШЕшп╗хоМцЬмцЦЗф╣ЛхРОхЬихО╗хЫЮчЬЛчЫ╕хЕ│цЦЗчлауАВ</p></blockquote> <p>хЬихЙНш╛╣чЪДч│╗хИЧцЦЗчлаф╕ня╝МчмФшАЕф╕║хдзхо╢ф╗Лч╗Нф║Жщй▒хКиNettyцХ┤ф╕кцбЖцЮ╢ш┐Рш╜мчЪДца╕х┐Гх╝ХцУОReactorчЪДхИЫх╗║я╝МхРпхКия╝Мш┐РшбМчЪДхЕиц╡БчиЛуАВф╗ОчО░хЬих╝АхзЛNettyчЪДцХ┤ф╕кца╕х┐ГцбЖцЮ╢х░▒х╝АхзЛш┐Рш╜мш╡╖цЭех╝АхзЛх╖еф╜Ьф║Жя╝МцЬмцЦЗшжБф╗Лч╗НчЪДф╕╗шжБхЖЕхо╣х░▒цШпNettyхЬихРпхКиф╣ЛхРОшжБхБЪчЪДчммф╕Аф╗╢ф║Лф╗╢я╝ЪчЫСхРмчлпхПгхЬ░хЭАя╝МщлШцХИцОецФ╢ховцИ╖члпш┐ЮцОеуАВ</p> <p>хЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247483737&amp;idx=1&amp;sn=7ef3afbb54289c6e839eed724bb8a9d6&amp;chksm=ce77c71ef9004e08e3d164561e3a2708fc210c05408fa41f7fe338d8e85f39c1ad57519b614e&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">уАКшБКшБКNettyщВгф║Ыф║ЛхД┐ф╣Лф╗ОхЖЕца╕шзТх║жчЬЛIOцибхЮЛуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕АцЦЗф╕ня╝МцИСф╗мцШпф╗ОцХ┤ф╕кч╜Сч╗ЬцбЖцЮ╢чЪДхЯ║чЯ│IOцибхЮЛчЪДшзТх║жцХ┤ф╜УщШРш┐░ф║Жф╕ЛNettyчЪДIOч║┐чиЛцибхЮЛуАВ</p> <p>шАМNettyф╕нчЪДReactorцнгцШпIOч║┐чиЛхЬиNettyф╕нчЪДцибхЮЛхоЪф╣ЙуАВReactorхЬиNettyф╕нцШпф╗еGroupчЪДх╜вх╝ПхЗ║чО░чЪДя╝МхИЖф╕║:</p> <ul><li>ф╕╗Reactorч║┐чиЛч╗Дф╣Ях░▒цШпцИСф╗мхЬихРпхКиф╗гчаБф╕нщЕНч╜очЪД<code>EventLoopGroup bossGroup</code>,main reactor groupф╕нчЪДreactorф╕╗шжБш┤Яш┤гчЫСхРмховцИ╖члпш┐ЮцОеф║Лф╗╢я╝МщлШцХИчЪДхдДчРЖховцИ╖члпш┐ЮцОеуАВф╣ЯцШпцЬмцЦЗцИСф╗мшжБф╗Лч╗НчЪДщЗНчВ╣уАВ</li> <li>ф╗ОReactorч║┐чиЛч╗Дф╣Ях░▒цШпцИСф╗мхЬихРпхКиф╗гчаБф╕нщЕНч╜очЪД<code>EventLoopGroup workerGroup</code>я╝Мsub reactor groupф╕нчЪДreactorф╕╗шжБш┤Яш┤гхдДчРЖховцИ╖члпш┐ЮцОеф╕КчЪДIOф║Лф╗╢я╝Мф╗ехПКх╝Вцнеф╗╗хКбчЪДцЙзшбМуАВ</li></ul> <p>цЬАхРОцИСф╗мх╛ЧхЗ║NettyчЪДцХ┤ф╕кIOцибхЮЛхжВф╕Ля╝Ъ</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNialDtXCOD5vvVGh56FT2yKauwTch6oYbrn1icPuYKaqY8nPibicWv66sQfw/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="хЫ╛чЙЗ"></p> <p>цЬмцЦЗцИСф╗мшоишо║чЪДщЗНчВ╣х░▒цШп MainReactorGroup чЪДца╕х┐Гх╖еф╜Ьф╕КхЫ╛ф╕нцЙАчд║чЪДцнещкд1я╝Мцнещкд2я╝Мцнещкд3уАВ</p> <p>хЬиф╗ОцХ┤ф╜Уф╕Кф╗Лч╗НхоМNettyчЪДIOцибхЮЛф╣ЛхРОя╝МцИСф╗мхПИхЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247483907&amp;idx=1&amp;sn=084c470a8fe6234c2c9461b5f713ff30&amp;chksm=ce77c444f9004d52e7c6244bee83479070effb0bc59236df071f4d62e91e25f01715fca53696&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКReactorхЬиNettyф╕нчЪДхоЮчО░(хИЫх╗║чпЗ)уАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕нхоМцХ┤чЪДф╗Лч╗Нф║ЖNettyцбЖцЮ╢чЪДщкицЮ╢ф╕╗ф╗ОReactorч╗ДчЪДцРнх╗║ш┐ЗчиЛя╝МщШРш┐░ф║ЖReactorцШпхжВф╜ХшвлхИЫх╗║хЗ║цЭечЪДя╝Мх╣╢ф╗Лч╗Нф║ЖхоГчЪДца╕х┐Гч╗Дф╗╢хжВф╕ЛхЫ╛цЙАчд║я╝Ъ</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiaRn9ZX4dJLJdyxSEEXojs5lEmPNiaBfstFOG95KMGibJed4vo3xMhnE6g/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="хЫ╛чЙЗ"></p> <ul><li><code>thread</code>хН│ф╕║Reactorф╕нчЪДIOч║┐чиЛя╝Мф╕╗шжБш┤Яш┤гчЫСхРмIOф║Лф╗╢я╝МхдДчРЖIOф╗╗хКбя╝МцЙзшбМх╝Вцнеф╗╗хКбуАВ</li> <li><code>selector</code>хИЩцШпJDK NIOхп╣цУНф╜Ьч│╗ч╗Ях║Хх▒ВIOхдЪш╖пхдНчФицКАцЬпхоЮчО░чЪДх░БшгЕуАВчФиф║ОчЫСхРмIOх░▒ч╗кф║Лф╗╢уАВ</li> <li><code>taskQueue</code>чФиф║Оф┐ЭхнШReactorщЬАшжБцЙзшбМчЪДх╝Вцнеф╗╗хКбя╝Мш┐Щф║Ых╝Вцнеф╗╗хКбхПпф╗ечФ▒чФицИ╖хЬиф╕ЪхКбч║┐чиЛф╕нхРСReactorцПРф║дя╝Мф╣ЯхПпф╗ецШпNettyцбЖцЮ╢цПРф║дчЪДф╕Аф║ЫшЗкш║лца╕х┐ГчЪДф╗╗хКбуАВ</li> <li><code>scheduledTaskQueue</code>хИЩцШпф┐ЭхнШReactorф╕нцЙзшбМчЪДхоЪцЧ╢ф╗╗хКбуАВф╗гцЫ┐ф║ЖхОЯцЬЙчЪДцЧ╢щЧ┤ш╜оцЭецЙзшбМх╗╢цЧ╢ф╗╗хКбуАВ</li> <li><code>tailQueue</code>ф┐ЭхнШф║ЖхЬиReactorщЬАшжБцЙзшбМчЪДф╕Аф║Ых░╛щГицФ╢х░╛ф╗╗хКбя╝МхЬицЩощАЪф╗╗хКбцЙзшбМхоМхРО Reactorч║┐чиЛф╝ЪцЙзшбМх░╛щГиф╗╗хКбя╝МцпФхжВхп╣Netty чЪДш┐РшбМчК╢цАБхБЪф╕Аф║Ыч╗ЯшобцХ░цНоя╝Мф╛ЛхжВф╗╗хКбх╛кчОпчЪДшАЧцЧ╢уАБхНачФичЙйчРЖхЖЕхнШчЪДхдзх░ПчнЙчнЙ</li></ul> <p>хЬищкицЮ╢цРнх╗║хоМцпХф╣ЛхРОя╝МцИСф╗мщЪПхРОхПИхЬихЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484005&amp;idx=1&amp;sn=52f51269902a58f40d33208421109bc3&amp;chksm=ce77c422f9004d340e5b385ef6ba24dfba1f802076ace80ad6390e934173a10401e64e13eaeb&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКшпжч╗ЖхЫ╛шзгNetty ReactorхРпхКихЕиц╡БчиЛуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>уАЛф╕АцЦЗф╕нф╗Лч╗Нф║Ж<strong>цЬмцЦЗчЪДф╕╗шзТцЬНхКбчлпNioServerSocketChannelчЪДхИЫх╗║я╝МхИЭхзЛхМЦя╝Мч╗СхоЪчлпхПгхЬ░хЭАя╝МхРСmain reactorц│ихЖМчЫСхРм<code>OP_ACCEPTф║Лф╗╢</code>чЪДхоМцХ┤ш┐ЗчиЛ</strong>уАВ</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiaMNnpeQav9HykpMEYenDPdshUtLBMicYHd5F9HwloOsE6FfLVtGW0XRA/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="хЫ╛чЙЗ"></p> <p>main reactor хжВф╜ХхдДчРЖ OP_ACCEPT ф║Лф╗╢х░Жф╝ЪцШпцЬмцЦЗчЪДф╕╗шжБхЖЕхо╣уАВ</p> <p>шЗкцндNettyцбЖцЮ╢чЪДmain reactor groupх╖▓ч╗ПхРпхКихоМцпХя╝Мх╝АхзЛхЗЖхдЗчЫСхРмOP_acceptф║Лф╗╢я╝Мх╜УховцИ╖члпш┐ЮцОеф╕КцЭеф╣ЛхРОя╝МOP_ACCEPTф║Лф╗╢ц┤╗ш╖Гя╝Мmain reactorх╝АхзЛхдДчРЖOP_ACCEPTф║Лф╗╢цОецФ╢ховцИ╖члпш┐ЮцОеф║ЖуАВ</p> <p>шАМnettyф╕нчЪДIOф║Лф╗╢хИЖф╕║я╝ЪOP_ACCEPTф║Лф╗╢я╝МOP_READф║Лф╗╢я╝МOP_WRITEф║Лф╗╢хТМOP_CONNECTф║Лф╗╢</p> <p>nettyхп╣ф║ОIOф║Лф╗╢чЪДчЫСхРмхТМхдДчРЖч╗Яф╕Ах░БшгЕхЬиReactorцибхЮЛф╕ня╝Мш┐ЩхЫЫф╕кIOф║Лф╗╢чЪДхдДчРЖш┐ЗчиЛф╣ЯцШпцИСф╗мхРОч╗нцЦЗчлаф╕ншжБхНХчЛмцЛ┐хЗ║цЭеф╗Лч╗НчЪДя╝МцЬмцЦЗцИСф╗мшБЪчДжOP_ACCEPTф║Лф╗╢чЪДхдДчРЖуАВ</p> <p>шАМф╕║ф║Жшойхдзхо╢шГ╜хдЯхп╣IOф║Лф╗╢чЪДхдДчРЖцЬЙф╕Аф╕кхоМцХ┤цАзчЪДшодшпЖя╝МчмФшАЕхЖЩф║Ж<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484087&amp;idx=1&amp;sn=0c065780e0f05c23c8e6465ede86cba0&amp;chksm=ce77c4f0f9004de63be369a664105708bc5975b52993f4a6df223caed34cc1ef6185a16acd75&amp;token=997171731&amp;lang=zh_CN&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКф╕АцЦЗшБКщАПNettyца╕х┐Гх╝ХцУОReactorчЪДш┐Рш╜мцЮ╢цЮДуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ш┐ЩчпЗцЦЗчлая╝МхЬицЦЗчлаф╕ншпжч╗Жф╗Лч╗Нф║ЖReactorч║┐чиЛчЪДцХ┤ф╜Уш┐РшбМцбЖцЮ╢уАВ</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiavrDh48SPMAM6BFPzvme6iceQT8aibcKY54GLfSOm2F7yCqynlkI9HkOg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="хЫ╛чЙЗ"></p> <p>Reactor ч║┐чиЛф╝ЪхЬиф╕Аф╕кцн╗х╛кчОпф╕н 996 ф╕НхБЬчЪДш┐Рш╜мя╝МхЬих╛кчОпф╕нф╝Ъф╕НцЦнчЪДш╜ошпвчЫСхРм Selector ф╕КчЪДIOф║Лф╗╢я╝Мх╜У IO ф║Лф╗╢ц┤╗ш╖ГхРОя╝МReactorф╗ОSelector ф╕КшвлхФдщЖТш╜мхО╗цЙзшбМ IO х░▒ч╗кф║Лф╗╢чЪДхдДчРЖя╝МхЬиш┐Щф╕кш┐ЗчиЛф╕нцИСф╗мх╝ХхЗ║ф║Жф╕Кш┐░хЫЫчзНIOф║Лф╗╢чЪДхдДчРЖхЕехПгхЗ╜цХ░уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processSelectedKey</span><span class="token punctuation">(</span><span class="token class-name">SelectionKey</span> k<span class="token punctuation">,</span> <span class="token class-name">AbstractNioChannel</span> ch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//шО╖хПЦChannelчЪДх║Хх▒ВцУНф╜Ьч▒╗Unsafe</span>
    <span class="token keyword">final</span> <span class="token class-name">AbstractNioChannel<span class="token punctuation">.</span>NioUnsafe</span> unsafe <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>k<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>хжВцЮЬ<span class="token class-name">SelectionKey</span>х╖▓ч╗Пхд▒цХИхИЩхЕ│щЧнхп╣х║ФчЪД<span class="token class-name">Channel</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//шО╖хПЦIOх░▒ч╗кф║Лф╗╢</span>
        <span class="token keyword">int</span> readyOps <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">readyOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//хдДчРЖConnectф║Лф╗╢</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readyOps <span class="token operator">&amp;</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_CONNECT</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> ops <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//чз╗щЩдхп╣Connectф║Лф╗╢чЪДчЫСхРмя╝МхРжхИЩSelectorф╝Ъф╕АчЫ┤щАЪчЯе</span>
            ops <span class="token operator">&amp;=</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_CONNECT</span><span class="token punctuation">;</span>
            k<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span>ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//шзжхПСchannelActiveф║Лф╗╢хдДчРЖConnectф║Лф╗╢</span>
            unsafe<span class="token punctuation">.</span><span class="token function">finishConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//хдДчРЖWriteф║Лф╗╢</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readyOps <span class="token operator">&amp;</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_WRITE</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ch<span class="token punctuation">.</span><span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forceFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//хдДчРЖReadф║Лф╗╢цИЦшАЕAcceptф║Лф╗╢</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readyOps <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_READ</span> <span class="token operator">|</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_ACCEPT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> readyOps <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            unsafe<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CancelledKeyException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        unsafe<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">voidPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цЬмцЦЗчмФшАЕх░Жф╝Ъф╕║хдзхо╢щЗНчВ╣ф╗Лч╗Н<code>OP_ACCEPTф║Лф╗╢</code>чЪДхдДчРЖхЕехПгхЗ╜цХ░<code>unsafe.read()</code>чЪДцХ┤ф╕кц║РчаБхоЮчО░уАВ</p> <p>х╜УховцИ╖члпш┐ЮцОехоМцИРф╕ЙцмбцПбцЙЛф╣ЛхРОя╝Мmain reactor ф╕нчЪД selector ф║зчФЯ<code>OP_ACCEPTф║Лф╗╢</code>ц┤╗ш╖Гя╝Мmain reactor щЪПхН│швлхФдщЖТя╝МцЭехИ░ф║Ж<code>OP_ACCEPTф║Лф╗╢</code>чЪДхдДчРЖхЕехПгхЗ╜цХ░х╝АхзЛцОецФ╢ховцИ╖члпш┐ЮцОе</p> <h2 id="_1-main-reactor-хдДчРЖ-op-accept-ф║Лф╗╢"><a href="#_1-main-reactor-хдДчРЖ-op-accept-ф║Лф╗╢" class="header-anchor">#</a> 1. Main Reactor хдДчРЖ OP_ACCEPT ф║Лф╗╢</h2> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191519260.webp" alt="хЫ╛чЙЗ"></p> <p>х╜У<code>Main Reactor</code>ш╜ошпвхИ░<code>NioServerSocketChannel</code>ф╕КчЪД<code>OP_ACCEPTф║Лф╗╢</code>х░▒ч╗кцЧ╢я╝МMain Reactorч║┐чиЛх░▒ф╝Ъф╗О<code>JDK Selector</code>ф╕КчЪДщШ╗хбЮш╜ошпвAPI<code>selector.select(timeoutMillis)</code>ш░ГчФиф╕нш┐ФхЫЮуАВш╜мшАМхО╗хдДчРЖ<code>NioServerSocketChannel</code>ф╕КчЪД<code>OP_ACCEPTф║Лф╗╢</code>уАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">NioEventLoop</span> <span class="token keyword">extends</span> <span class="token class-name">SingleThreadEventLoop</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processSelectedKey</span><span class="token punctuation">(</span><span class="token class-name">SelectionKey</span> k<span class="token punctuation">,</span> <span class="token class-name">AbstractNioChannel</span> ch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">AbstractNioChannel<span class="token punctuation">.</span>NioUnsafe</span> unsafe <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> readyOps <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">readyOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readyOps <span class="token operator">&amp;</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_CONNECT</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>хдДчРЖ<span class="token constant">OP_CONNECT</span>ф║Лф╗╢<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>


            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readyOps <span class="token operator">&amp;</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_WRITE</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>хдДчРЖ<span class="token constant">OP_WRITE</span>ф║Лф╗╢<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>


            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readyOps <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_READ</span> <span class="token operator">|</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_ACCEPT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> readyOps <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//цЬмцЦЗщЗНчВ╣хдДчРЖOP_ACCEPTф║Лф╗╢</span>
                unsafe<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CancelledKeyException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            unsafe<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">voidPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><ul><li>хдДчРЖIOх░▒ч╗кф║Лф╗╢чЪДхЕехПгхЗ╜цХ░<code>processSelectedKey</code>ф╕нчЪДхПВцХ░<code>AbstractNioChannel ch</code>цнгцШпNettyцЬНхКбчлп<code>NioServerSocketChannel</code>уАВхЫаф╕║цндцЧ╢чЪДцЙзшбМч║┐чиЛф╕║main reactorч║┐чиЛя╝МшАМmain reactorф╕Кц│ихЖМчЪДцнгцШпnettyцЬНхКбчлпNioServerSocketChannelш┤Яш┤гчЫСхРмчлпхПгхЬ░хЭАя╝МцОецФ╢ховцИ╖члпш┐ЮцОеуАВ</li> <li>щАЪш┐З<code>ch.unsafe()</code>шО╖хПЦхИ░чЪДNioUnsafeцУНф╜Ьч▒╗цнгцШпNioServerSocketChannelф╕нхп╣х║Хх▒ВJDK NIO ServerSocketChannelчЪДUnsafeх║Хх▒ВцУНф╜Ьч▒╗уАВ</li></ul> <blockquote><p><code>UnsafeцОехПг</code>цШпNettyхп╣Channelх║Хх▒ВцУНф╜ЬшбМф╕║чЪДх░БшгЕя╝МцпФхжВNioServerSocketChannelчЪДх║Хх▒ВUnsafeцУНф╜Ьч▒╗х╣▓чЪДф║ЛцГЕх░▒цШп<code>ч╗СхоЪчлпхПгхЬ░хЭА</code>я╝М<code>хдДчРЖOP_ACCEPTф║Лф╗╢</code>уАВ</p></blockquote> <p>ш┐ЩщЗМцИСф╗мчЬЛхИ░я╝МNettyх░Ж<code>OP_ACCEPTф║Лф╗╢</code>хдДчРЖчЪДхЕехПгхЗ╜цХ░х░БшгЕхЬи<code>NioServerSocketChannel</code>щЗМчЪДх║Хх▒ВцУНф╜Ьч▒╗UnsafeчЪД<code>read</code>цЦ╣ц│Хф╕нуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191519555.webp" alt="хЫ╛чЙЗ"></p> <p>шАМNioServerSocketChannelф╕нчЪДUnsafeцУНф╜Ьч▒╗хоЮчО░ч▒╗хЮЛф╕║<code>NioMessageUnsafe</code>хоЪф╣ЙхЬиф╕КхЫ╛ч╗зцЙ┐ч╗УцЮДф╕нчЪД<code>AbstractNioMessageChannelчИ╢ч▒╗ф╕н</code></p> <p>ф╕ЛщЭвцИСф╗мхИ░<code>NioMessageUnsafe#read</code>цЦ╣ц│Хф╕нцЭечЬЛф╕ЛNettyхп╣<code>OP_ACCPETф║Лф╗╢</code>чЪДхЕ╖ф╜УхдДчРЖш┐ЗчиЛя╝Ъ</p> <h2 id="_2-цОецФ╢ховцИ╖члпш┐ЮцОеца╕х┐Гц╡БчиЛцбЖцЮ╢цА╗шзИ"><a href="#_2-цОецФ╢ховцИ╖члпш┐ЮцОеца╕х┐Гц╡БчиЛцбЖцЮ╢цА╗шзИ" class="header-anchor">#</a> 2. цОецФ╢ховцИ╖члпш┐ЮцОеца╕х┐Гц╡БчиЛцбЖцЮ╢цА╗шзИ</h2> <p>цИСф╗мш┐ШцШпцМЙчЕзшАБшзДчЯйя╝МхЕИф╗ОцХ┤ф╜Уф╕КцККцХ┤ф╕к OP_ACCEPT ф║Лф╗╢чЪДщА╗ш╛СхдДчРЖцбЖцЮ╢цПРхПЦхЗ║цЭея╝Мшойхдзхо╢хЕИцА╗ф╜Уф┐пшзЖф╕Лц╡БчиЛхЕиш▓Мя╝МчД╢хРОхЬищТИхп╣цпПф╕кца╕х┐ГчВ╣ф╜Нш┐ЫшбМхРДф╕кхЗ╗ча┤</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191520806.webp" alt="хЫ╛чЙЗ"></p> <p>main reactor ч║┐чиЛцШпхЬиф╕Аф╕к<code>do...while{...}</code>х╛кчОп read loopф╕нф╕НцЦнчЪДш░ГчФи JDK NIO <code>serverSocketChannel.accept()</code>цЦ╣ц│ХцЭецОецФ╢хоМцИРф╕ЙцмбцПбцЙЛчЪДховцИ╖члпш┐ЮцОе <code>NioSocketChannel</code> чЪДя╝Мх╣╢х░ЖцОецФ╢хИ░чЪДховцИ╖члпш┐ЮцОе NioSocketChannel ф╕┤цЧ╢ф┐ЭхнШхЬи<code>List&lt;Object&gt; readBuf</code>щЫЖхРИф╕ня╝МхРОч╗нф╝ЪцЬНхКбчлпNioServerSocketChannelчЪДpipelineф╕нщАЪш┐ЗChannelReadф║Лф╗╢цЭеф╝ащАТя╝МцЬАч╗Иф╝ЪхЬиServerBootstrapAcceptorш┐Щф╕кChannelHandlerф╕ншвлхдДчРЖхИЭхзЛхМЦя╝Мх╣╢х░ЖхЕ╢ц│ихЖМхИ░Sub Reator Groupф╕н</p> <p>ш┐ЩщЗМчЪДread loopх╛кчОпф╝ЪшвлщЩРхоЪхПкшГ╜шп╗хПЦ<strong>16цмб</strong>я╝Мх╜Уmain reactorф╗ОNioServerSocketChannelф╕ншп╗хПЦховцИ╖члпш┐ЮцОеNioSocketChannelчЪДцмбцХ░ш╛╛хИ░<strong>16цмб</strong>ф╣ЛхРОя╝МцЧашо║цндцЧ╢цШпхРжш┐ШцЬЙховцИ╖члпш┐ЮцОещГ╜ф╕НшГ╜хЬич╗зч╗ншп╗хПЦф║ЖуАВ</p> <p>хЫаф╕║цИСф╗мхЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484087&amp;idx=1&amp;sn=0c065780e0f05c23c8e6465ede86cba0&amp;chksm=ce77c4f0f9004de63be369a664105708bc5975b52993f4a6df223caed34cc1ef6185a16acd75&amp;token=997171731&amp;lang=zh_CN&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКф╕АцЦЗшБКщАПNettyца╕х┐Гх╝ХцУОReactorчЪДш┐Рш╜мцЮ╢цЮДуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕АцЦЗф╕нцПРхИ░я╝Мnetty хп╣ reactor ч║┐чиЛхОЛцжичЪДцпФш╛ГчЛая╝МшжБх╣▓чЪДф║ЛцГЕх╛ИхдЪя╝МщЩдф║ЖшжБчЫСхРмш╜ошпвIOх░▒ч╗кф║Лф╗╢я╝МхдДчРЖ IO х░▒ч╗кф║Лф╗╢я╝Мш┐ШщЬАшжБцЙзшбМчФицИ╖хТМ netty цбЖцЮ╢цЬмш║лцПРф║дчЪДх╝Вцнеф╗╗хКбхТМхоЪцЧ╢ф╗╗хКбуАВ</p> <p>цЙАф╗еш┐ЩщЗМчЪДmain reactorч║┐чиЛф╕НшГ╜хЬиread loopф╕нцЧащЩРхИ╢чЪДцЙзшбМф╕ЛхО╗я╝МхЫаф╕║ш┐ШщЬАшжБхИЖщЕНцЧ╢щЧ┤хО╗цЙзшбМх╝Вцнеф╗╗хКбя╝Мф╕НшГ╜хЫаф╕║цЧащЩРхИ╢чЪДцОецФ╢ховцИ╖члпш┐ЮцОешАМшА╜шппф║Жх╝Вцнеф╗╗хКбчЪДцЙзшбМуАВцЙАф╗еш┐ЩщЗМх░Ж read loop чЪДх╛кчОпцмбцХ░щЩРхоЪф╕║16цмб</p> <p>хжВцЮЬ main reactor ч║┐чиЛхЬиread loopф╕ншп╗хПЦховцИ╖члпш┐ЮцОеNioSocketChannelчЪДцмбцХ░х╖▓ч╗Пц╗бф║Ж16цмбя╝МхН│ф╜┐цндцЧ╢ш┐ШцЬЙховцИ╖члпш┐ЮцОецЬкцОецФ╢я╝МщВгф╣Иmain reactorч║┐чиЛф╣Яф╕Нф╝ЪхЖНхО╗цОецФ╢ф║Жя╝МшАМцШпш╜мхО╗цЙзшбМх╝Вцнеф╗╗хКбя╝Мх╜Ух╝Вцнеф╗╗хКбцЙзшбМхоМцпХхРОя╝Мш┐Шф╝ЪхЬихЫЮцЭецЙзшбМхЙйф╜ЩцОецФ╢ш┐ЮцОечЪДф╗╗хКбуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191522085.webp" alt="хЫ╛чЙЗ"></p> <p>main reactorч║┐чиЛщААхЗ║ read loop х╛кчОпчЪДцЭбф╗╢цЬЙф╕дф╕кя╝Ъ</p> <ol><li>хЬищЩРхоЪчЪД16цмбшп╗хПЦф╕ня╝Мх╖▓ч╗Пц▓бцЬЙцЦ░чЪДховцИ╖члпш┐ЮцОешжБцОецФ╢ф║ЖуАВщААхЗ║х╛кчОпуАВ</li> <li>ф╗ОNioServerSocketChannelф╕ншп╗хПЦховцИ╖члпш┐ЮцОечЪДцмбцХ░ш╛╛хИ░ф║Ж16цмбя╝МцЧашо║цндцЧ╢цШпхРжш┐ШцЬЙховцИ╖члпш┐ЮцОещГ╜щЬАшжБщААхЗ║х╛кчОпуАВ</li></ol> <p>ф╗еф╕Кх░▒цШпNettyхЬицОецФ╢ховцИ╖члпш┐ЮцОецЧ╢чЪДцХ┤ф╜Уца╕х┐ГщА╗ш╛Ся╝Мф╕ЛщЭвчмФшАЕх░Жш┐ЩщГихИЖщА╗ш╛СчЪДца╕х┐Гц║РчаБхоЮчО░цбЖцЮ╢цПРхПЦхЗ║цЭея╝МцЦ╣ф╛┐хдзхо╢ца╣цНоф╕Кш┐░ца╕х┐ГщА╗ш╛Сф╕Оц║РчаБф╕нчЪДхдДчРЖцибхЭЧхп╣х║Фш╡╖цЭея╝Мш┐ШцШпщВгхПешпЭя╝Мш┐ЩщЗМхПкщЬАшжБцА╗ф╜УцККцПбца╕х┐ГхдДчРЖц╡БчиЛя╝Мф╕НщЬАшжБшп╗цЗВцпПф╕АшбМф╗гчаБя╝МчмФшАЕф╝ЪхЬицЦЗчлачЪДхРОш╛╣хИЖцибхЭЧцЭехРДф╕кхЗ╗ча┤хоГф╗муАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractNioMessageChannel</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractNioChannel</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">NioMessageUnsafe</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractNioUnsafe</span> <span class="token punctuation">{</span>

        <span class="token comment">//хнШцФ╛ш┐ЮцОех╗║члЛхРОя╝МхИЫх╗║чЪДховцИ╖члпSocketChannel</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> readBuf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//х┐Ещб╗хЬиMain Reactorч║┐чиЛф╕нцЙзшбМ</span>
            <span class="token keyword">assert</span> <span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//ц│ицДПф╕ЛщЭвчЪДconfigхТМpipelineщГ╜цШпцЬНхКбчлпServerSocketChannelф╕нчЪД</span>
            <span class="token keyword">final</span> <span class="token class-name">ChannelConfig</span> config <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> <span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//хИЫх╗║цОецФ╢цХ░цНоBufferхИЖщЕНхЩия╝ИчФиф║ОхИЖщЕНхо╣щЗПхдзх░ПхРИщАВчЪДbyteBufferчФицЭехо╣ч║│цОецФ╢цХ░цНоя╝Й</span>
            <span class="token comment">//хЬицОецФ╢ш┐ЮцОечЪДхЬ║цЩпф╕ня╝Мш┐ЩщЗМчЪДallocHandleхПкцШпчФиф║ОцОзхИ╢read loopчЪДх╛кчОпшп╗хПЦхИЫх╗║ш┐ЮцОечЪДцмбцХ░уАВ</span>
            <span class="token keyword">final</span> <span class="token class-name">RecvByteBufAllocator<span class="token punctuation">.</span>Handle</span> allocHandle <span class="token operator">=</span> <span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">recvBufAllocHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            allocHandle<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">boolean</span> closed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token class-name">Throwable</span> exception <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">do</span> <span class="token punctuation">{</span>
                        <span class="token comment">//х║Хх▒Вш░ГчФиNioServerSocketChannel-&gt;doReadMessages хИЫх╗║ховцИ╖члпSocketChannel</span>
                        <span class="token keyword">int</span> localRead <span class="token operator">=</span> <span class="token function">doReadMessages</span><span class="token punctuation">(</span>readBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">//х╖▓цЧацЦ░чЪДш┐ЮцОехПпцОецФ╢хИЩщААхЗ║read loop</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>localRead <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>localRead <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            closed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment">//ч╗ЯшобхЬих╜УхЙНф║Лф╗╢х╛кчОпф╕нх╖▓ч╗Пшп╗хПЦхИ░х╛ЧMessageцХ░щЗПя╝ИхИЫх╗║ш┐ЮцОечЪДф╕кцХ░я╝Й</span>
                        allocHandle<span class="token punctuation">.</span><span class="token function">incMessagesRead</span><span class="token punctuation">(</span>localRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>allocHandle<span class="token punctuation">.</span><span class="token function">continueReading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//хИдцЦнцШпхРжх╖▓ч╗Пшп╗ц╗б16цмб</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    exception <span class="token operator">=</span> t<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">int</span> size <span class="token operator">=</span> readBuf<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    readPending <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token comment">//хЬиNioServerSocketChannelхп╣х║ФчЪДpipelineф╕нф╝ацТнChannelReadф║Лф╗╢</span>
                    <span class="token comment">//хИЭхзЛхМЦховцИ╖члпSocketChannelя╝Мх╣╢х░ЖхЕ╢ч╗СхоЪхИ░Sub Reactorч║┐чиЛч╗Дф╕нчЪДф╕Аф╕кReactorф╕К</span>
                    pipeline<span class="token punctuation">.</span><span class="token function">fireChannelRead</span><span class="token punctuation">(</span>readBuf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//ц╕ЕщЩдцЬмцмбaccept хИЫх╗║чЪДховцИ╖члпSocketChannelщЫЖхРИ</span>
                readBuf<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                allocHandle<span class="token punctuation">.</span><span class="token function">readComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//шзжхПСreadCompleteф║Лф╗╢ф╝ацТн</span>
                pipeline<span class="token punctuation">.</span><span class="token function">fireChannelReadComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ш┐ЩщЗМщжЦхЕИшжБщАЪш┐ЗцЦншиА<code>assert eventLoop().inEventLoop()</code>чбоф┐ЭхдДчРЖцОецФ╢ховцИ╖члпш┐ЮцОечЪДч║┐чиЛх┐Ещб╗ф╕║Main Reactor ч║┐чиЛуАВ</p> <p>шАМmain reactorф╕нф╕╗шжБц│ихЖМчЪДцШпцЬНхКбчлп NioServerSocketChannelя╝Мф╕╗шжБш┤Яш┤гхдДчРЖ<code>OP_ACCEPTф║Лф╗╢</code>я╝МцЙАф╗ех╜УхЙНmain reactorч║┐чиЛцШпхЬиNioServerSocketChannelф╕нцЙзшбМцОецФ╢ш┐ЮцОечЪДх╖еф╜ЬуАВ</p> <p>цЙАф╗еш┐ЩщЗМцИСф╗мщАЪш┐З<code>config()</code>шО╖хПЦхИ░чЪДцШпNioServerSocketChannelчЪДх▒ЮцАзщЕНч╜оч▒╗<code>NioServerSocketChannelConfig</code>,хоГцШпхЬиReactorчЪДхРпхКищШ╢цо╡швлхИЫх╗║хЗ║цЭечЪДуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">(</span><span class="token class-name">ServerSocketChannel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//чИ╢ч▒╗AbstractNioChannelф╕нф┐ЭхнШJDK NIOхОЯчФЯServerSocketChannelф╗ехПКшжБчЫСхРмчЪДф║Лф╗╢OP_ACCEPT</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> channel<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_ACCEPT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//DefaultChannelConfigф╕ншо╛ч╜очФиф║ОChannelцОецФ╢цХ░цНочФичЪДbuffer-&gt;AdaptiveRecvByteBufAllocator</span>
    config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioServerSocketChannelConfig</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хРМчРЖш┐ЩщЗМщАЪш┐З<code>pipeline()</code>шО╖хПЦхИ░чЪДф╣ЯцШпNioServerSocketChannelф╕нчЪД<code>pipeline</code>уАВхоГф╝ЪхЬиNioServerSocketChannelхРСmain reactorц│ихЖМцИРхКЯф╣ЛхРОшвлхИЭхзЛхМЦуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191524947.webp" alt="хЫ╛чЙЗ"></p> <p>хЙНш╛╣цПРхИ░main reactorч║┐чиЛф╝ЪшвлщЩРхоЪхПкшГ╜хЬиread loopф╕нхРСNioServerSocketChannelшп╗хПЦ16цмбховцИ╖члпш┐ЮцОея╝МцЙАф╗ехЬих╝АхзЛread loopф╣ЛхЙНя╝МцИСф╗мщЬАшжБхИЫх╗║ф╕Аф╕кшГ╜хдЯф┐ЭхнШшо░х╜Хшп╗хПЦцмбцХ░чЪДхп╣ш▒бя╝МхЬицпПцмбread loopх╛кчОпф╣ЛхРОя╝МхПпф╗еца╣цНош┐Щф╕кхп╣ш▒бцЭехИдцЦнцШпхРжч╗УцЭЯread loopуАВ</p> <p>ш┐Щф╕кхп╣ш▒бх░▒цШпш┐ЩщЗМчЪД <code>RecvByteBufAllocator.Handle allocHandle</code>ф╕УщЧичФиф║Оч╗Яшобread loopф╕нцОецФ╢ховцИ╖члпш┐ЮцОечЪДцмбцХ░я╝Мф╗ехПКхИдцЦнцШпхРжшпеч╗УцЭЯread loopш╜мхО╗цЙзшбМх╝Вцнеф╗╗хКбуАВ</p> <p>х╜Уш┐Щф╕АхИЗхЗЖхдЗх░▒ч╗кф╣ЛхРОя╝Мmain reactor ч║┐чиЛх░▒х╝АхзЛхЬи<code>do{....}while(...)</code>х╛кчОпф╕нцОецФ╢ховцИ╖члпш┐ЮцОеф║ЖуАВ</p> <p>хЬи read loopф╕нщАЪш┐Зш░ГчФи<code>doReadMessagesхЗ╜цХ░</code>цОецФ╢хоМцИРф╕ЙцмбцПбцЙЛчЪДховцИ╖члпш┐ЮцОея╝Мх║Хх▒Вф╝Ъш░ГчФихИ░JDK NIO ServerSocketChannelчЪДacceptцЦ╣ц│Хя╝Мф╗ОхЖЕца╕хЕиш┐ЮцОещШЯхИЧф╕нхПЦхЗ║ховцИ╖члпш┐ЮцОеуАВ</p> <p>ш┐ФхЫЮхА╝<code>localRead</code>шбичд║цОецФ╢хИ░ф║ЖхдЪх░СховцИ╖члпш┐ЮцОея╝МховцИ╖члпш┐ЮцОещАЪш┐ЗacceptцЦ╣ц│ХхПкф╝Ъф╕Аф╕кф╕Аф╕кчЪДцОецФ╢я╝МцЙАф╗еш┐ЩщЗМчЪД<code>localRead</code>цнгх╕╕цГЕхЖ╡ф╕ЛщГ╜ф╝Ъш┐ФхЫЮ<code>1</code>я╝Мх╜У<code>localRead &lt;= 0</code>цЧ╢цДПхС│чЭАх╖▓ч╗Пц▓бцЬЙцЦ░чЪДховцИ╖члпш┐ЮцОехПпф╗ецОецФ╢ф║Жя╝МцЬмцмбmain reactorцОецФ╢ховцИ╖члпчЪДф╗╗хКбхИ░ш┐ЩщЗМх░▒ч╗УцЭЯф║Жя╝Мш╖│хЗ║read loopуАВх╝АхзЛцЦ░чЪДф╕Аш╜оIOф║Лф╗╢чЪДчЫСхРмхдДчРЖуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">SocketChannel</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ServerSocketChannel</span> serverSocketChannel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedExceptionAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">SocketChannel</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> serverSocketChannel<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PrivilegedActionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span><span class="token punctuation">)</span> e<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>щЪПхРОф╝Ъх░ЖцОецФ╢хИ░чЪДховцИ╖члпш┐ЮцОехНацЧ╢хнШцФ╛хИ░<code>List&lt;Object&gt; readBuf</code>щЫЖхРИф╕нуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">NioMessageUnsafe</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractNioUnsafe</span> <span class="token punctuation">{</span>

    <span class="token comment">//хнШцФ╛ш┐ЮцОех╗║члЛхРОя╝МхИЫх╗║чЪДховцИ╖члпSocketChannel</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> readBuf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ш░ГчФи<code>allocHandle.incMessagesRead</code>ч╗ЯшобцЬмцмбф║Лф╗╢х╛кчОпф╕нцОецФ╢хИ░чЪДховцИ╖члпш┐ЮцОеф╕кцХ░я╝МцЬАхРОхЬиread loopцЬлх░╛щАЪш┐З<code>allocHandle.continueReading</code>хИдцЦнцШпхРжш╛╛хИ░ф║ЖщЩРхоЪчЪД16цмбуАВф╗ОшАМхЖ│хоЪmain reactorч║┐чиЛцШпч╗зч╗нцОецФ╢ховцИ╖члпш┐ЮцОеш┐ШцШпш╜мхО╗цЙзшбМх╝Вцнеф╗╗хКбуАВ</p> <p>main reactorч║┐чиЛщААхЗ║read loopчЪДф╕дф╕кцЭбф╗╢я╝Ъ</p> <ol><li>хЬищЩРхоЪчЪД16цмбшп╗хПЦф╕ня╝Мх╖▓ч╗Пц▓бцЬЙцЦ░чЪДховцИ╖члпш┐ЮцОешжБцОецФ╢ф║ЖуАВщААхЗ║х╛кчОпуАВ</li> <li>ф╗ОNioServerSocketChannelф╕ншп╗хПЦховцИ╖члпш┐ЮцОечЪДцмбцХ░ш╛╛хИ░ф║Ж16цмбя╝МцЧашо║цндцЧ╢цШпхРжш┐ШцЬЙховцИ╖члпш┐ЮцОещГ╜щЬАшжБщААхЗ║х╛кчОпуАВ</li></ol> <p>х╜Уц╗бш╢│ф╗еф╕Кф╕дф╕кщААхЗ║цЭбф╗╢цЧ╢я╝Мmain reactorч║┐чиЛх░▒ф╝ЪщААхЗ║read loopя╝МчФ▒ф║ОхЬиread loopф╕нцОецФ╢хИ░чЪДховцИ╖члпш┐ЮцОехЕищГицЪВхнШхЬи<code>List&lt;Object&gt; readBuf</code>щЫЖхРИф╕н,щЪПхРОх╝АхзЛщБНхОЖreadBufя╝МхЬиNioServerSocketChannelчЪДpipelineф╕нф╝ацТнChannelReadф║Лф╗╢уАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">int</span> size <span class="token operator">=</span> readBuf<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    readPending <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">//NioServerSocketChannelхп╣х║ФчЪДpipelineф╕нф╝ацТнreadф║Лф╗╢</span>
    <span class="token comment">//io.netty.bootstrap.ServerBootstrap.ServerBootstrapAcceptor.channelRead</span>
    <span class="token comment">//хИЭхзЛхМЦховцИ╖члпSocketChannelя╝Мх╣╢х░ЖхЕ╢ч╗СхоЪхИ░Sub Reactorч║┐чиЛч╗Дф╕нчЪДф╕Аф╕кReactorф╕К</span>
    pipeline<span class="token punctuation">.</span><span class="token function">fireChannelRead</span><span class="token punctuation">(</span>readBuf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цЬАч╗Иpipelineф╕нчЪДChannelHandler(ServerBootstrapAcceptor)ф╝ЪхУНх║ФChannelReadф║Лф╗╢я╝Мх╣╢хЬичЫ╕х║ФхЫЮш░ГхЗ╜цХ░ф╕нхИЭхзЛхМЦховцИ╖члпNioSocketChannelя╝Мх╣╢х░ЖхЕ╢ц│ихЖМхИ░Sub Reactor Groupф╕нуАВцндхРОховцИ╖члпNioSocketChannelч╗СхоЪхИ░чЪДsub reactorх░▒х╝АхзЛчЫСхРмхдДчРЖховцИ╖члпш┐ЮцОеф╕КчЪДшп╗хЖЩф║Лф╗╢ф║ЖуАВ</p> <p>NettyцХ┤ф╕кцОецФ╢ховцИ╖члпчЪДщА╗ш╛Сш┐ЗчиЛхжВф╕ЛхЫ╛цнещкд1я╝М2я╝М3цЙАчд║уАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191527447.webp" alt="хЫ╛чЙЗ"></p> <p>ф╗еф╕КхЖЕхо╣х░▒цШпчмФшАЕцПРхПЦхЗ║цЭечЪДцХ┤ф╜Уц╡БчиЛцбЖцЮ╢я╝Мф╕ЛщЭвцИСф╗мцЭех░ЖхЕ╢ф╕нц╢ЙхПКхИ░чЪДщЗНшжБца╕х┐ГцибхЭЧцЛЖх╝Ая╝Мф╕Аф╕кф╕Аф╕кшпжч╗Жшзгшп╗ф╕ЛуАВ</p> <h2 id="_3-recvbytebufallocator-чоАф╗Л"><a href="#_3-recvbytebufallocator-чоАф╗Л" class="header-anchor">#</a> 3. RecvByteBufAllocator чоАф╗Л</h2> <p>Reactor хЬихдДчРЖхп╣х║Ф Channel ф╕КчЪД IO цХ░цНоцЧ╢я╝МщГ╜ф╝ЪщЗЗчФиф╕Аф╕к<code>ByteBuffer</code>цЭецОецФ╢Channelф╕КчЪДIOцХ░цНоуАВшАМцЬмх░ПшКВшжБф╗Лч╗НчЪДRecvByteBufAllocator цнгцШпчФицЭехИЖщЕН ByteBuffer чЪДф╕Аф╕кхИЖщЕНхЩиуАВ</p> <p>ш┐Шшо░х╛Чш┐Щф╕к<code>RecvByteBufAllocator</code>хЬихУкщЗМшвлхИЫх╗║чЪДхРЧя╝Яя╝Я</p> <p>хЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247483907&amp;idx=1&amp;sn=084c470a8fe6234c2c9461b5f713ff30&amp;chksm=ce77c444f9004d52e7c6244bee83479070effb0bc59236df071f4d62e91e25f01715fca53696&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКшБКшБКNettyщВгф║Ыф║ЛхД┐ф╣ЛReactorхЬиNettyф╕нчЪДхоЮчО░(хИЫх╗║чпЗ)уАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕АцЦЗф╕ня╝МхЬиф╗Лч╗Н<code>NioServerSocketChannel</code>чЪДхИЫх╗║ш┐ЗчиЛф╕нцПРхИ░я╝Мхп╣х║ФChannelчЪДщЕНч╜оч▒╗NioServerSocketChannelConfigф╣Яф╝ЪщЪПчЭАNioServerSocketChannelчЪДхИЫх╗║шАМхИЫх╗║уАВ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">(</span><span class="token class-name">ServerSocketChannel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> channel<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_ACCEPT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioServerSocketChannelConfig</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хЬихИЫх╗║<code>NioServerSocketChannelConfig</code>чЪДш┐ЗчиЛф╕нф╝ЪхИЫх╗║<code>RecvByteBufAllocator</code>уАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">DefaultChannelConfig</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AdaptiveRecvByteBufAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ш┐ЩщЗМцИСф╗мчЬЛхИ░ NioServerSocketChannel ф╕нчЪДRecvByteBufAllocatorхоЮщЩЕч▒╗хЮЛф╕║<code>AdaptiveRecvByteBufAllocator</code>я╝Мщб╛хРНцАЭф╣Йя╝Мш┐Щф╕кч▒╗хЮЛчЪДRecvByteBufAllocatorхПпф╗еца╣цНоChannelф╕КцпПцмбхИ░цЭечЪДIOцХ░цНохдзх░ПцЭешЗкщАВх║ФхКицАБш░ГцХ┤ByteBufferчЪДхо╣щЗПуАВ</p> <p>хп╣ф║ОцЬНхКбчлпNioServerSocketChannelцЭешп┤я╝МхоГф╕Кш╛╣чЪДIOцХ░цНох░▒цШпховцИ╖члпчЪДш┐ЮцОея╝МхоГчЪДщХ┐х║жхТМч▒╗хЮЛщГ╜цШпхЫ║хоЪчЪДя╝МцЙАф╗ехЬицОецФ╢ховцИ╖члпш┐ЮцОечЪДцЧ╢хАЩх╣╢ф╕НщЬАшжБш┐Щца╖чЪДф╕Аф╕кByteBufferцЭецОецФ╢я╝МцИСф╗мф╝Ъх░ЖцОецФ╢хИ░чЪДховцИ╖члпш┐ЮцОехнШцФ╛хЬи<code>List&lt;Object&gt; readBuf</code>щЫЖхРИф╕н</p> <p>хп╣ф║ОховцИ╖члпNioSocketChannelцЭешп┤я╝МхоГф╕Кш╛╣чЪДIOцХ░цНоцЧ╢ховцИ╖члпхПСщАБцЭечЪДч╜Сч╗ЬцХ░цНоя╝МщХ┐х║жцШпф╕НхоЪчЪДя╝МцЙАф╗ецЙНф╝ЪщЬАшжБш┐Щца╖ф╕Аф╕кхПпф╗еца╣цНоцпПцмбIOцХ░цНочЪДхдзх░ПцЭешЗкщАВх║ФхКицАБш░ГцХ┤хо╣щЗПчЪДByteBufferцЭецОецФ╢уАВ</p> <p>щВгф╣ИчЬЛш╡╖цЭеш┐Щф╕кRecvByteBufAllocatorхТМцЬмцЦЗчЪДф╕╗щвШф╕НцШпх╛ИхЕ│шБФя╝МхЫаф╕║хЬицОецФ╢ш┐ЮцОечЪДш┐ЗчиЛф╕нх╣╢ф╕Нф╝ЪцАОф╣ИчФихИ░хоГя╝Мш┐Щф╕кч▒╗чмФшАЕш┐Шф╝ЪхЬихРОщЭвчЪДцЦЗчлаф╕ншпжч╗Жф╗Лч╗Ня╝Мф╣ЛцЙАф╗еш┐ЩщЗМцККхоГцЛОхЗ║цЭехНХчЛмф╗Лч╗НцШпхЫаф╕║хоГхТМцЬмцЦЗх╝Ахд┤цПРхИ░чЪДBugцЬЙхЕ│ч│╗я╝Мш┐Щф╕кBugх░▒цШпчФ▒ш┐Щф╕кч▒╗х╝Хш╡╖чЪДуАВ</p> <h3 id="_3-1-recvbytebufallocator-handleчЪДшО╖хПЦ"><a href="#_3-1-recvbytebufallocator-handleчЪДшО╖хПЦ" class="header-anchor">#</a> 3.1 RecvByteBufAllocator.HandleчЪДшО╖хПЦ</h3> <p>хЬицЬмцЦЗф╕ня╝МцИСф╗мцШпщАЪш┐ЗNioServerSocketChannelф╕нчЪДunsafeх║Хх▒ВцУНф╜Ьч▒╗цЭешО╖хПЦRecvByteBufAllocator.HandleчЪД</p> <div class="language- extra-class"><pre class="language-text"><code>final RecvByteBufAllocator.Handle allocHandle = unsafe().recvBufAllocHandle();
protected abstract class AbstractUnsafe implements Unsafe {
        @Override
        public RecvByteBufAllocator.Handle recvBufAllocHandle() {
            if (recvHandle == null) {
                recvHandle = config().getRecvByteBufAllocator().newHandle();
            }
            return recvHandle;
        }
}
</code></pre></div><p>цИСф╗мчЬЛхИ░цЬАч╗Иф╝ЪхЬиNioServerSocketChannelчЪДщЕНч╜оч▒╗NioServerSocketChannelConfigф╕ншО╖хПЦхИ░<code>AdaptiveRecvByteBufAllocator</code></p> <div class="language- extra-class"><pre class="language-text"><code>public class DefaultChannelConfig implements ChannelConfig {
    //чФиф║ОChannelцОецФ╢цХ░цНочФичЪДbufferхИЖщЕНхЩи  ч▒╗хЮЛф╕║AdaptiveRecvByteBufAllocator
    private volatile RecvByteBufAllocator rcvBufAllocator;
}
</code></pre></div><p><code>AdaptiveRecvByteBufAllocator</code>ф╕нф╝ЪхИЫх╗║шЗкщАВх║ФхКицАБш░ГцХ┤хо╣щЗПчЪДByteBufferхИЖщЕНхЩиуАВ</p> <div class="language- extra-class"><pre class="language-text"><code>public class AdaptiveRecvByteBufAllocator extends DefaultMaxMessagesRecvByteBufAllocator {

    @Override
    public Handle newHandle() {
        return new HandleImpl(minIndex, maxIndex, initial);
    }
    
    private final class HandleImpl extends MaxMessageHandle {
                  .................чЬБчХе................
    }
}
</code></pre></div><p>ш┐ЩщЗМчЪД<code>newHandle</code>цЦ╣ц│Хш┐ФхЫЮчЪДхЕ╖ф╜Уч▒╗хЮЛф╕║<code>MaxMessageHandle</code>я╝Мш┐Щф╕к<code>MaxMessageHandle</code>щЗМш╛╣ф┐ЭхнШф║ЖцпПцмбф╗О<code>Channel</code>ф╕ншп╗хПЦ<code>IOцХ░цНо</code>чЪДхо╣щЗПцМЗцаЗя╝МцЦ╣ф╛┐ф╕Лцмбшп╗хПЦцЧ╢хИЖщЕНхРИщАВхдзх░ПчЪД<code>buffer</code>уАВ</p> <p>цпПцмбхЬиф╜┐чФи<code>allocHandle</code>хЙНщЬАшжБш░ГчФи<code>allocHandle.reset(config);</code>щЗНч╜ощЗМш╛╣чЪДч╗ЯшобцМЗцаЗуАВ</p> <div class="language- extra-class"><pre class="language-text"><code>    public abstract class MaxMessageHandle implements ExtendedHandle {
        private ChannelConfig config;
        //цпПцмбф║Лф╗╢ш╜ошпвцЧ╢я╝МцЬАхдЪшп╗хПЦ16цмб
        private int maxMessagePerRead;
        //цЬмцмбф║Лф╗╢ш╜ошпвцА╗хЕ▒шп╗хПЦчЪДmessageцХ░,ш┐ЩщЗМцМЗчЪДцШпцОецФ╢ш┐ЮцОечЪДцХ░щЗП
        private int totalMessages;
        //цЬмцмбф║Лф╗╢ш╜ошпвцА╗хЕ▒шп╗хПЦчЪДхнЧшКВцХ░
        private int totalBytesRead;

       @Override
        public void reset(ChannelConfig config) {
            this.config = config;
            //щ╗ШшодцпПцмбцЬАхдЪшп╗хПЦ16цмб
            maxMessagePerRead = maxMessagesPerRead();
            totalMessages = totalBytesRead = 0;
        }
    }
</code></pre></div><ul><li><strong>maxMessagePerRead</strong>я╝ЪчФиф║ОцОзхИ╢цпПцмбread loopщЗМцЬАхдзхПпф╗ех╛кчОпшп╗хПЦчЪДцмбцХ░я╝Мщ╗Шшодф╕║16цмбя╝МхПпхЬихРпхКищЕНч╜оч▒╗<code>ServerBootstrap</code>ф╕нщАЪш┐З<code>ChannelOption.MAX_MESSAGES_PER_READ</code>щАЙщб╣шо╛ч╜оуАВ</li></ul> <div class="language- extra-class"><pre class="language-text"><code>ServerBootstrap b = new ServerBootstrap();
b.group(bossGroup, workerGroup)
  .channel(NioServerSocketChannel.class)
  .option(ChannelOption.MAX_MESSAGES_PER_READ, шЗкхоЪф╣ЙцмбцХ░)
</code></pre></div><ul><li><strong>totalMessages</strong>я╝ЪчФиф║Оч╗Яшобread loopф╕нцА╗хЕ▒цОецФ╢чЪДш┐ЮцОеф╕кцХ░я╝МцпПцмбread loopх╛кчОпхРОф╝Ъш░ГчФи<code>allocHandle.incMessagesRead</code>хвЮхКашо░х╜ХцОецФ╢хИ░чЪДш┐ЮцОеф╕кцХ░уАВ</li></ul> <div class="language- extra-class"><pre class="language-text"><code>        @Override
        public final void incMessagesRead(int amt) {
            totalMessages += amt;
        }
</code></pre></div><ul><li><strong>totalBytesRead</strong>я╝ЪчФиф║Оч╗ЯшобхЬиread loopф╕нцА╗хЕ▒цОецФ╢хИ░ховцИ╖члпш┐ЮцОеф╕КчЪДцХ░цНохдзх░Пя╝Мш┐Щф╕кхнЧцо╡ф╕╗шжБчФиф║Оsub reactorхЬицОецФ╢ховцИ╖члпNioSocketChannelф╕КчЪДч╜Сч╗ЬцХ░цНочФичЪДя╝МцЬмцЦЗцИСф╗мф╗Лч╗НчЪДцШпmain reactorцОецФ╢ховцИ╖члпш┐ЮцОея╝МцЙАф╗еш┐ЩщЗМх╣╢ф╕Нф╝ЪчФихИ░ш┐Щф╕кхнЧцо╡уАВш┐Щф╕кхнЧцо╡ф╝ЪхЬиsub reactorцпПцмбшп╗хПЦхоМNioSocketChannelф╕КчЪДч╜Сч╗ЬцХ░цНоцЧ╢хвЮхКашо░х╜ХуАВ</li></ul> <div class="language- extra-class"><pre class="language-text"><code>        @Override
        public void lastBytesRead(int bytes) {
            lastBytesRead = bytes;
            if (bytes &gt; 0) {
                totalBytesRead += bytes;
            }
        }
</code></pre></div><p>MaxMessageHandlerф╕нш┐ШцЬЙф╕Аф╕кщЭЮх╕╕щЗНшжБчЪДцЦ╣ц│Хх░▒цШпхЬицпПцмбread loopцЬлх░╛ф╝Ъш░ГчФи<code>allocHandle.continueReading()</code>цЦ╣ц│ХцЭехИдцЦншп╗хПЦш┐ЮцОецмбцХ░цШпхРжх╖▓ц╗б16цмбя╝МцЭехЖ│хоЪmain reactorч║┐чиЛцШпхРжщААхЗ║х╛кчОпуАВ</p> <div class="language- extra-class"><pre class="language-text"><code>                  do {
                        //х║Хх▒Вш░ГчФиNioServerSocketChannel-&gt;doReadMessages хИЫх╗║ховцИ╖члпSocketChannel
                        int localRead = doReadMessages(readBuf);
                        if (localRead == 0) {
                            break;
                        }
                        if (localRead &lt; 0) {
                            closed = true;
                            break;
                        }
                        //ч╗ЯшобхЬих╜УхЙНф║Лф╗╢х╛кчОпф╕нх╖▓ч╗Пшп╗хПЦхИ░х╛ЧMessageцХ░щЗПя╝ИхИЫх╗║ш┐ЮцОечЪДф╕кцХ░я╝Й
                        allocHandle.incMessagesRead(localRead);
                    } while (allocHandle.continueReading());
</code></pre></div><p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiadlS4S4GAOnWGfc4cAFuhpziasUfsEWHxBfh3nKvLNvBAFAWEAP2sJibw/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="хЫ╛чЙЗ">image.png</p> <p>ч║вцбЖф╕нхЬИхЗ║цЭечЪДф╕дф╕кхИдцЦнцЭбф╗╢хТМцЬмцЦЗф╕╗щвШцЧахЕ│я╝МцИСф╗мш┐ЩщЗМф╕НщЬАшжБхЕ│ц│ия╝МчмФшАЕф╝ЪхЬихРОщЭвчЪДцЦЗчлашпжч╗Жф╗Лч╗НуАВ</p> <ul><li><code>totalMessages &lt; maxMessagePerRead</code>я╝ЪхЬицЬмцЦЗчЪДцОецФ╢ховцИ╖члпш┐ЮцОехЬ║цЩпф╕ня╝Мш┐Щф╕кцЭбф╗╢чФиф║ОхИдцЦнmain reactorч║┐чиЛхЬиread loopф╕нчЪДшп╗хПЦцмбцХ░цШпхРжш╢Еш┐Зф║Ж16цмбуАВхжВцЮЬш╢Еш┐З16цмбх░▒ф╝Ъш┐ФхЫЮfalseя╝Мmain reactorч║┐чиЛщААхЗ║х╛кчОпуАВ</li> <li><code>totalBytesRead &gt; 0</code>я╝ЪчФиф║ОхИдцЦнх╜УховцИ╖члпNioSocketChannelф╕КчЪДOP_READф║Лф╗╢ц┤╗ш╖ГцЧ╢я╝Мsub reactorч║┐чиЛхЬиread loopф╕нцШпхРжшп╗хПЦхИ░ф║Жч╜Сч╗ЬцХ░цНоуАВ</li></ul> <p>ф╗еф╕КхЖЕхо╣х░▒цШпRecvByteBufAllocator.HandleхЬицОецФ╢ховцИ╖члпш┐ЮцОехЬ║цЩпф╕ЛчЪДф╜ЬчФия╝Мхдзхо╢ш┐ЩщЗМф╗Фч╗ЖчЬЛф╕Лш┐Щф╕к<code>allocHandle.continueReading()</code>цЦ╣ц│ХщААхЗ║х╛кчОпчЪДхИдцЦнцЭбф╗╢я╝МхЖНч╗УхРИцХ┤ф╕к<code>do{....}while(...)</code>цОецФ╢ш┐ЮцОех╛кчОпф╜Уя╝МцДЯхПЧф╕ЛцШпхРжхУкщЗМцЬЙф║Ыф╕Нхп╣хК▓я╝ЯBugхН│х░ЖхЗ║чО░~~~</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNia73S7DDn065yic2ibMIJ2CB70d9VuqkWqj9ydiaAk4yDaKbHZ5Z3rlfQfA/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="хЫ╛чЙЗ">image.png</p> <h2 id="_4-хХКхУИ-bug"><a href="#_4-хХКхУИ-bug" class="header-anchor">#</a> 4. хХКхУИя╝Бя╝БBug ! !</h2> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNia1WWpXwfWKkgmhBW2wuBConIInzvqErmKhCjykxao8tPMQq4aMzRMWw/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="хЫ╛чЙЗ">image.png</p> <p>nettyф╕Ншо║цШпхЬицЬмцЦЗф╕нхдДчРЖцОецФ╢ховцИ╖члпш┐ЮцОечЪДхЬ║цЩпш┐ШцШпхЬихдДчРЖцОецФ╢ховцИ╖члпш┐ЮцОеф╕КчЪДч╜Сч╗ЬцХ░цНохЬ║цЩпщГ╜ф╝ЪхЬиф╕Аф╕к<code>do{....}while(...)</code>х╛кчОпread loopф╕нф╕НцЦнчЪДхдДчРЖуАВ</p> <p>хРМцЧ╢ф╣ЯщГ╜ф╝ЪхИйчФихЬиф╕Кф╕Ах░ПшКВф╕нф╗Лч╗НчЪД<code>RecvByteBufAllocator.Handle</code>цЭешо░х╜ХцпПцмбread loopцОецФ╢хИ░чЪДш┐ЮцОеф╕кцХ░хТМф╗Ош┐ЮцОеф╕Кшп╗хПЦхИ░чЪДч╜Сч╗ЬцХ░цНохдзх░ПуАВ</p> <p>ф╗ОшАМхЬиread loopчЪДцЬлх░╛щГ╜ф╝ЪщАЪш┐З<code>allocHandle.continueReading()</code>цЦ╣ц│ХхИдцЦнцШпхРжх║ФшпещААхЗ║read loopх╛кчОпч╗УцЭЯш┐ЮцОечЪДцОецФ╢ц╡БчиЛцИЦшАЕцШпч╗УцЭЯш┐ЮцОеф╕КцХ░цНочЪДшп╗хПЦц╡БчиЛуАВ</p> <p>цЧашо║цШпчФиф║ОцОецФ╢ховцИ╖члпш┐ЮцОечЪДmain reactorф╣Яхе╜ш┐ШцШпчФиф║ОцОецФ╢ховцИ╖члпш┐ЮцОеф╕КчЪДч╜Сч╗ЬцХ░цНочЪДsub reactorф╣Яхе╜я╝МхоГф╗мчЪДш┐РшбМцбЖцЮ╢щГ╜цШпф╕Аца╖чЪДя╝МхПкф╕Нш┐ЗцШпхЕ╖ф╜УхИЖх╖еф╕НхРМуАВ</p> <p>цЙАф╗еnettyш┐ЩщЗМцГ│чФич╗Яф╕АчЪД<code>RecvByteBufAllocator.Handle</code>цЭехдДчРЖф╗еф╕Кф╕дчзНхЬ║цЩпуАВ</p> <p>шАМ<code>RecvByteBufAllocator.Handle</code>ф╕нчЪД<code>totalBytesRead</code>хнЧцо╡ф╕╗шжБшо░х╜Хsub reactorч║┐чиЛхЬихдДчРЖховцИ╖члпNioSocketChannelф╕нOP_READф║Лф╗╢ц┤╗ш╖ГцЧ╢я╝МцА╗хЕ▒хЬиread loopф╕ншп╗хПЦхИ░чЪДч╜Сч╗ЬцХ░цНоя╝МшАМш┐ЩщЗМцШпmain reactorч║┐чиЛхЬицОецФ╢ховцИ╖члпш┐ЮцОецЙАф╗еш┐Щф╕кхнЧцо╡х╣╢ф╕Нф╝Ъшвлшо╛ч╜оуАВtotalBytesReadхнЧцо╡чЪДхА╝хЬицЬмцЦЗф╕нц░╕ш┐Ьф╝ЪцШп<code>0</code>уАВ</p> <p>цЙАф╗ецЧашо║хРМцЧ╢цЬЙхдЪх░Сф╕кховцИ╖члпх╣╢хПСш┐ЮцОехИ░цЬНхКбчлпф╕Кя╝МхЬицОецФ╢ш┐ЮцОечЪДш┐Щф╕кread loopф╕нц░╕ш┐ЬхПкф╝ЪцОехПЧф╕Аф╕кш┐ЮцОех░▒ф╝ЪщААхЗ║х╛кчОпя╝МхЫаф╕║<code>allocHandle.continueReading()цЦ╣ц│Х</code>ф╕нчЪДхИдцЦнцЭбф╗╢<code>totalBytesRead &gt; 0</code>ц░╕ш┐Ьф╝Ъш┐ФхЫЮ<code>false</code>уАВ</p> <div class="language- extra-class"><pre class="language-text"><code>                  do {
                        //х║Хх▒Вш░ГчФиNioServerSocketChannel-&gt;doReadMessages хИЫх╗║ховцИ╖члпSocketChannel
                        int localRead = doReadMessages(readBuf);
                        if (localRead == 0) {
                            break;
                        }
                        if (localRead &lt; 0) {
                            closed = true;
                            break;
                        }
                        //ч╗ЯшобхЬих╜УхЙНф║Лф╗╢х╛кчОпф╕нх╖▓ч╗Пшп╗хПЦхИ░х╛ЧMessageцХ░щЗПя╝ИхИЫх╗║ш┐ЮцОечЪДф╕кцХ░я╝Й
                        allocHandle.incMessagesRead(localRead);
                    } while (allocHandle.continueReading());
</code></pre></div><p><strong>шАМnettyчЪДцЬмцДПцШпхЬиш┐Щф╕кread loopх╛кчОпф╕нх░╜хПпшГ╜хдЪчЪДхО╗цОецФ╢ховцИ╖члпчЪДх╣╢хПСш┐ЮцОея╝МхРМцЧ╢хПИф╕Нх╜▒хУНmain reactorч║┐чиЛцЙзшбМх╝Вцнеф╗╗хКбуАВф╜ЖцШпчФ▒ф║Ош┐Щф╕кBugя╝Мmain reactorхЬиш┐Щф╕кх╛кчОпф╕нхПкцЙзшбМф╕Ацмбх░▒ч╗УцЭЯф║ЖуАВш┐Щф╣Яф╕АхоЪчиЛх║жф╕Кх░▒х╜▒хУНф║ЖnettyчЪДхРЮхРР</strong>уАВ</p> <p>шойцИСф╗мцГ│ш▒бф╕Лш┐Щца╖чЪДф╕Аф╕кхЬ║цЩпя╝Мх╜УцЬЙ16ф╕кховцИ╖члпхРМцЧ╢х╣╢хПСш┐ЮцОехИ░ф║ЖцЬНхКбчлпя╝Мш┐ЩцЧ╢NioServerSocketChannelф╕КчЪД<code>OP_ACCEPTф║Лф╗╢</code>ц┤╗ш╖Гя╝Мmain reactorф╗ОSelectorф╕КшвлхФдщЖТя╝МщЪПхРОцЙзшбМ<code>OP_ACCEPTф║Лф╗╢</code>чЪДхдДчРЖуАВ</p> <div class="language- extra-class"><pre class="language-text"><code>public final class NioEventLoop extends SingleThreadEventLoop {
    @Override
    protected void run() {
        int selectCnt = 0;
        for (;;) {
            try { 
                int strategy;
                try {
                    strategy = selectStrategy.calculateStrategy(selectNowSupplier, hasTasks());
                    switch (strategy) {
                    case SelectStrategy.CONTINUE:                  
                          ............чЬБчХе.........
                    case SelectStrategy.BUSY_WAIT:

                          ............чЬБчХе.........
                    case SelectStrategy.SELECT:
                            ............чЫСхРмш╜ошпвIOф║Лф╗╢.........
                    default:
                    }
                } catch (IOException e) {
                    ............чЬБчХе.........
                }

                ............хдДчРЖIOх░▒ч╗кф║Лф╗╢.........
                ............цЙзшбМх╝Вцнеф╗╗хКб.........
    }
}
</code></pre></div><p>ф╜ЖцШпчФ▒ф║Ош┐Щф╕кBugчЪДхнШхЬия╝Мmain reactorхЬицОецФ╢ховцИ╖члпш┐ЮцОечЪДш┐Щф╕кread loopф╕нхПкцОецФ╢ф║Жф╕Аф╕кховцИ╖члпш┐ЮцОех░▒хМЖхМЖш┐ФхЫЮф║ЖуАВ</p> <div class="language- extra-class"><pre class="language-text"><code>      private final class NioMessageUnsafe extends AbstractNioUnsafe {
                    do {
                        int localRead = doReadMessages(readBuf);
                        .........чЬБчХе...........
                    } while (allocHandle.continueReading());
     }
</code></pre></div><p>чД╢хРОца╣цНоф╕ЛхЫ╛ф╕нш┐Щф╕кReactorчЪДш┐РшбМч╗УцЮДхО╗цЙзшбМх╝Вцнеф╗╗хКбя╝МщЪПхРОч╗Хф╕АхдзхЬИхПИф╝ЪхЫЮхИ░<code>NioEventLoop#run</code>цЦ╣ц│Хф╕нщЗНцЦ░хПСш╡╖ф╕Аш╜оOP_ACCEPTф║Лф╗╢ш╜ошпвуАВ</p> <p>![хЫ╛чЙЗ](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)Reactorч║┐чиЛш┐РшбМцЧ╢ч╗УцЮД.png</p> <p>чФ▒ф║ОчО░хЬиш┐ШцЬЙ15ф╕кховцИ╖члпх╣╢хПСш┐ЮцОец▓бцЬЙшвлцОецФ╢я╝МцЙАф╗ецндцЧ╢Main Reactorч║┐чиЛх╣╢ф╕Нф╝ЪхЬи<code>selector.select()</code>ф╕КщШ╗хбЮя╝МцЬАч╗Ич╗Хф╕АхЬИхПИф╝ЪхЫЮхИ░<code>NioMessageUnsafe#read</code>цЦ╣ц│ХчЪД<code>do{.....}while()</code>х╛кчОпуАВхЬицОецФ╢ф╕Аф╕кш┐ЮцОеф╣ЛхРОхПИщААхЗ║х╛кчОпуАВ</p> <p>цЬмцЭецИСф╗мхПпф╗ехЬиф╕Ацмбread loopф╕нцККш┐Щ16ф╕кх╣╢хПСчЪДховцИ╖члпш┐ЮцОехЕищГицОецФ╢хоМцпХчЪДя╝МхЫаф╕║ш┐Щф╕кBugя╝Мmain reactorщЬАшжБф╕НцЦнчЪДхПСш╡╖OP_ACCEPTф║Лф╗╢чЪДш╜ошпвя╝Мч╗Хф║Жх╛Ихдзф╕Аф╕кхЬИхнРуАВ<strong>хРМцЧ╢ф╣ЯхвЮхКаф║Жшо╕хдЪф╕Нх┐ЕшжБчЪДselector.select()ч│╗ч╗Яш░ГчФих╝АщФА</strong></p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191110731.webp" alt="хЫ╛чЙЗ">issueшоишо║.png</p> <p>ш┐ЩцЧ╢хдзхо╢хЬичЬЛш┐Щф╕к?Issue#11708ф╕нчЪДшоишо║цШпф╕НцШпх░▒ц╕ЕцЩ░х╛ИхдЪф║Ж~~</p> <blockquote><p>Issue#11708я╝Ъhttps://github.com/netty/netty/issues/11708</p></blockquote> <h3 id="_4-1-bug-чЪДф┐охдН"><a href="#_4-1-bug-чЪДф┐охдН" class="header-anchor">#</a> 4.1 Bug чЪДф┐охдН</h3> <blockquote><p>чмФшАЕхЬихЖЩш┐ЩчпЗцЦЗчлачЪДцЧ╢хАЩя╝МNettyцЬАцЦ░чЙИцЬмцШп4.1.68.finalя╝Мш┐Щф╕кBugхЬи4.1.69.finalф╕ншвлф┐охдНуАВ</p></blockquote> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiamkpfIdsVEQRQibNvxZYJJiaTQFHvmuiasd23LH4hjLazv0W1sibvr46nkA/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="хЫ╛чЙЗ">image.png</p> <p>чФ▒ф║ОшпеBugф║зчФЯчЪДхОЯхЫацнгцШпхЫаф╕║цЬНхКбчлпNioServerSocketChannelя╝ИчФиф║ОчЫСхРмчлпхПгхЬ░хЭАхТМцОецФ╢ховцИ╖члпш┐ЮцОея╝ЙхТМ ховцИ╖члпNioSocketChannelя╝ИчФиф║ОщАЪф┐бя╝Йф╕нчЪДConfigщЕНч╜оч▒╗ц╖╖чФиф║ЖхРМф╕Аф╕кByteBufferхИЖщЕНхЩи<code>AdaptiveRecvByteBufAllocator</code>шАМхп╝шЗ┤чЪДуАВ</p> <p>цЙАф╗ехЬицЦ░чЙИцЬмф┐охдНф╕нф╕УщЧиф╕║цЬНхКбчлпServerSocketChannelф╕нчЪДConfigщЕНч╜оч▒╗х╝ХхЕеф║Жф╕Аф╕кцЦ░чЪДByteBufferхИЖщЕНхЩи<code>ServerChannelRecvByteBufAllocator</code>я╝Мф╕УщЧичФиф║ОцЬНхКбчлпServerSocketChannelцОецФ╢ховцИ╖члпш┐ЮцОечЪДхЬ║цЩпуАВ</p> <p>![хЫ╛чЙЗ](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>![хЫ╛чЙЗ](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>хЬи<code>ServerChannelRecvByteBufAllocator</code>чЪДчИ╢ч▒╗<code>DefaultMaxMessagesRecvByteBufAllocator</code>ф╕нх╝ХхЕеф║Жф╕Аф╕кцЦ░чЪДхнЧцо╡<code>ignoreBytesRead</code>я╝МчФиф║Ошбичд║цШпхРжх┐╜чХеч╜Сч╗ЬхнЧшКВчЪДшп╗хПЦя╝МхЬихИЫх╗║цЬНхКбчлпChannelщЕНч╜оч▒╗NioServerSocketChannelConfigчЪДцЧ╢хАЩя╝Мш┐Щф╕кхнЧцо╡ф╝Ъшвлш╡ЛхА╝ф╕║<code>true</code>уАВ</p> <p>![хЫ╛чЙЗ](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>х╜Уmain reactorч║┐чиЛхЬиread loopх╛кчОпф╕нцОецФ╢ховцИ╖члпш┐ЮцОечЪДцЧ╢хАЩуАВ</p> <div class="language- extra-class"><pre class="language-text"><code>      private final class NioMessageUnsafe extends AbstractNioUnsafe {

                    do {
                        int localRead = doReadMessages(readBuf);
                        .........чЬБчХе...........
                    } while (allocHandle.continueReading());
     }
</code></pre></div><p>хЬиread loopх╛кчОпчЪДцЬлх░╛х░▒ф╝ЪщЗЗчФиф╗О<code>ServerChannelRecvByteBufAllocator</code>ф╕нхИЫх╗║чЪД<code>MaxMessageHandle#continueReading</code>цЦ╣ц│ХцЭехИдцЦншп╗хПЦш┐ЮцОецмбцХ░цШпхРжш╢Еш┐Зф║Ж16цмбуАВчФ▒ф║Ош┐ЩщЗМчЪД<code>ignoreBytesRead == true</code>ш┐ЩхЫЮцИСф╗мх░▒ф╝Ъх┐╜чХе<code>totalBytesRead == 0</code>чЪДцГЕхЖ╡я╝Мф╗ОшАМф╜┐х╛ЧцОецФ╢ш┐ЮцОечЪДread loopх╛Чф╗еч╗зч╗нхЬ░цЙзшбМф╕ЛхО╗уАВхЬиф╕Аф╕кread loopф╕нф╕АцмбцАзцКК16ф╕кш┐ЮцОехЕищГицОецФ╢хоМцпХуАВ</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiabJdRFibbDhoULfxwyl3njuSGPmiaw9KwAtB7hicggEYHwcUbMZe4BibEDQ/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="хЫ╛чЙЗ">image.png</p> <p>ф╗еф╕Кх░▒цШпхп╣ш┐Щф╕кBugф║зчФЯчЪДхОЯхЫая╝Мф╗ехПКхПСчО░чЪДш┐ЗчиЛя╝МцЬАхРОф┐охдНчЪДцЦ╣цбИф╕Аф╕кхЕищЭвчЪДф╗Лч╗Ня╝МхЫацндчмФшАЕф╣ЯхЗ║чО░хЬиф║Жnetty 4.1.69.finalчЙИцЬмхПСх╕ГхЕмхСКщЗМчЪДthank-listф╕нуАВхУИхУИя╝МчЬЯцШпф╗дф║║х╝Ах┐ГчЪДф╕Аф╗╢ф║ЛцГЕ~~~</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiaEtpEzZGwchbkWicibbjCuOujhoHFk1GrxibqAKnfVkticFu04DQX8XyWkw/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="хЫ╛чЙЗ">image.png</p> <p>щАЪш┐Зф╗еф╕Кхп╣nettyцОецФ╢ховцИ╖члпш┐ЮцОечЪДхЕиц╡БчиЛхИЖцЮРхТМхп╣ш┐Щф╕кBugцЭещ╛ЩхО╗шДЙф╗ехПКф┐охдНцЦ╣цбИчЪДф╗Лч╗Ня╝Мхдзхо╢чО░хЬиф╕АхоЪх╖▓ч╗ПчРЖшзгф║ЖцХ┤ф╕кцОецФ╢ш┐ЮцОечЪДц╡БчиЛцбЖцЮ╢уАВ</p> <p>цОеф╕ЛцЭечмФшАЕх░▒цККш┐Щф╕кц╡БчиЛф╕нц╢ЙхПКхИ░чЪДф╕Аф║Ыца╕х┐ГцибхЭЧхЬихНХчЛмцЛОхЗ║цЭеф╗Оч╗ЖшКВхЕецЙЛя╝Мф╕║хдзхо╢хРДф╕кхЗ╗ча┤~~~</p> <h2 id="_5-doreadmessages-цОецФ╢ховцИ╖члпш┐ЮцОе"><a href="#_5-doreadmessages-цОецФ╢ховцИ╖члпш┐ЮцОе" class="header-anchor">#</a> 5. doReadMessages цОецФ╢ховцИ╖члпш┐ЮцОе</h2> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NioServerSocketChannel</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractNioMessageChannel</span>
                             <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>socket<span class="token punctuation">.</span></span>ServerSocketChannel</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">doReadMessages</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> buf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">SocketChannel</span> ch <span class="token operator">=</span> <span class="token class-name">SocketUtils</span><span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                buf<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NioSocketChannel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ch<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to create a new channel from an accepted socket.&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                ch<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to close a socket.&quot;</span><span class="token punctuation">,</span> t2<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><ul><li>щАЪш┐З<code>javaChannel()</code>шО╖хПЦх░БшгЕхЬиNettyцЬНхКбчлп<code>NioServerSocketChannel</code>ф╕нчЪД<code>JDK хОЯчФЯ ServerSocketChannel</code>уАВ</li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token class-name">ServerSocketChannel</span> <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">ServerSocketChannel</span><span class="token punctuation">)</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>щАЪш┐З<code>JDK NIO хОЯчФЯ</code>чЪД<code>ServerSocketChannel</code>чЪД<code>acceptцЦ╣ц│Х</code>шО╖хПЦ<code>JDK NIO хОЯчФЯ</code>ховцИ╖члпш┐ЮцОе<code>SocketChannel</code>уАВ</li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">SocketChannel</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ServerSocketChannel</span> serverSocketChannel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedExceptionAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">SocketChannel</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> serverSocketChannel<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PrivilegedActionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span><span class="token punctuation">)</span> e<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ш┐Щф╕Ацнех░▒цШпцИСф╗мхЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247483737&amp;idx=1&amp;sn=7ef3afbb54289c6e839eed724bb8a9d6&amp;chksm=ce77c71ef9004e08e3d164561e3a2708fc210c05408fa41f7fe338d8e85f39c1ad57519b614e&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКшБКшБКNettyщВгф║Ыф║ЛхД┐ф╣Лф╗ОхЖЕца╕шзТх║жчЬЛIOцибхЮЛуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╗Лч╗НхИ░чЪДш░ГчФи<code>чЫСхРмSocket</code>чЪД<code>acceptцЦ╣ц│Х</code>я╝МхЖЕца╕ф╝ЪхЯ║ф║О<code>чЫСхРмSocket</code>хИЫх╗║хЗ║цЭеф╕Аф╕кцЦ░чЪД<code>Socket</code>ф╕УщЧичФиф║Оф╕ОховцИ╖члпф╣ЛщЧ┤чЪДч╜Сч╗ЬщАЪф┐бш┐Щф╕кцИСф╗мчз░ф╣Лф╕║<code>ховцИ╖члпш┐ЮцОеSocket</code>уАВш┐ЩщЗМчЪД<code>ServerSocketChannel</code>х░▒ч▒╗ф╝╝ф║О<code>чЫСхРмSocket</code>уАВ<code>SocketChannel</code>х░▒ч▒╗ф╝╝ф║О<code>ховцИ╖члпш┐ЮцОеSocket</code>уАВ</p> <p>чФ▒ф║ОцИСф╗мхЬихИЫх╗║<code>NioServerSocketChannel</code>чЪДцЧ╢хАЩя╝Мф╝Ъх░Ж<code>JDK NIO хОЯчФЯ</code>чЪД<code>ServerSocketChannel</code>шо╛ч╜оф╕║<code>щЭЮщШ╗хбЮ</code>я╝МцЙАф╗еш┐ЩщЗМх╜У<code>ServerSocketChannel</code>ф╕КцЬЙховцИ╖члпш┐ЮцОецЧ╢х░▒ф╝ЪчЫ┤цОехИЫх╗║<code>SocketChannel</code>я╝МхжВцЮЬцндцЧ╢х╣╢ц▓бцЬЙховцИ╖члпш┐ЮцОецЧ╢<code>acceptш░ГчФи</code>х░▒ф╝ЪчлЛхИ╗ш┐ФхЫЮ<code>null</code>х╣╢ф╕Нф╝ЪщШ╗хбЮуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">AbstractNioChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> parent<span class="token punctuation">,</span> <span class="token class-name">SelectableChannel</span> ch<span class="token punctuation">,</span> <span class="token keyword">int</span> readInterestOp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ch <span class="token operator">=</span> ch<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>readInterestOp <span class="token operator">=</span> readInterestOp<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//шо╛ч╜оChannelф╕║щЭЮщШ╗хбЮ щЕНхРИIOхдЪш╖пхдНчФицибхЮЛ</span>
        ch<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_5-1-хИЫх╗║ховцИ╖члпniosocketchannel"><a href="#_5-1-хИЫх╗║ховцИ╖члпniosocketchannel" class="header-anchor">#</a> 5.1 хИЫх╗║ховцИ╖члпNioSocketChannel</h3> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NioServerSocketChannel</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractNioMessageChannel</span>
                             <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>socket<span class="token punctuation">.</span></span>ServerSocketChannel</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">doReadMessages</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> buf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">SocketChannel</span> ch <span class="token operator">=</span> <span class="token class-name">SocketUtils</span><span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                buf<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NioSocketChannel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ch<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>ш┐ЩщЗМф╝Ъца╣цНо<code>ServerSocketChannel</code>чЪД<code>accept</code>цЦ╣ц│ХшО╖хПЦхИ░<code>JDK NIO хОЯчФЯ</code>чЪД<code>SocketChannel</code>я╝ИчФиф║Ох║Хх▒ВчЬЯцнгф╕ОховцИ╖члпщАЪф┐бчЪДChannelя╝Йя╝МцЭехИЫх╗║Nettyф╕нчЪД<code>NioSocketChannel</code>уАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NioSocketChannel</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractNioByteChannel</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>socket<span class="token punctuation">.</span></span>SocketChannel</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">NioSocketChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> parent<span class="token punctuation">,</span> <span class="token class-name">SocketChannel</span> socket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioSocketChannelConfig</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> socket<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>хИЫх╗║ховцИ╖члп<code>NioSocketChannel</code>чЪДш┐ЗчиЛхЕ╢хоЮхТМф╣ЛхЙНшо▓чЪДхИЫх╗║цЬНхКбчлп<code>NioServerSocketChannel</code>хдзф╜Уц╡БчиЛцШпф╕Аца╖чЪДя╝МцИСф╗мш┐ЩщЗМхПкхп╣ховцИ╖члп<code>NioSocketChannel</code>хТМцЬНхКбчлп<code>NioServerSocketChannel</code>хЬихИЫх╗║ш┐ЗчиЛф╕нчЪДф╕НхРМф╣ЛхдДхБЪф╕Аф╕кхп╣цпФуАВ</p> <blockquote><p>хЕ╖ф╜Уч╗ЖшКВщГихИЖхдзхо╢хПпф╗ехЬихЫЮчЬЛф╕Л<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484005&amp;idx=1&amp;sn=52f51269902a58f40d33208421109bc3&amp;chksm=ce77c422f9004d340e5b385ef6ba24dfba1f802076ace80ad6390e934173a10401e64e13eaeb&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКшпжч╗ЖхЫ╛шзгNetty ReactorхРпхКихЕиц╡БчиЛуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕АцЦЗф╕нхЕ│ф║О<code>NioServerSocketChannel</code>чЪДхИЫх╗║чЪДшпжч╗Жч╗ЖшКВуАВ</p></blockquote> <h3 id="_5-3-хп╣цпФniosocketchannelф╕ОnioserversocketchannelчЪДф╕НхРМ"><a href="#_5-3-хп╣цпФniosocketchannelф╕ОnioserversocketchannelчЪДф╕НхРМ" class="header-anchor">#</a> 5.3 хп╣цпФNioSocketChannelф╕ОNioServerSocketChannelчЪДф╕НхРМ</h3> <h4 id="_1-channelчЪДх▒Вцмбф╕НхРМ"><a href="#_1-channelчЪДх▒Вцмбф╕НхРМ" class="header-anchor">#</a> 1я╝ЪChannelчЪДх▒Вцмбф╕НхРМ</h4> <p>хЬицИСф╗мф╗Лч╗НReactorчЪДхИЫх╗║цЦЗчлаф╕ня╝МцИСф╗мцПРхИ░Nettyф╕нчЪД<code>Channel</code>цШпхЕ╖цЬЙх▒ВцмбчЪДуАВчФ▒ф║ОховцИ╖члпNioSocketChannelцШпхЬиmain reactorцОецФ╢ш┐ЮцОецЧ╢хЬицЬНхКбчлпNioServerSocketChannelф╕ншвлхИЫх╗║чЪДя╝МцЙАф╗ехЬихИЫх╗║ховцИ╖члпNioSocketChannelчЪДцЧ╢хАЩф╝ЪщАЪш┐ЗцЮДщАахЗ╜цХ░цМЗхоЪф║Жparentх▒ЮцАзф╕║<code>NioServerSocketChanel</code>уАВх╣╢х░Ж<code>JDK NIO хОЯчФЯ</code>чЪД<code>SocketChannel</code>х░БшгЕш┐ЫNettyчЪДховцИ╖члп<code>NioSocketChannel</code>ф╕нуАВ</p> <p>шАМхЬиReactorхРпхКиш┐ЗчиЛф╕нхИЫх╗║<code>NioServerSocketChannel</code>чЪДцЧ╢хАЩ<code>parentх▒ЮцАз</code>цМЗхоЪцШп<code>null</code>уАВхЫаф╕║хоГх░▒цШпщб╢х▒ВчЪД<code>Channel</code>я╝Мш┤Яш┤гхИЫх╗║ховцИ╖члп<code>NioSocketChannel</code>уАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">(</span><span class="token class-name">ServerSocketChannel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> channel<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_ACCEPT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioServerSocketChannelConfig</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_2-хРСreactorц│ихЖМчЪДioф║Лф╗╢ф╕НхРМ"><a href="#_2-хРСreactorц│ихЖМчЪДioф║Лф╗╢ф╕НхРМ" class="header-anchor">#</a> 2я╝ЪхРСReactorц│ихЖМчЪДIOф║Лф╗╢ф╕НхРМ</h4> <p>ховцИ╖члп NioSocketChannel хРС Sub Reactor ц│ихЖМчЪДцШп <code>SelectionKey.OP_READф║Лф╗╢</code>я╝МшАМцЬНхКбчлп NioServerSocketChannel хРС Main Reactor ц│ихЖМчЪДцШп<code>SelectionKey.OP_ACCEPTф║Лф╗╢</code>уАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractNioByteChannel</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractNioChannel</span> <span class="token punctuation">{</span>

    <span class="token keyword">protected</span> <span class="token class-name">AbstractNioByteChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> parent<span class="token punctuation">,</span> <span class="token class-name">SelectableChannel</span> ch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> ch<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_READ</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NioServerSocketChannel</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractNioMessageChannel</span>
                             <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>socket<span class="token punctuation">.</span></span>ServerSocketChannel</span> <span class="token punctuation">{</span>

   <span class="token keyword">public</span> <span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">(</span><span class="token class-name">ServerSocketChannel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//чИ╢ч▒╗AbstractNioChannelф╕нф┐ЭхнШJDK NIOхОЯчФЯServerSocketChannelф╗ехПКшжБчЫСхРмчЪДф║Лф╗╢OP_ACCEPT</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> channel<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_ACCEPT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//DefaultChannelConfigф╕ншо╛ч╜очФиф║ОChannelцОецФ╢цХ░цНочФичЪДbuffer-&gt;AdaptiveRecvByteBufAllocator</span>
        config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioServerSocketChannelConfig</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_3-хКЯшГ╜х▒ЮцАзф╕НхРМщАацИРч╗зцЙ┐ч╗УцЮДчЪДф╕НхРМ"><a href="#_3-хКЯшГ╜х▒ЮцАзф╕НхРМщАацИРч╗зцЙ┐ч╗УцЮДчЪДф╕НхРМ" class="header-anchor">#</a> 3: хКЯшГ╜х▒ЮцАзф╕НхРМщАацИРч╗зцЙ┐ч╗УцЮДчЪДф╕НхРМ</h4> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191539423.webp" alt="хЫ╛чЙЗ"></p> <p>ховцИ╖члп<code>NioSocketChannel</code>ч╗зцЙ┐чЪДцШп<code>AbstractNioByteChannel</code>я╝МшАМцЬНхКбчлп<code>NioServerSocketChannel</code>ч╗зцЙ┐чЪДцШп<code>AbstractNioMessageChannel</code>уАВхоГф╗мч╗зцЙ┐чЪДш┐Щф╕дф╕кцК╜ш▒бч▒╗ф╕Аф╕кхЙНч╝АцШп<code>Byte</code>я╝Мф╕Аф╕кхЙНч╝АцШп<code>Message</code>цЬЙф╗Аф╣ИхМ║хИлхРЧя╝Яя╝Я</p> <blockquote><p>ховцИ╖члп<code>NioSocketChannel</code>ф╕╗шжБхдДчРЖчЪДцШпцЬНхКбчлпф╕ОховцИ╖члпчЪДщАЪф┐бя╝Мш┐ЩщЗМц╢ЙхПКхИ░цОецФ╢ховцИ╖члпхПСщАБцЭечЪДцХ░цНоя╝МшАМ<code>Sub Reactorч║┐чиЛ</code>ф╗О<code>NioSocketChannel</code>ф╕ншп╗хПЦчЪДцнгцШпч╜Сч╗ЬщАЪф┐бцХ░цНохНХф╜Нф╕║<code>Byte</code>уАВ</p></blockquote> <blockquote><p>цЬНхКбчлп<code>NioServerSocketChannel</code>ф╕╗шжБш┤Яш┤гхдДчРЖ<code>OP_ACCEPTф║Лф╗╢</code>я╝МхИЫх╗║чФиф║ОщАЪф┐бчЪДховцИ╖члп<code>NioSocketChannel</code>уАВш┐ЩцЧ╢хАЩховцИ╖члпф╕ОцЬНхКбчлпш┐Шц▓бх╝АхзЛщАЪф┐бя╝МцЙАф╗е<code>Main Reactorч║┐чиЛ</code>ф╗О<code>NioServerSocketChannel</code>чЪДшп╗хПЦхп╣ш▒бф╕║<code>Message</code>уАВш┐ЩщЗМчЪД<code>Message</code>цМЗчЪДх░▒цШпх║Хх▒ВчЪД<code>SocketChannel</code>ховцИ╖члпш┐ЮцОеуАВ</p></blockquote> <hr> <p>ф╗еф╕Кх░▒цШп<code>NioSocketChannel</code>ф╕О<code>NioServerSocketChannel</code>хИЫх╗║ш┐ЗчиЛф╕нчЪДф╕НхРМф╣ЛхдДя╝МхРОщЭвчЪДш┐ЗчиЛх░▒ф╕Аца╖ф║ЖуАВ</p> <ul><li>хЬиAbstractNioChannel ч▒╗ф╕нх░БшгЕJDK NIO хОЯчФЯчЪД<code>SocketChannel</code>я╝Мх╣╢х░ЖхЕ╢х║Хх▒ВчЪДIOцибхЮЛшо╛ч╜оф╕║<code>щЭЮщШ╗хбЮ</code>я╝Мф┐ЭхнШщЬАшжБчЫСхРмчЪДIOф║Лф╗╢<code>OP_READ</code>уАВ</li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">AbstractNioChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> parent<span class="token punctuation">,</span> <span class="token class-name">SelectableChannel</span> ch<span class="token punctuation">,</span> <span class="token keyword">int</span> readInterestOp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ch <span class="token operator">=</span> ch<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>readInterestOp <span class="token operator">=</span> readInterestOp<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//шо╛ч╜оChannelф╕║щЭЮщШ╗хбЮ щЕНхРИIOхдЪш╖пхдНчФицибхЮЛ</span>
        ch<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>ф╕║ховцИ╖члпNioSocketChannelхИЫх╗║хЕих▒АхФпф╕АчЪД<code>channelId</code>я╝МхИЫх╗║ховцИ╖члпNioSocketChannelчЪДх║Хх▒ВцУНф╜Ьч▒╗<code>NioByteUnsafe</code>я╝МхИЫх╗║pipelineуАВ</li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">AbstractChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>
    <span class="token comment">//channelхЕих▒АхФпф╕АID machineId+processId+sequence+timestamp+random</span>
    id <span class="token operator">=</span> <span class="token function">newId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//unsafeчФиф║Ох║Хх▒ВsocketчЪДшп╗хЖЩцУНф╜Ь</span>
    unsafe <span class="token operator">=</span> <span class="token function">newUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//ф╕║channelхИЖщЕНчЛмчлЛчЪДpipelineчФиф║ОIOф║Лф╗╢ч╝ЦцОТ</span>
    pipeline <span class="token operator">=</span> <span class="token function">newChannelPipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>хЬиNioSocketChannelConfigчЪДхИЫх╗║ш┐ЗчиЛф╕ня╝Мх░ЖNioSocketChannelчЪДRecvByteBufAllocatorч▒╗хЮЛшо╛ч╜оф╕║<code>AdaptiveRecvByteBufAllocator</code>уАВ</li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">DefaultChannelConfig</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AdaptiveRecvByteBufAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>хЬиBugф┐охдНхРОчЪДчЙИцЬмф╕нцЬНхКбчлпNioServerSocketChannelчЪДRecvByteBufAllocatorч▒╗хЮЛшо╛ч╜оф╕║<code>ServerChannelRecvByteBufAllocator</code></p></blockquote> <p>цЬАч╗ИцИСф╗мх╛ЧхИ░чЪДховцИ╖члп<code>NioSocketChannel</code>ч╗УцЮДхжВф╕Ля╝Ъ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191539254.webp" alt="хЫ╛чЙЗ"></p> <h2 id="_6-channelread-ф║Лф╗╢чЪДхУНх║Ф"><a href="#_6-channelread-ф║Лф╗╢чЪДхУНх║Ф" class="header-anchor">#</a> 6. ChannelRead ф║Лф╗╢чЪДхУНх║Ф</h2> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiaDjWPOibC4yyvicZOQROz0VprRQdxN0scINPgOrCAVGxL1bUoV6ia4YJXQ/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="хЫ╛чЙЗ"></p> <p>хЬихЙНш╛╣ф╗Лч╗НцОецФ╢ш┐ЮцОечЪДцХ┤ф╜Уца╕х┐Гц╡БчиЛцбЖцЮ╢чЪДцЧ╢хАЩя╝МцИСф╗мцПРхИ░main reactorч║┐чиЛцШпхЬиф╕Аф╕к<code>do{.....}while(...)</code>х╛кчОпread loopф╕нф╕НцЦнчЪДш░ГчФи<code>ServerSocketChannel#accept</code>цЦ╣ц│ХцЭецОецФ╢ховцИ╖члпчЪДш┐ЮцОеуАВ</p> <p>х╜Уц╗бш╢│щААхЗ║read loopх╛кчОпчЪДцЭбф╗╢цЬЙф╕дф╕кя╝Ъ</p> <ol><li>хЬищЩРхоЪчЪД16цмбшп╗хПЦф╕ня╝Мх╖▓ч╗Пц▓бцЬЙцЦ░чЪДховцИ╖члпш┐ЮцОешжБцОецФ╢ф║ЖуАВщААхЗ║х╛кчОпуАВ</li> <li>ф╗ОNioServerSocketChannelф╕ншп╗хПЦховцИ╖члпш┐ЮцОечЪДцмбцХ░ш╛╛хИ░ф║Ж16цмбя╝МцЧашо║цндцЧ╢цШпхРжш┐ШцЬЙховцИ╖члпш┐ЮцОещГ╜щЬАшжБщААхЗ║х╛кчОпуАВ</li></ol> <p>main reactorх░▒ф╝ЪщААхЗ║read loopх╛кчОпя╝МцндцЧ╢цОецФ╢хИ░чЪДховцИ╖члпш┐ЮцОеNioSocketChannelцЪВхнШф╕О<code>List&lt;Object&gt; readBuf</code>щЫЖхРИф╕нуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">NioMessageUnsafe</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractNioUnsafe</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> readBuf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">do</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                        <span class="token comment">//х║Хх▒Вш░ГчФиNioServerSocketChannel-&gt;doReadMessages хИЫх╗║ховцИ╖члпSocketChannel</span>
                        <span class="token keyword">int</span> localRead <span class="token operator">=</span> <span class="token function">doReadMessages</span><span class="token punctuation">(</span>readBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                        allocHandle<span class="token punctuation">.</span><span class="token function">incMessagesRead</span><span class="token punctuation">(</span>localRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>allocHandle<span class="token punctuation">.</span><span class="token function">continueReading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                exception <span class="token operator">=</span> t<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">int</span> size <span class="token operator">=</span> readBuf<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                readPending <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                pipeline<span class="token punctuation">.</span><span class="token function">fireChannelRead</span><span class="token punctuation">(</span>readBuf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>щЪПхРОmain reactorч║┐чиЛф╝ЪщБНхОЖ<code>List&lt;Object&gt; readBuf</code>щЫЖхРИф╕нчЪДNioSocketChannelя╝Мх╣╢хЬиNioServerSocketChannelчЪДpipelineф╕нф╝ацТнChannelReadф║Лф╗╢уАВ</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiaLcRXsic4tugeyCbo2ZjSLhNtU09WGLEicbhFmqJBY7BDibKss8j2BTKibg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="хЫ╛чЙЗ"></p> <p>цЬАч╗И<code>ChannelReadф║Лф╗╢</code>ф╝Ъф╝ацТнхИ░<code>ServerBootstrapAcceptor</code>ф╕ня╝Мш┐ЩщЗМцнгцШпNettyхдДчРЖховцИ╖члпш┐ЮцОечЪДца╕х┐ГщА╗ш╛СцЙАхЬиуАВ</p> <p><code>ServerBootstrapAcceptor</code>ф╕╗шжБчЪДф╜ЬчФих░▒цШпхИЭхзЛхМЦховцИ╖члп<code>NioSocketChannel</code>я╝Мх╣╢х░ЖховцИ╖члпNioSocketChannelц│ихЖМхИ░<code>Sub Reactor Group</code>ф╕ня╝Мх╣╢чЫСхРм<code>OP_READф║Лф╗╢</code>уАВ</p> <p>хЬиServerBootstrapAcceptor ф╕нф╝ЪхИЭхзЛхМЦховцИ╖члпNioSocketChannelчЪДш┐Щф║Ых▒ЮцАзуАВ</p> <p>цпФхжВя╝Ъф╗ОReactorч╗Д<code>EventLoopGroup childGroup</code>я╝МчФиф║ОхИЭхзЛхМЦ<code>NioSocketChannel</code>ф╕нчЪД<code>pipeline</code>чФихИ░чЪД<code>ChannelHandler childHandler</code>я╝Мф╗ехПК<code>NioSocketChannel</code>ф╕нчЪДф╕Аф║Ы<code>childOptions</code>хТМ<code>childAttrs</code>уАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ServerBootstrapAcceptor</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">EventLoopGroup</span> childGroup<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ChannelHandler</span> childHandler<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelOption</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> childOptions<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttributeKey</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> childAttrs<span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">Channel</span> child <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Channel</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>

            <span class="token comment">//хРСховцИ╖члпNioSocketChannelчЪДpipelineф╕н</span>
            <span class="token comment">//ц╖╗хКахЬихРпхКищЕНч╜оч▒╗ServerBootstrapф╕нщЕНч╜очЪДChannelHandler</span>
            child<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>childHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//хИйчФищЕНч╜очЪДх▒ЮцАзхИЭхзЛхМЦховцИ╖члпNioSocketChannel</span>
            <span class="token function">setChannelOptions</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> childOptions<span class="token punctuation">,</span> logger<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setAttributes</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> childAttrs<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">/**
                 * 1я╝ЪхЬиSub Reactorч║┐чиЛч╗Дф╕нщАЙцЛйф╕Аф╕кReactorч╗СхоЪ
                 * 2я╝Ъх░ЖховцИ╖члпSocketChannelц│ихЖМхИ░ч╗СхоЪчЪДReactorф╕К
                 * 3я╝ЪSocketChannelц│ихЖМхИ░sub reactorф╕нчЪДselectorф╕Кя╝Мх╣╢чЫСхРмOP_READф║Лф╗╢
                 * */</span>
                childGroup<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelFutureListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelFuture</span> future<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>future<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token function">forceClose</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> future<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">forceClose</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цнгцШпхЬиш┐ЩщЗМя╝Мnettyф╝Ъх░ЖцИСф╗мхЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484005&amp;idx=1&amp;sn=52f51269902a58f40d33208421109bc3&amp;chksm=ce77c422f9004d340e5b385ef6ba24dfba1f802076ace80ad6390e934173a10401e64e13eaeb&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКшпжч╗ЖхЫ╛шзгNetty ReactorхРпхКихЕиц╡БчиЛуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>чЪДхРпхКичд║ф╛ЛчиЛх║Пф╕нхЬиServerBootstrapф╕нщЕНч╜очЪДховцИ╖члпNioSocketChannelчЪДцЙАцЬЙх▒ЮцАзя╝ИchildхЙНч╝АщЕНч╜оя╝ЙхИЭхзЛхМЦхИ░NioSocketChannelф╕нуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">EchoServer</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">PORT</span> <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;port&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;8007&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// Configure the server.</span>
        <span class="token comment">//хИЫх╗║ф╕╗ф╗ОReactorч║┐чиЛч╗Д</span>
        <span class="token class-name">EventLoopGroup</span> bossGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EventLoopGroup</span> workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">EchoServerHandler</span> serverHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EchoServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span><span class="token comment">//щЕНч╜оф╕╗ф╗ОReactor</span>
             <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token comment">//щЕНч╜оф╕╗Reactorф╕нчЪДchannelч▒╗хЮЛ</span>
             <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_BACKLOG</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token comment">//шо╛ч╜оф╕╗Reactorф╕нchannelчЪДoptionщАЙщб╣</span>
             <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoggingHandler</span><span class="token punctuation">(</span><span class="token class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">INFO</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//шо╛ч╜оф╕╗Reactorф╕нChannel-&gt;pipline-&gt;handler</span>
             <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//шо╛ч╜оф╗ОReactorф╕нц│ихЖМchannelчЪДpipeline</span>
                 <span class="token annotation punctuation">@Override</span>
                 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                     <span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token comment">//p.addLast(new LoggingHandler(LogLevel.INFO));</span>
                     p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>serverHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token punctuation">}</span>
             <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Start the server. ч╗СхоЪчлпхПгхРпхКицЬНхКбя╝Мх╝АхзЛчЫСхРмacceptф║Лф╗╢</span>
            <span class="token class-name">ChannelFuture</span> f <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Wait until the server socket is closed.</span>
            f<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// Shut down all event loops to terminate all threads.</span>
            bossGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            workerGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ф╗еф╕Кчд║ф╛Лф╗гчаБф╕нщАЪш┐ЗServerBootstrapщЕНч╜очЪДNioSocketChannelчЫ╕хЕ│х▒ЮцАзя╝Мф╝ЪхЬиNettyхРпхКих╣╢х╝АхзЛхИЭхзЛхМЦ<code>NioServerSocketChannel</code>чЪДцЧ╢хАЩх░Ж<code>ServerBootstrapAcceptor</code>чЪДхИЫх╗║хИЭхзЛхМЦх╖еф╜Ьх░БшгЕцИР<code>х╝Вцнеф╗╗хКб</code>я╝МчД╢хРОхЬи<code>NioServerSocketChannel</code>ц│ихЖМхИ░<code>Main Reactor</code>ф╕нцИРхКЯхРОцЙзшбМуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServerBootstrap</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractBootstrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerBootstrap</span><span class="token punctuation">,</span> <span class="token class-name">ServerChannel</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Channel</span> ch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                ch<span class="token punctuation">.</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServerBootstrapAcceptor</span><span class="token punctuation">(</span>
                                ch<span class="token punctuation">,</span> currentChildGroup<span class="token punctuation">,</span> currentChildHandler<span class="token punctuation">,</span> currentChildOptions<span class="token punctuation">,</span> currentChildAttrs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хЬич╗Пш┐З<code>ServerBootstrapAccptor#chanelReadхЫЮш░Г</code>чЪДхдДчРЖф╣ЛхРОя╝МцндцЧ╢ховцИ╖члпNioSocketChannelф╕нpipelineчЪДч╗УцЮДф╕║я╝Ъ</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNia6cNkLIW571QH74LhkCfFpibJSm1cwDQTQBcxClKehQVGRR3ibdP9Ea5A/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="хЫ╛чЙЗ">ховцИ╖члпchannel pipelineхИЭхзЛч╗УцЮД.png</p> <p>щЪПхРОф╝Ъх░ЖхИЭхзЛхМЦхе╜чЪДховцИ╖члпNioSocketChannelхРСSub Reactor Groupф╕нц│ихЖМя╝Мх╣╢чЫСхРм<code>OP_READф║Лф╗╢</code>уАВ</p> <p>хжВф╕ЛхЫ╛ф╕нчЪДцнещкд3цЙАчд║я╝Ъ</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNialDtXCOD5vvVGh56FT2yKauwTch6oYbrn1icPuYKaqY8nPibicWv66sQfw/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="хЫ╛чЙЗ">nettyф╕нчЪДreactor.png</p> <h2 id="_7-хРСsubreactorgroupф╕нц│ихЖМniosocketchannel"><a href="#_7-хРСsubreactorgroupф╕нц│ихЖМniosocketchannel" class="header-anchor">#</a> 7. хРСSubReactorGroupф╕нц│ихЖМNioSocketChannel</h2> <div class="language-Java extra-class"><pre class="language-java"><code>childGroup<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelFutureListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelFuture</span> future<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>future<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">forceClose</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> future<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ховцИ╖члпNioSocketChannelхРСSub Reactor Groupц│ихЖМчЪДц╡БчиЛхоМхЕихТМцЬНхКбчлпNioServerSocketChannelхРСMain Reactor Groupц│ихЖМц╡БчиЛф╕Аца╖уАВ</p> <blockquote><p>хЕ│ф║ОцЬНхКбчлпNioServerSocketChannelчЪДц│ихЖМц╡БчиЛя╝МчмФшАЕх╖▓ч╗ПхЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484005&amp;idx=1&amp;sn=52f51269902a58f40d33208421109bc3&amp;chksm=ce77c422f9004d340e5b385ef6ba24dfba1f802076ace80ad6390e934173a10401e64e13eaeb&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКшпжч╗ЖхЫ╛шзгNetty ReactorхРпхКихЕиц╡БчиЛуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕АцЦЗф╕нхБЪхЗ║ф║Жшпжч╗ЖчЪДф╗Лч╗Ня╝Мхп╣чЫ╕хЕ│ч╗ЖшКВцДЯхЕ┤ш╢гчЪДхРМхнжхПпф╗ехЬихЫЮчЬЛф╕ЛуАВ</p></blockquote> <p>ш┐ЩщЗМчмФшАЕхЬих╕жхдзхо╢чоАшжБхЫЮщб╛ф╕ЛцХ┤ф╕кц│ихЖМш┐ЗчиЛх╣╢чЭАщЗНхМ║хИлхп╣цпФховцИ╖члпNioSocetChannelф╕ОцЬНхКбчлпNioServerSocketChannelц│ихЖМш┐ЗчиЛф╕нф╕НхРМчЪДхЬ░цЦ╣уАВ</p> <h3 id="_7-1-ф╗Оsub-reactor-groupф╕нщАЙхПЦф╕Аф╕кsub-reactorш┐ЫшбМч╗СхоЪ"><a href="#_7-1-ф╗Оsub-reactor-groupф╕нщАЙхПЦф╕Аф╕кsub-reactorш┐ЫшбМч╗СхоЪ" class="header-anchor">#</a> 7.1 ф╗ОSub Reactor Groupф╕нщАЙхПЦф╕Аф╕кSub Reactorш┐ЫшбМч╗СхоЪ</h3> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">MultithreadEventLoopGroup</span> <span class="token keyword">extends</span> <span class="token class-name">MultithreadEventExecutorGroup</span> <span class="token keyword">implements</span> <span class="token class-name">EventLoopGroup</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">EventExecutor</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> chooser<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="_7-2-хРСч╗СхоЪчЪДsub-reactorф╕Кц│ихЖМniosocketchannel"><a href="#_7-2-хРСч╗СхоЪчЪДsub-reactorф╕Кц│ихЖМniosocketchannel" class="header-anchor">#</a> 7.2 хРСч╗СхоЪчЪДSub Reactorф╕Кц│ихЖМNioSocketChannel</h3> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SingleThreadEventLoop</span> <span class="token keyword">extends</span> <span class="token class-name">SingleThreadEventExecutor</span> <span class="token keyword">implements</span> <span class="token class-name">EventLoop</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//ц│ихЖМchannelхИ░ч╗СхоЪчЪДReactorф╕К</span>
        <span class="token keyword">return</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultChannelPromise</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> <span class="token string">&quot;promise&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//unsafeш┤Яш┤гchannelх║Хх▒ВчЪДхРДчзНцУНф╜Ь</span>
        promise<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><ul><li>х╜УцЧ╢цИСф╗мхЬиф╗Лч╗Н<code>NioServerSocketChannel</code>чЪДц│ихЖМш┐ЗчиЛцЧ╢я╝Мш┐ЩщЗМчЪД<code>promise.channel()</code>ф╕║<code>NioServerSocketChannel</code>уАВх║Хх▒ВчЪДunsafeцУНф╜Ьч▒╗ф╕║<code>NioMessageUnsafe</code>уАВ</li> <li>цндцЧ╢ш┐ЩщЗМчЪД<code>promise.channel()</code>ф╕║<code>NioSocketChannel</code>уАВх║Хх▒ВчЪДunsafeцУНф╜Ьч▒╗ф╕║<code>NioByteUnsafe</code>уАВ</li></ul> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">EventLoop</span> eventLoop<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//цндцЧ╢ш┐ЩщЗМчЪДeventLoopф╕║Sub Reactor</span>
        <span class="token class-name">AbstractChannel</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventLoop <span class="token operator">=</span> eventLoop<span class="token punctuation">;</span>

    <span class="token comment">/**
      * цЙзшбМchannelц│ихЖМчЪДцУНф╜Ьх┐Ещб╗цШпReactorч║┐чиЛцЭехоМцИР
      *
      * 1: хжВцЮЬх╜УхЙНцЙзшбМч║┐чиЛцШпReactorч║┐чиЛя╝МхИЩчЫ┤цОецЙзшбМregister0ш┐ЫшбМц│ихЖМ
      * 2я╝ЪхжВцЮЬх╜УхЙНцЙзшбМч║┐чиЛцШпхдЦщГич║┐чиЛя╝МхИЩщЬАшжБх░Жregister0ц│ихЖМцУНф╜Ь х░БшгЕчиЛх╝ВцнеTask чФ▒Reactorч║┐чиЛцЙзшбМ
      * */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>eventLoop<span class="token punctuation">.</span><span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">register0</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            eventLoop<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">register0</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>ц│ицДПцндцЧ╢ф╝ащАТш┐ЫцЭечЪДEventLoop eventLoopф╕║Sub Reactor</strong>уАВ</p> <p><strong>ф╜ЖцндцЧ╢чЪДцЙзшбМч║┐чиЛф╕║<code>Main Reactorч║┐чиЛ</code>я╝Мх╣╢ф╕НцШпSub Reactorч║┐чиЛя╝ИцндцЧ╢ш┐ШцЬкхРпхКия╝Й</strong>уАВ</p> <p>цЙАф╗еш┐ЩщЗМчЪД<code>eventLoop.inEventLoop()</code>ш┐ФхЫЮчЪДцШп<code>false</code>уАВ</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiazIA5weroZkxOLyqsUBrN8Q1XP3NM5vBsFVdZXIGz1Il7FPprdZ4TNg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="хЫ╛чЙЗ">image.png</p> <p>хЬи<code>elseхИЖцФп</code>ф╕нхРСч╗СхоЪчЪДSub ReactorцПРф║дц│ихЖМ<code>NioSocketChannel</code>чЪДф╗╗хКбуАВ</p> <blockquote><p>х╜Уц│ихЖМф╗╗хКбцПРф║дхРОя╝МцндцЧ╢ч╗СхоЪчЪД<code>Sub Reactorч║┐чиЛ</code>хРпхКиуАВ</p></blockquote> <h3 id="_7-3-register0"><a href="#_7-3-register0" class="header-anchor">#</a> 7.3 register0</h3> <p>цИСф╗мхПИцЭехИ░ф║ЖChannelц│ихЖМчЪДшАБхЬ░цЦ╣<code>register0цЦ╣ц│Х</code>уАВхЬи<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484005&amp;idx=1&amp;sn=52f51269902a58f40d33208421109bc3&amp;chksm=ce77c422f9004d340e5b385ef6ba24dfba1f802076ace80ad6390e934173a10401e64e13eaeb&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКшпжч╗ЖхЫ╛шзгNetty ReactorхРпхКихЕиц╡БчиЛуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕нцИСф╗мшК▒ф║ЖхдзщЗПчЪДчпЗх╣Еф╗Лч╗Нф║Жш┐Щф╕кцЦ╣ц│ХуАВш┐ЩщЗМцИСф╗мхПкхп╣цпФ<code>NioSocketChannel</code>ф╕О<code>NioServerSocketChannel</code>ф╕НхРМчЪДхЬ░цЦ╣уАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">register0</span><span class="token punctuation">(</span><span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">boolean</span> firstRegistration <span class="token operator">=</span> neverRegistered<span class="token punctuation">;</span>
        <span class="token comment">//цЙзшбМчЬЯцнгчЪДц│ихЖМцУНф╜Ь</span>
        <span class="token function">doRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//ф┐оцФ╣ц│ихЖМчК╢цАБ</span>
        neverRegistered <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        registered <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        pipeline<span class="token punctuation">.</span><span class="token function">invokeHandlerAddedIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>firstRegistration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//шзжхПСchannelActiveф║Лф╗╢</span>
                pipeline<span class="token punctuation">.</span><span class="token function">fireChannelActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAutoRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">beginRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ш┐ЩщЗМ <code>doRegister()цЦ╣ц│Х</code>х░ЖNioSocketChannelц│ихЖМхИ░Sub Reactorф╕нчЪД<code>Selector</code>ф╕КуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractNioChannel</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractChannel</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> selected <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                selectionKey <span class="token operator">=</span> <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrappedSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CancelledKeyException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>ш┐ЩщЗМцШпNettyховцИ╖члп<code>NioSocketChannel</code>ф╕ОJDK NIO хОЯчФЯ SocketChannelхЕ│шБФчЪДхЬ░цЦ╣уАВцндцЧ╢ц│ихЖМчЪД<code>IOф║Лф╗╢</code>ф╛ЭчД╢цШп<code>0</code>уАВчЫочЪДф╣ЯцШпхПкцШпф╕║ф║ЖшО╖хПЦNioSocketChannelхЬиSelectorф╕нчЪД<code>SelectionKey</code>уАВ</p> <p>хРМцЧ╢щАЪш┐З<code>SelectableChannel#register</code>цЦ╣ц│Хх░ЖNettyшЗкхоЪф╣ЙчЪДNioSocketChannelя╝Иш┐ЩщЗМчЪДthisцМЗщТИя╝ЙщЩДчЭАхЬиSelectionKeyчЪДattechmentх▒ЮцАзф╕Кя╝МхоМцИРNettyшЗкхоЪф╣ЙChannelф╕ОJDK NIO ChannelчЪДхЕ│ч│╗ч╗СхоЪуАВш┐Щца╖хЬицпПцмбхп╣Selectorш┐ЫшбМIOх░▒ч╗кф║Лф╗╢ш╜ошпвцЧ╢я╝МNetty щГ╜хПпф╗еф╗О JDK NIO Selectorш┐ФхЫЮчЪДSelectionKeyф╕ншО╖хПЦхИ░шЗкхоЪф╣ЙчЪДChannelхп╣ш▒бя╝Иш┐ЩщЗМцМЗчЪДх░▒цШпNioSocketChannelя╝ЙуАВ</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiaBHZIoOsiaAmdqQxwtXvIIgHxoYrpp2AeUMs5qEla9BoHU4wkg4Sgjqg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="хЫ╛чЙЗ">channelф╕ОSelectionKeyхп╣х║ФхЕ│ч│╗.png</p> <p>щЪПхРОш░ГчФи<code>pipeline.invokeHandlerAddedIfNeeded()</code>хЫЮш░ГховцИ╖члпNioSocketChannelф╕Кpipelineф╕нчЪДцЙАцЬЙChannelHandlerчЪД<code>handlerAddedцЦ╣ц│Х</code>я╝МцндцЧ╢<code>pipeline</code>чЪДч╗УцЮДф╕нхПкцЬЙф╕Аф╕к<code>ChannelInitializer</code>уАВцЬАч╗Иф╝ЪхЬи<code>ChannelInitializer#handlerAdded</code>хЫЮш░ГцЦ╣ц│Хф╕нхИЭхзЛхМЦховцИ╖члп<code>NioSocketChannel</code>чЪД<code>pipeline</code>уАВ</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNia6cNkLIW571QH74LhkCfFpibJSm1cwDQTQBcxClKehQVGRR3ibdP9Ea5A/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="хЫ╛чЙЗ">ховцИ╖члпchannel pipelineхИЭхзЛч╗УцЮД.png</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span> <span class="token keyword">extends</span> <span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handlerAdded</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">initChannel</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//хИЭхзЛхМЦх╖еф╜ЬхоМцИРхРОя╝МщЬАшжБх░ЖшЗкш║лф╗Оpipelineф╕нчз╗щЩд</span>
                <span class="token function">removeState</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">C</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>хЕ│ф║Охп╣Channelф╕нpipelineчЪДшпжч╗ЖхИЭхзЛхМЦш┐ЗчиЛя╝Мхп╣ч╗ЖшКВщГихИЖцДЯхЕ┤ш╢гчЪДхРМхнжхПпф╗ехЫЮчЬЛф╕Л<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484005&amp;idx=1&amp;sn=52f51269902a58f40d33208421109bc3&amp;chksm=ce77c422f9004d340e5b385ef6ba24dfba1f802076ace80ad6390e934173a10401e64e13eaeb&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">?уАКшпжч╗ЖхЫ╛шзгNetty ReactorхРпхКихЕиц╡БчиЛуАЛ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>цндцЧ╢ховцИ╖члпNioSocketChannelф╕нчЪДpipelineф╕нчЪДч╗УцЮДх░▒хПШф╕║ф║ЖцИСф╗мшЗкхоЪф╣ЙчЪДца╖хнРя╝МхЬичд║ф╛Лф╗гчаБф╕нцИСф╗мшЗкхоЪф╣ЙчЪД<code>ChannelHandler</code>ф╕║<code>EchoServerHandler</code>уАВ</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiaTdUsySmibYW5g2lI0f8hN484CkfWrAjns8jib4vPJfrta5gpuxH5lyvQ/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="хЫ╛чЙЗ">ховцИ╖члпchannel pipelineч╗УцЮД.png</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Sharable</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelReadComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        ctx<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exceptionCaught</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Close the connection when an exception is raised.</span>
        cause<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>х╜УховцИ╖члпNioSocketChannelф╕нчЪДpipelineхИЭхзЛхМЦхоМцпХхРОя╝Мnettyх░▒х╝АхзЛш░ГчФи<code>safeSetSuccess(promise)цЦ╣ц│Х</code>хЫЮш░Г<code>regFuture</code>ф╕нц│ихЖМчЪД<code>ChannelFutureListener</code>я╝МщАЪчЯеховцИ╖члпNioSocketChannelх╖▓ч╗ПцИРхКЯц│ихЖМхИ░Sub Reactorф╕Кф║ЖуАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code>childGroup<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelFutureListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelFuture</span> future<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>future<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">forceClose</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> future<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>хЬицЬНхКбчлпNioServerSocketChannelц│ихЖМчЪДцЧ╢хАЩцИСф╗мф╝ЪхЬиlistenerф╕нхРСMain ReactorцПРф║д<code>bindч╗СхоЪчлпхПгхЬ░хЭАф╗╗хКб</code>уАВф╜ЖцШпхЬи<code>NioSocketChannel</code>ц│ихЖМчЪДцЧ╢хАЩя╝МхПкф╝ЪхЬи<code>listener</code>ф╕нхдДчРЖф╕Аф╕Лц│ихЖМхд▒ш┤ечЪДцГЕхЖ╡уАВ</p></blockquote> <p>х╜УSub Reactorч║┐чиЛщАЪчЯеChannelFutureListenerц│ихЖМцИРхКЯф╣ЛхРОя╝МщЪПхРОх░▒ф╝Ъш░ГчФи<code>pipeline.fireChannelRegistered()</code>хЬиховцИ╖члпNioSocketChannelчЪДpipelineф╕нф╝ацТн<code>ChannelRegisteredф║Лф╗╢</code>уАВ</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiaAGdSxbwsoLP3mhiaKahLtKrMRdE9IXvMOyxgInz5UweSSrv8H9HwNKQ/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="хЫ╛чЙЗ">ф╝ацТнChannelRegisterф║Лф╗╢.png</p> <p><strong>ш┐ЩщЗМчмФшАЕщЗНчВ╣шжБх╝║ш░Гф╕Л</strong>я╝МхЬиф╣ЛхЙНф╗Лч╗НNioServerSocketChannelц│ихЖМчЪДцЧ╢хАЩя╝МцИСф╗мцПРхИ░хЫаф╕║цндцЧ╢NioServerSocketChannelх╣╢цЬкч╗СхоЪчлпхПгхЬ░хЭАя╝МцЙАф╗еш┐ЩцЧ╢чЪДNioServerSocketChannelх╣╢цЬкц┐Ац┤╗я╝Мш┐ЩщЗМчЪД<code>isActive()</code>ш┐ФхЫЮ<code>false</code>уАВ<code>register0цЦ╣ц│Х</code>чЫ┤цОеш┐ФхЫЮуАВ</p> <blockquote><p>цЬНхКбчлпNioServerSocketChannelхИдцЦнцШпхРжц┐Ац┤╗чЪДцаЗхЗЖф╕║члпхПгцШпхРжч╗СхоЪцИРхКЯуАВ</p></blockquote> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NioServerSocketChannel</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractNioMessageChannel</span>
                             <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>socket<span class="token punctuation">.</span></span>ServerSocketChannel</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>ховцИ╖члп<code>NioSocketChannel</code>хИдцЦнцШпхРжц┐Ац┤╗чЪДцаЗхЗЖф╕║цШпхРжхдДф║О<code>ConnectedчК╢цАБ</code>уАВщВгф╣ИцШ╛чД╢ш┐ЩщЗМшВпхоЪцШпхдДф║О<code>connectedчК╢цАБ</code>чЪДуАВ</p></blockquote> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SocketChannel</span> ch <span class="token operator">=</span> <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ch<span class="token punctuation">.</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> ch<span class="token punctuation">.</span><span class="token function">isConnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>NioSocketChannel</code>х╖▓ч╗ПхдДф║О<code>connectedчК╢цАБ</code>я╝Мш┐ЩщЗМх╣╢ф╕НщЬАшжБч╗СхоЪчлпхПгя╝МцЙАф╗еш┐ЩщЗМчЪД<code>isActive()</code>ш┐ФхЫЮ<code>true</code>уАВ</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * ховцИ╖члпSocketChannelц│ихЖМцИРхКЯхРОф╝Ъш╡░ш┐ЩщЗМя╝МхЬиchannelActiveф║Лф╗╢хЫЮш░Гф╕нц│ихЖМOP_READф║Лф╗╢
     * */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>firstRegistration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//шзжхПСchannelActiveф║Лф╗╢</span>
        pipeline<span class="token punctuation">.</span><span class="token function">fireChannelActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAutoRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>цЬАхРОш░ГчФи<code>pipeline.fireChannelActive()</code>хЬиNioSocketChannelф╕нчЪДpipelineф╝ацТн<code>ChannelActiveф║Лф╗╢</code>я╝МцЬАч╗ИхЬи<code>pipeline</code>чЪДхд┤ч╗УчВ╣<code>HeadContext</code>ф╕нхУНх║Фх╣╢ц│ихЖМ<code>OP_READф║Лф╗╢</code>хИ░<code>Sub Reactor</code>ф╕нчЪД<code>Selector</code>ф╕КуАВ</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiaaDWO56Rib0H2YViadZkbq3WErIBg6duwk22WMHcnt41ZWlS9WTtaYbcw/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="хЫ╛чЙЗ">ф╝ацТнChannelActiveф║Лф╗╢.png</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractNioChannel</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractChannel</span> <span class="token punctuation">{</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doBeginRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>чЬБчХе<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> interestOps <span class="token operator">=</span> selectionKey<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/**
         * 1я╝ЪServerSocketChannel хИЭхзЛхМЦцЧ╢ readInterestOpшо╛ч╜очЪДцШпOP_ACCEPTф║Лф╗╢
         * 2я╝ЪSocketChannel хИЭхзЛхМЦцЧ╢ readInterestOpшо╛ч╜очЪДцШпOP_READф║Лф╗╢
         * */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>interestOps <span class="token operator">&amp;</span> readInterestOp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//ц│ихЖМчЫСхРмOP_ACCEPTцИЦшАЕOP_READф║Лф╗╢</span>
            selectionKey<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span>interestOps <span class="token operator">|</span> readInterestOp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>ц│ицДПш┐ЩщЗМчЪД<code>readInterestOp</code>ф╕║ховцИ╖члп<code>NioSocketChannel</code>хЬихИЭхзЛхМЦцЧ╢шо╛ч╜очЪД<code>OP_READф║Лф╗╢</code>уАВ</p></blockquote> <hr> <p>хИ░ш┐ЩщЗМя╝МNettyф╕нчЪД<code>Main Reactor</code>цОецФ╢ш┐ЮцОечЪДцХ┤ф╕кц╡БчиЛя╝МцИСф╗мх░▒ф╗Лч╗НхоМф║Жя╝МцндцЧ╢Nettyф╕нф╕╗ф╗ОReactorч╗ДчЪДч╗УцЮДх░▒хПШф╕║я╝Ъ</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/sOIZXFW0vUZnjTia9x6OdAvgr1icM1ZsNiabSEUJ3uzXNIS7OGAbpeQ3ib7ZoCM6RlzjglPlzJ4Pud3L0oWSzN0iaAw/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="хЫ╛чЙЗ">ф╕╗ф╗ОReactorч╗ДхоМцХ┤ч╗УцЮД.png</p> <h2 id="цА╗ч╗У"><a href="#цА╗ч╗У" class="header-anchor">#</a> цА╗ч╗У</h2> <p>цЬмцЦЗцИСф╗мф╗Лч╗Нф║Ж<code>NioServerSocketChannel</code>хдДчРЖховцИ╖члпш┐ЮцОеф║Лф╗╢чЪДцХ┤ф╕кш┐ЗчиЛуАВ</p> <ul><li>цОецФ╢ш┐ЮцОечЪДцХ┤ф╕кхдДчРЖцбЖцЮ╢уАВ</li> <li>х╜▒хУНNettyцОецФ╢ш┐ЮцОехРЮхРРчЪДBugф║зчФЯчЪДхОЯхЫая╝Мф╗ехПКф┐охдНчЪДцЦ╣цбИуАВ</li> <li>хИЫх╗║х╣╢хИЭхзЛхМЦховцИ╖члп<code>NioSocketChannel</code>уАВ</li> <li>хИЭхзЛхМЦ<code>NioSocketChannel</code>ф╕нчЪД<code>pipeline</code>уАВ</li> <li>ховцИ╖члп<code>NioSocketChannel</code>хРС<code>Sub Reactor</code>ц│ихЖМчЪДш┐ЗчиЛ</li></ul> <p>хЕ╢ф╕нцИСф╗мф╣Яхп╣цпФф║Ж<code>NioServerSocketChannel</code>ф╕О<code>NioSocketChannel</code>хЬихИЫх╗║хИЭхзЛхМЦф╗ехПКхРОщЭвхРС<code>Reactor</code>ц│ихЖМш┐ЗчиЛф╕нчЪДх╖ох╝Вф╣ЛхдДуАВ</p> <p>х╜УховцИ╖члп<code>NioSocketChannel</code>цОецФ╢хоМцпХх╣╢хРС<code>Sub Reactor</code>ц│ихЖМцИРхКЯхРОя╝МщВгф╣ИцОеф╕ЛцЭе<code>Sub Reactor</code>х░▒х╝АхзЛчЫСхРмц│ихЖМхЕ╢ф╕КчЪДцЙАцЬЙховцИ╖члп<code>NioSocketChannel</code>чЪД<code>OP_READф║Лф╗╢</code>я╝Мх╣╢чнЙх╛ЕховцИ╖члпхРСцЬНхКбчлпхПСщАБч╜Сч╗ЬцХ░цНоуАВ</p> <p>хРОщЭв<code>Reactor</code>чЪДф╕╗шзТх░▒шпехПШф╕║<code>Sub Reactor</code>ф╗ехПКц│ихЖМхЬихЕ╢ф╕КчЪДховцИ╖члп<code>NioSocketChannel</code>ф║ЖуАВ</p> <p>ф╕ЛчпЗцЦЗчлая╝МцИСф╗мх░Жф╝Ъшоишо║NettyцШпхжВф╜ХцОецФ╢ч╜Сч╗ЬцХ░цНочЪД~~~~ цИСф╗мф╕ЛчпЗцЦЗчлашзБ~~</p> <h2 id="хПВшАГш╡ДцЦЩ"><a href="#хПВшАГш╡ДцЦЩ" class="header-anchor">#</a> хПВшАГш╡ДцЦЩ</h2> <p><a href="https://mp.weixin.qq.com/s/qlsggjhRvcl3KsmzE2mrhA" target="_blank" rel="noopener noreferrer">цКУхИ░Nettyф╕Аф╕кBugя╝Мщб║х╕жцЭещАПх╜╗хЬ░шБКф╕Аф╕ЛNettyцШпхжВф╜ХщлШцХИцОецФ╢ч╜Сч╗Ьш┐ЮцОечЪД (qq.com)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/echo-lxy/echo-system-design/edit/master/docs/Netty ч│╗ч╗Яшо╛шоб/25.хЫЫуАБц╖▒хЕе Netty ца╕х┐Г/15.чммхЫЫшп╛я╝ЪNetty хжВф╜ХщлШцХИцОецФ╢ч╜Сч╗Ьш┐ЮцОе.md" target="_blank" rel="noopener noreferrer">ч╝Цш╛С</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">ф╕КцмбцЫ┤цЦ░ф║О:</span> <span class="time">2024/09/19, 08:16:36</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        тЖР
        <a href="/pages/bb668a/" class="prev">чммф╕Йшп╛я╝ЪNetty ца╕х┐Гх╝ХцУО Reactor чЪДш┐Рш╜мцЮ╢цЮД</a></span> <span class="next"><a href="/pages/0938c1/">чммф║Фшп╛я╝ЪNetty хжВф╜ХщлШцХИцОецФ╢ч╜Сч╗ЬцХ░цНо</a>тЖТ
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:lixinyang2002@163.com" title="хПСщВоф╗╢" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/echo-lxy" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="хРмщЯ│ф╣Р" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="цЬмчлЩф╕╗щвШ">Vdoing</a> 
    | Copyright ┬й 2024-2024
    <span>Xinyang Li | MIT License</span></div> <div class="buttons"><div title="ш┐ФхЫЮщб╢щГи" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="хО╗шпДшо║" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ф╕╗щвШцибх╝П" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          ш╖ЯщЪПч│╗ч╗Я
        </li><li class="iconfont icon-rijianmoshi">
          ц╡ЕшЙ▓цибх╝П
        </li><li class="iconfont icon-yejianmoshi">
          ц╖▒шЙ▓цибх╝П
        </li><li class="iconfont icon-yuedu">
          щШЕшп╗цибх╝П
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.bdcc6820.js" defer></script><script src="/assets/js/2.933750c6.js" defer></script><script src="/assets/js/54.8604fc24.js" defer></script><script src="/assets/js/7.7eb70372.js" defer></script>
  </body>
</html>
