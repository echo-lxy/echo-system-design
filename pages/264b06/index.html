<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ц╖▒хЕе Redis ф║Лф╗╢щй▒хКицбЖцЮ╢ | Echo ч│╗ч╗Яшо╛шобф╣Лч╛О</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="ц░┤ц╗┤чЯ│чй┐я╝Мшо╛шобцЧащУ╢х╝╣">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.473bdd25.css" as="style"><link rel="preload" href="/assets/js/app.f1bdf1ca.js" as="script"><link rel="preload" href="/assets/js/2.933750c6.js" as="script"><link rel="preload" href="/assets/js/47.f3a2643a.js" as="script"><link rel="preload" href="/assets/js/7.7eb70372.js" as="script"><link rel="prefetch" href="/assets/js/10.b313d17c.js"><link rel="prefetch" href="/assets/js/11.c7521a10.js"><link rel="prefetch" href="/assets/js/12.38d1989d.js"><link rel="prefetch" href="/assets/js/13.850793b0.js"><link rel="prefetch" href="/assets/js/14.1141ec27.js"><link rel="prefetch" href="/assets/js/15.13af8159.js"><link rel="prefetch" href="/assets/js/16.9c3f8295.js"><link rel="prefetch" href="/assets/js/17.1bd2c772.js"><link rel="prefetch" href="/assets/js/18.e689f555.js"><link rel="prefetch" href="/assets/js/19.68db5844.js"><link rel="prefetch" href="/assets/js/20.b5e0fdf1.js"><link rel="prefetch" href="/assets/js/21.af1069aa.js"><link rel="prefetch" href="/assets/js/22.98d9538a.js"><link rel="prefetch" href="/assets/js/23.80625400.js"><link rel="prefetch" href="/assets/js/24.88b84218.js"><link rel="prefetch" href="/assets/js/25.db0f299d.js"><link rel="prefetch" href="/assets/js/26.dc5ac22f.js"><link rel="prefetch" href="/assets/js/27.e82ff876.js"><link rel="prefetch" href="/assets/js/28.6b737928.js"><link rel="prefetch" href="/assets/js/29.ebd14054.js"><link rel="prefetch" href="/assets/js/3.aa815192.js"><link rel="prefetch" href="/assets/js/30.8e70b90d.js"><link rel="prefetch" href="/assets/js/31.833f9b33.js"><link rel="prefetch" href="/assets/js/32.f1016cda.js"><link rel="prefetch" href="/assets/js/33.39471dd3.js"><link rel="prefetch" href="/assets/js/34.9740832c.js"><link rel="prefetch" href="/assets/js/35.ac8dd46f.js"><link rel="prefetch" href="/assets/js/36.8aa375d9.js"><link rel="prefetch" href="/assets/js/37.07cad209.js"><link rel="prefetch" href="/assets/js/38.42e2eab6.js"><link rel="prefetch" href="/assets/js/39.ccf686b4.js"><link rel="prefetch" href="/assets/js/4.73518a0f.js"><link rel="prefetch" href="/assets/js/40.38653c0f.js"><link rel="prefetch" href="/assets/js/41.5525b2c4.js"><link rel="prefetch" href="/assets/js/42.825c6423.js"><link rel="prefetch" href="/assets/js/43.ba91706f.js"><link rel="prefetch" href="/assets/js/44.f4a3c564.js"><link rel="prefetch" href="/assets/js/45.4dc327b0.js"><link rel="prefetch" href="/assets/js/46.7ddc3ffa.js"><link rel="prefetch" href="/assets/js/48.0fdc5aae.js"><link rel="prefetch" href="/assets/js/49.449593cb.js"><link rel="prefetch" href="/assets/js/5.1875cdb3.js"><link rel="prefetch" href="/assets/js/50.009e4919.js"><link rel="prefetch" href="/assets/js/51.88874359.js"><link rel="prefetch" href="/assets/js/52.a2af2e28.js"><link rel="prefetch" href="/assets/js/53.c391ee9d.js"><link rel="prefetch" href="/assets/js/54.89dcf983.js"><link rel="prefetch" href="/assets/js/55.2f20af86.js"><link rel="prefetch" href="/assets/js/56.bee4259d.js"><link rel="prefetch" href="/assets/js/57.b6ba41a5.js"><link rel="prefetch" href="/assets/js/6.0b558b79.js"><link rel="prefetch" href="/assets/js/8.0ec7f6e8.js"><link rel="prefetch" href="/assets/js/9.b55932ba.js">
    <link rel="stylesheet" href="/assets/css/0.styles.473bdd25.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="чЫох╜Х" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="Echo ч│╗ч╗Яшо╛шобф╣Лч╛О" class="logo"> <span class="site-name can-hide">Echo ч│╗ч╗Яшо╛шобф╣Лч╛О</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">ЁЯПащжЦщб╡</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">тЬТя╕ПчГнщЧичоЧц│Х</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ч│╗ч╗Яшо╛шоб</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/84cb49/" class="nav-link">шо╛шобхЯ║чбАшо╛цЦ╜</a></li><li class="dropdown-item"><!----> <a href="/pages/a95d7d/" class="nav-link">шо╛шобчГнщЧих║ФчФи</a></li><li class="dropdown-item"><!----> <a href="/pages/def08a/" class="nav-link">хЬ║цЩпшо╛шоб</a></li></ul></div></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">тЭУщЧочнФ</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ЁЯСАхКицАБ</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">ЁЯПащжЦщб╡</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">тЬТя╕ПчГнщЧичоЧц│Х</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ч│╗ч╗Яшо╛шоб</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/84cb49/" class="nav-link">шо╛шобхЯ║чбАшо╛цЦ╜</a></li><li class="dropdown-item"><!----> <a href="/pages/a95d7d/" class="nav-link">шо╛шобчГнщЧих║ФчФи</a></li><li class="dropdown-item"><!----> <a href="/pages/def08a/" class="nav-link">хЬ║цЩпшо╛шоб</a></li></ul></div></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">тЭУщЧочнФ</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ЁЯСАхКицАБ</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>цМЗхНЧ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>хЯ║чбА</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>ф╕╗ч║┐</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/34fa27/" class="sidebar-link">Linux ф╕нчЪД IO хдЪш╖пхдНчФи</a></li><li><a href="/pages/d4ecb9/" class="sidebar-link">Redis Server хИЭхзЛхМЦ</a></li><li><a href="/pages/d6b00d/" class="sidebar-link">Redis чЪД Reactor цибхЮЛ</a></li><li><a href="/pages/264b06/" aria-current="page" class="active sidebar-link">ц╖▒хЕе Redis ф║Лф╗╢щй▒хКицбЖцЮ╢</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/264b06/#хЙНшиА" class="sidebar-link">хЙНшиА</a></li><li class="sidebar-sub-header level2"><a href="/pages/264b06/#ф║Лф╗╢цжВш┐░" class="sidebar-link">ф║Лф╗╢цжВш┐░</a></li><li class="sidebar-sub-header level2"><a href="/pages/264b06/#ф║Лф╗╢щй▒хКицбЖцЮ╢х╛кчОпц╡БчиЛчЪДхИЭхзЛхМЦ" class="sidebar-link">ф║Лф╗╢щй▒хКицбЖцЮ╢х╛кчОпц╡БчиЛчЪДхИЭхзЛхМЦ</a></li><li class="sidebar-sub-header level2"><a href="/pages/264b06/#io-ф║Лф╗╢хдДчРЖ" class="sidebar-link">IO ф║Лф╗╢хдДчРЖ</a></li><li class="sidebar-sub-header level2"><a href="/pages/264b06/#цЧ╢щЧ┤ф║Лф╗╢хдДчРЖ" class="sidebar-link">цЧ╢щЧ┤ф║Лф╗╢хдДчРЖ</a></li><li class="sidebar-sub-header level2"><a href="/pages/264b06/#цА╗ч╗У" class="sidebar-link">цА╗ч╗У</a></li><li class="sidebar-sub-header level2"><a href="/pages/264b06/#хПВшАГцЦЗчМо" class="sidebar-link">хПВшАГцЦЗчМо</a></li></ul></li><li><a href="/pages/e6d8ef/" class="sidebar-link">Redis чЪДцЙзшбМцибх╝П</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>цФпч║┐</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>щЫЖч╛д</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="щжЦщб╡" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>Redis ч│╗ч╗Яшо╛шоб</span></li><li data-v-06225672><span data-v-06225672>ф╕╗ч║┐</span></li></ul> <div class="info" data-v-06225672><div title="ф╜ЬшАЕ" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/brother-one" target="_blank" title="ф╜ЬшАЕ" class="beLink" data-v-06225672>echo</a></div> <div title="хИЫх╗║цЧ╢щЧ┤" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-09-15</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">чЫох╜Х</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">ц╖▒хЕе Redis ф║Лф╗╢щй▒хКицбЖцЮ╢<!----></h1> <div class="page-slot page-slot-top">
    <div class="wwads-cn wwads-horizontal page-wwads" data-id="136"></div>
    <style>
      .page-wwads{
        width:100%!important;
        min-height: 0;
        margin: 0;
      }
      .page-wwads .wwads-img img{
        width:80px!important;
      }
      .page-wwads .wwads-poweredby{
        width: 40px;
        position: absolute;
        right: 25px;
        bottom: 3px;
      }
      .wwads-content .wwads-text, .page-wwads .wwads-text{
        height: 100%;
        padding-top: 5px;
        display: block;
      }
  </style>
  </div> <div class="theme-vdoing-content content__default"><div class="custom-block danger"><p class="custom-block-title">цПРхЗ║щЧощвШцШпф╕АхИЗцЩ║цЕзчЪДх╝Ачлп</p> <ul><li>Redis ф║Лф╗╢щй▒хКицбЖцЮ╢цЬЙхУкф║Ыф║Лф╗╢я╝Я</li> <li>ш┐Щф║Ыф║Лф╗╢чЪДхИЫх╗║хТМхдДчРЖхПИхИЖхИлхп╣х║Фф║Ж Redis ц║РчаБф╕нчЪДхУкф║ЫхЕ╖ф╜УцУНф╜Ья╝Я</li> <li>хжВф╜ХхЬиф╕Аф╕кцбЖцЮ╢ф╕ня╝МхРМцЧ╢хдДчРЖ IO ф║Лф╗╢ хТМ цЧ╢щЧ┤ф║Лф╗╢я╝Я</li> <li>Redis ф║Лф╗╢щй▒хКицбЖцЮ╢цЬЙхУкф║Ыца╕х┐ГхЗ╜цХ░я╝Яstructя╝Я</li></ul></div> <h2 id="хЙНшиА"><a href="#хЙНшиА" class="header-anchor">#</a> хЙНшиА</h2> <p>хЙНч╜очЯешпЖ</p> <ul><li>Linux цПРф╛ЫчЪДф╕ЙчзН IO хдЪш╖пхдНчФицЬ║хИ╢</li> <li>Redis ф║Лф╗╢щй▒хКицбЖцЮ╢чЪДхЯ║цЬмх╖еф╜ЬцЬ║хИ╢</li></ul> <p>ф║Лф╗╢щй▒хКицбЖцЮ╢цШп Redis server ш┐РшбМхРОчЪДца╕х┐Гх╛кчОпц╡БчиЛя╝Мф║ЖшзгхоГф╜ХцЧ╢чФиф╗Аф╣ИхЗ╜цХ░хдДчРЖхУкчзНф║Лф╗╢я╝Мхп╣цИСф╗мцОТцЯе server ш┐РшбМш┐ЗчиЛф╕нщБЗхИ░чЪДщЧощвШя╝МцШпх╛ИцЬЙх╕охКйчЪД</p> <h2 id="ф║Лф╗╢цжВш┐░"><a href="#ф║Лф╗╢цжВш┐░" class="header-anchor">#</a> ф║Лф╗╢цжВш┐░</h2> <ul><li><p>цЦЗф╗╢ф║Лф╗╢уАМф╣ЯхПл IO ф║Лф╗╢уАНя╝ЪRedis цЬНхКбхЩищАЪш┐ЗхеЧцОехнЧф╕ОховцИ╖члпш┐ЫшбМш┐ЮцОея╝МшАМ<strong>цЦЗф╗╢ф║Лф╗╢х░▒цШпцЬНхКбхЩихп╣хеЧцОехнЧцУНф╜ЬчЪДцК╜ш▒б</strong>уАВцЬНхКбхЩиф╕ОховцИ╖члпчЪДщАЪф┐бф╝Ъф║зчФЯчЫ╕х║ФчЪДцЦЗф╗╢ф║Лф╗╢я╝МшАМцЬНхКбхЩихИЩщАЪш┐ЗчЫСхРмх╣╢хдДчРЖш┐Щф║Ыф║Лф╗╢цЭехоМцИРф╕Ач│╗хИЧч╜Сч╗ЬщАЪф┐бцУНф╜ЬуАВ</p></li> <li><p>цЧ╢щЧ┤ф║Лф╗╢я╝ЪRedis цЬНхКбхЩиф╕нчЪДф╕Аф║ЫцУНф╜ЬуАМцпФхжВ servercron хЗ╜цХ░уАНщЬАшжБхЬич╗ЩхоЪчЪДцЧ╢щЧ┤чВ╣цЙзшбМя╝МшАМцЧ╢щЧ┤ф║Лф╗╢х░▒цШпцЬНхКбхЩихп╣ш┐Щч▒╗хоЪцЧ╢цУНф╜ЬчЪДцК╜ш▒буАВ</p></li></ul> <h3 id="цЦЗф╗╢ф║Лф╗╢хдДчРЖ"><a href="#цЦЗф╗╢ф║Лф╗╢хдДчРЖ" class="header-anchor">#</a> цЦЗф╗╢ф║Лф╗╢хдДчРЖ</h3> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409151551218.png" alt="image-20240915155140145"></p> <p>цЦЗф╗╢ф║Лф╗╢хдДчРЖхЩицЬЙхЫЫф╕кч╗ДцИРщГихИЖя╝Ъ</p> <ul><li><strong>хеЧцОехнЧ</strong>я╝ЪцЦЗф╗╢ф║Лф╗╢цШпхп╣хеЧцОехнЧцУНф╜ЬчЪДцК╜ш▒бя╝МцпПх╜Уф╕Аф╕кхеЧцОехнЧхЗЖхдЗхе╜цЙзшбМш┐ЮцОех║ФчнФуАБхЖЩхЕеуАБшп╗хПЦуАБхЕ│щЧнчнЙцУНф╜ЬцЧ╢я╝Мх░▒ф╝Ъф║зчФЯф╕Аф╕кцЦЗф╗╢ф║Лф╗╢</li> <li><strong>IO хдЪш╖пхдНчФи</strong>я╝ЪIO хдЪш╖пхдНчФичиЛх║Пш┤Яш┤гчЫСхРмхдЪф╕кхеЧцОехнЧя╝Мх╣╢хРСцЦЗф╗╢ф║Лф╗╢хИЖц┤╛хЩиф╝ащАБщВгф║Ыф║зчФЯф║Жф║Лф╗╢чЪДхеЧцОехнЧуАВ</li> <li><strong>цЦЗф╗╢ф║Лф╗╢хИЖц┤╛хЩи</strong>я╝Ъх░╜чобхдЪф╕кцЦЗф╗╢ф║Лф╗╢хПпшГ╜ф╝Ъх╣╢хПСхЬ░хЗ║чО░я╝Мф╜Ж IO хдЪш╖пхдНчФичиЛх║ПцА╗цШпф╝Ъх░ЖцЙАцЬЙф║зчФЯф║Лф╗╢чЪДхеЧцОехнЧщГ╜цФ╛хИ░<strong>ф╕Аф╕кщШЯхИЧ</strong>щЗМщЭвя╝МчД╢хРОщАЪш┐Зш┐Щф╕кщШЯхИЧя╝Мф╗ецЬЙх║П(sequentially)уАБхРМцне(synchronously)уАБцпПцмбф╕Аф╕кхеЧцОехнЧчЪДцЦ╣х╝ПхРСцЦЗф╗╢ф║Лф╗╢хИЖц┤╛хЩиф╝ащАБхеЧцОехнЧуАВх╜Уф╕Кф╕Аф╕кхеЧцОехнЧф║зчФЯчЪДф║Лф╗╢швлхдДчРЖхоМцпХф╣ЛхРО(шпехеЧцОехнЧф╕║ф║Лф╗╢цЙАхЕ│шБФчЪДф║Лф╗╢хдДчРЖхЩицЙзшбМхоМцпХ)я╝МI/O хдЪш╖пхдНчФичиЛх║ПцЙНф╝Ъч╗зч╗нхРСцЦЗф╗╢ф║Лф╗╢хИЖц┤╛хЩиф╝ащАБф╕Лф╕Аф╕кхеЧцОехнЧ</li> <li><strong>ф║Лф╗╢хдДчРЖхЩи</strong>я╝ЪцЦЗф╗╢ф║Лф╗╢хИЖц┤╛хЩицОецФ╢ I/O хдЪш╖пхдНчФичиЛх║Пф╝ацЭечЪДхеЧцОехнЧя╝Мх╣╢ца╣цНохеЧцОехнЧф║зчФЯчЪДф║Лф╗╢чЪДч▒╗ш░ГчФичЫ╕х║ФчЪДф║Лф╗╢хдДчРЖхЩиуАВцЬНхКбхЩиф╝Ъф╕║цЙзшбМф╕НхРМф╗╗хКбчЪДхеЧцОехнЧхЕ│шБФф╕НхРМчЪДф║Лф╗╢хдДчРЖхЩия╝Мш┐Щф║ЫхдДчРЖхЩицШпф╕Аф╕кф╕кхЗ╜цХ░хоГф╗мхоЪф╣Йф║ЖцЯРф╕кф║Лф╗╢хПСчФЯцЧ╢я╝МцЬНхКбхЩих║ФшпецЙзшбМчЪДхКиф╜Ь</li></ul> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409151556794.png" alt="image-20240915155600717"></p> <h3 id="цЧ╢щЧ┤ф║Лф╗╢хдДчРЖхЩи"><a href="#цЧ╢щЧ┤ф║Лф╗╢хдДчРЖхЩи" class="header-anchor">#</a> цЧ╢щЧ┤ф║Лф╗╢хдДчРЖхЩи</h3> <p>цЧ╢щЧ┤ф║Лф╗╢хИЖф╕║ф╕дч▒╗я╝Ъ</p> <ul><li>хоЪцЧ╢ф║Лф╗╢я╝Ъшойф╕Ацо╡чиЛх║ПхЬицМЗхоЪчЪДцЧ╢щЧ┤ф╣ЛхРОцЙзшбМф╕АцмбуАВцпФхжВшп┤я╝МшойчиЛх║П X хЬих╜УхЙНцЧ╢щЧ┤чЪД 30 цплчзТф╣ЛхРОцЙзшбМф╕АцмбуАВ</li> <li>хСицЬЯцАзф║Лф╗╢я╝Ъшойф╕Ацо╡чиЛх║ПцпПщЪФцМЗхоЪцЧ╢щЧ┤х░▒цЙзшбМф╕АцмбуАВцпФхжВшп┤я╝МшойчиЛх║П Y цпПщЪФ 30 цплчзТх░▒цЙзшбМф╕АцмбуАВ</li></ul> <p>ф╕Аф╕кцЧ╢щЧ┤ф║Лф╗╢ф╕╗шжБчФ▒ф╗еф╕Лф╕Йф╕кх▒ЮцАзч╗ДцИР</p> <ul><li><strong>id</strong>я╝ЪцЬНхКбхЩиф╕║цЧ╢щЧ┤ф║Лф╗╢хИЫх╗║чЪДхЕих▒АхФпф╕А ID(цаЗшпЖхП╖)уАВID хП╖цМЙф╗Ох░ПхИ░хдзчЪДщб║х║ПщАТхвЮцЦ░ф║Лф╗╢чЪД ID хП╖цпФцЧзф║Лф╗╢чЪД ID хП╖шжБхдзуАВ</li> <li><strong>when</strong>я╝ЪцплчзТч▓╛х║жчЪД UNIX цЧ╢щЧ┤цИ│я╝Мшо░х╜Хф║ЖцЧ╢щЧ┤ф║Лф╗╢чЪДхИ░ш╛╛(arrive)цЧ╢щЧ┤уАВ</li> <li><strong>timeProc</strong>я╝ЪцЧ╢щЧ┤ф║Лф╗╢хдДчРЖхЩия╝Мф╕Аф╕кхЗ╜цХ░уАВх╜УцЧ╢щЧ┤ф║Лф╗╢хИ░ш╛╛цЧ╢я╝МцЬНхКбхЩих░▒ф╝Ъш░ГчФичЫ╕х║ФчЪДхдДчРЖхЩицЭехдДчРЖф║Лф╗╢уАВ</li></ul> <blockquote><p>ф╕Аф╕кцЧ╢щЧ┤ф║Лф╗╢цШпхоЪцЧ╢ф║Лф╗╢ш┐ШцШпхСицЬЯцАзф║Лф╗╢хПЦхЖ│ф║ОцЧ╢щЧ┤ф║Лф╗╢хдДчРЖхЩичЪДш┐ФхЫЮхА╝:хжВцЮЬф║Лф╗╢хдДчРЖхЩиш┐ФхЫЮ ae.h/AENOMOREя╝МщВгф╣Иш┐Щф╕кф║Лф╗╢ф╕║хоЪцЧ╢ф║Лф╗╢:шпеф║Лф╗╢хЬиш╛╛хИ░ф╕Ацмбф╣ЛхРОх░▒ф╝ЪшвлхИащЩдя╝Мф╣ЛхРОф╕НхЖНхИ░ш╛╛уАВхжВцЮЬф║Лф╗╢хдДчРЖхЩиш┐ФхЫЮф╕Аф╕кщЭЮ AENOMORE чЪДцХ┤цХ░хА╝я╝МщВгф╣Иш┐Щф╕кф║Лф╗╢ф╕║хСицЬЯцАзцЧ╢щЧ┤:х╜Уф╕Аф╕кцЧ╢щЧ┤ф║Лф╗╢хИ░ш╛╛ф╣ЛхРОя╝МцЬНхКбхЩиф╝Ъца╣цНоф║Лф╗╢хдДчРЖхЩиш┐ФхЫЮчЪДхА╝я╝Мхп╣цЧ╢щЧ┤ф║Лф╗╢чЪД when х▒ЮцАзш┐ЫшбМцЫ┤цЦ░я╝Мшойш┐Щф╕кф║Лф╗╢хЬиф╕Ацо╡цЧ╢щЧ┤ф╣ЛхРОхЖНцмбхИ░ш╛╛я╝Мх╣╢ф╗еш┐ЩчзНцЦ╣х╝Пф╕АчЫ┤цЫ┤цЦ░х╣╢ш┐РшбМф╕ЛхО╗уАВ</p></blockquote> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409151603657.png" alt="image-20240915160321589"></p> <p>redis ф╕нчЪДцЙАцЬЙцЧ╢щЧ┤ф║Лф╗╢щГ╜цФ╛хЬиф╕Аф╕кцЧах║ПщУ╛шбиф╕ня╝МцЬНхКбхЩих░ЖцЙАцЬЙцЧ╢щЧ┤ф║Лф╗╢щГ╜цФ╛хЬиф╕Аф╕кцЧах║ПщУ╛шбиф╕ня╝МцпПх╜УцЧ╢щЧ┤ф║Лф╗╢цЙзшбМхЩиш┐РшбМцЧ╢я╝МхоГх░▒щБНхОЖцХ┤ф╕кщУ╛шбия╝МцЯецЙ╛цЙАцЬЙх╖▓хИ░ш╛╛чЪДцЧ╢щЧ┤ф║Лф╗╢я╝Мх╣╢ш░ГчФичЫ╕х║ФчЪДф║Лф╗╢хдДчРЖхЩиуАВ</p> <div class="custom-block warning"><p class="custom-block-title">ц│ицДП</p> <p>цИСф╗мшп┤ф┐ЭхнШцЧ╢щЧ┤ф║Лф╗╢чЪДщУ╛шбиф╕║цЧах║ПщУ╛шбия╝МцМЗчЪДф╕НцШпщУ╛шбиф╕НцМЙ ID цОТх║Пя╝МшАМцШпшп┤шпещУ╛шбиф╕НцМЙ when х▒ЮцАзчЪДхдзх░ПцОТх║ПуАВцнгхЫаф╕║щУ╛шбиц▓бцЬЙцМЙ when х▒ЮцАзш┐ЫшбМцОТх║Пя╝МцЙАф╗ех╜УцЧ╢щЧ┤ф║Лф╗╢цЙзшбМхЩиш┐РшбМчЪДцЧ╢хАЩя╝МхоГх┐Ещб╗щБНхОЖщУ╛шбиф╕нчЪДцЙАцЬЙцЧ╢щЧ┤ф║Лф╗╢я╝Мш┐Щца╖цЙНшГ╜чбоф┐ЭцЬНхКбхЩиф╕нцЙАцЬЙх╖▓хИ░ш╛╛чЪДцЧ╢щЧ┤ф║Лф╗╢щГ╜ф╝ЪшвлхдДчРЖуАВ</p> <p>цнгх╕╕цибх╝Пф╕ЛчЪД Redis цЬНхКбхЩихПкф╜┐чФи serverCron ф╕Аф╕кцЧ╢щЧ┤ф║Лф╗╢я╝МшАМхЬи benchmark цибх╝Пф╕Ля╝МцЬНхКбхЩиф╣ЯхПкф╜┐чФиф╕дф╕кцЧ╢щЧ┤ф║Лф╗╢уАВхЬиш┐ЩчзНцГЕхЖ╡ф╕Ля╝МцЬНхКбхЩихЗаф╣ОцШпх░ЖцЧах║ПщУ╛шбищААхМЦцИРф╕Аф╕кцМЗщТИцЭеф╜┐чФия╝М<strong>цЙАф╗еф╜┐чФицЧах║ПщУ╛шбицЭеф┐ЭхнШцЧ╢щЧ┤ф║Лф╗╢я╝Мх╣╢ф╕Нх╜▒хУНф║Лф╗╢цЙзшбМчЪДцАзшГ╜уАВ</strong></p></div> <blockquote><p>serverCron</p> <p>цМБч╗нш┐РшбМчЪД Redis цЬНхКбхЩищЬАшжБхоЪцЬЯхп╣шЗкш║лчЪДш╡Дц║РхТМчК╢цАБш┐ЫшбМцгАцЯехТМш░ГцХ┤я╝Мф╗ОшАМчбоф┐ЭцЬНхКбхЩихПпф╗ещХ┐цЬЯуАБчи│хоЪхЬ░ш┐РшбМя╝Мш┐Щф║ЫхоЪцЬЯцУНф╜ЬчФ▒ redis.c/serverCron хЗ╜цХ░ш┤Яш┤гцЙзшбМя╝МхоГчЪДф╕╗шжБх╖еф╜ЬхМЕцЛм:</p> <ul><li>цЫ┤цЦ░цЬНхКбхЩичЪДхРДч▒╗ч╗Яшобф┐бцБпя╝МцпФхжВцЧ╢щЧ┤уАБхЖЕхнШхНачФиуАБцХ░цНох║УхНачФицГЕхЖ╡чнЙуАВ</li> <li>ц╕ЕчРЖцХ░цНох║Уф╕нчЪДш┐ЗцЬЯщФохА╝хп╣уАВхЕ│щЧнхТМц╕ЕчРЖш┐ЮцОехд▒цХИчЪДховцИ╖члпуАВ</li> <li>х░ЭшпХш┐ЫшбМ AOF цИЦ RDB цМБф╣ЕхМЦцУНф╜ЬуАВ</li> <li>хжВцЮЬцЬНхКбхЩицШпф╕╗цЬНхКбхЩия╝МщВгф╣Ихп╣ф╗ОцЬНхКбхЩиш┐ЫшбМхоЪцЬЯхРМцнеуАВ</li> <li>хжВцЮЬхдДф║ОщЫЖч╛дцибх╝Пя╝Мхп╣щЫЖч╛дш┐ЫшбМхоЪцЬЯхРМцнехТМш┐ЮцОец╡ЛшпХуАВ</li></ul></blockquote> <h3 id="ца╕х┐Гц║РчаБчЪДф╝кф╗гчаБ-шЗкщб╢хРСф╕Л"><a href="#ца╕х┐Гц║РчаБчЪДф╝кф╗гчаБ-шЗкщб╢хРСф╕Л" class="header-anchor">#</a> ца╕х┐Гц║РчаБчЪДф╝кф╗гчаБя╝ИшЗкщб╢хРСф╕Ля╝Й</h3> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409151620132.png" alt="image-20240915162014063"></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#хИЭхзЛхМЦцЬНхКбхЩи</span>
    init server<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">#ф╕АчЫ┤хдДчРЖф║Лф╗╢я╝МчЫ┤хИ░цЬНхКбхЩихЕ│щЧнф╕║цнв</span>
    <span class="token keyword">while</span> server_is_not_shutdown<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    	aeProcessEvents<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">#цЬНхКбхЩихЕ│щЧня╝МцЙзшбМц╕ЕчРЖцУНф╜Ь</span>
    clean server<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">aeProcessEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#шО╖хПЦхИ░ш╛╛цЧ╢щЧ┤чж╗х╜УхЙНцЧ╢щЧ┤цЬАцОеш┐СчЪДцЧ╢щЧ┤ф║Лф╗╢</span>
    time_event<span class="token operator">=</span>aeSearchNearestTimer<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">#шобчоЧцЬАцОеш┐СчЪДцЧ╢щЧ┤ф║Лф╗╢ш╖Эчж╗хИ░ш╛╛ш┐ШцЬЙхдЪх░СцплчзТ</span>
    remaind_ms<span class="token operator">=</span>time_event<span class="token punctuation">.</span>when <span class="token operator">-</span> unix_ts_now<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">#хжВцЮЬф║Лф╗╢х╖▓хИ░ш╛╛я╝МщВгф╣Иremaind msчЪДхА╝хПпшГ╜ф╕║ш┤ЯцХ░я╝Мх░ЖхоГшо╛хоЪф╕║0</span>
    <span class="token keyword">if</span> remaind_ms <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
    	remaind_ms <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token comment">#ца╣цНоremaind_msчЪДхА╝я╝МхИЫх╗║timevalч╗УцЮД</span>
    timeval<span class="token operator">=</span>create_timeval_with_ms<span class="token punctuation">(</span>remaind_ms<span class="token punctuation">)</span>

    <span class="token comment">#щШ╗хбЮх╣╢чнЙх╛ЕцЦЗф╗╢ф║Лф╗╢ф║зчФЯя╝МцЬАхдзщШ╗хбЮцЧ╢щЧ┤чФ▒ф╝ахЕечЪДtimevalч╗УцЮДхЖ│хоЪ#хжВцЮЬremaind_msчЪДхА╝ф╕║0я╝МщВгф╣ИaeApiPo1lш░ГчФиф╣ЛхРОщймф╕Кш┐ФхЫЮя╝Мф╕НщШ╗хбЮ</span>
    aeApiPoll<span class="token punctuation">(</span>timeval<span class="token punctuation">)</span>

    <span class="token comment">#хдДчРЖцЙАцЬЙх╖▓ф║зчФЯчЪДцЦЗф╗╢ф║Лф╗╢</span>
    processFileEvents<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">#хдДчРЖцЙАцЬЙх╖▓хИ░ш╛╛чЪДцЧ╢щЧ┤ф║Лф╗╢</span>
    processTimeEvents<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">processTimeEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment">#щБНхОЖцЬНхКбхЩиф╕нчЪДцЙАцЬЙцЧ╢щЧ┤ф║Лф╗╢</span>
	<span class="token keyword">for</span> time_event <span class="token keyword">in</span> all_time_event<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment">#цгАцЯеф║Лф╗╢цШпхРжх╖▓ч╗ПхИ░ш╛╛</span>
		<span class="token keyword">if</span> time_event<span class="token punctuation">.</span>when <span class="token operator">&lt;=</span> unix_ts_now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token comment">#ф║Лф╗╢х╖▓хИ░ш╛╛</span>
			<span class="token comment">#цЙзшбМф║Лф╗╢хдДчРЖхЩия╝Мх╣╢шО╖хПЦш┐ФхЫЮхА╝</span>
			retval<span class="token operator">=</span>time_event<span class="token punctuation">.</span>timeProc<span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token comment">#хжВцЮЬш┐ЩцШпф╕Аф╕кхоЪцЧ╢ф║Лф╗╢</span>
			<span class="token keyword">if</span> retval<span class="token operator">==</span>AE_NOMORE<span class="token punctuation">:</span>
				<span class="token comment">#щВгф╣Их░Жшпеф║Лф╗╢ф╗ОцЬНхКбхЩиф╕нхИащЩд</span>
				delete_time_event_from_server<span class="token punctuation">(</span>time event<span class="token punctuation">)</span>
			<span class="token comment">#хжВцЮЬш┐ЩцШпф╕Аф╕кхСицЬЯцАзф║Лф╗╢</span>
			<span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment">#щВгф╣ИцМЙчЕзф║Лф╗╢хдДчРЖхЩичЪДш┐ФхЫЮхА╝цЫ┤цЦ░цЧ╢щЧ┤ф║Лф╗╢чЪДwhen х▒ЮцАз</span>
            <span class="token comment">#шойш┐Щф╕кф║Лф╗╢хЬицМЗхоЪчЪДцЧ╢щЧ┤ф╣ЛхРОхЖНцмбхИ░ш╛╛</span>
            	update_when<span class="token punctuation">(</span>time_event<span class="token punctuation">,</span>retval<span class="token punctuation">)</span>
</code></pre></div><h2 id="ф║Лф╗╢щй▒хКицбЖцЮ╢х╛кчОпц╡БчиЛчЪДхИЭхзЛхМЦ"><a href="#ф║Лф╗╢щй▒хКицбЖцЮ╢х╛кчОпц╡БчиЛчЪДхИЭхзЛхМЦ" class="header-anchor">#</a> ф║Лф╗╢щй▒хКицбЖцЮ╢х╛кчОпц╡БчиЛчЪДхИЭхзЛхМЦ</h2> <p>ф╕║ф║Жхп╣ш┐Щф╕дч▒╗ф║Лф╗╢цЬЙф╕кчЫ╕хп╣хЕищЭвчЪДф║Жшзгя╝МцОеф╕ЛцЭея╝МцИСф╗мхЕИф╗Оф║Лф╗╢щй▒хКицбЖцЮ╢х╛кчОпц╡БчиЛчЪДцХ░цНоч╗УцЮДхПКхЕ╢хИЭхзЛхМЦх╝АхзЛхнжш╡╖я╝МхЫаф╕║ш┐ЩщЗМщЭвх░▒хМЕхРлф║ЖщТИхп╣<strong>ш┐Щф╕дч▒╗ф║Лф╗╢чЪДцХ░цНоч╗УцЮДхоЪф╣ЙхТМхИЭхзЛхМЦцУНф╜Ь</strong>уАВ</p> <h3 id="aeeventloop-ч╗УцЮДф╜Уф╕ОхИЭхзЛхМЦ"><a href="#aeeventloop-ч╗УцЮДф╜Уф╕ОхИЭхзЛхМЦ" class="header-anchor">#</a> aeEventLoop ч╗УцЮДф╜Уф╕ОхИЭхзЛхМЦ</h3> <p>щжЦхЕИя╝МцИСф╗мцЭечЬЛф╕Л Redis ф║Лф╗╢щй▒хКицбЖцЮ╢х╛кчОпц╡БчиЛхп╣х║ФчЪДцХ░цНоч╗УцЮД aeEventLoopуАВ</p> <p>ш┐Щф╕кч╗УцЮДф╜УцШпхЬиф║Лф╗╢щй▒хКицбЖцЮ╢ф╗гчаБ <a href="https://github.com/redis/redis/tree/5.0/src/ae.h" target="_blank" rel="noopener noreferrer">ae.h <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ф╕нхоЪф╣ЙчЪДя╝Мшо░х╜Хф║ЖцбЖцЮ╢х╛кчОпш┐РшбМш┐ЗчиЛф╕нчЪДф┐бцБпя╝МхЕ╢ф╕ня╝Мх░▒хМЕхРлф║Жшо░х╜Хф╕дч▒╗ф║Лф╗╢чЪДхПШщЗПя╝МхИЖхИлцШпя╝Ъ</p> <ul><li><strong>aeFileEvent ч▒╗хЮЛчЪДцМЗщТИ *eventsя╝Мшбичд║ IO ф║Лф╗╢</strong>уАВф╣ЛцЙАф╗еч▒╗хЮЛхРНчз░ф╕║ aeFileEventя╝МцШпхЫаф╕║цЙАцЬЙчЪД IO ф║Лф╗╢щГ╜ф╝ЪчФицЦЗф╗╢цППш┐░чмжш┐ЫшбМцаЗшпЖ</li> <li><strong>aeTimeEvent ч▒╗хЮЛчЪДцМЗщТИ *timeEventHeadя╝Мшбичд║цЧ╢щЧ┤ф║Лф╗╢</strong>я╝МхН│цМЙф╕АхоЪцЧ╢щЧ┤хСицЬЯшзжхПСчЪДф║Лф╗╢</li></ul> <p>цндхдЦя╝МaeEventLoop ч╗УцЮДф╜Уф╕нш┐ШцЬЙф╕Аф╕к<strong>aeFiredEvent ч▒╗хЮЛчЪДцМЗщТИ *fired</strong>я╝Мш┐Щф╕кх╣╢ф╕НцШпф╕Ач▒╗ф╕УщЧичЪДф║Лф╗╢ч▒╗хЮЛя╝МхоГхПкцШпчФицЭешо░х╜Х<strong>х╖▓шзжхПС</strong>ф║Лф╗╢хп╣х║ФчЪДцЦЗф╗╢цППш┐░чмжф┐бцБп</p> <p>ф╕ЛщЭвчЪДф╗гчаБцШ╛чд║ф║Ж Redis ф╕нф║Лф╗╢х╛кчОпчЪДч╗УцЮДф╜УхоЪф╣Йя╝Мф╜ахПпф╗ечЬЛф╕Л</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">aeEventLoop</span> <span class="token punctuation">{</span>
    тАж
    aeFileEvent <span class="token operator">*</span>events<span class="token punctuation">;</span> <span class="token comment">//IOф║Лф╗╢цХ░ч╗Д</span>
    aeFiredEvent <span class="token operator">*</span>fired<span class="token punctuation">;</span> <span class="token comment">//х╖▓шзжхПСф║Лф╗╢цХ░ч╗Д</span>
    aeTimeEvent <span class="token operator">*</span>timeEventHead<span class="token punctuation">;</span> <span class="token comment">//шо░х╜ХцЧ╢щЧ┤ф║Лф╗╢чЪДщУ╛шбихд┤</span>
    тАж
    <span class="token keyword">void</span> <span class="token operator">*</span>apidata<span class="token punctuation">;</span> <span class="token comment">//хТМAPIш░ГчФицОехПгчЫ╕хЕ│чЪДцХ░цНо</span>
    aeBeforeSleepProc <span class="token operator">*</span>beforesleep<span class="token punctuation">;</span> <span class="token comment">//ш┐ЫхЕеф║Лф╗╢х╛кчОпц╡БчиЛхЙНцЙзшбМчЪДхЗ╜цХ░</span>
    aeBeforeSleepProc <span class="token operator">*</span>aftersleep<span class="token punctuation">;</span>  <span class="token comment">//щААхЗ║ф║Лф╗╢х╛кчОпц╡БчиЛхРОцЙзшбМчЪДхЗ╜цХ░</span>
    
<span class="token punctuation">}</span> aeEventLoop<span class="token punctuation">;</span>
</code></pre></div><p>ф║Жшзгф║Ж aeEventLoop ч╗УцЮДф╜УхРОя╝МцИСф╗мхЖНцЭечЬЛф╕Ля╝Мш┐Щф╕кч╗УцЮДф╜УцШпхжВф╜ХхИЭхзЛхМЦчЪДя╝Мш┐ЩхЕ╢ф╕нх░▒хМЕцЛмф║Ж IO ф║Лф╗╢цХ░ч╗ДхТМцЧ╢щЧ┤ф║Лф╗╢щУ╛шбичЪДхИЭхзЛхМЦуАВ</p> <h3 id="aecreateeventloop-хЗ╜цХ░чЪДхИЭхзЛхМЦцУНф╜Ь"><a href="#aecreateeventloop-хЗ╜цХ░чЪДхИЭхзЛхМЦцУНф╜Ь" class="header-anchor">#</a> aeCreateEventLoop хЗ╜цХ░чЪДхИЭхзЛхМЦцУНф╜Ь</h3> <p>хЫаф╕║ Redis server хЬихоМцИРхИЭхзЛхМЦхРОя╝Мх░▒шжБх╝АхзЛш┐РшбМф║Лф╗╢щй▒хКицбЖцЮ╢чЪДх╛кчОпц╡БчиЛя╝МцЙАф╗ея╝МaeEventLoop ч╗УцЮДф╜УхЬи<a href="http://github.com/redis/redis/tree/5.0/src/server.c" target="_blank" rel="noopener noreferrer">server.c<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>чЪД initServer хЗ╜цХ░ф╕ня╝Мх░▒щАЪш┐Зш░ГчФи **aeCreateEventLoop хЗ╜цХ░ **ш┐ЫшбМхИЭхзЛхМЦф║ЖуАВш┐Щф╕кхЗ╜цХ░чЪДхПВцХ░хПкцЬЙф╕Аф╕кя╝МцШп setsize</p> <p>ф╕ЛщЭвчЪДф╗гчаБх▒Хчд║ф║Ж initServer хЗ╜цХ░ф╕нхп╣ aeCreateEventLoop хЗ╜цХ░чЪДш░ГчФиуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token function">initServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    тАж
    <span class="token comment">//ш░ГчФи aeCreateEventLoop хЗ╜цХ░хИЫх╗║ aeEventLoop ч╗УцЮДф╜Уя╝Мх╣╢ш╡ЛхА╝ч╗Щ server ч╗УцЮДчЪД el хПШщЗП</span>
    server<span class="token punctuation">.</span>el <span class="token operator">=</span> <span class="token function">aeCreateEventLoop</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxclients<span class="token operator">+</span>CONFIG_FDSET_INCR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    тАж
<span class="token punctuation">}</span>
</code></pre></div><p>ф╗Ош┐ЩщЗМцИСф╗мхПпф╗ечЬЛхИ░ <strong>хПВцХ░ setsize</strong> чЪДхдзх░Пя╝МхЕ╢хоЮцШпчФ▒ server ч╗УцЮДчЪД maxclients хПШщЗПхТМхоПхоЪф╣Й CONFIG_FDSET_INCR хЕ▒хРМхЖ│хоЪчЪДуАВхЕ╢ф╕ня╝Мmaxclients хПШщЗПчЪДхА╝хдзх░Пя╝МхПпф╗ехЬи Redis чЪДщЕНч╜оцЦЗф╗╢ redis.conf ф╕нш┐ЫшбМхоЪф╣Йя╝Мщ╗ШшодхА╝цШп 1000уАВшАМхоПхоЪф╣Й CONFIG_FDSET_INCR чЪДхдзх░Пя╝МчнЙф║ОхоПхоЪф╣Й CONFIG_MIN_RESERVED_FDS чЪДхА╝хЖНхКаф╕К 96я╝МхжВф╕ЛцЙАчд║я╝Мш┐ЩщЗМчЪДф╕дф╕кхоПхоЪф╣ЙщГ╜цШпхЬи<a href="https://github.com/redis/redis/blob/5.0/src/server.h" target="_blank" rel="noopener noreferrer">server.h<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>цЦЗф╗╢ф╕нхоЪф╣ЙчЪДуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CONFIG_MIN_RESERVED_FDS</span> <span class="token expression"><span class="token number">32</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CONFIG_FDSET_INCR</span> <span class="token expression"><span class="token punctuation">(</span>CONFIG_MIN_RESERVED_FDS<span class="token operator">+</span><span class="token number">96</span><span class="token punctuation">)</span></span></span>
</code></pre></div><p>хе╜ф║Жя╝МхИ░ш┐ЩщЗМя╝Мф╜ахПпшГ╜цЬЙчЦСщЧоф║Жя╝ЪaeCreateEventLoop хЗ╜цХ░чЪДхПВцХ░ setsizeя╝Мшо╛ч╜оф╕║цЬАхдзховцИ╖члпцХ░щЗПхКаф╕Кф╕Аф╕кхоПхоЪф╣ЙхА╝я╝МхПпцШп<strong>ш┐Щф╕кхПВцХ░цЬЙф╗Аф╣ИчФихСв</strong>я╝Яш┐Щх░▒хТМ aeCreateEventLoop хЗ╜цХ░хЕ╖ф╜УцЙзшбМчЪДхИЭхзЛхМЦцУНф╜ЬцЬЙхЕ│ф║ЖуАВ</p> <p>цОеф╕ЛцЭея╝МцИСф╗мх░▒цЭечЬЛф╕Л aeCreateEventLoop хЗ╜цХ░цЙзшбМчЪДцУНф╜Ья╝МхдзшЗ┤хПпф╗ехИЖцИРф╗еф╕Лф╕Йф╕кцнещкдуАВ</p> <p><strong>чммф╕Ацнея╝МaeCreateEventLoop хЗ╜цХ░ф╝ЪхИЫх╗║ф╕Аф╕к aeEventLoop ч╗УцЮДф╜Уч▒╗хЮЛчЪДхПШщЗП eventLoop</strong>уАВчД╢хРОя╝МшпехЗ╜цХ░ф╝Ъч╗Щ eventLoop чЪДцИРхСШхПШщЗПхИЖщЕНхЖЕхнШчй║щЧ┤я╝МцпФхжВя╝МцМЙчЕзф╝ахЕечЪДхПВцХ░ setsizeя╝Мч╗Щ IO ф║Лф╗╢цХ░ч╗ДхТМх╖▓шзжхПСф║Лф╗╢цХ░ч╗ДхИЖщЕНчЫ╕х║ФчЪДхЖЕхнШчй║щЧ┤уАВцндхдЦя╝МшпехЗ╜цХ░ш┐Шф╝Ъч╗Щ eventLoop чЪДцИРхСШхПШщЗПш╡ЛхИЭхзЛхА╝</p> <p><strong>чммф║Мцнея╝МaeCreateEventLoop хЗ╜цХ░ф╝Ъш░ГчФи aeApiCreate хЗ╜цХ░</strong>уАВaeApiCreate хЗ╜цХ░х░БшгЕф║ЖцУНф╜Ьч│╗ч╗ЯцПРф╛ЫчЪД IO хдЪш╖пхдНчФихЗ╜цХ░я╝МхБЗшо╛ Redis ш┐РшбМхЬи Linux цУНф╜Ьч│╗ч╗Яф╕Кя╝Мх╣╢ф╕Ф IO хдЪш╖пхдНчФицЬ║хИ╢цШп epollя╝МщВгф╣ИцндцЧ╢я╝МaeApiCreate хЗ╜цХ░х░▒ф╝Ъш░ГчФи epoll_create хИЫх╗║ epoll хоЮф╛Ля╝МхРМцЧ╢ф╝ЪхИЫх╗║ epoll_event ч╗УцЮДчЪДцХ░ч╗Дя╝МцХ░ч╗Дхдзх░ПчнЙф║ОхПВцХ░ setsize</p> <p>ш┐ЩщЗМф╜ащЬАшжБц│ицДПя╝МaeApiCreate хЗ╜цХ░цШпцККхИЫх╗║чЪД epoll хоЮф╛ЛцППш┐░чмжхТМ epoll_event цХ░ч╗Дя╝Мф┐ЭхнШхЬиф║Ж aeApiState ч╗УцЮДф╜Уч▒╗хЮЛчЪДхПШщЗП stateя╝МхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">aeApiState</span> <span class="token punctuation">{</span>  <span class="token comment">//aeApiStateч╗УцЮДф╜УхоЪф╣Й</span>
    <span class="token keyword">int</span> epfd<span class="token punctuation">;</span>   <span class="token comment">//epollхоЮф╛ЛчЪДцППш┐░чмж</span>
    <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span>events<span class="token punctuation">;</span>   <span class="token comment">//epoll_eventч╗УцЮДф╜УцХ░ч╗Дя╝Мшо░х╜ХчЫСхРмф║Лф╗╢</span>
<span class="token punctuation">}</span> aeApiState<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">aeApiCreate</span><span class="token punctuation">(</span>aeEventLoop <span class="token operator">*</span>eventLoop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    aeApiState <span class="token operator">*</span>state <span class="token operator">=</span> <span class="token function">zmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>aeApiState<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">//х░Жepoll_eventцХ░ч╗Дф┐ЭхнШхЬиaeApiStateч╗УцЮДф╜УхПШщЗПstateф╕н</span>
    state<span class="token operator">-&gt;</span>events <span class="token operator">=</span> <span class="token function">zmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">epoll_event</span><span class="token punctuation">)</span><span class="token operator">*</span>eventLoop<span class="token operator">-&gt;</span>setsize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">//х░ЖepollхоЮф╛ЛцППш┐░чмжф┐ЭхнШхЬиaeApiStateч╗УцЮДф╜УхПШщЗПstateф╕н</span>
    state<span class="token operator">-&gt;</span>epfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ┬╖┬╖┬╖
<span class="token punctuation">}</span>
</code></pre></div><p>ч┤зцОечЭАя╝МaeApiCreate хЗ╜цХ░цКК state хПШщЗПш╡ЛхА╝ч╗Щ eventLoop ф╕нчЪД apidata уАВш┐Щца╖ф╕АцЭея╝МeventLoop ч╗УцЮДф╜Уф╕нх░▒цЬЙф║Ж epoll хоЮф╛ЛхТМ epoll_event цХ░ч╗ДчЪДф┐бцБпя╝Мш┐Щца╖х░▒хПпф╗ечФицЭехЯ║ф║О epoll хИЫх╗║хТМхдДчРЖф║Лф╗╢ф║ЖуАВцИСф╕Аф╝ЪхД┐ш┐Шф╝Ъч╗Щф╜ахЕ╖ф╜Уф╗Лч╗НуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code>eventLoop<span class="token operator">-&gt;</span>apidata <span class="token operator">=</span> state<span class="token punctuation">;</span>
</code></pre></div><p><strong>чммф╕Йцнея╝МaeCreateEventLoop хЗ╜цХ░ф╝ЪцККцЙАцЬЙч╜Сч╗Ь IO ф║Лф╗╢хп╣х║ФцЦЗф╗╢цППш┐░чмжчЪДцОйчаБя╝МхИЭхзЛхМЦф╕║ AE_NONEя╝Мшбичд║цЪВцЧ╢ф╕Нхп╣ф╗╗ф╜Хф║Лф╗╢ш┐ЫшбМчЫСхРм</strong></p> <p>цИСцКК aeCreateEventLoop хЗ╜цХ░чЪДф╕╗шжБщГихИЖф╗гчаБцФ╛хЬиш┐ЩщЗМя╝Мф╜ахПпф╗ечЬЛф╕ЛуАВ</p> <div class="language-v extra-class"><pre class="language-v"><code>aeEventLoop <span class="token operator">*</span><span class="token function">aeCreateEventLoop</span><span class="token punctuation">(</span><span class="token builtin">int</span> setsize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    aeEventLoop <span class="token operator">*</span>eventLoop<span class="token punctuation">;</span>
    <span class="token builtin">int</span> i<span class="token punctuation">;</span>

    <span class="token comment">//ч╗ЩeventLoopхПШщЗПхИЖщЕНхЖЕхнШчй║щЧ┤</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>eventLoop <span class="token operator">=</span> <span class="token function">zmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>eventLoop<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> NULL<span class="token punctuation">)</span> <span class="token keyword">goto</span> err<span class="token punctuation">;</span>

	<span class="token comment">//ч╗ЩIOф║Лф╗╢уАБх╖▓шзжхПСф║Лф╗╢хИЖщЕНхЖЕхнШчй║щЧ┤</span>
    eventLoop<span class="token operator">-</span><span class="token operator">&gt;</span>events <span class="token operator">=</span> <span class="token function">zmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>aeFileEvent<span class="token punctuation">)</span><span class="token operator">*</span>setsize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    eventLoop<span class="token operator">-</span><span class="token operator">&gt;</span>fired <span class="token operator">=</span> <span class="token function">zmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>aeFiredEvent<span class="token punctuation">)</span><span class="token operator">*</span>setsize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    тАж
    eventLoop<span class="token operator">-</span><span class="token operator">&gt;</span>setsize <span class="token operator">=</span> setsize<span class="token punctuation">;</span>
    eventLoop<span class="token operator">-</span><span class="token operator">&gt;</span>lastTime <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span>NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//шо╛ч╜оцЧ╢щЧ┤ф║Лф╗╢чЪДщУ╛шбихд┤ф╕║NULL</span>
    eventLoop<span class="token operator">-</span><span class="token operator">&gt;</span>timeEventHead <span class="token operator">=</span> NULL<span class="token punctuation">;</span>
	тАж
	<span class="token comment">//ш░ГчФиaeApiCreateхЗ╜цХ░я╝МхО╗хоЮщЩЕш░ГчФицУНф╜Ьч│╗ч╗ЯцПРф╛ЫчЪДIOхдЪш╖пхдНчФихЗ╜цХ░</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">aeApiCreate</span><span class="token punctuation">(</span>eventLoop<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> err<span class="token punctuation">;</span>

    <span class="token comment">//х░ЖцЙАцЬЙч╜Сч╗ЬIOф║Лф╗╢хп╣х║ФцЦЗф╗╢цППш┐░чмжчЪДцОйчаБшо╛ч╜оф╕║AE_NONE</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> setsize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        eventLoop<span class="token operator">-</span><span class="token operator">&gt;</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mask <span class="token operator">=</span> AE_NONE<span class="token punctuation">;</span>
    <span class="token keyword">return</span> eventLoop<span class="token punctuation">;</span>

    <span class="token comment">//хИЭхзЛхМЦхд▒ш┤ехРОчЪДхдДчРЖщА╗ш╛Ся╝М</span>
    err<span class="token punctuation">:</span>
    тАж
<span class="token punctuation">}</span>
</code></pre></div><p>хе╜я╝МщВгф╣Иф╗О aeCreateEventLoop хЗ╜цХ░чЪДцЙзшбМц╡БчиЛф╕ня╝МцИСф╗мхЕ╢хоЮхПпф╗ечЬЛхИ░ф╗еф╕Л<strong>ф╕дф╕кхЕ│щФочВ╣</strong>я╝Ъ</p> <ul><li>ф║Лф╗╢щй▒хКицбЖцЮ╢чЫСхРмчЪД IO ф║Лф╗╢цХ░ч╗Дхдзх░Пх░▒чнЙф║ОхПВцХ░ setsizeя╝Мш┐Щца╖хЖ│хоЪф║ЖхТМ Redis server ш┐ЮцОечЪДховцИ╖члпцХ░щЗПуАВцЙАф╗ея╝Мх╜Уф╜ащБЗхИ░ховцИ╖члпш┐ЮцОе Redis цЧ╢цКещФЩтАЬmax number of clients reachedтАЭя╝Мф╜ах░▒хПпф╗ехО╗ redis.conf цЦЗф╗╢ф┐оцФ╣ maxclients щЕНч╜ощб╣я╝Мф╗ецЙйхЕЕцбЖцЮ╢шГ╜чЫСхРмчЪДховцИ╖члпцХ░щЗПуАВ</li> <li>х╜Уф╜┐чФи Linux ч│╗ч╗ЯчЪД epoll цЬ║хИ╢цЧ╢я╝МцбЖцЮ╢х╛кчОпц╡БчиЛхИЭхзЛхМЦцУНф╜Ья╝Мф╝ЪщАЪш┐З aeApiCreate хЗ╜цХ░хИЫх╗║ epoll_event ч╗УцЮДцХ░ч╗Дя╝Мх╣╢ш░ГчФи epoll_create хЗ╜цХ░хИЫх╗║ epoll хоЮф╛Ля╝Мш┐ЩщГ╜цШпф╜┐чФи epoll цЬ║хИ╢чЪДхЗЖхдЗх╖еф╜ЬшжБц▒В</li></ul> <p>хИ░ш┐ЩщЗМя╝МцбЖцЮ╢х░▒хПпф╗ехИЫх╗║хТМхдДчРЖхЕ╖ф╜УчЪД IO ф║Лф╗╢хТМцЧ╢щЧ┤ф║Лф╗╢ф║ЖуАВцЙАф╗ецОеф╕ЛцЭея╝МцИСф╗мх░▒хЕИцЭеф║Жшзгф╕Л IO ф║Лф╗╢хПКхЕ╢хдДчРЖцЬ║хИ╢уАВ</p> <h2 id="io-ф║Лф╗╢хдДчРЖ"><a href="#io-ф║Лф╗╢хдДчРЖ" class="header-anchor">#</a> IO ф║Лф╗╢хдДчРЖ</h2> <p>Redis чЪД IO ф║Лф╗╢ф╕╗шжБхМЕцЛмф╕Йч▒╗я╝МхИЖхИлцШп</p> <ul><li>хПпшп╗ф║Лф╗╢</li> <li>хПпхЖЩф║Лф╗╢</li> <li>х▒ПщЪЬф║Лф╗╢</li></ul> <p>хЕ╢ф╕ня╝МхПпшп╗ф║Лф╗╢хТМхПпхЖЩф║Лф╗╢хЕ╢хоЮцпФш╛Гхе╜чРЖшзгя╝Мф╣Ях░▒цШпхп╣х║Фф║О Redis хоЮф╛Ля╝МцИСф╗мхПпф╗е<strong>ф╗ОховцИ╖члпшп╗хПЦцХ░цНоцИЦцШпхРСховцИ╖члпхЖЩхЕецХ░цНо</strong>уАВ</p> <p>шАМх▒ПщЪЬф║Лф╗╢чЪДф╕╗шжБф╜ЬчФицШпчФицЭе<strong>хПНш╜мф║Лф╗╢чЪДхдДчРЖщб║х║П</strong>уАВцпФхжВхЬищ╗ШшодцГЕхЖ╡ф╕Ля╝МRedis ф╝ЪхЕИч╗ЩховцИ╖члпш┐ФхЫЮч╗УцЮЬя╝Мф╜ЖцШпхжВцЮЬщЭвф╕┤щЬАшжБцККцХ░цНох░╜х┐лхЖЩхЕечгБчЫШчЪДцГЕхЖ╡я╝МRedis х░▒ф╝ЪчФихИ░х▒ПщЪЬф║Лф╗╢я╝МцККхЖЩцХ░цНохТМхЫЮхдНховцИ╖члпчЪДщб║х║ПхБЪф╕Лш░ГцХ┤я╝МхЕИцККцХ░цНошР╜чЫШя╝МхЖНч╗ЩховцИ╖члпхЫЮхдНуАВ</p> <p>echo ф╣ЛхЙНшп┤ш┐Зя╝МхЬи Redis ц║РчаБф╕ня╝МIO ф║Лф╗╢чЪДцХ░цНоч╗УцЮДцШп aeFileEvent ч╗УцЮДф╜Уя╝МIO ф║Лф╗╢чЪДхИЫх╗║цШпщАЪш┐З aeCreateFileEvent хЗ╜цХ░цЭехоМцИРчЪДуАВф╕ЛщЭвчЪДф╗гчаБх▒Хчд║ф║Ж aeFileEvent ч╗УцЮДф╜УчЪДхоЪф╣Йя╝Мф╜ахПпф╗ехЖНхЫЮщб╛ф╕Ля╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">aeFileEvent</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> mask<span class="token punctuation">;</span> <span class="token comment">//цОйчаБцаЗшо░я╝МхМЕцЛмхПпшп╗ф║Лф╗╢уАБхПпхЖЩф║Лф╗╢хТМх▒ПщЪЬф║Лф╗╢</span>
    aeFileProc <span class="token operator">*</span>rfileProc<span class="token punctuation">;</span>   <span class="token comment">//хдДчРЖхПпшп╗ф║Лф╗╢чЪДхЫЮш░ГхЗ╜цХ░</span>
    aeFileProc <span class="token operator">*</span>wfileProc<span class="token punctuation">;</span>   <span class="token comment">//хдДчРЖхПпхЖЩф║Лф╗╢чЪДхЫЮш░ГхЗ╜цХ░</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>clientData<span class="token punctuation">;</span>  <span class="token comment">//чзБцЬЙцХ░цНо</span>
<span class="token punctuation">}</span> aeFileEvent<span class="token punctuation">;</span>
</code></pre></div><p>шАМхп╣ф║О aeCreateFileEvent хЗ╜цХ░цЭешп┤я╝МхЬиф╕КшКВшп╛цИСф╗мх╖▓ч╗Пф║Жшзгф║ЖхоГцШпщАЪш┐З aeApiAddEvent хЗ╜цХ░цЭехоМцИРф║Лф╗╢ц│ихЖМчЪДуАВщВгф╣ИцОеф╕ЛцЭея╝МцИСф╗мхЖНф╗Оф╗гчаБч║зхИлчЬЛф╕ЛхоГцШпхжВф╜ХцЙзшбМчЪДя╝Мш┐ЩхПпф╗ех╕охКйцИСф╗мцЫ┤хКащАПх╜╗хЬ░чРЖшзгя╝Мф║Лф╗╢щй▒хКицбЖцЮ╢хп╣ IO ф║Лф╗╢чЫСхРмцШпхжВф╜ХхЯ║ф║О epoll цЬ║хИ╢хп╣х║Фх░БшгЕчЪДуАВ</p> <h3 id="io-ф║Лф╗╢хИЫх╗║"><a href="#io-ф║Лф╗╢хИЫх╗║" class="header-anchor">#</a> IO ф║Лф╗╢хИЫх╗║</h3> <p>щжЦхЕИя╝МцИСф╗мцЭечЬЛ aeCreateFileEvent хЗ╜цХ░чЪДхОЯхЮЛхоЪф╣Йя╝МхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">aeCreateFileEvent</span><span class="token punctuation">(</span>aeEventLoop <span class="token operator">*</span>eventLoop<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> mask<span class="token punctuation">,</span> aeFileProc <span class="token operator">*</span>proc<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>clientData<span class="token punctuation">)</span>
</code></pre></div><p>ш┐Щф╕кхЗ╜цХ░чЪДхПВцХ░цЬЙ 5 ф╕кя╝МхИЖхИлцШп</p> <ul><li>х╛кчОпц╡БчиЛч╗УцЮДф╜У<code>*eventLoop</code></li> <li>IO ф║Лф╗╢хп╣х║ФчЪДцЦЗф╗╢цППш┐░чмж fd</li> <li>ф║Лф╗╢ч▒╗хЮЛцОйчаБ mask</li> <li>ф║Лф╗╢хдДчРЖхЫЮш░ГхЗ╜цХ░<code>*proc</code></li> <li>ф║Лф╗╢чзБцЬЙцХ░цНо<code>*clientData</code>уАВ</li></ul> <p>хЫаф╕║х╛кчОпц╡БчиЛч╗УцЮДф╜У<code>*eventLoop</code>ф╕нцЬЙ IO ф║Лф╗╢цХ░ч╗Дя╝Мш┐Щф╕кцХ░ч╗ДчЪДхЕГч┤ацШп aeFileEvent ч▒╗хЮЛя╝МцЙАф╗ея╝МцпПф╕кцХ░ч╗ДхЕГч┤ащГ╜хп╣х║Фшо░х╜Хф║Жф╕Аф╕кцЦЗф╗╢цППш┐░чмжя╝ИцпФхжВф╕Аф╕кхеЧцОехнЧя╝ЙчЫ╕хЕ│шБФчЪДчЫСхРмф║Лф╗╢ч▒╗хЮЛхТМхЫЮш░ГхЗ╜цХ░уАВ</p> <p>aeCreateFileEvent хЗ╜цХ░ф╝ЪхЕИца╣цНоф╝ахЕечЪДцЦЗф╗╢цППш┐░чмж fdя╝МхЬи eventLoop чЪД IO ф║Лф╗╢цХ░ч╗Дф╕ня╝МшО╖хПЦшпецППш┐░чмжхЕ│шБФчЪД IO ф║Лф╗╢цМЗщТИхПШщЗП<code>*fe</code>я╝МхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code>aeFileEvent <span class="token operator">*</span>fe <span class="token operator">=</span> <span class="token operator">&amp;</span>eventLoop<span class="token operator">-&gt;</span>events<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>ч┤зцОечЭАя╝МaeCreateFileEvent хЗ╜цХ░ф╝Ъш░ГчФи aeApiAddEvent хЗ╜цХ░я╝Мц╖╗хКашжБчЫСхРмчЪДф║Лф╗╢я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">aeApiAddEvent</span><span class="token punctuation">(</span>eventLoop<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> mask<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
   <span class="token keyword">return</span> AE_ERR<span class="token punctuation">;</span>
</code></pre></div><p>aeApiAddEvent хЗ╜цХ░хоЮщЩЕф╕Кф╝Ъш░ГчФицУНф╜Ьч│╗ч╗ЯцПРф╛ЫчЪД IO хдЪш╖пхдНчФихЗ╜цХ░я╝МцЭехоМцИРф║Лф╗╢чЪДц╖╗хКауАВцИСф╗мш┐ШцШпхБЗшо╛ Redis хоЮф╛Лш┐РшбМхЬиф╜┐чФи epoll цЬ║хИ╢чЪД Linux ф╕Кя╝МщВгф╣И aeApiAddEvent хЗ╜цХ░х░▒ф╝Ъш░ГчФи epoll_ctl хЗ╜цХ░я╝Мц╖╗хКашжБчЫСхРмчЪДф║Лф╗╢уАВцИСхЬичмм 9 шо▓ф╕нхЕ╢хоЮх╖▓ч╗Пч╗Щф╜аф╗Лч╗Нш┐З epoll_ctl хЗ╜цХ░я╝Мш┐Щф╕кхЗ╜цХ░ф╝ЪцОецФ╢ 4 ф╕кхПВцХ░я╝МхИЖхИлцШпя╝Ъ</p> <ul><li>epoll хоЮф╛Ля╝Ы</li> <li>шжБцЙзшбМчЪДцУНф╜Ьч▒╗хЮЛя╝ИцШпц╖╗хКаш┐ШцШпф┐оцФ╣я╝Йя╝Ы</li> <li>шжБчЫСхРмчЪДцЦЗф╗╢цППш┐░чмжя╝Ы</li> <li>epoll_event ч▒╗хЮЛхПШщЗП</li></ul> <p>щВгф╣Ия╝М<strong>ш┐Щф╕кш░ГчФиш┐ЗчиЛцШпхжВф╜ХхЗЖхдЗ epoll_ctl хЗ╜цХ░щЬАшжБчЪДхПВцХ░я╝Мф╗ОшАМхоМцИРцЙзшбМчЪДхСвя╝Я</strong></p> <p>щжЦхЕИя╝Мepoll хоЮф╛ЛцШпцИСхИЪцЙНч╗Щф╜аф╗Лч╗НчЪД aeCreateEventLoop хЗ╜цХ░я╝МхоГцШпщАЪш┐Зш░ГчФи aeApiCreate хЗ╜цХ░цЭехИЫх╗║чЪДя╝Мф┐ЭхнШхЬиф║Ж eventLoop ч╗УцЮДф╜УчЪД apidata хПШщЗПф╕ня╝Мч▒╗хЮЛцШп aeApiStateуАВцЙАф╗ея╝МaeApiAddEvent хЗ╜цХ░ф╝ЪхЕИшО╖хПЦшпехПШщЗПя╝МхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">aeApiAddEvent</span><span class="token punctuation">(</span>aeEventLoop <span class="token operator">*</span>eventLoop<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> mask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//ф╗ОeventLoopч╗УцЮДф╜Уф╕ншО╖хПЦaeApiStateхПШщЗПя╝МщЗМщЭвф┐ЭхнШф║ЖepollхоЮф╛Л</span>
	aeApiState <span class="token operator">*</span>state <span class="token operator">=</span> eventLoop<span class="token operator">-&gt;</span>apidata<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">}</span>
</code></pre></div><p>хЕ╢цмбя╝Мхп╣ф║ОшжБцЙзшбМчЪДцУНф╜Ьч▒╗хЮЛчЪДшо╛ч╜оя╝МaeApiAddEvent хЗ╜цХ░ф╝Ъца╣цНоф╝ахЕечЪДцЦЗф╗╢цППш┐░чмж fdя╝МхЬи eventLoop ч╗УцЮДф╜Уф╕н IO ф║Лф╗╢цХ░ч╗Дф╕нцЯецЙ╛шпе fdуАВхЫаф╕║ IO ф║Лф╗╢цХ░ч╗ДчЪДцпПф╕кхЕГч┤ая╝МщГ╜хп╣х║Фф║Жф╕Аф╕кцЦЗф╗╢цППш┐░чмжя╝МшАМшпецХ░ч╗ДхИЭхзЛхМЦцЧ╢я╝МцпПф╕кхЕГч┤ачЪДхА╝щГ╜шо╛ч╜оф╕║ф║Ж AE_NONEуАВ</p> <p>цЙАф╗ея╝МхжВцЮЬшжБчЫСхРмчЪДцЦЗф╗╢цППш┐░чмж fd хЬицХ░ч╗Дф╕нчЪДч▒╗хЮЛф╕НцШп AE_NONEя╝МхИЩшбицШОшпецППш┐░чмжх╖▓хБЪш┐Зшо╛ч╜оя╝МщВгф╣ИцУНф╜Ьч▒╗хЮЛх░▒цШпф┐оцФ╣цУНф╜Ья╝Мхп╣х║Ф epoll цЬ║хИ╢ф╕нчЪДхоПхоЪф╣Й EPOLL_CTL_MODуАВхРжхИЩя╝МцУНф╜Ьч▒╗хЮЛх░▒цШпц╖╗хКацУНф╜Ья╝Мхп╣х║Ф epoll цЬ║хИ╢ф╕нчЪДхоПхоЪф╣Й EPOLL_CTL_ADDуАВш┐ЩщГихИЖф╗гчаБхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">//хжВцЮЬцЦЗф╗╢цППш┐░чмжfdхп╣х║ФчЪДIOф║Лф╗╢х╖▓хнШхЬия╝МхИЩцУНф╜Ьч▒╗хЮЛф╕║ф┐оцФ╣я╝МхРжхИЩф╕║ц╖╗хКа</span>
 <span class="token keyword">int</span> op <span class="token operator">=</span> eventLoop<span class="token operator">-&gt;</span>events<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">.</span>mask <span class="token operator">==</span> AE_NONE <span class="token operator">?</span>
            EPOLL_CTL_ADD <span class="token operator">:</span> EPOLL_CTL_MOD<span class="token punctuation">;</span>
</code></pre></div><p>чммф╕Йя╝Мepoll_ctl хЗ╜цХ░щЬАшжБчЪДчЫСхРмцЦЗф╗╢цППш┐░чмжя╝Мх░▒цШп aeApiAddEvent хЗ╜цХ░цОецФ╢хИ░чЪДхПВцХ░ fdуАВ</p> <p>цЬАхРОя╝Мepoll_ctl хЗ╜цХ░ш┐ШщЬАшжБф╕Аф╕к epoll_event ч▒╗хЮЛхПШщЗПя╝МхЫацнд aeApiAddEvent хЗ╜цХ░хЬиш░ГчФи epoll_ctl хЗ╜цХ░хЙНя╝Мф╝ЪцЦ░хИЫх╗║ epoll_event ч▒╗хЮЛ**хПШщЗП eeуАВ**чД╢хРОя╝МaeApiAddEvent хЗ╜цХ░ф╝Ъшо╛ч╜охПШщЗП ee ф╕нчЪДчЫСхРмф║Лф╗╢ч▒╗хЮЛхТМчЫСхРмцЦЗф╗╢цППш┐░чмжуАВ</p> <p>aeApiAddEvent хЗ╜цХ░чЪДхПВцХ░ maskя╝Мшбичд║чЪДцШпшжБчЫСхРмчЪДф║Лф╗╢ч▒╗хЮЛцОйчаБуАВцЙАф╗ея╝МaeApiAddEvent хЗ╜цХ░ф╝Ъца╣цНоцОйчаБхА╝цШпхПпшп╗я╝ИAE_READABLEя╝ЙцИЦхПпхЖЩя╝ИAE_WRITABLEя╝Йф║Лф╗╢я╝МцЭешо╛ч╜о ee чЫСхРмчЪДф║Лф╗╢ч▒╗хЮЛцШп EPOLLIN ш┐ШцШп EPOLLOUTуАВш┐Щца╖ф╕АцЭея╝МRedis ф║Лф╗╢щй▒хКицбЖцЮ╢ф╕нчЪДшп╗хЖЩф║Лф╗╢х░▒шГ╜хдЯхТМ epoll цЬ║хИ╢ф╕нчЪДшп╗хЖЩф║Лф╗╢хп╣х║Фф╕КцЭеуАВф╕ЛщЭвчЪДф╗гчаБх▒Хчд║ф║Жш┐ЩщГихИЖщА╗ш╛Ся╝Мф╜ахПпф╗ечЬЛф╕ЛуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code>тАж
<span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> ee <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">//хИЫх╗║epoll_eventч▒╗хЮЛхПШщЗП</span>
тАж
<span class="token comment">//х░ЖхПпшп╗цИЦхПпхЖЩIOф║Лф╗╢ч▒╗хЮЛш╜мцНвф╕║epollчЫСхРмчЪДч▒╗хЮЛEPOLLINцИЦEPOLLOUT</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>mask <span class="token operator">&amp;</span> AE_READABLE<span class="token punctuation">)</span> ee<span class="token punctuation">.</span>events <span class="token operator">|=</span> EPOLLIN<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>mask <span class="token operator">&amp;</span> AE_WRITABLE<span class="token punctuation">)</span> ee<span class="token punctuation">.</span>events <span class="token operator">|=</span> EPOLLOUT<span class="token punctuation">;</span>
ee<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>  <span class="token comment">//х░ЖшжБчЫСхРмчЪДцЦЗф╗╢цППш┐░чмжш╡ЛхА╝ч╗Щee</span>
тАж
</code></pre></div><p>хе╜ф║Жя╝МхИ░ш┐ЩщЗМя╝МaeApiAddEvent хЗ╜цХ░х░▒хЗЖхдЗхе╜ф║Ж epoll хоЮф╛ЛуАБцУНф╜Ьч▒╗хЮЛуАБчЫСхРмцЦЗф╗╢цППш┐░чмжф╗ехПК epoll_event ч▒╗хЮЛхПШщЗПя╝МчД╢хРОя╝МхоГх░▒ф╝Ъш░ГчФи epoll_ctl х╝АхзЛхоЮщЩЕхИЫх╗║чЫСхРмф║Лф╗╢ф║Жя╝МхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">aeApiAddEvent</span><span class="token punctuation">(</span>aeEventLoop <span class="token operator">*</span>eventLoop<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> mask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">//ш░ГчФиepoll_ctlхоЮщЩЕхИЫх╗║чЫСхРмф║Лф╗╢</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>state<span class="token operator">-&gt;</span>epfd<span class="token punctuation">,</span>op<span class="token punctuation">,</span>fd<span class="token punctuation">,</span><span class="token operator">&amp;</span>ee<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ф║Жшзгф║Жш┐Щф║Ыф╗гчаБхРОя╝МцИСф╗мхПпф╗ехнжф╣ахИ░ф║Лф╗╢щй▒хКицбЖцЮ╢цШпхжВф╜ХхЯ║ф║О epollя╝Мх░БшгЕхоЮчО░ф║Ж IO ф║Лф╗╢чЪДхИЫх╗║уАВщВгф╣Ия╝МхЬи Redis server хРпхКиш┐РшбМхРОя╝МцЬАх╝АхзЛчЫСхРмчЪД IO ф║Лф╗╢цШпхПпшп╗ф║Лф╗╢я╝Мхп╣х║Фф║ОховцИ╖члпчЪДш┐ЮцОешп╖ц▒ВуАВхЕ╖ф╜УцШп initServer хЗ╜цХ░ш░ГчФиф║Ж aeCreateFileEvent хЗ╜цХ░я╝МхИЫх╗║хПпшп╗ф║Лф╗╢я╝Мх╣╢шо╛ч╜охЫЮш░ГхЗ╜цХ░ф╕║ acceptTcpHandlerя╝МчФицЭехдДчРЖховцИ╖члпш┐ЮцОе</p> <p>цОеф╕ЛцЭея╝МцИСф╗мхЖНцЭечЬЛф╕Лф╕АцЧжцЬЙф║ЖховцИ╖члпш┐ЮцОешп╖ц▒ВхРОя╝МIO ф║Лф╗╢хЕ╖ф╜УцШпхжВф╜ХхдДчРЖчЪДхСвя╝Я</p> <h3 id="шп╗ф║Лф╗╢хдДчРЖ"><a href="#шп╗ф║Лф╗╢хдДчРЖ" class="header-anchor">#</a> шп╗ф║Лф╗╢хдДчРЖ</h3> <p>х╜У Redis server цОецФ╢хИ░ховцИ╖члпчЪДш┐ЮцОешп╖ц▒ВцЧ╢я╝Мх░▒ф╝Ъф╜┐чФиц│ихЖМхе╜чЪД <strong>acceptTcpHandler хЗ╜цХ░</strong> ш┐ЫшбМхдДчРЖуАВ</p> <p>acceptTcpHandler хЗ╜цХ░ф╝ЪцОехПЧховцИ╖члпш┐ЮцОея╝Мх╣╢хИЫх╗║х╖▓ш┐ЮцОехеЧцОехнЧ cfdуАВчД╢хРОя╝МacceptCommonHandler хЗ╜цХ░ф╝Ъшвлш░ГчФия╝МхРМцЧ╢я╝МхИЪхИЪхИЫх╗║чЪДх╖▓ш┐ЮцОехеЧцОехнЧ cfd ф╝Ъф╜Ьф╕║хПВцХ░я╝Мф╝ащАТч╗Щ acceptCommonHandler хЗ╜цХ░уАВ</p> <p>acceptCommonHandler хЗ╜цХ░ф╝Ъш░ГчФи createClient хЗ╜цХ░хИЫх╗║ховцИ╖члпуАВшАМхЬи createClient хЗ╜цХ░ф╕ня╝МцИСф╗мх░▒ф╝ЪчЬЛхИ░я╝МaeCreateFileEvent хЗ╜цХ░швлхЖНцмбш░ГчФиф║Ж</p> <p>цндцЧ╢я╝МaeCreateFileEvent хЗ╜цХ░ф╝ЪщТИхп╣х╖▓ш┐ЮцОехеЧцОехнЧф╕Кя╝МхИЫх╗║чЫСхРмф║Лф╗╢я╝Мч▒╗хЮЛф╕║ AE_READABLEя╝МхЫЮш░ГхЗ╜цХ░цШп readQueryFromClient</p> <p>хе╜ф║Жя╝МхИ░ш┐ЩщЗМя╝Мф║Лф╗╢щй▒хКицбЖцЮ╢х░▒<strong>хвЮхКа</strong>ф║Жхп╣ф╕Аф╕кховцИ╖члпх╖▓ш┐ЮцОехеЧцОехнЧчЪДчЫСхРмуАВф╕АцЧжховцИ╖члпцЬЙшп╖ц▒ВхПСщАБхИ░ serverя╝МцбЖцЮ╢х░▒ф╝ЪхЫЮш░Г readQueryFromClient хЗ╜цХ░хдДчРЖшп╖ц▒ВуАВш┐Щца╖ф╕АцЭея╝МховцИ╖члпшп╖ц▒Вх░▒шГ╜щАЪш┐Зф║Лф╗╢щй▒хКицбЖцЮ╢ш┐ЫшбМхдДчРЖф║ЖуАВ</p> <p>ф╕ЛщЭвф╗гчаБх▒Хчд║ф║Ж createClient хЗ╜цХ░ш░ГчФи aeCreateFileEvent чЪДш┐ЗчиЛя╝Мф╜ахПпф╗ечЬЛф╕ЛуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code>client <span class="token operator">*</span><span class="token function">createClient</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
тАж
<span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        тАж
        <span class="token comment">//ш░ГчФиaeCreateFileEventя╝МчЫСхРмшп╗ф║Лф╗╢я╝Мхп╣х║ФховцИ╖члпшп╗хЖЩшп╖ц▒Вя╝Мф╜┐чФиreadQueryFromclientхЫЮш░ГхЗ╜цХ░хдДчРЖ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">aeCreateFileEvent</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">,</span>fd<span class="token punctuation">,</span>AE_READABLE<span class="token punctuation">,</span>
            readQueryFromClient<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token operator">==</span> AE_ERR<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">zfree</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token punctuation">}</span>
тАж
<span class="token punctuation">}</span>
</code></pre></div><p>ф╕║ф║Жф╛┐ф║Оф╜ацОМцПбф╗ОчЫСхРмховцИ╖члпш┐ЮцОешп╖ц▒ВхИ░чЫСхРмховцИ╖члпх╕╕шзДшп╗хЖЩшп╖ц▒ВчЪДф║Лф╗╢хИЫх╗║ш┐ЗчиЛя╝МцИСчФ╗ф║Жф╕ЛщЭвш┐Щх╝ахЫ╛я╝Мф╜ахПпф╗ечЬЛф╕ЛуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409151358214.png" alt="image-20240915135841109"></p> <h3 id="хЖЩф║Лф╗╢хдДчРЖ"><a href="#хЖЩф║Лф╗╢хдДчРЖ" class="header-anchor">#</a> хЖЩф║Лф╗╢хдДчРЖ</h3> <p>Redis хоЮф╛ЛхЬицФ╢хИ░ховцИ╖члпшп╖ц▒ВхРОя╝Мф╝ЪхЬихдДчРЖховцИ╖члпхС╜ф╗дхРОя╝Мх░ЖшжБш┐ФхЫЮчЪДцХ░цНохЖЩхЕеховцИ╖члпш╛УхЗ║ч╝УхЖ▓хМ║уАВф╕ЛхЫ╛х░▒х▒Хчд║ф║Жш┐Щф╕кш┐ЗчиЛчЪДхЗ╜цХ░ш░ГчФищА╗ш╛Ся╝Ъ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409151359441.png" alt="image-20240915135959373"></p> <p>шАМхЬи Redis ф║Лф╗╢щй▒хКицбЖцЮ╢цпПцмбх╛кчОпш┐ЫхЕеф║Лф╗╢хдДчРЖхЗ╜цХ░хЙНя╝Мф╣Ях░▒цШпхЬицбЖцЮ╢ф╕╗хЗ╜цХ░ aeMain ф╕нш░ГчФи aeProcessEventsя╝МцЭехдДчРЖчЫСхРмхИ░чЪДх╖▓шзжхПСф║Лф╗╢цИЦцШпхИ░цЧ╢чЪДцЧ╢щЧ┤ф║Лф╗╢ф╣ЛхЙНя╝МщГ╜ф╝Ъш░ГчФи server.c цЦЗф╗╢ф╕нчЪД<strong>beforeSleep хЗ╜цХ░</strong>я╝Мш┐ЫшбМф╕Аф║Ыф╗╗хКбхдДчРЖя╝Мш┐ЩхЕ╢ф╕нх░▒хМЕцЛмф║Жш░ГчФи handleClientsWithPendingWrites хЗ╜цХ░я╝МхоГф╝Ъх░Ж Redis sever ховцИ╖члпч╝УхЖ▓хМ║ф╕нчЪДцХ░цНохЖЩхЫЮховцИ╖члпуАВ</p> <p>ф╕ЛщЭвч╗ЩхЗ║чЪДф╗гчаБцШпф║Лф╗╢щй▒хКицбЖцЮ╢чЪДф╕╗хЗ╜цХ░ aeMainуАВхЬишпехЗ╜цХ░цпПцмбш░ГчФи aeProcessEvents хЗ╜цХ░хЙНя╝Мх░▒ф╝Ъш░ГчФи beforeSleep хЗ╜цХ░я╝Мф╜ахПпф╗ечЬЛф╕ЛуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">aeMain</span><span class="token punctuation">(</span>aeEventLoop <span class="token operator">*</span>eventLoop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    eventLoop<span class="token operator">-&gt;</span>stop <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>eventLoop<span class="token operator">-&gt;</span>stop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token comment">//хжВцЮЬbeforeSleepхЗ╜цХ░ф╕Нф╕║чй║я╝МхИЩш░ГчФиbeforeSleepхЗ╜цХ░</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>eventLoop<span class="token operator">-&gt;</span>beforesleep <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
            eventLoop<span class="token operator">-&gt;</span><span class="token function">beforesleep</span><span class="token punctuation">(</span>eventLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//ш░ГчФихоМbeforeSleepхЗ╜цХ░я╝МхЖНхдДчРЖф║Лф╗╢</span>
        <span class="token function">aeProcessEvents</span><span class="token punctuation">(</span>eventLoop<span class="token punctuation">,</span> AE_ALL_EVENTS<span class="token operator">|</span>AE_CALL_AFTER_SLEEP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ш┐ЩщЗМф╜ашжБчЯещБУя╝МbeforeSleep хЗ╜цХ░ш░ГчФичЪД handleClientsWithPendingWrites хЗ╜цХ░я╝Мф╝ЪщБНхОЖцпПф╕Аф╕кх╛ЕхЖЩхЫЮцХ░цНочЪДховцИ╖члпя╝МчД╢хРОш░ГчФи writeToClient хЗ╜цХ░я╝Мх░ЖховцИ╖члпш╛УхЗ║ч╝УхЖ▓хМ║ф╕нчЪДцХ░цНохЖЩхЫЮуАВф╕ЛщЭвш┐Щх╝ахЫ╛х▒Хчд║ф║Жш┐Щф╕кц╡БчиЛя╝Мф╜ахПпф╗ечЬЛф╕ЛуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409151400521.png" alt="image-20240915140035435"></p> <p>ф╕Нш┐Зя╝МхжВцЮЬш╛УхЗ║ч╝УхЖ▓хМ║чЪДцХ░цНош┐Шц▓бцЬЙхЖЩхоМя╝МцндцЧ╢я╝МhandleClientsWithPendingWrites хЗ╜цХ░х░▒ф╝Ъ<strong>ш░ГчФи aeCreateFileEvent хЗ╜цХ░я╝МхИЫх╗║хПпхЖЩф║Лф╗╢</strong>я╝Мх╣╢шо╛ч╜охЫЮш░ГхЗ╜цХ░ sendReplyToClientуАВsendReplyToClient хЗ╜цХ░щЗМщЭвф╝Ъш░ГчФи writeToClient хЗ╜цХ░хЖЩхЫЮцХ░цНоуАВ</p> <blockquote><p>aeCreateFileEvent цШп Redis ф╕нчЪДф╕Аф╕кх║Хх▒ВхЗ╜цХ░я╝МчФиф║ОхРСф║Лф╗╢х╛кчОпф╕нц│ихЖМф╕Аф╕кцЦ░чЪДцЦЗф╗╢ф║Лф╗╢уАВцЦЗф╗╢ф║Лф╗╢хПпф╗ецШптАЬхПпшп╗ф║Лф╗╢тАЭя╝ИцХ░цНохИ░цЭецЧ╢шзжхПСя╝ЙцИЦтАЬхПпхЖЩф║Лф╗╢тАЭя╝Ич╝УхЖ▓хМ║чй║щЧ▓цЧ╢шзжхПСя╝ЙуАВхЬиф╕Кш┐░хЬ║цЩпф╕ня╝М<code>aeCreateFileEvent</code> хИЫх╗║чЪДцШпф╕Аф╕ктАЬхПпхЖЩф║Лф╗╢тАЭуАВ</p> <p>х╜УховцИ╖члпчЪДш╛УхЗ║ч╝УхЖ▓хМ║ш┐ШцЬкхоМхЕихПСщАБхоМцХ░цНоцЧ╢я╝МRedis ф╕Нф╝ЪчлЛхИ╗щШ╗хбЮя╝МшАМцШпщАЪш┐ЗхИЫх╗║тАЬхПпхЖЩф║Лф╗╢тАЭцЭехдДчРЖш┐Щф╕кцГЕхЖ╡уАВш┐Щф╕кхПпхЖЩф║Лф╗╢шбичд║я╝Мх╜У Redis хПСчО░ховцИ╖члпхПпф╗еч╗зч╗нцОецФ╢цХ░цНоцЧ╢я╝Иш╛УхЗ║ч╝УхЖ▓хМ║чй║щЧ▓я╝Йя╝МхоГх░▒ф╝ЪшЗкхКишзжхПСш┐Щф╕кф║Лф╗╢уАВ</p> <p>х╜УхПпхЖЩф║Лф╗╢шзжхПСцЧ╢я╝МRedis ф╝Ъш░ГчФи <code>sendReplyToClient</code> хЗ╜цХ░уАВш┐Щф╕кхЗ╜цХ░ш┤Яш┤гх░ЖхЙйф╜ЩчЪДцХ░цНоф╗Ош╛УхЗ║ч╝УхЖ▓хМ║хПСщАБч╗ЩховцИ╖члпуАВхЕ╖ф╜УцЭешп┤я╝МхоГхЖЕщГиф╝Ъш░ГчФи <code>writeToClient</code> хЗ╜цХ░цЭечЬЯцнгцЙзшбМцХ░цНохПСщАБчЪДцУНф╜ЬуАВ</p></blockquote> <p>echo шодф╕║</p> <blockquote><ol><li><strong>ш╛УхЗ║ч╝УхЖ▓хМ║</strong>я╝Ъх╜У Redis щЬАшжБх░ЖцХ░цНош┐ФхЫЮч╗ЩховцИ╖члпцЧ╢я╝МцХ░цНоф╝ЪхЕИхнШцФ╛хЬиф╕Аф╕кш╛УхЗ║ч╝УхЖ▓хМ║ф╕ня╝МчД╢хРОхЖНщАЪш┐Зч╜Сч╗Ьф╝аш╛Уч╗ЩховцИ╖члпуАВ</li> <li><strong>ч╝УхЖ▓хМ║цЬкхЖЩхоМ</strong>я╝Ъш┐Щф╕кцГЕхЖ╡хПпшГ╜хПСчФЯхЬиф╗еф╕ЛхЗачзНцГЕхЖ╡ф╕Ля╝Ъ
<ul><li><strong>ховцИ╖члпч╜Сч╗Ьф╕НчХЕ</strong>я╝ЪховцИ╖члпхдДчРЖщАЯх║жш╛ГцЕвя╝МцИЦшАЕч╜Сч╗Ьх╕жхо╜ф╕Нш╢│я╝Мхп╝шЗ┤ф╕АцмбхПкшГ╜ф╗Оч╝УхЖ▓хМ║цОецФ╢ф╕АщГихИЖцХ░цНоя╝МхЙйф╜ЩчЪДцХ░цНоцЪВцЧ╢цЧац│ХхПСщАБуАВ(хПпшГ╜цШп TCP чЪДц╗СхКичкЧхПгф╕нчЪДцОецФ╢цЦ╣чЪДцОецФ╢чкЧхПгш╖Яф╕Нф╕К)</li> <li><strong>хдзцХ░цНощЗПф╝аш╛У</strong>я╝ЪхжВцЮЬ Redis щЬАшжБхПСщАБчЪДцХ░цНощЗПх╛Ихдзя╝МцпФхжВф╕Аф╕кхдзчЪДцЯешпвч╗УцЮЬя╝МRedis хПпшГ╜цЧац│ХхЬиф╕Ацмб write цУНф╜Ьф╕нх░ЖцЙАцЬЙцХ░цНохЖЩхЕеховцИ╖члпчЪДч╜Сч╗ЬхеЧцОехнЧя╝МхПкшГ╜хЕИхЖЩхЕеф╕АщГихИЖя╝МхЙйф╕ЛчЪДцФ╛хЬич╝УхЖ▓хМ║щЗМчнЙх╛Еф╕Лф╕АцмбхЖЩхЕеуАВ</li></ul></li> <li><strong>хдДчРЖцЬ║хИ╢</strong>я╝Ъ
<ul><li>х╜У Redis хПСчО░ч╝УхЖ▓хМ║ф╕нчЪДцХ░цНоц▓бцЬЙхЖЩхоМя╝Иф╛ЛхжВя╝М<code>writeToClient</code> хЗ╜цХ░х░ЭшпХхПСщАБцХ░цНоцЧ╢хПкшГ╜хЖЩхЕеф╕АщГихИЖя╝Йя╝МхоГф╕Нф╝ЪчнЙх╛ЕцИЦщШ╗хбЮф╕╗ч║┐чиЛуАВ</li> <li>цндцЧ╢ Redis ф╝Ъш░ГчФи <code>aeCreateFileEvent</code>я╝МхИЫх╗║ф╕Аф╕к<strong>хПпхЖЩф║Лф╗╢</strong>я╝Мшбичд║ховцИ╖члпш┐ШцЬкхоМхЕицОецФ╢цХ░цНоуАВх╜УховцИ╖члпхЗЖхдЗхе╜цОецФ╢цЫ┤хдЪцХ░цНоцЧ╢я╝Мш┐Щф╕кхПпхЖЩф║Лф╗╢ф╝ЪшзжхПСя╝МхЫЮш░ГхЗ╜цХ░ <code>sendReplyToClient</code> ф╝ЪхЖНцмбшвлш░ГчФия╝Мх░ЭшпХх░ЖхЙйф╕ЛчЪДцХ░цНохПСщАБч╗ЩховцИ╖члпуАВ</li></ul></li></ol> <ul><li><strong>щБ┐хЕНщШ╗хбЮф╕╗ч║┐чиЛ</strong>я╝ЪRedis цШпхНХч║┐чиЛчЪДя╝МхжВцЮЬчФ▒ф║Оч╜Сч╗ЬщЧощвШцИЦховцИ╖члпхдДчРЖшГ╜хКЫщЩРхИ╢я╝Мф╕╗ч║┐чиЛшвлщШ╗хбЮхЬиф╕Аф╕кховцИ╖члпчЪДхПСщАБш┐ЗчиЛф╕ня╝МхЕ╢ф╗ЦховцИ╖члпчЪДшп╖ц▒Вх░▒цЧац│Хх╛ЧхИ░хПКцЧ╢хдДчРЖуАВ</li> <li><strong>цПРщлШцАзшГ╜хТМхРЮхРРщЗП</strong>я╝ЪщАЪш┐Зх╝ВцнечЪДцЦ╣х╝ПхдДчРЖч╝УхЖ▓хМ║чЪДхЙйф╜ЩцХ░цНохПСщАБя╝МRedis шГ╜хЬищлШх╣╢хПСчЪДцГЕхЖ╡ф╕ЛцЫ┤щлШцХИхЬ░хдДчРЖхдЪф╕кховцИ╖члпчЪДшп╖ц▒ВуАВ</li></ul></blockquote> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">handleClientsWithPendingWrites</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    listIter li<span class="token punctuation">;</span>
	listNode <span class="token operator">*</span>ln<span class="token punctuation">;</span>
	тАж
    <span class="token comment">//шО╖хПЦх╛ЕхЖЩхЫЮчЪДховцИ╖члпхИЧшби</span>
	<span class="token function">listRewind</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>clients_pending_write<span class="token punctuation">,</span><span class="token operator">&amp;</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//щБНхОЖцпПф╕Аф╕кх╛ЕхЖЩхЫЮчЪДховцИ╖члп</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ln <span class="token operator">=</span> <span class="token function">listNext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>li<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	   client <span class="token operator">*</span>c <span class="token operator">=</span> <span class="token function">listNodeValue</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">;</span>
	   тАж
	   <span class="token comment">//ш░ГчФиwriteToClientх░Жх╜УхЙНховцИ╖члпчЪДш╛УхЗ║ч╝УхЖ▓хМ║цХ░цНохЖЩхЫЮ</span>
	   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">writeToClient</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span>c<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> C_ERR<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
	   <span class="token comment">//хжВцЮЬш┐ШцЬЙх╛ЕхЖЩхЫЮцХ░цНо</span>
	   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">clientHasPendingReplies</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	            <span class="token keyword">int</span> ae_flags <span class="token operator">=</span> AE_WRITABLE<span class="token punctuation">;</span>
	            <span class="token comment">//хИЫх╗║хПпхЖЩф║Лф╗╢чЪДчЫСхРмя╝Мф╗ехПКшо╛ч╜охЫЮш░ГхЗ╜цХ░</span>
	             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">aeCreateFileEvent</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">,</span> c<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> ae_flags<span class="token punctuation">,</span>
	                sendReplyToClient<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token operator">==</span> AE_ERR<span class="token punctuation">)</span>
	            <span class="token punctuation">{</span>
	                   тАж
	            <span class="token punctuation">}</span>
	  <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хе╜ф║Жя╝МцИСф╗мхИЪцЙНф║ЖшзгчЪДцШпшп╗хЖЩф║Лф╗╢хп╣х║ФчЪДхЫЮш░ГхдДчРЖхЗ╜цХ░уАВхоЮщЩЕф╕Кя╝Мф╕║ф║ЖшГ╜хПКцЧ╢хдДчРЖш┐Щф║Ыф║Лф╗╢я╝МRedis ф║Лф╗╢щй▒хКицбЖцЮ╢чЪД aeMain хЗ╜цХ░ш┐Шф╝Ъх╛кчОп<strong>ш░ГчФи aeProcessEvents хЗ╜цХ░я╝МцЭецгАц╡Лх╖▓шзжхПСчЪДф║Лф╗╢я╝Мх╣╢ш░ГчФичЫ╕х║ФчЪДхЫЮш░ГхЗ╜цХ░ш┐ЫшбМхдДчРЖуАВ</strong></p> <p>ф╗О aeProcessEvents хЗ╜цХ░чЪДф╗гчаБф╕ня╝МцИСф╗мхПпф╗ечЬЛхИ░шпехЗ╜цХ░ф╝Ъш░ГчФи aeApiPoll хЗ╜цХ░я╝МцЯешпвчЫСхРмчЪДцЦЗф╗╢цППш┐░чмжф╕ня╝МцЬЙхУкф║Ых╖▓ч╗Пх░▒ч╗куАВф╕АцЧжцЬЙцППш┐░чмжх░▒ч╗кя╝МaeProcessEvents хЗ╜цХ░х░▒ф╝Ъца╣цНоф║Лф╗╢чЪДхПпшп╗цИЦхПпхЖЩч▒╗хЮЛя╝Мш░ГчФичЫ╕х║ФчЪДхЫЮш░ГхЗ╜цХ░ш┐ЫшбМхдДчРЖуАВaeProcessEvents хЗ╜цХ░ш░ГчФичЪДхЯ║цЬмц╡БчиЛхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">aeProcessEvents</span><span class="token punctuation">(</span>aeEventLoop <span class="token operator">*</span>eventLoop<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">{</span>
тАж
<span class="token comment">//ш░ГчФиaeApiPollшО╖хПЦх░▒ч╗кчЪДцППш┐░чмж</span>
numevents <span class="token operator">=</span> <span class="token function">aeApiPoll</span><span class="token punctuation">(</span>eventLoop<span class="token punctuation">,</span> tvp<span class="token punctuation">)</span><span class="token punctuation">;</span>
тАж
<span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> numevents<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	aeFileEvent <span class="token operator">*</span>fe <span class="token operator">=</span> <span class="token operator">&amp;</span>eventLoop<span class="token operator">-&gt;</span>events<span class="token punctuation">[</span>eventLoop<span class="token operator">-&gt;</span>fired<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">]</span><span class="token punctuation">;</span>
	тАж
    <span class="token comment">//хжВцЮЬшзжхПСчЪДцШпхПпшп╗ф║Лф╗╢я╝Мш░ГчФиф║Лф╗╢ц│ихЖМцЧ╢шо╛ч╜очЪДшп╗ф║Лф╗╢хЫЮш░ГхдДчРЖхЗ╜цХ░</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>invert <span class="token operator">&amp;&amp;</span> fe<span class="token operator">-&gt;</span>mask <span class="token operator">&amp;</span> mask <span class="token operator">&amp;</span> AE_READABLE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	      fe<span class="token operator">-&gt;</span><span class="token function">rfileProc</span><span class="token punctuation">(</span>eventLoop<span class="token punctuation">,</span>fd<span class="token punctuation">,</span>fe<span class="token operator">-&gt;</span>clientData<span class="token punctuation">,</span>mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
	                fired<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

    <span class="token comment">//хжВцЮЬшзжхПСчЪДцШпхПпхЖЩф║Лф╗╢я╝Мш░ГчФиф║Лф╗╢ц│ихЖМцЧ╢шо╛ч╜очЪДхЖЩф║Лф╗╢хЫЮш░ГхдДчРЖхЗ╜цХ░</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>fe<span class="token operator">-&gt;</span>mask <span class="token operator">&amp;</span> mask <span class="token operator">&amp;</span> AE_WRITABLE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fired <span class="token operator">||</span> fe<span class="token operator">-&gt;</span>wfileProc <span class="token operator">!=</span> fe<span class="token operator">-&gt;</span>rfileProc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	                    fe<span class="token operator">-&gt;</span><span class="token function">wfileProc</span><span class="token punctuation">(</span>eventLoop<span class="token punctuation">,</span>fd<span class="token punctuation">,</span>fe<span class="token operator">-&gt;</span>clientData<span class="token punctuation">,</span>mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
	                    fired<span class="token operator">++</span><span class="token punctuation">;</span>
	                <span class="token punctuation">}</span>
	            <span class="token punctuation">}</span>
	тАж
	<span class="token punctuation">}</span> <span class="token punctuation">}</span>
	тАж
<span class="token punctuation">}</span>
</code></pre></div><p>хИ░ш┐ЩщЗМя╝МцИСф╗мх░▒ф║Жшзгф║Ж IO ф║Лф╗╢чЪДхИЫх╗║хЗ╜цХ░ aeCreateFileEventя╝Мф╗ехПКхЬихдДчРЖховцИ╖члпшп╖ц▒ВцЧ╢хп╣х║ФчЪДшп╗хЖЩф║Лф╗╢хТМхоГф╗мчЪДхдДчРЖхЗ╜цХ░уАВщВгф╣ИцОеф╕ЛцЭея╝МцИСф╗мхЖНцЭечЬЛчЬЛф║Лф╗╢щй▒хКицбЖцЮ╢ф╕нчЪДцЧ╢щЧ┤ф║Лф╗╢цШпцАОф╣ИхИЫх╗║хТМхдДчРЖчЪДуАВ</p> <h2 id="цЧ╢щЧ┤ф║Лф╗╢хдДчРЖ"><a href="#цЧ╢щЧ┤ф║Лф╗╢хдДчРЖ" class="header-anchor">#</a> цЧ╢щЧ┤ф║Лф╗╢хдДчРЖ</h2> <p>хЕ╢хоЮя╝МчЫ╕цпФф║О IO ф║Лф╗╢цЬЙхПпшп╗уАБхПпхЖЩуАБх▒ПщЪЬч▒╗хЮЛя╝Мф╗ехПКф╕НхРМч▒╗хЮЛ IO ф║Лф╗╢цЬЙф╕НхРМхЫЮш░ГхЗ╜цХ░цЭешп┤я╝МцЧ╢щЧ┤ф║Лф╗╢чЪДхдДчРЖх░▒цпФш╛ГчоАхНХф║ЖуАВф╕ЛщЭвя╝МцИСф╗мх░▒цЭехИЖхИлхнжф╣аф╕ЛхоГчЪДхоЪф╣ЙуАБхИЫх╗║уАБхЫЮш░ГхЗ╜цХ░хТМшзжхПСхдДчРЖуАВ</p> <h3 id="цЧ╢щЧ┤ф║Лф╗╢хоЪф╣Й"><a href="#цЧ╢щЧ┤ф║Лф╗╢хоЪф╣Й" class="header-anchor">#</a> цЧ╢щЧ┤ф║Лф╗╢хоЪф╣Й</h3> <p>щжЦхЕИя╝МцИСф╗мцЭечЬЛф╕ЛцЧ╢щЧ┤ф║Лф╗╢чЪДч╗УцЮДф╜УхоЪф╣Йя╝Мф╗гчаБхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">aeTimeEvent</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> id<span class="token punctuation">;</span> <span class="token comment">//цЧ╢щЧ┤ф║Лф╗╢ID</span>
    <span class="token keyword">long</span> when_sec<span class="token punctuation">;</span> <span class="token comment">//ф║Лф╗╢хИ░ш╛╛чЪДчзТч║зцЧ╢щЧ┤цИ│</span>
    <span class="token keyword">long</span> when_ms<span class="token punctuation">;</span> <span class="token comment">//ф║Лф╗╢хИ░ш╛╛чЪДцплчзТч║зцЧ╢щЧ┤цИ│</span>
    aeTimeProc <span class="token operator">*</span>timeProc<span class="token punctuation">;</span> <span class="token comment">//цЧ╢щЧ┤ф║Лф╗╢шзжхПСхРОчЪДхдДчРЖхЗ╜цХ░</span>
    aeEventFinalizerProc <span class="token operator">*</span>finalizerProc<span class="token punctuation">;</span>  <span class="token comment">//ф║Лф╗╢ч╗УцЭЯхРОчЪДхдДчРЖхЗ╜цХ░</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>clientData<span class="token punctuation">;</span> <span class="token comment">//ф║Лф╗╢чЫ╕хЕ│чЪДчзБцЬЙцХ░цНо</span>
    <span class="token keyword">struct</span> <span class="token class-name">aeTimeEvent</span> <span class="token operator">*</span>prev<span class="token punctuation">;</span>  <span class="token comment">//цЧ╢щЧ┤ф║Лф╗╢щУ╛шбичЪДхЙНхРСцМЗщТИ</span>
    <span class="token keyword">struct</span> <span class="token class-name">aeTimeEvent</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>  <span class="token comment">//цЧ╢щЧ┤ф║Лф╗╢щУ╛шбичЪДхРОхРСцМЗщТИ</span>
<span class="token punctuation">}</span> aeTimeEvent<span class="token punctuation">;</span>
</code></pre></div><p>цЧ╢щЧ┤ф║Лф╗╢ч╗УцЮДф╜Уф╕нф╕╗шжБчЪДхПШщЗПя╝МхМЕцЛмф╗ечзТшо░х╜ХхТМф╗ецплчзТшо░х╜ХчЪДцЧ╢щЧ┤ф║Лф╗╢шзжхПСцЧ╢чЪДцЧ╢щЧ┤цИ│ when_sec хТМ when_msя╝Мф╗ехПКцЧ╢щЧ┤ф║Лф╗╢шзжхПСхРОчЪДхдДчРЖхЗ╜цХ░<code>*timeProc</code>уАВхПжхдЦя╝МхЬицЧ╢щЧ┤ф║Лф╗╢чЪДч╗УцЮДф╜Уф╕ня╝Мш┐ШхМЕхРлф║ЖхЙНхРСхТМхРОхРСцМЗщТИ<code>*prev</code>хТМ<code>*next</code>я╝Мш┐ЩшбицШО<strong>цЧ╢щЧ┤ф║Лф╗╢цШпф╗ещУ╛шбичЪДх╜вх╝Пч╗Дч╗Зш╡╖цЭечЪД</strong>уАВ</p> <p>хЬиф║Жшзгф║ЖцЧ╢щЧ┤ф║Лф╗╢ч╗УцЮДф╜УчЪДхоЪф╣Йф╗ехРОя╝МцИСф╗мцОечЭАцЭечЬЛф╕Ля╝МцЧ╢щЧ┤ф║Лф╗╢цШпхжВф╜ХхИЫх╗║чЪДуАВ</p> <h3 id="цЧ╢щЧ┤ф║Лф╗╢хИЫх╗║"><a href="#цЧ╢щЧ┤ф║Лф╗╢хИЫх╗║" class="header-anchor">#</a> цЧ╢щЧ┤ф║Лф╗╢хИЫх╗║</h3> <p>ф╕О IO ф║Лф╗╢хИЫх╗║ф╜┐чФи aeCreateFileEvent хЗ╜цХ░ч▒╗ф╝╝я╝М<strong>цЧ╢щЧ┤ф║Лф╗╢чЪДхИЫх╗║хЗ╜цХ░цШп aeCreateTimeEvent хЗ╜цХ░</strong>уАВш┐Щф╕кхЗ╜цХ░чЪДхОЯхЮЛхоЪф╣ЙхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token function">aeCreateTimeEvent</span><span class="token punctuation">(</span>aeEventLoop <span class="token operator">*</span>eventLoop<span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token keyword">long</span> milliseconds<span class="token punctuation">,</span> aeTimeProc <span class="token operator">*</span>proc<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>clientData<span class="token punctuation">,</span> aeEventFinalizerProc <span class="token operator">*</span>finalizerProc<span class="token punctuation">)</span>
</code></pre></div><p>хЬихоГчЪДхПВцХ░ф╕ня╝МцЬЙф╕дф╕кщЬАшжБцИСф╗мщЗНчВ╣ф║Жшзгф╕Ля╝Мф╗еф╛┐ф║ОцИСф╗мчРЖшзгцЧ╢щЧ┤ф║Лф╗╢чЪДхдДчРЖуАВ</p> <ul><li>ф╕Аф╕кцШп<strong>milliseconds</strong>я╝Мш┐ЩцШпцЙАхИЫх╗║цЧ╢щЧ┤ф║Лф╗╢чЪДшзжхПСцЧ╢щЧ┤ш╖Эчж╗х╜УхЙНцЧ╢щЧ┤чЪДцЧ╢щХ┐я╝МцШпчФицплчзТшбичд║чЪДуАВ</li> <li>хПжф╕Аф╕кцШп***proc**я╝Мш┐ЩцШпцЙАхИЫх╗║цЧ╢щЧ┤ф║Лф╗╢шзжхПСхРОчЪД<strong>хЫЮш░ГхЗ╜цХ░</strong>уАВ</li></ul> <p>aeCreateTimeEvent хЗ╜цХ░чЪДцЙзшбМщА╗ш╛Сф╕НхдНцЭВя╝Мф╕╗шжБх░▒цШпхИЫх╗║ф╕Аф╕кцЧ╢щЧ┤ф║Лф╗╢чЪД<strong>хПШщЗП te</strong>я╝Мхп╣хоГш┐ЫшбМхИЭхзЛхМЦя╝Мх╣╢цККхоГцПТхЕехИ░цбЖцЮ╢х╛кчОпц╡БчиЛч╗УцЮДф╜У eventLoop ф╕нчЪДцЧ╢щЧ┤ф║Лф╗╢щУ╛шбиф╕нуАВхЬиш┐Щф╕кш┐ЗчиЛф╕ня╝МaeCreateTimeEvent хЗ╜цХ░ф╝Ъ<strong>ш░ГчФи aeAddMillisecondsToNow хЗ╜цХ░</strong>я╝Мца╣цНоф╝ахЕечЪД milliseconds хПВцХ░я╝МшобчоЧцЙАхИЫх╗║цЧ╢щЧ┤ф║Лф╗╢хЕ╖ф╜УчЪДшзжхПСцЧ╢щЧ┤цИ│я╝Мх╣╢ш╡ЛхА╝ч╗Щ teуАВ</p> <p>хоЮщЩЕф╕Кя╝МRedis server хЬихИЭхзЛхМЦцЧ╢я╝МщЩдф║ЖхИЫх╗║чЫСхРмчЪД IO ф║Лф╗╢хдЦя╝Мф╣Яф╝Ъш░ГчФи aeCreateTimeEvent хЗ╜цХ░хИЫх╗║цЧ╢щЧ┤ф║Лф╗╢уАВф╕ЛщЭвф╗гчаБцШ╛чд║ф║Ж initServer хЗ╜цХ░хп╣ aeCreateTimeEvent хЗ╜цХ░чЪДш░ГчФия╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token function">initServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    тАж
    <span class="token comment">//хИЫх╗║цЧ╢щЧ┤ф║Лф╗╢</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">aeCreateTimeEvent</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> serverCron<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> AE_ERR<span class="token punctuation">)</span><span class="token punctuation">{</span>
    тАж <span class="token comment">//цКещФЩф┐бцБп</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ф╗Оф╗гчаБф╕ня╝МцИСф╗мхПпф╗ечЬЛхИ░я╝М<strong>цЧ╢щЧ┤ф║Лф╗╢шзжхПСхРОчЪДхЫЮш░ГхЗ╜цХ░цШп serverCron</strong>уАВцЙАф╗ецОеф╕ЛцЭея╝МцИСф╗мх░▒цЭеф║Жшзгф╕Л serverCron хЗ╜цХ░уАВ</p> <h3 id="цЧ╢щЧ┤ф║Лф╗╢хЫЮш░ГхЗ╜цХ░"><a href="#цЧ╢щЧ┤ф║Лф╗╢хЫЮш░ГхЗ╜цХ░" class="header-anchor">#</a> цЧ╢щЧ┤ф║Лф╗╢хЫЮш░ГхЗ╜цХ░</h3> <p>serverCron хЗ╜цХ░цШпхЬи server.c цЦЗф╗╢ф╕нхоЮчО░чЪДуАВ<strong>ф╕АцЦ╣щЭв</strong>я╝МхоГф╝Ъщб║х║Пш░ГчФиф╕Аф║ЫхЗ╜цХ░я╝МцЭехоЮчО░цЧ╢щЧ┤ф║Лф╗╢швлшзжхПСхРОя╝МцЙзшбМф╕Аф║ЫхРОхП░ф╗╗хКбуАВцпФхжВя╝МserverCron хЗ╜цХ░ф╝ЪцгАцЯецШпхРжцЬЙш┐ЫчиЛч╗УцЭЯф┐бхП╖я╝МшЛецЬЙх░▒цЙзшбМ server хЕ│щЧнцУНф╜ЬуАВserverCron ф╝Ъш░ГчФи databaseCron хЗ╜цХ░я╝МхдДчРЖш┐ЗцЬЯ key цИЦш┐ЫшбМ rehash чнЙуАВф╜ахПпф╗ехПВшАГф╕ЛщЭвч╗ЩхЗ║чЪДф╗гчаБя╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">//хжВцЮЬцФ╢хИ░ш┐ЫчиЛч╗УцЭЯф┐бхП╖я╝МхИЩцЙзшбМserverхЕ│щЧнцУНф╜Ь</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>shutdown_asap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">prepareForShutdown</span><span class="token punctuation">(</span>SHUTDOWN_NOFLAGS<span class="token punctuation">)</span> <span class="token operator">==</span> C_OK<span class="token punctuation">)</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token function">clientCron</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//цЙзшбМховцИ╖члпчЪДх╝ВцнецУНф╜Ь</span>
<span class="token function">databaseCron</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//цЙзшбМцХ░цНох║УчЪДхРОхП░цУНф╜Ь</span>
</code></pre></div><p><strong>хПжф╕АцЦ╣щЭв</strong>я╝МserverCron хЗ╜цХ░ш┐Шф╝Ъф╗еф╕НхРМчЪДщвСчОЗхСицЬЯцАзцЙзшбМф╕Аф║Ыф╗╗хКбя╝Мш┐ЩцШпщАЪш┐ЗцЙзшбМхоП run_with_period цЭехоЮчО░чЪДуАВ</p> <p>run<em>with_period хоПхоЪф╣ЙхжВф╕Ля╝МшпехоПхоЪф╣Йф╝Ъца╣цНо Redis хоЮф╛ЛщЕНч╜оцЦЗф╗╢ redis.conf ф╕нхоЪф╣ЙчЪД hz хА╝я╝МцЭехИдцЦнхПВцХ░_ms</em>шбичд║чЪДцЧ╢щЧ┤цИ│цШпхРжхИ░ш╛╛уАВф╕АцЧжхИ░ш╛╛я╝МserverCron х░▒хПпф╗ецЙзшбМчЫ╕х║ФчЪДф╗╗хКбф║ЖуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">run_with_period</span><span class="token expression"><span class="token punctuation">(</span>_ms_<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>_ms_ <span class="token operator">&lt;=</span> <span class="token number">1000</span><span class="token operator">/</span>server<span class="token punctuation">.</span>hz<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>cronloops<span class="token operator">%</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_ms_<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token operator">/</span>server<span class="token punctuation">.</span>hz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
</code></pre></div><p>цпФхжВя╝МserverCron хЗ╜цХ░ф╕нф╝Ъф╗е 1 чзТ 1 цмбчЪДщвСчОЗя╝МцгАцЯе AOF цЦЗф╗╢цШпхРжцЬЙхЖЩщФЩшппуАВхжВцЮЬцЬЙчЪДшпЭя╝МserverCron х░▒ф╝Ъш░ГчФи flushAppendOnlyFile хЗ╜цХ░я╝МхЖНцмбхИ╖хЫЮ AOF цЦЗф╗╢чЪДч╝УхнШцХ░цНоуАВф╕ЛщЭвчЪДф╗гчаБх▒Хчд║ф║Жш┐Щф╕АхСицЬЯцАзф╗╗хКбя╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token function">serverCron</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   тАж
   <span class="token comment">//цпП1чзТцЙзшбМ1цмбя╝МцгАцЯеAOFцШпхРжцЬЙхЖЩщФЩшпп</span>
   <span class="token function">run_with_period</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_last_write_status <span class="token operator">==</span> C_ERR<span class="token punctuation">)</span>
            <span class="token function">flushAppendOnlyFile</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   тАж
<span class="token punctuation">}</span>
</code></pre></div><p>хжВцЮЬф╜ацГ│ф║ЖшзгцЫ┤хдЪчЪДхСицЬЯцАзф╗╗хКбя╝МхПпф╗ехЖНшпжч╗ЖщШЕшп╗ф╕Л serverCron хЗ╜цХ░ф╕ня╝Мф╗е run_with_period хоПхоЪф╣ЙхМЕхРлчЪДф╗гчаБхЭЧуАВ</p> <p>хе╜ф║Жя╝Мф║Жшзгф║ЖцЧ╢щЧ┤ф║Лф╗╢шзжхПСхРОчЪДхЫЮш░ГхЗ╜цХ░ serverCronя╝МцИСф╗мцЬАхРОцЭечЬЛф╕Ля╝МцЧ╢щЧ┤ф║Лф╗╢цШпхжВф╜ХшзжхПСхдДчРЖчЪДуАВ</p> <h3 id="цЧ╢щЧ┤ф║Лф╗╢чЪДшзжхПСхдДчРЖ"><a href="#цЧ╢щЧ┤ф║Лф╗╢чЪДшзжхПСхдДчРЖ" class="header-anchor">#</a> цЧ╢щЧ┤ф║Лф╗╢чЪДшзжхПСхдДчРЖ</h3> <p>хЕ╢хоЮя╝МцЧ╢щЧ┤ф║Лф╗╢чЪДцгАц╡ЛшзжхПСцпФш╛ГчоАхНХя╝Мф║Лф╗╢щй▒хКицбЖцЮ╢чЪД aeMain хЗ╜цХ░ф╝Ъх╛кчОпш░ГчФи aeProcessEvents хЗ╜цХ░я╝МцЭехдДчРЖхРДчзНф║Лф╗╢уАВшАМ aeProcessEvents хЗ╜цХ░хЬицЙзшбМц╡БчиЛчЪДцЬАхРОя╝Мф╝Ъ<strong>ш░ГчФи processTimeEvents хЗ╜цХ░хдДчРЖчЫ╕х║ФхИ░цЧ╢чЪДф╗╗хКб</strong>уАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token function">aeProcessEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    тАж
    <span class="token comment">//цгАц╡ЛцЧ╢щЧ┤ф║Лф╗╢цШпхРжшзжхПС</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> AE_TIME_EVENTS<span class="token punctuation">)</span>
            processed <span class="token operator">+=</span> <span class="token function">processTimeEvents</span><span class="token punctuation">(</span>eventLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    тАж
<span class="token punctuation">}</span>
</code></pre></div><p>щВгф╣Ия╝МхЕ╖ф╜УхИ░ proecessTimeEvent хЗ╜цХ░цЭешп┤я╝МхоГчЪДхЯ║цЬмц╡БчиЛх░▒цШпф╗ОцЧ╢щЧ┤ф║Лф╗╢щУ╛шбиф╕КщАРф╕АхПЦхЗ║цпПф╕Аф╕кф║Лф╗╢я╝МчД╢хРОца╣цНох╜УхЙНцЧ╢щЧ┤хИдцЦншпеф║Лф╗╢чЪДшзжхПСцЧ╢щЧ┤цИ│цШпхРжх╖▓ц╗бш╢│уАВхжВцЮЬх╖▓ц╗бш╢│я╝МщВгф╣Их░▒ш░ГчФишпеф║Лф╗╢хп╣х║ФчЪДхЫЮш░ГхЗ╜цХ░ш┐ЫшбМхдДчРЖуАВш┐Щца╖ф╕АцЭея╝МхСицЬЯцАзф╗╗хКбх░▒шГ╜хЬиф╕НцЦнх╛кчОпцЙзшбМчЪД aeProcessEvents хЗ╜цХ░ф╕ня╝Мх╛ЧхИ░цЙзшбМф║ЖуАВ</p> <p>ф╕ЛщЭвчЪДф╗гчаБцШ╛чд║ф║Ж processTimeEvents хЗ╜цХ░чЪДхЯ║цЬмц╡БчиЛя╝Мф╜ахПпф╗ехЖНчЬЛф╕ЛуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">processTimeEvents</span><span class="token punctuation">(</span>aeEventLoop <span class="token operator">*</span>eventLoop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    te <span class="token operator">=</span> eventLoop<span class="token operator">-&gt;</span>timeEventHead<span class="token punctuation">;</span>  <span class="token comment">//ф╗ОцЧ╢щЧ┤ф║Лф╗╢щУ╛шбиф╕нхПЦхЗ║ф║Лф╗╢</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>te<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token function">aeGetTime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>now_sec<span class="token punctuation">,</span> <span class="token operator">&amp;</span>now_ms<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//шО╖хПЦх╜УхЙНцЧ╢щЧ┤</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>now_sec <span class="token operator">&gt;</span> te<span class="token operator">-&gt;</span>when_sec <span class="token operator">||</span> <span class="token punctuation">(</span>now_sec <span class="token operator">==</span> te<span class="token operator">-&gt;</span>when_sec <span class="token operator">&amp;&amp;</span> now_ms <span class="token operator">&gt;=</span> te<span class="token operator">-&gt;</span>when_ms<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">//хжВцЮЬх╜УхЙНцЧ╢щЧ┤х╖▓ч╗Пц╗бш╢│х╜УхЙНф║Лф╗╢чЪДшзжхПСцЧ╢щЧ┤цИ│</span>
      <span class="token punctuation">{</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        retval <span class="token operator">=</span> te<span class="token operator">-&gt;</span><span class="token function">timeProc</span><span class="token punctuation">(</span>eventLoop<span class="token punctuation">,</span> id<span class="token punctuation">,</span> te<span class="token operator">-&gt;</span>clientData<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//ш░ГчФиц│ихЖМчЪДхЫЮш░ГхЗ╜цХ░хдДчРЖ</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token punctuation">}</span>
      te <span class="token operator">=</span> te<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>   <span class="token comment">//шО╖хПЦф╕Лф╕Аф╕кцЧ╢щЧ┤ф║Лф╗╢</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="цА╗ч╗У"><a href="#цА╗ч╗У" class="header-anchor">#</a> цА╗ч╗У</h2> <p>хп╣ф║О IO ф║Лф╗╢цЭешп┤я╝МхоГхПпф╗еш┐Ыф╕АцнехИЖцИРхПпшп╗уАБхПпхЖЩхТМх▒ПщЪЬф║Лф╗╢уАВхЫаф╕║хПпшп╗уАБхПпхЖЩф║Лф╗╢хЬи Redis хТМховцИ╖члпщАЪф┐бхдДчРЖшп╖ц▒Вш┐ЗчиЛф╕нф╜┐чФих╣┐ц│Ыя╝МцЙАф╗ецЬмшКВцИСф╗мщЗНчВ╣хнжф╣аф║Жш┐Щф╕дчзН IO ф║Лф╗╢уАВх╜У Redis server хИЫх╗║ Socket хРОя╝Мх░▒ф╝Ъц│ихЖМхПпшп╗ф║Лф╗╢я╝Мх╣╢ф╜┐чФи acceptTCPHandler хЫЮш░ГхЗ╜цХ░хдДчРЖховцИ╖члпчЪДш┐ЮцОешп╖ц▒ВуАВ</p> <p>х╜У server хТМховцИ╖члпхоМцИРш┐ЮцОех╗║члЛхРОя╝Мserver ф╝ЪхЬих╖▓ш┐ЮцОехеЧцОехнЧф╕КчЫСхРмхПпшп╗ф║Лф╗╢я╝Мх╣╢ф╜┐чФи readQueryFromClient хЗ╜цХ░хдДчРЖховцИ╖члпшп╗хЖЩшп╖ц▒ВуАВш┐ЩщЗМя╝Мф╜ащЬАшжБхЖНц│ицДПф╕Ля╝М<strong>цЧашо║ховцИ╖члпхПСщАБчЪДшп╖ц▒ВцШпшп╗цИЦхЖЩцУНф╜Ья╝Мхп╣ф║О server цЭешп┤я╝МщГ╜цШпшжБшп╗хПЦховцИ╖члпчЪДшп╖ц▒Вх╣╢шзгцЮРхдДчРЖ</strong>уАВцЙАф╗ея╝Мserver хЬиховцИ╖члпчЪДх╖▓ш┐ЮцОехеЧцОехнЧф╕Кц│ихЖМчЪДцШпхПпшп╗ф║Лф╗╢уАВ</p> <p>шАМх╜УхоЮф╛ЛщЬАшжБхРСховцИ╖члпхЖЩхЫЮцХ░цНоцЧ╢я╝МхоЮф╛Лф╝ЪхЬиф║Лф╗╢щй▒хКицбЖцЮ╢ф╕нц│ихЖМхПпхЖЩф║Лф╗╢я╝Мх╣╢ф╜┐чФи sendReplyToClient ф╜Ьф╕║хЫЮш░ГхЗ╜цХ░я╝Мх░Жч╝УхЖ▓хМ║ф╕нцХ░цНохЖЩхЫЮховцИ╖члпуАВцИСцА╗ч╗Уф║Жф╕Ах╝ашбица╝я╝Мф╗еф╛┐ф╜ахЖНхЫЮщб╛ф╕Л IO ф║Лф╗╢хТМчЫ╕х║ФхеЧцОехнЧуАБхЫЮш░ГхЗ╜цХ░чЪДхп╣х║ФхЕ│ч│╗уАВ</p> <p>чД╢хРОя╝Мхп╣ф║ОцЧ╢щЧ┤ф║Лф╗╢цЭешп┤я╝МхоГф╕╗шжБцШпчФиф║ОхЬиф║Лф╗╢щй▒хКицбЖцЮ╢ф╕нц│ихЖМф╕Аф║ЫхСицЬЯцАзцЙзшбМчЪДф╗╗хКбя╝Мф╗еф╛┐ Redis server ш┐ЫшбМхРОхП░хдДчРЖуАВцЧ╢щЧ┤ф║Лф╗╢чЪДхЫЮш░ГхЗ╜цХ░цШп serverCron хЗ╜цХ░я╝Мф╜ахПпф╗ехБЪш┐Ыф╕АцнещШЕшп╗ф║ЖшзгхЕ╢ф╕нчЪДхЕ╖ф╜Уф╗╗хКбуАВ</p> <p>хе╜ф║Жя╝Мф╗Очмм 9 шо▓х╝АхзЛя╝МцИСчФиф║Ж 3 шКВшп╛я╝МхРСф╜аф╗Лч╗Н Redis ф║Лф╗╢щй▒хКицбЖцЮ╢чЪДш┐РшбМцЬ║хИ╢я╝МцЬмш┤иф╕КцЭешп┤я╝Мф║Лф╗╢щй▒хКицбЖцЮ╢цШпхЯ║ф║ОцУНф╜Ьч│╗ч╗ЯцПРф╛ЫчЪД IO хдЪш╖пхдНчФицЬ║хИ╢ш┐ЫшбМф║Жх░БшгЕя╝Мх╣╢хКаф╕Кф║ЖцЧ╢щЧ┤ф║Лф╗╢чЪДхдДчРЖуАВш┐ЩцШпф╕Аф╕кщЭЮх╕╕ч╗ПхЕ╕чЪДф║Лф╗╢цбЖцЮ╢хоЮчО░я╝МцИСх╕МцЬЫф╜ахПпф╗ехнжф╣ах╣╢цОМцПбхе╜хоГя╝МчД╢хРОчФихЬиф╜ашЗкх╖▒чЪДч│╗ч╗Ях╝АхПСф╕нуАВ</p> <h2 id="хПВшАГцЦЗчМо"><a href="#хПВшАГцЦЗчМо" class="header-anchor">#</a> хПВшАГцЦЗчМо</h2> <p><a href="https://time.geekbang.org/column/intro/100084301?utm_campaign=geektime_search&amp;utm_content=geektime_search&amp;utm_medium=geektime_search&amp;utm_source=geektime_search&amp;utm_term=geektime_search" target="_blank" rel="noopener noreferrer">Redis ц║РчаБхЙЦцЮРф╕ОхоЮцИШ<em>Redis_Redis ц║РчаБ</em>цХ░цНоч╗УцЮД<em>ф╕╗ф╗ОхдНхИ╢</em>ч╝УхнШ<em>щЫЖч╛д</em>хИЖх╕Гх╝ПцХ░цНох║У<em>щФохА╝цХ░цНох║У</em>ф║Лф╗╢щй▒хКицбЖцЮ╢-цЮБховцЧ╢щЧ┤ (geekbang.org)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://book.douban.com/subject/25900156/" target="_blank" rel="noopener noreferrer">Redis шо╛шобф╕ОхоЮчО░ (ш▒ЖчУг) (douban.com)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/echo-lxy/echo-system-design/edit/master/docs/Redis ч│╗ч╗Яшо╛шоб/03.ф╕╗ч║┐/08.ц╖▒хЕе Redis ф║Лф╗╢щй▒хКицбЖцЮ╢.md" target="_blank" rel="noopener noreferrer">ч╝Цш╛С</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">ф╕КцмбцЫ┤цЦ░ф║О:</span> <span class="time">2024/09/16, 13:27:00</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        тЖР
        <a href="/pages/d6b00d/" class="prev">Redis чЪД Reactor цибхЮЛ</a></span> <span class="next"><a href="/pages/e6d8ef/">Redis чЪДцЙзшбМцибх╝П</a>тЖТ
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:lixinyang2002@163.com" title="хПСщВоф╗╢" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/echo-lxy" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="хРмщЯ│ф╣Р" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="цЬмчлЩф╕╗щвШ">Vdoing</a> 
    | Copyright ┬й 2024-2024
    <span>Xinyang Li | MIT License</span></div> <div class="buttons"><div title="ш┐ФхЫЮщб╢щГи" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="хО╗шпДшо║" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ф╕╗щвШцибх╝П" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          ш╖ЯщЪПч│╗ч╗Я
        </li><li class="iconfont icon-rijianmoshi">
          ц╡ЕшЙ▓цибх╝П
        </li><li class="iconfont icon-yejianmoshi">
          ц╖▒шЙ▓цибх╝П
        </li><li class="iconfont icon-yuedu">
          щШЕшп╗цибх╝П
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.f1bdf1ca.js" defer></script><script src="/assets/js/2.933750c6.js" defer></script><script src="/assets/js/47.f3a2643a.js" defer></script><script src="/assets/js/7.7eb70372.js" defer></script>
  </body>
</html>
