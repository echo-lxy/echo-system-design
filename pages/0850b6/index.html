<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Redis хдЪIOч║┐чиЛ | EchoDesign</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="ч│╗ч╗Яшо╛шобф╣ЛуАМшо▓шзг + щЭвшпХцМЗхНЧуАНя╝Мц░┤ц╗┤чЯ│чй┐я╝Мшо╛шобцЧащУ╢х╝╣я╝Б">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.c76c3453.css" as="style"><link rel="preload" href="/assets/js/app.bdcc6820.js" as="script"><link rel="preload" href="/assets/js/2.933750c6.js" as="script"><link rel="preload" href="/assets/js/70.b920a5f7.js" as="script"><link rel="preload" href="/assets/js/7.7eb70372.js" as="script"><link rel="prefetch" href="/assets/js/10.2cc95be8.js"><link rel="prefetch" href="/assets/js/100.152e23f6.js"><link rel="prefetch" href="/assets/js/101.99b73fec.js"><link rel="prefetch" href="/assets/js/11.c7521a10.js"><link rel="prefetch" href="/assets/js/12.38d1989d.js"><link rel="prefetch" href="/assets/js/13.850793b0.js"><link rel="prefetch" href="/assets/js/14.1141ec27.js"><link rel="prefetch" href="/assets/js/15.8f1b4081.js"><link rel="prefetch" href="/assets/js/16.e52ba8b4.js"><link rel="prefetch" href="/assets/js/17.acb3bf3d.js"><link rel="prefetch" href="/assets/js/18.5df2a013.js"><link rel="prefetch" href="/assets/js/19.571eaed1.js"><link rel="prefetch" href="/assets/js/20.fe7d08c7.js"><link rel="prefetch" href="/assets/js/21.0e0ed140.js"><link rel="prefetch" href="/assets/js/22.dd779f94.js"><link rel="prefetch" href="/assets/js/23.4d814163.js"><link rel="prefetch" href="/assets/js/24.e94253bb.js"><link rel="prefetch" href="/assets/js/25.1d172890.js"><link rel="prefetch" href="/assets/js/26.6337eac0.js"><link rel="prefetch" href="/assets/js/27.eeee1d20.js"><link rel="prefetch" href="/assets/js/28.6fa848cf.js"><link rel="prefetch" href="/assets/js/29.4ff6fa35.js"><link rel="prefetch" href="/assets/js/3.08ee786a.js"><link rel="prefetch" href="/assets/js/30.892b2994.js"><link rel="prefetch" href="/assets/js/31.df4cc39d.js"><link rel="prefetch" href="/assets/js/32.f1174703.js"><link rel="prefetch" href="/assets/js/33.64ab8d0c.js"><link rel="prefetch" href="/assets/js/34.405ab364.js"><link rel="prefetch" href="/assets/js/35.8287c9dc.js"><link rel="prefetch" href="/assets/js/36.be98cc35.js"><link rel="prefetch" href="/assets/js/37.82be3556.js"><link rel="prefetch" href="/assets/js/38.40fe2658.js"><link rel="prefetch" href="/assets/js/39.6e2f31a6.js"><link rel="prefetch" href="/assets/js/4.73518a0f.js"><link rel="prefetch" href="/assets/js/40.0ada49bd.js"><link rel="prefetch" href="/assets/js/41.fcee3e0f.js"><link rel="prefetch" href="/assets/js/42.f5fdb401.js"><link rel="prefetch" href="/assets/js/43.5a509601.js"><link rel="prefetch" href="/assets/js/44.64fd3383.js"><link rel="prefetch" href="/assets/js/45.685623ac.js"><link rel="prefetch" href="/assets/js/46.7624d38c.js"><link rel="prefetch" href="/assets/js/47.cc86aae6.js"><link rel="prefetch" href="/assets/js/48.ba7dfd47.js"><link rel="prefetch" href="/assets/js/49.15d8e916.js"><link rel="prefetch" href="/assets/js/5.94727770.js"><link rel="prefetch" href="/assets/js/50.b424b2c0.js"><link rel="prefetch" href="/assets/js/51.ef213b56.js"><link rel="prefetch" href="/assets/js/52.24cc5c91.js"><link rel="prefetch" href="/assets/js/53.16def11d.js"><link rel="prefetch" href="/assets/js/54.8604fc24.js"><link rel="prefetch" href="/assets/js/55.78a9171b.js"><link rel="prefetch" href="/assets/js/56.94e28708.js"><link rel="prefetch" href="/assets/js/57.9f8a974b.js"><link rel="prefetch" href="/assets/js/58.24008d78.js"><link rel="prefetch" href="/assets/js/59.28ca51b4.js"><link rel="prefetch" href="/assets/js/6.0b558b79.js"><link rel="prefetch" href="/assets/js/60.1714dba8.js"><link rel="prefetch" href="/assets/js/61.08b4acf0.js"><link rel="prefetch" href="/assets/js/62.cc8fdced.js"><link rel="prefetch" href="/assets/js/63.41ff19e4.js"><link rel="prefetch" href="/assets/js/64.9b3def35.js"><link rel="prefetch" href="/assets/js/65.0b2ab47d.js"><link rel="prefetch" href="/assets/js/66.2ae7a107.js"><link rel="prefetch" href="/assets/js/67.79dd6daf.js"><link rel="prefetch" href="/assets/js/68.c27f5109.js"><link rel="prefetch" href="/assets/js/69.5f61d937.js"><link rel="prefetch" href="/assets/js/71.f44644ed.js"><link rel="prefetch" href="/assets/js/72.9a370df8.js"><link rel="prefetch" href="/assets/js/73.bc16a468.js"><link rel="prefetch" href="/assets/js/74.d9ad1a67.js"><link rel="prefetch" href="/assets/js/75.7c86d41a.js"><link rel="prefetch" href="/assets/js/76.15a7bb60.js"><link rel="prefetch" href="/assets/js/77.c89b4964.js"><link rel="prefetch" href="/assets/js/78.c0a4ffae.js"><link rel="prefetch" href="/assets/js/79.0906d2fb.js"><link rel="prefetch" href="/assets/js/8.0ec7f6e8.js"><link rel="prefetch" href="/assets/js/80.fdcb5fa1.js"><link rel="prefetch" href="/assets/js/81.711911b1.js"><link rel="prefetch" href="/assets/js/82.e54c087e.js"><link rel="prefetch" href="/assets/js/83.65db62ac.js"><link rel="prefetch" href="/assets/js/84.e5207e82.js"><link rel="prefetch" href="/assets/js/85.4cd3a775.js"><link rel="prefetch" href="/assets/js/86.931cbb70.js"><link rel="prefetch" href="/assets/js/87.47ba635a.js"><link rel="prefetch" href="/assets/js/88.93192130.js"><link rel="prefetch" href="/assets/js/89.e05e3a70.js"><link rel="prefetch" href="/assets/js/9.6e274fca.js"><link rel="prefetch" href="/assets/js/90.ca1ff100.js"><link rel="prefetch" href="/assets/js/91.8ad18b18.js"><link rel="prefetch" href="/assets/js/92.ec3a28ed.js"><link rel="prefetch" href="/assets/js/93.f8975bc4.js"><link rel="prefetch" href="/assets/js/94.1eade7f0.js"><link rel="prefetch" href="/assets/js/95.96f5db04.js"><link rel="prefetch" href="/assets/js/96.5ed2d348.js"><link rel="prefetch" href="/assets/js/97.4d4bfff5.js"><link rel="prefetch" href="/assets/js/98.18f62eb7.js"><link rel="prefetch" href="/assets/js/99.7d84cc97.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c76c3453.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="чЫох╜Х" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="EchoDesign" class="logo"> <span class="site-name can-hide">EchoDesign</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">ЁЯПащжЦщб╡</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">тЬТя╕ПчГнщЧичоЧц│Х</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕шо╛шоб" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕шо╛шоб</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ч│╗ч╗Яшо╛шоб</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">тЭУщЧочнФ</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ЁЯСАхКицАБ</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">ЁЯПащжЦщб╡</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">тЬТя╕ПчГнщЧичоЧц│Х</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕шо╛шоб" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕шо╛шоб</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ч│╗ч╗Яшо╛шоб</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">тЭУщЧочнФ</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ЁЯСАхКицАБ</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ф╕АуАБхЙНшиА</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ф║МуАБхЯ║чбАчЯешпЖ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>ф╕ЙуАБф╕╗ч║┐ф╗╗хКб</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/34fa27/" class="sidebar-link">Linux ф╕нчЪД IO хдЪш╖пхдНчФи</a></li><li><a href="/pages/d4ecb9/" class="sidebar-link">Redis Server хИЭхзЛхМЦ</a></li><li><a href="/pages/d6b00d/" class="sidebar-link">Redis чЪД Reactor цибхЮЛ</a></li><li><a href="/pages/264b06/" class="sidebar-link">ц╖▒хЕе Redis ф║Лф╗╢щй▒хКицбЖцЮ╢</a></li><li><a href="/pages/e6d8ef/" class="sidebar-link">Redis чЪДцЙзшбМцибх╝П</a></li><li><a href="/pages/0850b6/" aria-current="page" class="active sidebar-link">Redis хдЪIOч║┐чиЛ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/0850b6/#хЙНшиА" class="sidebar-link">хЙНшиА</a></li><li class="sidebar-sub-header level2"><a href="/pages/0850b6/#хНХч║┐чиЛ-io-хПКхЕ╢ч╝║щЩ╖" class="sidebar-link">хНХч║┐чиЛ IO хПКхЕ╢ч╝║щЩ╖</a></li><li class="sidebar-sub-header level2"><a href="/pages/0850b6/#redis-хдЪч║┐чиЛ-io-чЪДх╖еф╜ЬхОЯчРЖ" class="sidebar-link">Redis хдЪч║┐чиЛ IO чЪДх╖еф╜ЬхОЯчРЖ</a></li><li class="sidebar-sub-header level2"><a href="/pages/0850b6/#redis-хдЪч║┐чиЛ-io-ца╕х┐Гц║РчаБшзгцЮР" class="sidebar-link">Redis хдЪч║┐чиЛ IO ца╕х┐Гц║РчаБшзгцЮР</a></li><li class="sidebar-sub-header level2"><a href="/pages/0850b6/#redis-хдЪч║┐чиЛ-io-чЪДцАзшГ╜ш░Гф╝Шф╕ОхоЮщЩЕщЧощвШ" class="sidebar-link">Redis хдЪч║┐чиЛ IO чЪДцАзшГ╜ш░Гф╝Шф╕ОхоЮщЩЕщЧощвШ</a></li><li class="sidebar-sub-header level2"><a href="/pages/0850b6/#цА╗ч╗У" class="sidebar-link">цА╗ч╗У</a></li><li class="sidebar-sub-header level2"><a href="/pages/0850b6/#хПВшАГцЦЗчМо" class="sidebar-link">хПВшАГцЦЗчМо</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>хЫЫуАБцФпч║┐ф╗╗хКб</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ф║ФуАБщЫЖч╛д</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="щжЦщб╡" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>Redis ч│╗ч╗Яшо╛шоб</span></li><li data-v-06225672><span data-v-06225672>ф╕ЙуАБф╕╗ч║┐ф╗╗хКб</span></li></ul> <div class="info" data-v-06225672><div title="ф╜ЬшАЕ" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/brother-one" target="_blank" title="ф╜ЬшАЕ" class="beLink" data-v-06225672>echo</a></div> <div title="хИЫх╗║цЧ╢щЧ┤" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-09-17</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">чЫох╜Х</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">Redis хдЪIOч║┐чиЛ<!----></h1> <div class="page-slot page-slot-top">
    <div class="wwads-cn wwads-horizontal page-wwads" data-id="136"></div>
    <style>
      .page-wwads{
        width:100%!important;
        min-height: 0;
        margin: 0;
      }
      .page-wwads .wwads-img img{
        width:80px!important;
      }
      .page-wwads .wwads-poweredby{
        width: 40px;
        position: absolute;
        right: 25px;
        bottom: 3px;
      }
      .wwads-content .wwads-text, .page-wwads .wwads-text{
        height: 100%;
        padding-top: 5px;
        display: block;
      }
  </style>
  </div> <div class="theme-vdoing-content content__default"><div class="custom-block note"><p class="custom-block-title">цПРхЗ║щЧощвШцШпф╕АхИЗцЩ║цЕзчЪДх╝Ачлп</p> <ol><li>ф╕║ф╗Аф╣И Redis ф╗ОхНХч║┐чиЛц╝ФхПШхИ░хдЪч║┐чиЛя╝ЯхНХч║┐чиЛцибх╝ПчЪДчУ╢щвИхЬихУкщЗМя╝Я</li> <li>Redis 6.0 х╝ХхЕехдЪч║┐чиЛ IO чЪДф╕╗шжБхОЯчРЖцШпф╗Аф╣Ия╝ЯхоГхжВф╜ХцПРхНЗцАзшГ╜я╝Я</li> <li>хдЪч║┐чиЛ IO цШпхжВф╜ХхЬи Redis ф╕нхИЖцЛЕшп╗хЖЩф╗╗хКбчЪДя╝Яф╕ОхНХч║┐чиЛ IO цЬЙхУкф║ЫхЕ│щФохМ║хИля╝Я</li> <li>хЬи Redis 6.0 ф╕ня╝МхУкф║ЫцГЕхЖ╡ф╕ЛщАВхРИхРпчФихдЪч║┐чиЛ IOя╝Мч║┐чиЛцХ░шпехжВф╜ХщЕНч╜оя╝Я</li> <li>Redis хжВф╜ХхИйчФихдЪч║┐чиЛцЬ║хИ╢хИЖщЕНхТМхдДчРЖховцИ╖члпшп╖ц▒Вя╝ЯхЕ╖ф╜Уц╡БчиЛцШпцАОца╖чЪДя╝Я</li> <li>хдЪч║┐чиЛ IO хжВф╜ХшзгхЖ│хНХч║┐чиЛцибх╝Пф╕ЛчЪДцАзшГ╜чУ╢щвИя╝ЯцЬЙхУкф║ЫхЬ║цЩпф╕ЛцХИцЮЬцЬАцШ╛шСЧя╝Я</li> <li>ф╗Аф╣ИцШп Redis хдЪч║┐чиЛ IO чЪДф╕╗шжБцАзшГ╜ф╝ШхМЦчВ╣я╝ЯхжВф╜ХщБ┐хЕНц╜ЬхЬичЪДщЧощвШя╝Я</li> <li>хдЪ IO ч║┐чиЛхп╣ Redis хС╜ф╗дцЙзшбМчЪДх╜▒хУНцЬЙхУкф║Ыя╝ЯцШпхРжф╝Ъх╕жцЭецЦ░чЪДх╣╢хПСцМСцИШя╝Я</li></ol></div> <h2 id="хЙНшиА"><a href="#хЙНшиА" class="header-anchor">#</a> хЙНшиА</h2> <p>хдНцЭВчЪДцЮ╢цЮДч│╗ч╗ЯщАЪх╕╕цШпщАРц╕Рц╝Фш┐ЫчЪДя╝Мф╗ОхНХч║┐чиЛхИ░хдЪч║┐чиЛя╝Мф╗ОхНХф╜Ух║ФчФихИ░хдНцЭВхКЯшГ╜чЪДхИЖх╕Гх╝Пч│╗ч╗Яя╝МRedis ф╣Яч╗ПхОЖф║Жч▒╗ф╝╝чЪДхПСх▒ХхОЖчиЛуАВ</p> <p>хЬихНХч║┐чиЛцибх╝Пф╕Ля╝МRedis шГ╜хдЯхоЮчО░цЮБщлШчЪДхРЮхРРщЗПя╝Мф╜ЖхЬицЯРф║ЫцГЕхЖ╡ф╕Ля╝МхдДчРЖцЧ╢щЧ┤хПпшГ╜ф╝ЪцШ╛шСЧхвЮхКая╝Мхп╝шЗ┤цАзшГ╜ф╕ЛщЩНуАВф╕║ф║ЖшзгхЖ│ш┐Щф║ЫщЧощвШя╝МRedis х╝ХхЕеф║ЖхРОхП░ч║┐чиЛцЭехдДчРЖф╕Аф║ЫшАЧцЧ╢чЪДцУНф╜ЬуАВщЪПчЭАхп╣цЫ┤щлШхРЮхРРщЗПчЪДщЬАц▒ВхвЮхКая╝Мч╜Сч╗ЬцибхЭЧф╣ЯцИРф╕║чУ╢щвИя╝МхЫацнд Redis хЬи 6.0 чЙИцЬмф╕нх╝ХхЕеф║ЖхдЪч║┐чиЛцЭешзгхЖ│ш┐Щф╕кщЧощвШтАФтАФш┐Щф╣ЯцШпцЬмцЦЗф╕╗шжБцОвшоичЪДхЖЕхо╣уАВ</p> <p>цЬмцЦЗхЖЕхо╣хМЕцЛмя╝Ъ</p> <ol><li>цЧйцЬЯхНХч║┐чиЛ IO хдДчРЖш┐ЗчиЛхПКхЕ╢ч╝║чВ╣</li> <li>Redis хдЪч║┐чиЛ IO чЪДх╖еф╜ЬхОЯчРЖ</li> <li>Redis хдЪч║┐чиЛ IO ца╕х┐Гц║РчаБшзгцЮР</li></ol> <div class="custom-block warning"><p class="custom-block-title">ц│ицДП</p> <p>шп╖ф╕Лш╜╜ <a href="https://github.com/redis/redis/tree/6.0" target="_blank" rel="noopener noreferrer">Redis 6.0.15<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> чЪДц║РчаБя╝Мф╗еф╛┐цЯечЬЛф╕ОхдЪ IO ч║┐чиЛцЬ║хИ╢чЫ╕хЕ│чЪДф╗гчаБуАВ</p></div> <h2 id="хНХч║┐чиЛ-io-хПКхЕ╢ч╝║щЩ╖"><a href="#хНХч║┐чиЛ-io-хПКхЕ╢ч╝║щЩ╖" class="header-anchor">#</a> хНХч║┐чиЛ IO хПКхЕ╢ч╝║щЩ╖</h2> <h3 id="х╝ВцнехдДчРЖ"><a href="#х╝ВцнехдДчРЖ" class="header-anchor">#</a> х╝ВцнехдДчРЖ</h3> <p>Redis чЪДца╕х┐Гш┤Яш╜╜чФ▒хНХч║┐чиЛхдДчРЖя╝Мф╜Жф╕║ф╜ХхЕ╢цАзшГ╜ф╗НшГ╜хжВцндф╝Шх╝Вя╝Я</p> <ul><li><strong>ч║пхЖЕхнШцУНф╜Ь</strong>я╝ЪRedis чЪДцУНф╜ЬхдзхдЪхЬихЖЕхнШф╕нхоМцИРуАВ</li> <li><strong>щЭЮщШ╗хбЮ IO</strong>я╝ЪRedis ф╜┐чФищЭЮщШ╗хбЮчЪД IO цЬ║хИ╢уАВ</li> <li><strong>х╝Вцне IO хдДчРЖ</strong>я╝ЪцпПф╕кхС╜ф╗дхЬицОецФ╢уАБхдДчРЖхТМш┐ФхЫЮчЪДш┐ЗчиЛф╕ня╝Мч╗Пш┐ЗхдЪф╕ктАЬф╕Нш┐Юч╗нтАЭчЪДцнещкдуАВ</li></ul> <blockquote><p>щЬАшжБчЙ╣хИлцМЗхЗ║чЪДцШпя╝МцндхдДчЪДтАЬх╝ВцнехдДчРЖтАЭх╣╢щЭЮцМЗхРМцне/х╝Вцне IOя╝МшАМцШпцМЗ IO хдДчРЖш┐ЗчиЛчЪДх╝ВцнехМЦя╝МхН│хРДф╕кхдДчРЖцнещкдф╣ЛщЧ┤ф╕НцШпхРМцнецЙзшбМчЪДя╝МшАМцШпщАЪш┐Зф║Лф╗╢х╛кчОпцЬ║хИ╢хТМщЭЮщШ╗хбЮ IOя╝Мф╜┐ Redis шГ╜хЬихНХч║┐чиЛчОпхвГф╕ЛщлШцХИхдДчРЖхдЪф╕кшп╖ц▒ВуАВ</p></blockquote> <p>хБЗшо╛ховцИ╖члпхПСщАБф╗еф╕ЛхС╜ф╗дя╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code>GET key<span class="token operator">-</span>how<span class="token operator">-</span>to<span class="token operator">-</span>be<span class="token operator">-</span>a<span class="token operator">-</span>better<span class="token operator">-</span>man
</code></pre></div><p>Redis чЪДхЫЮх║ФцШпя╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code>хКкхКЫхКацККхК▓цККцЦЗчлахЖЩхоМ
</code></pre></div><p>хдДчРЖш┐Щф╕кхС╜ф╗дчЪДш┐ЗчиЛхМЕцЛмф╗еф╕ЛхЗаф╕кцнещкдя╝Ъ</p> <ul><li><strong>цОецФ╢</strong>я╝ЪщАЪш┐З TCP цОецФ╢хС╜ф╗дя╝МхПпшГ╜ч╗ПхОЖхдЪцмб TCP хМЕуАБчбошодх║ФчнФ (ack) хТМ IO цУНф╜ЬуАВ</li> <li><strong>шзгцЮР</strong>я╝Ъф╗ОцОецФ╢хИ░чЪДцХ░цНоф╕нцПРхПЦхС╜ф╗дуАВ</li> <li><strong>цЙзшбМ</strong>я╝Ъшп╗хПЦцМЗхоЪф╜Нч╜очЪДхА╝уАВ</li> <li><strong>ш┐ФхЫЮ</strong>я╝ЪщАЪш┐З TCP ш┐ФхЫЮхА╝ч╗ЩховцИ╖члпуАВхжВцЮЬхА╝ш╛Гхдзя╝МIO ш┤Яш╜╜ф╣ЯцЫ┤щЗНуАВ</li></ul> <p>хЕ╢ф╕ня╝МшзгцЮРхТМцЙзшбМцнещкдф╕╗шжБцШп CPU хТМхЖЕхнШцУНф╜Ья╝МшАМцОецФ╢хТМш┐ФхЫЮф╕╗шжБц╢ЙхПК IO цУНф╜Ья╝Мш┐ЩцШпцИСф╗мхЕ│ц│ичЪДщЗНчВ╣уАВф╗ецОецФ╢ф╕║ф╛Ля╝МRedis щЗЗчФиф║Жф╕дчзНчнЦчХея╝Ъ</p> <ul><li><strong>хРМцнехдДчРЖ</strong>я╝ЪхЬицОецФ╢хоМцХ┤хС╜ф╗дф╣ЛхЙНя╝МхзЛч╗Иф┐ЭцМБчнЙх╛ЕчК╢цАБя╝МцОецФ╢хИ░хоМцХ┤хС╜ф╗дхРОцЙНш┐ЫшбМхдДчРЖя╝МчД╢хРОш┐ФхЫЮч╗УцЮЬуАВхЬич╜Сч╗ЬчК╢хЖ╡ф╕Нф╜│цЧ╢я╝Мш┐ЩчзНцЦ╣ц│ХхПпшГ╜ф╝Ъхп╝шЗ┤ш╛ГщХ┐чЪДчнЙх╛ЕцЧ╢щЧ┤уАВ</li> <li><strong>х╝ВцнехдДчРЖ</strong>я╝ЪщАЪш┐ЗщЭЮщШ╗хбЮ IO хТМф║Лф╗╢х╛кчОпцЬ║хИ╢я╝МхЬихдДчРЖф╕Аф╕кшп╖ц▒ВцЧ╢я╝МRedis хПпф╗еч╗зч╗нхдДчРЖхЕ╢ф╗Цшп╖ц▒Вя╝Мф╗ОшАМщБ┐хЕНф║ЖщШ╗хбЮчнЙх╛ЕуАВRedis ф╜┐чФищлШцХИчЪДф║Лф╗╢щй▒хКицЬ║хИ╢я╝ИхжВ epollя╝ЙцЭечЫСцОз IO ф║Лф╗╢я╝Мф╗ОшАМцПРщлШхНХч║┐чиЛф╕ЛчЪДх╣╢хПСхдДчРЖшГ╜хКЫуАВ</li></ul> <p>ф╗еф╕ЛцШпхп╣х╝ВцнехдДчРЖчЪДч▒╗цпФя╝Ъ</p> <ul><li><strong>хРМцне</strong>я╝Ъх╜УшБКхдйцбЖцШ╛чд║тАЬцнгхЬиш╛УхЕетАЭцЧ╢я╝Мф╜ащЬАшжБчнЙхп╣цЦ╣ш╛УхЕехоМцИРхРОя╝МцЙНшГ╜хЫЮчнФхп╣цЦ╣чЪДщЧощвШуАВхоМцИРхЫЮчнФхРОя╝МцЙНф╝Ъш╜мхРСхЕ╢ф╗Цф║║уАВ</li> <li><strong>х╝Вцне</strong>я╝Ъх╜УшБКхдйцбЖцШ╛чд║тАЬцнгхЬиш╛УхЕетАЭцЧ╢я╝Мф╜ахПпф╗ехЫЮчнФхЕ╢ф╗Цх╖▓хоМцИРш╛УхЕечЪДщЧощвШя╝МшАМф╕Нх┐ЕчнЙхп╣цЦ╣ш╛УхЕехоМцИРя╝Мх╛Ехп╣цЦ╣ш╛УхЕехоМцИРхРОхЖНч╗зч╗нхЫЮчнФхЕ╢ф╗ЦщЧощвШуАВ</li></ul> <p>цШ╛чД╢я╝Мх╝ВцнехдДчРЖчЪДцХИчОЗцЫ┤щлШя╝МхЫаф╕║хРМцнехдДчРЖхЬичнЙх╛Еф╕Кц╡кш┤╣ф║ЖцЧ╢щЧ┤уАВх╝ВцнехдДчРЖчнЦчХецА╗ч╗УхжВф╕Ля╝Ъ</p> <ul><li>хЬич╜Сч╗ЬхМЕхИ░ш╛╛цЧ╢члЛхН│шп╗хПЦх╣╢цФ╛хЕеч╝УхЖ▓хМ║я╝Мшп╗хПЦхоМцИРхРОчлЛхН│ш┐ЫшбМхЕ╢ф╗ЦцУНф╜Ья╝МшАМф╕НчнЙх╛Еф╕Лф╕Аф╕кхМЕуАВ</li> <li>шзгцЮРч╝УхЖ▓хМ║ф╕нчЪДцХ░цНоцШпхРжхоМцХ┤уАВшЛецХ░цНохоМцХ┤я╝МхИЩцЙзшбМхС╜ф╗дя╝ЫшЛеф╕НхоМцХ┤я╝МхИЩч╗зч╗нхдДчРЖхЕ╢ф╗Цф╗╗хКбуАВ</li> <li>цХ░цНохоМцХ┤хРОчлЛхН│цЙзшбМхС╜ф╗дя╝Мх░Жч╗УцЮЬцФ╛хЕеч╝УхЖ▓хМ║уАВ</li> <li>х░ЖцХ░цНош┐ФхЫЮч╗ЩховцИ╖члпуАВхжВцЮЬф╕Ацмбф╕НшГ╜хЕищГихПСщАБя╝МхИЩчнЙхИ░хПпф╗ехПСщАБцЧ╢хЖНч╗зч╗нхПСщАБя╝МчЫ┤хИ░хЕищГихПСщАБхоМцпХуАВ</li></ul> <h3 id="ф║Лф╗╢щй▒хКи"><a href="#ф║Лф╗╢щй▒хКи" class="header-anchor">#</a> ф║Лф╗╢щй▒хКи</h3> <p>х░╜чобх╝ВцнехдДчРЖщБ┐хЕНф║ЖщЫ╢цХгчЪДчнЙх╛ЕцЧ╢щЧ┤я╝Мф╜ЖхжВф╜Хх╛ЧчЯетАЬч╜Сч╗ЬхМЕцЬЙцХ░цНотАЭцИЦтАЬф╕ЛцмбхПпф╗ехПСщАБцХ░цНотАЭхСвя╝ЯхжВцЮЬщАЪш┐Зш╜ошпвцгАцЯеш┐Щф║ЫцЧ╢цЬ║я╝МцХИчОЗф╝Ъх╛Иф╜ОуАВRedis ф╜┐чФиф║Лф╗╢щй▒хКицЬ║хИ╢цЭешзгхЖ│ш┐Щф╕АщЧощвШуАВ</p> <p>ф║Лф╗╢щй▒хКицбЖцЮ╢шГ╜хдЯщлШцХИхЬ░щАЪчЯе Redis хЬиф╜ХцЧ╢щЬАшжБхдДчРЖф║Лф╗╢уАВRedis щАЪш┐Зф║Лф╗╢щй▒хКицЬ║хИ╢я╝ИхжВ epollя╝ЙцЭечЫСхРмхТМхдДчРЖф║Лф╗╢уАВLinux ф╕нчЪД epoll цЬ║хИ╢ф╕Уф╕║щлШцХИщАЪчЯешАМшо╛шобуАВRedis хЯ║ф║О epoll чнЙцЬ║хИ╢цК╜ш▒бхЗ║ф║Жф╕АхеЧф║Лф╗╢щй▒хКицбЖцЮ╢я╝МцХ┤ф╕кцЬНхКбхЩичФ▒ф║Лф╗╢щй▒хКия╝Мх╜Уф║Лф╗╢хПСчФЯцЧ╢ш┐ЫшбМхдДчРЖя╝МцЧаф║Лф╗╢цЧ╢хИЩхдДф║Очй║щЧ▓чК╢цАБуАВ</p> <ul><li><strong><code>хПпшп╗</code>ф║Лф╗╢</strong>я╝Ъшбичд║хп╣х║ФчЪД socket ф╕нцЬЙцЦ░чЪД TCP цХ░цНохМЕхИ░ш╛╛уАВ</li> <li><strong><code>хПпхЖЩ</code>ф║Лф╗╢</strong>я╝Ъшбичд║хп╣х║ФчЪД socket чЪДхЖЩч╝УхЖ▓хМ║х╖▓ч╗Пчй║ф║Жя╝ИцХ░цНох╖▓щАЪш┐Зч╜Сч╗ЬхПСщАБч╗ЩховцИ╖члпя╝ЙуАВ</li></ul> <p>хдДчРЖц╡БчиЛхжВф╕Ля╝Ъ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409172227893.webp" alt="img"></p> <ul><li><code>aeMain()</code> хЖЕщГиф╕║ф╕Аф╕кцн╗х╛кчОпя╝МхЬи <code>epoll_wait</code> хдДчЯнцЪВф╝СчЬауАВ</li> <li><code>epoll_wait</code> ш┐ФхЫЮх╜УхЙНхПпшп╗уАБхПпхЖЩчЪД socket хИЧшбиуАВ</li> <li><code>beforeSleep</code> цШпш┐ЫхЕеф╝СчЬахЙНцЙзшбМчЪДщА╗ш╛Ся╝Мф╕╗шжБцШпх░ЖцХ░цНохЫЮхЖЩхИ░ socketуАВ</li> <li>ца╕х┐ГщА╗ш╛СчФ▒ IO ф║Лф╗╢шзжхПСя╝МхПпшГ╜цШпхПпшп╗ф║Лф╗╢я╝Мф╣ЯхПпшГ╜цШпхПпхЖЩф║Лф╗╢я╝МхРжхИЩцЙзшбМхоЪцЧ╢ф╗╗хКбуАВ</li> <li>чммф╕АцмбчЪД IO хПпшп╗ф║Лф╗╢цШпчЫСхРм socketя╝ИхжВчЫСхРм 6379 члпхПгя╝Йя╝Мх╜УцЬЙцПбцЙЛшп╖ц▒ВцЧ╢я╝МцЙзшбМ <code>accept</code> ш░ГчФия╝МшО╖хПЦф╕Аф╕кш┐ЮцОе socketя╝Мх╣╢ц│ихЖМхПпшп╗хЫЮш░Г <code>createClient</code>я╝МцндхРОховцИ╖члпф╕О Redis чЪДцХ░цНощАЪш┐Зшпе socket ш┐ЫшбМф╝аш╛УуАВ</li> <li>ф╕Аф╕кхоМцХ┤чЪДхС╜ф╗дхПпшГ╜щАЪш┐ЗхдЪцмб <code>readQueryFromClient</code> шп╗хПЦхоМцпХя╝МцДПхС│чЭАф╝ЪцЬЙхдЪцмбхПпшп╗ IO ф║Лф╗╢уАВ</li> <li>хС╜ф╗дцЙзшбМч╗УцЮЬф╣ЯхПпшГ╜щЬАшжБщАЪш┐ЗхдЪцмбхЖЩцУНф╜ЬхоМцИРуАВ</li> <li>хС╜ф╗дцЙзшбМхоМцпХхРОя╝Мхп╣х║ФчЪДш┐ЮцОеф╝ЪшвлхКахЕе <code>clients_pending_write</code>я╝М<code>beforeSleep</code> ф╝Ъх░ЭшпХхЫЮхЖЩхИ░ socketя╝МшЛехЖЩф╕НхоМхИЩц│ихЖМхПпхЖЩф║Лф╗╢я╝Мф╕Лцмбч╗зч╗нхЖЩуАВ</li> <li>цХ┤ф╕кш┐ЗчиЛф╕нчЪД IO хЕищГицШпхРМцнещЭЮщШ╗хбЮчЪДя╝Мц▓бцЬЙцЧ╢щЧ┤ц╡кш┤╣уАВ</li></ul> <h3 id="хНХч║┐чиЛ-io-чЪДчУ╢щвИ"><a href="#хНХч║┐чиЛ-io-чЪДчУ╢щвИ" class="header-anchor">#</a> хНХч║┐чиЛ IO чЪДчУ╢щвИ</h3> <p>х░╜чобхНХч║┐чиЛ IO хдДчРЖш┐ЗчиЛщБ┐хЕНф║ЖчнЙх╛ЕцЧ╢щЧ┤чЪДц╡кш┤╣я╝Мх╣╢шГ╜хоЮчО░ш╛ГщлШчЪД QPSя╝Мф╜Жф╗НчД╢хнШхЬиф╕Аф║ЫчУ╢щвИя╝Ъ</p> <ul><li><strong>ф╗Еф╜┐чФиф╕Аф╕к CPU ца╕х┐Г</strong>я╝Их┐╜чХехРОхП░ч║┐чиЛя╝ЙуАВ</li> <li>х╜УцХ░цНощЗПш╛ГхдзцЧ╢я╝МRedis чЪД QPS хПпшГ╜ф╝ЪцШ╛шСЧф╕ЛщЩНя╝МцЬЙцЧ╢ф╕Аф╕кхдзчЪД key ф╝ЪцЛЦхЮоцХ┤ф╕кч│╗ч╗ЯуАВ</li> <li>щЪ╛ф╗еш┐Ыф╕АцнецПРхНЗ QPSуАВ</li></ul> <p>Redis ф╕╗ч║┐чиЛчЪДцЧ╢щЧ┤ц╢ИшАЧф╕╗шжБщЫЖф╕нхЬиф╗еф╕Лф╕дф╕кцЦ╣щЭвя╝Ъ</p> <ul><li><strong>щА╗ш╛СшобчоЧц╢ИшАЧ</strong></li> <li><strong>хРМцне IO шп╗хЖЩц╢ИшАЧ</strong>я╝МхМЕцЛмцХ░цНоцЛ╖ш┤ЭчЪДц╢ИшАЧуАВ</li></ul> <p>х╜УцХ░цНощЗПш╛ГхдзцЧ╢я╝МчУ╢щвИф╕╗шжБхЗ║чО░хЬихРМцне IO ф╕Кя╝ИхБЗшо╛х╕жхо╜хТМхЖЕхнШхЕЕш╢│я╝ЙуАВф╕╗шжБчЪДц╢ИшАЧхМЕцЛмя╝Ъ</p> <ul><li>ф╗О socket ф╕ншп╗хПЦшп╖ц▒ВцХ░цНоцЧ╢я╝Мф╝Ъх░ЖцХ░цНоф╗ОхЖЕца╕цАБцЛ╖ш┤ЭхИ░чФицИ╖цАБя╝И<code>read</code> ш░ГчФия╝ЙуАВ</li> <li>х░ЖцХ░цНохЫЮхЖЩхИ░ socket цЧ╢я╝Мф╝Ъх░ЖцХ░цНоф╗ОчФицИ╖цАБцЛ╖ш┤ЭхИ░хЖЕца╕цАБя╝И<code>write</code> ш░ГчФия╝ЙуАВ</li></ul> <p>ш┐Щф║ЫцХ░цНошп╗хЖЩцУНф╜Ьф╝ЪхНачФихдзщЗП CPU цЧ╢щЧ┤я╝Мх╣╢чЫ┤цОехп╝шЗ┤цАзшГ╜чУ╢щвИуАВхжВцЮЬшГ╜щАЪш┐ЗхдЪч║┐чиЛцЭехИЖцЛЕш┐Щф║Ыц╢ИшАЧя╝МRedis чЪДхРЮхРРщЗПцЬЙцЬЫх╛ЧхИ░цШ╛шСЧцПРхНЗя╝Мш┐Щф╣ЯцШп Redis х╝ХхЕехдЪч║┐чиЛ IO чЪДф╕╗шжБчЫочЪДуАВ</p> <h2 id="redis-хдЪч║┐чиЛ-io-чЪДх╖еф╜ЬхОЯчРЖ"><a href="#redis-хдЪч║┐чиЛ-io-чЪДх╖еф╜ЬхОЯчРЖ" class="header-anchor">#</a> Redis хдЪч║┐чиЛ IO чЪДх╖еф╜ЬхОЯчРЖ</h2> <p>цОеф╕ЛцЭех░ЖчЫохЕЙцФ╛хИ░я╝Ъ хжВф╜ХчФихдЪч║┐чиЛхИЖцЛЕIOчЪДш┤ЯшН╖уАВхЕ╢хБЪц│ХчФичоАхНХчЪДшпЭцЭешп┤х░▒цШпя╝Ъ</p> <ul><li>чФиф╕Ач╗ДхНХчЛмчЪДч║┐чиЛф╕УщЧиш┐ЫшбМ read/write socketшп╗хЖЩш░ГчФи я╝ИхРМцнеIOя╝Й</li> <li>шп╗хЫЮш░ГхЗ╜цХ░ф╕нф╕НхЖНшп╗цХ░цНоя╝МшАМцШпх░Жхп╣х║ФчЪДш┐ЮцОеш┐╜хКахИ░хПпшп╗ clients_pending_read чЪДщУ╛шби</li> <li>ф╕╗ч║┐чиЛхЬи beforeSleep ф╕нх░ЖIOшп╗ф╗╗хКбхИЖч╗ЩIOч║┐чиЛч╗Д</li> <li>ф╕╗ч║┐чиЛшЗкх╖▒ф╣ЯхдДчРЖф╕Аф╕к IO шп╗ф╗╗хКбя╝Мх╣╢шЗкцЧЛх╝ПчнЙ IO ч║┐чиЛч╗ДхдДчРЖхоМя╝МхЖНч╗зч╗нх╛Аф╕Л</li> <li>ф╕╗ч║┐чиЛхЬи beforeSleep ф╕нх░Ж IO хЖЩф╗╗хКбхИЖч╗ЩIOч║┐чиЛч╗Д</li> <li>ф╕╗ч║┐чиЛшЗкх╖▒ф╣ЯхдДчРЖф╕Аф╕к IO хЖЩф╗╗хКбя╝Мх╣╢шЗкцЧЛх╝ПчнЙ IO ч║┐чиЛч╗ДхдДчРЖхоМя╝МхЖНч╗зч╗нх╛Аф╕Л</li> <li>IOч║┐чиЛч╗ДшжБф╣ИхРМцЧ╢хЬишп╗я╝МшжБф╣ИхРМцЧ╢хЬихЖЩ</li> <li>хС╜ф╗дчЪДцЙзшбМчФ▒ф╕╗ч║┐чиЛф╕▓шбМцЙзшбМя╝Иф┐ЭцМБхНХч║┐чиЛя╝Й</li> <li>IOч║┐чиЛцХ░щЗПхПпщЕНч╜о</li></ul> <p>хоМцХ┤ц╡БчиЛхЫ╛хжВф╕Ля╝Ъ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409172051604.webp" alt="img"></p> <p>beforesleep ф╕ня╝МхЕИшой IO ч║┐чиЛшп╗цХ░цНоя╝МчД╢хРОхЖНшой IO ч║┐чиЛхЖЩцХ░цНоуАВ шп╗хЖЩцЧ╢я╝МхдЪч║┐чиЛшГ╜х╣╢хПСцЙзшбМя╝МхИйчФихдЪца╕уАВ</p> <ol><li>х░Жшп╗ф╗╗хКбхЭЗхМАхИЖхПСхИ░хРДф╕кIOч║┐чиЛчЪДф╗╗хКбщУ╛шби io_threads_list[i]я╝Мх░Ж io_threads_pending[i] шо╛ч╜оф╕║хп╣х║ФчЪДф╗╗хКбцХ░я╝МцндцЧ╢ IO ч║┐чиЛх░Жф╗Оцн╗х╛кчОпф╕ншвлц┐Ац┤╗я╝Мх╝АхзЛцЙзшбМф╗╗хКбя╝МцЙзшбМхоМцпХхРОя╝Мф╝Ъх░Ж io_threads_pending[i] ц╕ЕщЫ╢уАВ хЗ╜цХ░хРНф╕║я╝Ъ handleClientsWithPendingReadsUsingThreads</li> <li>х░ЖхЖЩф╗╗хКбхЭЗхМАхИЖхПСхИ░хРДф╕кIOч║┐чиЛчЪДф╗╗хКбщУ╛шби io_threads_list[i]я╝Мх░Жio_threads_pending[i] шо╛ч╜оф╕║хп╣х║ФчЪДф╗╗хКбцХ░я╝МцндцЧ╢IOч║┐чиЛх░Жф╗Оцн╗х╛кчОпф╕ншвлц┐Ац┤╗я╝Мх╝АхзЛцЙзшбМф╗╗хКбя╝МцЙзшбМхоМцпХхРОя╝Мф╝Ъх░Ж io_threads_pending[i]ц╕ЕщЫ╢уАВ хЗ╜цХ░хРНф╕║я╝Ъ handleClientsWithPendingWritesUsingThreads</li> <li>beforeSleepф╕нф╕╗ч║┐чиЛф╣Яф╝ЪцЙзшбМхЕ╢ф╕нф╕Аф╕кф╗╗хКбя╝МцЙзшбМхоМхРОшЗкцЧЛчнЙх╛Е IO ч║┐чиЛхдДчРЖхоМуАВ</li> <li>шп╗ф╗╗хКбшжБф╣ИхЬи beforeSleep ф╕ншвлцЙзшбМя╝МшжБф╣ИхЬи IO ч║┐чиЛшвлцЙзшбМя╝Мф╕Нф╝ЪхЖНхЬишп╗хЫЮш░Гф╕нцЙзшбМ</li> <li>хЖЩф╗╗хКбф╝ЪхИЖцХгхИ░ beforeSleepуАБIOч║┐чиЛуАБхЖЩхЫЮш░Гф╕нцЙзшбМ</li> <li>ф╕╗ч║┐чиЛхТМ IO ч║┐чиЛф║дф║ТцШпцЧащФБчЪДя╝МщАЪш┐ЗцаЗх┐Чф╜Ншо╛ч╜ош┐ЫшбМя╝Мф╕Нф╝ЪхРМцЧ╢хЖЩф╗╗хКбщУ╛шби</li></ol> <h2 id="redis-хдЪч║┐чиЛ-io-ца╕х┐Гц║РчаБшзгцЮР"><a href="#redis-хдЪч║┐чиЛ-io-ца╕х┐Гц║РчаБшзгцЮР" class="header-anchor">#</a> Redis хдЪч║┐чиЛ IO ца╕х┐Гц║РчаБшзгцЮР</h2> <h3 id="_1уАБхИЭхзЛхМЦ-io-ч║┐чиЛ"><a href="#_1уАБхИЭхзЛхМЦ-io-ч║┐чиЛ" class="header-anchor">#</a> 1уАБхИЭхзЛхМЦ IO ч║┐чиЛ</h3> <p>хЬи <a href="">Redis чЪДцЙзшбМцибх╝П</a> ф╕нцПРхИ░я╝ЪRedis 5.0 чЙИцЬмф╕нчЪДф╕Йф╕кхРОхП░ч║┐чиЛцШпхЬи <code>server.c</code> цЦЗф╗╢чЪД <code>main</code> хЗ╜цХ░хРпхКичЪДцЬАхРОщШ╢цо╡ш░ГчФи <code>InitServerLast</code> хЗ╜цХ░цЭехИЭхзЛхМЦчЪДя╝МшАМ <code>InitServerLast</code> хЗ╜цХ░хИЩш┐Ыф╕Ацнеш░ГчФи <code>bioInit</code> хЗ╜цХ░цЭехоМцИРхИЭхзЛхМЦуАВ</p> <p>хЬи Redis 6.0 ф╕ня╝М<code>InitServerLast</code> хЗ╜цХ░хЬиш░ГчФи <code>bioInit</code> хРОя╝МцЦ░хвЮф║Жхп╣ <code>initThreadedIO</code> хЗ╜цХ░чЪДш░ГчФия╝Мф╗ехИЭхзЛхМЦхдЪч║┐чиЛ IO цЬ║хИ╢уАВ</p> <p><code>initThreadedIO</code> хЗ╜цХ░чФиф║ОхИЭхзЛхМЦхдЪ IO ч║┐чиЛя╝МхЕ╢ф╗гчаБхоЮчО░хжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// server.c#InitServerLast</span>
<span class="token keyword">void</span> <span class="token function">InitServerLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">bioInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">initThreadedIO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set_jemalloc_bg_thread</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>jemalloc_bg_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>initial_memory_usage <span class="token operator">=</span> <span class="token function">zmalloc_used_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p><code>bioInit</code> хЗ╜цХ░чФиф║ОхИЭхзЛхМЦ Redis чЪДхРОхП░ IO ч║┐чиЛя╝МхдДчРЖхжВ RDB/AOF цМБф╣ЕхМЦчнЙшАЧцЧ╢цУНф╜ЬуАВшАМ <code>initThreadedIO</code> хЗ╜цХ░хЬицндхЯ║чбАф╕Кш┐Ыф╕АцнехИЭхзЛхМЦхдЪч║┐чиЛ IO цЬ║хИ╢я╝Мф╗ецФпцМБцЫ┤щлШцХИчЪДховцИ╖члпшп╖ц▒ВхдДчРЖуАВ</p></blockquote> <p><code>initThreadedIO</code> хЗ╜цХ░чЪДф╕╗шжБф╗╗хКбцШпхИЭхзЛхМЦ IO ч║┐чиЛя╝МхЕ╢ф╗гчаБхоЮчО░хжВф╕Ля╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// networking.c#initThreadedIO</span>
<span class="token keyword">void</span> <span class="token function">initThreadedIO</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    server<span class="token punctuation">.</span>io_threads_active <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">/* хИЭхзЛхМЦцЧ╢ч║┐чиЛцЬкц┐Ац┤╗уАВ */</span>

    <span class="token comment">/* хжВцЮЬчФицИ╖щАЙцЛйф║ЖхНХч║┐чиЛя╝МхИЩф╕НхИЫх╗║щвЭхдЦч║┐чиЛя╝Ъ
     * цЙАцЬЙ I/O цУНф╜Ьх░ЖчФ▒ф╕╗ч║┐чиЛхдДчРЖуАВ */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>io_threads_num <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>io_threads_num <span class="token operator">&gt;</span> IO_THREADS_MAX_NUM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span><span class="token string">&quot;шЗ┤хС╜щФЩшппя╝ЪщЕНч╜оф║Жш┐ЗхдЪчЪД I/O ч║┐чиЛуАВ&quot;</span>
                             <span class="token string">&quot;цЬАхдзхЕБшо╕цХ░щЗПф╕║ %dуАВ&quot;</span><span class="token punctuation">,</span> IO_THREADS_MAX_NUM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* хИЫх╗║х╣╢хИЭхзЛхМЦ I/O ч║┐чиЛуАВ */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> server<span class="token punctuation">.</span>io_threads_num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* хп╣цЙАцЬЙч║┐чиЛя╝ИхМЕцЛмф╕╗ч║┐чиЛя╝ЙцЙзшбМчЪДцУНф╜ЬуАВ */</span>
        io_threads_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">listCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment">/* ч║┐чиЛ 0 цШпф╕╗ч║┐чиЛуАВ */</span>

        <span class="token comment">/* хп╣щвЭхдЦч║┐чиЛцЙзшбМчЪДцУНф╜ЬуАВ */</span>
        <span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>
        <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>io_threads_mutex<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setIOPendingCount</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>io_threads_mutex<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* ч║┐чиЛх░ЖшвлцЪВхБЬуАВ */</span>
        <span class="token comment">// хИЫх╗║ч║┐чиЛя╝Мх╣╢цМЗхоЪхдДчРЖцЦ╣ц│Х IOThreadMain</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>IOThreadMain<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>i<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span><span class="token string">&quot;шЗ┤хС╜щФЩшппя╝ЪцЧац│ХхИЭхзЛхМЦ IO ч║┐чиЛуАВ&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        io_threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> tid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>щжЦхЕИя╝М<code>initThreadedIO</code> хЗ╜цХ░ф╝Ъшо╛ч╜о IO ч║┐чиЛчЪДц┐Ац┤╗цаЗх┐ЧуАВ</li> <li>щЪПхРОя╝М<code>initThreadedIO</code> хЗ╜цХ░хп╣шо╛ч╜очЪД IO ч║┐чиЛцХ░щЗПш┐ЫшбМцгАцЯея╝Ъ
<ol><li>хжВцЮЬ IO ч║┐чиЛцХ░щЗПф╕║ 1я╝МхИЩшбичд║хПкцЬЙф╕Аф╕кф╕╗ч║┐чиЛя╝М<code>initThreadedIO</code> хЗ╜цХ░х░ЖчЫ┤цОеш┐ФхЫЮуАВхЬиш┐ЩчзНцГЕхЖ╡ф╕Ля╝МRedis server чЪД IO ч║┐чиЛщЕНч╜оф╕О Redis 6.0 ф╣ЛхЙНчЪДчЙИцЬмчЫ╕хРМуАВ</li> <li>хжВцЮЬ IO ч║┐чиЛцХ░щЗПш╢Еш┐ЗхоПхоЪф╣Й <code>IO_THREADS_MAX_NUM</code>я╝Ищ╗ШшодхА╝ф╕║ 128я╝Йя╝М<code>initThreadedIO</code> хЗ╜цХ░ф╝ЪцКещФЩх╣╢щААхЗ║чиЛх║ПуАВ</li> <li>хжВцЮЬ IO ч║┐чиЛцХ░щЗПхЬи 1 хТМ <code>IO_THREADS_MAX_NUM</code> ф╣ЛщЧ┤я╝М<code>initThreadedIO</code> хЗ╜цХ░ф╝ЪцЙзшбМф╕Аф╕кх╛кчОпя╝Мшпех╛кчОпцмбцХ░чнЙф║Ошо╛ч╜очЪД IO ч║┐чиЛцХ░щЗПя╝И<strong>ц│ицДП</strong>я╝М<code>i == 0</code> шбичд║ф╕╗ч║┐чиЛя╝ЙуАВ</li></ol></li></ol> <blockquote><p><code>IO_THREADS_MAX_NUM</code> цШпф╕Аф╕кхоПхоЪф╣Йя╝Мшбичд║ Redis цФпцМБчЪДцЬАхдз IO ч║┐чиЛцХ░щЗПя╝Мщ╗ШшодхА╝ф╕║ 128уАВш┐Щф╕АщЩРхИ╢цЧихЬищШ▓цнвш┐ЗхдЪч║┐чиЛхп╣ч│╗ч╗ЯцАзшГ╜щАацИРш┤ЯцЛЕуАВ</p></blockquote> <p>хЬишпех╛кчОпф╕ня╝М<code>initThreadedIO</code> хЗ╜цХ░ф╝Ъхп╣ф╗еф╕ЛхЫЫф╕кцХ░ч╗Дш┐ЫшбМхИЭхзЛхМЦя╝Ъ</p> <ul><li><strong>io_threads_list цХ░ч╗Д</strong>я╝Ъф┐ЭхнШцпПф╕к IO ч║┐чиЛшжБхдДчРЖчЪДховцИ╖члпхИЧшбия╝МцХ░ч╗ДчЪДцпПф╕кхЕГч┤ахИЭхзЛхМЦф╕║ф╕Аф╕к <code>List</code> ч▒╗хЮЛчЪДхИЧшбиуАВ</li> <li><strong>io_threads_pending цХ░ч╗Д</strong>я╝Ъф┐ЭхнШчнЙх╛ЕцпПф╕к IO ч║┐чиЛхдДчРЖчЪДховцИ╖члпцХ░щЗПуАВ</li> <li><strong>io_threads_mutex цХ░ч╗Д</strong>я╝Ъф┐ЭхнШч║┐чиЛчЪДф║ТцЦещФБуАВ</li> <li><strong>io_threads цХ░ч╗Д</strong>я╝Ъф┐ЭхнШцпПф╕к IO ч║┐чиЛчЪДцППш┐░чмжуАВ</li></ul> <p>ш┐Щф║ЫцХ░ч╗ДчЪДхоЪф╣ЙщГ╜хЬи <code>networking.c</code> цЦЗф╗╢ф╕ня╝МхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token class-name">pthread_t</span> io_threads<span class="token punctuation">[</span>IO_THREADS_MAX_NUM<span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// шо░х╜Хч║┐чиЛцППш┐░чмжчЪДцХ░ч╗Д</span>
<span class="token class-name">pthread_mutex_t</span> io_threads_mutex<span class="token punctuation">[</span>IO_THREADS_MAX_NUM<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// шо░х╜Хч║┐чиЛф║ТцЦещФБчЪДцХ░ч╗Д</span>
<span class="token keyword">_Atomic</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> io_threads_pending<span class="token punctuation">[</span>IO_THREADS_MAX_NUM<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// шо░х╜Хч║┐чиЛх╛ЕхдДчРЖчЪДховцИ╖члпцХ░щЗП</span>
list <span class="token operator">*</span>io_threads_list<span class="token punctuation">[</span>IO_THREADS_MAX_NUM<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// шо░х╜Хч║┐чиЛхп╣х║ФхдДчРЖчЪДховцИ╖члпхИЧшби</span>
</code></pre></div><p>хЬихп╣ш┐Щф║ЫцХ░ч╗Дш┐ЫшбМхИЭхзЛхМЦчЪДхРМцЧ╢я╝М<code>initThreadedIO</code> хЗ╜цХ░ш┐Шф╝Ъца╣цНо IO ч║┐чиЛцХ░щЗПя╝М<strong>ш░ГчФи <code>pthread_create</code> хЗ╜цХ░хИЫх╗║чЫ╕х║ФцХ░щЗПчЪДч║┐чиЛ</strong>уАВ</p> <p>хЬи <code>for</code> х╛кчОпф╕ня╝М<code>pthread_create</code> хЗ╜цХ░чФиф║ОхИЫх╗║ч║┐чиЛуАВцпПф╕кч║┐чиЛцЙзшбМ <code>IOThreadMain</code> хЗ╜цХ░цЭехдДчРЖховцИ╖члпшп╖ц▒ВуАВхжВцЮЬ <code>pthread_create</code> ш┐ФхЫЮщЭЮщЫ╢хА╝я╝МхИЩшп┤цШОч║┐чиЛхИЫх╗║хд▒ш┤ея╝МцндцЧ╢ Redis ф╝Ъшо░х╜ХщФЩшппх╣╢щААхЗ║уАВ</p> <p>хЫацндя╝М<code>initThreadedIO</code> хЗ╜цХ░хИЫх╗║чЪДч║┐чиЛш┐РшбМчЪДхЗ╜цХ░цШп <strong>IOThreadMain</strong>я╝МхПВцХ░ф╕║х╜УхЙНхИЫх╗║ч║┐чиЛчЪДч╝ЦхП╖уАВщЬАшжБц│ицДПчЪДцШпя╝Мшпеч╝ЦхП╖ф╗О 1 х╝АхзЛя╝МшАМч╝ЦхП╖ф╕║ 0 чЪДч║┐чиЛхоЮщЩЕф╕КцШпш┐РшбМ Redis server ф╕╗ц╡БчиЛчЪДф╕╗ч║┐чиЛуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">IOThreadMain</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>myid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* ID цШпч║┐чиЛч╝ЦхП╖я╝Иф╗О 0 хИ░ server.iothreads_num-1я╝Й */</span>
    <span class="token keyword">long</span> id <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>myid<span class="token punctuation">;</span>
    <span class="token keyword">char</span> thdname<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token function">snprintf</span><span class="token punctuation">(</span>thdname<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>thdname<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;io_thd_%ld&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">redis_set_thread_title</span><span class="token punctuation">(</span>thdname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">redisSetCpuAffinity</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>server_cpulist<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">makeThreadKillable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* чнЙх╛Ех╝АхзЛ */</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">1000000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getIOPendingCount</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* ч╗Щф╕╗ч║┐чиЛф╕Аф╕кцЬ║ф╝ЪцЭехБЬцнвцндч║┐чиЛуАВ */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getIOPendingCount</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>io_threads_mutex<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>io_threads_mutex<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">serverAssert</span><span class="token punctuation">(</span><span class="token function">getIOPendingCount</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>tio_debug<span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;[%ld] %d to handle\n&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">listLength</span><span class="token punctuation">(</span>io_threads_list<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* хдДчРЖя╝Ъц│ицДПф╕╗ч║┐чиЛф╕Нф╝ЪхЬицИСф╗мх░Жх╛ЕхдДчРЖцХ░щЗПхЗПх░СхИ░ 0 ф╣ЛхЙНшзжчв░цИСф╗мчЪДхИЧшби */</span>
        listIter li<span class="token punctuation">;</span>
        listNode <span class="token operator">*</span>ln<span class="token punctuation">;</span>
        <span class="token function">listRewind</span><span class="token punctuation">(</span>io_threads_list<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ln <span class="token operator">=</span> <span class="token function">listNext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>li<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            client <span class="token operator">*</span>c <span class="token operator">=</span> <span class="token function">listNodeValue</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>io_threads_op <span class="token operator">==</span> IO_THREADS_OP_WRITE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">writeToClient</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>io_threads_op <span class="token operator">==</span> IO_THREADS_OP_READ<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">readQueryFromClient</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">serverPanic</span><span class="token punctuation">(</span><span class="token string">&quot;io_threads_op хА╝цЬкчЯе&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">listEmpty</span><span class="token punctuation">(</span>io_threads_list<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setIOPendingCount</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>tio_debug<span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;[%ld] Done\n&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>IOThreadMain</code> хЗ╜цХ░ф╣ЯхЬи <code>networking.c</code> цЦЗф╗╢ф╕нхоЪф╣Йя╝МхЕ╢ф╕╗шжБщА╗ш╛Сф╕║ф╕Аф╕к <strong>while(1) х╛кчОп</strong>уАВ</p> <p><code>IOThreadMain</code> хЗ╜цХ░хЬих╛кчОпф╕нхдДчРЖ <code>io_threads_list</code> цХ░ч╗Дф╕нцпПф╕кч║┐чиЛчЪДховцИ╖члпшп╖ц▒ВуАВ</p> <p>цнгхжВф╣ЛхЙНцЙАш┐░я╝М<code>io_threads_list</code> цХ░ч╗Дф╕нф╕║цпПф╕к IO ч║┐чиЛф╜┐чФиф╕Аф╕кхИЧшбишо░х╜Хх╛ЕхдДчРЖчЪДховцИ╖члпуАВхЫацндя╝М<code>IOThreadMain</code> хЗ╜цХ░ф╝Ъф╗ОцпПф╕к IO ч║┐чиЛхп╣х║ФчЪДхИЧшбиф╕нхПЦхЗ║х╛ЕхдДчРЖчЪДховцИ╖члпя╝Мх╣╢ца╣цНоцУНф╜Ьч▒╗хЮЛцЙзшбМчЫ╕х║ФцУНф╜ЬуАВцУНф╜Ьч▒╗хЮЛчФ▒хПШщЗП <code>io_threads_op</code> шбичд║я╝МхЕ╢хА╝цЬЙф╕дчзНя╝Ъ</p> <ul><li><strong><code>io_threads_op</code> чЪДхА╝ф╕║хоПхоЪф╣Й <code>IO_THREADS_OP_WRITE</code></strong>я╝Ъшбичд║шпе IO ч║┐чиЛш┐ЫшбМхЖЩцУНф╜Ья╝Мх░ЖцХ░цНоф╗О Redis хЖЩхЫЮховцИ╖члпя╝Мч║┐чиЛф╝Ъш░ГчФи <code>writeToClient</code> хЗ╜цХ░уАВ</li> <li><strong><code>io_threads_op</code> чЪДхА╝ф╕║хоПхоЪф╣Й <code>IO_THREADS_OP_READ</code></strong>я╝Ъшбичд║шпе IO ч║┐чиЛш┐ЫшбМшп╗цУНф╜Ья╝Мф╗ОховцИ╖члпшп╗хПЦцХ░цНоя╝Мч║┐чиЛф╝Ъш░ГчФи <code>readQueryFromClient</code> хЗ╜цХ░уАВ</li></ul> <div class="custom-block note"><p class="custom-block-title">чмФшо░</p> <p>хжВцЮЬцВихп╣ Java ч╝ЦчиЛчЖЯцВЙя╝МхПпф╗ех░Ж <code>IOThreadMain</code> хЗ╜цХ░шзЖф╕║ <code>Runnable</code> чЪДхЕ╖ф╜УхоЮчО░уАВхЕ╢ца╕х┐ГщА╗ш╛СхЬиф║О <code>while(1)</code> цЧащЩРх╛кчОпф╕нуАВца╣цНоц║РчаБя╝МIO ч║┐чиЛф╗О <code>io_threads_list</code> щШЯхИЧя╝ИцИЦхИЧшбия╝Йф╕ншО╖хПЦх╛ЕхдДчРЖчЪДховцИ╖члпя╝Мх╣╢ца╣цНоцУНф╜Ьч▒╗хЮЛщАЙцЛйхЕ╖ф╜УчЪДцЙзшбМщА╗ш╛СуАВш┐ЩцШпф╕АчзНхЕ╕хЮЛчЪД <code>чФЯф║зшАЕ-ц╢Иш┤╣шАЕцибхЮЛ</code>я╝Мф╕╗ч║┐чиЛш┤Яш┤гцКХщАТф║Лф╗╢я╝МIO ч║┐чиЛш┤Яш┤гц╢Иш┤╣ф║Лф╗╢я╝Иф╕╗ч║┐чиЛф╣ЯхПВф╕Оя╝ЙуАВ</p></div> <p>цИСч╗ШхИ╢ф║Жф╕ЛхЫ╛я╝Мф╗ех▒Хчд║ <code>IOThreadMain</code> хЗ╜цХ░чЪДхЯ║цЬмц╡БчиЛя╝Мшп╖хПВшАГя╝Ъ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409172237429.png" alt="image-20240917144454718"></p> <p>хжВф╕КцЙАчд║я╝МцпПф╕к IO ч║┐чиЛхЬиш┐РшбМш┐ЗчиЛф╕ня╝Мф╝Ъф╕НцЦнцгАцЯецШпхРжцЬЙх╛ЕхдДчРЖчЪДховцИ╖члпшп╖ц▒ВуАВхжВцЮЬхнШхЬих╛ЕхдДчРЖчЪДховцИ╖члпя╝Мч║┐чиЛф╝Ъца╣цНоцУНф╜Ьч▒╗хЮЛя╝Мф╗ОховцИ╖члпшп╗хПЦцХ░цНоцИЦх░ЖцХ░цНохЖЩхЫЮховцИ╖члпуАВш┐Щф║ЫцУНф╜Ьц╢ЙхПК Redis ф╕ОховцИ╖члпф╣ЛщЧ┤чЪД I/O ф║дф║Тя╝МхЫацндш┐Щф║Ыч║┐чиЛшвлчз░ф╕║ IO ч║┐чиЛуАВ</p> <p>хЬицндя╝МцВихПпшГ╜ф╝Ъф║зчФЯф╕Аф║ЫчЦСщЧоя╝Ъ<strong>IO ч║┐чиЛхжВф╜Хх░ЖховцИ╖члпц╖╗хКахИ░ <code>io_threads_list</code> цХ░ч╗Дф╕ня╝Я</strong></p> <p>ш┐Щц╢ЙхПК Redis server чЪДхЕих▒АхПШщЗП <code>server</code>уАВ<code>server</code> хПШщЗПф╕нхМЕхРлф╕дф╕к <code>List</code> ч▒╗хЮЛчЪДцИРхСШхПШщЗПя╝Ъ<code>clients_pending_write</code> хТМ <code>clients_pending_read</code>я╝МхИЖхИлшо░х╜Хх╛ЕхЖЩхЫЮцХ░цНочЪДховцИ╖члпхТМх╛Ешп╗хПЦцХ░цНочЪДховцИ╖члпя╝МхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// х╛ЕхЖЩхЫЮцХ░цНочЪДховцИ╖члп</span>
    list <span class="token operator">*</span>clients_pending_write<span class="token punctuation">;</span>  
    <span class="token comment">// х╛Ешп╗хПЦцХ░цНочЪДховцИ╖члп</span>
    list <span class="token operator">*</span>clients_pending_read<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Redis server хЬицОецФ╢ховцИ╖члпшп╖ц▒ВхТМш┐ФхЫЮцХ░цНочЪДш┐ЗчиЛф╕ня╝Мф╝Ъца╣цНочЙ╣хоЪцЭбф╗╢цОиш┐ЯховцИ╖члпчЪДшп╗хЖЩцУНф╜Ья╝Мх╣╢х░Жш┐Щф║ЫховцИ╖члпхИЖхИлф┐ЭхнШхИ░ш┐Щф╕дф╕кхИЧшбиф╕нуАВщЪПхРОя╝МхЬицпПцмбш┐ЫхЕеф║Лф╗╢х╛кчОпхЙНя╝МRedis server ф╝Ъх░ЖхИЧшбиф╕нчЪДховцИ╖члпц╖╗хКахИ░ <code>io_threads_list</code> цХ░ч╗Дф╕ня╝МчФ▒ IO ч║┐чиЛш┐ЫшбМхдДчРЖуАВ</p> <p>цОеф╕ЛцЭея╝МцИСф╗мх░ЖцОвшои Redis хжВф╜ХцОиш┐ЯховцИ╖члпчЪДшп╗хЖЩцУНф╜Ья╝Мх╣╢х░Жш┐Щф║ЫховцИ╖члпц╖╗хКахИ░ <code>clients_pending_write</code> хТМ <code>clients_pending_read</code> хИЧшбиф╕нуАВ</p> <h3 id="_2-хдЪч║┐чиЛшп╗"><a href="#_2-хдЪч║┐чиЛшп╗" class="header-anchor">#</a> 2. хдЪч║┐чиЛшп╗</h3> <p>хЬицЧйцЬЯчЪДхНХч║┐чиЛчЙИцЬмф╕ня╝Мх╜УхдЪш╖пхдНчФицгАц╡ЛхИ░ховцИ╖члпцХ░цНохЗЖхдЗх░▒ч╗кцЧ╢я╝Мф╕╗ф║Лф╗╢х╛кчОпф╝Ъш╜ошпвхдДчРЖш┐Щф║Ых░▒ч╗кчЪДховцИ╖члпя╝МцнещкдхжВф╕Ля╝Ъ</p> <ol><li>шп╗хПЦцХ░цНо</li> <li>шзгцЮРцХ░цНо</li> <li>цЙзшбМхС╜ф╗д</li> <li>х░ЖцХ░цНохЖЩхЫЮховцИ╖члпч╝УхЖ▓хМ║</li> <li>чнЙх╛Еф╕Лф╕Аш╜оф╕╗ф║Лф╗╢х╛кчОп</li> <li>х░ЖховцИ╖члпч╝УхЖ▓цХ░цНохЖЩхЫЮховцИ╖члп</li></ol> <p>хЬихдЪч║┐чиЛцибх╝Пф╕Ля╝ИхБЗшо╛щЕНч╜оф║ЖхдЪч║┐чиЛшп╗я╝Йя╝Мф╕Кш┐░ц╡БчиЛцЬЙцЙАхПШхМЦя╝ЪцХ░цНошп╗хПЦхТМшзгцЮРцУНф╜Ьх░ЖшвлхИЖщЕНч╗ЩхдЪф╕к IO ч║┐чиЛя╝ИхМЕцЛмф╕╗ч║┐чиЛя╝ЙуАВ</p> <p>цЙАцЬЙх░▒ч╗кховцИ╖члпх░ЖцЪВхнШшЗ│щШЯхИЧф╕ня╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">{</span>  
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   list <span class="token operator">*</span>clients_pending_read<span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хдДчРЖц╡БчиЛхжВф╕Ля╝Ъ</p> <ol><li>ф╕╗ч║┐чиЛх╝АхзЛчЫСхРм IO ф║Лф╗╢</li> <li>ф╕╗ч║┐чиЛш░ГчФи <code>readQueryFromClient</code></li> <li><code>postponeClientRead</code> х░ЖховцИ╖члпц╖╗хКашЗ│ <code>clients_pending_read</code></li> <li><code>handleClientsWithPendingReadsUsingThreads</code> х░Ж <code>clients_pending_read</code> хИЧшбиф╕нчЪДховцИ╖члпхИЖщЕНч╗ЩцЙАцЬЙ IO ч║┐чиЛ</li> <li>ф╕╗ч║┐чиЛщШ╗хбЮх╣╢чнЙх╛ЕцЙАцЬЙ IO ч║┐чиЛхоМцИРшп╗хПЦ</li> <li>ф╕╗ч║┐чиЛх╛кчОпщБНхОЖх╣╢хдДчРЖцЙАцЬЙшп╗хПЦхИ░чЪДцХ░цНо</li></ol> <h4 id="хЕещШЯ-хжВф╜ХцОиш┐ЯховцИ╖члпшп╗цУНф╜Ь"><a href="#хЕещШЯ-хжВф╜ХцОиш┐ЯховцИ╖члпшп╗цУНф╜Ь" class="header-anchor">#</a> хЕещШЯя╝ЪхжВф╜ХцОиш┐ЯховцИ╖члпшп╗цУНф╜Ья╝Я</h4> <p>Redis server хЬиф╕ОховцИ╖члпх╗║члЛш┐ЮцОехРОя╝Мф╝Ъх╝АхзЛчЫСхРмховцИ╖члпчЪДхПпшп╗ф║Лф╗╢уАВхдДчРЖхПпшп╗ф║Лф╗╢чЪДхЫЮш░ГхЗ╜цХ░цШп <code>readQueryFromClient</code>уАВцИСхЬицЯРхдДх╖▓ф╗Лч╗Нф║Жш┐Щф╕Аш┐ЗчиЛя╝МцВихПпф╗ехЖНцмбхЫЮщб╛уАВ</p> <p>хЬи Redis 6.0 чЙИцЬмф╕ня╝М<code>readQueryFromClient</code> хЗ╜цХ░щжЦхЕИф╗Оф╝ахЕечЪДхПВцХ░ <code>conn</code> ф╕ншО╖хПЦховцИ╖члп <code>c</code>я╝МчД╢хРОш░ГчФи <code>postponeClientRead</code> хЗ╜цХ░цЭехИдцЦнцШпхРжцОиш┐Яф╗ОховцИ╖члпшп╗хПЦцХ░цНоуАВцЙзшбМщА╗ш╛СхжВф╕Ля╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">readQueryFromClient</span><span class="token punctuation">(</span>connection <span class="token operator">*</span>conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    client <span class="token operator">*</span>c <span class="token operator">=</span> <span class="token function">connGetPrivateData</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ф╗Ош┐ЮцОецХ░цНоч╗УцЮДф╕ншО╖хПЦховцИ╖члп</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">postponeClientRead</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token comment">// хИдцЦнцШпхРжцОиш┐Яф╗ОховцИ╖члпшп╗хПЦцХ░цНо</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цОеф╕ЛцЭея╝МцИСф╗мх░ЖхИЖцЮР <code>postponeClientRead</code> хЗ╜цХ░чЪДцЙзшбМщА╗ш╛СуАВшпехЗ╜цХ░ф╝Ъца╣цНоф╗еф╕ЛхЫЫф╕кцЭбф╗╢хИдцЦнцШпхРжхПпф╗ецОиш┐Яф╗ОховцИ╖члпшп╗хПЦцХ░цНоя╝Ъ</p> <p><strong>цЭбф╗╢ф╕Ая╝ЪхЕих▒АхПШщЗП <code>server</code> чЪД <code>io_threads_active</code> хА╝ф╕║ 1</strong></p> <p>ш┐Щшбичд║хдЪ IO ч║┐чиЛх╖▓ц┐Ац┤╗уАВцнгхжВхЙНш┐░я╝МшпехПШщЗПхЬи <code>initThreadedIO</code> хЗ╜цХ░ф╕нхИЭхзЛхМЦф╕║ 0я╝МшбицШОхдЪ IO ч║┐чиЛхИЭхзЛхМЦхРОщ╗ШшодцЬкц┐Ац┤╗я╝ИхРОцЦЗх░Жшпжч╗Жф╗Лч╗Нф╜ХцЧ╢х░ЖшпехПШщЗПхА╝шо╛ч╜оф╕║ 1я╝ЙуАВ</p> <p><strong>цЭбф╗╢ф║Мя╝ЪхЕих▒АхПШщЗП <code>server</code> чЪД <code>io_threads_do_read</code> хА╝ф╕║ 1</strong></p> <p>ш┐Щшбичд║хдЪ IO ч║┐чиЛхПпф╗ехдДчРЖх╗╢хРОцЙзшбМчЪДховцИ╖члпшп╗цУНф╜ЬуАВшпехПШщЗПхЬи Redis щЕНч╜оцЦЗф╗╢ <code>redis.conf</code> ф╕нщАЪш┐З <code>io-threads-do-reads</code> щЕНч╜ощб╣шо╛ч╜оя╝Мщ╗Шшодф╕║ <code>no</code>я╝МхН│хдЪ IO ч║┐чиЛцЬ║хИ╢щ╗Шшодф╕НчФиф║ОховцИ╖члпшп╗цУНф╜ЬуАВшЛешжБхРпчФихдЪ IO ч║┐чиЛхдДчРЖховцИ╖члпшп╗цУНф╜Ья╝МщЬАх░Ж <code>io-threads-do-reads</code> щЕНч╜ощб╣шо╛ф╕║ <code>yes</code>уАВ</p> <p><strong>цЭбф╗╢ф╕Йя╝Ъ<code>ProcessingEventsWhileBlocked</code> хПШщЗПхА╝ф╕║ 0</strong></p> <p>ш┐Щшбичд║ <code>processEventsWhileBlocked</code> хЗ╜цХ░цЬкхЬицЙзшбМф╕нуАВ<code>ProcessingEventsWhileBlocked</code> цШпф╕Аф╕кхЕих▒АхПШщЗПя╝Мх╜У <code>processEventsWhileBlocked</code> хЗ╜цХ░цЙзшбМцЧ╢я╝МшпехПШщЗПхА╝ф╕║ 1я╝МхЗ╜цХ░цЙзшбМхоМцИРхРОхА╝ф╕║ 0уАВ<code>processEventsWhileBlocked</code> хЗ╜цХ░хЬи <code>networking.c</code> цЦЗф╗╢ф╕нхоЮчО░я╝Мф╕╗шжБчФиф║ОхЬи Redis шп╗хПЦ RDB цИЦ AOF цЦЗф╗╢цЧ╢хдДчРЖф║Лф╗╢я╝МщБ┐хЕНхЫашп╗хПЦцЦЗф╗╢щШ╗хбЮ Redis хп╝шЗ┤ф║Лф╗╢хдДчРЖх╗╢ш┐ЯуАВхЫацндя╝Мх╜У <code>processEventsWhileBlocked</code> хЗ╜цХ░хдДчРЖховцИ╖члпхПпшп╗ф║Лф╗╢цЧ╢я╝Мш┐Щф║ЫховцИ╖члпшп╗цУНф╜Ьф╕Нф╝ЪшвлцОиш┐ЯуАВ</p> <p><strong>цЭбф╗╢хЫЫя╝ЪховцИ╖члпх╜УхЙНцаЗшпЖф╕НшГ╜хМЕхРл <code>CLIENT_MASTER</code>уАБ<code>CLIENT_SLAVE</code> хТМ <code>CLIENT_PENDING_READ</code></strong></p> <p>хЕ╢ф╕ня╝М<code>CLIENT_MASTER</code> хТМ <code>CLIENT_SLAVE</code> цаЗшпЖшбичд║ховцИ╖члпчФиф║Оф╕╗ф╗ОхдНхИ╢я╝Мш┐Щф║ЫховцИ╖члпчЪДшп╗цУНф╜Ьф╕Нф╝ЪшвлцОиш┐ЯуАВ<code>CLIENT_PENDING_READ</code> цаЗшпЖшбичд║ховцИ╖члпх╖▓шо╛ч╜оф╕║цОиш┐Яшп╗цУНф╜Ья╝МхЫацндя╝Мхп╣ф║Ох╖▓х╕жцЬЙ <code>CLIENT_PENDING_READ</code> цаЗшпЖчЪДховцИ╖члпя╝М<code>postponeClientRead</code> хЗ╜цХ░ф╕Нф╝ЪхЖНцмбцОиш┐ЯхЕ╢шп╗цУНф╜ЬуАВ</p> <p>хПкцЬЙх╜Уф╕Кш┐░хЫЫф╕кцЭбф╗╢хЭЗц╗бш╢│цЧ╢я╝М<code>postponeClientRead</code> хЗ╜цХ░цЙНф╝ЪцОиш┐Ях╜УхЙНховцИ╖члпчЪДшп╗цУНф╜ЬуАВхЕ╖ф╜УцЭешп┤я╝М<code>postponeClientRead</code> хЗ╜цХ░ф╝Ъф╕║шпеховцИ╖члпшо╛ч╜о <code>CLIENT_PENDING_READ</code> цаЗшпЖя╝Мх╣╢ш░ГчФи <code>listAddNodeHead</code> хЗ╜цХ░я╝Мх░ЖховцИ╖члпц╖╗хКахИ░хЕих▒АхПШщЗП <code>server</code> чЪД <code>clients_pending_read</code> хИЧшбиф╕нуАВ</p> <p>ф╗еф╕ЛцШп <code>postponeClientRead</code> хЗ╜цХ░чЪДф╗гчаБя╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">postponeClientRead</span><span class="token punctuation">(</span>client <span class="token operator">*</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// хИдцЦн IO ч║┐чиЛцШпхРжц┐Ац┤╗</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>io_threads_active <span class="token operator">&amp;&amp;</span> server<span class="token punctuation">.</span>io_threads_do_reads <span class="token operator">&amp;&amp;</span>      
         <span class="token operator">!</span>ProcessingEventsWhileBlocked <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>CLIENT_MASTER<span class="token operator">|</span>CLIENT_SLAVE<span class="token operator">|</span>CLIENT_PENDING_READ<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        c<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> CLIENT_PENDING_READ<span class="token punctuation">;</span> <span class="token comment">// шо╛ч╜оховцИ╖члпцаЗшпЖф╕║ CLIENT_PENDING_READя╝Мшбичд║цОиш┐ЯшпеховцИ╖члпчЪДшп╗цУНф╜Ь</span>
        <span class="token function">listAddNodeHead</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>clients_pending_read<span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// х░ЖховцИ╖члпц╖╗хКахИ░ clients_pending_read хИЧшбиф╕н</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ч╗╝ф╕КцЙАш┐░я╝МRedis хЬиховцИ╖члпшп╗ф║Лф╗╢хЫЮш░ГхЗ╜цХ░ <code>readQueryFromClient</code> ф╕ня╝МщАЪш┐Зш░ГчФи <code>postponeClientRead</code> хЗ╜цХ░цЭехИдцЦнх╣╢цОиш┐ЯховцИ╖члпшп╗цУНф╜ЬуАВцОеф╕ЛцЭея╝МцИСф╗мх░ЖцОвшои Redis хжВф╜ХцОиш┐ЯховцИ╖члпхЖЩцУНф╜ЬуАВ</p> <h4 id="хИЖщЕН-хжВф╜Хх░Жх╛Ешп╗ховцИ╖члпхИЖщЕНч╗Щ-io-ч║┐чиЛцЙзшбМ"><a href="#хИЖщЕН-хжВф╜Хх░Жх╛Ешп╗ховцИ╖члпхИЖщЕНч╗Щ-io-ч║┐чиЛцЙзшбМ" class="header-anchor">#</a> хИЖщЕНя╝ЪхжВф╜Хх░Жх╛Ешп╗ховцИ╖члпхИЖщЕНч╗Щ IO ч║┐чиЛцЙзшбМя╝Я</h4> <p>щжЦхЕИя╝МцИСф╗мщЬАшжБф║Жшзг <strong>handleClientsWithPendingReadsUsingThreads</strong> хЗ╜цХ░чЪДф╜ЬчФиуАВшпехЗ╜цХ░хЬи <code>beforeSleep</code> хЗ╜цХ░ф╕ншвлш░ГчФиуАВ</p> <p>хЬи Redis 6.0 чЙИцЬмчЪДхоЮчО░ф╕ня╝Мф║Лф╗╢щй▒хКицбЖцЮ╢щАЪш┐Зш░ГчФи <code>aeMain</code> хЗ╜цХ░цЙзшбМф║Лф╗╢х╛кчОпя╝М<code>aeMain</code> хЗ╜цХ░ш┐Ыф╕Ацнеш░ГчФи <code>aeProcessEvents</code> хдДчРЖхРДчзНф║Лф╗╢уАВхЬи <code>aeProcessEvents</code> хоЮщЩЕш░ГчФи <code>aeApiPoll</code> цНХшО╖ IO ф║Лф╗╢ф╣ЛхЙНя╝М<code>beforeSleep</code> хЗ╜цХ░ф╝ЪшвлцЙзшбМуАВ</p> <p>шпеш┐ЗчиЛхжВхЫ╛цЙАчд║я╝Ъ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409172240189.png" alt="image-20240917145125065"></p> <p><strong>handleClientsWithPendingReadsUsingThreads</strong> хЗ╜цХ░чЪДцЙзшбМщА╗ш╛СхПпхИЖф╕║хЫЫф╕кцнещкдя╝Ъ</p> <p><strong>чммф╕Ацне</strong>я╝МшпехЗ╜цХ░щжЦхЕИцгАцЯехЕих▒АхПШщЗП <code>server</code> чЪД <code>io_threads_active</code> цИРхСШхПШщЗПя╝Мчбошод IO ч║┐чиЛцШпхРжц┐Ац┤╗я╝МхРМцЧ╢ф╛ЭцНо <code>io_threads_do_reads</code> цИРхСШхПШщЗПхИдцЦнцШпхРжхЕБшо╕ IO ч║┐чиЛхдДчРЖх╛Ешп╗ховцИ╖члпуАВхПкцЬЙхЬи IO ч║┐чиЛшвлц┐Ац┤╗х╣╢ф╕ФхЕБшо╕хдДчРЖх╛Ешп╗ховцИ╖члпчЪДцГЕхЖ╡ф╕Ля╝М<code>handleClientsWithPendingReadsUsingThreads</code> хЗ╜цХ░цЙНф╝Ъч╗зч╗нцЙзшбМя╝МхРжхИЩхЗ╜цХ░х░ЖчЫ┤цОеш┐ФхЫЮуАВхИдцЦнщА╗ш╛СхжВф╕Ля╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>server<span class="token punctuation">.</span>io_threads_active <span class="token operator">||</span> <span class="token operator">!</span>server<span class="token punctuation">.</span>io_threads_do_reads<span class="token punctuation">)</span> 
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>чммф║Мцне</strong>я╝МхЗ╜цХ░шО╖хПЦ <code>clients_pending_read</code> хИЧшбичЪДщХ┐х║жя╝Мшбичд║х╛ЕхдДчРЖховцИ╖члпчЪДцХ░щЗПуАВщЪПхРОя╝МхЗ╜цХ░ф╗О <code>clients_pending_read</code> хИЧшбиф╕нщАРф╕АхПЦхЗ║х╛ЕхдДчРЖчЪДховцИ╖члпя╝Мх╣╢щАЪш┐ЗховцИ╖члпхЬихИЧшбиф╕нчЪДх║ПхП╖хп╣ IO ч║┐чиЛцХ░щЗПш┐ЫшбМхПЦцибш┐РчоЧуАВ</p> <p>щАЪш┐Зш┐ЩчзНцЦ╣х╝Пя╝МховцИ╖члпх░ЖшвлхИЖщЕНч╗Щхп╣х║ФчЪД IO ч║┐чиЛуАВцОечЭАя╝МхЗ╜цХ░ф╝Ъш░ГчФи <code>listAddNodeTail</code> х░ЖхИЖщЕНхе╜чЪДховцИ╖члпц╖╗хКахИ░ <code>io_threads_list</code> цХ░ч╗ДчЪДчЫ╕х║ФхЕГч┤аф╕нуАВ<code>io_threads_list</code> цХ░ч╗ДчЪДцпПф╕кхЕГч┤ацШпф╕Аф╕кхИЧшбия╝Мф┐ЭхнШф║ЖцпПф╕к IO ч║┐чиЛщЬАшжБхдДчРЖчЪДховцИ╖члпуАВ</p> <p>ф╗еф╕ЛцШпхЕ╖ф╜УчЪДчд║ф╛Ля╝Ъ</p> <p>хБЗшо╛ IO ч║┐чиЛцХ░щЗПф╕║ 3я╝МшАМ <code>clients_pending_read</code> хИЧшбиф╕нцЬЙ 5 ф╕кховцИ╖члпя╝МхЕ╢х║ПхП╖хИЖхИлф╕║ 0уАБ1уАБ2уАБ3 хТМ 4уАВхЬицндцнещкдф╕ня╝Мш┐Щф║ЫховцИ╖члпчЪДх║ПхП╖хп╣ч║┐чиЛцХ░щЗП 3 хПЦцибчЪДч╗УцЮЬхИЖхИлцШп 0уАБ1уАБ2уАБ0уАБ1я╝Мш┐Щхп╣х║Фф║ЖхдДчРЖш┐Щф║ЫховцИ╖члпчЪД IO ч║┐чиЛч╝ЦхП╖уАВф╣Ях░▒цШпшп┤я╝МховцИ╖члп 0 чФ▒ч║┐чиЛ 0 хдДчРЖя╝МховцИ╖члп 1 чФ▒ч║┐чиЛ 1 хдДчРЖя╝Мф╗ецндч▒╗цОиуАВховцИ╖члпчЪДхИЖщЕНцЦ╣х╝ПхоЮщЩЕф╕КцШпф╕АчзН <strong>ш╜ошпв</strong> цЦ╣х╝ПуАВ</p> <p>ф╕ЛхЫ╛х▒Хчд║ф║Жш┐ЩчзНхИЖщЕНч╗УцЮЬя╝Ъ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409172240213.png" alt="image-20240917145140527"></p> <p>ф╗еф╕Лф╗гчаБх▒Хчд║ф║ЖхжВф╜Хф╗еш╜ошпвцЦ╣х╝Пх░ЖховцИ╖члпхИЖщЕНч╗Щ IO ч║┐чиЛчЪДцЙзшбМщА╗ш╛Ся╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> processed <span class="token operator">=</span> <span class="token function">listLength</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>clients_pending_read<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">listRewind</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>clients_pending_read<span class="token punctuation">,</span> <span class="token operator">&amp;</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> item_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ln <span class="token operator">=</span> <span class="token function">listNext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>li<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    client <span class="token operator">*</span>c <span class="token operator">=</span> <span class="token function">listNodeValue</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> target_id <span class="token operator">=</span> item_id <span class="token operator">%</span> server<span class="token punctuation">.</span>io_threads_num<span class="token punctuation">;</span>
    <span class="token function">listAddNodeTail</span><span class="token punctuation">(</span>io_threads_list<span class="token punctuation">[</span>target_id<span class="token punctuation">]</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    item_id<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>х╜У <code>handleClientsWithPendingReadsUsingThreads</code> хЗ╜цХ░хоМцИРховцИ╖члпчЪД IO ч║┐чиЛхИЖщЕНхРОя╝МхоГф╝Ъх░Ж IO ч║┐чиЛчЪДцУНф╜ЬцаЗшпЖшо╛ч╜оф╕║ <strong>шп╗цУНф╜Ь</strong>я╝МхН│ <code>IO_THREADS_OP_READ</code>уАВчД╢хРОя╝МхоГф╝ЪщБНхОЖ <code>io_threads_list</code> цХ░ч╗Дф╕нчЪДцпПф╕кхЕГч┤ахИЧшбия╝Мшо░х╜ХцпПф╕кч║┐чиЛх╛ЕхдДчРЖховцИ╖члпчЪДцХ░щЗПя╝Мх╣╢ш╡ЛхА╝ч╗Щ <code>io_threads_pending</code> цХ░ч╗ДуАВхЕ╖ф╜Уш┐ЗчиЛхжВф╕Ля╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code>io_threads_op <span class="token operator">=</span> IO_THREADS_OP_READ<span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> server<span class="token punctuation">.</span>io_threads_num<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">listLength</span><span class="token punctuation">(</span>io_threads_list<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    io_threads_pending<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>чммф╕Йцне</strong>я╝МхЗ╜цХ░ф╝Ъх░Ж <code>io_threads_list</code> цХ░ч╗Дф╕нчЪД 0 хП╖хИЧшбия╝ИхН│ <code>io_threads_list[0]</code>я╝Йф╕нчЪДховцИ╖члпщАРф╕АхПЦхЗ║я╝Мх╣╢ш░ГчФи <code>readQueryFromClient</code> хЗ╜цХ░ш┐ЫшбМхдДчРЖуАВ</p> <p>щЬАшжБц│ицДПчЪДцШпя╝М<code>handleClientsWithPendingReadsUsingThreads</code> хЗ╜цХ░цЬмш║лчФ▒ IO ф╕╗ч║┐чиЛцЙзшбМя╝МшАМ <code>io_threads_list</code> цХ░ч╗Дф╕нчЪД 0 хП╖ч║┐чиЛхН│ф╕║ IO ф╕╗ч║┐чиЛя╝МхЫацндцндцнещкдцШпчФ▒ф╕╗ч║┐чиЛхдДчРЖхЕ╢х╛Ешп╗ховцИ╖члпя╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token function">listRewind</span><span class="token punctuation">(</span>io_threads_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// шО╖хПЦ 0 хП╖хИЧшбиф╕нчЪДцЙАцЬЙховцИ╖члп</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ln <span class="token operator">=</span> <span class="token function">listNext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>li<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    client <span class="token operator">*</span>c <span class="token operator">=</span> <span class="token function">listNodeValue</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">readQueryFromClient</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">listEmpty</span><span class="token punctuation">(</span>io_threads_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// хдДчРЖхоМхРОя╝Мц╕Ечй║ 0 хП╖хИЧшби</span>
</code></pre></div><p>цОеф╕ЛцЭея╝М<code>handleClientsWithPendingReadsUsingThreads</code> хЗ╜цХ░ф╝Ъш┐ЫхЕеф╕Аф╕к <code>while(1)</code> х╛кчОпя╝МчнЙх╛ЕцЙАцЬЙ IO ч║┐чиЛхоМцИРхп╣х╛Ешп╗ховцИ╖члпчЪДхдДчРЖя╝МхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> pending <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> server<span class="token punctuation">.</span>io_threads_num<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
        pending <span class="token operator">+=</span> io_threads_pending<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pending <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>чммхЫЫцне</strong>я╝МхЗ╜цХ░ф╝ЪхЖНцмбщБНхОЖ <code>clients_pending_read</code> хИЧшбия╝МщАРф╕АхПЦхЗ║хЕ╢ф╕нчЪДховцИ╖члпуАВцОечЭАя╝МхЗ╜цХ░ф╝ЪцгАцЯеховцИ╖члпцШпхРжцЬЙ <code>CLIENT_PENDING_COMMAND</code> цаЗшпЖуАВхжВцЮЬхнШхЬия╝Мшп┤цШОшпеховцИ╖члпчЪДхС╜ф╗дх╖▓швлцЯРф╕к IO ч║┐чиЛшзгцЮРя╝МхПпф╗ецЙзшбМуАВ</p> <p>цндцЧ╢я╝М<code>handleClientsWithPendingReadsUsingThreads</code> хЗ╜цХ░ф╝Ъш░ГчФи <code>processCommandAndResetClient</code> цЙзшбМхС╜ф╗дя╝Мх╣╢чЫ┤цОеш░ГчФи <code>processInputBuffer</code> шзгцЮРховцИ╖члпф╕нцЙАцЬЙхС╜ф╗дх╣╢цЙзшбМуАВ</p> <p>чЫ╕хЕ│ф╗гчаБхжВф╕Ля╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">listLength</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>clients_pending_read<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ln <span class="token operator">=</span> <span class="token function">listFirst</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>clients_pending_read<span class="token punctuation">)</span><span class="token punctuation">;</span>
    client <span class="token operator">*</span>c <span class="token operator">=</span> <span class="token function">listNodeValue</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// хжВцЮЬхС╜ф╗дх╖▓шзгцЮРя╝МхИЩцЙзшбМшпехС╜ф╗д</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> CLIENT_PENDING_COMMAND<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        c<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>CLIENT_PENDING_COMMAND<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">processCommandAndResetClient</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">==</span> C_ERR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// шзгцЮРх╣╢цЙзшбМцЙАцЬЙхС╜ф╗д</span>
    <span class="token function">processInputBuffer</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>шЗ│цндя╝Мф╜ах╖▓ч╗Пф║Жшзгф║ЖхжВф╜Хх░Ж <code>clients_pending_read</code> хИЧшбиф╕нчЪДх╛Ешп╗ховцИ╖члпщАЪш┐Зф╕Кш┐░хЫЫф╕кцнещкдхИЖщЕНч╗Щ IO ч║┐чиЛш┐ЫшбМхдДчРЖуАВф╕ЛхЫ╛х▒Хчд║ф║Жш┐Щф╕Аф╕╗шжБш┐ЗчиЛя╝Мф╜ахПпф╗еш┐Ыф╕АцнехЫЮщб╛я╝Ъ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409172240204.png" alt="image-20240917145158198"></p> <p>цОеф╕ЛцЭея╝МцИСф╗мх░ЖцОвшоих╛ЕхЖЩховцИ╖члпчЪДхИЖщЕНхТМхдДчРЖцЦ╣х╝ПуАВ</p> <p>щЬАшжБц│ицДПчЪДцШпя╝Мх╜У <code>х╛ЕхдДчРЖховцИ╖члп</code> цХ░щЗПш╛Гх░СцЧ╢я╝МRedis шодф╕║ф╕НщЬАшжБхдЪч║┐чиЛхЕ▒хРМхдДчРЖя╝МцЙАцЬЙф╗╗хКбх░ЖчФ▒ф╕╗ч║┐чиЛхоМцИРя╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">stopThreadedIOIfNeeded</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> pending <span class="token operator">=</span> <span class="token function">listLength</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>clients_pending_write<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>io_threads_num <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pending <span class="token operator">&lt;</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>io_threads_num <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>io_threads_active<span class="token punctuation">)</span> <span class="token function">stopThreadedIO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>х╜У <code>х╛ЕхдДчРЖховцИ╖члпцХ░щЗП</code> х░Пф║О <code>2хАНчЪД IO ч║┐чиЛцХ░</code> цЧ╢я╝МцЙАцЬЙховцИ╖члпцХ░цНох░ЖчФ▒ф╕╗ч║┐чиЛхдДчРЖуАВ</p> <h3 id="_3уАБхдЪч║┐чиЛхЖЩ"><a href="#_3уАБхдЪч║┐чиЛхЖЩ" class="header-anchor">#</a> 3уАБхдЪч║┐чиЛхЖЩ</h3> <h4 id="хЕещШЯ-хжВф╜ХхЖ│хоЪцШпхРжцОиш┐ЯховцИ╖члпхЖЩцУНф╜Ь"><a href="#хЕещШЯ-хжВф╜ХхЖ│хоЪцШпхРжцОиш┐ЯховцИ╖члпхЖЩцУНф╜Ь" class="header-anchor">#</a> хЕещШЯя╝ЪхжВф╜ХхЖ│хоЪцШпхРжцОиш┐ЯховцИ╖члпхЖЩцУНф╜Ья╝Я</h4> <p>хЬи Redis ф╕ня╝Мх╜УцЙзшбМховцИ╖члпхС╜ф╗дхРОя╝МщЬАшжБхРСховцИ╖члпш┐ФхЫЮч╗УцЮЬцЧ╢я╝Мф╝Ъш░ГчФи <code>addReply</code> хЗ╜цХ░х░Жх╛Еш┐ФхЫЮчЪДч╗УцЮЬхЖЩхЕеховцИ╖члпчЪДш╛УхЗ║ч╝УхЖ▓хМ║уАВ</p> <p>хЬи <code>addReply</code> хЗ╜цХ░чЪДх╝АхзЛщГихИЖя╝МшпехЗ╜цХ░ф╝Ъш░ГчФи <code>prepareClientToWrite</code> хЗ╜цХ░цЭехИдцЦнцШпхРжщЬАшжБцОиш┐ЯцЙзшбМховцИ╖члпчЪДхЖЩцУНф╜ЬуАВф╗еф╕Лф╗гчаБх▒Хчд║ф║Ж <code>addReply</code> хЗ╜цХ░хжВф╜Хш░ГчФи <code>prepareClientToWrite</code> хЗ╜цХ░я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">addReply</span><span class="token punctuation">(</span>client <span class="token operator">*</span>c<span class="token punctuation">,</span> robj <span class="token operator">*</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">prepareClientToWrite</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">!=</span> C_OK<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цОеф╕ЛцЭея╝МцИСф╗мцЭечЬЛф╕Аф╕Л <code>prepareClientToWrite</code> хЗ╜цХ░уАВшпехЗ╜цХ░ца╣цНоховцИ╖члпчЪДшо╛ч╜ош┐ЫшбМф╕Ач│╗хИЧхИдцЦнуАВхЕ╢ф╕ня╝М<code>clientHasPendingReplies</code> хЗ╜цХ░ф╝Ъшвлш░ГчФия╝МчФиф║ОцгАцЯех╜УхЙНховцИ╖члпчЪДш╛УхЗ║ч╝УхЖ▓хМ║ф╕нцШпхРжш┐ШцЬЙх╛ЕхЖЩхЫЮчЪДцХ░цНоуАВ</p> <p>хжВцЮЬч╝УхЖ▓хМ║ф╕нц▓бцЬЙх╛ЕхЖЩхЫЮчЪДцХ░цНоя╝М<code>prepareClientToWrite</code> хЗ╜цХ░ф╝Ъш┐Ыф╕Ацнеш░ГчФи <code>clientInstallWriteHandler</code> хЗ╜цХ░я╝Мф╗ехИдцЦнцШпхРжшГ╜хдЯцОиш┐ЯховцИ╖члпчЪДхЖЩцУНф╜ЬуАВф╗еф╕Лф╗гчаБх▒Хчд║ф║Жш┐Щф╕Аш░ГчФиш┐ЗчиЛя╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">prepareClientToWrite</span><span class="token punctuation">(</span>client <span class="token operator">*</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// хжВцЮЬховцИ╖члпц▓бцЬЙх╛ЕхЖЩхЫЮцХ░цНоя╝МхИЩш░ГчФи clientInstallWriteHandler хЗ╜цХ░</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">clientHasPendingReplies</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">clientInstallWriteHandler</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хЫацндя╝МцОиш┐ЯховцИ╖члпхЖЩцУНф╜ЬчЪДцЬАч╗ИхЖ│хоЪчФ▒ <code>clientInstallWriteHandler</code> хЗ╜цХ░хБЪхЗ║уАВшпехЗ╜цХ░ф╝ЪцгАцЯеф╕дф╕кцЭбф╗╢я╝Ъ</p> <ul><li><strong>цЭбф╗╢ф╕А</strong>я╝ЪховцИ╖члпцЬкшо╛ч╜о <code>CLIENT_PENDING_WRITE</code> цаЗшпЖя╝МхН│х░ЪцЬкцОиш┐Яш┐ЗхЖЩцУНф╜ЬуАВ</li> <li><strong>цЭбф╗╢ф║М</strong>я╝ЪховцИ╖члпцЙАхЬихоЮф╛ЛцЬкш┐ЫшбМф╕╗ф╗ОхдНхИ╢я╝МцИЦхН│ф╜┐цнгхЬиш┐ЫшбМф╕╗ф╗ОхдНхИ╢я╝МховцИ╖члпцЙАхЬихоЮф╛Лф╜Ьф╕║ф╗ОшКВчВ╣ф╕ФхЕищЗПхдНхИ╢чЪД RDB цЦЗф╗╢х╖▓ф╝аш╛УхоМцИРя╝МхПпф╗ецОецФ╢шп╖ц▒ВуАВ</li></ul> <p>х╜Уф╕Кш┐░ф╕дф╕кцЭбф╗╢щГ╜ц╗бш╢│цЧ╢я╝М<code>clientInstallWriteHandler</code> хЗ╜цХ░ф╝Ъх░ЖховцИ╖члпцаЗшпЖшо╛ч╜оф╕║ <code>CLIENT_PENDING_WRITE</code>я╝Мф╗ешбичд║цОиш┐ЯшпеховцИ╖члпчЪДхЖЩцУНф╜ЬуАВхРМцЧ╢я╝МшпехЗ╜цХ░ф╝Ъх░ЖховцИ╖члпц╖╗хКахИ░хЕих▒АхПШщЗП <code>server</code> чЪДх╛ЕхЖЩхЫЮховцИ╖члпхИЧшби <code>clients_pending_write</code> ф╕нуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">clientInstallWriteHandler</span><span class="token punctuation">(</span>client <span class="token operator">*</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// хжВцЮЬховцИ╖члпц▓бцЬЙшо╛ч╜ош┐З CLIENT_PENDING_WRITE цаЗшпЖя╝Мф╕ФховцИ╖члпф╕НхЬиф╕╗ф╗ОхдНхИ╢ф╕ня╝МцИЦф╜Ьф╕║ф╗ОшКВчВ╣ф╕Фх╖▓цОецФ╢шп╖ц▒В</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> CLIENT_PENDING_WRITE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>replstate <span class="token operator">==</span> REPL_STATE_NONE <span class="token operator">||</span>
         <span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>replstate <span class="token operator">==</span> SLAVE_STATE_ONLINE <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>c<span class="token operator">-&gt;</span>repl_put_online_on_ack<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// х░ЖховцИ╖члпцаЗшпЖшо╛ч╜оф╕║х╛ЕхЖЩхЫЮя╝МхН│ CLIENT_PENDING_WRITE</span>
        c<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> CLIENT_PENDING_WRITE<span class="token punctuation">;</span>
        <span class="token function">listAddNodeHead</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>clients_pending_write<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// х░ЖховцИ╖члпц╖╗хКахИ░ clients_pending_write хИЧшби</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ф╕║х╕охКйчРЖшзгя╝МцИСч╗ШхИ╢ф║Жф╕Ах╝ахЫ╛я╝Мх▒Хчд║ф║Ж Redis цОиш┐ЯховцИ╖члпхЖЩцУНф╜ЬчЪДхЗ╜цХ░ш░ГчФихЕ│ч│╗я╝Мф╛ЫхПВшАГуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409172248379.png" alt="img"></p> <p>чД╢шАМя╝Мх╜У Redis ф╜┐чФи <code>clients_pending_read</code> хТМ <code>clients_pending_write</code> ф╕дф╕кхИЧшбиф┐ЭхнШцОиш┐ЯцЙзшбМчЪДховцИ╖члпцЧ╢я╝М<strong>ш┐Щф║ЫховцИ╖члпхжВф╜ХхИЖщЕНч╗ЩхдЪф╕к I/O ч║┐чиЛш┐ЫшбМхдДчРЖхСвя╝Я</strong> ш┐Щц╢ЙхПКхИ░ф╗еф╕Лф╕дф╕кхЗ╜цХ░я╝Ъ</p> <ul><li><code>handleClientsWithPendingReadsUsingThreads</code> хЗ╜цХ░я╝Ъш┤Яш┤гх░Ж <code>clients_pending_read</code> хИЧшбиф╕нчЪДховцИ╖члпхИЖщЕНч╗Щ I/O ч║┐чиЛхдДчРЖуАВ</li> <li><code>handleClientsWithPendingWritesUsingThreads</code> хЗ╜цХ░я╝Ъш┤Яш┤гх░Ж <code>clients_pending_write</code> хИЧшбиф╕нчЪДховцИ╖члпхИЖщЕНч╗Щ I/O ч║┐чиЛхдДчРЖуАВ</li></ul> <p>цОеф╕ЛцЭея╝МцИСф╗мх░Жшпжч╗Жф╗Лч╗Нш┐Щф╕дф╕кхЗ╜цХ░чЪДхЕ╖ф╜УцУНф╜ЬуАВ</p> <h4 id="хИЖщЕН-хжВф╜Хх░Жх╛Ешп╗ховцИ╖члпхИЖщЕНч╗Щ-10-ф╕кч║┐чиЛцЙзшбМ"><a href="#хИЖщЕН-хжВф╜Хх░Жх╛Ешп╗ховцИ╖члпхИЖщЕНч╗Щ-10-ф╕кч║┐чиЛцЙзшбМ" class="header-anchor">#</a> хИЖщЕНя╝ЪхжВф╜Хх░Жх╛Ешп╗ховцИ╖члпхИЖщЕНч╗Щ 10 ф╕кч║┐чиЛцЙзшбМя╝Я</h4> <p>ф╕Ох╛Ешп╗ховцИ╖члпчЪДхИЖщЕНч▒╗ф╝╝я╝Мх╛ЕхЖЩховцИ╖члпчЪДхИЖщЕНхдДчРЖчФ▒ <code>handleClientsWithPendingWritesUsingThreads</code> хЗ╜цХ░хоМцИРя╝МшпехЗ╜цХ░хРМца╖хЬи <code>beforeSleep</code> хЗ╜цХ░ф╕ншвлш░ГчФиуАВ</p> <p><code>handleClientsWithPendingWritesUsingThreads</code> хЗ╜цХ░чЪДф╕╗шжБц╡БчиЛхПпф╗ехИЖф╕║хЫЫф╕кцнещкдя╝МхЕ╢ф╕нчммф║МуАБчммф╕ЙхТМчммхЫЫцнечЪДцЙзшбМщА╗ш╛Сф╕О <code>handleClientsWithPendingReadsUsingThreads</code> хЗ╜цХ░ч▒╗ф╝╝уАВ</p> <p>чоАшиАф╣Ля╝МхЬичммф║Мцнеф╕ня╝М<code>handleClientsWithPendingWritesUsingThreads</code> хЗ╜цХ░ф╝Ъх░Жх╛ЕхЖЩховцИ╖члпцМЙчЕз <strong>ш╜ошпвцЦ╣х╝П</strong> хИЖщЕНч╗Щ I/O ч║┐чиЛя╝Мх╣╢х░ЖхЕ╢ц╖╗хКахИ░ <code>io_threads_list</code> цХ░ч╗ДчЪДхРДф╕кхЕГч┤аф╕нуАВ</p> <p>хЬичммф╕Йцнеф╕ня╝М<code>handleClientsWithPendingWritesUsingThreads</code> хЗ╜цХ░ф╝Ъшойф╕╗ I/O ч║┐чиЛхдДчРЖхЕ╢х╛ЕхЖЩховцИ╖члпя╝Мх╣╢цЙзшбМ <code>while(1)</code> х╛кчОпф╗ечнЙх╛ЕцЙАцЬЙ I/O ч║┐чиЛхоМцИРхдДчРЖуАВ</p> <p>хЬичммхЫЫцнеф╕ня╝М<code>handleClientsWithPendingWritesUsingThreads</code> хЗ╜цХ░ф╝ЪхЖНцмбцгАцЯе <code>clients_pending_write</code> хИЧшбиф╕нцШпхРжш┐ШцЬЙх╛ЕхЖЩховцИ╖члпуАВхжВцЮЬхнШхЬиф╕Фш┐Щф║ЫховцИ╖члпф╗НцЬЙцХ░цНох╛ЕхЖЩя╝МхЗ╜цХ░ф╝Ъш░ГчФи <code>connSetWriteHandler</code> хЗ╜цХ░ц│ихЖМхПпхЖЩф║Лф╗╢я╝Мшпеф║Лф╗╢чЪДхЫЮш░ГхЗ╜цХ░ф╕║ <code>sendReplyToClient</code>уАВ</p> <p>х╜Уф║Лф╗╢х╛кчОпц╡БчиЛхЖНцмбцЙзшбМцЧ╢я╝М<code>sendReplyToClient</code> хЗ╜цХ░ф╝Ъшвлш░ГчФия╝МхоГф╝ЪчЫ┤цОеш░ГчФи <code>writeToClient</code> хЗ╜цХ░я╝Мх░ЖховцИ╖члпч╝УхЖ▓хМ║ф╕нчЪДцХ░цНохЖЩхЫЮуАВ</p> <p>щЬАшжБц│ицДПчЪДцШпя╝М<code>connSetWriteHandler</code> хЗ╜цХ░цЬАч╗Иф╝ЪцШах░Дф╕║ <code>connSocketSetWriteHandler</code> хЗ╜цХ░я╝МхРОшАЕхЬи <a href="https://github.com/redis/redis/tree/5.0/src/connection.c" target="_blank" rel="noopener noreferrer">connection.c<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> цЦЗф╗╢ф╕нхоЮчО░уАВ<code>connSocketSetWriteHandler</code> хЗ╜цХ░ф╝Ъш░ГчФи <code>aeCreateFileEvent</code> хЗ╜цХ░хИЫх╗║ <code>AE_WRITABLE</code> ф║Лф╗╢я╝Мш┐ЩхН│ф╕║хПпхЖЩф║Лф╗╢чЪДц│ихЖМя╝ИцЬЙхЕ│ <code>aeCreateFileEvent</code> хЗ╜цХ░чЪДф╜┐чФия╝МхПпф╗ехПВшзБчмм 11 шо▓я╝ЙуАВ</p> <p>ф╕О <code>handleClientsWithPendingReadsUsingThreads</code> хЗ╜цХ░ф╕НхРМчЪДцШпя╝МхЬичммф╕Ацнеф╕ня╝М<code>handleClientsWithPendingWritesUsingThreads</code> хЗ╜цХ░ф╝ЪхИдцЦн I/O ч║┐чиЛцХ░щЗПцШпхРжф╕║ 1я╝МцИЦх╛ЕхЖЩховцИ╖члпцХ░щЗПцШпхРжх░Сф║О I/O ч║┐чиЛцХ░щЗПчЪДф╕дхАНуАВ</p> <p>хжВцЮЬц╗бш╢│ф╕Кш┐░ф╗╗ф╕АцЭбф╗╢я╝МхИЩ <code>handleClientsWithPendingWritesUsingThreads</code> хЗ╜цХ░ф╕Нф╝ЪщЗЗчФихдЪч║┐чиЛхдДчРЖховцИ╖члпя╝МшАМцШпш░ГчФи <code>handleClientsWithPendingWrites</code> хЗ╜цХ░чФ▒ф╕╗ I/O ч║┐чиЛчЫ┤цОехдДчРЖх╛ЕхЖЩховцИ╖члпуАВш┐Щф╕╗шжБцШпф╕║ф║ЖхЬих╛ЕхЖЩховцИ╖члпцХ░щЗПш╛Гх░СцЧ╢я╝М<strong>шКВчЬБ CPU х╝АщФА</strong>уАВ</p> <p>ф╗еф╕ЛцШпцЭбф╗╢хИдцЦнщА╗ш╛Ся╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>io_threads_num <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> <span class="token function">stopThreadedIOIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">handleClientsWithPendingWrites</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цндхдЦя╝М<code>handleClientsWithPendingWritesUsingThreads</code> хЗ╜цХ░хЬичммф╕Ацнеф╕нш┐Шф╝ЪхИдцЦн I/O ч║┐чиЛцШпхРжх╖▓ц┐Ац┤╗уАВхжВцЮЬцЬкц┐Ац┤╗я╝МхИЩш░ГчФи <code>startThreadedIO</code> хЗ╜цХ░я╝Мх░ЖхЕих▒АхПШщЗП <code>server</code> чЪД <code>io_threads_active</code> цИРхСШхПШщЗПшо╛ч╜оф╕║ 1я╝Мф╗ешбичд║ I/O ч║┐чиЛх╖▓ц┐Ац┤╗уАВцндхИдцЦнцУНф╜ЬхжВф╕Ля╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>server<span class="token punctuation">.</span>io_threads_active<span class="token punctuation">)</span> <span class="token function">startThreadedIO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>цА╗ф╣Ля╝МRedis щАЪш┐З <code>handleClientsWithPendingWritesUsingThreads</code> хЗ╜цХ░х░Жх╛ЕхЖЩховцИ╖члпцМЙш╜ошпвцЦ╣х╝ПхИЖщЕНч╗ЩхРДф╕к I/O ч║┐чиЛя╝Мх╣╢чФ▒ш┐Щф║Ыч║┐чиЛш┤Яш┤гцХ░цНочЪДхЖЩхЫЮуАВ</p> <h2 id="redis-хдЪч║┐чиЛ-io-чЪДцАзшГ╜ш░Гф╝Шф╕ОхоЮщЩЕщЧощвШ"><a href="#redis-хдЪч║┐чиЛ-io-чЪДцАзшГ╜ш░Гф╝Шф╕ОхоЮщЩЕщЧощвШ" class="header-anchor">#</a> Redis хдЪч║┐чиЛ IO чЪДцАзшГ╜ш░Гф╝Шф╕ОхоЮщЩЕщЧощвШ</h2> <p>redis щ╗ШшодцГЕхЖ╡ф╕Лф╕Нф╝Ъх╝АхРпхдЪч║┐чиЛхдДчРЖя╝МхоШцЦ╣ф╣Ях╗║шооя╝МщЩдщЭЮцАзшГ╜ш╛╛хИ░чУ╢щвИя╝МхРжхИЩц▓бх┐ЕшжБх╝АхРпхдЪч║┐чиЛуАВ</p> <p><strong>щЕНч╜охдЪх░СхРИщАВя╝Я</strong></p> <p>хоШцЦ╣цЦЗцбг redis.conf ф╕нф╗Лч╗НцЬЙя╝Ъ</p> <blockquote><p>By default threading is disabled, we suggest enabling it only in machines
that have at least 4 or more cores, leaving at least one spare core.
Using more than 8 threads is unlikely to help much. We also recommend using
threaded I/O only if you actually have performance problems, with Redis
instances being able to use a quite big percentage of CPU time, otherwise
there is no point in using this feature.</p> <p>So for instance if you have a four cores boxes, try to use 2 or 3 I/O
threads, if you have a 8 cores, try to use 6 threads. In order to
enable I/O threads use the following configuration directive:</p></blockquote> <p>CPU 4 ца╕ф╗еф╕Кя╝МцЙНшАГшЩСх╝АхРпхдЪч║┐чиЛя╝МхЕ╢ф╕ня╝Ъ</p> <ul><li>4 ца╕х╝АхРп 2 - 3 ф╕к IO ч║┐чиЛ</li> <li>8 ца╕ х╝АхРп 6 ф╕к IO ч║┐чиЛ</li> <li>ш╢Еш┐З 8 ф╕к IO ч║┐чиЛя╝МцАзшГ╜цПРхНЗх╖▓ч╗Пф╕Нхдз</li></ul> <p>хА╝х╛Чц│ицДПчЪДцШпя╝Мф╗еф╕КчЪД IO ч║┐чиЛхЕ╢хоЮхМЕхРлф║Жф╕╗ч║┐чиЛуАВ</p> <p><strong>щЕНч╜оя╝Ъ</strong></p> <p>х╝АхРпхдЪч║┐чиЛя╝ЪщЕНч╜о io-thread хН│хПпуАВio-thread = 1 шбичд║хПкф╜┐чФиф╕╗ч║┐чиЛ</p> <blockquote><p>io-threads 4</p></blockquote> <p>х╝АхРпф╣ЛхРОя╝Мщ╗ШшодхЖЩцУНф╜Ьф╝ЪщАЪш┐ЗхдЪч║┐чиЛцЭехдДчРЖя╝МшАМшп╗цУНф╜ЬхИЩф╕Нф╝ЪуАВ</p> <p>хжВцЮЬшп╗цУНф╜Ьф╣ЯцГ│шжБх╝АхРпхдЪч║┐чиЛя╝МхИЩщЬАшжБщЕНч╜оя╝Ъ</p> <blockquote><p>io-threads-do-reads yes</p></blockquote> <h2 id="цА╗ч╗У"><a href="#цА╗ч╗У" class="header-anchor">#</a> цА╗ч╗У</h2> <p>ф╗Кхдйш┐ЩшКВшп╛я╝МцИСч╗Щф╜аф╗Лч╗Нф║Ж Redis 6.0 ф╕нцЦ░шо╛шобхоЮчО░чЪД<strong>хдЪ IO ч║┐чиЛцЬ║хИ╢</strong>уАВш┐Щф╕кцЬ║хИ╢чЪДшо╛шобф╕╗шжБцШпф╕║ф║Жф╜┐чФихдЪф╕к IO ч║┐чиЛя╝МцЭех╣╢хПСхдДчРЖховцИ╖члпшп╗хПЦцХ░цНоуАБшзгцЮРхС╜ф╗дхТМхЖЩхЫЮцХ░цНоуАВф╜┐чФиф║ЖхдЪч║┐чиЛхРОя╝МRedis х░▒хПпф╗ехЕЕхИЖхИйчФицЬНхКбхЩичЪДхдЪца╕чЙ╣цАзя╝Мф╗ОшАМ<strong>цПРщлШ IO цХИчОЗ</strong>уАВ</p> <p>цА╗ч╗УцЭешп┤я╝МRedis 6.0 хЕИцШпхЬихИЭхзЛхМЦш┐ЗчиЛф╕ня╝Мца╣цНочФицИ╖шо╛ч╜очЪД IO ч║┐чиЛцХ░щЗПя╝МхИЫх╗║хп╣х║ФцХ░щЗПчЪД IO ч║┐чиЛуАВ</p> <p>х╜У Redis server хИЭхзЛхМЦхоМцИРхРОцнгх╕╕ш┐РшбМцЧ╢я╝МхоГф╝ЪхЬи readQueryFromClient хЗ╜цХ░ф╕нщАЪш┐Зш░ГчФи postponeClientRead хЗ╜цХ░цЭехЖ│хоЪцШпхРжцОиш┐ЯховцИ╖члпшп╗цУНф╜ЬуАВхРМцЧ╢я╝МRedis server ф╝ЪхЬи addReply хЗ╜цХ░ф╕нщАЪш┐Зш░ГчФи prepareClientToWrite хЗ╜цХ░я╝МцЭехЖ│хоЪцШпхРжцОиш┐ЯховцИ╖члпхЖЩцУНф╜ЬуАВшАМх╛Ешп╗хЖЩчЪДховцИ╖члпф╝ЪшвлхИЖхИлхКахЕехИ░ clients_pending_read хТМ clients_pending_write ф╕дф╕кхИЧшбиф╕нуАВ</p> <p>ш┐Щца╖я╝МцпПх╜У Redis server шжБш┐ЫхЕеф║Лф╗╢х╛кчОпц╡БчиЛхЙНя╝МщГ╜ф╝ЪхЬи beforeSleep хЗ╜цХ░ф╕нхИЖхИлш░ГчФи handleClientsWithPendingReadsUsingThreads хЗ╜цХ░хТМ handleClientsWithPendingWritesUsingThreads хЗ╜цХ░я╝Мх░Жх╛Ешп╗хЖЩховцИ╖члп<strong>ф╗еш╜ошпвцЦ╣х╝ПхИЖщЕНч╗Щ IO ч║┐чиЛ</strong>я╝МхКахЕехИ░ IO ч║┐чиЛчЪДх╛ЕхдДчРЖховцИ╖члпхИЧшби io_threads_list ф╕нуАВ</p> <p>шАМ IO ч║┐чиЛф╕АцЧжш┐РшбМхРОя╝МцЬмш║лф╝Ъф╕АчЫ┤цгАц╡Л io_threads_list ф╕нчЪДховцИ╖члпя╝МхжВцЮЬцЬЙх╛Ешп╗хЖЩховцИ╖члпя╝МIO ч║┐чиЛх░▒ф╝Ъш░ГчФи readQueryFromClient цИЦ writeToClient хЗ╜цХ░цЭеш┐ЫшбМхдДчРЖуАВ</p> <p>цЬАхРОя╝МцИСф╣ЯцГ│хЖНцПРщЖТф╜аф╕Аф╕Ля╝М<strong>хдЪ IO ч║┐чиЛцЬмш║лх╣╢ф╕Нф╝ЪцЙзшбМхС╜ф╗д</strong>я╝МхоГф╗мхПкцШпхИйчФихдЪца╕х╣╢шбМхЬ░шп╗хПЦцХ░цНохТМшзгцЮРхС╜ф╗дя╝МцИЦцШпх░Ж server цХ░цНохЖЩхЫЮя╝Иф╕ЛшКВшп╛цИСш┐Шф╝Ъч╗УхРИхИЖх╕Гх╝ПщФБчЪДхОЯхнРцАзф┐ЭшпБя╝МцЭеч╗Щф╜аф╗Лч╗Нш┐Щф╕АщГихИЖчЪДц║РчаБхоЮчО░уАВя╝ЙуАВцЙАф╗ея╝М<strong>Redis цЙзшбМхС╜ф╗дчЪДч║┐чиЛш┐ШцШпф╕╗ч║┐чиЛ</strong>уАВш┐Щф╕АчВ╣хп╣ф║Оф╜ачРЖшзгхдЪ IO ч║┐чиЛцЬ║хИ╢х╛ИщЗНшжБя╝МхПпф╗ещБ┐хЕНф╜ашппшзг Redis цЬЙхдЪч║┐чиЛхРМцЧ╢цЙзшбМхС╜ф╗дуАВ</p> <p>ш┐Щца╖ф╕АцЭея╝МцИСф╗мхОЯцЭещТИхп╣ Redis хНХф╕кф╕╗ч║┐чиЛхБЪчЪДф╝ШхМЦф╗НчД╢цЬЙцХИя╝МцпФхжВщБ┐хЕН bigkeyуАБщБ┐хЕНщШ╗хбЮцУНф╜ЬчнЙуАВ</p> <h2 id="хПВшАГцЦЗчМо"><a href="#хПВшАГцЦЗчМо" class="header-anchor">#</a> хПВшАГцЦЗчМо</h2> <ul><li><a href="https://zhuanlan.zhihu.com/p/556726757" target="_blank" rel="noopener noreferrer">redis 6.0ф╣ЛхдЪч║┐чиЛя╝Мц╖▒хЕешзгшп╗ - чЯеф╣О (zhihu.com)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.zhihu.com/tardis/zm/art/144805500?source_id=1005" target="_blank" rel="noopener noreferrer">Redis 6.0 хдЪч║┐чиЛIOхдДчРЖш┐ЗчиЛшпжшзг (zhihu.com)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://time.geekbang.org/column/intro/100084301" target="_blank" rel="noopener noreferrer">Redis ц║РчаБхЙЦцЮРф╕ОхоЮцИШ (geekbang.org)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/echo-lxy/echo-system-design/edit/master/docs/Redis ч│╗ч╗Яшо╛шоб/03.ф╕ЙуАБф╕╗ч║┐ф╗╗хКб/16.Redis хдЪIOч║┐чиЛ.md" target="_blank" rel="noopener noreferrer">ч╝Цш╛С</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">ф╕КцмбцЫ┤цЦ░ф║О:</span> <span class="time">2024/09/18, 11:29:27</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        тЖР
        <a href="/pages/e6d8ef/" class="prev">Redis чЪДцЙзшбМцибх╝П</a></span> <span class="next"><a href="/pages/b43a19/">LRU чнЦчХе</a>тЖТ
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:lixinyang2002@163.com" title="хПСщВоф╗╢" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/echo-lxy" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="хРмщЯ│ф╣Р" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="цЬмчлЩф╕╗щвШ">Vdoing</a> 
    | Copyright ┬й 2024-2024
    <span>Xinyang Li | MIT License</span></div> <div class="buttons"><div title="ш┐ФхЫЮщб╢щГи" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="хО╗шпДшо║" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ф╕╗щвШцибх╝П" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          ш╖ЯщЪПч│╗ч╗Я
        </li><li class="iconfont icon-rijianmoshi">
          ц╡ЕшЙ▓цибх╝П
        </li><li class="iconfont icon-yejianmoshi">
          ц╖▒шЙ▓цибх╝П
        </li><li class="iconfont icon-yuedu">
          щШЕшп╗цибх╝П
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.bdcc6820.js" defer></script><script src="/assets/js/2.933750c6.js" defer></script><script src="/assets/js/70.b920a5f7.js" defer></script><script src="/assets/js/7.7eb70372.js" defer></script>
  </body>
</html>
