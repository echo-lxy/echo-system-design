<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ц╖▒хЕе Redis чЪДхдЪIOч║┐чиЛ | Echo ч│╗ч╗Яшо╛шобф╣Лч╛О</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="ц░┤ц╗┤чЯ│чй┐я╝Мшо╛шобцЧащУ╢х╝╣">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.bc6beed4.css" as="style"><link rel="preload" href="/assets/js/app.aaad5302.js" as="script"><link rel="preload" href="/assets/js/2.933750c6.js" as="script"><link rel="preload" href="/assets/js/50.9bff482f.js" as="script"><link rel="preload" href="/assets/js/7.7eb70372.js" as="script"><link rel="prefetch" href="/assets/js/10.2cc95be8.js"><link rel="prefetch" href="/assets/js/11.c7521a10.js"><link rel="prefetch" href="/assets/js/12.c0ea1b08.js"><link rel="prefetch" href="/assets/js/13.d9d26d25.js"><link rel="prefetch" href="/assets/js/14.1141ec27.js"><link rel="prefetch" href="/assets/js/15.61830f0a.js"><link rel="prefetch" href="/assets/js/16.f2ccbb47.js"><link rel="prefetch" href="/assets/js/17.1f44d5e0.js"><link rel="prefetch" href="/assets/js/18.e689f555.js"><link rel="prefetch" href="/assets/js/19.68db5844.js"><link rel="prefetch" href="/assets/js/20.b5e0fdf1.js"><link rel="prefetch" href="/assets/js/21.af1069aa.js"><link rel="prefetch" href="/assets/js/22.af583a75.js"><link rel="prefetch" href="/assets/js/23.f8a8e8e0.js"><link rel="prefetch" href="/assets/js/24.88b84218.js"><link rel="prefetch" href="/assets/js/25.acf70158.js"><link rel="prefetch" href="/assets/js/26.381f581c.js"><link rel="prefetch" href="/assets/js/27.e82ff876.js"><link rel="prefetch" href="/assets/js/28.6b737928.js"><link rel="prefetch" href="/assets/js/29.ebd14054.js"><link rel="prefetch" href="/assets/js/3.d9533589.js"><link rel="prefetch" href="/assets/js/30.ed6ead0e.js"><link rel="prefetch" href="/assets/js/31.89a26765.js"><link rel="prefetch" href="/assets/js/32.9a158243.js"><link rel="prefetch" href="/assets/js/33.a9dfc110.js"><link rel="prefetch" href="/assets/js/34.9740832c.js"><link rel="prefetch" href="/assets/js/35.017688d8.js"><link rel="prefetch" href="/assets/js/36.69f4f9a7.js"><link rel="prefetch" href="/assets/js/37.381f3758.js"><link rel="prefetch" href="/assets/js/38.3f232ff8.js"><link rel="prefetch" href="/assets/js/39.5259c5c3.js"><link rel="prefetch" href="/assets/js/4.73518a0f.js"><link rel="prefetch" href="/assets/js/40.6da9cd20.js"><link rel="prefetch" href="/assets/js/41.5525b2c4.js"><link rel="prefetch" href="/assets/js/42.9f3d0d39.js"><link rel="prefetch" href="/assets/js/43.d6629a36.js"><link rel="prefetch" href="/assets/js/44.ff4f9547.js"><link rel="prefetch" href="/assets/js/45.bcc663f0.js"><link rel="prefetch" href="/assets/js/46.bf329f04.js"><link rel="prefetch" href="/assets/js/47.bcbfaada.js"><link rel="prefetch" href="/assets/js/48.9c747df7.js"><link rel="prefetch" href="/assets/js/49.4732d3cb.js"><link rel="prefetch" href="/assets/js/5.dd198b3d.js"><link rel="prefetch" href="/assets/js/51.8c80377e.js"><link rel="prefetch" href="/assets/js/52.37d81e55.js"><link rel="prefetch" href="/assets/js/53.88841637.js"><link rel="prefetch" href="/assets/js/54.1a887e66.js"><link rel="prefetch" href="/assets/js/55.3c3f2203.js"><link rel="prefetch" href="/assets/js/56.590fc579.js"><link rel="prefetch" href="/assets/js/57.a2182867.js"><link rel="prefetch" href="/assets/js/58.28ea8ba4.js"><link rel="prefetch" href="/assets/js/59.d771376d.js"><link rel="prefetch" href="/assets/js/6.0b558b79.js"><link rel="prefetch" href="/assets/js/8.0ec7f6e8.js"><link rel="prefetch" href="/assets/js/9.6e274fca.js">
    <link rel="stylesheet" href="/assets/css/0.styles.bc6beed4.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="чЫох╜Х" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="Echo ч│╗ч╗Яшо╛шобф╣Лч╛О" class="logo"> <span class="site-name can-hide">Echo ч│╗ч╗Яшо╛шобф╣Лч╛О</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">ЁЯПащжЦщб╡</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">тЬТя╕ПчГнщЧичоЧц│Х</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ч│╗ч╗Яшо╛шоб</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/84cb49/" class="nav-link">шо╛шобхЯ║чбАшо╛цЦ╜</a></li><li class="dropdown-item"><!----> <a href="/pages/a95d7d/" class="nav-link">шо╛шобчГнщЧих║ФчФи</a></li><li class="dropdown-item"><!----> <a href="/pages/def08a/" class="nav-link">хЬ║цЩпшо╛шоб</a></li></ul></div></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">тЭУщЧочнФ</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ЁЯСАхКицАБ</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">ЁЯПащжЦщб╡</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">тЬТя╕ПчГнщЧичоЧц│Х</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ч│╗ч╗Яшо╛шоб</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/84cb49/" class="nav-link">шо╛шобхЯ║чбАшо╛цЦ╜</a></li><li class="dropdown-item"><!----> <a href="/pages/a95d7d/" class="nav-link">шо╛шобчГнщЧих║ФчФи</a></li><li class="dropdown-item"><!----> <a href="/pages/def08a/" class="nav-link">хЬ║цЩпшо╛шоб</a></li></ul></div></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">тЭУщЧочнФ</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ЁЯСАхКицАБ</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>цМЗхНЧ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>хЯ║чбА</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>ф╕╗ч║┐</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/34fa27/" class="sidebar-link">Linux ф╕нчЪД IO хдЪш╖пхдНчФи</a></li><li><a href="/pages/d4ecb9/" class="sidebar-link">Redis Server хИЭхзЛхМЦ</a></li><li><a href="/pages/d6b00d/" class="sidebar-link">Redis чЪД Reactor цибхЮЛ</a></li><li><a href="/pages/264b06/" class="sidebar-link">ц╖▒хЕе Redis ф║Лф╗╢щй▒хКицбЖцЮ╢</a></li><li><a href="/pages/e6d8ef/" class="sidebar-link">Redis чЪДцЙзшбМцибх╝П</a></li><li><a href="/pages/b4aed2/" class="sidebar-link">чоАш┐░ Redis хдЪч║┐чиЛ IO</a></li><li><a href="/pages/030696/" aria-current="page" class="active sidebar-link">ц╖▒хЕе Redis чЪДхдЪIOч║┐чиЛ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/030696/#хЙНшиА" class="sidebar-link">хЙНшиА</a></li><li class="sidebar-sub-header level2"><a href="/pages/030696/#хдЪ-io-ч║┐чиЛчЪДхИЭхзЛхМЦ" class="sidebar-link">хдЪ IO ч║┐чиЛчЪДхИЭхзЛхМЦ</a></li><li class="sidebar-sub-header level2"><a href="/pages/030696/#io-ч║┐чиЛчЪДш┐РшбМхЗ╜цХ░-iothreadmain" class="sidebar-link">IO ч║┐чиЛчЪДш┐РшбМхЗ╜цХ░ IOThreadMain</a></li><li class="sidebar-sub-header level2"><a href="/pages/030696/#хжВф╜ХцОиш┐ЯховцИ╖члпшп╗цУНф╜Ь" class="sidebar-link">хжВф╜ХцОиш┐ЯховцИ╖члпшп╗цУНф╜Ья╝Я</a></li><li class="sidebar-sub-header level2"><a href="/pages/030696/#хжВф╜ХцОиш┐ЯховцИ╖члпхЖЩцУНф╜Ь" class="sidebar-link">хжВф╜ХцОиш┐ЯховцИ╖члпхЖЩцУНф╜Ья╝Я</a></li><li class="sidebar-sub-header level2"><a href="/pages/030696/#хжВф╜ХцККх╛Ешп╗ховцИ╖члпхИЖщЕНч╗Щ-io-ч║┐чиЛцЙзшбМ" class="sidebar-link">хжВф╜ХцККх╛Ешп╗ховцИ╖члпхИЖщЕНч╗Щ IO ч║┐чиЛцЙзшбМя╝Я</a></li><li class="sidebar-sub-header level2"><a href="/pages/030696/#хжВф╜ХцККх╛ЕхЖЩховцИ╖члпхИЖщЕНч╗Щ-io-ч║┐чиЛцЙзшбМ" class="sidebar-link">хжВф╜ХцККх╛ЕхЖЩховцИ╖члпхИЖщЕНч╗Щ IO ч║┐чиЛцЙзшбМя╝Я</a></li><li class="sidebar-sub-header level2"><a href="/pages/030696/#цА╗ч╗У" class="sidebar-link">цА╗ч╗У</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>цФпч║┐</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>щЫЖч╛д</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="щжЦщб╡" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>Redis ч│╗ч╗Яшо╛шоб</span></li><li data-v-06225672><span data-v-06225672>ф╕╗ч║┐</span></li></ul> <div class="info" data-v-06225672><div title="ф╜ЬшАЕ" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/brother-one" target="_blank" title="ф╜ЬшАЕ" class="beLink" data-v-06225672>echo</a></div> <div title="хИЫх╗║цЧ╢щЧ┤" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-09-17</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">чЫох╜Х</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">ц╖▒хЕе Redis чЪДхдЪIOч║┐чиЛ<!----></h1> <div class="page-slot page-slot-top">
    <div class="wwads-cn wwads-horizontal page-wwads" data-id="136"></div>
    <style>
      .page-wwads{
        width:100%!important;
        min-height: 0;
        margin: 0;
      }
      .page-wwads .wwads-img img{
        width:80px!important;
      }
      .page-wwads .wwads-poweredby{
        width: 40px;
        position: absolute;
        right: 25px;
        bottom: 3px;
      }
      .wwads-content .wwads-text, .page-wwads .wwads-text{
        height: 100%;
        padding-top: 5px;
        display: block;
      }
  </style>
  </div> <div class="theme-vdoing-content content__default"><div class="custom-block note"><p class="custom-block-title">цПРхЗ║щЧощвШцШпф╕АхИЗцЩ║цЕзчЪДх╝Ачлп</p> <ul><li>хдЪч║┐чиЛ IO хжВф╜Хч╝УшзгщлШх╣╢хПСф╕ЛчЪДч╜Сч╗ЬчУ╢щвИя╝Я</li> <li>ф╕║ф╗Аф╣И Redis 6 хПкх░ЖхдЪч║┐чиЛчФиф║О IOя╝МшАМф╕НцШпхС╜ф╗дцЙзшбМя╝Яш┐ЩчзНшо╛шобчЪДф╝ШчВ╣я╝Я</li> <li>хРпчФихдЪ IO ч║┐чиЛхРОя╝МхжВф╜Хчбоф┐Эшп╖ц▒ВхдДчРЖчЪДщб║х║ПхТМф╕АшЗ┤цАзя╝Я</li> <li>Redis хжВф╜ХхЖ│хоЪцОиш┐Яшп╗хЖЩцУНф╜Ья╝Яш┐Щхп╣цАзшГ╜цЬЙф╜Хх╜▒хУНя╝Я</li> <li>хЬиф╗Аф╣ИцГЕхЖ╡ф╕ЛхРпчФихдЪ IO ч║┐чиЛхПНшАМф╝Ъхп╝шЗ┤цАзшГ╜ф╕ЛщЩНя╝ЯхжВф╜ХщБ┐хЕНя╝Я</li> <li>IO ч║┐чиЛщШЯхИЧц╗бш╜╜цЧ╢ч│╗ч╗Яф╝ЪхПСчФЯф╗Аф╣Ия╝ЯхжВф╜ХщШ▓цнвф╗╗хКбхаЖчзпя╝Я</li> <li>хдЪч║┐чиЛ IO цШпхРжщАВхРИцЙАцЬЙхЬ║цЩпя╝ЯхжВф╜ХхИдцЦнцШпхРжх║ФшпехРпчФия╝Я</li></ul></div> <h2 id="хЙНшиА"><a href="#хЙНшиА" class="header-anchor">#</a> хЙНшиА</h2> <p>цИСф╗мчЯещБУ Redis server хРпхКихРОчЪДш┐ЫчиЛф╝Ъф╗ехНХч║┐чиЛчЪДцЦ╣х╝Пя╝МцЙзшбМховцИ╖члпшп╖ц▒ВшзгцЮРхТМхдДчРЖх╖еф╜ЬуАВф╜ЖцШпя╝МRedis server ф╣Яф╝ЪщАЪш┐З bioInit хЗ╜цХ░хРпхКиф╕Йф╕кхРОхП░ч║┐чиЛя╝МцЭехдДчРЖхРОхП░ф╗╗хКбуАВф╣Ях░▒цШпшп┤я╝МRedis ф╕НхЖНшойф╕╗ч║┐чиЛцЙзшбМф╕Аф║ЫшАЧцЧ╢цУНф╜Ья╝МцпФхжВхРМцнехЖЩуАБхИащЩдчнЙя╝МшАМцШпф║дч╗ЩхРОхП░ч║┐чиЛх╝ВцнехоМцИРя╝Мф╗ОшАМщБ┐хЕНф║Жхп╣ф╕╗ч║┐чиЛчЪДщШ╗хбЮ</p> <p>хоЮщЩЕф╕Кя╝МхЬи 2020 х╣┤ 5 цЬИцОихЗ║чЪД Redis 6.0 чЙИцЬмф╕ня╝МRedis хЬицЙзшбМцибхЮЛф╕нш┐Шш┐Ыф╕Ацнеф╜┐чФиф║ЖхдЪч║┐чиЛцЭехдДчРЖ IO ф╗╗хКбя╝Мш┐Щца╖шо╛шобчЪДчЫочЪДя╝Мх░▒цШпф╕║ф║ЖхЕЕхИЖхИйчФих╜УхЙНцЬНхКбхЩичЪДхдЪца╕чЙ╣цАзя╝Мф╜┐чФихдЪца╕ш┐РшбМхдЪч║┐чиЛя╝МшойхдЪч║┐чиЛх╕охКйхКащАЯцХ░цНошп╗хПЦуАБхС╜ф╗дшзгцЮРф╗ехПКцХ░цНохЖЩхЫЮчЪДщАЯх║жя╝МцПРхНЗ Redis цХ┤ф╜УцАзшГ╜</p> <p><strong>щВгф╣Ия╝Мш┐Щф║ЫхдЪч║┐чиЛхЕ╖ф╜УцШпхЬиф╗Аф╣ИцЧ╢хАЩхРпхКия╝МхПИцШпщАЪш┐Зф╗Аф╣ИцЦ╣х╝ПцЭехдДчРЖ IO шп╖ц▒ВчЪДхСвя╝Я</strong></p> <p>echo цОеф╕ЛцЭеч╗Щф╜аф╗Лч╗Нф╕Л Redis 6.0 хоЮчО░чЪДхдЪ IO ч║┐чиЛцЬ║хИ╢уАВщАЪш┐Зш┐ЩщГихИЖхЖЕхо╣чЪДхнжф╣ая╝Мф╜ахПпф╗ехЕЕхИЖф║ЖшзгхИ░ Redis 6.0 цШпхжВф╜ХщАЪш┐ЗхдЪч║┐чиЛцЭецПРхНЗ IO шп╖ц▒ВхдДчРЖцХИчОЗчЪДуАВш┐Щца╖ф╜аф╣Ях░▒хПпф╗еч╗УхРИхоЮщЩЕф╕ЪхКбцЭешпДф╝░я╝МшЗкх╖▒цШпхРжщЬАшжБф╜┐чФи Redis 6.0 ф║ЖуАВ</p> <div class="custom-block warning"><p class="custom-block-title">ц│ицДП</p> <p>ф╜ащЬАшжБф╕Лш╜╜ <a href="https://github.com/redis/redis/tree/6.0" target="_blank" rel="noopener noreferrer">Redis 6.0.15<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> чЪДц║РчаБя╝Мф╗еф╛┐шГ╜цЯечЬЛхИ░хТМхдЪ IO ч║┐чиЛцЬ║хИ╢чЫ╕хЕ│чЪДф╗гчаБ</p></div> <h2 id="хдЪ-io-ч║┐чиЛчЪДхИЭхзЛхМЦ"><a href="#хдЪ-io-ч║┐чиЛчЪДхИЭхзЛхМЦ" class="header-anchor">#</a> хдЪ IO ч║┐чиЛчЪДхИЭхзЛхМЦ</h2> <p><a href="/pages/e6d8ef/">Redis чЪДцЙзшбМцибх╝П</a> ф╕нцЬЙцПРхИ░я╝ЪRedis 5.0 ф╕нчЪДф╕Йф╕кхРОхП░ч║┐чиЛя╝МцШп server хЬихИЭхзЛхМЦш┐ЗчиЛчЪДцЬАхРОя╝Мш░ГчФи InitSeverLast хЗ╜цХ░я╝МшАМ InitServerLast хЗ╜цХ░хЖНш┐Ыф╕Ацнеш░ГчФи bioInit хЗ╜цХ░цЭехоМцИРчЪДуАВхжВцЮЬцИСф╗мхЬи Redis 6.0 ф╕нцЯечЬЛ InitServerLast хЗ╜цХ░я╝Мф╝ЪхПСчО░хТМ Redis 5.0 чЫ╕цпФя╝МшпехЗ╜цХ░хЬиш░ГхоМ bioInit хЗ╜цХ░хРОя╝МхПИш░ГчФиф║Ж <strong>initThreadedIO хЗ╜цХ░</strong>уАВшАМ initThreadedIO хЗ╜цХ░цнгцШпчФицЭехИЭхзЛхМЦхдЪ IO ч║┐чиЛчЪДя╝Мш┐ЩщГихИЖчЪДф╗гчаБш░ГчФихжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-C extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">InitServerLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">bioInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">initThreadedIO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//ш░ГчФиinitThreadedIOхЗ╜цХ░хИЭхзЛхМЦIOч║┐чиЛ</span>
    <span class="token function">set_jemalloc_bg_thread</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>jemalloc_bg_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>initial_memory_usage <span class="token operator">=</span> <span class="token function">zmalloc_used_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цЙАф╗еф╕ЛщЭвя╝МцИСф╗мх░▒цЭечЬЛф╕Л initThreadedIO хЗ╜цХ░чЪДф╕╗шжБцЙзшбМц╡БчиЛя╝Мш┐Щф╕кхЗ╜цХ░цШпхЬи <a href="https://github.com/redis/redis/tree/5.0/src/networking.c" target="_blank" rel="noopener noreferrer">networking.c<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> цЦЗф╗╢ф╕нхоЮчО░чЪДуАВ</p> <p>**щжЦхЕИя╝МinitThreadedIO хЗ╜цХ░ф╝Ъшо╛ч╜о IO ч║┐чиЛчЪДц┐Ац┤╗цаЗх┐ЧуАВ**ш┐Щф╕кц┐Ац┤╗цаЗх┐Чф┐ЭхнШхЬи redisServer ч╗УцЮДф╜Уч▒╗хЮЛчЪДхЕих▒АхПШщЗП server х╜Уф╕ня╝Мхп╣х║Ф redisServer ч╗УцЮДф╜УчЪДцИРхСШхПШщЗП io_threads_activeуАВinitThreadedIO хЗ╜цХ░ф╝ЪцКК io_threads_active хИЭхзЛхМЦф╕║ 0я╝Мшбичд║ IO ч║┐чиЛш┐Шц▓бцЬЙшвлц┐Ац┤╗уАВш┐ЩщГихИЖф╗гчаБхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-C extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">initThreadedIO</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  server<span class="token punctuation">.</span>io_threads_active <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  тАж
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">ц│ицДП</p> <p>хИЪцЙНцПРхИ░чЪД<strong>хЕих▒АхПШщЗП server</strong> цШп Redis server ш┐РшбМцЧ╢я╝МчФицЭеф┐ЭхнШхРДчзНхЕих▒Аф┐бцБпчЪДч╗УцЮДф╜УхПШщЗПуАВцИСхЬич╗Щф╜аф╗Лч╗Н Redis server хИЭхзЛхМЦш┐ЗчиЛчЪДцЧ╢хАЩя╝МцПРхИ░ш┐З Redis server чЪДхРДчзНхПВцХ░хИЭхзЛхМЦщЕНч╜оя╝МщГ╜цШпф┐ЭхнШхЬиш┐Щф╕кхЕих▒АхПШщЗП server ф╕нчЪДуАВцЙАф╗ея╝Мх╜Уф╜ахЬищШЕшп╗ Redis ц║РчаБцЧ╢я╝МхжВцЮЬхЬицЯРф╕кхЗ╜цХ░ф╕нчЬЛхИ░хПШщЗП serverя╝МшжБчЯещБУхЕ╢хоЮх░▒цШпш┐Щф╕кхЕих▒АхПШщЗПуАВ</p></div> <p>**ч┤зцОечЭАя╝МinitThreadedIO хЗ╜цХ░ф╝Ъхп╣шо╛ч╜очЪД IO ч║┐чиЛцХ░щЗПш┐ЫшбМхИдцЦнуАВ**ш┐Щф╕кцХ░щЗПх░▒цШпф┐ЭхнШхЬихЕих▒АхПШщЗП server чЪДцИРхСШхПШщЗП io_threads_num ф╕нчЪДуАВщВгф╣ИхЬиш┐ЩщЗМя╝МIO ч║┐чиЛчЪДцХ░щЗПхИдцЦнф╝ЪцЬЙф╕ЙчзНч╗УцЮЬуАВ</p> <ul><li><p>хжВцЮЬ IO ч║┐чиЛцХ░щЗПф╕║ 1я╝Мх░▒шбичд║хПкцЬЙ 1 ф╕кф╕╗ IO ч║┐чиЛя╝МinitThreadedIO хЗ╜цХ░х░▒чЫ┤цОеш┐ФхЫЮф║ЖуАВцндцЧ╢я╝МRedis server чЪД IO ч║┐чиЛхТМ Redis 6.0 ф╣ЛхЙНчЪДчЙИцЬмцШпчЫ╕хРМчЪДуАВ</p> <ul><li><code>if (server.io_threads_num == 1) return;</code></li></ul></li> <li><p>хжВцЮЬ IO ч║┐чиЛцХ░щЗПхдзф║ОхоПхоЪф╣Й IO_THREADS_MAX_NUMя╝Ищ╗ШшодхА╝ф╕║ 128я╝Йя╝МщВгф╣И initThreadedIO хЗ╜цХ░ф╝ЪцКещФЩя╝Мх╣╢щААхЗ║цХ┤ф╕кчиЛх║П</p> <ul><li><div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>io_threads_num <span class="token operator">&gt;</span> IO_THREADS_MAX_NUM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        тАж  <span class="token comment">//цКещФЩцЧех┐Чшо░х╜Х</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//щААхЗ║чиЛх║П</span>
 <span class="token punctuation">}</span>
</code></pre></div></li></ul></li> <li><p>хжВцЮЬ IO ч║┐чиЛцХ░щЗПхдзф║О 1я╝Мх╣╢ф╕Фх░Пф║ОхоПхоЪф╣Й IO_THREADS_MAX_NUMя╝МщВгф╣Ия╝МinitThreadedIO хЗ╜цХ░ф╝ЪцЙзшбМф╕Аф╕кх╛кчОпц╡БчиЛя╝Мшпец╡БчиЛчЪДх╛кчОпцмбцХ░х░▒цШпшо╛ч╜очЪД IO ч║┐чиЛцХ░щЗП</p></li></ul> <p>хЬишпех╛кчОпц╡БчиЛф╕ня╝МinitThreadedIO хЗ╜цХ░х░▒ф╝Ъч╗Щф╗еф╕ЛхЫЫф╕кцХ░ч╗Дш┐ЫшбМхИЭхзЛхМЦцУНф╜Ь</p> <ul><li><strong>io_threads_list цХ░ч╗Д</strong>я╝Ъф┐ЭхнШф║ЖцпПф╕к IO ч║┐чиЛшжБхдДчРЖчЪДховцИ╖члпхИЧшбия╝Мх░ЖцХ░ч╗ДцпПф╕кхЕГч┤ахИЭхзЛхМЦф╕║ф╕Аф╕к List ч▒╗хЮЛчЪДхИЧшби</li> <li><strong>io_threads_pending цХ░ч╗Д</strong>я╝Ъф┐ЭхнШчнЙх╛ЕцпПф╕к IO ч║┐чиЛхдДчРЖчЪДховцИ╖члпф╕кцХ░</li> <li><strong>io_threads_mutex цХ░ч╗Д</strong>я╝Ъф┐ЭхнШч║┐чиЛф║ТцЦещФБ</li> <li><strong>io_threads цХ░ч╗Д</strong>я╝Ъф┐ЭхнШцпПф╕к IO ч║┐чиЛчЪДцППш┐░чмж</li></ul> <p>ш┐ЩхЫЫф╕кцХ░ч╗ДчЪДхоЪф╣ЙщГ╜хЬи networking.c цЦЗф╗╢ф╕ня╝МхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token class-name">pthread_t</span> io_threads<span class="token punctuation">[</span>IO_THREADS_MAX_NUM<span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">//шо░х╜Хч║┐чиЛцППш┐░чмжчЪДцХ░ч╗Д</span>
<span class="token class-name">pthread_mutex_t</span> io_threads_mutex<span class="token punctuation">[</span>IO_THREADS_MAX_NUM<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">//шо░х╜Хч║┐чиЛф║ТцЦещФБчЪДцХ░ч╗Д</span>
<span class="token keyword">_Atomic</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> io_threads_pending<span class="token punctuation">[</span>IO_THREADS_MAX_NUM<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">//шо░х╜Хч║┐чиЛх╛ЕхдДчРЖчЪДховцИ╖члпф╕кцХ░</span>
list <span class="token operator">*</span>io_threads_list<span class="token punctuation">[</span>IO_THREADS_MAX_NUM<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">//шо░х╜Хч║┐чиЛхп╣х║ФхдДчРЖчЪДховцИ╖члп</span>
</code></pre></div><p>чД╢хРОя╝МхЬихп╣ш┐Щф║ЫцХ░ч╗Дш┐ЫшбМхИЭхзЛхМЦчЪДхРМцЧ╢я╝МinitThreadedIO хЗ╜цХ░ш┐Шф╝Ъца╣цНо IO ч║┐чиЛцХ░щЗПя╝М<strong>ш░ГчФи pthread_create хЗ╜цХ░хИЫх╗║чЫ╕х║ФцХ░щЗПчЪДч║┐чиЛ</strong>уАВцИСхЬиф╕КшКВшп╛ч╗Щф╜аф╗Лч╗Нш┐Зя╝Мpthread_create хЗ╜цХ░чЪДхПВцХ░хМЕцЛмхИЫх╗║ч║┐чиЛшжБш┐РшбМчЪДхЗ╜цХ░хТМхЗ╜цХ░хПВцХ░я╝И*tidpуАБ*attrуАБ*start_routineуАБ*argя╝ЙуАВ</p> <p>цЙАф╗ея╝Мхп╣ф║О initThreadedIO хЗ╜цХ░цЭешп┤я╝МхоГхИЫх╗║чЪДч║┐чиЛшжБш┐РшбМчЪДхЗ╜цХ░цШп <strong>IOThreadMain</strong>я╝МхПВцХ░цШпх╜УхЙНхИЫх╗║ч║┐чиЛчЪДч╝ЦхП╖уАВф╕Нш┐ЗшжБц│ицДПчЪДцШпя╝Мш┐Щф╕кч╝ЦхП╖цШпф╗О 1 х╝АхзЛчЪДя╝Мч╝ЦхП╖ф╕║ 0 чЪДч║┐чиЛхЕ╢хоЮцШпш┐РшбМ Redis server ф╕╗ц╡БчиЛчЪДф╕╗ IO ч║┐чиЛуАВ</p> <p>ф╗еф╕Лф╗гчаБх░▒х▒Хчд║ф║Ж initThreadedIO хЗ╜цХ░хп╣цХ░ч╗ДчЪДхИЭхзЛхМЦя╝Мф╗ехПКхИЫх╗║ IO ч║┐чиЛчЪДш┐ЗчиЛя╝Мф╜ахПпф╗ечЬЛф╕ЛуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> server<span class="token punctuation">.</span>io_threads_num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
    io_threads_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">listCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//ч╝ЦхП╖ф╕║0чЪДч║┐чиЛцШпф╕╗IOч║┐чиЛ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span> 

    <span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>
    <span class="token comment">//хИЭхзЛхМЦio_threads_mutexцХ░ч╗Д</span>
    <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>io_threads_mutex<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">//хИЭхзЛхМЦio_threads_pendingцХ░ч╗Д</span>
    io_threads_pending<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   
    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>io_threads_mutex<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//ш░ГчФиpthread_createхЗ╜цХ░хИЫх╗║IOч║┐чиЛя╝Мч║┐чиЛш┐РшбМхЗ╜цХ░ф╕║IOThreadMain</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>IOThreadMain<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>i<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	тАж <span class="token comment">//хЗ║щФЩхдДчРЖ</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//хИЭхзЛхМЦio_threadsцХ░ч╗Дя╝Мшо╛ч╜охА╝ф╕║ч║┐чиЛцаЗшпЖ</span>
    io_threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> tid<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre></div><p>хе╜ф║Жя╝МчО░хЬицИСф╗мхЖНцЭечЬЛф╕Ля╝МхИЪцЙНф╗Лч╗НчЪД IO ч║┐чиЛхРпхКихРОшжБш┐РшбМчЪДхЗ╜цХ░ IOThreadMainуАВф║Жшзгш┐Щф╕кхЗ╜цХ░я╝МхПпф╗ех╕охКйцИСф╗мцОМцПб IO ч║┐чиЛхоЮщЩЕхБЪчЪДх╖еф╜Ь</p> <h2 id="io-ч║┐чиЛчЪДш┐РшбМхЗ╜цХ░-iothreadmain"><a href="#io-ч║┐чиЛчЪДш┐РшбМхЗ╜цХ░-iothreadmain" class="header-anchor">#</a> IO ч║┐чиЛчЪДш┐РшбМхЗ╜цХ░ IOThreadMain</h2> <p>IOThreadMain хЗ╜цХ░ф╣ЯцШпхЬи networking.c цЦЗф╗╢ф╕нхоЪф╣ЙчЪДя╝МхоГчЪДф╕╗шжБцЙзшбМщА╗ш╛СцШпф╕Аф╕к <strong>while(1) х╛кчОп</strong>уАВхЬиш┐Щф╕кх╛кчОпф╕ня╝МIOThreadMain хЗ╜цХ░ф╝ЪцКК io_threads_list цХ░ч╗Дф╕ня╝МцпПф╕к IO ч║┐чиЛхп╣х║ФчЪДхИЧшбишп╗хПЦхЗ║цЭеуАВ</p> <p>х░▒хГПцИСхЬихЙНщЭвч╗Щф╜аф╗Лч╗НчЪДф╕Аца╖я╝Мio_threads_list цХ░ч╗Дф╕нф╝ЪщТИхп╣цпПф╕к IO ч║┐чиЛя╝Мф╜┐чФиф╕Аф╕кхИЧшбишо░х╜Хшпеч║┐чиЛшжБхдДчРЖчЪДховцИ╖члпуАВцЙАф╗ея╝МIOThreadMain хЗ╜цХ░х░▒ф╝Ъф╗ОцпПф╕к IO ч║┐чиЛхп╣х║ФчЪДхИЧшбиф╕ня╝Мш┐Ыф╕АцнехПЦхЗ║шжБхдДчРЖчЪДховцИ╖члпя╝МчД╢хРОхИдцЦнч║┐чиЛшжБцЙзшбМчЪДцУНф╜ЬцаЗшо░уАВш┐Щф╕кцУНф╜ЬцаЗшо░цШпчФихПШщЗП io_threads_op шбичд║чЪДя╝МхоГцЬЙф╕дчзНхПЦхА╝уАВ</p> <ul><li><strong>io_threads_op чЪДхА╝ф╕║хоПхоЪф╣Й IO_THREADS_OP_WRITE</strong>я╝Ъш┐ЩшбицШОшпе IO ч║┐чиЛшжБхБЪчЪДцШпхЖЩцУНф╜Ья╝Мч║┐чиЛф╝Ъш░ГчФи writeToClient хЗ╜цХ░х░ЖцХ░цНохЖЩхЫЮховцИ╖члпуАВ</li> <li><strong>io_threads_op чЪДхА╝ф╕║хоПхоЪф╣Й IO_THREADS_OP_READ</strong>я╝Ъш┐ЩшбицШОшпе IO ч║┐чиЛшжБхБЪчЪДцШпшп╗цУНф╜Ья╝Мч║┐чиЛф╝Ъш░ГчФи readQueryFromClient хЗ╜цХ░ф╗ОховцИ╖члпшп╗хПЦцХ░цНоуАВ</li></ul> <p>ш┐ЩщГихИЖчЪДф╗гчаБщА╗ш╛Сф╜ахПпф╗ечЬЛчЬЛф╕ЛщЭвчЪДф╗гчаБуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">IOThreadMain</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>myid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    тАж
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       listIter li<span class="token punctuation">;</span>
       listNode <span class="token operator">*</span>ln<span class="token punctuation">;</span>
       <span class="token comment">//шО╖хПЦ IO ч║┐чиЛшжБхдДчРЖчЪДховцИ╖члпхИЧшби</span>
       <span class="token function">listRewind</span><span class="token punctuation">(</span>io_threads_list<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ln <span class="token operator">=</span> <span class="token function">listNext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>li<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          client <span class="token operator">*</span>c <span class="token operator">=</span> <span class="token function">listNodeValue</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//ф╗ОховцИ╖члпхИЧшбиф╕ншО╖хПЦф╕Аф╕кховцИ╖члп</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>io_threads_op <span class="token operator">==</span> IO_THREADS_OP_WRITE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token function">writeToClient</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//хжВцЮЬч║┐чиЛцУНф╜ЬцШпхЖЩцУНф╜Ья╝МхИЩш░ГчФиwriteToClientх░ЖцХ░цНохЖЩхЫЮховцИ╖члп</span>
           <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>io_threads_op <span class="token operator">==</span> IO_THREADS_OP_READ<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">readQueryFromClient</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//хжВцЮЬч║┐чиЛцУНф╜ЬцШпшп╗цУНф╜Ья╝МхИЩш░ГчФиreadQueryFromClientф╗ОховцИ╖члпшп╗хПЦцХ░цНо</span>
           <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token function">serverPanic</span><span class="token punctuation">(</span><span class="token string">&quot;io_threads_op value is unknown&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
       <span class="token function">listEmpty</span><span class="token punctuation">(</span>io_threads_list<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//хдДчРЖхоМцЙАцЬЙховцИ╖члпхРОя╝Мц╕Ечй║шпеч║┐чиЛчЪДховцИ╖члпхИЧшби</span>
       io_threads_pending<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//х░Жшпеч║┐чиЛчЪДх╛ЕхдДчРЖф╗╗хКбцХ░щЗПшо╛ч╜оф╕║0</span>

	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цИСф╣ЯчФ╗ф║Жф╕ЛщЭвш┐Щх╝ахЫ╛я╝Мх▒Хчд║ф║Ж IOThreadMain хЗ╜цХ░чЪДхЯ║цЬмц╡БчиЛя╝Мф╜ахПпф╗ечЬЛф╕ЛуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409171444793.png" alt="image-20240917144454718"></p> <p>хе╜ф║Жя╝МхИ░ш┐ЩщЗМф╜ах║Фшпех░▒ф║Жшзгф║Жя╝МцпПф╕Аф╕к IO ч║┐чиЛш┐РшбМцЧ╢я╝МщГ╜ф╝Ъф╕НцЦнцгАцЯецШпхРжцЬЙчнЙх╛ЕхоГхдДчРЖчЪДховцИ╖члпуАВхжВцЮЬцЬЙя╝Мх░▒ца╣цНоцУНф╜Ьч▒╗хЮЛя╝Мф╗ОховцИ╖члпшп╗хПЦцХ░цНоцИЦцШпх░ЖцХ░цНохЖЩхЫЮховцИ╖члпуАВф╜ахПпф╗ечЬЛхИ░я╝Мш┐Щф║ЫцУНф╜ЬщГ╜цШп Redis шжБхТМховцИ╖члпхоМцИРчЪД IO цУНф╜Ья╝МцЙАф╗ея╝Мш┐Щф╣ЯцШпф╕║ф╗Аф╣ИцИСф╗мцККш┐Щф║Ыч║┐чиЛчз░ф╕║ IO ч║┐чиЛчЪДхОЯхЫауАВ</p> <p>щВгф╣Ия╝Мф╜ачЬЛхИ░ш┐ЩщЗМя╝МхПпшГ╜ф╣Яф╝Ъф║зчФЯф╕Аф║ЫчЦСщЧоя╝М<strong>IO ч║┐чиЛшжБхдДчРЖчЪДховцИ╖члпцШпхжВф╜Хц╖╗хКахИ░ io_threads_list цХ░ч╗Дф╕нчЪДхСвя╝Я</strong></p> <p>ш┐Щх░▒шжБшп┤хИ░ Redis server хп╣х║ФчЪДхЕих▒АхПШщЗП server ф║ЖуАВserver хПШщЗПф╕нцЬЙф╕дф╕к List ч▒╗хЮЛчЪДцИРхСШхПШщЗПя╝Ъclients_pending_write хТМ clients_pending_readя╝МхоГф╗мхИЖхИлшо░х╜Хф║Жх╛ЕхЖЩхЫЮцХ░цНочЪДховцИ╖члпхТМх╛Ешп╗хПЦцХ░цНочЪДховцИ╖члпя╝МхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">//х╛ЕхЖЩхЫЮцХ░цНочЪДховцИ╖члп</span>
    list <span class="token operator">*</span>clients_pending_write<span class="token punctuation">;</span>  
    <span class="token comment">//х╛Ешп╗хПЦцХ░цНочЪДховцИ╖члп</span>
    list <span class="token operator">*</span>clients_pending_read<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ф╜ашжБчЯещБУя╝МRedis server хЬицОецФ╢хИ░ховцИ╖члпшп╖ц▒ВхТМч╗ЩховцИ╖члпш┐ФхЫЮцХ░цНочЪДш┐ЗчиЛф╕ня╝Мф╝Ъца╣цНоф╕АхоЪцЭбф╗╢я╝МцОиш┐ЯховцИ╖члпчЪДшп╗хЖЩцУНф╜Ья╝Мх╣╢хИЖхИлцККх╛Ешп╗хЖЩчЪДховцИ╖члпф┐ЭхнШхИ░ш┐Щф╕дф╕кхИЧшбиф╕нуАВчД╢хРОя╝МRedis server хЬицпПцмбш┐ЫхЕеф║Лф╗╢х╛кчОпхЙНя╝Мф╝ЪхЖНцККхИЧшбиф╕нчЪДховцИ╖члпц╖╗хКахИ░ io_threads_list цХ░ч╗Дф╕ня╝Мф║дч╗Щ IO ч║┐чиЛш┐ЫшбМхдДчРЖуАВ</p> <p>цЙАф╗ецОеф╕ЛцЭея╝МцИСф╗мх░▒хЕИцЭечЬЛф╕Ля╝МRedis цШпхжВф╜ХцОиш┐ЯховцИ╖члпчЪДшп╗хЖЩцУНф╜Ья╝Мх╣╢цККш┐Щф║ЫховцИ╖члпц╖╗хКахИ░ clients_pending_write хТМ clients_pending_read ш┐Щф╕дф╕кхИЧшбиф╕нчЪДуАВ</p> <h2 id="хжВф╜ХцОиш┐ЯховцИ╖члпшп╗цУНф╜Ь"><a href="#хжВф╜ХцОиш┐ЯховцИ╖члпшп╗цУНф╜Ь" class="header-anchor">#</a> хжВф╜ХцОиш┐ЯховцИ╖члпшп╗цУНф╜Ья╝Я</h2> <p>Redis server хЬихТМф╕Аф╕кховцИ╖члпх╗║члЛш┐ЮцОехРОя╝Мх░▒ф╝Ъх╝АхзЛчЫСхРмш┐Щф╕кховцИ╖члпф╕КчЪДхПпшп╗ф║Лф╗╢я╝МшАМхдДчРЖхПпшп╗ф║Лф╗╢чЪДхЫЮш░ГхЗ╜цХ░цШп <strong>readQueryFromClient</strong>уАВцИСхЬиxxxф╕нч╗Щф╜аф╗Лч╗Нф║Жш┐Щф╕кш┐ЗчиЛя╝Мф╜ахПпф╗ехЖНхО╗хЫЮщб╛ф╕ЛуАВ</p> <p>щВгф╣Иш┐ЩщЗМя╝МцИСф╗мхЖНцЭечЬЛф╕Л Redis 6.0 чЙИцЬмф╕нчЪД readQueryFromClient хЗ╜цХ░уАВш┐Щф╕кхЗ╜цХ░ф╕Ах╝АхзЛф╝ЪхЕИф╗Оф╝ахЕехПВцХ░ conn ф╕ншО╖хПЦховцИ╖члп cя╝Мч┤зцОечЭАх░▒ш░ГчФи postponeClientRead хЗ╜цХ░я╝МцЭехИдцЦнцШпхРжцОиш┐Яф╗ОховцИ╖члпшп╗хПЦцХ░цНоуАВш┐ЩщГихИЖчЪДцЙзшбМщА╗ш╛СхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">readQueryFromClient</span><span class="token punctuation">(</span>connection <span class="token operator">*</span>conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    client <span class="token operator">*</span>c <span class="token operator">=</span> <span class="token function">connGetPrivateData</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//ф╗Ош┐ЮцОецХ░цНоч╗УцЮДф╕ншО╖хПЦховцИ╖</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">postponeClientRead</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token comment">//хИдцЦнцШпхРжцОиш┐Яф╗ОховцИ╖члпшп╗хПЦцХ░цНо</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>чО░хЬия╝МцИСф╗мх░▒цЭечЬЛф╕Л <strong>postponeClientRead хЗ╜цХ░</strong>чЪДцЙзшбМщА╗ш╛СуАВш┐Щф╕кхЗ╜цХ░ф╝Ъца╣цНохЫЫф╕кцЭбф╗╢хИдцЦншГ╜хРжцОиш┐Яф╗ОховцИ╖члпшп╗хПЦцХ░цНоуАВ</p> <p><strong>цЭбф╗╢ф╕Ая╝ЪхЕих▒АхПШщЗП server чЪД io_threads_active хА╝ф╕║ 1</strong></p> <p>ш┐Щшбичд║хдЪ IO ч║┐чиЛх╖▓ч╗Пц┐Ац┤╗уАВцИСхИЪцЙНшп┤ш┐Зя╝Мш┐Щф╕кхПШщЗПхА╝хЬи initThreadedIO хЗ╜цХ░ф╕нцШпф╝ЪшвлхИЭхзЛхМЦф╕║ 0 чЪДя╝Мф╣Ях░▒цШпшп┤я╝МхдЪ IO ч║┐чиЛхИЭхзЛхМЦхРОя╝Мщ╗Шшодш┐Шц▓бцЬЙц┐Ац┤╗я╝ИцИСф╕Аф╝ЪхД┐ш┐Шф╝Ъч╗Щф╜аф╗Лч╗Нш┐Щф╕кхПШщЗПхА╝ф╜ХцЧ╢швлшо╛ч╜оф╕║ 1я╝ЙуАВ</p> <p><strong>цЭбф╗╢ф║Мя╝ЪхЕих▒АхПШщЗП server чЪД io_threads_do_read хА╝ф╕║ 1</strong></p> <p>ш┐Щшбичд║хдЪ IO ч║┐чиЛхПпф╗ечФиф║ОхдДчРЖх╗╢хРОцЙзшбМчЪДховцИ╖члпшп╗цУНф╜ЬуАВш┐Щф╕кхПШщЗПхА╝цШпхЬи Redis щЕНч╜оцЦЗф╗╢ redis.conf ф╕ня╝МщАЪш┐ЗщЕНч╜ощб╣ io-threads-do-reads шо╛ч╜очЪДя╝Мщ╗ШшодхА╝ф╕║ noя╝Мф╣Ях░▒цШпшп┤я╝МхдЪ IO ч║┐чиЛцЬ║хИ╢щ╗Шшодх╣╢ф╕Нф╝ЪчФиф║ОховцИ╖члпшп╗цУНф╜ЬуАВцЙАф╗ея╝МхжВцЮЬф╜ацГ│чФихдЪ IO ч║┐чиЛхдДчРЖховцИ╖члпшп╗цУНф╜Ья╝Мх░▒щЬАшжБцКК io-threads-do-reads щЕНч╜ощб╣шо╛ф╕║ yesуАВ</p> <p><strong>цЭбф╗╢ф╕Йя╝ЪProcessingEventsWhileBlocked хПШщЗПхА╝ф╕║ 0</strong></p> <p>ш┐Щшбичд║ processEventsWhileBlokced хЗ╜цХ░ц▓бцЬЙхЬицЙзшбМуАВProcessingEventsWhileBlocked цШпф╕Аф╕кхЕих▒АхПШщЗПя╝МхоГф╝ЪхЬи processEventsWhileBlokced хЗ╜цХ░цЙзшбМцЧ╢швлшо╛ч╜оф╕║ 1я╝МхЬи processEventsWhileBlokced хЗ╜цХ░цЙзшбМхоМцИРцЧ╢швлшо╛ч╜оф╕║ 0уАВ</p> <p>шАМ processEventsWhileBlokced хЗ╜цХ░цШпхЬи<a href="https://github.com/redis/redis/tree/5.0/src/networking.c" target="_blank" rel="noopener noreferrer">networking.c<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>цЦЗф╗╢ф╕нхоЮчО░чЪДуАВх╜У Redis хЬишп╗хПЦ RDB цЦЗф╗╢цИЦцШп AOF цЦЗф╗╢цЧ╢я╝Мш┐Щф╕кхЗ╜цХ░ф╝Ъшвлш░ГчФия╝МчФицЭехдДчРЖф║Лф╗╢щй▒хКицбЖцЮ╢цНХшО╖хИ░чЪДф║Лф╗╢уАВш┐Щца╖х░▒щБ┐хЕНф║ЖхЫашп╗хПЦ RDB цИЦ AOF цЦЗф╗╢щАацИР Redis щШ╗хбЮя╝МшАМцЧац│ХхПКцЧ╢хдДчРЖф║Лф╗╢чЪДцГЕхЖ╡уАВцЙАф╗ея╝Мх╜У processEventsWhileBlokced хЗ╜цХ░цЙзшбМхдДчРЖховцИ╖члпхПпшп╗ф║Лф╗╢цЧ╢я╝Мш┐Щф║ЫховцИ╖члпшп╗цУНф╜ЬцШпф╕Нф╝ЪшвлцОиш┐ЯцЙзшбМчЪДуАВ</p> <p><strong>цЭбф╗╢хЫЫя╝ЪховцИ╖члпчО░цЬЙцаЗшпЖф╕НшГ╜цЬЙ CLIENT_MASTERуАБCLIENT_SLAVE хТМ CLIENT_PENDING_READ</strong></p> <p>хЕ╢ф╕ня╝МCLIENT_MASTER хТМ CLIENT_SLAVE цаЗшпЖхИЖхИлшбичд║ховцИ╖члпцШпчФиф║Оф╕╗ф╗ОхдНхИ╢чЪДховцИ╖члпя╝Мф╣Ях░▒цШпшп┤я╝Мш┐Щф║ЫховцИ╖члпф╕Нф╝ЪцОиш┐Яшп╗цУНф╜ЬуАВCLIENT_PENDING_READ цЬмш║лх░▒шбичд║ф╕Аф╕кховцИ╖члпх╖▓ч╗Пшвлшо╛ч╜оф╕║цОиш┐Яшп╗цУНф╜Ьф║Жя╝МцЙАф╗ея╝Мхп╣ф║Ох╖▓х╕жцЬЙ CLIENT_PENDING_READ цаЗшпЖчЪДховцИ╖члпя╝МpostponeClientRead хЗ╜цХ░х░▒ф╕Нф╝ЪхЖНцОиш┐ЯхоГчЪДшп╗цУНф╜Ьф║ЖуАВ</p> <p>цА╗ф╣Ля╝МхПкцЬЙхЙНщЭвш┐ЩхЫЫф╕кцЭбф╗╢щГ╜ц╗бш╢│ф║Жя╝МpostponeClientRead хЗ╜цХ░цЙНф╝ЪцОиш┐Ях╜УхЙНховцИ╖члпчЪДшп╗цУНф╜ЬуАВхЕ╖ф╜УцЭешп┤я╝МpostponeClientRead хЗ╜цХ░ф╝Ъч╗ЩшпеховцИ╖члпшо╛ч╜о CLIENT_PENDING_REA цаЗшпЖя╝Мх╣╢ш░ГчФи listAddNodeHead хЗ╜цХ░я╝МцККш┐Щф╕кховцИ╖члпц╖╗хКахИ░хЕих▒АхПШщЗП server чЪД clients_pending_read хИЧшбиф╕нуАВ</p> <p>цИСцКК postponeClientRead хЗ╜цХ░чЪДф╗гчаБцФ╛хЬиш┐ЩщЗМя╝Мф╜ахПпф╗ечЬЛф╕ЛуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">postponeClientRead</span><span class="token punctuation">(</span>client <span class="token operator">*</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//хИдцЦнIOч║┐чиЛцШпхРжц┐Ац┤╗я╝М</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>io_threads_active <span class="token operator">&amp;&amp;</span> server<span class="token punctuation">.</span>io_threads_do_reads <span class="token operator">&amp;&amp;</span>      
         <span class="token operator">!</span>ProcessingEventsWhileBlocked <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>CLIENT_MASTER<span class="token operator">|</span>CLIENT_SLAVE<span class="token operator">|</span>CLIENT_PENDING_READ<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        c<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> CLIENT_PENDING_READ<span class="token punctuation">;</span> <span class="token comment">//ч╗ЩховцИ╖члпчЪДflagц╖╗хКаCLIENT_PENDING_READцаЗшо░я╝Мшбичд║цОиш┐ЯшпеховцИ╖члпчЪДшп╗цУНф╜Ь</span>
        <span class="token function">listAddNodeHead</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>clients_pending_read<span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//х░ЖховцИ╖члпц╖╗хКахИ░clients_pending_readхИЧшбиф╕н</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хе╜я╝МчО░хЬиф╜ах╖▓ч╗ПчЯещБУя╝МRedis цШпхЬиховцИ╖члпшп╗ф║Лф╗╢хЫЮш░ГхЗ╜цХ░ readQueryFromClient ф╕ня╝МщАЪш┐Зш░ГчФи postponeClientRead хЗ╜цХ░цЭехИдцЦнхТМцОиш┐ЯховцИ╖члпшп╗цУНф╜ЬуАВф╕ЛщЭвя╝МцИСхЖНх╕жф╜ацЭечЬЛф╕Л Redis цШпхжВф╜ХцОиш┐ЯховцИ╖члпхЖЩцУНф╜ЬчЪД</p> <h2 id="хжВф╜ХцОиш┐ЯховцИ╖члпхЖЩцУНф╜Ь"><a href="#хжВф╜ХцОиш┐ЯховцИ╖члпхЖЩцУНф╜Ь" class="header-anchor">#</a> хжВф╜ХцОиш┐ЯховцИ╖члпхЖЩцУНф╜Ья╝Я</h2> <p>Redis хЬицЙзшбМф║ЖховцИ╖члпхС╜ф╗дя╝МшжБч╗ЩховцИ╖члпш┐ФхЫЮч╗УцЮЬцЧ╢я╝Мф╝Ъш░ГчФи **addReply хЗ╜цХ░ **х░Жх╛Еш┐ФхЫЮч╗УцЮЬхЖЩхЕеховцИ╖члпш╛УхЗ║ч╝УхЖ▓хМ║уАВ</p> <p>шАМхЬи addReply хЗ╜цХ░чЪДф╕Ах╝АхзЛя╝МшпехЗ╜цХ░ф╝Ъш░ГчФи <strong>prepareClientToWrite хЗ╜цХ░</strong>я╝МцЭехИдцЦнцШпхРжцОиш┐ЯцЙзшбМховцИ╖члпхЖЩцУНф╜ЬуАВф╕ЛщЭвф╗гчаБх▒Хчд║ф║Ж addReply хЗ╜цХ░хп╣ prepareClientToWrite хЗ╜цХ░чЪДш░ГчФия╝Мф╜ахПпф╗ечЬЛф╕ЛуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">addReply</span><span class="token punctuation">(</span>client <span class="token operator">*</span>c<span class="token punctuation">,</span> robj <span class="token operator">*</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">prepareClientToWrite</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">!=</span> C_OK<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цЙАф╗еш┐ЩщЗМя╝МцИСф╗мч╗зч╗нцЭечЬЛф╕Л prepareClientToWrite хЗ╜цХ░уАВш┐Щф╕кхЗ╜цХ░ф╝Ъца╣цНоховцИ╖члпшо╛ч╜очЪДцаЗшпЖш┐ЫшбМф╕Ач│╗хИЧчЪДхИдцЦнуАВхЕ╢ф╕ня╝МшпехЗ╜цХ░ф╝Ъш░ГчФи <strong>clientHasPendingReplies хЗ╜цХ░</strong>я╝МхИдцЦнх╜УхЙНховцИ╖члпцШпхРжш┐ШцЬЙчХЩхнШхЬиш╛УхЗ║ч╝УхЖ▓хМ║ф╕нчЪДцХ░цНочнЙх╛ЕхЖЩхЫЮуАВ</p> <p>хжВцЮЬц▓бцЬЙчЪДшпЭя╝МщВгф╣Ия╝МprepareClientToWrite х░▒ф╝Ъш░ГчФи <strong>clientInstallWriteHandler хЗ╜цХ░</strong>я╝МхЖНш┐Ыф╕АцнехИдцЦншГ╜хРжцОиш┐ЯшпеховцИ╖члпхЖЩцУНф╜ЬуАВф╕ЛщЭвчЪДф╗гчаБх▒Хчд║ф║Жш┐Щф╕Аш░ГчФиш┐ЗчиЛя╝Мф╜ахПпф╗ечЬЛф╕ЛуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">prepareClientToWrite</span><span class="token punctuation">(</span>client <span class="token operator">*</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token comment">//хжВцЮЬх╜УхЙНховцИ╖члпц▓бцЬЙх╛ЕхЖЩхЫЮцХ░цНоя╝Мш░ГчФиclientInstallWriteHandlerхЗ╜цХ░</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">clientHasPendingReplies</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">clientInstallWriteHandler</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>щВгф╣Иш┐Щца╖ф╕АцЭея╝МцИСф╗мхЕ╢хоЮх░▒чЯещБУф║Жя╝МшГ╜хРжцОиш┐ЯховцИ╖члпхЖЩцУНф╜Ья╝МцЬАч╗ИцШпчФ▒ clientInstallWriteHandler хЗ╜цХ░цЭехЖ│хоЪчЪДя╝Мш┐Щф╕кхЗ╜цХ░ф╝ЪхИдцЦнф╕дф╕кцЭбф╗╢уАВ</p> <ul><li><strong>цЭбф╗╢ф╕А</strong>я╝ЪховцИ╖члпц▓бцЬЙшо╛ч╜ош┐З CLIENT_PENDING_WRITE цаЗшпЖя╝МхН│ц▓бцЬЙшвлцОиш┐Яш┐ЗцЙзшбМхЖЩцУНф╜ЬуАВ</li> <li><strong>цЭбф╗╢ф║М</strong>я╝ЪховцИ╖члпцЙАхЬихоЮф╛Лц▓бцЬЙш┐ЫшбМф╕╗ф╗ОхдНхИ╢я╝МцИЦшАЕховцИ╖члпцЙАхЬихоЮф╛ЛцШпф╕╗ф╗ОхдНхИ╢ф╕нчЪДф╗ОшКВчВ╣я╝Мф╜ЖхЕищЗПхдНхИ╢чЪД RDB цЦЗф╗╢х╖▓ч╗Пф╝аш╛УхоМцИРя╝МховцИ╖члпхПпф╗ецОецФ╢шп╖ц▒ВуАВ</li></ul> <p>ф╕АцЧжш┐Щф╕дф╕кцЭбф╗╢щГ╜ц╗бш╢│ф║Жя╝МclientInstallWriteHandler хЗ╜цХ░х░▒ф╝ЪцККховцИ╖члпцаЗшпЖшо╛ч╜оф╕║ CLIENT_PENDING_WRITEя╝Мшбичд║цОиш┐ЯшпеховцИ╖члпчЪДхЖЩцУНф╜ЬуАВхРМцЧ╢я╝МclientInstallWriteHandler хЗ╜цХ░ф╝ЪцККш┐Щф╕кховцИ╖члпц╖╗хКахИ░хЕих▒АхПШщЗП server чЪДх╛ЕхЖЩхЫЮховцИ╖члпхИЧшбиф╕ня╝Мф╣Ях░▒цШп clients_pending_write хИЧшбиф╕нуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">clientInstallWriteHandler</span><span class="token punctuation">(</span>client <span class="token operator">*</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//хжВцЮЬховцИ╖члпц▓бцЬЙшо╛ч╜ош┐ЗCLIENT_PENDING_WRITEцаЗшпЖя╝Мх╣╢ф╕ФховцИ╖члпц▓бцЬЙхЬиш┐ЫшбМф╕╗ф╗ОхдНхИ╢я╝МцИЦшАЕховцИ╖члпцШпф╕╗ф╗ОхдНхИ╢ф╕нчЪДф╗ОшКВчВ╣я╝Мх╖▓ч╗ПшГ╜цОецФ╢шп╖ц▒В</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> CLIENT_PENDING_WRITE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>replstate <span class="token operator">==</span> REPL_STATE_NONE <span class="token operator">||</span>
         <span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>replstate <span class="token operator">==</span> SLAVE_STATE_ONLINE <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>c<span class="token operator">-&gt;</span>repl_put_online_on_ack<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//х░ЖховцИ╖члпчЪДцаЗшпЖшо╛ч╜оф╕║х╛ЕхЖЩхЫЮя╝МхН│CLIENT_PENDING_WRITE</span>
        c<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> CLIENT_PENDING_WRITE<span class="token punctuation">;</span>
        <span class="token function">listAddNodeHead</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>clients_pending_write<span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//х░ЖхПпшО╖х╛ЧхКахЕеclients_pending_writeхИЧшби</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ф╕║ф║Жф╛┐ф║Оф╜ацЫ┤хе╜хЬ░чРЖшзгя╝МцИСчФ╗ф║Жф╕Ах╝ахЫ╛я╝Мх▒Хчд║ф║Ж Redis цОиш┐ЯховцИ╖члпхЖЩцУНф╜ЬчЪДхЗ╜цХ░ш░ГчФихЕ│ч│╗я╝Мф╜ахПпф╗ехЖНхЫЮщб╛ф╕ЛуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409171450799.png" alt="image-20240917145036743"></p> <p>ф╕Нш┐Зя╝Мх╜У Redis ф╜┐чФи clients_pending_read хТМ clients_pending_write ф╕дф╕кхИЧшбия╝Мф┐ЭхнШф║ЖцОиш┐ЯцЙзшбМчЪДховцИ╖члпхРОя╝М**ш┐Щф║ЫховцИ╖члпхПИцШпхжВф╜ХхИЖщЕНч╗ЩхдЪ IO ч║┐чиЛцЙзшбМчЪДхСвя╝Я**ш┐Щх░▒хТМф╕ЛщЭвф╕дф╕кхЗ╜цХ░чЫ╕хЕ│ф║ЖуАВ</p> <ul><li>handleClientsWithPendingReadsUsingThreads хЗ╜цХ░я╝ЪшпехЗ╜цХ░ф╕╗шжБш┤Яш┤гх░Ж clients_pending_read хИЧшбиф╕нчЪДховцИ╖члпхИЖщЕНч╗Щ IO ч║┐чиЛш┐ЫшбМхдДчРЖуАВ</li> <li>handleClientsWithPendingWritesUsingThreads хЗ╜цХ░я╝ЪшпехЗ╜цХ░ф╕╗шжБш┤Яш┤гх░Ж clients_pending_write хИЧшбиф╕нчЪДховцИ╖члпхИЖщЕНч╗Щ IO ч║┐чиЛш┐ЫшбМхдДчРЖуАВ</li></ul> <p>цЙАф╗ецОеф╕ЛцЭея╝МцИСф╗мх░▒цЭечЬЛф╕Лш┐Щф╕дф╕кхЗ╜цХ░чЪДхЕ╖ф╜УцУНф╜ЬуАВ</p> <h2 id="хжВф╜ХцККх╛Ешп╗ховцИ╖члпхИЖщЕНч╗Щ-io-ч║┐чиЛцЙзшбМ"><a href="#хжВф╜ХцККх╛Ешп╗ховцИ╖члпхИЖщЕНч╗Щ-io-ч║┐чиЛцЙзшбМ" class="header-anchor">#</a> хжВф╜ХцККх╛Ешп╗ховцИ╖члпхИЖщЕНч╗Щ IO ч║┐чиЛцЙзшбМя╝Я</h2> <p>щжЦхЕИя╝МцИСф╗мцЭеф║Жшзг <strong>handleClientsWithPendingReadsUsingThreads хЗ╜цХ░</strong>уАВш┐Щф╕кхЗ╜цХ░цШпхЬи beforeSleep хЗ╜цХ░ф╕нш░ГчФичЪДуАВ</p> <p>хЬи Redis 6.0 чЙИцЬмчЪДф╗гчаБф╕ня╝Мф║Лф╗╢щй▒хКицбЖцЮ╢хРМца╖цШпш░ГчФи aeMain хЗ╜цХ░цЭецЙзшбМф║Лф╗╢х╛кчОпц╡БчиЛя╝Мшпех╛кчОпц╡БчиЛф╝Ъш░ГчФи aeProcessEvents хЗ╜цХ░хдДчРЖхРДчзНф║Лф╗╢уАВшАМхЬи aeProcessEvents хЗ╜цХ░хоЮщЩЕш░ГчФи aeApiPoll хЗ╜цХ░цНХшО╖ IO ф║Лф╗╢ф╣ЛхЙНя╝МbeforeSleep хЗ╜цХ░ф╝Ъшвлш░ГчФиуАВ</p> <p>ш┐Щф╕кш┐ЗчиЛхжВф╕ЛхЫ╛цЙАчд║я╝Мф╜ахПпф╗ечЬЛф╕ЛуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409171451107.png" alt="image-20240917145125065"></p> <p>handleClientsWithPendingReadsUsingThreads хЗ╜цХ░чЪДф╕╗шжБцЙзшбМщА╗ш╛СхПпф╗ехИЖцИРхЫЫцнеуАВ</p> <p><strong>чммф╕Ацне</strong>я╝МшпехЗ╜цХ░ф╝ЪхЕИца╣цНохЕих▒АхПШщЗП server чЪД io_threads_active цИРхСШхПШщЗПя╝МхИдхоЪ IO ч║┐чиЛцШпхРжц┐Ац┤╗я╝Мх╣╢ф╕Фца╣цНо server чЪД io_threads_do_reads цИРхСШхПШщЗПя╝МхИдхоЪчФицИ╖цШпхРжшо╛ч╜оф║Ж Redis хПпф╗ечФи IO ч║┐чиЛхдДчРЖх╛Ешп╗ховцИ╖члпуАВхПкцЬЙхЬи IO ч║┐чиЛц┐Ац┤╗я╝Мх╣╢ф╕Ф IO ч║┐чиЛхПпф╗ечФиф║ОхдДчРЖх╛Ешп╗ховцИ╖члпцЧ╢я╝МhandleClientsWithPendingReadsUsingThreads хЗ╜цХ░цЙНф╝Ъч╗зч╗нцЙзшбМя╝МхРжхИЩшпехЗ╜цХ░х░▒чЫ┤цОеч╗УцЭЯш┐ФхЫЮф║ЖуАВш┐Щф╕АцнечЪДхИдцЦнщА╗ш╛СхжВф╗еф╕Лф╗гчаБцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>server<span class="token punctuation">.</span>io_threads_active <span class="token operator">||</span> <span class="token operator">!</span>server<span class="token punctuation">.</span>io_threads_do_reads<span class="token punctuation">)</span> 
<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>чммф║Мцне</strong>я╝МhandleClientsWithPendingReadsUsingThreads хЗ╜цХ░ф╝ЪшО╖хПЦ clients_pending_read хИЧшбичЪДщХ┐х║жя╝Мш┐Щф╗гшбиф║ЖшжБхдДчРЖчЪДх╛Ешп╗ховцИ╖члпф╕кцХ░уАВчД╢хРОя╝МшпехЗ╜цХ░ф╝Ъф╗О clients_pending_read хИЧшбиф╕нщАРф╕АхПЦхЗ║х╛ЕхдДчРЖчЪДховцИ╖члпя╝Мх╣╢чФиховцИ╖члпхЬихИЧшбиф╕нчЪДх║ПхП╖я╝Мхп╣ IO ч║┐чиЛцХ░щЗПш┐ЫшбМхПЦцибш┐РчоЧуАВ</p> <p>ш┐Щца╖ф╕АцЭея╝МцИСф╗мх░▒хПпф╗еца╣цНохПЦцибх╛ЧхИ░чЪДф╜ЩцХ░я╝МцККшпеховцИ╖члпхИЖщЕНч╗Щхп╣х║ФчЪД IO ч║┐чиЛш┐ЫшбМхдДчРЖуАВч┤зцОечЭАя╝МhandleClientsWithPendingReadsUsingThreads хЗ╜цХ░ф╝Ъ<strong>ш░ГчФи listAddNodeTail хЗ╜цХ░я╝МцККхИЖщЕНхе╜чЪДховцИ╖члпц╖╗хКахИ░ io_threads_list хИЧшбичЪДчЫ╕х║ФхЕГч┤аф╕н</strong>уАВцИСхИЪцЙНч╗Щф╜аф╗Лч╗Нш┐Зя╝Мio_threads_list цХ░ч╗ДчЪДцпПф╕кхЕГч┤ацШпф╕Аф╕кхИЧшбия╝Мхп╣х║Фф┐ЭхнШф║ЖцпПф╕к IO ч║┐чиЛшжБхдДчРЖчЪДховцИ╖члпуАВ</p> <p>ф╕║ф║Жф╛┐ф║Оф╜ачРЖшзгя╝МцИСцЭеч╗Щф╜аф╕╛ф╕кф╛ЛхнРуАВ</p> <p>хБЗшо╛ IO ч║┐чиЛцХ░щЗПшо╛ч╜оф╕║ 3я╝Мclients_pending_read хИЧшбиф╕нф╕АхЕ▒цЬЙ 5 ф╕кх╛Ешп╗ховцИ╖члпя╝МхоГф╗мхЬихИЧшбиф╕нчЪДх║ПхП╖хИЖхИлцШп 0я╝М1я╝М2я╝М3 хТМ 4уАВхЬиш┐Щф╕Ацнеф╕ня╝М0 хП╖хИ░ 4 хП╖ховцИ╖члпхп╣ч║┐чиЛцХ░щЗП 3 хПЦцибчЪДч╗УцЮЬхИЖхИлцШп 0я╝М1я╝М2я╝М0я╝М1я╝Мш┐Щф╣Яхп╣х║Фф║ЖхН│х░ЖхдДчРЖш┐Щф║ЫховцИ╖члпчЪД IO ч║┐чиЛч╝ЦхП╖уАВш┐Щф╣Ях░▒цШпшп┤я╝М0 хП╖ховцИ╖члпчФ▒ 0 хП╖ч║┐чиЛхдДчРЖя╝М1 хП╖ховцИ╖члпцЬЙ 1 хП╖ч║┐чиЛхдДчРЖя╝Мф╗ецндч▒╗цОиуАВф╜ахПпф╗ечЬЛхИ░я╝Мш┐Щф╕кхИЖщЕНцЦ╣х╝ПхЕ╢хоЮх░▒цШпцККх╛ЕхдДчРЖховцИ╖члпя╝Мф╗е<strong>ш╜ошпвцЦ╣х╝П</strong>щАРф╕АхИЖщЕНч╗ЩхРДф╕к IO ч║┐чиЛуАВ</p> <p>цИСчФ╗ф║Жф╕ЛщЭвш┐Щх╝ахЫ╛я╝Мх▒Хчд║ф║Жш┐Щф╕кхИЖщЕНч╗УцЮЬя╝Мф╜ахПпф╗ехЖНчЬЛф╕ЛуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409171451572.png" alt="image-20240917145140527"></p> <p>ф╗еф╕Лф╗гчаБх▒Хчд║чЪДх░▒цШпф╗еш╜ошпвцЦ╣х╝Пх░ЖховцИ╖члпхИЖщЕНч╗Щ IO ч║┐чиЛчЪДцЙзшбМщА╗ш╛Ся╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> processed <span class="token operator">=</span> <span class="token function">listLength</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>clients_pending_read<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">listRewind</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>clients_pending_read<span class="token punctuation">,</span><span class="token operator">&amp;</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> item_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ln <span class="token operator">=</span> <span class="token function">listNext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>li<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        client <span class="token operator">*</span>c <span class="token operator">=</span> <span class="token function">listNodeValue</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> target_id <span class="token operator">=</span> item_id <span class="token operator">%</span> server<span class="token punctuation">.</span>io_threads_num<span class="token punctuation">;</span>
        <span class="token function">listAddNodeTail</span><span class="token punctuation">(</span>io_threads_list<span class="token punctuation">[</span>target_id<span class="token punctuation">]</span><span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        item_id<span class="token operator">++</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre></div><p>ш┐Щца╖я╝Мх╜У handleClientsWithPendingReadsUsingThreads хЗ╜цХ░хоМцИРховцИ╖члпчЪД IO ч║┐чиЛхИЖщЕНф╣ЛхРОя╝МхоГф╝Ъх░Ж IO ч║┐чиЛчЪДцУНф╜ЬцаЗшпЖшо╛ч╜оф╕║<strong>шп╗цУНф╜Ь</strong>я╝Мф╣Ях░▒цШп IO_THREADS_OP_READуАВчД╢хРОя╝МхоГф╝ЪщБНхОЖ io_threads_list цХ░ч╗Дф╕нчЪДцпПф╕кхЕГч┤ахИЧшбищХ┐х║жя╝МчнЙх╛ЕцпПф╕кч║┐чиЛхдДчРЖчЪДховцИ╖члпцХ░щЗПя╝Мш╡ЛхА╝ч╗Щ io_threads_pending цХ░ч╗ДуАВш┐Щф╕Аш┐ЗчиЛхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code> io_threads_op <span class="token operator">=</span> IO_THREADS_OP_READ<span class="token punctuation">;</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> server<span class="token punctuation">.</span>io_threads_num<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">listLength</span><span class="token punctuation">(</span>io_threads_list<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        io_threads_pending<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> count<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre></div><p><strong>чммф╕Йцне</strong>я╝МhandleClientsWithPendingReadsUsingThreads хЗ╜цХ░ф╝Ъх░Ж io_threads_list цХ░ч╗Д 0 хП╖хИЧшбия╝Иф╣Ях░▒цШп io_threads_list[0]хЕГч┤ая╝Йф╕нчЪДх╛Ешп╗ховцИ╖члпщАРф╕АхПЦхЗ║цЭея╝Мх╣╢ш░ГчФи readQueryFromClient хЗ╜цХ░ш┐ЫшбМхдДчРЖуАВ</p> <p>хЕ╢хоЮя╝МhandleClientsWithPendingReadsUsingThreads хЗ╜цХ░цЬмш║лх░▒цШпчФ▒ IO ф╕╗ч║┐чиЛцЙзшбМчЪДя╝МшАМ io_threads_list цХ░ч╗Дхп╣х║ФчЪД 0 хП╖ч║┐чиЛцнгцШп IO ф╕╗ч║┐чиЛя╝МцЙАф╗ея╝Мш┐ЩщЗМх░▒цШпшойф╕╗ IO ч║┐чиЛцЭехдДчРЖхоГчЪДх╛Ешп╗ховцИ╖члпуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code>  <span class="token function">listRewind</span><span class="token punctuation">(</span>io_threads_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//шО╖хПЦ0хП╖хИЧшбиф╕нчЪДцЙАцЬЙховцИ╖члп</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ln <span class="token operator">=</span> <span class="token function">listNext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>li<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        client <span class="token operator">*</span>c <span class="token operator">=</span> <span class="token function">listNodeValue</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">readQueryFromClient</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">listEmpty</span><span class="token punctuation">(</span>io_threads_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//хдДчРЖхоМхРОя╝Мц╕Ечй║0хП╖хИЧшби</span>
</code></pre></div><p>ч┤зцОечЭАя╝МhandleClientsWithPendingReadsUsingThreads хЗ╜цХ░ф╝ЪцЙзшбМф╕Аф╕к while(1) х╛кчОпя╝МчнЙх╛ЕцЙАцЬЙ IO ч║┐чиЛхоМцИРх╛Ешп╗ховцИ╖члпчЪДхдДчРЖя╝МхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> pending <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> server<span class="token punctuation">.</span>io_threads_num<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
            pending <span class="token operator">+=</span> io_threads_pending<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pending <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><strong>чммхЫЫцне</strong>я╝МhandleClientsWithPendingReadsUsingThreads хЗ╜цХ░ф╝ЪхЖНцмбщБНхОЖф╕АщБН clients_pending_read хИЧшбия╝Мф╛ЭцмбхПЦхЗ║хЕ╢ф╕нчЪДховцИ╖члпуАВч┤зцОечЭАя╝МхоГф╝ЪхИдцЦнховцИ╖члпчЪДцаЗшпЖф╕нцШпхРжцЬЙ CLIENT_PENDING_COMMANDуАВхжВцЮЬцЬЙ CLIENT_PENDING_COMMAND цаЗшпЖя╝МшбицШОшпеховцИ╖члпф╕нчЪДхС╜ф╗дх╖▓ч╗ПшвлцЯРф╕Аф╕к IO ч║┐чиЛшзгцЮРш┐Зя╝Мх╖▓ч╗ПхПпф╗ешвлцЙзшбМф║ЖуАВ</p> <p>цндцЧ╢я╝МhandleClientsWithPendingReadsUsingThreads хЗ╜цХ░ф╝Ъш░ГчФи processCommandAndResetClient хЗ╜цХ░цЙзшбМхС╜ф╗дуАВцЬАхРОя╝МхоГф╝ЪчЫ┤цОеш░ГчФи processInputBuffer хЗ╜цХ░шзгцЮРховцИ╖члпф╕нцЙАцЬЙхС╜ф╗дх╣╢цЙзшбМуАВ</p> <p>ш┐ЩщГихИЖчЪДф╗гчаБщА╗ш╛СхжВф╕ЛцЙАчд║я╝Мф╜ахПпф╗ечЬЛф╕ЛуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">listLength</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>clients_pending_read<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ln <span class="token operator">=</span> <span class="token function">listFirst</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>clients_pending_read<span class="token punctuation">)</span><span class="token punctuation">;</span>
        client <span class="token operator">*</span>c <span class="token operator">=</span> <span class="token function">listNodeValue</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//хжВцЮЬхС╜ф╗дх╖▓ч╗ПшзгцЮРш┐Зя╝МхИЩцЙзшбМшпехС╜ф╗д</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> CLIENT_PENDING_COMMAND<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            c<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>CLIENT_PENDING_COMMAND<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">processCommandAndResetClient</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">==</span> C_ERR<span class="token punctuation">)</span> <span class="token punctuation">{</span>      
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//шзгцЮРх╣╢цЙзшбМцЙАцЬЙхС╜ф╗д</span>
        <span class="token function">processInputBuffer</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хе╜ф║Жя╝МхИ░ш┐ЩщЗМя╝Мф╜ах░▒ф║Жшзгф║Ж clients_pending_read хИЧшбиф╕нчЪДх╛Ешп╗ховцИ╖члпя╝МцШпхжВф╜Хч╗Пш┐Зф╗еф╕КхЫЫф╕кцнещкдцЭехИЖщЕНч╗Щ IO ч║┐чиЛш┐ЫшбМхдДчРЖчЪДуАВф╕ЛхЫ╛х▒Хчд║ф║Жш┐Щф╕кф╕╗шжБш┐ЗчиЛя╝Мф╜ахПпф╗ехЖНхЫЮщб╛ф╕ЛуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409171451258.png" alt="image-20240917145158198"></p> <p>щВгф╣Ия╝МцОеф╕ЛцЭея╝МцИСф╗мхЖНцЭечЬЛф╕Лх╛ЕхЖЩховцИ╖члпчЪДхИЖщЕНхТМхдДчРЖуАВ</p> <h2 id="хжВф╜ХцККх╛ЕхЖЩховцИ╖члпхИЖщЕНч╗Щ-io-ч║┐чиЛцЙзшбМ"><a href="#хжВф╜ХцККх╛ЕхЖЩховцИ╖члпхИЖщЕНч╗Щ-io-ч║┐чиЛцЙзшбМ" class="header-anchor">#</a> хжВф╜ХцККх╛ЕхЖЩховцИ╖члпхИЖщЕНч╗Щ IO ч║┐чиЛцЙзшбМя╝Я</h2> <p>хТМх╛Ешп╗ховцИ╖члпчЪДхИЖщЕНхдДчРЖч▒╗ф╝╝я╝Мх╛ЕхЖЩховцИ╖члпхИЖщЕНхдДчРЖцШпчФ▒ <strong>handleClientsWithPendingWritesUsingThreads хЗ╜цХ░</strong>цЭехоМцИРчЪДуАВшпехЗ╜цХ░ф╣ЯцШпхЬи beforeSleep хЗ╜цХ░ф╕ншвлш░ГчФичЪДуАВ</p> <p>handleClientsWithPendingWritesUsingThreads хЗ╜цХ░чЪДф╕╗шжБц╡БчиЛхРМца╖ф╣ЯхПпф╗ехИЖцИР 4 цнея╝МхЕ╢ф╕ня╝Мчмм 2уАБ3 хТМ 4 цнечЪДцЙзшбМщА╗ш╛Ся╝МхТМ handleClientsWithPendingReadsUsingThreads хЗ╜цХ░ч▒╗ф╝╝уАВ</p> <p>чоАхНХцЭешп┤я╝МхЬичмм 2 цнея╝МhandleClientsWithPendingWritesUsingThreads хЗ╜цХ░ф╝ЪцККх╛ЕхЖЩховцИ╖члпя╝МцМЙчЕз<strong>ш╜ошпвцЦ╣х╝П</strong>хИЖщЕНч╗Щ IO ч║┐чиЛя╝Мц╖╗хКахИ░ io_threads_list цХ░ч╗ДхРДхЕГч┤аф╕нуАВ</p> <p>чД╢хРОя╝МхЬичмм 3 цнея╝МhandleClientsWithPendingWritesUsingThreads хЗ╜цХ░ф╝Ъшойф╕╗ IO ч║┐чиЛхдДчРЖхЕ╢х╛ЕхЖЩховцИ╖члпя╝Мх╣╢цЙзшбМ while(1) х╛кчОпчнЙх╛ЕцЙАцЬЙ IO ч║┐чиЛхоМцИРхдДчРЖуАВ</p> <p>хЬичмм 4 цнея╝МhandleClientsWithPendingWritesUsingThreads хЗ╜цХ░ф╝ЪхЖНцмбцгАцЯе clients_pending_write хИЧшбиф╕ня╝МцШпхРжш┐ШцЬЙх╛ЕхЖЩчЪДховцИ╖члпуАВхжВцЮЬцЬЙчЪДшпЭя╝Мх╣╢ф╕Фш┐Щф║ЫховцИ╖члпш┐ШцЬЙчХЩхнШхЬич╝УхЖ▓хМ║ф╕нчЪДцХ░цНоя╝МщВгф╣Ия╝МhandleClientsWithPendingWritesUsingThreads хЗ╜цХ░х░▒ф╝Ъш░ГчФи connSetWriteHandler хЗ╜цХ░ц│ихЖМхПпхЖЩф║Лф╗╢я╝МшАМш┐Щф╕кхПпхЖЩф║Лф╗╢хп╣х║ФчЪДхЫЮш░ГхЗ╜цХ░цШп <strong>sendReplyToClient хЗ╜цХ░</strong>уАВ</p> <p>чнЙхИ░ф║Лф╗╢х╛кчОпц╡БчиЛхЖНцмбцЙзшбМцЧ╢я╝МхИЪцЙН handleClientsWithPendingWritesUsingThreads хЗ╜цХ░ц│ихЖМчЪДхПпхЖЩф║Лф╗╢х░▒ф╝ЪшвлхдДчРЖя╝Мч┤зцОечЭА sendReplyToClient хЗ╜цХ░ф╝ЪцЙзшбМя╝МхоГф╝ЪчЫ┤цОеш░ГчФи writeToClient хЗ╜цХ░я╝МцККховцИ╖члпч╝УхЖ▓хМ║ф╕нчЪДцХ░цНохЖЩхЫЮуАВ</p> <p>ш┐ЩщЗМя╝М<strong>ф╜ащЬАшжБц│ицДПчЪДцШп</strong>я╝МconnSetWriteHandler хЗ╜цХ░цЬАч╗Иф╝ЪцШах░Дф╕║ connSocketSetWriteHandler хЗ╜цХ░я╝МшАМ connSocketSetWriteHandler хЗ╜цХ░цШпхЬи<a href="https://github.com/redis/redis/tree/5.0/src/connection.c" target="_blank" rel="noopener noreferrer">connection.c<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>цЦЗф╗╢ф╕нхоЮчО░чЪДуАВconnSocketSetWriteHandler хЗ╜цХ░ф╝Ъш░ГчФи aeCreateFileEvent хЗ╜цХ░хИЫх╗║ AE_WRITABLE ф║Лф╗╢я╝Мш┐Щх░▒цШпхИЪцЙНф╗Лч╗НчЪДхПпхЖЩф║Лф╗╢чЪДц│ихЖМя╝ИхЕ│ф║О aeCreateFileEvent хЗ╜цХ░чЪДф╜┐чФия╝Мф╜аф╣ЯхПпф╗ехЖНхЫЮщб╛ф╕Лчмм 11 шо▓я╝ЙуАВ</p> <p>ф╕Нш┐Зя╝МхТМ handleClientsWithPendingReadsUsingThreads хЗ╜цХ░ф╕НхРМчЪДцШпхЬичмм 1 цнея╝МhandleClientsWithPendingWritesUsingThreads хЗ╜цХ░я╝М<strong>ф╝ЪхИдцЦн IO ч║┐чиЛцХ░щЗПцШпхРжф╕║ 1я╝МцИЦшАЕх╛ЕхЖЩховцИ╖члпцХ░щЗПцШпхРжх░Пф║О IO ч║┐чиЛцХ░щЗПчЪД 2 хАНуАВ</strong></p> <p>хжВцЮЬш┐Щф╕дф╕кцЭбф╗╢ф╕нцЬЙф╕Аф╕кцЭбф╗╢цИРчлЛя╝МщВгф╣И handleClientsWithPendingWritesUsingThreads хЗ╜цХ░х░▒ф╕Нф╝ЪчФихдЪч║┐чиЛцЭехдДчРЖховцИ╖члпф║Жя╝МшАМцШпф╝Ъш░ГчФи handleClientsWithPendingWrites хЗ╜цХ░чФ▒ф╕╗ IO ч║┐чиЛчЫ┤цОехдДчРЖх╛ЕхЖЩховцИ╖члпуАВш┐Щца╖хБЪчЪДчЫочЪДя╝Мф╕╗шжБцШпф╕║ф║ЖхЬих╛ЕхЖЩховцИ╖члпцХ░щЗПф╕НхдЪцЧ╢я╝МщБ┐хЕНщЗЗчФихдЪч║┐чиЛя╝Мф╗ОшАМ<strong>шКВчЬБ CPU х╝АщФА</strong>уАВ</p> <p>ш┐Щф╕АцнечЪДцЭбф╗╢хИдцЦнщА╗ш╛СхжВф╕ЛцЙАчд║уАВхЕ╢ф╕ня╝МstopThreadedIOIfNeeded хЗ╜цХ░ф╕╗шжБцШпчФицЭехИдцЦнх╛ЕхЖЩховцИ╖члпцХ░щЗПя╝МцШпхРжф╕Нш╢│ф╕║ IO ч║┐чиЛцХ░щЗПчЪД 2 хАНуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>io_threads_num <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> <span class="token function">stopThreadedIOIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">handleClientsWithPendingWrites</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хПжхдЦя╝МhandleClientsWithPendingWritesUsingThreads хЗ╜цХ░хЬичмм 1 цнеф╕ня╝Мш┐Шф╝Ъ<strong>хИдцЦн IO ч║┐чиЛцШпхРжх╖▓ц┐Ац┤╗</strong>уАВхжВцЮЬц▓бцЬЙц┐Ац┤╗я╝МхоГх░▒ф╝Ъш░ГчФи startThreadedIO хЗ╜цХ░я╝МцККхЕих▒АхПШщЗП server чЪД io_threads_active цИРхСШхПШщЗПхА╝шо╛ч╜оф╕║ 1я╝Мшбичд║ IO ч║┐чиЛх╖▓ц┐Ац┤╗уАВш┐ЩцнехИдцЦнцУНф╜ЬхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>server<span class="token punctuation">.</span>io_threads_active<span class="token punctuation">)</span> <span class="token function">startThreadedIO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>цА╗ф╣Лф╜ашжБчЯещБУчЪДх░▒цШпя╝МRedis цШпщАЪш┐З handleClientsWithPendingWritesUsingThreads хЗ╜цХ░я╝МцККх╛ЕхЖЩховцИ╖члпцМЙш╜ошпвцЦ╣х╝ПхИЖщЕНч╗ЩхРДф╕к IO ч║┐чиЛя╝Мх╣╢чФ▒хоГф╗мцЭеш┤Яш┤гхЖЩхЫЮцХ░цНочЪДуАВ</p> <h2 id="цА╗ч╗У"><a href="#цА╗ч╗У" class="header-anchor">#</a> цА╗ч╗У</h2> <p>ф╗Кхдйш┐ЩшКВшп╛я╝МцИСч╗Щф╜аф╗Лч╗Нф║Ж Redis 6.0 ф╕нцЦ░шо╛шобхоЮчО░чЪД<strong>хдЪ IO ч║┐чиЛцЬ║хИ╢</strong>уАВш┐Щф╕кцЬ║хИ╢чЪДшо╛шобф╕╗шжБцШпф╕║ф║Жф╜┐чФихдЪф╕к IO ч║┐чиЛя╝МцЭех╣╢хПСхдДчРЖховцИ╖члпшп╗хПЦцХ░цНоуАБшзгцЮРхС╜ф╗дхТМхЖЩхЫЮцХ░цНоуАВф╜┐чФиф║ЖхдЪч║┐чиЛхРОя╝МRedis х░▒хПпф╗ехЕЕхИЖхИйчФицЬНхКбхЩичЪДхдЪца╕чЙ╣цАзя╝Мф╗ОшАМ<strong>цПРщлШ IO цХИчОЗ</strong>уАВ</p> <p>цА╗ч╗УцЭешп┤я╝МRedis 6.0 хЕИцШпхЬихИЭхзЛхМЦш┐ЗчиЛф╕ня╝Мца╣цНочФицИ╖шо╛ч╜очЪД IO ч║┐чиЛцХ░щЗПя╝МхИЫх╗║хп╣х║ФцХ░щЗПчЪД IO ч║┐чиЛуАВ</p> <p>х╜У Redis server хИЭхзЛхМЦхоМцИРхРОцнгх╕╕ш┐РшбМцЧ╢я╝МхоГф╝ЪхЬи readQueryFromClient хЗ╜цХ░ф╕нщАЪш┐Зш░ГчФи postponeClientRead хЗ╜цХ░цЭехЖ│хоЪцШпхРжцОиш┐ЯховцИ╖члпшп╗цУНф╜ЬуАВхРМцЧ╢я╝МRedis server ф╝ЪхЬи addReply хЗ╜цХ░ф╕нщАЪш┐Зш░ГчФи prepareClientToWrite хЗ╜цХ░я╝МцЭехЖ│хоЪцШпхРжцОиш┐ЯховцИ╖члпхЖЩцУНф╜ЬуАВшАМх╛Ешп╗хЖЩчЪДховцИ╖члпф╝ЪшвлхИЖхИлхКахЕехИ░ clients_pending_read хТМ clients_pending_write ф╕дф╕кхИЧшбиф╕нуАВ</p> <p>ш┐Щца╖я╝МцпПх╜У Redis server шжБш┐ЫхЕеф║Лф╗╢х╛кчОпц╡БчиЛхЙНя╝МщГ╜ф╝ЪхЬи beforeSleep хЗ╜цХ░ф╕нхИЖхИлш░ГчФи handleClientsWithPendingReadsUsingThreads хЗ╜цХ░хТМ handleClientsWithPendingWritesUsingThreads хЗ╜цХ░я╝Мх░Жх╛Ешп╗хЖЩховцИ╖члп<strong>ф╗еш╜ошпвцЦ╣х╝ПхИЖщЕНч╗Щ IO ч║┐чиЛ</strong>я╝МхКахЕехИ░ IO ч║┐чиЛчЪДх╛ЕхдДчРЖховцИ╖члпхИЧшби io_threads_list ф╕нуАВ</p> <p>шАМ IO ч║┐чиЛф╕АцЧжш┐РшбМхРОя╝МцЬмш║лф╝Ъф╕АчЫ┤цгАц╡Л io_threads_list ф╕нчЪДховцИ╖члпя╝МхжВцЮЬцЬЙх╛Ешп╗хЖЩховцИ╖члпя╝МIO ч║┐чиЛх░▒ф╝Ъш░ГчФи readQueryFromClient цИЦ writeToClient хЗ╜цХ░цЭеш┐ЫшбМхдДчРЖуАВ</p> <p>цЬАхРОя╝МцИСф╣ЯцГ│хЖНцПРщЖТф╜аф╕Аф╕Ля╝М<strong>хдЪ IO ч║┐чиЛцЬмш║лх╣╢ф╕Нф╝ЪцЙзшбМхС╜ф╗д</strong>я╝МхоГф╗мхПкцШпхИйчФихдЪца╕х╣╢шбМхЬ░шп╗хПЦцХ░цНохТМшзгцЮРхС╜ф╗дя╝МцИЦцШпх░Ж server цХ░цНохЖЩхЫЮя╝Иф╕ЛшКВшп╛цИСш┐Шф╝Ъч╗УхРИхИЖх╕Гх╝ПщФБчЪДхОЯхнРцАзф┐ЭшпБя╝МцЭеч╗Щф╜аф╗Лч╗Нш┐Щф╕АщГихИЖчЪДц║РчаБхоЮчО░уАВя╝ЙуАВцЙАф╗ея╝М<strong>Redis цЙзшбМхС╜ф╗дчЪДч║┐чиЛш┐ШцШпф╕╗ IO ч║┐чиЛ</strong>уАВш┐Щф╕АчВ╣хп╣ф║Оф╜ачРЖшзгхдЪ IO ч║┐чиЛцЬ║хИ╢х╛ИщЗНшжБя╝МхПпф╗ещБ┐хЕНф╜ашппшзг Redis цЬЙхдЪч║┐чиЛхРМцЧ╢цЙзшбМхС╜ф╗дуАВ</p> <p>ш┐Щца╖ф╕АцЭея╝МцИСф╗мхОЯцЭещТИхп╣ Redis хНХф╕кф╕╗ IO ч║┐чиЛхБЪчЪДф╝ШхМЦф╗НчД╢цЬЙцХИя╝МцпФхжВщБ┐хЕН bigkeyуАБщБ┐хЕНщШ╗хбЮцУНф╜ЬчнЙуАВ</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/echo-lxy/echo-system-design/edit/master/docs/Redis ч│╗ч╗Яшо╛шоб/03.ф╕╗ч║┐/15.ц╖▒хЕе Redis чЪДхдЪIOч║┐чиЛ.md" target="_blank" rel="noopener noreferrer">ч╝Цш╛С</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">ф╕КцмбцЫ┤цЦ░ф║О:</span> <span class="time">2024/09/17, 08:34:31</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        тЖР
        <a href="/pages/b4aed2/" class="prev">чоАш┐░ Redis хдЪч║┐чиЛ IO</a></span> <span class="next"><a href="/pages/b43a19/">LRU чнЦчХе</a>тЖТ
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:lixinyang2002@163.com" title="хПСщВоф╗╢" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/echo-lxy" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="хРмщЯ│ф╣Р" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="цЬмчлЩф╕╗щвШ">Vdoing</a> 
    | Copyright ┬й 2024-2024
    <span>Xinyang Li | MIT License</span></div> <div class="buttons"><div title="ш┐ФхЫЮщб╢щГи" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="хО╗шпДшо║" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ф╕╗щвШцибх╝П" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          ш╖ЯщЪПч│╗ч╗Я
        </li><li class="iconfont icon-rijianmoshi">
          ц╡ЕшЙ▓цибх╝П
        </li><li class="iconfont icon-yejianmoshi">
          ц╖▒шЙ▓цибх╝П
        </li><li class="iconfont icon-yuedu">
          щШЕшп╗цибх╝П
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.aaad5302.js" defer></script><script src="/assets/js/2.933750c6.js" defer></script><script src="/assets/js/50.9bff482f.js" defer></script><script src="/assets/js/7.7eb70372.js" defer></script>
  </body>
</html>
