<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>消息未读数系统 | Echo 系统设计之美</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="水滴石穿，设计无银弹">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.3c3ffff0.css" as="style"><link rel="preload" href="/assets/js/app.1fd994d0.js" as="script"><link rel="preload" href="/assets/js/2.c1dbdf51.js" as="script"><link rel="preload" href="/assets/js/39.9e338504.js" as="script"><link rel="prefetch" href="/assets/js/10.031334f8.js"><link rel="prefetch" href="/assets/js/11.0d3e36bd.js"><link rel="prefetch" href="/assets/js/12.2e9aa303.js"><link rel="prefetch" href="/assets/js/13.073b21f5.js"><link rel="prefetch" href="/assets/js/14.38bb0bec.js"><link rel="prefetch" href="/assets/js/15.96fa5395.js"><link rel="prefetch" href="/assets/js/16.b2f13111.js"><link rel="prefetch" href="/assets/js/17.d93afe2d.js"><link rel="prefetch" href="/assets/js/18.5b90af04.js"><link rel="prefetch" href="/assets/js/19.e3ba0882.js"><link rel="prefetch" href="/assets/js/20.3086ea77.js"><link rel="prefetch" href="/assets/js/21.f6642d0c.js"><link rel="prefetch" href="/assets/js/22.c8bf77a9.js"><link rel="prefetch" href="/assets/js/23.03b3a76f.js"><link rel="prefetch" href="/assets/js/24.d7df3410.js"><link rel="prefetch" href="/assets/js/25.19ca3810.js"><link rel="prefetch" href="/assets/js/26.62fa0893.js"><link rel="prefetch" href="/assets/js/27.1e14f5fb.js"><link rel="prefetch" href="/assets/js/28.549fdcf3.js"><link rel="prefetch" href="/assets/js/29.36067c16.js"><link rel="prefetch" href="/assets/js/3.02653a41.js"><link rel="prefetch" href="/assets/js/30.5d8b8b16.js"><link rel="prefetch" href="/assets/js/31.db6e3954.js"><link rel="prefetch" href="/assets/js/32.2e41e383.js"><link rel="prefetch" href="/assets/js/33.eb08d4c3.js"><link rel="prefetch" href="/assets/js/34.b291b0e7.js"><link rel="prefetch" href="/assets/js/35.56ddcab7.js"><link rel="prefetch" href="/assets/js/36.c0284793.js"><link rel="prefetch" href="/assets/js/37.822f2a24.js"><link rel="prefetch" href="/assets/js/38.14e581cb.js"><link rel="prefetch" href="/assets/js/4.898790b1.js"><link rel="prefetch" href="/assets/js/40.43aede46.js"><link rel="prefetch" href="/assets/js/5.39afb5af.js"><link rel="prefetch" href="/assets/js/6.2e800bfd.js"><link rel="prefetch" href="/assets/js/7.8c61d8b1.js"><link rel="prefetch" href="/assets/js/8.a9abd6e1.js"><link rel="prefetch" href="/assets/js/9.ccc0ac01.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3c3ffff0.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="Echo 系统设计之美" class="logo"> <span class="site-name can-hide">Echo 系统设计之美</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">🏠首页</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">✒️热门算法</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🎖️赏析经典" class="dropdown-title"><!----> <span class="title" style="display:;">🎖️赏析经典</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis 系统设计</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka 系统设计</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx 系统设计</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🧑‍💻实战系统设计" class="dropdown-title"><!----> <span class="title" style="display:;">🧑‍💻实战系统设计</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/84cb49/" class="nav-link">设计基础设施</a></li><li class="dropdown-item"><!----> <a href="/pages/a95d7d/" class="nav-link">设计热门应用</a></li><li class="dropdown-item"><!----> <a href="/pages/def08a/" class="nav-link">场景设计</a></li></ul></div></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">❓问答</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">👀动态</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">🏠首页</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">✒️热门算法</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🎖️赏析经典" class="dropdown-title"><!----> <span class="title" style="display:;">🎖️赏析经典</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis 系统设计</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka 系统设计</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx 系统设计</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🧑‍💻实战系统设计" class="dropdown-title"><!----> <span class="title" style="display:;">🧑‍💻实战系统设计</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/84cb49/" class="nav-link">设计基础设施</a></li><li class="dropdown-item"><!----> <a href="/pages/a95d7d/" class="nav-link">设计热门应用</a></li><li class="dropdown-item"><!----> <a href="/pages/def08a/" class="nav-link">场景设计</a></li></ul></div></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">❓问答</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">👀动态</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>经典场景设计</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/def08a/" class="sidebar-link">双写一致性</a></li><li><a href="/pages/1e9e8e/" class="sidebar-link">缓存穿透</a></li><li><a href="/pages/1d96b2/" class="sidebar-link">缓存击穿</a></li><li><a href="/pages/24abe0/" class="sidebar-link">任务补偿</a></li><li><a href="/pages/a72629/" class="sidebar-link">秒杀</a></li><li><a href="/pages/8a57f2/" class="sidebar-link">超卖</a></li><li><a href="/pages/51aa8b/" class="sidebar-link">多级缓存</a></li><li><a href="/pages/0dfb49/" class="sidebar-link">超时&amp;重试</a></li><li><a href="/pages/4fc8cb/" class="sidebar-link">幂等&amp;防重</a></li><li><a href="/pages/f3295f/" class="sidebar-link">海量数据计数</a></li><li><a href="/pages/6b9d68/" aria-current="page" class="active sidebar-link">消息未读数系统</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/6b9d68/#引子" class="sidebar-link">引子</a></li><li class="sidebar-sub-header level2"><a href="/pages/6b9d68/#系统通知的未读数要如何设计" class="sidebar-link">系统通知的未读数要如何设计</a></li><li class="sidebar-sub-header level2"><a href="/pages/6b9d68/#如何为信息流的未读数设计方案" class="sidebar-link">如何为信息流的未读数设计方案</a></li><li class="sidebar-sub-header level2"><a href="/pages/6b9d68/#总结" class="sidebar-link">总结</a></li></ul></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>经典场景设计</span></li><li data-v-06225672><span data-v-06225672>经典场景设计</span></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/brother-one" target="_blank" title="作者" class="beLink" data-v-06225672>echo</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-09-14</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">消息未读数系统<!----></h1> <div class="page-slot page-slot-top">
    <div class="wwads-cn wwads-horizontal page-wwads" data-id="136"></div>
    <style>
      .page-wwads{
        width:100%!important;
        min-height: 0;
        margin: 0;
      }
      .page-wwads .wwads-img img{
        width:80px!important;
      }
      .page-wwads .wwads-poweredby{
        width: 40px;
        position: absolute;
        right: 25px;
        bottom: 3px;
      }
      .wwads-content .wwads-text, .page-wwads .wwads-text{
        height: 100%;
        padding-top: 5px;
        display: block;
      }
  </style>
  </div> <div class="theme-vdoing-content content__default"><h2 id="引子"><a href="#引子" class="header-anchor">#</a> 引子</h2> <p>未读数也是系统中一个常见的模块，以微博系统为例，你可看到有多个未读计数的场景，</p> <p>比如：</p> <ul><li>当有人 @你、评论你、给你的博文点赞或者给你发送私信的时候，你会收到相应的未读提醒；</li> <li>在早期的微博版本中有系统通知的功能，也就是系统会给全部用户发送消息，通知用户有新的版本或者有一些好玩的运营活动，如果用户没有看，系统就会给他展示有多少条未读的提醒。</li> <li>我们在浏览信息流的时候，如果长时间没有刷新页面，那么信息流上方就会提示你在这段时间有多少条信息没有看</li></ul> <h2 id="系统通知的未读数要如何设计"><a href="#系统通知的未读数要如何设计" class="header-anchor">#</a> 系统通知的未读数要如何设计</h2> <p>来看具体的例子。假如你的系统中只有 A、B、C 三个用户，那么你可以在通用计数系统中 增加一块儿内存区域，并且以用户 ID 为 Key 来存储这三个用户的未读通知数据，当系统发 送一个新的通知时，我们会循环给每一个用户的未读数加 1，这个处理逻辑的伪代码就像下 面这样</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> userIds <span class="token operator">=</span> <span class="token function">getAllUserIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id <span class="token operator">:</span> userIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">incrUnreadCount</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>但随着系统中的用户越来越多，这个方案存在两个致命的问题</p> <ul><li>首先，<strong>获取全量用户就是一个比较耗时的操作</strong>，相当于对用户库做一次全表的扫描，这不仅会对数据库造成很大的压力，而且查询全量用户数据的响应时间是很长的，对于在线业务来说是难以接受的。如果你的用户库已经做了分库分表，那么就要扫描所有的库表，响应时间就更长了。不过有一个折中的方法， 那就是在发送系统通知之前，先从线下的数据仓库中 获取全量的用户 ID，并且存储在一个本地的文件中，然后再轮询所有的用户 ID，给这些用 户增加未读计数。
<ul><li>这似乎是一个可行的技术方案，然而它给所有人增加未读计数，会消耗非常长的时间。你计 算一下，假如你的系统中有一个亿的用户，给一个用户增加未读数需要消耗 1ms，那么给 所有人都增加未读计数就需要 100000000 * 1 /1000 = 100000 秒，也就是超过一天的时 间；即使你启动 100 个线程并发的设置，也需要十几分钟的时间才能完成，而用户很难接 受这么长的延迟时间。</li></ul></li> <li>另外，使用这种方式需要<strong>给系统中的每一个用户都记一个未读数的值</strong>，而在系统中，活跃用 户只是很少的一部分，大部分的用户是不活跃的，甚至从来没有打开过系统通知，为这些用 户记录未读数显然是一种浪费。</li></ul> <p>通过上面的内容，你可以知道为什么我们不能用通用计数系统实现系统通知未读数了吧？那正确的做法是什么呢</p> <p>要知道，系统通知实际上是存储在一个大的列表中的，这个列表对所有用户共享，也就是所有人看到的都是同一份系统通知的数据。不过不同的人最近看到的消息不同，所以每个人会有不同的未读数。<strong>因此，你可以记录一下在这个列表中每个人看过最后一条消息的 ID，然 后统计这个 ID 之后有多少条消息，这就是未读数了</strong></p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409150002925.png" alt="image-20240915000214865"></p> <p><strong>上述就是 timeline 模型</strong></p> <p>这个方案在实现时有这样几个关键点：</p> <ul><li>用户访问系统通知页面需要设置未读数为 0，我们需要将用户最近看过的通知 ID 设置为最新的一条系统通知 ID</li> <li>如果最近看过的通知 ID 为空，则认为是一个新的用户，返回未读数为 0；</li> <li>对于非活跃用户，比如最近一个月都没有登录和使用过系统的用户，可以把用户最近看过的通知 ID 清空，节省内存空间。</li></ul> <p>这是一种比较通用的方案，即节省内存，又能尽量减少获取未读数的延迟。</p> <p>这个方案适用 的另一个业务场景是全量用户打点的场景，比如像下面这张微博截图中的红点</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409150003640.png" alt="image-20240915000342579"></p> <p>这个红点和系统通知类似，也是一种通知全量用户的手段，如果逐个通知用户，延迟也是无法接受的。因此你可以采用和系统通知类似的方案。</p> <p>首先，我们为每一个用户存储一个时间戳，代表最近点过这个红点的时间，用户点了红点， 就把这个时间戳设置为当前时间；然后，我们也记录一个全局的时间戳，这个时间戳标识最新的一次打点时间，如果你在后台操作给全体用户打点，就更新这个时间戳为当前时间。而 我们在判断是否需要展示红点时，只需要判断用户的时间戳和全局时间戳的大小，如果用户时间戳小于全局时间戳，代表在用户最后一次点击红点之后又有新的红点推送，那么就要展 示红点，反之，就不展示红点了。</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409150004010.png" alt="image-20240915000419959"></p> <p>这两个场景的共性是全部用户共享一份有限的存储数据，每个人只记录自己在这份存储中的 偏移量，就可以得到未读数了。</p> <p>你可以看到，系统消息未读的实现方案不是很复杂，它通过设计避免了操作全量数据未读数，如果你的系统中有这种打红点的需求，那我建议你可以结合实际工作灵活使用上述方案。</p> <p>最后一个需求关注的是微博<strong>信息流的未读数</strong>，在现在的社交系统中，关注关系已经成为标配的功能，而基于关注关系的信息流也是一种非常重要的信息聚合方式，因此，如何设计信息流的未读数系统就成了你必须面对的一个问题。</p> <h2 id="如何为信息流的未读数设计方案"><a href="#如何为信息流的未读数设计方案" class="header-anchor">#</a> 如何为信息流的未读数设计方案</h2> <p>信息流的未读数之所以复杂主要有这样几点原因</p> <p><strong>首先，微博的信息流是基于关注关系的，未读数也是基于关注关系的，就是说，你关注的人发布了新的微博，那么你作为粉丝未读数就要增加 1</strong>。</p> <p>如果微博用户都是像我这样只有几百粉丝的“小透明”就简单了，你发微博的时候系统给你粉丝的未读数增加 1 不 是什么难事儿。但是对于一些动辄几千万甚至上亿粉丝的微博大 V 就麻烦了，增加未读 数可能需要几个小时。假设你是杨幂的粉丝，想了解她实时发布的博文，那么如果当她 发布博文几个小时之后，你才收到提醒，这显然是不能接受的。所以未读数的延迟是你在设计方案时首先要考虑的内容。</p> <p><strong>其次，信息流未读数请求量极大、并发极高，这是因为接口是客户端轮询请求的，不是用户触发的。</strong></p> <p>也就是说，用户即使打开微博客户端什么都不做，这个接口也会被请求到。在几年前，请求未读数接口的量级就已经接近每秒 50 万次，这几年随着微博量级的增长，请求量也变得更高。而作为微博的非核心接口，我们不太可能使用大量的机器来抗未读数请求，因此，如何使用有限的资源来支撑如此高的流量是这个方案的难点。 最后，它不像系统通知那样有共享的存储，因为每个人关注的人不同，信息流的列表也就不同，所以也就没办法采用系统通知未读数的方案。</p> <p>那要如何设计能够承接每秒几十万次请求的信息流未读数系统呢？你可以这样做：</p> <p>首先，在通用计数器中记录每一个用户发布的博文数； 然后在 Redis 或者 Memcached 中记录一个人所有关注人的博文数快照，当用户点击未读消息重置未读数为 0 时，将他关注所有人的博文数刷新到快照中； 这样，他关注所有人的博文总数减去快照中的博文总数就是他的信息流未读数。</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409150008448.png" alt="image-20240915000826402"></p> <p>假如用户 A，像上图这样关注了用户 B、C、D，其中 B 发布的博文数是 10，C 发布的博 文数是 8，D 发布的博文数是 14，而在用户 A 最近一次查看未读消息时，记录在快照中的 这三个用户的博文数分别是 6、7、12，因此用户 A 的未读数就是（10-6）+（8-7）+（14-12）=7。</p> <p>这个方案设计简单，并且是全内存操作，性能足够好，能够支撑比较高的并发，事实上微博团队仅仅用 16 台普通的服务器就支撑了每秒接近 50 万次的请求，这就足以证明这个方案的性能有多出色，因此，它完全能够满足信息流未读数的需求。</p> <p>当然了这个方案也有一些缺陷，比如说快照中需要存储关注关系，如果关注关系变更的时候 更新不及时，那么就会造成未读数不准确；快照采用的是全缓存存储，如果缓存满了就会剔 除一些数据，那么被剔除用户的未读数就变为 0 了。但是好在用户对于未读数的准确度要求不高（未读 10 条还是 11 条，其实用户有时候看不出来），因此，这些缺陷也是可以接受的</p> <p>通过分享未读数系统设计这个案例，我想给你一些建议：</p> <ol><li>缓存是提升系统性能和抵抗大并发量的神器，像是微博信息流未读数这么大的量级我们 仅仅使用十几台服务器就可以支撑，这全都是缓存的功劳；</li> <li>要围绕系统设计的关键困难点想解决办法，就像我们解决系统通知未读数的延迟问题一 样；</li> <li>合理分析业务场景，明确哪些是可以权衡的，哪些是不行的，会对你的系统设计增益良多，比如对于长久不登录用户，我们就会记录未读数为 0，通过这样的权衡，可以极大 地减少内存的占用，减少成本。</li></ol> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <ol><li>评论未读、@未读、赞未读等一对一关系的未读数可以使用上节课讲到的通用计数方案来解决；</li> <li>在系统通知未读、全量用户打点等存在有限的共享存储的场景下，可以通过记录用户上次操作的时间或者偏移量，来实现未读方案；</li> <li>最后，信息流未读方案最为复杂，采用的是记录用户博文数快照的方式</li></ol></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/echo-lxy/echo-system-design/edit/master/docs/30.经典场景设计/01.经典场景设计/11.消息未读数系统.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2024/09/15, 13:32:51</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/f3295f/" class="prev">海量数据计数</a></span> <!----></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:lixinyang2002@163.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/echo-lxy" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2024-2024
    <span>Xinyang Li | MIT License</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1fd994d0.js" defer></script><script src="/assets/js/2.c1dbdf51.js" defer></script><script src="/assets/js/39.9e338504.js" defer></script>
  </body>
</html>
