<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ç¬¬ä¸ƒè¯¾ï¼šè¯¦è§£ Netty ä¸­æ‰€æœ‰IOäº‹ä»¶çš„è§¦å‘æ—¶æœºå’Œä¼ æ’­æµç¨‹ | EchoDesign</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="ç³»ç»Ÿè®¾è®¡ä¹‹ã€Œè®²è§£ + é¢è¯•æŒ‡å—ã€ï¼Œæ°´æ»´çŸ³ç©¿ï¼Œè®¾è®¡æ— é“¶å¼¹ï¼">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.c76c3453.css" as="style"><link rel="preload" href="/assets/js/app.6c7acbd0.js" as="script"><link rel="preload" href="/assets/js/2.933750c6.js" as="script"><link rel="preload" href="/assets/js/57.72ba41a6.js" as="script"><link rel="preload" href="/assets/js/7.7eb70372.js" as="script"><link rel="prefetch" href="/assets/js/10.2cc95be8.js"><link rel="prefetch" href="/assets/js/100.2b21dce5.js"><link rel="prefetch" href="/assets/js/101.09d5e594.js"><link rel="prefetch" href="/assets/js/11.c7521a10.js"><link rel="prefetch" href="/assets/js/12.38d1989d.js"><link rel="prefetch" href="/assets/js/13.8ddd597e.js"><link rel="prefetch" href="/assets/js/14.397b7600.js"><link rel="prefetch" href="/assets/js/15.b3c76984.js"><link rel="prefetch" href="/assets/js/16.831e5a24.js"><link rel="prefetch" href="/assets/js/17.acb3bf3d.js"><link rel="prefetch" href="/assets/js/18.e491edb6.js"><link rel="prefetch" href="/assets/js/19.daf31819.js"><link rel="prefetch" href="/assets/js/20.cb4a5c13.js"><link rel="prefetch" href="/assets/js/21.24c0f101.js"><link rel="prefetch" href="/assets/js/22.7d106f59.js"><link rel="prefetch" href="/assets/js/23.623f0b5d.js"><link rel="prefetch" href="/assets/js/24.6ba53300.js"><link rel="prefetch" href="/assets/js/25.1fb855d9.js"><link rel="prefetch" href="/assets/js/26.0146252c.js"><link rel="prefetch" href="/assets/js/27.de80589e.js"><link rel="prefetch" href="/assets/js/28.d4ca2c30.js"><link rel="prefetch" href="/assets/js/29.7325b5ce.js"><link rel="prefetch" href="/assets/js/3.5c09ac9d.js"><link rel="prefetch" href="/assets/js/30.892b2994.js"><link rel="prefetch" href="/assets/js/31.a532917f.js"><link rel="prefetch" href="/assets/js/32.13b70e91.js"><link rel="prefetch" href="/assets/js/33.64ab8d0c.js"><link rel="prefetch" href="/assets/js/34.6d3cc288.js"><link rel="prefetch" href="/assets/js/35.5b49d706.js"><link rel="prefetch" href="/assets/js/36.be98cc35.js"><link rel="prefetch" href="/assets/js/37.ead210df.js"><link rel="prefetch" href="/assets/js/38.9f396b5a.js"><link rel="prefetch" href="/assets/js/39.8409097b.js"><link rel="prefetch" href="/assets/js/4.73518a0f.js"><link rel="prefetch" href="/assets/js/40.0ada49bd.js"><link rel="prefetch" href="/assets/js/41.fcee3e0f.js"><link rel="prefetch" href="/assets/js/42.b34f1599.js"><link rel="prefetch" href="/assets/js/43.5a509601.js"><link rel="prefetch" href="/assets/js/44.64fd3383.js"><link rel="prefetch" href="/assets/js/45.685623ac.js"><link rel="prefetch" href="/assets/js/46.7624d38c.js"><link rel="prefetch" href="/assets/js/47.86be3d8d.js"><link rel="prefetch" href="/assets/js/48.ba7dfd47.js"><link rel="prefetch" href="/assets/js/49.ee9681bc.js"><link rel="prefetch" href="/assets/js/5.94727770.js"><link rel="prefetch" href="/assets/js/50.3e91aa07.js"><link rel="prefetch" href="/assets/js/51.ad7a3e32.js"><link rel="prefetch" href="/assets/js/52.08ad747c.js"><link rel="prefetch" href="/assets/js/53.5ee4652a.js"><link rel="prefetch" href="/assets/js/54.0bbf2ba5.js"><link rel="prefetch" href="/assets/js/55.0edcba5d.js"><link rel="prefetch" href="/assets/js/56.5ecf867d.js"><link rel="prefetch" href="/assets/js/58.7144aef6.js"><link rel="prefetch" href="/assets/js/59.f96f0065.js"><link rel="prefetch" href="/assets/js/6.0b558b79.js"><link rel="prefetch" href="/assets/js/60.66a7f41d.js"><link rel="prefetch" href="/assets/js/61.08b4acf0.js"><link rel="prefetch" href="/assets/js/62.cc8fdced.js"><link rel="prefetch" href="/assets/js/63.41ff19e4.js"><link rel="prefetch" href="/assets/js/64.9b3def35.js"><link rel="prefetch" href="/assets/js/65.0b2ab47d.js"><link rel="prefetch" href="/assets/js/66.2ae7a107.js"><link rel="prefetch" href="/assets/js/67.79dd6daf.js"><link rel="prefetch" href="/assets/js/68.1b76c178.js"><link rel="prefetch" href="/assets/js/69.7ac52a2f.js"><link rel="prefetch" href="/assets/js/70.7279b1df.js"><link rel="prefetch" href="/assets/js/71.f44644ed.js"><link rel="prefetch" href="/assets/js/72.c8cf2fab.js"><link rel="prefetch" href="/assets/js/73.526febf1.js"><link rel="prefetch" href="/assets/js/74.d9ad1a67.js"><link rel="prefetch" href="/assets/js/75.90fd56c9.js"><link rel="prefetch" href="/assets/js/76.32858593.js"><link rel="prefetch" href="/assets/js/77.7b3f6980.js"><link rel="prefetch" href="/assets/js/78.31a353ef.js"><link rel="prefetch" href="/assets/js/79.173bbc8c.js"><link rel="prefetch" href="/assets/js/8.0ec7f6e8.js"><link rel="prefetch" href="/assets/js/80.d8713e74.js"><link rel="prefetch" href="/assets/js/81.d124398a.js"><link rel="prefetch" href="/assets/js/82.3b90a7cc.js"><link rel="prefetch" href="/assets/js/83.f3a9ee0c.js"><link rel="prefetch" href="/assets/js/84.1fd412a9.js"><link rel="prefetch" href="/assets/js/85.f69467b2.js"><link rel="prefetch" href="/assets/js/86.931cbb70.js"><link rel="prefetch" href="/assets/js/87.78b2eebd.js"><link rel="prefetch" href="/assets/js/88.605444aa.js"><link rel="prefetch" href="/assets/js/89.e05e3a70.js"><link rel="prefetch" href="/assets/js/9.6e274fca.js"><link rel="prefetch" href="/assets/js/90.ca1ff100.js"><link rel="prefetch" href="/assets/js/91.8ad18b18.js"><link rel="prefetch" href="/assets/js/92.b554f1c7.js"><link rel="prefetch" href="/assets/js/93.fb2397b7.js"><link rel="prefetch" href="/assets/js/94.1eade7f0.js"><link rel="prefetch" href="/assets/js/95.96f5db04.js"><link rel="prefetch" href="/assets/js/96.5ed2d348.js"><link rel="prefetch" href="/assets/js/97.0154143f.js"><link rel="prefetch" href="/assets/js/98.8d8d41db.js"><link rel="prefetch" href="/assets/js/99.690e4395.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c76c3453.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="ç›®å½•" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="EchoDesign" class="logo"> <span class="site-name can-hide">EchoDesign</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">ğŸ é¦–é¡µ</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">âœ’ï¸çƒ­é—¨ç®—æ³•</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ğŸ–ï¸èµæç»å…¸è®¾è®¡" class="dropdown-title"><!----> <span class="title" style="display:;">ğŸ–ï¸èµæç»å…¸è®¾è®¡</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ç³»ç»Ÿè®¾è®¡</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ğŸ§‘â€ğŸ’»å®æˆ˜ç³»ç»Ÿè®¾è®¡</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">â“é—®ç­”</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ğŸ‘€åŠ¨æ€</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">ğŸ é¦–é¡µ</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">âœ’ï¸çƒ­é—¨ç®—æ³•</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ğŸ–ï¸èµæç»å…¸è®¾è®¡" class="dropdown-title"><!----> <span class="title" style="display:;">ğŸ–ï¸èµæç»å…¸è®¾è®¡</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty ç³»ç»Ÿè®¾è®¡</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ç³»ç»Ÿè®¾è®¡</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ğŸ§‘â€ğŸ’»å®æˆ˜ç³»ç»Ÿè®¾è®¡</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">â“é—®ç­”</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ğŸ‘€åŠ¨æ€</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ä¸€ã€å‰è¨€</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>äºŒã€åŸºç¡€çŸ¥è¯†</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ä¸‰ã€ä¸»çº¿ä»»åŠ¡</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>å››ã€æ·±å…¥ Netty æ ¸å¿ƒ</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/c3d4a6/" class="sidebar-link">ç¬¬ä¸€è¯¾ï¼šé€è¿‡ Netty çœ‹ IO æ¨¡å‹</a></li><li><a href="/pages/70bb50/" class="sidebar-link">ç¬¬äºŒè¯¾ï¼šReactoråœ¨Nettyä¸­çš„å®ç°</a></li><li><a href="/pages/830f05/" class="sidebar-link">ç¬¬ä¸‰è¯¾ï¼šNettyæ ¸å¿ƒå¼•æ“Reactorçš„è¿è½¬æ¶æ„</a></li><li><a href="/pages/6d0640/" class="sidebar-link">ç¬¬å››è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œè¿æ¥</a></li><li><a href="/pages/9cb8c1/" class="sidebar-link">ç¬¬äº”è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œæ•°æ®</a></li><li><a href="/pages/cfe9ff/" class="sidebar-link">ç¬¬å…­è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆå‘é€ç½‘ç»œæ•°æ®.md</a></li><li><a href="/pages/ed2e85/" aria-current="page" class="active sidebar-link">ç¬¬ä¸ƒè¯¾ï¼šè¯¦è§£ Netty ä¸­æ‰€æœ‰IOäº‹ä»¶çš„è§¦å‘æ—¶æœºå’Œä¼ æ’­æµç¨‹</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/ed2e85/#_1-å‰æ–‡å›é¡¾" class="sidebar-link">1. å‰æ–‡å›é¡¾</a></li><li class="sidebar-sub-header level2"><a href="/pages/ed2e85/#_2-pipelineçš„åˆ›å»º" class="sidebar-link">2. pipelineçš„åˆ›å»º</a></li><li class="sidebar-sub-header level2"><a href="/pages/ed2e85/#_3-pipelineä¸­çš„äº‹ä»¶åˆ†ç±»" class="sidebar-link">3. pipelineä¸­çš„äº‹ä»¶åˆ†ç±»</a></li><li class="sidebar-sub-header level2"><a href="/pages/ed2e85/#_4-å‘pipelineæ·»åŠ channelhandler" class="sidebar-link">4. å‘pipelineæ·»åŠ channelHandler</a></li><li class="sidebar-sub-header level2"><a href="/pages/ed2e85/#_5-channehandlercontext-çš„åˆ›å»º" class="sidebar-link">5. ChanneHandlerContext çš„åˆ›å»º</a></li><li class="sidebar-sub-header level2"><a href="/pages/ed2e85/#_6-ä»-pipeline-åˆ é™¤-channelhandler" class="sidebar-link">6. ä» pipeline åˆ é™¤ channelHandler</a></li><li class="sidebar-sub-header level2"><a href="/pages/ed2e85/#_7-pipeline-çš„åˆå§‹åŒ–" class="sidebar-link">7. pipeline çš„åˆå§‹åŒ–</a></li><li class="sidebar-sub-header level2"><a href="/pages/ed2e85/#_8-äº‹ä»¶ä¼ æ’­" class="sidebar-link">8. äº‹ä»¶ä¼ æ’­</a></li><li class="sidebar-sub-header level2"><a href="/pages/ed2e85/#æ€»ç»“" class="sidebar-link">æ€»ç»“</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>äº”ã€æ·±å…¥ Netty å†…å­˜ç®¡ç†</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="é¦–é¡µ" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>Netty ç³»ç»Ÿè®¾è®¡</span></li><li data-v-06225672><span data-v-06225672>å››ã€æ·±å…¥ Netty æ ¸å¿ƒ</span></li></ul> <div class="info" data-v-06225672><div title="ä½œè€…" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/brother-one" target="_blank" title="ä½œè€…" class="beLink" data-v-06225672>echo</a></div> <div title="åˆ›å»ºæ—¶é—´" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-09-19</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">ç›®å½•</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">ç¬¬ä¸ƒè¯¾ï¼šè¯¦è§£ Netty ä¸­æ‰€æœ‰IOäº‹ä»¶çš„è§¦å‘æ—¶æœºå’Œä¼ æ’­æµç¨‹<!----></h1> <div class="page-slot page-slot-top">
    <div class="wwads-cn wwads-horizontal page-wwads" data-id="136"></div>
    <style>
      .page-wwads{
        width:100%!important;
        min-height: 0;
        margin: 0;
      }
      .page-wwads .wwads-img img{
        width:80px!important;
      }
      .page-wwads .wwads-poweredby{
        width: 40px;
        position: absolute;
        right: 25px;
        bottom: 3px;
      }
      .wwads-content .wwads-text, .page-wwads .wwads-text{
        height: 100%;
        padding-top: 5px;
        display: block;
      }
  </style>
  </div> <div class="theme-vdoing-content content__default"><h2 id="_1-å‰æ–‡å›é¡¾"><a href="#_1-å‰æ–‡å›é¡¾" class="header-anchor">#</a> 1. å‰æ–‡å›é¡¾</h2> <p>åœ¨å‰è¾¹çš„ç³»åˆ—æ–‡ç« ä¸­ï¼Œç¬”è€…ä¸ºå¤§å®¶è¯¦ç»†å‰–æäº† Reactor æ¨¡å‹åœ¨ netty ä¸­çš„<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247483907&amp;idx=1&amp;sn=084c470a8fe6234c2c9461b5f713ff30&amp;chksm=ce77c444f9004d52e7c6244bee83479070effb0bc59236df071f4d62e91e25f01715fca53696&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">åˆ›å»º<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ï¼Œ<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484005&amp;idx=1&amp;sn=52f51269902a58f40d33208421109bc3&amp;chksm=ce77c422f9004d340e5b385ef6ba24dfba1f802076ace80ad6390e934173a10401e64e13eaeb&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">å¯åŠ¨<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ï¼Œ<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484087&amp;idx=1&amp;sn=0c065780e0f05c23c8e6465ede86cba0&amp;chksm=ce77c4f0f9004de63be369a664105708bc5975b52993f4a6df223caed34cc1ef6185a16acd75&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">è¿è¡Œ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ï¼Œ<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484184&amp;idx=1&amp;sn=726877ce28cf6e5d2ac3225fae687f19&amp;chksm=ce77c55ff9004c493b592288819dc4d4664b5949ee97fed977b6558bc517dad0e1f73fab0f46&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">æ¥æ”¶è¿æ¥<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ï¼Œ<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484244&amp;idx=1&amp;sn=831060fc38caa201d69f87305de7f86a&amp;chksm=ce77c513f9004c05b48f849ff99997d6d7252453135ae856a029137b88aa70b8e046013d596e&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">æ¥æ”¶æ•°æ®<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ï¼Œ<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484532&amp;idx=1&amp;sn=c3a8b37a2eb09509d9914494ef108c68&amp;chksm=ce77c233f9004b25a29f9fdfb179e41646092d09bc89df2147a9fab66df13231e46dd6a5c26d&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">å‘é€æ•°æ®<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>çš„å®Œæ•´æµç¨‹ï¼Œåœ¨è¯¦ç»†å‰–ææ•´ä¸ª Reactor æ¨¡å‹å¦‚ä½•åœ¨ netty ä¸­å®ç°çš„è¿‡ç¨‹é‡Œï¼Œæˆ‘ä»¬æˆ–å¤šæˆ–å°‘çš„è§åˆ°äº† pipeline çš„èº«å½±ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191115157.webp" alt="å›¾ç‰‡">Reactorå¯åŠ¨åçš„ç»“æ„.png</p> <p>æ¯”å¦‚åœ¨ Reactor å¯åŠ¨çš„è¿‡ç¨‹ä¸­é¦–å…ˆéœ€è¦åˆ›å»º NioServerSocketChannel ï¼Œåœ¨åˆ›å»ºçš„è¿‡ç¨‹ä¸­ä¼šä¸º NioServerSocketChannel åˆ›å»ºåˆ†é…ä¸€ä¸ª pipeline ï¼Œç”¨äºå¯¹ OP_ACCEPT äº‹ä»¶çš„ç¼–æ’ã€‚</p> <p>å½“ NioServerSocketChannel å‘ main reactor æ³¨å†ŒæˆåŠŸåï¼Œä¼šåœ¨ pipeline ä¸­è§¦å‘ ChannelRegistered äº‹ä»¶çš„ä¼ æ’­ã€‚</p> <p>å½“ NioServerSocketChannel ç»‘å®šç«¯å£æˆåŠŸåï¼Œä¼šåœ¨ pipeline ä¸­è§¦å‘ ChannelActive äº‹ä»¶çš„ä¼ æ’­ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191115136.webp" alt="å›¾ç‰‡">ä¸»ä»Reactorç»„å®Œæ•´ç»“æ„.png</p> <p>åˆæ¯”å¦‚åœ¨ Reactor æ¥æ”¶è¿æ¥çš„è¿‡ç¨‹ä¸­ï¼Œå½“å®¢æˆ·ç«¯å‘èµ·ä¸€ä¸ªè¿æ¥å¹¶å®Œæˆä¸‰æ¬¡æ¡æ‰‹ä¹‹åï¼Œè¿æ¥å¯¹åº”çš„ Socket ä¼šå­˜æ”¾åœ¨å†…æ ¸ä¸­çš„å…¨è¿æ¥é˜Ÿåˆ—ä¸­ï¼Œéšå JDK Selector ä¼šé€šçŸ¥ main reactor æ­¤æ—¶ NioServerSocketChannel ä¸Šæœ‰ OP_ACCEPT äº‹ä»¶æ´»è·ƒï¼Œæœ€å main reactor å¼€å§‹æ‰§è¡Œ NioServerSocketChannel çš„åº•å±‚æ“ä½œç±» NioMessageUnsafe#read æ–¹æ³•åœ¨ NioServerSocketChannel ä¸­çš„ pipeline ä¸­ä¼ æ’­ ChannelRead äº‹ä»¶ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)ä¼ æ’­ChannelReadäº‹ä»¶.png</p> <p>æœ€ç»ˆä¼šåœ¨ NioServerSocketChannel çš„ pipeline ä¸­çš„ ServerBootstrapAcceptor ä¸­å“åº” ChannelRead äº‹ä»¶å¹¶åˆ›å»ºåˆå§‹åŒ– NioSocketChannel ï¼Œéšåä¼šä¸ºæ¯ä¸€ä¸ªæ–°åˆ›å»ºçš„ NioSocetChannel åˆ›å»ºåˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„ pipeline ï¼Œç”¨äºå„è‡ª NioSocketChannel ä¸Šçš„ IO äº‹ä»¶çš„ç¼–æ’ã€‚å¹¶å‘ sub reactor æ³¨å†Œ NioSocketChannel ï¼Œéšååœ¨ NioSocketChannel çš„ pipeline ä¸­ä¼ æ’­ ChannelRegistered äº‹ä»¶ï¼Œæœ€åä¼ æ’­ ChannelActive äº‹ä»¶ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)ä¼ æ’­ChannelRegisteräº‹ä»¶.png</p> <p>è¿˜æœ‰åœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484244&amp;idx=1&amp;sn=831060fc38caa201d69f87305de7f86a&amp;chksm=ce77c513f9004c05b48f849ff99997d6d7252453135ae856a029137b88aa70b8e046013d596e&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">ã€ŠNettyå¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œæ•°æ®ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿæè¿‡å½“ sub reactor è¯»å– NioSocketChannel ä¸­æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚æ•°æ®æ—¶ï¼Œä¼šåœ¨ NioSocketChannel çš„ pipeline ä¸­ä¼ æ’­ ChannelRead äº‹ä»¶ï¼Œåœ¨ä¸€ä¸ªå®Œæ•´çš„ read loop è¯»å–å®Œæ¯•åä¼šä¼ æ’­ ChannelReadComplete äº‹ä»¶ã€‚</p> <p>åœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484532&amp;idx=1&amp;sn=c3a8b37a2eb09509d9914494ef108c68&amp;chksm=ce77c233f9004b25a29f9fdfb179e41646092d09bc89df2147a9fab66df13231e46dd6a5c26d&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">ã€Šä¸€æ–‡ææ‡‚Nettyå‘é€æ•°æ®å…¨æµç¨‹ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬è®²åˆ°äº†åœ¨ç”¨æˆ·ç»è¿‡ä¸šåŠ¡å¤„ç†åï¼Œé€šè¿‡ write æ–¹æ³•å’Œ flush æ–¹æ³•åˆ†åˆ«åœ¨ NioSocketChannel çš„ pipeline ä¸­ä¼ æ’­ write äº‹ä»¶å’Œ flush äº‹ä»¶çš„è¿‡ç¨‹ã€‚</p> <p>ç¬”è€…å¸¦å¤§å®¶åˆå›é¡¾äº†ä¸€ä¸‹åœ¨å‰è¾¹ç³»åˆ—æ–‡ç« ä¸­å…³äº pipeline çš„ä½¿ç”¨åœºæ™¯ï¼Œä½†æ˜¯åœ¨è¿™äº›ç³»åˆ—æ–‡ç« ä¸­å¹¶æœªå¯¹ pipeline ç›¸å…³çš„ç»†èŠ‚è¿›è¡Œå®Œæ•´å…¨é¢åœ°æè¿°ï¼Œé‚£ä¹ˆæœ¬æ–‡ç¬”è€…å°†ä¸ºå¤§å®¶è¯¦ç»†çš„å‰–æä¸‹ pipeline åœ¨ IO äº‹ä»¶çš„ç¼–æ’å’Œä¼ æ’­åœºæ™¯ä¸‹çš„å®Œæ•´å®ç°åŸç†ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191115172.webp" alt="å›¾ç‰‡">å†…å®¹æ¦‚è¦.png</p> <h2 id="_2-pipelineçš„åˆ›å»º"><a href="#_2-pipelineçš„åˆ›å»º" class="header-anchor">#</a> 2. pipelineçš„åˆ›å»º</h2> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)ä¸»ä»Reactorç»„å®Œæ•´ç»“æ„.png</p> <p>Netty ä¼šä¸ºæ¯ä¸€ä¸ª Channel åˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„ pipeline ï¼Œpipeline ä¼´éšç€ channel çš„åˆ›å»ºè€Œåˆ›å»ºã€‚</p> <p>å‰è¾¹ä»‹ç»åˆ° NioServerSocketChannel æ˜¯åœ¨ netty æœåŠ¡ç«¯å¯åŠ¨çš„è¿‡ç¨‹ä¸­åˆ›å»ºçš„ã€‚è€Œ NioSocketChannel çš„åˆ›å»ºæ˜¯åœ¨å½“ NioServerSocketChannel ä¸Šçš„ OP_ACCEPT äº‹ä»¶æ´»è·ƒæ—¶ï¼Œç”± main reactor çº¿ç¨‹åœ¨ NioServerSocketChannel ä¸­åˆ›å»ºï¼Œå¹¶åœ¨ NioServerSocketChannel çš„ pipeline ä¸­å¯¹ OP_ACCEPT äº‹ä»¶è¿›è¡Œç¼–æ’æ—¶ï¼ˆå›¾ä¸­çš„ ServerBootstrapAcceptor ä¸­ï¼‰åˆå§‹åŒ–çš„ã€‚</p> <p>æ— è®ºæ˜¯åˆ›å»º NioServerSocketChannel  é‡Œçš„ pipeline è¿˜æ˜¯åˆ›å»º NioSocketChannel é‡Œçš„ pipeline , æœ€ç»ˆéƒ½ä¼šå§”æ‰˜ç»™å®ƒä»¬çš„çˆ¶ç±» AbstractChannel ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191115176.webp" alt="å›¾ç‰‡">image.png</p> <div class="language- extra-class"><pre class="language-text"><code>public abstract class AbstractChannel extends DefaultAttributeMap implements Channel {

    protected AbstractChannel(Channel parent) {
        this.parent = parent;
        //channelå…¨å±€å”¯ä¸€ID machineId+processId+sequence+timestamp+random
        id = newId();
        //unsafeç”¨äºåº•å±‚socketçš„ç›¸å…³æ“ä½œ
        unsafe = newUnsafe();
        //ä¸ºchannelåˆ†é…ç‹¬ç«‹çš„pipelineç”¨äºIOäº‹ä»¶ç¼–æ’
        pipeline = newChannelPipeline();
    }

    protected DefaultChannelPipeline newChannelPipeline() {
        return new DefaultChannelPipeline(this);
    }

}
public class DefaultChannelPipeline implements ChannelPipeline {

      ....................

    //pipelineä¸­çš„å¤´ç»“ç‚¹
    final AbstractChannelHandlerContext head;
    //pipelineä¸­çš„å°¾ç»“ç‚¹
    final AbstractChannelHandlerContext tail;

    //pipelineä¸­æŒæœ‰å¯¹åº”channelçš„å¼•ç”¨
    private final Channel channel;

       ....................

    protected DefaultChannelPipeline(Channel channel) {
        //pipelineä¸­æŒæœ‰å¯¹åº”channelçš„å¼•ç”¨
        this.channel = ObjectUtil.checkNotNull(channel, &quot;channel&quot;);
        
        ............çœç•¥.......

        tail = new TailContext(this);
        head = new HeadContext(this);

        head.next = tail;
        tail.prev = head;
    }

       ....................
}
</code></pre></div><p>åœ¨å‰è¾¹çš„ç³»åˆ—æ–‡ç« ä¸­ç¬”è€…å¤šæ¬¡æåˆ°è¿‡ï¼Œpipeline çš„ç»“æ„æ˜¯ç”± ChannelHandlerContext ç±»å‹çš„èŠ‚ç‚¹æ„æˆçš„åŒå‘é“¾è¡¨ã€‚å…¶ä¸­å¤´ç»“ç‚¹ä¸º HeadContext ï¼Œå°¾ç»“ç‚¹ä¸º TailContext ã€‚å…¶åˆå§‹ç»“æ„å¦‚ä¸‹ï¼š</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)pipelineçš„åˆå§‹ç»“æ„.png</p> <h3 id="_2-1-headcontext"><a href="#_2-1-headcontext" class="header-anchor">#</a> 2.1 HeadContext</h3> <div class="language- extra-class"><pre class="language-text"><code>    private static final String HEAD_NAME = generateName0(HeadContext.class);

    final class HeadContext extends AbstractChannelHandlerContext
            implements ChannelOutboundHandler, ChannelInboundHandler {
       //headContextä¸­æŒæœ‰å¯¹channel unsafeæ“ä½œç±»çš„å¼•ç”¨ ç”¨äºæ‰§è¡Œchannelåº•å±‚æ“ä½œ
        private final Unsafe unsafe;

        HeadContext(DefaultChannelPipeline pipeline) {
            super(pipeline, null, HEAD_NAME, HeadContext.class);
            //æŒæœ‰channel unsafeæ“ä½œç±»çš„å¼•ç”¨ï¼Œåç»­ç”¨äºæ‰§è¡Œchannelåº•å±‚æ“ä½œ
            unsafe = pipeline.channel().unsafe();
            //è®¾ç½®channelHandlerçš„çŠ¶æ€ä¸ºADD_COMPLETE
            setAddComplete();
        }

        @Override
        public ChannelHandler handler() {
            return this;
        }

        .......................
    }
</code></pre></div><p>æˆ‘ä»¬çŸ¥é“åŒå‘é“¾è¡¨ç»“æ„çš„ pipeline ä¸­çš„èŠ‚ç‚¹å…ƒç´ ä¸º ChannelHandlerContext ï¼Œæ—¢ç„¶ HeadContext ä½œä¸º pipeline çš„å¤´ç»“ç‚¹ï¼Œé‚£ä¹ˆå®ƒä¸€å®šæ˜¯ ChannelHandlerContext ç±»å‹çš„ï¼Œæ‰€ä»¥å®ƒéœ€è¦ç»§æ‰¿å®ç° AbstractChannelHandlerContext ï¼Œç›¸å½“äºä¸€ä¸ªå“¨å…µçš„ä½œç”¨ï¼Œå› ä¸ºç”¨æˆ·å¯ä»¥ä»¥ä»»æ„é¡ºåºå‘ pipeline ä¸­æ·»åŠ  ChannelHandler ï¼Œéœ€è¦ç”¨ HeadContext æ¥å›ºå®šæŒ‡å‘ç¬¬ä¸€ä¸ª ChannelHandlerContext ã€‚</p> <blockquote><p>åœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484532&amp;idx=1&amp;sn=c3a8b37a2eb09509d9914494ef108c68&amp;chksm=ce77c233f9004b25a29f9fdfb179e41646092d09bc89df2147a9fab66df13231e46dd6a5c26d&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">ã€Šä¸€æ–‡ææ‡‚Nettyå‘é€æ•°æ®å…¨æµç¨‹ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ä¸€æ–‡ä¸­çš„ã€Š1. ChannelHandlerContextã€‹å°èŠ‚ä¸­ï¼Œç¬”è€…æ›¾ä¸ºå¤§å®¶è¯¦ç»†ä»‹ç»è¿‡ ChannelHandlerContext åœ¨ pipeline ä¸­çš„ä½œç”¨ï¼Œå¿˜è®°çš„åŒå­¦å¯ä»¥åœ¨å›çœ‹ä¸‹ã€‚</p></blockquote> <p>äºæ­¤åŒæ—¶ HeadContext åˆå®ç°äº† ChannelInboundHandler å’Œ ChannelOutboundHandler  æ¥å£ï¼Œè¯´æ˜ HeadContext å³æ˜¯ä¸€ä¸ª ChannelHandlerContext åˆæ˜¯ä¸€ä¸ª ChannelHandler ï¼Œå®ƒå¯ä»¥åŒæ—¶å¤„ç† Inbound äº‹ä»¶å’Œ Outbound äº‹ä»¶ã€‚</p> <p>æˆ‘ä»¬ä¹Ÿæ³¨æ„åˆ° HeadContext ä¸­æŒæœ‰äº†å¯¹åº” channel çš„åº•å±‚æ“ä½œç±» unsafe ï¼Œè¿™ä¹Ÿè¯´æ˜ IO äº‹ä»¶åœ¨ pipeline ä¸­çš„ä¼ æ’­æœ€ç»ˆä¼šè½åœ¨ HeadContext ä¸­è¿›è¡Œæœ€åçš„ IO å¤„ç†ã€‚å®ƒæ˜¯ Inbound äº‹ä»¶çš„å¤„ç†èµ·ç‚¹ï¼Œä¹Ÿæ˜¯ Outbound äº‹ä»¶çš„å¤„ç†ç»ˆç‚¹ã€‚è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡º HeadContext é™¤äº†èµ·åˆ°å“¨å…µçš„ä½œç”¨ï¼Œå®ƒè¿˜æ‰¿æ‹…äº†å¯¹ channel åº•å±‚ç›¸å…³çš„æ“ä½œã€‚</p> <p>æ¯”å¦‚æˆ‘ä»¬åœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484005&amp;idx=1&amp;sn=52f51269902a58f40d33208421109bc3&amp;chksm=ce77c422f9004d340e5b385ef6ba24dfba1f802076ace80ad6390e934173a10401e64e13eaeb&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">ã€ŠReactoråœ¨Nettyä¸­çš„å®ç°(å¯åŠ¨ç¯‡)ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸­ä»‹ç»çš„ NioServerSocketChannel åœ¨å‘ main reactor æ³¨å†Œå®Œæˆåä¼šè§¦å‘ ChannelRegistered äº‹ä»¶ä» HeadContext å¼€å§‹ä¾æ¬¡åœ¨ pipeline ä¸­å‘åä¼ æ’­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>      @Override
        public void channelRegistered(ChannelHandlerContext ctx) {
            //æ­¤æ—¶firstRegistrationå·²ç»å˜ä¸ºfalse,åœ¨pipeline.invokeHandlerAddedIfNeededä¸­å·²è¢«è°ƒç”¨è¿‡
            invokeHandlerAddedIfNeeded();
            ctx.fireChannelRegistered();
        }
</code></pre></div><p>ä»¥åŠ NioServerSocketChannel åœ¨ä¸ç«¯å£ç»‘å®šæˆåŠŸåä¼šè§¦å‘ ChannelActive äº‹ä»¶ä» HeadContext å¼€å§‹ä¾æ¬¡åœ¨ pipeline ä¸­å‘åä¼ æ’­ï¼Œå¹¶åœ¨ HeadContext ä¸­é€šè¿‡ unsafe.beginRead() æ³¨å†Œ OP_ACCEPT äº‹ä»¶åˆ° main reactor ä¸­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>     @Override
        public void read(ChannelHandlerContext ctx) {
            //è§¦å‘æ³¨å†ŒOP_ACCEPTæˆ–è€…OP_READäº‹ä»¶
            unsafe.beginRead();
        }
</code></pre></div><p>åŒç†åœ¨ NioSocketChannel åœ¨å‘ sub reactor æ³¨å†ŒæˆåŠŸåã€‚ä¼šå…ˆåè§¦å‘ ChannelRegistered äº‹ä»¶å’Œ ChannelActive äº‹ä»¶ä» HeadContext å¼€å§‹åœ¨ pipeline ä¸­å‘åä¼ æ’­ã€‚å¹¶åœ¨ HeadContext ä¸­é€šè¿‡ unsafe.beginRead() æ³¨å†Œ OP_READ äº‹ä»¶åˆ° sub reactor ä¸­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>        @Override
        public void channelActive(ChannelHandlerContext ctx) {
            //pipelineä¸­ç»§ç»­å‘åä¼ æ’­channelActiveäº‹ä»¶
            ctx.fireChannelActive();
            //å¦‚æœæ˜¯autoRead åˆ™è‡ªåŠ¨è§¦å‘readäº‹ä»¶ä¼ æ’­
            //åœ¨readå›è°ƒå‡½æ•°ä¸­ è§¦å‘OP_ACCEPTæˆ–è€…OP_READäº‹ä»¶æ³¨å†Œ
            readIfIsAutoRead();
        }
</code></pre></div><p>åœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484532&amp;idx=1&amp;sn=c3a8b37a2eb09509d9914494ef108c68&amp;chksm=ce77c233f9004b25a29f9fdfb179e41646092d09bc89df2147a9fab66df13231e46dd6a5c26d&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">ã€Šä¸€æ–‡ææ‡‚Nettyå‘é€æ•°æ®å…¨æµç¨‹ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸­ä»‹ç»çš„ write äº‹ä»¶å’Œ flush äº‹ä»¶æœ€ç»ˆä¼šåœ¨ pipeline ä¸­ä»åå‘å‰ä¸€ç›´ä¼ æ’­åˆ° HeadContext ï¼Œå¹¶åœ¨ HeadContext ä¸­ç›¸åº”äº‹ä»¶å›è°ƒå‡½æ•°ä¸­è°ƒç”¨ unsafe ç±»æ“ä½œåº•å±‚ channel å‘é€æ•°æ®ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>        @Override
        public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) {
            //åˆ°headContextè¿™é‡Œ msgçš„ç±»å‹å¿…é¡»æ˜¯ByteBufferï¼Œä¹Ÿå°±æ˜¯è¯´å¿…é¡»ç»è¿‡ç¼–ç å™¨å°†ä¸šåŠ¡å±‚å†™å…¥çš„å®ä½“ç¼–ç ä¸ºByteBuffer
            unsafe.write(msg, promise);
        }

        @Override
        public void flush(ChannelHandlerContext ctx) {
            unsafe.flush();
        }
</code></pre></div><blockquote><p>ä»æœ¬å°èŠ‚çš„å†…å®¹ä»‹ç»ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºåœ¨ Netty ä¸­å¯¹äº Channel çš„ç›¸å…³åº•å±‚æ“ä½œè°ƒç”¨å‡æ˜¯åœ¨ HeadContext ä¸­è§¦å‘çš„ã€‚</p></blockquote> <h3 id="_2-2-tailcontext"><a href="#_2-2-tailcontext" class="header-anchor">#</a> 2.2 TailContext</h3> <div class="language- extra-class"><pre class="language-text"><code>    private static final String TAIL_NAME = generateName0(TailContext.class);

    final class TailContext extends AbstractChannelHandlerContext implements ChannelInboundHandler {

        TailContext(DefaultChannelPipeline pipeline) {
            super(pipeline, null, TAIL_NAME, TailContext.class);
            //è®¾ç½®channelHandlerçš„çŠ¶æ€ä¸ºADD_COMPLETE
            setAddComplete();
        }

        @Override
        public ChannelHandler handler() {
            return this;
        }
    
        ......................
}
</code></pre></div><p>åŒæ · TailContext ä½œä¸ºåŒå‘é“¾è¡¨ç»“æ„çš„ pipeline ä¸­çš„å°¾ç»“ç‚¹ï¼Œä¹Ÿéœ€è¦ç»§æ‰¿å®ç° AbstractChannelHandlerContext ã€‚ä½†å®ƒåŒæ—¶åˆå®ç°äº† ChannelInboundHandler ã€‚</p> <p>è¿™è¯´æ˜ TailContext é™¤äº†æ˜¯ä¸€ä¸ª ChannelHandlerContext åŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ª ChannelInboundHandler ã€‚</p> <h4 id="_2-2-1-tailcontext-ä½œä¸ºä¸€ä¸ª-channelhandlercontext-çš„ä½œç”¨"><a href="#_2-2-1-tailcontext-ä½œä¸ºä¸€ä¸ª-channelhandlercontext-çš„ä½œç”¨" class="header-anchor">#</a> 2.2.1 TailContext ä½œä¸ºä¸€ä¸ª ChannelHandlerContext çš„ä½œç”¨</h4> <p>TailContext ä½œä¸ºä¸€ä¸ª ChannelHandlerContext çš„ä½œç”¨æ˜¯è´Ÿè´£å°† outbound äº‹ä»¶ä» pipeline çš„æœ«å°¾ä¸€ç›´å‘å‰ä¼ æ’­ç›´åˆ° HeadContext ã€‚å½“ç„¶å‰ææ˜¯ç”¨æˆ·éœ€è¦è°ƒç”¨ channel çš„ç›¸å…³ outbound æ–¹æ³•ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public interface Channel extends AttributeMap, ChannelOutboundInvoker, Comparable&lt;Channel&gt; {

    ChannelFuture write(Object msg);

    ChannelFuture write(Object msg, ChannelPromise promise);

    ChannelOutboundInvoker flush();

    ChannelFuture writeAndFlush(Object msg, ChannelPromise promise);

    ChannelFuture writeAndFlush(Object msg);

}
public abstract class AbstractChannel extends DefaultAttributeMap implements Channel {

   @Override
    public ChannelFuture write(Object msg) {
        return pipeline.write(msg);
    }

    @Override
    public Channel flush() {
        pipeline.flush();
        return this;
    }

    @Override
    public ChannelFuture writeAndFlush(Object msg) {
        return pipeline.writeAndFlush(msg);
    }
}
public class DefaultChannelPipeline implements ChannelPipeline {

   @Override
    public final ChannelFuture write(Object msg) {
        return tail.write(msg);
    }

    @Override
    public final ChannelPipeline flush() {
        tail.flush();
        return this;
    }

   @Override
    public final ChannelFuture writeAndFlush(Object msg) {
        return tail.writeAndFlush(msg);
    }

}
</code></pre></div><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘ä»¬åœ¨è‡ªå®šä¹‰ ChannelHandler ä¸­è°ƒç”¨ <code>ctx.channel().write(msg)</code> æ—¶ï¼Œä¼šåœ¨ AbstractChannel ä¸­è§¦å‘ pipeline.write(msg) ï¼Œæœ€ç»ˆåœ¨ DefaultChannelPipeline ä¸­è°ƒç”¨ tail.write(msg) ã€‚ä½¿å¾— write äº‹ä»¶å¯ä»¥ä» pipeline çš„æœ«å°¾å¼€å§‹å‘å‰ä¼ æ’­ï¼Œå…¶ä»– outbound äº‹ä»¶çš„ä¼ æ’­ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class EchoServerHandler extends ChannelInboundHandlerAdapter {

    @Override
    public void channelRead(final ChannelHandlerContext ctx, final Object msg) {
        ctx.channel().write(msg);
    }

}
</code></pre></div><p>è€Œæˆ‘ä»¬è‡ªå®šä¹‰çš„ ChannelHandler ä¼šè¢«å°è£…åœ¨ä¸€ä¸ª ChannelHandlerContext ä¸­ä»è€ŒåŠ å…¥åˆ° pipeline ä¸­ï¼Œè€Œè¿™ä¸ªç”¨äºè£…è½½è‡ªå®šä¹‰ ChannelHandler çš„ ChannelHandlerContext ä¸ TailContext ä¸€æ ·æœ¬è´¨ä¹Ÿéƒ½æ˜¯ ChannelHandlerContext ï¼Œåªä¸è¿‡åœ¨ pipeline ä¸­çš„ä½ç½®ä¸åŒç½¢äº†ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191115318.webp" alt="å›¾ç‰‡">å®¢æˆ·ç«¯channel pipelineç»“æ„.png</p> <div class="language- extra-class"><pre class="language-text"><code>public interface ChannelHandlerContext extends AttributeMap, ChannelInboundInvoker, ChannelOutboundInvoker {

    ChannelFuture write(Object msg);

    ChannelFuture write(Object msg, ChannelPromise promise);

    ChannelOutboundInvoker flush();

    ChannelFuture writeAndFlush(Object msg, ChannelPromise promise);

    ChannelFuture writeAndFlush(Object msg);

}
</code></pre></div><p>æˆ‘ä»¬çœ‹åˆ° ChannelHandlerContext æ¥å£æœ¬èº«ä¹Ÿä¼šç»§æ‰¿ ChannelInboundInvoker å’Œ ChannelOutboundInvoker æ¥å£ï¼Œæ‰€ä»¥è¯´ ContextHandlerContext ä¹Ÿå¯ä»¥è§¦å‘ inbound äº‹ä»¶å’Œ outbound äº‹ä»¶ï¼Œåªä¸è¿‡è¡¨è¾¾çš„è¯­ä¹‰æ˜¯åœ¨ pipeline ä¸­ä»å½“å‰ ChannelHandler å¼€å§‹å‘å‰æˆ–è€…å‘åä¼ æ’­ outbound äº‹ä»¶æˆ–è€… inbound äº‹ä»¶ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class EchoServerHandler extends ChannelInboundHandlerAdapter {

    @Override
    public void channelRead(final ChannelHandlerContext ctx, final Object msg) {
        ctx.write(msg);
    }

}
</code></pre></div><p>è¿™é‡Œè¡¨ç¤º write äº‹ä»¶ä»å½“å‰ EchoServerHandler å¼€å§‹åœ¨ pipeline ä¸­å‘å‰ä¼ æ’­ç›´åˆ° HeadContext ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)å®¢æˆ·ç«¯channel pipelineç»“æ„.png</p> <h4 id="_2-2-2-tailcontext-ä½œä¸ºä¸€ä¸ª-channelinboundhandler-çš„ä½œç”¨"><a href="#_2-2-2-tailcontext-ä½œä¸ºä¸€ä¸ª-channelinboundhandler-çš„ä½œç”¨" class="header-anchor">#</a> 2.2.2 TailContext ä½œä¸ºä¸€ä¸ª ChannelInboundHandler çš„ä½œç”¨</h4> <p>æœ€å TailContext ä½œä¸ºä¸€ä¸ª ChannelInboundHandler çš„ä½œç”¨å°±æ˜¯ä¸º inbound äº‹ä»¶åœ¨ pipeline ä¸­çš„ä¼ æ’­åšä¸€ä¸ªå…œåº•çš„å¤„ç†ã€‚</p> <p>è¿™é‡Œæåˆ°çš„å…œåº•å¤„ç†æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ</p> <p>æ¯”å¦‚æˆ‘ä»¬å‰è¾¹ä»‹ç»åˆ°çš„ï¼Œåœ¨ NioSocketChannel å‘ sub reactor æ³¨å†ŒæˆåŠŸåä¹‹åè§¦å‘çš„ ChannelRegistered äº‹ä»¶å’Œ ChannelActive äº‹ä»¶ã€‚æˆ–è€…åœ¨ reactor çº¿ç¨‹è¯»å– NioSocketChannel ä¸­çš„è¯·æ±‚æ•°æ®æ—¶æ‰€è§¦å‘çš„ channelRead äº‹ä»¶å’Œ ChannelReadComplete äº‹ä»¶ã€‚</p> <p>è¿™äº› inbound äº‹ä»¶éƒ½ä¼šé¦–å…ˆä» HeadContext å¼€å§‹åœ¨ pipeline ä¸­ä¸€ä¸ªä¸€ä¸ªçš„å‘åä¼ é€’ã€‚</p> <p>æç«¯çš„æƒ…å†µæ˜¯å¦‚æœ pipeline ä¸­æ‰€æœ‰ ChannelInboundHandler ä¸­ç›¸åº”çš„ inbound äº‹ä»¶å›è°ƒæ–¹æ³•å‡ä¸å¯¹äº‹ä»¶ä½œå‡ºå¤„ç†ï¼Œå¹¶ç»§ç»­å‘åä¼ æ’­ã€‚å¦‚ä¸‹ç¤ºä¾‹ä»£ç æ‰€ç¤ºï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>public class EchoServerHandler extends ChannelInboundHandlerAdapter {

    @Override
    public void channelRead(final ChannelHandlerContext ctx, final Object msg) {
        ctx.fireChannelRead(msg);
    }

    @Override
    public void channelReadComplete(ChannelHandlerContext ctx) {
        ctx.fireChannelReadComplete();
    }

    @Override
    public void channelRegistered(ChannelHandlerContext ctx) throws Exception {
        ctx.fireChannelRegistered();
    }

    @Override
    public void channelActive(ChannelHandlerContext ctx) throws Exception {
        ctx.fireChannelActive();
    }
}
</code></pre></div><p>æœ€ç»ˆè¿™äº› inbound äº‹ä»¶åœ¨ pipeline ä¸­å¾—ä¸åˆ°å¤„ç†ï¼Œæœ€åä¼šä¼ æ’­åˆ° TailContext ä¸­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>final class TailContext extends AbstractChannelHandlerContext implements ChannelInboundHandler {

        @Override
        public void channelRead(ChannelHandlerContext ctx, Object msg) {
            onUnhandledInboundMessage(ctx, msg);
        }

        @Override
        public void channelReadComplete(ChannelHandlerContext ctx) {
            onUnhandledInboundChannelReadComplete();
        }

        @Override
        public void channelActive(ChannelHandlerContext ctx) {
            onUnhandledInboundChannelActive();
        }

}
</code></pre></div><p>è€Œåœ¨ TailContext ä¸­éœ€è¦å¯¹è¿™äº›å¾—ä¸åˆ°ä»»ä½•å¤„ç†çš„ inbound äº‹ä»¶åšå‡ºæœ€ç»ˆå¤„ç†ã€‚æ¯”å¦‚ä¸¢å¼ƒè¯¥ msgï¼Œå¹¶é‡Šæ”¾æ‰€å ç”¨çš„ directByteBufferï¼Œä»¥å…å‘ç”Ÿå†…å­˜æ³„éœ²ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    protected void onUnhandledInboundMessage(ChannelHandlerContext ctx, Object msg) {
        onUnhandledInboundMessage(msg);
        if (logger.isDebugEnabled()) {
            logger.debug(&quot;Discarded message pipeline : {}. Channel : {}.&quot;,
                         ctx.pipeline().names(), ctx.channel());
        }
    }

    protected void onUnhandledInboundMessage(Object msg) {
        try {
            logger.debug(
                    &quot;Discarded inbound message {} that reached at the tail of the pipeline. &quot; +
                            &quot;Please check your pipeline configuration.&quot;, msg);
        } finally {
            ReferenceCountUtil.release(msg);
        }
    }
</code></pre></div><h2 id="_3-pipelineä¸­çš„äº‹ä»¶åˆ†ç±»"><a href="#_3-pipelineä¸­çš„äº‹ä»¶åˆ†ç±»" class="header-anchor">#</a> 3. pipelineä¸­çš„äº‹ä»¶åˆ†ç±»</h2> <p>åœ¨å‰è¾¹çš„ç³»åˆ—æ–‡ç« ä¸­ï¼Œç¬”è€…å¤šæ¬¡ä»‹ç»è¿‡ï¼ŒNetty ä¸­çš„ IO äº‹ä»¶ä¸€å…±åˆ†ä¸ºä¸¤å¤§ç±»ï¼šinbound ç±»äº‹ä»¶å’Œ outbound ç±»äº‹ä»¶ã€‚å…¶å®å¦‚æœä¸¥æ ¼æ¥åˆ†çš„è¯åº”è¯¥åˆ†ä¸ºä¸‰ç±»ã€‚ç¬¬ä¸‰ç§äº‹ä»¶ç±»å‹ä¸º exceptionCaught å¼‚å¸¸äº‹ä»¶ç±»å‹ã€‚</p> <p>è€Œ exceptionCaught äº‹ä»¶åœ¨äº‹ä»¶ä¼ æ’­è§’åº¦ä¸Šæ¥è¯´å’Œ inbound ç±»äº‹ä»¶ä¸€æ ·ï¼Œéƒ½æ˜¯ä» pipeline çš„ HeadContext å¼€å§‹ä¸€ç›´å‘åä¼ é€’æˆ–è€…ä»å½“å‰ ChannelHandler å¼€å§‹ä¸€ç›´å‘åä¼ é€’ç›´åˆ° TailContext ã€‚æ‰€ä»¥ä¸€èˆ¬ä¹Ÿä¼šå°† exceptionCaught äº‹ä»¶ç»Ÿä¸€å½’ä¸º inbound ç±»äº‹ä»¶ã€‚</p> <p>è€Œæ ¹æ®äº‹ä»¶ç±»å‹çš„åˆ†ç±»ï¼Œç›¸åº”è´Ÿè´£å¤„ç†äº‹ä»¶å›è°ƒçš„ ChannelHandler ä¹Ÿä¼šè¢«åˆ†ä¸ºä¸¤ç±»ï¼š</p> <ul><li><code>ChannelInboundHandler</code> ï¼šä¸»è¦è´Ÿè´£å“åº”å¤„ç† inbound ç±»äº‹ä»¶å›è°ƒå’Œ exceptionCaught äº‹ä»¶å›è°ƒã€‚</li> <li><code>ChannelOutboundHandler</code> ï¼šä¸»è¦è´Ÿè´£å“åº”å¤„ç† outbound ç±»äº‹ä»¶å›è°ƒã€‚</li></ul> <p>é‚£ä¹ˆæˆ‘ä»¬å¸¸è¯´çš„ inbound ç±»äº‹ä»¶å’Œ outbound ç±»äº‹ä»¶å…·ä½“éƒ½åŒ…å«å“ªäº›äº‹ä»¶å‘¢ï¼Ÿ</p> <h3 id="_3-1-inboundç±»äº‹ä»¶"><a href="#_3-1-inboundç±»äº‹ä»¶" class="header-anchor">#</a> 3.1 inboundç±»äº‹ä»¶</h3> <div class="language- extra-class"><pre class="language-text"><code>final class ChannelHandlerMask {

    // inboundäº‹ä»¶é›†åˆ
    static final int MASK_ONLY_INBOUND =  MASK_CHANNEL_REGISTERED |
            MASK_CHANNEL_UNREGISTERED | MASK_CHANNEL_ACTIVE | MASK_CHANNEL_INACTIVE | MASK_CHANNEL_READ |
            MASK_CHANNEL_READ_COMPLETE | MASK_USER_EVENT_TRIGGERED | MASK_CHANNEL_WRITABILITY_CHANGED;

    private static final int MASK_ALL_INBOUND = MASK_EXCEPTION_CAUGHT | MASK_ONLY_INBOUND;

    // inbound ç±»äº‹ä»¶ç›¸å…³æ©ç 
    static final int MASK_EXCEPTION_CAUGHT = 1;
    static final int MASK_CHANNEL_REGISTERED = 1 &lt;&lt; 1;
    static final int MASK_CHANNEL_UNREGISTERED = 1 &lt;&lt; 2;
    static final int MASK_CHANNEL_ACTIVE = 1 &lt;&lt; 3;
    static final int MASK_CHANNEL_INACTIVE = 1 &lt;&lt; 4;
    static final int MASK_CHANNEL_READ = 1 &lt;&lt; 5;
    static final int MASK_CHANNEL_READ_COMPLETE = 1 &lt;&lt; 6;
    static final int MASK_USER_EVENT_TRIGGERED = 1 &lt;&lt; 7;
    static final int MASK_CHANNEL_WRITABILITY_CHANGED = 1 &lt;&lt; 8;

}
</code></pre></div><p>netty ä¼šå°†å…¶æ”¯æŒçš„æ‰€æœ‰å¼‚æ­¥äº‹ä»¶ç”¨æ©ç æ¥è¡¨ç¤ºï¼Œå®šä¹‰åœ¨ ChannelHandlerMask ç±»ä¸­ï¼Œ netty æ¡†æ¶é€šè¿‡è¿™äº›äº‹ä»¶æ©ç å¯ä»¥å¾ˆæ–¹ä¾¿çš„çŸ¥é“ç”¨æˆ·è‡ªå®šä¹‰çš„ ChannelHandler æ˜¯å±äºä»€ä¹ˆç±»å‹çš„ï¼ˆChannelInboundHandler or ChannelOutboundHandler ï¼‰ã€‚</p> <p>é™¤æ­¤ä¹‹å¤–ï¼Œinbound ç±»äº‹ä»¶å¦‚æ­¤ä¹‹å¤šï¼Œç”¨æˆ·ä¹Ÿå¹¶ä¸æ˜¯å¯¹æ‰€æœ‰çš„ inbound ç±»äº‹ä»¶æ„Ÿå…´è¶£ï¼Œç”¨æˆ·å¯ä»¥åœ¨è‡ªå®šä¹‰çš„ ChannelInboundHandler ä¸­è¦†ç›–è‡ªå·±æ„Ÿå…´è¶£çš„ inbound äº‹ä»¶å›è°ƒï¼Œä»è€Œè¾¾åˆ°é’ˆå¯¹ç‰¹å®š inbound äº‹ä»¶çš„ç›‘å¬ã€‚</p> <p>è¿™äº›ç”¨æˆ·æ„Ÿå…´è¶£çš„ inbound äº‹ä»¶é›†åˆåŒæ ·ä¹Ÿä¼šç”¨æ©ç çš„å½¢å¼ä¿å­˜åœ¨è‡ªå®šä¹‰ ChannelHandler å¯¹åº”çš„ ChannelHandlerContext ä¸­ï¼Œè¿™æ ·å½“ç‰¹å®š inbound äº‹ä»¶åœ¨ pipeline ä¸­å¼€å§‹ä¼ æ’­çš„æ—¶å€™ï¼Œnetty å¯ä»¥æ ¹æ®å¯¹åº” ChannelHandlerContext ä¸­ä¿å­˜çš„ inbound äº‹ä»¶é›†åˆæ©ç æ¥åˆ¤æ–­ï¼Œç”¨æˆ·è‡ªå®šä¹‰çš„ ChannelHandler æ˜¯å¦å¯¹è¯¥ inbound äº‹ä»¶æ„Ÿå…´è¶£ï¼Œä»è€Œå†³å®šæ˜¯å¦æ‰§è¡Œç”¨æˆ·è‡ªå®šä¹‰ ChannelHandler ä¸­çš„ç›¸åº”å›è°ƒæ–¹æ³•æˆ–è€…è·³è¿‡å¯¹è¯¥ inbound äº‹ä»¶ä¸æ„Ÿå…´è¶£çš„ ChannelHandler ç»§ç»­å‘åä¼ æ’­ã€‚</p> <blockquote><p>ä»ä»¥ä¸Šæè¿°ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çª¥æ¢å‡ºï¼ŒNetty å¼•å…¥ ChannelHandlerContext æ¥å°è£… ChannelHandler çš„åŸå› ï¼Œåœ¨ä»£ç è®¾è®¡ä¸Šè¿˜æ˜¯éµå¾ªå•ä¸€èŒè´£çš„åŸåˆ™ï¼Œ ChannelHandler æ˜¯ç”¨æˆ·æ¥è§¦æœ€é¢‘ç¹çš„ä¸€ä¸ª netty ç»„ä»¶ï¼Œnetty å¸Œæœ›ç”¨æˆ·èƒ½å¤ŸæŠŠå…¨éƒ¨æ³¨æ„åŠ›æ”¾åœ¨æœ€æ ¸å¿ƒçš„ IO å¤„ç†ä¸Šï¼Œç”¨æˆ·åªéœ€è¦å…³å¿ƒè‡ªå·±å¯¹å“ªäº›å¼‚æ­¥äº‹ä»¶æ„Ÿå…´è¶£å¹¶è€ƒè™‘ç›¸åº”çš„å¤„ç†é€»è¾‘å³å¯ï¼Œè€Œå¹¶ä¸éœ€è¦å…³å¿ƒå¼‚æ­¥äº‹ä»¶åœ¨ pipeline ä¸­å¦‚ä½•ä¼ é€’ï¼Œå¦‚ä½•é€‰æ‹©å…·æœ‰æ‰§è¡Œæ¡ä»¶çš„ ChannelHandler å»æ‰§è¡Œæˆ–è€…è·³è¿‡ã€‚è¿™äº›åˆ‡é¢æ€§è´¨çš„é€»è¾‘ï¼Œnetty å°†å®ƒä»¬ä½œä¸ºä¸Šä¸‹æ–‡ä¿¡æ¯å…¨éƒ¨å°è£…åœ¨ ChannelHandlerContext ä¸­ç”±nettyæ¡†æ¶æœ¬èº«è´Ÿè´£å¤„ç†ã€‚</p></blockquote> <blockquote><p>ä»¥ä¸Šè¿™äº›å†…å®¹ï¼Œç¬”è€…è¿˜ä¼šåœ¨äº‹ä»¶ä¼ æ’­ç›¸å…³å°èŠ‚åšè¯¦ç»†çš„ä»‹ç»ï¼Œä¹‹æ‰€ä»¥è¿™é‡Œå¼•å‡ºï¼Œè¿˜æ˜¯ä¸ºäº†è®©å¤§å®¶æ„Ÿå—ä¸‹åˆ©ç”¨æ©ç è¿›è¡Œé›†åˆæ“ä½œçš„ä¾¿åˆ©æ€§ï¼Œnetty ä¸­ç±»ä¼¼è¿™æ ·çš„è®¾è®¡è¿˜æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚å‰è¾¹ç³»åˆ—æ–‡ç« ä¸­å¤šæ¬¡æåˆ°è¿‡çš„ï¼Œchannel å†å‘ reactor æ³¨å†Œ IO äº‹ä»¶æ—¶ï¼Œnetty ä¹Ÿæ˜¯å°† channel æ„Ÿå…´è¶£çš„ IO äº‹ä»¶ç”¨æ©ç çš„å½¢å¼å­˜å‚¨äº SelectionKey ä¸­çš„ int interestOps ä¸­ã€‚</p></blockquote> <p>æ¥ä¸‹æ¥ç¬”è€…å°±ä¸ºå¤§å®¶ä»‹ç»ä¸‹è¿™äº› inbound äº‹ä»¶ï¼Œå¹¶æ¢³ç†å‡ºè¿™äº› inbound äº‹ä»¶çš„è§¦å‘æ—¶æœºã€‚æ–¹ä¾¿å¤§å®¶æ ¹æ®å„è‡ªä¸šåŠ¡éœ€æ±‚çµæ´»åœ°è¿›è¡Œç›‘å¬ã€‚</p> <h3 id="_3-1-1-exceptioncaught-äº‹ä»¶"><a href="#_3-1-1-exceptioncaught-äº‹ä»¶" class="header-anchor">#</a> 3.1.1 ExceptionCaught äº‹ä»¶</h3> <p>åœ¨æœ¬å°èŠ‚ä»‹ç»çš„è¿™äº› inbound ç±»äº‹ä»¶åœ¨ pipeline ä¸­ä¼ æ’­çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœåœ¨ç›¸åº”äº‹ä»¶å›è°ƒå‡½æ•°æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œé‚£ä¹ˆå°±ä¼šè§¦å‘å¯¹åº” ChannelHandler ä¸­çš„ exceptionCaught äº‹ä»¶å›è°ƒã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private void invokeExceptionCaught(final Throwable cause) {
        if (invokeHandler()) {
            try {
                handler().exceptionCaught(this, cause);
            } catch (Throwable error) {
                if (logger.isDebugEnabled()) {
                    logger.debug(
                        &quot;An exception {}&quot; +
                        &quot;was thrown by a user handler's exceptionCaught() &quot; +
                        &quot;method while handling the following exception:&quot;,
                        ThrowableUtil.stackTraceToString(error), cause);
                } else if (logger.isWarnEnabled()) {
                    logger.warn(
                        &quot;An exception '{}' [enable DEBUG level for full stacktrace] &quot; +
                        &quot;was thrown by a user handler's exceptionCaught() &quot; +
                        &quot;method while handling the following exception:&quot;, error, cause);
                }
            }
        } else {
            fireExceptionCaught(cause);
        }
    }
</code></pre></div><p>å½“ç„¶ç”¨æˆ·å¯ä»¥é€‰æ‹©åœ¨ exceptionCaught äº‹ä»¶å›è°ƒä¸­æ˜¯å¦æ‰§è¡Œ ctx.fireExceptionCaught(cause) ä»è€Œå†³å®šæ˜¯å¦å°† exceptionCaught äº‹ä»¶ç»§ç»­å‘åä¼ æ’­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) {
        ..........
        ctx.fireExceptionCaught(cause);
    }
</code></pre></div><p>å½“ netty å†…æ ¸å¤„ç†è¿æ¥çš„æ¥æ”¶ï¼Œä»¥åŠæ•°æ®çš„è¯»å–è¿‡ç¨‹ä¸­å¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œä¼šåœ¨æ•´ä¸ª pipeline ä¸­è§¦å‘ exceptionCaught äº‹ä»¶çš„ä¼ æ’­ã€‚</p> <p><strong>è¿™é‡Œç¬”è€…ä¸ºä»€ä¹ˆè¦å•ç‹¬å¼ºè°ƒåœ¨ inbound äº‹ä»¶ä¼ æ’­çš„è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œæ‰ä¼šå›è°ƒ exceptionCaught å‘¢</strong> ?</p> <p>å› ä¸º inbound äº‹ä»¶ä¸€èˆ¬éƒ½æ˜¯ç”± netty å†…æ ¸è§¦å‘ä¼ æ’­çš„ï¼Œè€Œ outbound äº‹ä»¶ä¸€èˆ¬éƒ½æ˜¯ç”±ç”¨æˆ·é€‰æ‹©è§¦å‘çš„ï¼Œæ¯”å¦‚ç”¨æˆ·åœ¨å¤„ç†å®Œä¸šåŠ¡é€»è¾‘è§¦å‘çš„ write äº‹ä»¶æˆ–è€… flush äº‹ä»¶ã€‚</p> <p>è€Œåœ¨ç”¨æˆ·è§¦å‘ outbound äº‹ä»¶åï¼Œä¸€èˆ¬éƒ½ä¼šå¾—åˆ°ä¸€ä¸ª ChannelPromise ã€‚ç”¨æˆ·å¯ä»¥å‘ ChannelPromise æ·»åŠ å„ç§ listener ã€‚å½“ outbound äº‹ä»¶åœ¨ä¼ æ’­çš„è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œnetty ä¼šé€šçŸ¥ç”¨æˆ·æŒæœ‰çš„è¿™ä¸ª ChannelPromise ï¼Œ<strong>ä½†ä¸ä¼šè§¦å‘ exceptionCaught çš„å›è°ƒ</strong>ã€‚</p> <p>æ¯”å¦‚æˆ‘ä»¬åœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484532&amp;idx=1&amp;sn=c3a8b37a2eb09509d9914494ef108c68&amp;chksm=ce77c233f9004b25a29f9fdfb179e41646092d09bc89df2147a9fab66df13231e46dd6a5c26d&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">ã€Šä¸€æ–‡ææ‡‚Nettyå‘é€æ•°æ®å…¨æµç¨‹ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸€æ–‡ä¸­ä»‹ç»åˆ°çš„åœ¨ write äº‹ä»¶ä¼ æ’­çš„è¿‡ç¨‹ä¸­å°±ä¸ä¼šè§¦å‘ exceptionCaught äº‹ä»¶å›è°ƒã€‚åªæ˜¯å»é€šçŸ¥ç”¨æˆ·çš„ ChannelPromise ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private void invokeWrite0(Object msg, ChannelPromise promise) {
        try {
            //è°ƒç”¨å½“å‰ChannelHandlerä¸­çš„writeæ–¹æ³•
            ((ChannelOutboundHandler) handler()).write(this, msg, promise);
        } catch (Throwable t) {
            notifyOutboundHandlerException(t, promise);
        }
    }

    private static void notifyOutboundHandlerException(Throwable cause, ChannelPromise promise) {
        PromiseNotificationUtil.tryFailure(promise, cause, promise instanceof VoidChannelPromise ? null : logger);
    }
</code></pre></div><p><strong>è€Œ outbound äº‹ä»¶ä¸­åªæœ‰ flush äº‹ä»¶çš„ä¼ æ’­æ˜¯ä¸ªä¾‹å¤–</strong>ï¼Œå½“ flush äº‹ä»¶åœ¨ pipeline ä¼ æ’­çš„è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œä¼šè§¦å‘å¯¹åº”å¼‚å¸¸ ChannelHandler çš„ exceptionCaught äº‹ä»¶å›è°ƒã€‚å› ä¸º flush æ–¹æ³•çš„ç­¾åä¸­ä¸ä¼šç»™ç”¨æˆ·è¿”å› ChannelPromise ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    ChannelHandlerContext flush();
    private void invokeFlush0() {
        try {
            ((ChannelOutboundHandler) handler()).flush(this);
        } catch (Throwable t) {
            invokeExceptionCaught(t);
        }
    }
</code></pre></div><h3 id="_3-1-2-channelregistered-äº‹ä»¶"><a href="#_3-1-2-channelregistered-äº‹ä»¶" class="header-anchor">#</a> 3.1.2 ChannelRegistered äº‹ä»¶</h3> <p>å½“ main reactor åœ¨å¯åŠ¨çš„æ—¶å€™ï¼ŒNioServerSocketChannel ä¼šè¢«åˆ›å»ºå¹¶åˆå§‹åŒ–ï¼Œéšåå°±ä¼šå‘main reactoræ³¨å†Œï¼Œå½“æ³¨å†ŒæˆåŠŸåå°±ä¼šåœ¨ NioServerSocketChannel ä¸­çš„ pipeline ä¸­ä¼ æ’­ ChannelRegistered äº‹ä»¶ã€‚</p> <p>å½“ main reactor æ¥æ”¶å®¢æˆ·ç«¯å‘èµ·çš„è¿æ¥åï¼ŒNioSocketChannel ä¼šè¢«åˆ›å»ºå¹¶åˆå§‹åŒ–ï¼Œéšåä¼šå‘ sub reactor æ³¨å†Œï¼Œå½“æ³¨å†ŒæˆåŠŸåä¼šåœ¨ NioSocketChannel ä¸­çš„ pipeline ä¼ æ’­ ChannelRegistered äº‹ä»¶ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)ä¼ æ’­ChannelRegisteräº‹ä»¶.png</p> <div class="language- extra-class"><pre class="language-text"><code>private void register0(ChannelPromise promise) {

        ................
        //æ‰§è¡ŒçœŸæ­£çš„æ³¨å†Œæ“ä½œ
        doRegister();

        ...........

        //è§¦å‘channelRegisteräº‹ä»¶
        pipeline.fireChannelRegistered();

        .......
}
</code></pre></div><blockquote><p>æ³¨æ„ï¼šæ­¤æ—¶å¯¹åº”çš„ channel è¿˜æ²¡æœ‰æ³¨å†Œ IO äº‹ä»¶åˆ°ç›¸åº”çš„ reactor ä¸­ã€‚</p></blockquote> <h3 id="_3-1-3-channelactive-äº‹ä»¶"><a href="#_3-1-3-channelactive-äº‹ä»¶" class="header-anchor">#</a> 3.1.3 ChannelActive äº‹ä»¶</h3> <p>å½“ NioServerSocketChannel å†å‘ main reactor æ³¨å†ŒæˆåŠŸå¹¶è§¦å‘ ChannelRegistered äº‹ä»¶ä¼ æ’­ä¹‹åï¼Œéšåå°±ä¼šåœ¨ pipeline ä¸­è§¦å‘ bind äº‹ä»¶ï¼Œè€Œ bind äº‹ä»¶æ˜¯ä¸€ä¸ª outbound äº‹ä»¶ï¼Œä¼šä» pipeline ä¸­çš„å°¾ç»“ç‚¹ TailContext ä¸€ç›´å‘å‰ä¼ æ’­æœ€ç»ˆåœ¨ HeadContext ä¸­æ‰§è¡ŒçœŸæ­£çš„ç»‘å®šæ“ä½œã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>     @Override
        public void bind(
                ChannelHandlerContext ctx, SocketAddress localAddress, ChannelPromise promise) {
            //è§¦å‘AbstractChannel-&gt;bindæ–¹æ³• æ‰§è¡ŒJDK NIO SelectableChannel æ‰§è¡Œåº•å±‚ç»‘å®šæ“ä½œ
            unsafe.bind(localAddress, promise);
        }
       @Override
        public final void bind(final SocketAddress localAddress, final ChannelPromise promise) {
             ..............

            doBind(localAddress);

            ...............

            //ç»‘å®šæˆåŠŸå channelæ¿€æ´» è§¦å‘channelActiveäº‹ä»¶ä¼ æ’­
            if (!wasActive &amp;&amp; isActive()) {
                invokeLater(new Runnable() {
                    @Override
                    public void run() {
                        //HeadContext-&gt;channelActiveå›è°ƒæ–¹æ³• æ‰§è¡Œæ³¨å†ŒOP_ACCEPTäº‹ä»¶
                        pipeline.fireChannelActive();
                    }
                });
            }
  
            ...............
        }
</code></pre></div><p>å½“ netty æœåŠ¡ç«¯ NioServerSocketChannel ç»‘å®šç«¯å£æˆåŠŸä¹‹åï¼Œæ‰ç®—æ˜¯çœŸæ­£çš„ Active ï¼Œéšåè§¦å‘ ChannelActive äº‹ä»¶åœ¨ pipeline ä¸­çš„ä¼ æ’­ã€‚</p> <p>ä¹‹å‰æˆ‘ä»¬ä¹Ÿæåˆ°è¿‡åˆ¤æ–­ NioServerSocketChannel æ˜¯å¦ Active çš„æ ‡å‡†å°±æ˜¯ : <strong>åº•å±‚ JDK Nio ServerSocketChannel æ˜¯å¦ open å¹¶ä¸” ServerSocket æ˜¯å¦å·²ç»å®Œæˆç»‘å®šã€‚</strong></p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public boolean isActive() {
        return isOpen() &amp;&amp; javaChannel().socket().isBound();
    }
</code></pre></div><p>è€Œå®¢æˆ·ç«¯ NioSocketChannel ä¸­è§¦å‘ ChannelActive äº‹ä»¶å°±ä¼šæ¯”è¾ƒç®€å•ï¼Œå½“ NioSocketChannel å†å‘ sub reactor æ³¨å†ŒæˆåŠŸå¹¶è§¦å‘ ChannelRegistered ä¹‹åï¼Œç´§æ¥ç€å°±ä¼šè§¦å‘ ChannelActive äº‹ä»¶åœ¨ pipeline ä¸­ä¼ æ’­ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)ä¼ æ’­ChannelActiveäº‹ä»¶.png</p> <div class="language- extra-class"><pre class="language-text"><code>private void register0(ChannelPromise promise) {

        ................
        //æ‰§è¡ŒçœŸæ­£çš„æ³¨å†Œæ“ä½œ
        doRegister();

        ...........

        //è§¦å‘channelRegisteräº‹ä»¶
        pipeline.fireChannelRegistered();

        .......

        if (isActive()) {

                    if (firstRegistration) {
                        //è§¦å‘channelActiveäº‹ä»¶
                        pipeline.fireChannelActive();
                    } else if (config().isAutoRead()) {
                        beginRead();
                    }
          }
}
</code></pre></div><p>è€Œå®¢æˆ·ç«¯ NioSocketChannel æ˜¯å¦ Active çš„æ ‡è¯†æ˜¯ï¼šåº•å±‚ JDK NIO SocketChannel æ˜¯å¦ open å¹¶ä¸”åº•å±‚ socket æ˜¯å¦è¿æ¥ã€‚æ¯«æ— ç–‘é—®ï¼Œè¿™é‡Œçš„ socket ä¸€å®šæ˜¯ connected ã€‚æ‰€ä»¥ç›´æ¥è§¦å‘ ChannelActive äº‹ä»¶ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public boolean isActive() {
        SocketChannel ch = javaChannel();
        return ch.isOpen() &amp;&amp; ch.isConnected();
    }
</code></pre></div><blockquote><p>æ³¨æ„ï¼šæ­¤æ—¶ channel æ‰ä¼šåˆ°ç›¸åº”çš„ reactor ä¸­å»æ³¨å†Œæ„Ÿå…´è¶£çš„ IO äº‹ä»¶ã€‚å½“ç”¨æˆ·è‡ªå®šä¹‰çš„ ChannelHandler æ¥æ”¶åˆ° ChannelActive äº‹ä»¶æ—¶ï¼Œè¡¨æ˜ IO äº‹ä»¶å·²ç»æ³¨å†Œåˆ° reactor ä¸­äº†ã€‚</p></blockquote> <h3 id="_3-1-4-channelread-å’Œ-channelreadcomplete-äº‹ä»¶"><a href="#_3-1-4-channelread-å’Œ-channelreadcomplete-äº‹ä»¶" class="header-anchor">#</a> 3.1.4 ChannelRead å’Œ ChannelReadComplete äº‹ä»¶</h3> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥.png</p> <p>å½“å®¢æˆ·ç«¯æœ‰æ–°è¿æ¥è¯·æ±‚çš„æ—¶å€™ï¼ŒæœåŠ¡ç«¯çš„ NioServerSocketChannel ä¸Šçš„ OP_ACCEPT äº‹ä»¶ä¼šæ´»è·ƒï¼Œéšå main reactor ä¼šåœ¨ä¸€ä¸ª read loop ä¸­ä¸æ–­çš„è°ƒç”¨ serverSocketChannel.accept() æ¥æ”¶æ–°çš„è¿æ¥ç›´åˆ°å…¨éƒ¨æ¥æ”¶å®Œæ¯•æˆ–è€…è¾¾åˆ° read loop æœ€å¤§æ¬¡æ•° 16 æ¬¡ã€‚</p> <p>åœ¨ NioServerSocketChannel ä¸­ï¼Œæ¯ accept ä¸€ä¸ªæ–°çš„è¿æ¥ï¼Œå°±ä¼šåœ¨ pipeline ä¸­è§¦å‘ ChannelRead äº‹ä»¶ã€‚ä¸€ä¸ªå®Œæ•´çš„ read loop ç»“æŸä¹‹åï¼Œä¼šè§¦å‘ ChannelReadComplete äº‹ä»¶ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private final class NioMessageUnsafe extends AbstractNioUnsafe {

        @Override
        public void read() {
            ......................


                try {
                    do {
                        //åº•å±‚è°ƒç”¨NioServerSocketChannel-&gt;doReadMessages åˆ›å»ºå®¢æˆ·ç«¯SocketChannel
                        int localRead = doReadMessages(readBuf);
                        .................
                    } while (allocHandle.continueReading());

                } catch (Throwable t) {
                    exception = t;
                }

                int size = readBuf.size();
                for (int i = 0; i &lt; size; i ++) {            
                    pipeline.fireChannelRead(readBuf.get(i));
                }

                pipeline.fireChannelReadComplete();

                     .................
        }
    }
</code></pre></div><p>å½“å®¢æˆ·ç«¯ NioSocketChannel ä¸Šæœ‰è¯·æ±‚æ•°æ®åˆ°æ¥æ—¶ï¼ŒNioSocketChannel ä¸Šçš„ OP_READ äº‹ä»¶æ´»è·ƒï¼Œéšå sub reactor ä¹Ÿä¼šåœ¨ä¸€ä¸ª read loop ä¸­å¯¹ NioSocketChannel ä¸­çš„è¯·æ±‚æ•°æ®è¿›è¡Œè¯»å–ç›´åˆ°è¯»å–å®Œæ¯•æˆ–è€…è¾¾åˆ° read loop çš„æœ€å¤§æ¬¡æ•° 16 æ¬¡ã€‚</p> <p>åœ¨ read loop çš„è¯»å–è¿‡ç¨‹ä¸­ï¼Œæ¯è¯»å–ä¸€æ¬¡å°±ä¼šåœ¨ pipeline ä¸­è§¦å‘ ChannelRead äº‹ä»¶ã€‚å½“ä¸€ä¸ªå®Œæ•´çš„ read loop ç»“æŸä¹‹åï¼Œä¼šåœ¨ pipeline ä¸­è§¦å‘ ChannelReadComplete äº‹ä»¶ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191115068.webp" alt="å›¾ç‰‡">Nettyæ¥æ”¶ç½‘ç»œæ•°æ®æµç¨‹.png</p> <p><strong>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯å½“ ChannelReadComplete äº‹ä»¶è§¦å‘æ—¶ï¼Œæ­¤æ—¶å¹¶ä¸ä»£è¡¨ NioSocketChannel ä¸­çš„è¯·æ±‚æ•°æ®å·²ç»è¯»å–å®Œæ¯•</strong>ï¼Œå¯èƒ½çš„æƒ…å†µæ˜¯å‘é€çš„è¯·æ±‚æ•°æ®å¤ªå¤šï¼Œåœ¨ä¸€ä¸ª read loop ä¸­è¯»å–ä¸å®Œè¾¾åˆ°äº†æœ€å¤§é™åˆ¶æ¬¡æ•° 16 æ¬¡ï¼Œè¿˜æ²¡å…¨éƒ¨è¯»å–å®Œæ¯•å°±é€€å‡ºäº† read loop ã€‚ä¸€æ—¦é€€å‡º read loop å°±ä¼šè§¦å‘ ChannelReadComplete äº‹ä»¶ã€‚è¯¦ç»†å†…å®¹å¯ä»¥æŸ¥çœ‹ç¬”è€…çš„è¿™ç¯‡æ–‡ç« <a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484244&amp;idx=1&amp;sn=831060fc38caa201d69f87305de7f86a&amp;chksm=ce77c513f9004c05b48f849ff99997d6d7252453135ae856a029137b88aa70b8e046013d596e&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">ã€ŠNettyå¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œæ•°æ®ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ã€‚</p> <h3 id="_3-1-5-channelwritabilitychanged-äº‹ä»¶"><a href="#_3-1-5-channelwritabilitychanged-äº‹ä»¶" class="header-anchor">#</a> 3.1.5 ChannelWritabilityChanged äº‹ä»¶</h3> <p>å½“æˆ‘ä»¬å¤„ç†å®Œä¸šåŠ¡é€»è¾‘å¾—åˆ°ä¸šåŠ¡å¤„ç†ç»“æœåï¼Œä¼šè°ƒç”¨ ctx.write(msg) è§¦å‘ write äº‹ä»¶åœ¨ pipeline ä¸­çš„ä¼ æ’­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public void channelRead(final ChannelHandlerContext ctx, final Object msg) {
         ctx.write(msg);
    }
</code></pre></div><p>æœ€ç»ˆ netty ä¼šå°†å‘é€æ•°æ® msg å†™å…¥ NioSocketChannel ä¸­çš„å¾…å‘é€ç¼“å†²é˜Ÿåˆ— ChannelOutboundBuffer ä¸­ã€‚å¹¶ç­‰å¾…ç”¨æˆ·è°ƒç”¨ flush æ“ä½œä» ChannelOutboundBuffer ä¸­å°†å¾…å‘é€æ•°æ® msg ï¼Œå†™å…¥åˆ°åº•å±‚ Socket çš„å‘é€ç¼“å†²åŒºä¸­ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)ChannelOutboundBufferä¸­ç¼“å­˜å¾…å‘é€æ•°æ®.png</p> <p>å½“å¯¹ç«¯çš„æ¥æ”¶å¤„ç†é€Ÿåº¦éå¸¸æ…¢æˆ–è€…ç½‘ç»œçŠ¶å†µæåº¦æ‹¥å¡æ—¶ï¼Œä½¿å¾— TCP æ»‘åŠ¨çª—å£ä¸æ–­çš„ç¼©å°ï¼Œè¿™å°±å¯¼è‡´å‘é€ç«¯çš„å‘é€é€Ÿåº¦ä¹Ÿå˜å¾—è¶Šæ¥è¶Šå°ï¼Œè€Œæ­¤æ—¶ç”¨æˆ·è¿˜åœ¨ä¸æ–­çš„è°ƒç”¨ ctx.write(msg) ï¼Œè¿™å°±ä¼šå¯¼è‡´ ChannelOutboundBuffer ä¼šæ€¥å‰§å¢å¤§ï¼Œä»è€Œå¯èƒ½å¯¼è‡´ OOM ã€‚netty å¼•å…¥äº†é«˜ä½æ°´ä½çº¿æ¥æ§åˆ¶ ChannelOutboundBuffer çš„å†…å­˜å ç”¨ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public final class WriteBufferWaterMark {

    private static final int DEFAULT_LOW_WATER_MARK = 32 * 1024;
    private static final int DEFAULT_HIGH_WATER_MARK = 64 * 1024;
}
</code></pre></div><p>å½“ ChanneOutboundBuffer ä¸­çš„å†…å­˜å ç”¨é‡è¶…è¿‡é«˜æ°´ä½çº¿æ—¶ï¼Œnetty å°±ä¼šå°†å¯¹åº”çš„ channel ç½®ä¸ºä¸å¯å†™çŠ¶æ€ï¼Œå¹¶åœ¨ pipeline ä¸­è§¦å‘ ChannelWritabilityChanged äº‹ä»¶ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private void setUnwritable(boolean invokeLater) {
        for (;;) {
            final int oldValue = unwritable;
            final int newValue = oldValue | 1;
            if (UNWRITABLE_UPDATER.compareAndSet(this, oldValue, newValue)) {
                if (oldValue == 0) {
                    //è§¦å‘fireChannelWritabilityChangedäº‹ä»¶ è¡¨ç¤ºå½“å‰channelå˜ä¸ºä¸å¯å†™
                    fireChannelWritabilityChanged(invokeLater);
                }
                break;
            }
        }
    }
</code></pre></div><p>å½“ ChannelOutboundBuffer ä¸­çš„å†…å­˜å ç”¨é‡ä½äºä½æ°´ä½çº¿æ—¶ï¼Œnetty åˆä¼šå°†å¯¹åº”çš„ NioSocketChannel è®¾ç½®ä¸ºå¯å†™çŠ¶æ€ï¼Œå¹¶å†æ¬¡è§¦å‘ ChannelWritabilityChanged äº‹ä»¶ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)å“åº”channelWritabilityChangedäº‹ä»¶.png</p> <div class="language- extra-class"><pre class="language-text"><code>    private void setWritable(boolean invokeLater) {
        for (;;) {
            final int oldValue = unwritable;
            final int newValue = oldValue &amp; ~1;
            if (UNWRITABLE_UPDATER.compareAndSet(this, oldValue, newValue)) {
                if (oldValue != 0 &amp;&amp; newValue == 0) {
                    fireChannelWritabilityChanged(invokeLater);
                }
                break;
            }
        }
    }
</code></pre></div><p>ç”¨æˆ·å¯åœ¨è‡ªå®šä¹‰ ChannelHandler ä¸­é€šè¿‡ ctx.channel().isWritable() åˆ¤æ–­å½“å‰ channel æ˜¯å¦å¯å†™ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public void channelWritabilityChanged(ChannelHandlerContext ctx) throws Exception {

        if (ctx.channel().isWritable()) {
            ...........å½“å‰channelå¯å†™.........
        } else {
            ...........å½“å‰channelä¸å¯å†™.........
        }
    }
</code></pre></div><h3 id="_3-1-6-usereventtriggered-äº‹ä»¶"><a href="#_3-1-6-usereventtriggered-äº‹ä»¶" class="header-anchor">#</a> 3.1.6 UserEventTriggered äº‹ä»¶</h3> <p>netty æä¾›äº†ä¸€ç§äº‹ä»¶æ‰©å±•æœºåˆ¶å¯ä»¥å…è®¸ç”¨æˆ·è‡ªå®šä¹‰å¼‚æ­¥äº‹ä»¶ï¼Œè¿™æ ·å¯ä»¥ä½¿å¾—ç”¨æˆ·èƒ½å¤Ÿçµæ´»çš„å®šä¹‰å„ç§å¤æ‚åœºæ™¯çš„å¤„ç†æœºåˆ¶ã€‚</p> <p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹å¦‚ä½•åœ¨ Netty ä¸­è‡ªå®šä¹‰å¼‚æ­¥äº‹ä»¶ã€‚</p> <ol><li>å®šä¹‰å¼‚æ­¥äº‹ä»¶ã€‚</li></ol> <div class="language- extra-class"><pre class="language-text"><code>public final class OurOwnDefinedEvent {
 
    public static final OurOwnDefinedEvent INSTANCE = new OurOwnDefinedEvent();

    private OurOwnDefinedEvent() { }
}
</code></pre></div><ol><li>è§¦å‘è‡ªå®šä¹‰äº‹ä»¶çš„ä¼ æ’­</li></ol> <div class="language- extra-class"><pre class="language-text"><code>public class EchoServerHandler extends ChannelInboundHandlerAdapter {

    @Override
    public void channelRead(final ChannelHandlerContext ctx, final Object msg) {
            ......çœç•¥.......
            //äº‹ä»¶åœ¨pipelineä¸­ä»å½“å‰ChannelHandlerContextå¼€å§‹å‘åä¼ æ’­
            ctx.fireUserEventTriggered(OurOwnDefinedEvent.INSTANCE);
            //äº‹ä»¶ä»pipelineçš„å¤´ç»“ç‚¹headContextå¼€å§‹å‘åä¼ æ’­
            ctx.channel().pipeline().fireUserEventTriggered(OurOwnDefinedEvent.INSTANCE);

    }
}
     
</code></pre></div><ol><li>è‡ªå®šä¹‰äº‹ä»¶çš„å“åº”å’Œå¤„ç†ã€‚</li></ol> <div class="language- extra-class"><pre class="language-text"><code>public class EchoServerHandler extends ChannelInboundHandlerAdapter {

    @Override
    public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception {

        if (OurOwnDefinedEvent.INSTANCE == evt) {
              .....è‡ªå®šä¹‰äº‹ä»¶å¤„ç†......
        }
    }

}
</code></pre></div><p>åç»­éšç€æˆ‘ä»¬æºç è§£è¯»çš„æ·±å…¥ï¼Œæˆ‘ä»¬è¿˜ä¼šçœ‹åˆ° Netty è‡ªå·±æœ¬èº«ä¹Ÿå®šä¹‰äº†è®¸å¤š UserEvent äº‹ä»¶ï¼Œæˆ‘ä»¬åé¢è¿˜ä¼šåœ¨ä»‹ç»ï¼Œå¤§å®¶è¿™é‡Œåªæ˜¯ç¨å¾®äº†è§£ä¸€ä¸‹ç›¸å…³çš„ç”¨æ³•å³å¯ã€‚</p> <h3 id="_3-1-7-channelinactiveå’Œchannelunregisteredäº‹ä»¶"><a href="#_3-1-7-channelinactiveå’Œchannelunregisteredäº‹ä»¶" class="header-anchor">#</a> 3.1.7 ChannelInactiveå’ŒChannelUnregisteredäº‹ä»¶</h3> <p>å½“ Channel è¢«å…³é—­ä¹‹åä¼šåœ¨ pipeline ä¸­å…ˆè§¦å‘ ChannelInactive äº‹ä»¶çš„ä¼ æ’­ç„¶ååœ¨è§¦å‘ ChannelUnregistered äº‹ä»¶çš„ä¼ æ’­ã€‚</p> <p>æˆ‘ä»¬å¯ä»¥åœ¨ Inbound ç±»å‹çš„ ChannelHandler ä¸­å“åº” ChannelInactive å’Œ ChannelUnregistered äº‹ä»¶ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public void channelInactive(ChannelHandlerContext ctx) throws Exception {
        
        ......å“åº”inActiveäº‹ä»¶...
        
        //ç»§ç»­å‘åä¼ æ’­inActiveäº‹ä»¶
        super.channelInactive(ctx);
    }

    @Override
    public void channelUnregistered(ChannelHandlerContext ctx) throws Exception {
        
          ......å“åº”Unregisteredäº‹ä»¶...

        //ç»§ç»­å‘åä¼ æ’­Unregisteredäº‹ä»¶
        super.channelUnregistered(ctx);
    }
</code></pre></div><blockquote><p>è¿™é‡Œå’Œè¿æ¥å»ºç«‹ä¹‹åçš„äº‹ä»¶è§¦å‘é¡ºåºæ­£å¥½ç›¸åï¼Œè¿æ¥å»ºç«‹ä¹‹åæ˜¯å…ˆè§¦å‘ ChannelRegistered äº‹ä»¶ç„¶ååœ¨è§¦å‘ ChannelActive äº‹ä»¶ã€‚</p></blockquote> <h3 id="_3-2-outbound-ç±»äº‹ä»¶"><a href="#_3-2-outbound-ç±»äº‹ä»¶" class="header-anchor">#</a> 3.2 Outbound ç±»äº‹ä»¶</h3> <div class="language- extra-class"><pre class="language-text"><code>final class ChannelHandlerMask {

    // outbound äº‹ä»¶çš„é›†åˆ
    static final int MASK_ONLY_OUTBOUND =  MASK_BIND | MASK_CONNECT | MASK_DISCONNECT |
            MASK_CLOSE | MASK_DEREGISTER | MASK_READ | MASK_WRITE | MASK_FLUSH;

    private static final int MASK_ALL_OUTBOUND = MASK_EXCEPTION_CAUGHT | MASK_ONLY_OUTBOUND;
    
    // outbound äº‹ä»¶æ©ç 
    static final int MASK_BIND = 1 &lt;&lt; 9;
    static final int MASK_CONNECT = 1 &lt;&lt; 10;
    static final int MASK_DISCONNECT = 1 &lt;&lt; 11;
    static final int MASK_CLOSE = 1 &lt;&lt; 12;
    static final int MASK_DEREGISTER = 1 &lt;&lt; 13;
    static final int MASK_READ = 1 &lt;&lt; 14;
    static final int MASK_WRITE = 1 &lt;&lt; 15;
    static final int MASK_FLUSH = 1 &lt;&lt; 16;
}
</code></pre></div><p>å’Œ Inbound ç±»äº‹ä»¶ä¸€æ ·ï¼ŒOutbound ç±»äº‹ä»¶ä¹Ÿæœ‰å¯¹åº”çš„æ©ç è¡¨ç¤ºã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹ Outboundç±»äº‹ä»¶çš„è§¦å‘æ—¶æœºï¼š</p> <h3 id="_3-2-1-read-äº‹ä»¶"><a href="#_3-2-1-read-äº‹ä»¶" class="header-anchor">#</a> 3.2.1 read äº‹ä»¶</h3> <p><strong>å¤§å®¶è¿™é‡Œéœ€è¦æ³¨æ„åŒºåˆ† read äº‹ä»¶å’Œ ChannelRead äº‹ä»¶çš„ä¸åŒ</strong>ã€‚</p> <p>ChannelRead äº‹ä»¶å‰è¾¹æˆ‘ä»¬å·²ç»ä»‹ç»äº†ï¼Œå½“ NioServerSocketChannel æ¥æ”¶åˆ°æ–°è¿æ¥æ—¶ï¼Œä¼šè§¦å‘ ChannelRead äº‹ä»¶åœ¨å…¶ pipeline ä¸Šä¼ æ’­ã€‚</p> <p>å½“ NioSocketChannel ä¸Šæœ‰è¯·æ±‚æ•°æ®æ—¶ï¼Œåœ¨ read loop ä¸­è¯»å–è¯·æ±‚æ•°æ®æ—¶ä¼šè§¦å‘ ChannelRead äº‹ä»¶åœ¨å…¶ pipeline ä¸Šä¼ æ’­ã€‚</p> <p>è€Œ read äº‹ä»¶åˆ™å’Œ ChannelRead äº‹ä»¶å®Œå…¨ä¸åŒï¼Œread äº‹ä»¶ç‰¹æŒ‡ä½¿ Channel å…·å¤‡æ„ŸçŸ¥ IO äº‹ä»¶çš„èƒ½åŠ›ã€‚NioServerSocketChannel å¯¹åº”çš„ OP_ACCEPT äº‹ä»¶çš„æ„ŸçŸ¥èƒ½åŠ›ï¼ŒNioSocketChannel å¯¹åº”çš„æ˜¯ OP_READ äº‹ä»¶çš„æ„ŸçŸ¥èƒ½åŠ›ã€‚</p> <p>read äº‹ä»¶çš„è§¦å‘æ˜¯åœ¨å½“ channel éœ€è¦å‘å…¶å¯¹åº”çš„ reactor æ³¨å†Œè¯»ç±»å‹äº‹ä»¶æ—¶ï¼ˆæ¯”å¦‚ OP_ACCEPT äº‹ä»¶ å’Œ  OP_READ äº‹ä»¶ï¼‰æ‰ä¼šè§¦å‘ã€‚read äº‹ä»¶çš„å“åº”å°±æ˜¯å°† channel æ„Ÿå…´è¶£çš„ IO äº‹ä»¶æ³¨å†Œåˆ°å¯¹åº”çš„ reactor ä¸Šã€‚</p> <p>æ¯”å¦‚ NioServerSocketChannel æ„Ÿå…´è¶£çš„æ˜¯ OP_ACCEPT äº‹ä»¶ï¼Œ NioSocketChannel æ„Ÿå…´è¶£çš„æ˜¯ OP_READ äº‹ä»¶ã€‚</p> <p>åœ¨å‰è¾¹ä»‹ç» ChannelActive äº‹ä»¶æ—¶æˆ‘ä»¬æåˆ°ï¼Œå½“ channel å¤„äº active çŠ¶æ€åä¼šåœ¨ pipeline ä¸­ä¼ æ’­ ChannelActive äº‹ä»¶ã€‚è€Œåœ¨ HeadContext ä¸­çš„ ChannelActive äº‹ä»¶å›è°ƒä¸­ä¼šè§¦å‘ Read äº‹ä»¶çš„ä¼ æ’­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>final class HeadContext extends AbstractChannelHandlerContext
            implements ChannelOutboundHandler, ChannelInboundHandler {

        @Override
        public void channelActive(ChannelHandlerContext ctx) {
            ctx.fireChannelActive();  
            readIfIsAutoRead();
        }

        private void readIfIsAutoRead() {
            if (channel.config().isAutoRead()) {
                //å¦‚æœæ˜¯autoRead åˆ™è§¦å‘readäº‹ä»¶ä¼ æ’­
                channel.read();
            }
        }

        @Override
        public void read(ChannelHandlerContext ctx) {
            //è§¦å‘æ³¨å†ŒOP_ACCEPTæˆ–è€…OP_READäº‹ä»¶
            unsafe.beginRead();
        }
 }
</code></pre></div><p>è€Œåœ¨ HeadContext ä¸­çš„ read äº‹ä»¶å›è°ƒä¸­ä¼šè°ƒç”¨ Channel çš„åº•å±‚æ“ä½œç±» unsafe çš„ beginRead æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ä¼šå‘ reactor æ³¨å†Œ channel æ„Ÿå…´è¶£çš„ IO äº‹ä»¶ã€‚å¯¹äº NioServerSocketChannel æ¥è¯´è¿™é‡Œæ³¨å†Œçš„å°±æ˜¯ OP_ACCEPT äº‹ä»¶ï¼Œå¯¹äº NioSocketChannel æ¥è¯´è¿™é‡Œæ³¨å†Œçš„åˆ™æ˜¯ OP_READ äº‹ä»¶ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    protected void doBeginRead() throws Exception {
        // Channel.read() or ChannelHandlerContext.read() was called
        final SelectionKey selectionKey = this.selectionKey;
        if (!selectionKey.isValid()) {
            return;
        }

        readPending = true;

        final int interestOps = selectionKey.interestOps();

        if ((interestOps &amp; readInterestOp) == 0) {
            //æ³¨å†Œç›‘å¬OP_ACCEPTæˆ–è€…OP_READäº‹ä»¶
            selectionKey.interestOps(interestOps | readInterestOp);
        }
    }
</code></pre></div><p><strong>ç»†å¿ƒçš„åŒå­¦å¯èƒ½æ³¨æ„åˆ°äº† channel å¯¹åº”çš„é…ç½®ç±»ä¸­åŒ…å«äº†ä¸€ä¸ª autoRead å±æ€§ï¼Œé‚£ä¹ˆè¿™ä¸ª autoRead åˆ°åº•æ˜¯å¹²ä»€ä¹ˆçš„å‘¢ï¼Ÿ</strong></p> <p>å…¶å®è¿™æ˜¯ netty ä¸ºå¤§å®¶æä¾›çš„ä¸€ç§èƒŒå‹æœºåˆ¶ï¼Œç”¨æ¥é˜²æ­¢ OOM ï¼Œæƒ³è±¡ä¸€ä¸‹å½“å¯¹ç«¯å‘é€æ•°æ®éå¸¸å¤šå¹¶ä¸”å‘é€é€Ÿåº¦éå¸¸å¿«ï¼Œè€ŒæœåŠ¡ç«¯å¤„ç†é€Ÿåº¦éå¸¸æ…¢ï¼Œä¸€æ—¶é—´æ¶ˆè´¹ä¸è¿‡æ¥ã€‚è€Œå¯¹ç«¯åˆåœ¨ä¸åœçš„å¤§é‡å‘é€æ•°æ®ï¼ŒæœåŠ¡ç«¯çš„ reactor çº¿ç¨‹ä¸å¾—ä¸åœ¨ read loop ä¸­ä¸åœçš„è¯»å–ï¼Œå¹¶ä¸”ä¸ºè¯»å–åˆ°çš„æ•°æ®åˆ†é… ByteBuffer ã€‚è€ŒæœåŠ¡ç«¯ä¸šåŠ¡çº¿ç¨‹åˆå¤„ç†ä¸è¿‡æ¥ï¼Œè¿™å°±å¯¼è‡´äº†å¤§é‡æ¥ä¸åŠå¤„ç†çš„æ•°æ®å ç”¨äº†å¤§é‡çš„å†…å­˜ç©ºé—´ï¼Œä»è€Œå¯¼è‡´ OOM ã€‚</p> <p>é¢å¯¹è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>channelHandlerContext.channel().config().setAutoRead(false)</code> å°† autoRead å±æ€§è®¾ç½®ä¸º false ã€‚éšå netty å°±ä¼šå°† channel ä¸­æ„Ÿå…´è¶£çš„è¯»ç±»å‹äº‹ä»¶ä» reactor ä¸­æ³¨é”€ï¼Œä»æ­¤ reactor ä¸ä¼šå†å¯¹ç›¸åº”äº‹ä»¶è¿›è¡Œç›‘å¬ã€‚è¿™æ · channel å°±ä¸ä¼šåœ¨è¯»å–æ•°æ®äº†ã€‚</p> <blockquote><p>è¿™é‡Œ NioServerSocketChannel å¯¹åº”çš„æ˜¯ OP_ACCEPT äº‹ä»¶ï¼Œ NioSocketChannel å¯¹åº”çš„æ˜¯ OP_READ äº‹ä»¶ã€‚</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>        protected final void removeReadOp() {
            SelectionKey key = selectionKey();
            if (!key.isValid()) {
                return;
            }
            int interestOps = key.interestOps();
            if ((interestOps &amp; readInterestOp) != 0) {        
                key.interestOps(interestOps &amp; ~readInterestOp);
            }
        }
</code></pre></div><p>è€Œå½“æœåŠ¡ç«¯çš„å¤„ç†é€Ÿåº¦æ¢å¤æ­£å¸¸ï¼Œæˆ‘ä»¬åˆå¯ä»¥é€šè¿‡ <code>channelHandlerContext.channel().config().setAutoRead(true)</code> å°† autoRead å±æ€§è®¾ç½®ä¸º true ã€‚è¿™æ · netty ä¼šåœ¨ pipeline ä¸­è§¦å‘ read äº‹ä»¶ï¼Œæœ€ç»ˆåœ¨ HeadContext ä¸­çš„ read äº‹ä»¶å›è°ƒæ–¹æ³•ä¸­é€šè¿‡è°ƒç”¨ unsafe#beginRead æ–¹æ³•å°† channel æ„Ÿå…´è¶£çš„è¯»ç±»å‹äº‹ä»¶é‡æ–°æ³¨å†Œåˆ°å¯¹åº”çš„ reactor ä¸­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public ChannelConfig setAutoRead(boolean autoRead) {
        boolean oldAutoRead = AUTOREAD_UPDATER.getAndSet(this, autoRead ? 1 : 0) == 1;
        if (autoRead &amp;&amp; !oldAutoRead) {
            //autoReadä»falseå˜ä¸ºtrue
            channel.read();
        } else if (!autoRead &amp;&amp; oldAutoRead) {
            //autoReadä»trueå˜ä¸ºfalse
            autoReadCleared();
        }
        return this;
    }
</code></pre></div><blockquote><p>read äº‹ä»¶å¯ä»¥ç†è§£ä¸ºä½¿ channel æ‹¥æœ‰è¯»çš„èƒ½åŠ›ï¼Œå½“æœ‰äº†è¯»çš„èƒ½åŠ›åï¼Œ channelRead å°±å¯ä»¥è¯»å–å…·ä½“çš„æ•°æ®äº†ã€‚</p></blockquote> <h3 id="_3-2-2-write-å’Œ-flush-äº‹ä»¶"><a href="#_3-2-2-write-å’Œ-flush-äº‹ä»¶" class="header-anchor">#</a> 3.2.2 write å’Œ flush äº‹ä»¶</h3> <p>write äº‹ä»¶å’Œ flush äº‹ä»¶æˆ‘ä»¬åœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484532&amp;idx=1&amp;sn=c3a8b37a2eb09509d9914494ef108c68&amp;chksm=ce77c233f9004b25a29f9fdfb179e41646092d09bc89df2147a9fab66df13231e46dd6a5c26d&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">ã€Šä¸€æ–‡ææ‡‚Nettyå‘é€æ•°æ®å…¨æµç¨‹ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸€æ–‡ä¸­å·²ç»éå¸¸è¯¦å°½çš„ä»‹ç»è¿‡äº†ï¼Œè¿™é‡Œç¬”è€…åœ¨å¸¦å¤§å®¶ç®€å•å›é¡¾ä¸€ä¸‹ã€‚</p> <p>write äº‹ä»¶å’Œ flush äº‹ä»¶å‡ç”±ç”¨æˆ·åœ¨å¤„ç†å®Œä¸šåŠ¡è¯·æ±‚å¾—åˆ°ä¸šåŠ¡ç»“æœååœ¨ä¸šåŠ¡çº¿ç¨‹ä¸­ä¸»åŠ¨è§¦å‘ã€‚</p> <p>ç”¨æˆ·æ—¢å¯ä»¥é€šè¿‡ ChannelHandlerContext è§¦å‘ä¹Ÿå¯ä»¥é€šè¿‡ Channel æ¥è§¦å‘ã€‚</p> <p>ä¸åŒä¹‹å¤„åœ¨äºå¦‚æœé€šè¿‡ ChannelHandlerContext è§¦å‘ï¼Œé‚£ä¹ˆ write äº‹ä»¶æˆ–è€… flush äº‹ä»¶å°±ä¼šåœ¨ pipeline ä¸­ä»å½“å‰ ChannelHandler å¼€å§‹ä¸€ç›´å‘å‰ä¼ æ’­ç›´åˆ° HeadContext ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public void channelRead(final ChannelHandlerContext ctx, final Object msg) {
       ctx.write(msg);
    }

    @Override
    public void channelReadComplete(ChannelHandlerContext ctx) {
        ctx.flush();
    }
</code></pre></div><p>å¦‚æœé€šè¿‡ Channel è§¦å‘ï¼Œé‚£ä¹ˆ write äº‹ä»¶å’Œ flush äº‹ä»¶å°±ä¼šä» pipeline çš„å°¾éƒ¨èŠ‚ç‚¹ TailContext å¼€å§‹ä¸€ç›´å‘å‰ä¼ æ’­ç›´åˆ° HeadContext ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public void channelRead(final ChannelHandlerContext ctx, final Object msg) {
       ctx.channel().write(msg);
    }

    @Override
    public void channelReadComplete(ChannelHandlerContext ctx) {
        ctx.channel().flush();
    }
</code></pre></div><p>å½“ç„¶è¿˜æœ‰ä¸€ä¸ª writeAndFlush æ–¹æ³•ï¼Œä¹Ÿä¼šåˆ†ä¸º ChannelHandlerContext è§¦å‘å’Œ Channel çš„è§¦å‘ã€‚è§¦å‘ writeAndFlush åï¼Œwrite äº‹ä»¶é¦–å…ˆä¼šåœ¨ pipeline ä¸­ä¼ æ’­ï¼Œæœ€å flush äº‹ä»¶åœ¨ pipeline ä¸­ä¼ æ’­ã€‚</p> <p>netty å¯¹ write äº‹ä»¶çš„å¤„ç†æœ€ç»ˆä¼šå°†å‘é€æ•°æ®å†™å…¥ Channel å¯¹åº”çš„å†™ç¼“å†²é˜Ÿåˆ— ChannelOutboundBuffer ä¸­ã€‚æ­¤æ—¶æ•°æ®å¹¶æ²¡æœ‰å‘é€å‡ºå»è€Œæ˜¯åœ¨å†™ç¼“å†²é˜Ÿåˆ—ä¸­ç¼“å­˜ï¼Œè¿™ä¹Ÿæ˜¯ netty å®ç°å¼‚æ­¥å†™çš„æ ¸å¿ƒè®¾è®¡ã€‚</p> <p>æœ€ç»ˆé€šè¿‡ flush æ“ä½œä» Channel ä¸­çš„å†™ç¼“å†²é˜Ÿåˆ— ChannelOutboundBuffer ä¸­è·å–åˆ°å¾…å‘é€æ•°æ®ï¼Œå¹¶å†™å…¥åˆ° Socket çš„å‘é€ç¼“å†²åŒºä¸­ã€‚</p> <h3 id="_3-2-3-close-äº‹ä»¶"><a href="#_3-2-3-close-äº‹ä»¶" class="header-anchor">#</a> 3.2.3 close äº‹ä»¶</h3> <p>å½“ç”¨æˆ·åœ¨ ChannelHandler ä¸­è°ƒç”¨å¦‚ä¸‹æ–¹æ³•å¯¹ Channel è¿›è¡Œå…³é—­æ—¶ï¼Œä¼šè§¦å‘ Close äº‹ä»¶åœ¨ pipeline ä¸­ä»åå‘å‰ä¼ æ’­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>//closeäº‹ä»¶ä»å½“å‰ChannelHandlerContextå¼€å§‹åœ¨pipelineä¸­å‘å‰ä¼ æ’­
ctx.close();
//closeäº‹ä»¶ä»pipelineçš„å°¾ç»“ç‚¹tailContextå¼€å§‹å‘å‰ä¼ æ’­
ctx.channel().close();
</code></pre></div><p>æˆ‘ä»¬å¯ä»¥åœ¨Outboundç±»å‹çš„ChannelHandlerä¸­å“åº”closeäº‹ä»¶ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class ExampleChannelHandler extends ChannelOutboundHandlerAdapter {

    @Override
    public void close(ChannelHandlerContext ctx, ChannelPromise promise) throws Exception {
        
        .....å®¢æˆ·ç«¯channelå…³é—­ä¹‹å‰çš„å¤„ç†å›è°ƒ.....
        
        //ç»§ç»­å‘å‰ä¼ æ’­closeäº‹ä»¶
        super.close(ctx, promise);
    }
}
</code></pre></div><p>æœ€ç»ˆ close äº‹ä»¶ä¼šåœ¨ pipeline ä¸­ä¸€ç›´å‘å‰ä¼ æ’­ç›´åˆ°å¤´ç»“ç‚¹ HeadConnect ä¸­ï¼Œå¹¶åœ¨ HeadContext ä¸­å®Œæˆè¿æ¥å…³é—­çš„æ“ä½œï¼Œå½“è¿æ¥å®Œæˆå…³é—­ä¹‹åï¼Œä¼šåœ¨ pipelineä¸­å…ˆåè§¦å‘ ChannelInactive äº‹ä»¶å’Œ ChannelUnregistered äº‹ä»¶ã€‚</p> <h3 id="_3-2-4-deregister-äº‹ä»¶"><a href="#_3-2-4-deregister-äº‹ä»¶" class="header-anchor">#</a> 3.2.4 deRegister äº‹ä»¶</h3> <p>ç”¨æˆ·å¯è°ƒç”¨å¦‚ä¸‹ä»£ç å°†å½“å‰ Channel ä» Reactor ä¸­æ³¨é”€æ‰ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>//deregisteräº‹ä»¶ä»å½“å‰ChannelHandlerContextå¼€å§‹åœ¨pipelineä¸­å‘å‰ä¼ æ’­
ctx.deregister();
//deregisteräº‹ä»¶ä»pipelineçš„å°¾ç»“ç‚¹tailContextå¼€å§‹å‘å‰ä¼ æ’­
ctx.channel().deregister();
</code></pre></div><p>æˆ‘ä»¬å¯ä»¥åœ¨ Outbound ç±»å‹çš„ ChannelHandler ä¸­å“åº” deregister äº‹ä»¶ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class ExampleChannelHandler extends ChannelOutboundHandlerAdapter {

    @Override
    public void deregister(ChannelHandlerContext ctx, ChannelPromise promise) throws Exception {


        .....å®¢æˆ·ç«¯channelå–æ¶ˆæ³¨å†Œä¹‹å‰çš„å¤„ç†å›è°ƒ.....

        //ç»§ç»­å‘å‰ä¼ æ’­connectäº‹ä»¶
        super.deregister(ctx, promise);
    }
}
</code></pre></div><p>æœ€ç»ˆ deRegister äº‹ä»¶ä¼šä¼ æ’­è‡³ pipeline ä¸­çš„å¤´ç»“ç‚¹ HeadContext ä¸­ï¼Œå¹¶åœ¨ HeadContext ä¸­å®Œæˆåº•å±‚ channel å–æ¶ˆæ³¨å†Œçš„æ“ä½œã€‚å½“ Channel ä» Reactor ä¸Šæ³¨é”€ä¹‹åï¼Œä»æ­¤ Reactor å°†ä¸ä¼šåœ¨ç›‘å¬ Channel ä¸Šçš„ IO äº‹ä»¶ï¼Œå¹¶è§¦å‘ ChannelUnregistered äº‹ä»¶åœ¨ pipeline ä¸­ä¼ æ’­ã€‚</p> <h3 id="_3-2-5-connect-äº‹ä»¶"><a href="#_3-2-5-connect-äº‹ä»¶" class="header-anchor">#</a> 3.2.5 connect äº‹ä»¶</h3> <p>åœ¨ Netty çš„å®¢æˆ·ç«¯ä¸­æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ NioSocketChannel çš„ connect æ–¹æ³•è§¦å‘ connect äº‹ä»¶åœ¨ pipeline ä¸­ä¼ æ’­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>//connectäº‹ä»¶ä»å½“å‰ChannelHandlerContextå¼€å§‹åœ¨pipelineä¸­å‘å‰ä¼ æ’­
ctx.connect(remoteAddress);
//connectäº‹ä»¶ä»pipelineçš„å°¾ç»“ç‚¹tailContextå¼€å§‹å‘å‰ä¼ æ’­
ctx.channel().connect(remoteAddress);
</code></pre></div><p>æˆ‘ä»¬å¯ä»¥åœ¨ Outbound ç±»å‹çš„ ChannelHandler ä¸­å“åº” connect äº‹ä»¶ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class ExampleChannelHandler extends ChannelOutboundHandlerAdapter {

    @Override
    public void connect(ChannelHandlerContext ctx, SocketAddress remoteAddress, SocketAddress localAddress,
                        ChannelPromise promise) throws Exception {
                 
        
        .....å®¢æˆ·ç«¯channelè¿æ¥æˆåŠŸä¹‹å‰çš„å¤„ç†å›è°ƒ.....
        
        //ç»§ç»­å‘å‰ä¼ æ’­connectäº‹ä»¶
        super.connect(ctx, remoteAddress, localAddress, promise);
    }
}
</code></pre></div><p>æœ€ç»ˆ connect äº‹ä»¶ä¼šåœ¨ pipeline ä¸­çš„å¤´ç»“ç‚¹ headContext ä¸­è§¦å‘åº•å±‚çš„è¿æ¥å»ºç«‹è¯·æ±‚ã€‚å½“å®¢æˆ·ç«¯æˆåŠŸè¿æ¥åˆ°æœåŠ¡ç«¯ä¹‹åï¼Œä¼šåœ¨å®¢æˆ·ç«¯ NioSocketChannel çš„ pipeline ä¸­ä¼ æ’­ channelActive äº‹ä»¶ã€‚</p> <h3 id="_3-2-6-disconnect-äº‹ä»¶"><a href="#_3-2-6-disconnect-äº‹ä»¶" class="header-anchor">#</a> 3.2.6 disConnect äº‹ä»¶</h3> <p>åœ¨ Netty çš„å®¢æˆ·ç«¯ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥è°ƒç”¨ NioSocketChannel çš„ disconnect æ–¹æ³•åœ¨ pipeline ä¸­è§¦å‘ disconnect äº‹ä»¶ï¼Œè¿™ä¼šå¯¼è‡´ NioSocketChannel çš„å…³é—­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>//disconnectäº‹ä»¶ä»å½“å‰ChannelHandlerContextå¼€å§‹åœ¨pipelineä¸­å‘å‰ä¼ æ’­
ctx.disconnect();
//disconnectäº‹ä»¶ä»pipelineçš„å°¾ç»“ç‚¹tailContextå¼€å§‹å‘å‰ä¼ æ’­
ctx.channel().disconnect();
</code></pre></div><p>æˆ‘ä»¬å¯ä»¥åœ¨ Outbound ç±»å‹çš„ ChannelHandler ä¸­å“åº” disconnect äº‹ä»¶ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class ExampleChannelHandler extends ChannelOutboundHandlerAdapter {


    @Override
    public void disconnect(ChannelHandlerContext ctx, ChannelPromise promise) throws Exception {
        
        .....å®¢æˆ·ç«¯channelå³å°†å…³é—­å‰çš„å¤„ç†å›è°ƒ.....
        
        //ç»§ç»­å‘å‰ä¼ æ’­disconnectäº‹ä»¶
        super.disconnect(ctx, promise);
    }
}
</code></pre></div><p>æœ€ç»ˆ disconnect äº‹ä»¶ä¼šä¼ æ’­åˆ° HeadContext ä¸­ï¼Œå¹¶åœ¨ HeadContext ä¸­å®Œæˆåº•å±‚çš„æ–­å¼€è¿æ¥æ“ä½œï¼Œå½“å®¢æˆ·ç«¯æ–­å¼€è¿æ¥æˆåŠŸå…³é—­ä¹‹åï¼Œä¼šåœ¨ pipeline ä¸­å…ˆåè§¦å‘ ChannelInactive äº‹ä»¶å’Œ ChannelUnregistered äº‹ä»¶ã€‚</p> <h2 id="_4-å‘pipelineæ·»åŠ channelhandler"><a href="#_4-å‘pipelineæ·»åŠ channelhandler" class="header-anchor">#</a> 4. å‘pipelineæ·»åŠ channelHandler</h2> <p>åœ¨æˆ‘ä»¬è¯¦ç»†ä»‹ç»äº†å…¨éƒ¨çš„ inbound ç±»äº‹ä»¶å’Œ outbound ç±»äº‹ä»¶çš„æ©ç è¡¨ç¤ºä»¥åŠäº‹ä»¶çš„è§¦å‘å’Œä¼ æ’­è·¯å¾„åï¼Œç›¸ä¿¡å¤§å®¶ç°åœ¨å¯ä»¥é€šè¿‡ ChannelInboundHandler å’Œ ChannelOutboundHandler æ¥æ ¹æ®å…·ä½“çš„ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚çš„ ChannelHandler ç±»å‹ä»¥åŠç›‘å¬åˆé€‚çš„äº‹ä»¶æ¥å®Œæˆä¸šåŠ¡éœ€æ±‚äº†ã€‚</p> <p>æœ¬å°èŠ‚å°±è¯¥ä»‹ç»ä¸€ä¸‹è‡ªå®šä¹‰çš„ ChannelHandler æ˜¯å¦‚ä½•æ·»åŠ åˆ° pipeline ä¸­çš„ï¼Œnetty åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¸®æˆ‘ä»¬ä½œäº†å“ªäº›å·¥ä½œ?</p> <div class="language- extra-class"><pre class="language-text"><code>           final EchoServerHandler serverHandler = new EchoServerHandler();

            ServerBootstrap b = new ServerBootstrap();
            b.group(bossGroup, workerGroup)
             .channel(NioServerSocketChannel.class)

             .............

             .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() {
                 @Override
                 public void initChannel(SocketChannel ch) throws Exception {
                     ChannelPipeline p = ch.pipeline();          
                     p.addLast(serverHandler);

                     ......å¯æ·»åŠ å¤šä¸ªchannelHandler......
                 }
             });
</code></pre></div><p>ä»¥ä¸Šæ˜¯ç¬”è€…ç®€åŒ–çš„ä¸€ä¸ª netty æœåŠ¡ç«¯é…ç½® ServerBootstrap å¯åŠ¨ç±»çš„ä¸€æ®µç¤ºä¾‹ä»£ç ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å†å‘ channel å¯¹åº”çš„ pipeline ä¸­æ·»åŠ  ChannelHandler æ˜¯é€šè¿‡ ChannelPipeline#addLast æ–¹æ³•å°†æŒ‡å®š ChannelHandler æ·»åŠ åˆ° pipeline çš„æœ«å°¾å¤„ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public interface ChannelPipeline
        extends ChannelInboundInvoker, ChannelOutboundInvoker, Iterable&lt;Entry&lt;String, ChannelHandler&gt;&gt; {

    //å‘pipelineçš„æœ«å°¾å¤„æ‰¹é‡æ·»åŠ å¤šä¸ªchannelHandler
    ChannelPipeline addLast(ChannelHandler... handlers);

    //æŒ‡å®šchannelHandlerçš„executorï¼Œç”±æŒ‡å®šçš„executoræ‰§è¡ŒchannelHandlerä¸­çš„å›è°ƒæ–¹æ³•
    ChannelPipeline addLast(EventExecutorGroup group, ChannelHandler... handlers);

     //ä¸ºchannelHandleræŒ‡å®šåç§°
    ChannelPipeline addLast(String name, ChannelHandler handler);

    //ä¸ºchannelHandleræŒ‡å®šexecutorå’Œname
    ChannelPipeline addLast(EventExecutorGroup group, String name, ChannelHandler handler);
}
public class DefaultChannelPipeline implements ChannelPipeline {

    @Override
    public final ChannelPipeline addLast(ChannelHandler... handlers) {
        return addLast(null, handlers);
    }

    @Override
    public final ChannelPipeline addLast(EventExecutorGroup executor, ChannelHandler... handlers) {
        ObjectUtil.checkNotNull(handlers, &quot;handlers&quot;);

        for (ChannelHandler h: handlers) {
            if (h == null) {
                break;
            }
            addLast(executor, null, h);
        }

        return this;
    }

    @Override
    public final ChannelPipeline addLast(String name, ChannelHandler handler) {
        return addLast(null, name, handler);
    }
}
</code></pre></div><p>æœ€ç»ˆ addLast çš„è¿™äº›é‡è½½æ–¹æ³•éƒ½ä¼šè°ƒç”¨åˆ° <code>DefaultChannelPipeline#addLast(EventExecutorGroup, String, ChannelHandler)</code> è¿™ä¸ªæ–¹æ³•ä»è€Œå®Œæˆ ChannelHandler çš„æ·»åŠ ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public final ChannelPipeline addLast(EventExecutorGroup group, String name, ChannelHandler handler) {
        final AbstractChannelHandlerContext newCtx;
        synchronized (this) {
            //æ£€æŸ¥åŒä¸€ä¸ªchannelHandlerå®ä¾‹æ˜¯å¦å…è®¸è¢«é‡å¤æ·»åŠ 
            checkMultiplicity(handler);

            //åˆ›å»ºchannelHandlerContextåŒ…è£¹channelHandlerå¹¶å°è£…æ‰§è¡Œä¼ æ’­äº‹ä»¶ç›¸å…³çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
            newCtx = newContext(group, filterName(name, handler), handler);

            //å°†channelHandelrContextæ’å…¥åˆ°pipelineä¸­çš„æœ«å°¾å¤„ã€‚åŒå‘é“¾è¡¨æ“ä½œ
            //æ­¤æ—¶channelHandlerçš„çŠ¶æ€è¿˜æ˜¯ADD_PENDINGï¼Œåªæœ‰å½“channelHandlerçš„handlerAddedæ–¹æ³•è¢«å›è°ƒåï¼ŒçŠ¶æ€æ‰ä¼šä¸ºADD_COMPLETE
            addLast0(newCtx);

            //å¦‚æœå½“å‰channelè¿˜æ²¡æœ‰å‘reactoræ³¨å†Œï¼Œåˆ™å°†handlerAddedæ–¹æ³•çš„å›è°ƒæ·»åŠ è¿›pipelineçš„ä»»åŠ¡é˜Ÿåˆ—ä¸­
            if (!registered) {
                //è¿™é‡Œä¸»è¦æ˜¯ç”¨æ¥å¤„ç†ChannelInitializerçš„æƒ…å†µ
                //è®¾ç½®channelHandlerçš„çŠ¶æ€ä¸ºADD_PENDING å³ç­‰å¾…æ·»åŠ ,å½“çŠ¶æ€å˜ä¸ºADD_COMPLETEæ—¶ channelHandlerä¸­çš„handlerAddedä¼šè¢«å›è°ƒ
                newCtx.setAddPending();
                //å‘pipelineä¸­æ·»åŠ PendingHandlerAddedTaskä»»åŠ¡ï¼Œåœ¨ä»»åŠ¡ä¸­å›è°ƒhandlerAdded
                //å½“channelæ³¨å†Œåˆ°reactoråï¼Œpipelineä¸­çš„pendingHandlerCallbackHeadä»»åŠ¡é“¾è¡¨ä¼šè¢«æŒ¨ä¸ªæ‰§è¡Œ
                callHandlerCallbackLater(newCtx, true);
                return this;
            }

            //å¦‚æœå½“å‰channelå·²ç»å‘reactoræ³¨å†ŒæˆåŠŸï¼Œé‚£ä¹ˆå°±ç›´æ¥å›è°ƒchannelHandlerä¸­çš„handlerAdddedæ–¹æ³•
            EventExecutor executor = newCtx.executor();
            if (!executor.inEventLoop()) {
                //è¿™é‡Œéœ€è¦ç¡®ä¿channelHandlerä¸­handlerAddedæ–¹æ³•çš„å›è°ƒæ˜¯åœ¨channelæŒ‡å®šçš„executorä¸­
                callHandlerAddedInEventLoop(newCtx, executor);
                return this;
            }
        }
        //å›è°ƒchannelHandlerä¸­çš„handlerAdddedæ–¹æ³•
        callHandlerAdded0(newCtx);
        return this;
    }
</code></pre></div><p>è¿™ä¸ªæ–¹æ³•çš„é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œæ¶‰åŠåˆ°å¾ˆå¤šç»†èŠ‚ï¼Œä¸ºäº†æ¸…æ™°åœ°ä¸ºå¤§å®¶è®²è¿°ï¼Œç¬”è€…è¿™é‡Œè¿˜æ˜¯é‡‡ç”¨æ€»åˆ†æ€»çš„ç»“æ„ï¼Œå…ˆæè¿°è¯¥æ–¹æ³•çš„æ€»ä½“é€»è¾‘ï¼Œç„¶ååœ¨é’ˆå¯¹æ ¸å¿ƒç»†èŠ‚è¦ç‚¹å±•å¼€ç»†èŠ‚åˆ†æã€‚</p> <p>å› ä¸ºå‘ pipeline ä¸­æ·»åŠ  channelHandler çš„æ“ä½œå¯èƒ½ä¼šåœ¨å¤šä¸ªçº¿ç¨‹ä¸­è¿›è¡Œï¼Œæ‰€ä»¥ä¸ºäº†ç¡®ä¿æ·»åŠ æ“ä½œçš„çº¿ç¨‹å®‰å…¨æ€§ï¼Œè¿™é‡Œé‡‡ç”¨ä¸€ä¸ª synchronized è¯­å¥å—å°†æ•´ä¸ªæ·»åŠ é€»è¾‘åŒ…è£¹èµ·æ¥ã€‚</p> <ol><li>é€šè¿‡ checkMultiplicity æ£€æŸ¥è¢«æ·»åŠ çš„ ChannelHandler æ˜¯å¦æ˜¯å…±äº«çš„ï¼ˆæ ‡æ³¨ @Sharable æ³¨è§£ï¼‰ï¼Œå¦‚æœä¸æ˜¯å…±äº«çš„é‚£ä¹ˆåˆ™ä¸ä¼šå…è®¸è¯¥ ChannelHandler çš„<strong>åŒä¸€å®ä¾‹</strong>è¢«æ·»åŠ è¿›å¤šä¸ª pipeline ä¸­ã€‚å¦‚æœæ˜¯å…±äº«çš„ï¼Œåˆ™å…è®¸è¯¥ ChannelHandler çš„<strong>åŒä¸€ä¸ªå®ä¾‹</strong>è¢«å¤šæ¬¡æ·»åŠ è¿›å¤šä¸ª pipeline ä¸­ã€‚</li></ol> <div class="language- extra-class"><pre class="language-text"><code>    private static void checkMultiplicity(ChannelHandler handler) {
        if (handler instanceof ChannelHandlerAdapter) {
            ChannelHandlerAdapter h = (ChannelHandlerAdapter) handler;
            //åªæœ‰æ ‡æ³¨@Sharableæ³¨è§£çš„channelHandlerï¼Œæ‰è¢«å…è®¸åŒä¸€ä¸ªå®ä¾‹è¢«æ·»åŠ è¿›å¤šä¸ªpipelineä¸­
            //æ³¨æ„ï¼šæ ‡æ³¨@Sharableä¹‹åï¼Œä¸€ä¸ªchannelHandlerçš„å®ä¾‹å¯ä»¥è¢«æ·»åŠ åˆ°å¤šä¸ªchannelå¯¹åº”çš„pipelineä¸­
            //å¯èƒ½è¢«å¤šçº¿ç¨‹æ‰§è¡Œï¼Œéœ€è¦ç¡®ä¿çº¿ç¨‹å®‰å…¨
            if (!h.isSharable() &amp;&amp; h.added) {
                throw new ChannelPipelineException(
                        h.getClass().getName() +
                        &quot; is not a @Sharable handler, so can't be added or removed multiple times.&quot;);
            }
            h.added = true;
        }
    }
</code></pre></div><blockquote><p>è¿™é‡Œå¤§å®¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä¸€ä¸ª ChannelHandler è¢«æ ‡æ³¨äº† @Sharable æ³¨è§£,è¿™å°±æ„å‘³ç€å®ƒçš„ä¸€ä¸ªå®ä¾‹å¯ä»¥è¢«å¤šæ¬¡æ·»åŠ è¿›å¤šä¸ª pipeline ä¸­ï¼ˆæ¯ä¸ª channel å¯¹åº”ä¸€ä¸ª pipeline å®ä¾‹ï¼‰ï¼Œè€Œè¿™å¤šä¸ªä¸åŒçš„ pipeline å¯èƒ½ä¼šè¢«ä¸åŒçš„ reactor çº¿ç¨‹æ‰§è¡Œï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨å…±äº« ChannelHandler çš„æ—¶å€™éœ€è¦ç¡®ä¿å…¶çº¿ç¨‹å®‰å…¨æ€§ã€‚</p></blockquote> <p>æ¯”å¦‚ä¸‹é¢çš„å®ä¾‹ä»£ç ï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>@Sharable
public class EchoServerHandler extends ChannelInboundHandlerAdapter {
            .............éœ€è¦ç¡®ä¿çº¿ç¨‹å®‰å…¨.......
}
  final EchoServerHandler serverHandler = new EchoServerHandler();

  ServerBootstrap b = new ServerBootstrap();
            b.group(bossGroup, workerGroup)
               ..................
            .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() {
                 @Override
                 public void initChannel(SocketChannel ch) throws Exception {
                     ChannelPipeline p = ch.pipeline();
                     p.addLast(serverHandler);
                 }
             });
</code></pre></div><p>EchoServerHandler ä¸ºæˆ‘ä»¬è‡ªå®šä¹‰çš„ ChannelHandler ï¼Œå®ƒè¢« @Sharable æ³¨è§£æ ‡æ³¨ï¼Œå…¨å±€åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œè¢«æ·»åŠ è¿›å¤šä¸ª Channel çš„ pipeline ä¸­ã€‚ä»è€Œä¼šè¢«å¤šä¸ª reactor çº¿ç¨‹æ‰§è¡Œåˆ°ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)å…±äº«channelHandler.png</p> <ol><li>ä¸º ChannelHandler åˆ›å»ºå…¶ ChannelHandlerContext ï¼Œç”¨äºå°è£… ChannelHandler çš„åç§°ï¼ŒçŠ¶æ€ä¿¡æ¯ï¼Œæ‰§è¡Œä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä»¥åŠç”¨äºæ„ŸçŸ¥ ChannelHandler åœ¨ pipeline ä¸­çš„ä½ç½®ä¿¡æ¯ã€‚newContext æ–¹æ³•æ¶‰åŠçš„ç»†èŠ‚è¾ƒå¤šï¼Œåé¢æˆ‘ä»¬å•ç‹¬ä»‹ç»ã€‚</li> <li>é€šè¿‡ addLast0 å°†æ–°åˆ›å»ºå‡ºæ¥çš„ ChannelHandlerContext æ’å…¥åˆ° pipeline ä¸­æœ«å°¾å¤„ã€‚æ–¹æ³•çš„é€»è¾‘å¾ˆç®€å•å…¶å®å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„åŒå‘é“¾è¡¨æ’å…¥æ“ä½œã€‚</li></ol> <div class="language- extra-class"><pre class="language-text"><code>    private void addLast0(AbstractChannelHandlerContext newCtx) {
        AbstractChannelHandlerContext prev = tail.prev;
        newCtx.prev = prev;
        newCtx.next = tail;
        prev.next = newCtx;
        tail.prev = newCtx;
    }
</code></pre></div><p>**ä½†æ˜¯è¿™é‡Œå¤§å®¶éœ€è¦æ³¨æ„çš„ç‚¹æ˜¯ï¼š**è™½ç„¶æ­¤æ—¶ ChannelHandlerContext è¢«ç‰©ç†çš„æ’å…¥åˆ°äº† pipeline ä¸­ï¼Œä½†æ˜¯æ­¤æ—¶ channelHandler çš„çŠ¶æ€ä¾ç„¶ä¸º INIT çŠ¶æ€ï¼Œä»é€»è¾‘ä¸Šæ¥è¯´å¹¶æœªç®—æ˜¯çœŸæ­£çš„æ’å…¥åˆ° pipeline ä¸­ï¼Œéœ€è¦ç­‰åˆ° ChannelHandler çš„ handlerAdded æ–¹æ³•è¢«å›è°ƒæ—¶ï¼ŒçŠ¶æ€æ‰å˜ä¸º ADD_COMPLETE ï¼Œè€Œåªæœ‰ ADD_COMPLETE çŠ¶æ€çš„ ChannelHandler æ‰èƒ½å“åº” pipeline ä¸­ä¼ æ’­çš„äº‹ä»¶ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191115611.webp" alt="å›¾ç‰‡">channelhandelrçš„çŠ¶æ€.png</p> <p>åœ¨ä¸Šç¯‡æ–‡ç« <a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484532&amp;idx=1&amp;sn=c3a8b37a2eb09509d9914494ef108c68&amp;chksm=ce77c233f9004b25a29f9fdfb179e41646092d09bc89df2147a9fab66df13231e46dd6a5c26d&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">ã€Šä¸€æ–‡ææ‡‚Nettyå‘é€æ•°æ®å…¨æµç¨‹ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸­çš„ã€Š3.1.5 è§¦å‘nextChannelHandlerçš„writeæ–¹æ³•å›è°ƒã€‹å°èŠ‚ä¸­æˆ‘ä»¬ä¹Ÿæè¿‡ï¼Œåœ¨æ¯æ¬¡ write äº‹ä»¶æˆ–è€… flush äº‹ä»¶ä¼ æ’­çš„æ—¶å€™ï¼Œéƒ½éœ€è¦é€šè¿‡ invokeHandler æ–¹æ³•æ¥åˆ¤æ–­ channelHandler çš„çŠ¶æ€æ˜¯å¦ä¸º ADD_COMPLETE  ï¼Œå¦åˆ™å½“å‰ channelHandler åˆ™ä¸èƒ½å“åº”æ­£åœ¨ pipeline ä¸­ä¼ æ’­çš„äº‹ä»¶ã€‚<strong>å¿…é¡»è¦ç­‰åˆ°å¯¹åº”çš„ handlerAdded æ–¹æ³•è¢«å›è°ƒæ‰å¯ä»¥ï¼Œå› ä¸º handlerAdded æ–¹æ³•ä¸­å¯èƒ½åŒ…å«ä¸€äº› ChannelHandler åˆå§‹åŒ–çš„é‡è¦é€»è¾‘ã€‚</strong></p> <div class="language- extra-class"><pre class="language-text"><code>    private boolean invokeHandler() {
        // è¿™é‡Œæ˜¯ä¸€ä¸ªä¼˜åŒ–ç‚¹ï¼Œnetty ç”¨ä¸€ä¸ªå±€éƒ¨å˜é‡ä¿å­˜ handlerState
        // ç›®çš„æ˜¯å‡å°‘ volatile å˜é‡ handlerState çš„è¯»å–æ¬¡æ•°
        int handlerState = this.handlerState;
        return handlerState == ADD_COMPLETE || (!ordered &amp;&amp; handlerState == ADD_PENDING);
    }

    void invokeWrite(Object msg, ChannelPromise promise) {
        if (invokeHandler()) {
            invokeWrite0(msg, promise);
        } else {
            // å½“å‰channelHandlerè™½ç„¶æ·»åŠ åˆ°pipelineä¸­ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è°ƒç”¨handlerAdded
            // æ‰€ä»¥ä¸èƒ½è°ƒç”¨å½“å‰channelHandlerä¸­çš„å›è°ƒæ–¹æ³•ï¼Œåªèƒ½ç»§ç»­å‘å‰ä¼ é€’writeäº‹ä»¶
            write(msg, promise);
        }
    }

    private void invokeFlush() {
        if (invokeHandler()) {
            invokeFlush0();
        } else {
            //å¦‚æœè¯¥ChannelHandlerè™½ç„¶åŠ å…¥åˆ°pipelineä¸­ä½†handlerAddedæ–¹æ³•å¹¶æœªè¢«å›è°ƒï¼Œåˆ™ç»§ç»­å‘å‰ä¼ é€’flushäº‹ä»¶
            flush();
        }
    }
</code></pre></div><blockquote><p>äº‹å®ä¸Šä¸ä»…ä»…æ˜¯ write äº‹ä»¶å’Œ flush äº‹ä»¶åœ¨ä¼ æ’­çš„æ—¶å€™éœ€è¦åˆ¤æ–­ ChannelHandler çš„çŠ¶æ€ï¼Œæ‰€æœ‰çš„ inbound ç±»äº‹ä»¶å’Œ outbound ç±»äº‹ä»¶åœ¨ä¼ æ’­çš„æ—¶å€™éƒ½éœ€è¦é€šè¿‡ invokeHandler æ–¹æ³•æ¥åˆ¤æ–­å½“å‰ ChannelHandler çš„çŠ¶æ€æ˜¯å¦ä¸º ADD_COMPLETE ï¼Œéœ€è¦ç¡®ä¿åœ¨ ChannelHandler å“åº”äº‹ä»¶ä¹‹å‰ï¼Œå®ƒçš„ handlerAdded æ–¹æ³•è¢«å›è°ƒã€‚</p></blockquote> <ol><li>å¦‚æœå‘ pipeline ä¸­æ·»åŠ  ChannelHandler çš„æ—¶å€™ï¼Œ channel è¿˜æ²¡æ¥å¾—åŠæ³¨å†Œåˆ° reactorä¸­ï¼Œé‚£ä¹ˆéœ€è¦å°†å½“å‰ ChannelHandler çš„çŠ¶æ€å…ˆè®¾ç½®ä¸º ADD_PENDING ï¼Œå¹¶å°†å›è°ƒè¯¥ ChannelHandler çš„ handlerAdded æ–¹æ³•å°è£…æˆ PendingHandlerAddedTask ä»»åŠ¡æ·»åŠ è¿› pipeline ä¸­çš„ä»»åŠ¡åˆ—è¡¨ä¸­ï¼Œç­‰åˆ° channel å‘ reactor æ³¨å†Œä¹‹åï¼Œreactor çº¿ç¨‹ä¼šæŒ¨ä¸ªæ‰§è¡Œ pipeline ä¸­ä»»åŠ¡åˆ—è¡¨ä¸­çš„ä»»åŠ¡ã€‚</li></ol> <blockquote><p>è¿™æ®µé€»è¾‘ä¸»è¦ç”¨æ¥å¤„ç† ChannelInitializer çš„æ·»åŠ åœºæ™¯ï¼Œå› ä¸ºç›®å‰åªæœ‰ ChannelInitializer è¿™ä¸ªç‰¹æ®Šçš„ channelHandler ä¼šåœ¨ channel æ²¡æœ‰æ³¨å†Œä¹‹å‰è¢«æ·»åŠ è¿› pipeline ä¸­</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>         if (!registered) {
                newCtx.setAddPending();
                callHandlerCallbackLater(newCtx, true);
                return this;
         }
</code></pre></div><p>å‘ pipeline çš„ä»»åŠ¡åˆ—è¡¨ pendingHandlerCallbackHead ä¸­æ·»åŠ  PendingHandlerAddedTask ä»»åŠ¡ï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>public class DefaultChannelPipeline implements ChannelPipeline {

    // pipelineä¸­çš„ä»»åŠ¡åˆ—è¡¨
    private PendingHandlerCallback pendingHandlerCallbackHead;

    // å‘ä»»åŠ¡åˆ—è¡¨å°¾éƒ¨æ·»åŠ PendingHandlerAddedTask
    private void callHandlerCallbackLater(AbstractChannelHandlerContext ctx, boolean added) {
        assert !registered;

        PendingHandlerCallback task = added ? new PendingHandlerAddedTask(ctx) : new PendingHandlerRemovedTask(ctx);
        PendingHandlerCallback pending = pendingHandlerCallbackHead;
        if (pending == null) {
            pendingHandlerCallbackHead = task;
        } else {
            // Find the tail of the linked-list.
            while (pending.next != null) {
                pending = pending.next;
            }
            pending.next = task;
        }
    }
}
</code></pre></div><p>PendingHandlerAddedTask ä»»åŠ¡è´Ÿè´£å›è°ƒ ChannelHandler ä¸­çš„ handlerAdded æ–¹æ³•ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>private final class PendingHandlerAddedTask extends PendingHandlerCallback {
        ...............

        @Override
        public void run() {
            callHandlerAdded0(ctx);
        }

       ...............
}
    private void callHandlerAdded0(final AbstractChannelHandlerContext ctx) {
       try {
            ctx.callHandlerAdded();
        } catch (Throwable t) {
           ...............
        }
    }
</code></pre></div><p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)pipelineä»»åŠ¡åˆ—è¡¨.png</p> <ol><li>é™¤äº† ChannelInitializer è¿™ä¸ªç‰¹æ®Šçš„ ChannelHandler çš„æ·»åŠ æ˜¯åœ¨ channel å‘ reactor æ³¨å†Œä¹‹å‰å¤–ï¼Œå‰©ä¸‹çš„è¿™äº›ç”¨æˆ·è‡ªå®šä¹‰çš„ ChannelHandler çš„æ·»åŠ ï¼Œå‡æ˜¯åœ¨ channel å‘ reactor æ³¨å†Œä¹‹åè¢«æ·»åŠ è¿› pipeline çš„ã€‚è¿™ç§åœºæ™¯ä¸‹çš„å¤„ç†å°±ä¼šå˜å¾—æ¯”è¾ƒç®€å•ï¼Œåœ¨ ChannelHandler è¢«æ’å…¥åˆ° pipeline ä¸­ä¹‹åï¼Œå°±ä¼šç«‹å³å›è°ƒè¯¥ ChannelHandler çš„ handlerAdded æ–¹æ³•ã€‚<strong>ä½†æ˜¯éœ€è¦ç¡®ä¿ handlerAdded æ–¹æ³•çš„å›è°ƒåœ¨ channel æŒ‡å®šçš„ executor ä¸­è¿›è¡Œã€‚</strong></li></ol> <div class="language- extra-class"><pre class="language-text"><code>            EventExecutor executor = newCtx.executor();
            if (!executor.inEventLoop()) {
                callHandlerAddedInEventLoop(newCtx, executor);
                return this;
            }  
      
            callHandlerAdded0(newCtx);
</code></pre></div><p>å¦‚æœå½“å‰æ‰§è¡Œçº¿ç¨‹å¹¶ä¸æ˜¯ ChannelHandler æŒ‡å®šçš„ executor ( !executor.inEventLoop() ),é‚£ä¹ˆå°±éœ€è¦ç¡®ä¿ handlerAdded æ–¹æ³•çš„å›è°ƒåœ¨ channel æŒ‡å®šçš„ executor ä¸­è¿›è¡Œã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private void callHandlerAddedInEventLoop(final AbstractChannelHandlerContext newCtx, EventExecutor executor) {
        newCtx.setAddPending();
        executor.execute(new Runnable() {
            @Override
            public void run() {
                callHandlerAdded0(newCtx);
            }
        });
    }
</code></pre></div><p><strong>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯éœ€è¦åœ¨å›è°ƒ handlerAdded æ–¹æ³•ä¹‹å‰å°† ChannelHandler çš„çŠ¶æ€æå‰è®¾ç½®ä¸º ADD_COMPLETE ã€‚</strong> å› ä¸ºç”¨æˆ·å¯èƒ½åœ¨ ChannelHandler ä¸­çš„ handerAdded å›è°ƒä¸­è§¦å‘ä¸€äº›äº‹ä»¶ï¼Œè€Œå¦‚æœæ­¤æ—¶ ChannelHandler çš„çŠ¶æ€ä¸æ˜¯ ADD_COMPLETE çš„è¯ï¼Œå°±ä¼šåœæ­¢å¯¹äº‹ä»¶çš„å“åº”ï¼Œä»è€Œé”™è¿‡äº‹ä»¶çš„å¤„ç†ã€‚</p> <blockquote><p>è¿™ç§å±äºä¸€ç§ç”¨æˆ·æç«¯çš„ä½¿ç”¨æƒ…å†µã€‚</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>    final void callHandlerAdded() throws Exception {
        if (setAddComplete()) {
            handler().handlerAdded(this);
        }
    }
</code></pre></div><h2 id="_5-channehandlercontext-çš„åˆ›å»º"><a href="#_5-channehandlercontext-çš„åˆ›å»º" class="header-anchor">#</a> 5. ChanneHandlerContext çš„åˆ›å»º</h2> <p>åœ¨ä»‹ç»å®Œ ChannelHandler å‘ pipeline æ·»åŠ çš„æ•´ä¸ªé€»è¾‘è¿‡ç¨‹åï¼Œæœ¬å°èŠ‚æˆ‘ä»¬æ¥çœ‹ä¸‹å¦‚ä½•ä¸º ChannelHandler åˆ›å»ºå¯¹åº”çš„ ChannelHandlerContext ï¼Œä»¥åŠ ChannelHandlerContext ä¸­å…·ä½“åŒ…å«äº†å“ªäº›ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class DefaultChannelPipeline implements ChannelPipeline {
    @Override
    public final ChannelPipeline addLast(EventExecutorGroup group, String name, ChannelHandler handler) {
        final AbstractChannelHandlerContext newCtx;
        synchronized (this) {
             
            ................

            //åˆ›å»ºchannelHandlerContextåŒ…è£¹channelHandlerå¹¶å°è£…æ‰§è¡Œä¼ æ’­ç›¸å…³çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
            newCtx = newContext(group, filterName(name, handler), handler);

             ................
        }

    }

    private AbstractChannelHandlerContext newContext(EventExecutorGroup group, String name, ChannelHandler handler) {
        return new DefaultChannelHandlerContext(this, childExecutor(group), name, handler);
    }

}
</code></pre></div><p>åœ¨åˆ›å»º ChannelHandlerContext ä¹‹å‰ï¼Œéœ€è¦åšä¸¤ä¸ªé‡è¦çš„å‰ç½®æ“ä½œï¼š</p> <ul><li>é€šè¿‡ filterName æ–¹æ³•ä¸º ChannelHandlerContext è¿‡æ»¤å‡ºåœ¨ pipeline ä¸­å”¯ä¸€çš„åç§°ã€‚</li> <li>å¦‚æœç”¨æˆ·ä¸º ChannelHandler æŒ‡å®šäº†ç‰¹æ®Šçš„ EventExecutorGroup ï¼Œè¿™é‡Œå°±éœ€è¦é€šè¿‡ childExecutor æ–¹æ³•ä»æŒ‡å®šçš„ EventExecutorGroup ä¸­é€‰å‡ºä¸€ä¸ª EventExecutor ä¸ ChannelHandler ç»‘å®šã€‚</li></ul> <h3 id="_5-1-filtername"><a href="#_5-1-filtername" class="header-anchor">#</a> 5.1 filterName</h3> <div class="language- extra-class"><pre class="language-text"><code>    private String filterName(String name, ChannelHandler handler) {
        if (name == null) {
            // å¦‚æœæ²¡æœ‰æŒ‡å®šname,åˆ™ä¼šä¸ºhandleré»˜è®¤ç”Ÿæˆä¸€ä¸ªnameï¼Œè¯¥æ–¹æ³•å¯ç¡®ä¿é»˜è®¤ç”Ÿæˆçš„nameåœ¨pipelineä¸­ä¸ä¼šé‡å¤
            return generateName(handler);
        }

        // å¦‚æœæŒ‡å®šäº†nameï¼Œéœ€è¦ç¡®ä¿nameåœ¨pipelineä¸­æ˜¯å”¯ä¸€çš„
        checkDuplicateName(name);
        return name;
    }
</code></pre></div><p>å¦‚æœç”¨æˆ·å†å‘ pipeline æ·»åŠ  ChannelHandler çš„æ—¶å€™ï¼Œä¸ºå…¶æŒ‡å®šäº†å…·ä½“çš„åç§°ï¼Œé‚£ä¹ˆè¿™é‡Œéœ€è¦ç¡®ä¿ç”¨æˆ·æŒ‡å®šçš„åç§°åœ¨ pipeline ä¸­æ˜¯å”¯ä¸€çš„ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private void checkDuplicateName(String name) {
        if (context0(name) != null) {
            throw new IllegalArgumentException(&quot;Duplicate handler name: &quot; + name);
        }
    }

    /**
     * é€šè¿‡æŒ‡å®šåç§°åœ¨pipelineä¸­æŸ¥æ‰¾å¯¹åº”çš„channelHandler æ²¡æœ‰è¿”å›null
     * */
    private AbstractChannelHandlerContext context0(String name) {
        AbstractChannelHandlerContext context = head.next;
        while (context != tail) {
            if (context.name().equals(name)) {
                return context;
            }
            context = context.next;
        }
        return null;
    }
</code></pre></div><p>å¦‚æœç”¨æˆ·æ²¡æœ‰ä¸º ChannelHandler æŒ‡å®šåç§°ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸º ChannelHandler åœ¨ pipeline ä¸­é»˜è®¤ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„åç§°ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    // pipelineä¸­channelHandlerå¯¹åº”çš„nameç¼“å­˜
    private static final FastThreadLocal&lt;Map&lt;Class&lt;?&gt;, String&gt;&gt; nameCaches =
            new FastThreadLocal&lt;Map&lt;Class&lt;?&gt;, String&gt;&gt;() {
        @Override
        protected Map&lt;Class&lt;?&gt;, String&gt; initialValue() {
            return new WeakHashMap&lt;Class&lt;?&gt;, String&gt;();
        }
    };

    private String generateName(ChannelHandler handler) {
        // è·å–pipelineä¸­channelHandlerå¯¹åº”çš„nameç¼“å­˜
        Map&lt;Class&lt;?&gt;, String&gt; cache = nameCaches.get();
        Class&lt;?&gt; handlerType = handler.getClass();
        String name = cache.get(handlerType);
        if (name == null) {
            // å½“å‰handlerè¿˜æ²¡å¯¹åº”çš„nameç¼“å­˜ï¼Œåˆ™é»˜è®¤ç”Ÿæˆï¼šsimpleClassName + #0
            name = generateName0(handlerType);
            cache.put(handlerType, name);
        }

        if (context0(name) != null) {
            // ä¸æ–­é‡è¯•åç§°åç¼€#n + 1 ç›´åˆ°æ²¡æœ‰é‡å¤
            String baseName = name.substring(0, name.length() - 1); 
            for (int i = 1;; i ++) {
                String newName = baseName + i;
                if (context0(newName) == null) {
                    name = newName;
                    break;
                }
            }
        }
        return name;
    }

    private static String generateName0(Class&lt;?&gt; handlerType) {
        return StringUtil.simpleClassName(handlerType) + &quot;#0&quot;;
    }
</code></pre></div><p>pipeline ä¸­ä½¿ç”¨äº†ä¸€ä¸ª FastThreadLocal ç±»å‹çš„ nameCaches æ¥ç¼“å­˜å„ç§ç±»å‹ ChannelHandler çš„åŸºç¡€åç§°ã€‚åé¢ä¼šæ ¹æ®è¿™ä¸ªåŸºç¡€åç§°ä¸æ–­çš„é‡è¯•ç”Ÿæˆä¸€ä¸ªæ²¡æœ‰å†²çªçš„æ­£å¼åç§°ã€‚ç¼“å­˜ nameCaches ä¸­çš„ key è¡¨ç¤ºç‰¹å®šçš„ ChannelHandler ç±»å‹ï¼Œvalue è¡¨ç¤ºè¯¥ç‰¹å®šç±»å‹çš„ ChannelHandler çš„åŸºç¡€åç§°  <code>simpleClassName + #0</code>ã€‚</p> <p>è‡ªåŠ¨ä¸º ChannelHandler ç”Ÿæˆé»˜è®¤åç§°çš„é€»è¾‘æ˜¯ï¼š</p> <ul><li>é¦–å…ˆä»ç¼“å­˜ä¸­ nameCaches è·å–å½“å‰æ·»åŠ çš„ ChannelHandler çš„åŸºç¡€åç§° <code>simpleClassName + #0</code>ã€‚</li> <li>å¦‚æœè¯¥åŸºç¡€åç§° <code>simpleClassName + #0</code> åœ¨ pipeline ä¸­æ˜¯å”¯ä¸€çš„ï¼Œé‚£ä¹ˆå°±å°†åŸºç¡€åç§°ä½œä¸º ChannelHandler çš„åç§°ã€‚</li> <li>å¦‚æœç¼“å­˜çš„åŸºç¡€åç§°åœ¨ pipeline ä¸­ä¸æ˜¯å”¯ä¸€çš„ï¼Œåˆ™ä¸æ–­çš„å¢åŠ åç§°åç¼€ <code>simpleClassName#1 ,simpleClassName#2 ...... simpleClassName#n</code> ç›´åˆ°äº§ç”Ÿä¸€ä¸ªæ²¡æœ‰é‡å¤çš„åç§°ã€‚</li></ul> <blockquote><p>è™½ç„¶ç”¨æˆ·ä¸å¤§å¯èƒ½å°†åŒä¸€ç±»å‹çš„ channelHandler é‡å¤æ·»åŠ åˆ° pipeline ä¸­ï¼Œä½†æ˜¯ netty ä¸ºäº†é˜²æ­¢è¿™ç§åå¤æ·»åŠ åŒä¸€ç±»å‹ ChannelHandler çš„è¡Œä¸ºå¯¼è‡´çš„åç§°å†²çªï¼Œä»è€Œåˆ©ç”¨ nameCaches æ¥ç¼“å­˜åŒä¸€ç±»å‹ ChannelHandler çš„åŸºç¡€åç§° <code>simpleClassName + #0</code>ï¼Œç„¶åé€šè¿‡ä¸æ–­çš„é‡è¯•é€’å¢åç§°åç¼€ï¼Œæ¥ç”Ÿæˆä¸€ä¸ªåœ¨pipelineä¸­å”¯ä¸€çš„åç§°ã€‚</p></blockquote> <h3 id="_5-2-childexecutor"><a href="#_5-2-childexecutor" class="header-anchor">#</a> 5.2 childExecutor</h3> <p>é€šè¿‡å‰è¾¹çš„ä»‹ç»æˆ‘ä»¬äº†è§£åˆ°ï¼Œå½“æˆ‘ä»¬å‘ pipeline æ·»åŠ  ChannelHandler çš„æ—¶å€™ï¼Œnetty å…è®¸æˆ‘ä»¬ä¸º ChannelHandler æŒ‡å®šç‰¹å®šçš„ executor å»æ‰§è¡Œ ChannelHandler ä¸­çš„å„ç§äº‹ä»¶å›è°ƒæ–¹æ³•ã€‚</p> <p>é€šå¸¸æˆ‘ä»¬ä¼šä¸º ChannelHandler æŒ‡å®šä¸€ä¸ªEventExecutorGroupï¼Œåœ¨åˆ›å»ºChannelHandlerContext çš„æ—¶å€™ï¼Œä¼šé€šè¿‡ childExecutor æ–¹æ³•ä» EventExecutorGroup ä¸­é€‰å–ä¸€ä¸ª EventExecutor æ¥ä¸è¯¥ ChannelHandler ç»‘å®šã€‚</p> <blockquote><p>EventExecutorGroup æ˜¯ netty è‡ªå®šä¹‰çš„ä¸€ä¸ªçº¿ç¨‹æ± æ¨¡å‹ï¼Œå…¶ä¸­åŒ…å«å¤šä¸ª EventExecutor ï¼Œè€Œ EventExecutor åœ¨ netty ä¸­æ˜¯ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œæ¨¡å‹ã€‚ç›¸å…³çš„å…·ä½“å®ç°å’Œç”¨æ³•ç¬”è€…å·²ç»åœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247483907&amp;idx=1&amp;sn=084c470a8fe6234c2c9461b5f713ff30&amp;chksm=ce77c444f9004d52e7c6244bee83479070effb0bc59236df071f4d62e91e25f01715fca53696&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">ã€ŠReactoråœ¨Nettyä¸­çš„å®ç°(åˆ›å»ºç¯‡)ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸€æ–‡ä¸­ç»™å‡ºäº†è¯¦å°½çš„ä»‹ç»ï¼Œå¿˜è®°çš„åŒå­¦å¯ä»¥åœ¨å›é¡¾ä¸‹ã€‚</p></blockquote> <p>åœ¨ä»‹ç» executor çš„ç»‘å®šé€»è¾‘ä¹‹å‰ï¼Œè¿™é‡Œç¬”è€…éœ€è¦å…ˆä¸ºå¤§å®¶ä»‹ç»ä¸€ä¸ªç›¸å…³çš„é‡è¦å‚æ•°ï¼š<code>SINGLE_EVENTEXECUTOR_PER_GROUP</code> ï¼Œé»˜è®¤ä¸º true ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>ServerBootstrap b = new ServerBootstrap();
b.group(bossGroup, workerGroup)
.channel(NioServerSocketChannel.class)
  .........
.childOption(ChannelOption.SINGLE_EVENTEXECUTOR_PER_GROUP,trueï¼‰
</code></pre></div><p>æˆ‘ä»¬çŸ¥é“åœ¨ netty ä¸­ï¼Œæ¯ä¸€ä¸ª channel éƒ½ä¼šå¯¹åº”ä¸€ä¸ªç‹¬ç«‹çš„ pipeline ï¼Œå¦‚æœæˆ‘ä»¬å¼€å¯äº† <code>SINGLE_EVENTEXECUTOR_PER_GROUP</code> å‚æ•°ï¼Œè¡¨ç¤ºåœ¨ä¸€ä¸ª channel å¯¹åº”çš„ pipeline ä¸­ï¼Œå¦‚æœæˆ‘ä»¬ä¸ºå¤šä¸ª ChannelHandler æŒ‡å®šäº†åŒä¸€ä¸ª EventExecutorGroup ï¼Œé‚£ä¹ˆè¿™å¤šä¸ª channelHandler åªèƒ½ç»‘å®šåˆ° EventExecutorGroup ä¸­çš„åŒä¸€ä¸ª EventExecutor ä¸Šã€‚</p> <p>ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿï¼Ÿæ¯”å¦‚æˆ‘ä»¬æœ‰ä¸‹é¢ä¸€æ®µåˆå§‹åŒ–<code>pipeline</code>çš„ä»£ç ï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>            ServerBootstrap b = new ServerBootstrap();
            b.group(bossGroup, workerGroup)
                 ........................
             .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() {
                 @Override
                 public void initChannel(SocketChannel ch) throws Exception {
                     ChannelPipeline pipeline = ch.pipeline();
                     pipeline.addLast(eventExecutorGroup,channelHandler1)
                     pipeline.addLast(eventExecutorGroup,channelHandler2)
                     pipeline.addLast(eventExecutorGroup,channelHandler3)
                 }
             });
</code></pre></div><p>eventExecutorGroup ä¸­åŒ…å« EventExecutor1ï¼ŒEventExecutor2 ï¼Œ EventExecutor3 ä¸‰ä¸ªæ‰§è¡Œçº¿ç¨‹ã€‚</p> <p>å‡è®¾æ­¤æ—¶ç¬¬ä¸€ä¸ªè¿æ¥è¿›æ¥ï¼Œåœ¨åˆ›å»º channel1 ååˆå§‹åŒ– pipeline1 çš„æ—¶å€™ï¼Œå¦‚æœåœ¨å¼€å¯ <code>SINGLE_EVENTEXECUTOR_PER_GROUP</code> å‚æ•°çš„æƒ…å†µä¸‹ï¼Œé‚£ä¹ˆåœ¨ channel1 å¯¹åº”çš„ pipeline1 ä¸­ channelHandler1ï¼ŒchannelHandler2 ï¼Œ channelHandler3 ç»‘å®šçš„ EventExecutor å‡ä¸º EventExecutorGroup ä¸­çš„ EventExecutor1 ã€‚</p> <p>ç¬¬äºŒä¸ªè¿æ¥ channel2 å¯¹åº”çš„ pipeline2 ä¸­ channelHandler1 ï¼Œ channelHandler2 ï¼ŒchannelHandler3 ç»‘å®šçš„ EventExecutor å‡ä¸º EventExecutorGroup ä¸­çš„ EventExecutor2 ã€‚</p> <p>ç¬¬ä¸‰ä¸ªè¿æ¥ channel3 å¯¹åº”çš„ pipeline3 ä¸­ channelHandler1 ï¼Œ channelHandler2 ï¼ŒchannelHandler3 ç»‘å®šçš„ EventExecutor å‡ä¸º EventExecutorGroup ä¸­çš„ EventExecutor3 ã€‚</p> <p>ä»¥æ­¤ç±»æ¨........</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191115389.webp" alt="å›¾ç‰‡">SINGLE_EVENTEXECUTOR_PER_GROUPç»‘å®š.png</p> <p>å¦‚æœåœ¨å…³é—­ <code>SINGLE_EVENTEXECUTOR_PER_GROUP</code> å‚æ•°çš„æƒ…å†µä¸‹, channel1 å¯¹åº”çš„ pipeline1 ä¸­ channelHandler1 ä¼šç»‘å®šåˆ° EventExecutorGroup ä¸­çš„ EventExecutor1 ï¼ŒchannelHandler2 ä¼šç»‘å®šåˆ° EventExecutor2 ï¼ŒchannelHandler3 ä¼šç»‘å®šåˆ° EventExecutor3 ã€‚</p> <p>åŒç†å…¶ä»– channel å¯¹åº”çš„ pipeline ä¸­çš„ channelHandler ç»‘å®šé€»è¾‘åŒ channel1 ã€‚å®ƒä»¬å‡ä¼šç»‘å®šåˆ° EventExecutorGroup ä¸­çš„ä¸åŒ EventExecutor ä¸­ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)SINGLE_EVENTEXECUTOR_PER_GROUPå…³é—­.png</p> <p>å½“æˆ‘ä»¬äº†è§£äº† <code>SINGLE_EVENTEXECUTOR_PER_GROUP</code>å‚æ•°çš„ä½œç”¨ä¹‹åï¼Œå†æ¥çœ‹ä¸‹é¢è¿™æ®µç»‘å®šé€»è¾‘å°±å¾ˆå®¹æ˜“ç†è§£äº†ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>     // åœ¨æ¯ä¸ªpipelineä¸­éƒ½ä¼šä¿å­˜EventExecutorGroupä¸­ç»‘å®šçš„çº¿ç¨‹
    private Map&lt;EventExecutorGroup, EventExecutor&gt; childExecutors;

    private EventExecutor childExecutor(EventExecutorGroup group) {
        if (group == null) {
            return null;
        }

        Boolean pinEventExecutor = channel.config().getOption(ChannelOption.SINGLE_EVENTEXECUTOR_PER_GROUP);
        if (pinEventExecutor != null &amp;&amp; !pinEventExecutor) {
            //å¦‚æœæ²¡æœ‰å¼€å¯SINGLE_EVENTEXECUTOR_PER_GROUPï¼Œåˆ™æŒ‰é¡ºåºä»æŒ‡å®šçš„EventExecutorGroupä¸­ä¸ºchannelHandleråˆ†é…EventExecutor
            return group.next();
        }

        //è·å–pipelineç»‘å®šåˆ°EventExecutorGroupçš„çº¿ç¨‹ï¼ˆåœ¨ä¸€ä¸ªpipelineä¸­ä¼šä¸ºæ¯ä¸ªæŒ‡å®šçš„EventExecutorGroupç»‘å®šä¸€ä¸ªå›ºå®šçš„çº¿ç¨‹ï¼‰
        Map&lt;EventExecutorGroup, EventExecutor&gt; childExecutors = this.childExecutors;
        if (childExecutors == null) {
            childExecutors = this.childExecutors = new IdentityHashMap&lt;EventExecutorGroup, EventExecutor&gt;(4);
        }

        //è·å–è¯¥pipelineç»‘å®šåœ¨æŒ‡å®šEventExecutorGroupä¸­çš„çº¿ç¨‹
        EventExecutor childExecutor = childExecutors.get(group);
        if (childExecutor == null) {
            childExecutor = group.next();
            childExecutors.put(group, childExecutor);
        }
        return childExecutor;
    }
</code></pre></div><p>å¦‚æœæˆ‘ä»¬å¹¶æœªç‰¹æ®ŠæŒ‡å®š ChannelHandler çš„ executor ï¼Œé‚£ä¹ˆé»˜è®¤ä¼šæ˜¯å¯¹åº” channel ç»‘å®šçš„ reactor çº¿ç¨‹è´Ÿè´£æ‰§è¡Œè¯¥ ChannelHandler ã€‚</p> <p>å¦‚æœæˆ‘ä»¬æœªå¼€å¯ <code>SINGLE_EVENTEXECUTOR_PER_GROUP</code>ï¼Œnetty å°±ä¼šä»æˆ‘ä»¬æŒ‡å®šçš„ EventExecutorGroup ä¸­æŒ‰ç…§ round-robin çš„æ–¹å¼ä¸º ChannelHandler ç»‘å®šå…¶ä¸­ä¸€ä¸ª eventExecutor ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)SINGLE_EVENTEXECUTOR_PER_GROUPå…³é—­.png</p> <p>å¦‚æœæˆ‘ä»¬å¼€å¯äº† <code>SINGLE_EVENTEXECUTOR_PER_GROUP</code>ï¼Œ<strong>ç›¸åŒçš„ EventExecutorGroup åœ¨åŒä¸€ä¸ª pipeline å®ä¾‹ä¸­çš„ç»‘å®šå…³ç³»æ˜¯å›ºå®šçš„</strong>ã€‚åœ¨ pipeline ä¸­å¦‚æœå¤šä¸ª channelHandler æŒ‡å®šäº†åŒä¸€ä¸ª EventExecutorGroup ï¼Œé‚£ä¹ˆè¿™äº› channelHandler çš„ executor å‡ä¼šç»‘å®šåˆ°ä¸€ä¸ªå›ºå®šçš„ eventExecutor ä¸Šã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191115389.webp" alt="å›¾ç‰‡">SINGLE_EVENTEXECUTOR_PER_GROUPç»‘å®š.png</p> <p>è¿™ç§å›ºå®šçš„ç»‘å®šå…³ç³»ç¼“å­˜äºæ¯ä¸ª pipeline ä¸­çš„ Map&lt;EventExecutorGroup, EventExecutor&gt; childExecutors å­—æ®µä¸­ï¼Œkey æ˜¯ç”¨æˆ·ä¸º channelHandler æŒ‡å®šçš„ EventExecutorGroup ï¼Œvalue ä¸ºè¯¥ EventExecutorGroup åœ¨ pipeline å®ä¾‹ä¸­çš„ç»‘å®š eventExecutor ã€‚</p> <p>æ¥ä¸‹æ¥å°±æ˜¯ä» childExecutors ä¸­è·å–æŒ‡å®š EventExecutorGroup åœ¨è¯¥ pipeline å®ä¾‹ä¸­çš„ç»‘å®š eventExecutorï¼Œå¦‚æœç»‘å®šå…³ç³»è¿˜æœªå»ºç«‹ï¼Œåˆ™é€šè¿‡ round-robin çš„æ–¹å¼ä» EventExecutorGroup ä¸­é€‰å–ä¸€ä¸ª eventExecutor è¿›è¡Œç»‘å®šï¼Œå¹¶åœ¨ childExecutor ä¸­ç¼“å­˜ç»‘å®šå…³ç³»ã€‚</p> <p>å¦‚æœç»‘å®šå…³ç³»å·²ç»å»ºç«‹ï¼Œåˆ™ç›´æ¥ä¸º ChannelHandler æŒ‡å®šç»‘å®šå¥½çš„ eventExecutorã€‚</p> <h3 id="_5-3-channehandlercontext"><a href="#_5-3-channehandlercontext" class="header-anchor">#</a> 5.3 ChanneHandlerContext</h3> <p>åœ¨ä»‹ç»å®Œåˆ›å»º ChannelHandlerContext çš„ä¸¤ä¸ªå‰ç½®æ“ä½œåï¼Œæˆ‘ä»¬å›å¤´æ¥çœ‹ä¸‹ ChannelHandlerContext ä¸­åŒ…å«äº†å“ªäº›å…·ä½“çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>final class DefaultChannelHandlerContext extends AbstractChannelHandlerContext {

    // ChannelHandlerContextåŒ…è£¹çš„channelHandler
    private final ChannelHandler handler;

    DefaultChannelHandlerContext(
            DefaultChannelPipeline pipeline, EventExecutor executor, String name, ChannelHandler handler) {
        super(pipeline, executor, name, handler.getClass());
        //åŒ…è£¹çš„channelHandler
        this.handler = handler;
    }

    @Override
    public ChannelHandler handler() {
        return handler;
    }
}
abstract class AbstractChannelHandlerContext implements ChannelHandlerContext, ResourceLeakHint {
    //å¯¹åº”channelHandlerçš„åç§°
    private final String name;

    //ChannelHandlerContextä¸­æŒæœ‰pipelineçš„å¼•ç”¨
    private final DefaultChannelPipeline pipeline;

    // channelHandlerå¯¹åº”çš„executor é»˜è®¤ä¸ºreactor
    final EventExecutor executor;

    //channelHandlerContextä¸­ä¿å­˜channelHandlerçš„æ‰§è¡Œæ¡ä»¶æ©ç ï¼ˆæ˜¯ä»€ä¹ˆç±»å‹çš„ChannelHandler,å¯¹ä»€ä¹ˆäº‹ä»¶æ„Ÿå…´è¶£ï¼‰
    private final int executionMask;

    //falseè¡¨ç¤º å½“channelHandlerçš„çŠ¶æ€ä¸ºADD_PENDINGçš„æ—¶å€™ï¼Œä¹Ÿå¯ä»¥å“åº”pipelineä¸­çš„äº‹ä»¶
    //trueè¡¨ç¤ºåªæœ‰åœ¨channelHandlerçš„çŠ¶æ€ä¸ºADD_COMPLETEçš„æ—¶å€™æ‰èƒ½å“åº”pipelineä¸­çš„äº‹ä»¶
    private final boolean ordered;

    //channelHandelrçš„çŠ¶æ€ï¼Œåˆå§‹åŒ–ä¸ºINIT
    private volatile int handlerState = INIT;

    AbstractChannelHandlerContext(DefaultChannelPipeline pipeline, EventExecutor executor,
                                  String name, Class&lt;? extends ChannelHandler&gt; handlerClass) {
        this.name = ObjectUtil.checkNotNull(name, &quot;name&quot;);
        this.pipeline = pipeline;
        this.executor = executor;
        //channelHandlerContextä¸­ä¿å­˜channelHandlerçš„æ‰§è¡Œæ¡ä»¶æ©ç ï¼ˆæ˜¯ä»€ä¹ˆç±»å‹çš„ChannelHandler,å¯¹ä»€ä¹ˆäº‹ä»¶æ„Ÿå…´è¶£ï¼‰
        this.executionMask = mask(handlerClass);
        ordered = executor == null || executor instanceof OrderedEventExecutor;
    }

}
</code></pre></div><p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)ChannelHandlerContext.png</p> <p>è¿™é‡Œç¬”è€…é‡ç‚¹ä»‹ç» orderd å±æ€§å’Œ executionMask å±æ€§ï¼Œå…¶ä»–çš„å±æ€§å¤§å®¶å¾ˆå®¹æ˜“ç†è§£ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>  ordered = executor == null || executor instanceof OrderedEventExecutor;
</code></pre></div><p>å½“æˆ‘ä»¬ä¸æŒ‡å®š channelHandler çš„ executor æ—¶æˆ–è€…æŒ‡å®šçš„ executor ç±»å‹ä¸º OrderedEventExecutor æ—¶ï¼Œordered = trueã€‚</p> <p>é‚£ä¹ˆè¿™ä¸ª ordered å±æ€§å¯¹äº ChannelHandler å“åº” pipeline ä¸­çš„äº‹ä»¶æœ‰ä»€ä¹ˆå½±å“å‘¢ï¼Ÿ</p> <p>æˆ‘ä»¬ä¹‹å‰ä»‹ç»è¿‡åœ¨ ChannelHandler å“åº” pipeline ä¸­çš„äº‹ä»¶ä¹‹å‰éƒ½ä¼šè°ƒç”¨ invokeHandler() æ–¹æ³•æ¥åˆ¤æ–­æ˜¯å¦å›è°ƒ ChannelHandler çš„äº‹ä»¶å›è°ƒæ–¹æ³•è¿˜æ˜¯è·³è¿‡ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>   private boolean invokeHandler() {
        int handlerState = this.handlerState;
        return handlerState == ADD_COMPLETE || (!ordered &amp;&amp; handlerState == ADD_PENDING);
    }
</code></pre></div><ul><li>å½“ <code>ordered == false</code> æ—¶ï¼ŒchannelHandler çš„çŠ¶æ€ä¸º ADD_PENDING çš„æ—¶å€™ï¼Œä¹Ÿå¯ä»¥å“åº” pipeline ä¸­çš„äº‹ä»¶ã€‚</li> <li>å½“ <code>ordered == true</code> æ—¶ï¼Œåªæœ‰åœ¨ channelHandler çš„çŠ¶æ€ä¸º ADD_COMPLETE çš„æ—¶å€™æ‰èƒ½å“åº” pipeline ä¸­çš„äº‹ä»¶</li></ul> <p>å¦ä¸€ä¸ªé‡è¦çš„å±æ€§ <code>executionMask</code> ä¿å­˜çš„æ˜¯å½“å‰ ChannelHandler çš„ä¸€äº›æ‰§è¡Œæ¡ä»¶ä¿¡æ¯æ©ç ï¼Œæ¯”å¦‚ï¼š</p> <ul><li>å½“å‰ ChannelHandler æ˜¯ä»€ä¹ˆç±»å‹çš„ï¼ˆ ChannelInboundHandler or ChannelOutboundHandler ?ï¼‰ã€‚</li> <li>å½“å‰ ChannelHandler å¯¹å“ªäº›äº‹ä»¶æ„Ÿå…´è¶£ï¼ˆè¦†ç›–äº†å“ªäº›äº‹ä»¶å›è°ƒæ–¹æ³•?ï¼‰</li></ul> <div class="language- extra-class"><pre class="language-text"><code>    private static final FastThreadLocal&lt;Map&lt;Class&lt;? extends ChannelHandler&gt;, Integer&gt;&gt; MASKS =
            new FastThreadLocal&lt;Map&lt;Class&lt;? extends ChannelHandler&gt;, Integer&gt;&gt;() {
                @Override
                protected Map&lt;Class&lt;? extends ChannelHandler&gt;, Integer&gt; initialValue() {
                    return new WeakHashMap&lt;Class&lt;? extends ChannelHandler&gt;, Integer&gt;(32);
                }
            };

    static int mask(Class&lt;? extends ChannelHandler&gt; clazz) {
        // å› ä¸ºæ¯å»ºç«‹ä¸€ä¸ªchannelå°±ä¼šåˆå§‹åŒ–ä¸€ä¸ªpipelineï¼Œè¿™é‡Œéœ€è¦å°†ChannelHandlerå¯¹åº”çš„maskç¼“å­˜
        Map&lt;Class&lt;? extends ChannelHandler&gt;, Integer&gt; cache = MASKS.get();
        Integer mask = cache.get(clazz);
        if (mask == null) {
            // è®¡ç®—ChannelHandlerå¯¹åº”çš„maskï¼ˆä»€ä¹ˆç±»å‹çš„ChannelHandlerï¼Œå¯¹ä»€ä¹ˆäº‹ä»¶æ„Ÿå…´è¶£ï¼‰
            mask = mask0(clazz);
            cache.put(clazz, mask);
        }
        return mask;
    }
</code></pre></div><p>è¿™é‡Œéœ€è¦ä¸€ä¸ª FastThreadLocal ç±»å‹çš„ MASKS å­—æ®µæ¥ç¼“å­˜ ChannelHandler å¯¹åº”çš„æ‰§è¡Œæ©ç ã€‚å› ä¸º ChannelHandler ç±»ä¸€æ—¦è¢«å®šä¹‰å‡ºæ¥å®ƒçš„æ‰§è¡Œæ©ç å°±å›ºå®šäº†ï¼Œè€Œ netty éœ€è¦æ¥æ”¶å¤§é‡çš„è¿æ¥ï¼Œåˆ›å»ºå¤§é‡çš„ channel ï¼Œå¹¶ä¸ºè¿™äº› channel åˆå§‹åŒ–å¯¹åº”çš„ pipeline ï¼Œéœ€è¦é¢‘ç¹çš„è®°å½• channelHandler çš„æ‰§è¡Œæ©ç åˆ° context ç±»ä¸­ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦å°†æ©ç ç¼“å­˜èµ·æ¥ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private static int mask0(Class&lt;? extends ChannelHandler&gt; handlerType) {
        int mask = MASK_EXCEPTION_CAUGHT;
        try {
            if (ChannelInboundHandler.class.isAssignableFrom(handlerType)) {
                //å¦‚æœè¯¥ChannelHandleræ˜¯Inboundç±»å‹çš„ï¼Œåˆ™å…ˆå°†inboundäº‹ä»¶å…¨éƒ¨è®¾ç½®è¿›æ©ç ä¸­
                mask |= MASK_ALL_INBOUND;

                //æœ€ååœ¨å¯¹ä¸æ„Ÿå…´è¶£çš„äº‹ä»¶ä¸€ä¸€æ’é™¤ï¼ˆhandlerä¸­çš„äº‹ä»¶å›è°ƒæ–¹æ³•å¦‚æœæ ‡æ³¨äº†@Skipæ³¨è§£ï¼Œåˆ™è®¤ä¸ºhandlerå¯¹è¯¥äº‹ä»¶ä¸æ„Ÿå…´è¶£ï¼‰
                if (isSkippable(handlerType, &quot;channelRegistered&quot;, ChannelHandlerContext.class)) {
                    mask &amp;= ~MASK_CHANNEL_REGISTERED;
                }
                if (isSkippable(handlerType, &quot;channelUnregistered&quot;, ChannelHandlerContext.class)) {
                    mask &amp;= ~MASK_CHANNEL_UNREGISTERED;
                }
                if (isSkippable(handlerType, &quot;channelActive&quot;, ChannelHandlerContext.class)) {
                    mask &amp;= ~MASK_CHANNEL_ACTIVE;
                }
                if (isSkippable(handlerType, &quot;channelInactive&quot;, ChannelHandlerContext.class)) {
                    mask &amp;= ~MASK_CHANNEL_INACTIVE;
                }
                if (isSkippable(handlerType, &quot;channelRead&quot;, ChannelHandlerContext.class, Object.class)) {
                    mask &amp;= ~MASK_CHANNEL_READ;
                }
                if (isSkippable(handlerType, &quot;channelReadComplete&quot;, ChannelHandlerContext.class)) {
                    mask &amp;= ~MASK_CHANNEL_READ_COMPLETE;
                }
                if (isSkippable(handlerType, &quot;channelWritabilityChanged&quot;, ChannelHandlerContext.class)) {
                    mask &amp;= ~MASK_CHANNEL_WRITABILITY_CHANGED;
                }
                if (isSkippable(handlerType, &quot;userEventTriggered&quot;, ChannelHandlerContext.class, Object.class)) {
                    mask &amp;= ~MASK_USER_EVENT_TRIGGERED;
                }
            }

            if (ChannelOutboundHandler.class.isAssignableFrom(handlerType)) {
                //å¦‚æœhandlerä¸ºOutboundç±»å‹çš„ï¼Œåˆ™å…ˆå°†å…¨éƒ¨outboundäº‹ä»¶è®¾ç½®è¿›æ©ç ä¸­
                mask |= MASK_ALL_OUTBOUND;

                //æœ€åå¯¹handlerä¸æ„Ÿå…´è¶£çš„äº‹ä»¶ä»æ©ç ä¸­ä¸€ä¸€æ’é™¤
                if (isSkippable(handlerType, &quot;bind&quot;, ChannelHandlerContext.class,
                        SocketAddress.class, ChannelPromise.class)) {
                    mask &amp;= ~MASK_BIND;
                }
                if (isSkippable(handlerType, &quot;connect&quot;, ChannelHandlerContext.class, SocketAddress.class,
                        SocketAddress.class, ChannelPromise.class)) {
                    mask &amp;= ~MASK_CONNECT;
                }
                if (isSkippable(handlerType, &quot;disconnect&quot;, ChannelHandlerContext.class, ChannelPromise.class)) {
                    mask &amp;= ~MASK_DISCONNECT;
                }
                if (isSkippable(handlerType, &quot;close&quot;, ChannelHandlerContext.class, ChannelPromise.class)) {
                    mask &amp;= ~MASK_CLOSE;
                }
                if (isSkippable(handlerType, &quot;deregister&quot;, ChannelHandlerContext.class, ChannelPromise.class)) {
                    mask &amp;= ~MASK_DEREGISTER;
                }
                if (isSkippable(handlerType, &quot;read&quot;, ChannelHandlerContext.class)) {
                    mask &amp;= ~MASK_READ;
                }
                if (isSkippable(handlerType, &quot;write&quot;, ChannelHandlerContext.class,
                        Object.class, ChannelPromise.class)) {
                    mask &amp;= ~MASK_WRITE;
                }
                if (isSkippable(handlerType, &quot;flush&quot;, ChannelHandlerContext.class)) {
                    mask &amp;= ~MASK_FLUSH;
                }
            }

            if (isSkippable(handlerType, &quot;exceptionCaught&quot;, ChannelHandlerContext.class, Throwable.class)) {
                mask &amp;= ~MASK_EXCEPTION_CAUGHT;
            }
        } catch (Exception e) {
            // Should never reach here.
            PlatformDependent.throwException(e);
        }

        //è®¡ç®—å‡ºçš„æ©ç éœ€è¦ç¼“å­˜ï¼Œå› ä¸ºæ¯æ¬¡å‘pipelineä¸­æ·»åŠ è¯¥ç±»å‹çš„handlerçš„æ—¶å€™éƒ½éœ€è¦è·å–æ©ç ï¼ˆåˆ›å»ºä¸€ä¸ªchannel å°±éœ€è¦ä¸ºå…¶åˆå§‹åŒ–pipelineï¼‰
        return mask;
    }
</code></pre></div><p>è®¡ç®— ChannelHandler çš„æ‰§è¡Œæ©ç  mask0 æ–¹æ³•è™½ç„¶æ¯”è¾ƒé•¿ï¼Œä½†æ˜¯é€»è¾‘å´ååˆ†ç®€å•ã€‚åœ¨æœ¬æ–‡çš„ç¬¬ä¸‰å°èŠ‚ã€Š3. pipelineä¸­çš„äº‹ä»¶åˆ†ç±»ã€‹ä¸­ï¼Œç¬”è€…ä¸ºå¤§å®¶è¯¦ç»†ä»‹ç»äº†å„ç§äº‹ä»¶ç±»å‹çš„æ©ç è¡¨ç¤ºï¼Œè¿™é‡Œæˆ‘æ¥çœ‹ä¸‹å¦‚ä½•åˆ©ç”¨è¿™äº›åŸºæœ¬äº‹ä»¶æ©ç æ¥è®¡ç®—å‡º ChannelHandler çš„æ‰§è¡Œæ©ç çš„ã€‚</p> <p>å¦‚æœ ChannelHandler æ˜¯ ChannelInboundHandler ç±»å‹çš„ï¼Œé‚£ä¹ˆé¦–å…ˆä¼šå°†æ‰€æœ‰ Inbound äº‹ä»¶æ©ç è®¾ç½®è¿›æ‰§è¡Œæ©ç  mask ä¸­ã€‚</p> <p>æœ€åæŒ¨ä¸ªéå†æ‰€æœ‰ Inbound äº‹ä»¶ï¼Œä»æ©ç é›†åˆ mask ä¸­æ’é™¤è¯¥ ChannelHandler ä¸æ„Ÿå…´è¶£çš„äº‹ä»¶ã€‚è¿™æ ·ä¸€è½®ä¸‹æ¥ï¼Œå°±å¾—åˆ°äº† ChannelHandler çš„æ‰§è¡Œæ©ç ã€‚</p> <blockquote><p>ä»è¿™ä¸ªè¿‡ç¨‹ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒChannelHandler çš„æ‰§è¡Œæ©ç åŒ…å«çš„æ˜¯è¯¥ ChannelHandler æ„Ÿå…´è¶£çš„äº‹ä»¶æ©ç é›†åˆã€‚å½“äº‹ä»¶åœ¨ pipeline ä¸­ä¼ æ’­çš„æ—¶å€™ï¼Œåœ¨ ChannelHandlerContext ä¸­å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ‰§è¡Œæ©ç æ¥åˆ¤æ–­ï¼Œå½“å‰ ChannelHandler æ˜¯å¦ç¬¦åˆå“åº”è¯¥äº‹ä»¶çš„èµ„æ ¼ã€‚</p></blockquote> <p>åŒç†æˆ‘ä»¬ä¹Ÿå¯ä»¥è®¡ç®—å‡º ChannelOutboundHandler ç±»å‹çš„ ChannelHandler å¯¹åº”çš„æ‰§è¡Œæ©ç ã€‚</p> <p><strong>é‚£ä¹ˆ netty æ¡†æ¶æ˜¯å¦‚ä½•åˆ¤æ–­å‡ºæˆ‘ä»¬è‡ªå®šä¹‰çš„ ChannelHandler å¯¹å“ªäº›äº‹ä»¶æ„Ÿå…´è¶£ï¼Œå¯¹å“ªäº›äº‹ä»¶ä¸æ„Ÿå…´è¶£çš„å‘¢</strong>?</p> <p>è¿™é‡Œæˆ‘ä»¬ä»¥ ChannelInboundHandler ç±»å‹ä¸¾ä¾‹è¯´æ˜ï¼Œåœ¨æœ¬æ–‡ç¬¬ä¸‰å°èŠ‚ä¸­ï¼Œç¬”è€…å¯¹æ‰€æœ‰ Inbound ç±»å‹çš„äº‹ä»¶ä½œäº†ä¸€ä¸ªå…¨é¢çš„ä»‹ç»ï¼Œä½†æ˜¯åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½å¹¶ä¸éœ€è¦ç›‘å¬æ‰€æœ‰çš„ Inbound äº‹ä»¶ï¼Œå¯èƒ½åªæ˜¯éœ€è¦ç›‘å¬å…¶ä¸­çš„ä¸€åˆ°ä¸¤ä¸ªäº‹ä»¶ã€‚</p> <p>å¯¹äºæˆ‘ä»¬ä¸æ„Ÿå…´è¶£çš„äº‹ä»¶ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨å…¶å¯¹åº”çš„å›è°ƒæ–¹æ³•ä¸Šæ ‡æ³¨ @Skip æ³¨è§£å³å¯ï¼Œnetty å°±ä¼šè®¤ä¸ºè¯¥ ChannelHandler å¯¹æ ‡æ³¨ @Skip æ³¨è§£çš„äº‹ä»¶ä¸æ„Ÿå…´è¶£ï¼Œå½“ä¸æ„Ÿå…´è¶£çš„äº‹ä»¶åœ¨ pipeline ä¼ æ’­çš„æ—¶å€™ï¼Œè¯¥ ChannelHandler å°±ä¸éœ€è¦æ‰§è¡Œå“åº”ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private static boolean isSkippable(
            final Class&lt;?&gt; handlerType, final String methodName, final Class&lt;?&gt;... paramTypes) throws Exception {
        return AccessController.doPrivileged(new PrivilegedExceptionAction&lt;Boolean&gt;() {
            @Override
            public Boolean run() throws Exception {
                Method m;
                try {
                    // é¦–å…ˆæŸ¥çœ‹ç±»ä¸­æ˜¯å¦è¦†ç›–å®ç°äº†å¯¹åº”çš„äº‹ä»¶å›è°ƒæ–¹æ³•
                    m = handlerType.getMethod(methodName, paramTypes);
                } catch (NoSuchMethodException e) {
                    if (logger.isDebugEnabled()) {
                        logger.debug(
                            &quot;Class {} missing method {}, assume we can not skip execution&quot;, handlerType, methodName, e);
                    }
                    return false;
                }
                return m != null &amp;&amp; m.isAnnotationPresent(Skip.class);
            }
        });
    }
</code></pre></div><p>é‚£æˆ‘ä»¬åœ¨ç¼–å†™è‡ªå®šä¹‰ ChannelHandler çš„æ—¶å€™æ˜¯ä¸æ˜¯è¦åœ¨ ChannelInboundHandler æˆ–è€… ChannelOutboundHandler æ¥å£æä¾›çš„æ‰€æœ‰äº‹ä»¶å›è°ƒæ–¹æ³•ä¸Šï¼Œå¯¹æˆ‘ä»¬ä¸æ„Ÿå…´è¶£çš„äº‹ä»¶ç¹çåœ°ä¸€ä¸€æ ‡æ³¨ @Skip æ³¨è§£å‘¢ï¼Ÿ</p> <p>å…¶å®æ˜¯ä¸éœ€è¦çš„ï¼Œnetty ä¸ºæˆ‘ä»¬æä¾›äº† ChannelInboundHandlerAdapter ç±»å’Œ ChannelOutboundHandlerAdapter ç±»ï¼Œnetty äº‹å…ˆå·²ç»åœ¨è¿™äº› Adapter ç±»ä¸­çš„äº‹ä»¶å›è°ƒæ–¹æ³•ä¸Šå…¨éƒ¨æ ‡æ³¨äº† @Skip æ³¨è§£ï¼Œæˆ‘ä»¬åœ¨è‡ªå®šä¹‰å®ç° ChannelHandler çš„æ—¶å€™åªéœ€è¦ç»§æ‰¿è¿™äº› Adapter ç±»å¹¶è¦†ç›–æˆ‘ä»¬æ„Ÿå…´è¶£çš„äº‹ä»¶å›è°ƒæ–¹æ³•å³å¯ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class ChannelInboundHandlerAdapter extends ChannelHandlerAdapter implements ChannelInboundHandler {

    @Skip
    @Override
    public void channelRegistered(ChannelHandlerContext ctx) throws Exception {
        ctx.fireChannelRegistered();
    }

    @Skip
    @Override
    public void channelUnregistered(ChannelHandlerContext ctx) throws Exception {
        ctx.fireChannelUnregistered();
    }

    @Skip
    @Override
    public void channelActive(ChannelHandlerContext ctx) throws Exception {
        ctx.fireChannelActive();
    }

    @Skip
    @Override
    public void channelInactive(ChannelHandlerContext ctx) throws Exception {
        ctx.fireChannelInactive();
    }

    @Skip
    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {
        ctx.fireChannelRead(msg);
    }

    @Skip
    @Override
    public void channelReadComplete(ChannelHandlerContext ctx) throws Exception {
        ctx.fireChannelReadComplete();
    }

    @Skip
    @Override
    public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception {
        ctx.fireUserEventTriggered(evt);
    }

    @Skip
    @Override
    public void channelWritabilityChanged(ChannelHandlerContext ctx) throws Exception {
        ctx.fireChannelWritabilityChanged();
    }

    @Skip
    @Override
    @SuppressWarnings(&quot;deprecation&quot;)
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause)
            throws Exception {
        ctx.fireExceptionCaught(cause);
    }
}
</code></pre></div><h2 id="_6-ä»-pipeline-åˆ é™¤-channelhandler"><a href="#_6-ä»-pipeline-åˆ é™¤-channelhandler" class="header-anchor">#</a> 6. ä» pipeline åˆ é™¤ channelHandler</h2> <p>ä»ä¸Šä¸ªå°èŠ‚çš„å†…å®¹ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å‘ pipeline ä¸­æ·»åŠ  ChannelHandler çš„é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œæ¶‰åŠåˆ°çš„ç»†èŠ‚æ¯”è¾ƒå¤šã€‚</p> <p>é‚£ä¹ˆåœ¨äº†è§£äº†å‘ pipeline ä¸­æ·»åŠ  ChannelHandler çš„è¿‡ç¨‹ä¹‹åï¼Œä» pipeline ä¸­åˆ é™¤ ChannelHandler çš„é€»è¾‘å°±å˜å¾—å¾ˆå¥½ç†è§£äº†ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public interface ChannelPipeline
        extends ChannelInboundInvoker, ChannelOutboundInvoker, Iterable&lt;Entry&lt;String, ChannelHandler&gt;&gt; {

    //ä»pipelineä¸­åˆ é™¤æŒ‡å®šçš„channelHandler
    ChannelPipeline remove(ChannelHandler handler);
    //ä»pipelineä¸­åˆ é™¤æŒ‡å®šåç§°çš„channelHandler
    ChannelHandler remove(String name);
    //ä»pipelineä¸­åˆ é™¤ç‰¹å®šç±»å‹çš„channelHandler
    &lt;T extends ChannelHandler&gt; T remove(Class&lt;T&gt; handlerType);
}
</code></pre></div><p>netty æä¾›äº†ä»¥ä¸Šä¸‰ç§æ–¹å¼ä» pipeline ä¸­åˆ é™¤æŒ‡å®š ChannelHandler ï¼Œä¸‹é¢æˆ‘ä»¬ä»¥ç¬¬ä¸€ç§æ–¹å¼ä¸ºä¾‹æ¥ä»‹ç» ChannelHandler çš„åˆ é™¤è¿‡ç¨‹ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class DefaultChannelPipeline implements ChannelPipeline {

    @Override
    public final ChannelPipeline remove(ChannelHandler handler) {
        remove(getContextOrDie(handler));
        return this;
    }

}
</code></pre></div><h3 id="_6-1-getcontextordie"><a href="#_6-1-getcontextordie" class="header-anchor">#</a> 6.1 getContextOrDie</h3> <p>é¦–å…ˆéœ€è¦é€šè¿‡ getContextOrDie æ–¹æ³•åœ¨ pipeline ä¸­æŸ¥æ‰¾åˆ°æŒ‡å®šçš„ ChannelHandler å¯¹åº”çš„ ChannelHandelrContext ã€‚ä»¥ä¾¿ç¡®è®¤è¦åˆ é™¤çš„ ChannelHandler ç¡®å®æ˜¯å­˜åœ¨äº pipeline ä¸­ã€‚</p> <p>context æ–¹æ³•æ˜¯é€šè¿‡éå† pipeline ä¸­çš„åŒå‘é“¾è¡¨æ¥æŸ¥æ‰¾è¦åˆ é™¤çš„ ChannelHandlerContext ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private AbstractChannelHandlerContext getContextOrDie(ChannelHandler handler) {
        AbstractChannelHandlerContext ctx = (AbstractChannelHandlerContext) context(handler);
        if (ctx == null) {
            throw new NoSuchElementException(handler.getClass().getName());
        } else {
            return ctx;
        }
    }

    @Override
    public final ChannelHandlerContext context(ChannelHandler handler) {
        ObjectUtil.checkNotNull(handler, &quot;handler&quot;);
        // è·å– pipeline åŒå‘é“¾è¡¨ç»“æ„çš„å¤´ç»“ç‚¹
        AbstractChannelHandlerContext ctx = head.next;
        for (;;) {

            if (ctx == null) {
                return null;
            }

            if (ctx.handler() == handler) {
                return ctx;
            }

            ctx = ctx.next;
        }
    }
</code></pre></div><h3 id="_6-2-remove"><a href="#_6-2-remove" class="header-anchor">#</a> 6.2 remove</h3> <p>remove æ–¹æ³•çš„æ•´ä½“ä»£ç ç»“æ„å’Œ addLast0 æ–¹æ³•çš„ä»£ç ç»“æ„ä¸€æ ·ï¼Œæ•´ä½“é€»è¾‘ä¹Ÿæ˜¯å…ˆä» pipeline ä¸­çš„åŒå‘é“¾è¡¨ç»“æ„ä¸­å°†æŒ‡å®šçš„ ChanneHandlerContext åˆ é™¤ï¼Œç„¶ååœ¨å¤„ç†è¢«åˆ é™¤çš„ ChannelHandler ä¸­ handlerRemoved æ–¹æ³•çš„å›è°ƒã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private AbstractChannelHandlerContext remove(final AbstractChannelHandlerContext ctx) {
        assert ctx != head &amp;&amp; ctx != tail;

        synchronized (this) {
            //ä»pipelineçš„åŒå‘åˆ—è¡¨ä¸­åˆ é™¤æŒ‡å®šchannelHandlerå¯¹åº”çš„context
            atomicRemoveFromHandlerList(ctx);

            if (!registered) {
                //å¦‚æœæ­¤æ—¶channelè¿˜æœªå‘reactoræ³¨å†Œï¼Œåˆ™é€šè¿‡å‘pipelineä¸­æ·»åŠ PendingHandlerRemovedTaskä»»åŠ¡
                //åœ¨æ³¨å†Œä¹‹åå›è°ƒchannelHandelrä¸­çš„handlerRemovedæ–¹æ³•
                callHandlerCallbackLater(ctx, false);
                return ctx;
            }

            //channelHandelrä»pipelineä¸­åˆ é™¤åï¼Œéœ€è¦å›è°ƒå…¶handlerRemovedæ–¹æ³•
            //éœ€è¦ç¡®ä¿handlerRemovedæ–¹æ³•åœ¨channelHandelræŒ‡å®šçš„executorä¸­è¿›è¡Œ
            EventExecutor executor = ctx.executor();
            if (!executor.inEventLoop()) {
                executor.execute(new Runnable() {
                    @Override
                    public void run() {
                        callHandlerRemoved0(ctx);
                    }
                });
                return ctx;
            }
        }
        callHandlerRemoved0(ctx);
        return ctx;
    }
</code></pre></div><ol><li>ä» pipeline ä¸­åˆ é™¤æŒ‡å®š ChannelHandler å¯¹åº”çš„ ChannelHandlerContext ã€‚é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯æ™®é€šåŒå‘é“¾è¡¨çš„åˆ é™¤æ“ä½œã€‚</li></ol> <div class="language- extra-class"><pre class="language-text"><code>    private synchronized void atomicRemoveFromHandlerList(AbstractChannelHandlerContext ctx) {
        AbstractChannelHandlerContext prev = ctx.prev;
        AbstractChannelHandlerContext next = ctx.next;
        prev.next = next;
        next.prev = prev;
    }
</code></pre></div><ol><li>å¦‚æœæ­¤æ—¶ channel å¹¶æœªå‘å¯¹åº”çš„ reactor è¿›è¡Œæ³¨å†Œï¼Œåˆ™éœ€è¦å‘ pipeline çš„ä»»åŠ¡åˆ—è¡¨ä¸­æ·»åŠ  PendingHandlerRemovedTask ä»»åŠ¡ï¼Œå†è¯¥ä»»åŠ¡ä¸­ä¼šæ‰§è¡Œ ChannelHandler çš„ handlerRemoved å›è°ƒï¼Œå½“ channel å‘ reactor æ³¨å†ŒæˆåŠŸåï¼Œreactor ä¼šæ‰§è¡Œ pipeline ä¸­ä»»åŠ¡åˆ—è¡¨ä¸­çš„ä»»åŠ¡ï¼Œä»è€Œå›è°ƒè¢«åˆ é™¤ ChannelHandler çš„ handlerRemoved æ–¹æ³•ã€‚</li></ol> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)pipelineä»»åŠ¡.png</p> <div class="language- extra-class"><pre class="language-text"><code>    private final class PendingHandlerRemovedTask extends PendingHandlerCallback {

        PendingHandlerRemovedTask(AbstractChannelHandlerContext ctx) {
            super(ctx);
        }

        @Override
        public void run() {
            callHandlerRemoved0(ctx);
        }
    }
</code></pre></div><p>åœ¨æ‰§è¡Œ ChannelHandler ä¸­ handlerRemoved å›è°ƒçš„æ—¶å€™ï¼Œéœ€è¦å¯¹ ChannelHandler çš„çŠ¶æ€è¿›è¡Œåˆ¤æ–­ï¼šåªæœ‰å½“ handlerState ä¸º ADD_COMPLETE çš„æ—¶å€™æ‰èƒ½å›è°ƒ handlerRemoved æ–¹æ³•ã€‚</p> <blockquote><p>è¿™é‡Œè¡¨è¾¾çš„è¯­ä¹‰æ˜¯åªæœ‰å½“ ChannelHanler çš„ handlerAdded æ–¹æ³•è¢«å›è°ƒä¹‹åï¼Œé‚£ä¹ˆåœ¨ ChannelHanler è¢«ä» pipeline ä¸­åˆ é™¤çš„æ—¶å€™å®ƒçš„ handlerRemoved æ–¹æ³•æ‰å¯ä»¥è¢«å›è°ƒã€‚</p></blockquote> <p>åœ¨ ChannelHandler çš„ handlerRemove æ–¹æ³•è¢«å›è°ƒä¹‹åï¼Œå°† ChannelHandler çš„çŠ¶æ€è®¾ç½®ä¸º REMOVE_COMPLETE ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private void callHandlerRemoved0(final AbstractChannelHandlerContext ctx) {

        try {
            // åœ¨è¿™é‡Œå›è°ƒ handlerRemoved æ–¹æ³•
            ctx.callHandlerRemoved();
        } catch (Throwable t) {
            fireExceptionCaught(new ChannelPipelineException(
                    ctx.handler().getClass().getName() + &quot;.handlerRemoved() has thrown an exception.&quot;, t));
        }
    }

    final void callHandlerRemoved() throws Exception {
        try {
            if (handlerState == ADD_COMPLETE) {
                handler().handlerRemoved(this);
            }
        } finally {
            // Mark the handler as removed in any case.
            setRemoved();
        }
    }

   final void setRemoved() {
        handlerState = REMOVE_COMPLETE;
    }
</code></pre></div><ol><li>å¦‚æœ channel å·²ç»åœ¨ reactor ä¸­æ³¨å†ŒæˆåŠŸï¼Œé‚£ä¹ˆå½“ channelHandler ä» pipeline ä¸­åˆ é™¤ä¹‹åï¼Œéœ€è¦ç«‹å³å›è°ƒå…¶ handlerRemoved æ–¹æ³•ã€‚ä½†æ˜¯éœ€è¦ç¡®ä¿ handlerRemoved æ–¹æ³•åœ¨ channelHandler æŒ‡å®šçš„ executor ä¸­è¿›è¡Œã€‚</li></ol> <h2 id="_7-pipeline-çš„åˆå§‹åŒ–"><a href="#_7-pipeline-çš„åˆå§‹åŒ–" class="header-anchor">#</a> 7. pipeline çš„åˆå§‹åŒ–</h2> <p>å…¶å®å…³äº pipeline åˆå§‹åŒ–çš„ç›¸å…³å†…å®¹æˆ‘ä»¬åœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484005&amp;idx=1&amp;sn=52f51269902a58f40d33208421109bc3&amp;chksm=ce77c422f9004d340e5b385ef6ba24dfba1f802076ace80ad6390e934173a10401e64e13eaeb&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">ã€Šè¯¦ç»†å›¾è§£ Netty Reactor å¯åŠ¨å…¨æµç¨‹ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸­å·²ç»ç®€è¦ä»‹ç»äº† NioServerSocketChannel ä¸­çš„ pipeline çš„åˆå§‹åŒ–æ—¶æœºä»¥åŠè¿‡ç¨‹ã€‚</p> <p>åœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484184&amp;idx=1&amp;sn=726877ce28cf6e5d2ac3225fae687f19&amp;chksm=ce77c55ff9004c493b592288819dc4d4664b5949ee97fed977b6558bc517dad0e1f73fab0f46&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">ã€ŠNetty å¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œè¿æ¥ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸­ç¬”è€…ä¹Ÿç®€è¦ä»‹ç»äº† NioSocketChannel ä¸­ pipeline çš„åˆå§‹åŒ–æ—¶æœºä»¥åŠè¿‡ç¨‹ã€‚</p> <p>æœ¬å°èŠ‚ç¬”è€…å°†ç»“åˆè¿™ä¸¤ç§ç±»å‹çš„ Channel æ¥å®Œæ•´å…¨é¢çš„ä»‹ç» pipeline çš„æ•´ä¸ªåˆå§‹åŒ–è¿‡ç¨‹ã€‚</p> <h3 id="_7-1-nioserversocketchannel-ä¸­-pipeline-çš„åˆå§‹åŒ–"><a href="#_7-1-nioserversocketchannel-ä¸­-pipeline-çš„åˆå§‹åŒ–" class="header-anchor">#</a> 7.1 NioServerSocketChannel ä¸­ pipeline çš„åˆå§‹åŒ–</h3> <p>ä»å‰è¾¹æåˆ°çš„è¿™ä¸¤ç¯‡æ–‡ç« ä»¥åŠæœ¬æ–‡å‰è¾¹çš„ç›¸å…³å†…å®¹æˆ‘ä»¬çŸ¥é“ï¼ŒNetty æä¾›äº†ä¸€ä¸ªç‰¹æ®Šçš„ ChannelInboundHandler å«åš ChannelInitializer ï¼Œç”¨æˆ·å¯ä»¥åˆ©ç”¨è¿™ä¸ªç‰¹æ®Šçš„ ChannelHandler å¯¹ Channel ä¸­çš„ pipeline è¿›è¡Œè‡ªå®šä¹‰çš„åˆå§‹åŒ–é€»è¾‘ã€‚</p> <p>å¦‚æœç”¨æˆ·åªå¸Œæœ›åœ¨ pipeline ä¸­æ·»åŠ ä¸€ä¸ªå›ºå®šçš„ ChannelHandler å¯ä»¥é€šè¿‡å¦‚ä¸‹ä»£ç ç›´æ¥æ·»åŠ ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>            ServerBootstrap b = new ServerBootstrap();
            b.group(bossGroup, workerGroup)//é…ç½®ä¸»ä»Reactor
                  ...........
             .handler(new LoggingHandler(LogLevel.INFO))
</code></pre></div><p>å¦‚æœå¸Œæœ›æ·»åŠ å¤šä¸ª ChannelHandler ï¼Œåˆ™å¯ä»¥é€šè¿‡ ChannelInitializer æ¥è‡ªå®šä¹‰æ·»åŠ é€»è¾‘ã€‚</p> <blockquote><p>ç”±äºä½¿ç”¨ ChannelInitializer åˆå§‹åŒ– NioServerSocketChannel ä¸­ pipeline çš„é€»è¾‘ä¼šç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œä¸‹é¢æˆ‘ä»¬å‡ä»¥è¿™ä¸ªå¤æ‚çš„æ¡ˆä¾‹æ¥è®²è¿° pipeline çš„åˆå§‹åŒ–è¿‡ç¨‹ã€‚</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>            ServerBootstrap b = new ServerBootstrap();
            b.group(bossGroup, workerGroup)//é…ç½®ä¸»ä»Reactor
                  ...........
               .handler(new ChannelInitializer&lt;NioServerSocketChannel&gt;() {
                 @Override
                 protected void initChannel(NioServerSocketChannel ch) throws Exception {
                              ....è‡ªå®šä¹‰pipelineåˆå§‹åŒ–é€»è¾‘....
                               ChannelPipeline p = ch.pipeline();
                               p.addLast(channelHandler1);
                               p.addLast(channelHandler2);
                               p.addLast(channelHandler3);
                                    ........
                 }
             })
</code></pre></div><p>ä»¥ä¸Šè¿™äº›ç”±ç”¨æˆ·è‡ªå®šä¹‰çš„ç”¨äºåˆå§‹åŒ– pipeline çš„ ChannelInitializer ï¼Œè¢«ä¿å­˜è‡³ ServerBootstrap å¯åŠ¨ç±»ä¸­çš„ handler å­—æ®µä¸­ã€‚ç”¨äºåç»­çš„åˆå§‹åŒ–è°ƒç”¨</p> <div class="language- extra-class"><pre class="language-text"><code>public abstract class AbstractBootstrap&lt;B extends AbstractBootstrap&lt;B, C&gt;, C extends Channel&gt; implements Cloneable
   private volatile ChannelHandler handler;
}
</code></pre></div><p>åœ¨æœåŠ¡ç«¯å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šä¼´éšç€ NioServeSocketChannel çš„åˆ›å»ºä»¥åŠåˆå§‹åŒ–ï¼Œåœ¨åˆå§‹åŒ– NioServerSokcetChannel çš„æ—¶å€™ä¼šå°†ä¸€ä¸ªæ–°çš„ ChannelInitializer æ·»åŠ è¿› pipeline ä¸­ï¼Œåœ¨æ–°çš„ ChannelInitializer ä¸­æ‰ä¼šå°†ç”¨æˆ·è‡ªå®šä¹‰çš„ ChannelInitializer æ·»åŠ è¿› pipeline ä¸­ï¼Œéšåæ‰æ‰§è¡Œåˆå§‹åŒ–è¿‡ç¨‹ã€‚</p> <p>Netty è¿™é‡Œä¹‹æ‰€ä»¥å¼•å…¥ä¸€ä¸ªæ–°çš„ ChannelInitializer æ¥åˆå§‹åŒ– NioServerSocketChannel ä¸­çš„ pipeline çš„åŸå› æ˜¯éœ€è¦å…¼å®¹å‰è¾¹ä»‹ç»çš„è¿™ä¸¤ç§åˆå§‹åŒ– pipeline çš„æ–¹å¼ã€‚</p> <ul><li>ä¸€ç§æ˜¯ç›´æ¥ä½¿ç”¨ä¸€ä¸ªå…·ä½“çš„ ChannelHandler æ¥åˆå§‹åŒ– pipelineã€‚</li> <li>å¦ä¸€ç§æ˜¯ä½¿ç”¨ ChannelInitializer æ¥è‡ªå®šä¹‰åˆå§‹åŒ– pipeline é€»è¾‘ã€‚</li></ul> <blockquote><p>å¿˜è®° netty å¯åŠ¨è¿‡ç¨‹çš„åŒå­¦å¯ä»¥åœ¨å›çœ‹ä¸‹ç¬”è€…çš„<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484005&amp;idx=1&amp;sn=52f51269902a58f40d33208421109bc3&amp;chksm=ce77c422f9004d340e5b385ef6ba24dfba1f802076ace80ad6390e934173a10401e64e13eaeb&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">ã€Šè¯¦ç»†å›¾è§£ Netty Reactor å¯åŠ¨å…¨æµç¨‹ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>è¿™ç¯‡æ–‡ç« ã€‚</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>   @Override
    void init(Channel channel) {
       .........

        p.addLast(new ChannelInitializer&lt;Channel&gt;() {
            @Override
            public void initChannel(final Channel ch) {
                final ChannelPipeline pipeline = ch.pipeline();
                //ServerBootstrapä¸­ç”¨æˆ·æŒ‡å®šçš„channelHandler
                ChannelHandler handler = config.handler();
                if (handler != null) {
                    pipeline.addLast(handler);
                }

                .........
            }
        });
   }
</code></pre></div><p><strong>æ³¨æ„æ­¤æ—¶ NioServerSocketChannel å¹¶æœªå¼€å§‹å‘ Main Reactor æ³¨å†Œ</strong>ï¼Œæ ¹æ®æœ¬æ–‡ç¬¬å››å°èŠ‚ã€Š4. å‘ pipeline æ·»åŠ  channelHandler ã€‹ä¸­çš„ä»‹ç»ï¼Œæ­¤æ—¶å‘ pipeline ä¸­æ·»åŠ è¿™ä¸ªæ–°çš„ ChannelInitializer ä¹‹åï¼Œnetty ä¼šå‘ pipeline çš„ä»»åŠ¡åˆ—è¡¨ä¸­æ·»åŠ  PendingHandlerAddedTask ã€‚å½“ NioServerSocketChannel å‘ Main Reactor æ³¨å†ŒæˆåŠŸä¹‹åï¼Œç´§æ¥ç€ Main Reactor çº¿ç¨‹ä¼šè°ƒç”¨è¿™ä¸ª PendingHandlerAddedTask ï¼Œåœ¨ä»»åŠ¡ä¸­ä¼šæ‰§è¡Œè¿™ä¸ªæ–°çš„ ChannelInitializer çš„ handlerAdded å›è°ƒã€‚åœ¨è¿™ä¸ªå›è°ƒæ–¹æ³•ä¸­ä¼šæ‰§è¡Œä¸Šè¾¹ initChannel æ–¹æ³•é‡Œçš„ä»£ç ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)server channel pipeline æ³¨å†Œå‰ç»“æ„.png</p> <p>å½“ NioServerSocketChannel åœ¨å‘ Main Reactor æ³¨å†ŒæˆåŠŸä¹‹åï¼Œå°±æŒ¨ä¸ªæ‰§è¡Œ pipeline ä¸­çš„ä»»åŠ¡åˆ—è¡¨ä¸­çš„ä»»åŠ¡ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>       private void register0(ChannelPromise promise) {
                     .........
                boolean firstRegistration = neverRegistered;
                //æ‰§è¡ŒçœŸæ­£çš„æ³¨å†Œæ“ä½œ
                doRegister();
                //ä¿®æ”¹æ³¨å†ŒçŠ¶æ€
                neverRegistered = false;
                registered = true;
                //è°ƒç”¨pipelineä¸­çš„ä»»åŠ¡é“¾è¡¨ï¼Œæ‰§è¡ŒPendingHandlerAddedTask
                pipeline.invokeHandlerAddedIfNeeded();
                .........
    final void invokeHandlerAddedIfNeeded() {
        assert channel.eventLoop().inEventLoop();
        if (firstRegistration) {
            firstRegistration = false;
            // æ‰§è¡Œ pipeline ä»»åŠ¡åˆ—è¡¨ä¸­çš„ PendingHandlerAddedTask ä»»åŠ¡ã€‚
            callHandlerAddedForAllHandlers();
        }
    }
</code></pre></div><p>æ‰§è¡Œ pipeline ä»»åŠ¡åˆ—è¡¨ä¸­çš„ PendingHandlerAddedTask ä»»åŠ¡ï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>    private void callHandlerAddedForAllHandlers() {
        // pipeline ä»»åŠ¡åˆ—è¡¨ä¸­çš„å¤´ç»“ç‚¹
        final PendingHandlerCallback pendingHandlerCallbackHead;
        synchronized (this) {
            assert !registered;
            // This Channel itself was registered.
            registered = true;
            pendingHandlerCallbackHead = this.pendingHandlerCallbackHead;
            // Null out so it can be GC'ed.
            this.pendingHandlerCallbackHead = null;
        }

        PendingHandlerCallback task = pendingHandlerCallbackHead;
        // æŒ¨ä¸ªæ‰§è¡Œä»»åŠ¡åˆ—è¡¨ä¸­çš„ä»»åŠ¡
        while (task != null) {
            //è§¦å‘ ChannelInitializer çš„ handlerAdded å›è°ƒ
            task.execute();
            task = task.next;
        }
    }
</code></pre></div><p>æœ€ç»ˆåœ¨ PendingHandlerAddedTask ä¸­æ‰§è¡Œ pipeline ä¸­ ChannelInitializer çš„ handlerAdded å›è°ƒã€‚</p> <blockquote><p>è¿™ä¸ª ChannelInitializer å°±æ˜¯åœ¨åˆå§‹åŒ– NioServerSocketChannel çš„ init æ–¹æ³•ä¸­å‘ pipeline æ·»åŠ çš„ ChannelInitializerã€‚</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>@Sharable
public abstract class ChannelInitializer&lt;C extends Channel&gt; extends ChannelInboundHandlerAdapter {

    @Override
    public void handlerAdded(ChannelHandlerContext ctx) throws Exception {
        if (ctx.channel().isRegistered()) {

            if (initChannel(ctx)) {
                //åˆå§‹åŒ–å·¥ä½œå®Œæˆåï¼Œéœ€è¦å°†è‡ªèº«ä»pipelineä¸­ç§»é™¤
                removeState(ctx);
            }
        }
    }

}
</code></pre></div><p>åœ¨ handelrAdded å›è°ƒä¸­æ‰§è¡Œ ChannelInitializer åŒ¿åç±»ä¸­ initChannel æ–¹æ³•ï¼Œ<strong>æ³¨æ„æ­¤æ—¶æ‰§è¡Œçš„ ChannelInitializer ç±»ä¸ºåœ¨æœ¬å°èŠ‚å¼€å¤´ init æ–¹æ³•ä¸­ç”± Netty æ¡†æ¶æ·»åŠ çš„ ChannelInitializer ï¼Œå¹¶ä¸æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„ ChannelInitializer ã€‚</strong></p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    void init(Channel channel) {
       .........

        p.addLast(new ChannelInitializer&lt;Channel&gt;() {
            @Override
            public void initChannel(final Channel ch) {
                final ChannelPipeline pipeline = ch.pipeline();
                //ServerBootstrapä¸­ç”¨æˆ·æŒ‡å®šçš„ChannelInitializer
                ChannelHandler handler = config.handler();
                if (handler != null) {
                    pipeline.addLast(handler);
                }

                .........
            }
        });
   }
</code></pre></div><p>æ‰§è¡Œå®Œ ChannelInitializer åŒ¿åç±»ä¸­ initChannel æ–¹æ³•åï¼Œéœ€å°† ChannelInitializer ä» pipeline ä¸­åˆ é™¤ã€‚å¹¶å›è°ƒ ChannelInitializer çš„ handlerRemoved æ–¹æ³•ã€‚åˆ é™¤è¿‡ç¨‹ç¬”è€…å·²ç»åœ¨ç¬¬å…­å°èŠ‚ã€Š6. ä» pipeline åˆ é™¤ channelHandlerã€‹è¯¦ç»†ä»‹ç»è¿‡äº†ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private boolean initChannel(ChannelHandlerContext ctx) throws Exception {
        if (initMap.add(ctx)) { // Guard against re-entrance.
            try {
                //æ‰§è¡ŒChannelInitializeråŒ¿åç±»ä¸­çš„initChannelæ–¹æ³•
                initChannel((C) ctx.channel());
            } catch (Throwable cause) {
                exceptionCaught(ctx, cause);
            } finally {
                ChannelPipeline pipeline = ctx.pipeline();
                if (pipeline.context(this) != null) {
                    //åˆå§‹åŒ–å®Œæ¯•åï¼Œä»pipelineä¸­ç§»é™¤è‡ªèº«
                    pipeline.remove(this);
                }
            }
            return true;
        }
        return false;
    }
</code></pre></div><p>å½“æ‰§è¡Œå®Œ initChannel æ–¹æ³•åæ­¤æ—¶ pipeline çš„ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191115923.webp" alt="å›¾ç‰‡">serverSocketChannelæ³¨å†Œä¹‹åpipelineç»“æ„.png</p> <p>å½“ç”¨æˆ·çš„è‡ªå®šä¹‰ ChannelInitializer è¢«æ·»åŠ è¿› pipeline ä¹‹åï¼Œæ ¹æ®ç¬¬å››å°èŠ‚æ‰€è®²çš„æ·»åŠ é€»è¾‘ï¼Œæ­¤æ—¶ NioServerSocketChannel å·²ç»å‘ main reactor æˆåŠŸæ³¨å†Œå®Œæ¯•ï¼Œä¸å†éœ€è¦å‘ pipeine çš„ä»»åŠ¡åˆ—è¡¨ä¸­æ·»åŠ  PendingHandlerAddedTask ä»»åŠ¡ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨è‡ªå®šä¹‰ ChannelInitializer ä¸­çš„ handlerAdded å›è°ƒï¼Œå’Œä¸Šé¢çš„é€»è¾‘ä¸€æ ·ã€‚ä¸åŒçš„æ˜¯è¿™é‡Œæœ€ç»ˆå›è°ƒè‡³ç”¨æˆ·è‡ªå®šä¹‰çš„åˆå§‹åŒ–é€»è¾‘å®ç° initChannel æ–¹æ³•ä¸­ã€‚æ‰§è¡Œå®Œç”¨æˆ·è‡ªå®šä¹‰çš„åˆå§‹åŒ–é€»è¾‘ä¹‹åï¼Œä» pipeline åˆ é™¤ç”¨æˆ·è‡ªå®šä¹‰çš„ ChannelInitializer ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>            ServerBootstrap b = new ServerBootstrap();
            b.group(bossGroup, workerGroup)//é…ç½®ä¸»ä»Reactor
                  ...........
               .handler(new ChannelInitializer&lt;NioServerSocketChannel&gt;() {
                 @Override
                 protected void initChannel(NioServerSocketChannel ch) throws Exception {
                              ....è‡ªå®šä¹‰pipelineåˆå§‹åŒ–é€»è¾‘....
                               ChannelPipeline p = ch.pipeline();
                               p.addLast(channelHandler1);
                               p.addLast(channelHandler2);
                               p.addLast(channelHandler3);
                                    ........
                 }
             })
</code></pre></div><p>éšå netty ä¼šä»¥å¼‚æ­¥ä»»åŠ¡çš„å½¢å¼å‘ pipeline çš„æœ«å°¾æ·»åŠ  ServerBootstrapAcceptor ï¼Œè‡³æ­¤ NioServerSocketChannel ä¸­ pipeline çš„åˆå§‹åŒ–å·¥ä½œå°±å…¨éƒ¨å®Œæˆäº†ã€‚</p> <h3 id="_7-2-niosocketchannel-ä¸­-pipeline-çš„åˆå§‹åŒ–"><a href="#_7-2-niosocketchannel-ä¸­-pipeline-çš„åˆå§‹åŒ–" class="header-anchor">#</a> 7.2 NioSocketChannel ä¸­ pipeline çš„åˆå§‹åŒ–</h3> <p>åœ¨ 7.1 å°èŠ‚ä¸­ç¬”è€…ä¸¾çš„è¿™ä¸ª pipeline åˆå§‹åŒ–çš„ä¾‹å­ç›¸å¯¹æ¥è¯´æ¯”è¾ƒå¤æ‚ï¼Œå½“æˆ‘ä»¬æŠŠè¿™ä¸ªå¤æ‚ä¾‹å­çš„åˆå§‹åŒ–é€»è¾‘ææ¸…æ¥šä¹‹åï¼ŒNioSocketChannel ä¸­ pipeline çš„åˆå§‹åŒ–è¿‡ç¨‹å°±å˜çš„å¾ˆç®€å•äº†ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>            ServerBootstrap b = new ServerBootstrap();
            b.group(bossGroup, workerGroup)//é…ç½®ä¸»ä»Reactor
                  ...........
               .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() {
                 @Override
                 protected void initChannel(SocketChannel ch) throws Exception {
                              ....è‡ªå®šä¹‰pipelineåˆå§‹åŒ–é€»è¾‘....
                               ChannelPipeline p = ch.pipeline();
                               p.addLast(channelHandler1);
                               p.addLast(channelHandler2);
                               p.addLast(channelHandler3);
                                    ........
                 }
             })
public class ServerBootstrap extends AbstractBootstrap&lt;ServerBootstrap, ServerChannel&gt; {
    //ä¿å­˜ç”¨æˆ·è‡ªå®šä¹‰ChannelInitializer
    private volatile ChannelHandler childHandler;
}
</code></pre></div><p>åœ¨<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484184&amp;idx=1&amp;sn=726877ce28cf6e5d2ac3225fae687f19&amp;chksm=ce77c55ff9004c493b592288819dc4d4664b5949ee97fed977b6558bc517dad0e1f73fab0f46&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">ã€ŠNetty å¦‚ä½•é«˜æ•ˆæ¥æ”¶ç½‘ç»œè¿æ¥ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸€æ–‡ä¸­æˆ‘ä»¬ä»‹ç»è¿‡ï¼Œå½“å®¢æˆ·ç«¯å‘èµ·è¿æ¥ï¼Œå®Œæˆä¸‰æ¬¡æ¡æ‰‹ä¹‹åï¼ŒNioServerSocketChannel ä¸Šçš„ OP_ACCEPT äº‹ä»¶æ´»è·ƒï¼Œéšåä¼šåœ¨ NioServerSocketChannel çš„ pipeline ä¸­è§¦å‘ channelRead äº‹ä»¶ã€‚å¹¶æœ€ç»ˆåœ¨ ServerBootstrapAcceptor ä¸­åˆå§‹åŒ–å®¢æˆ·ç«¯ NioSocketChannel ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191115136.webp" alt="å›¾ç‰‡">ä¸»ä»Reactorç»„å®Œæ•´ç»“æ„.png</p> <div class="language- extra-class"><pre class="language-text"><code>private static class ServerBootstrapAcceptor extends ChannelInboundHandlerAdapter {

       @Override
        @SuppressWarnings(&quot;unchecked&quot;)
        public void channelRead(ChannelHandlerContext ctx, Object msg) {
            final Channel child = (Channel) msg;
            child.pipeline().addLast(childHandler);
                    ...........
       }
}
</code></pre></div><p>åœ¨è¿™é‡Œä¼šå°†ç”¨æˆ·è‡ªå®šä¹‰çš„ ChannelInitializer æ·»åŠ è¿› NioSocketChannel ä¸­çš„ pipeline ä¸­ï¼Œç”±äºæ­¤æ—¶ NioSocketChannel è¿˜æ²¡æœ‰å‘ sub reactor å¼€å§‹æ³¨å†Œã€‚æ‰€ä»¥åœ¨å‘ pipeline ä¸­æ·»åŠ  ChannelInitializer çš„åŒæ—¶ä¼šä¼´éšç€ PendingHandlerAddedTask è¢«æ·»åŠ è¿› pipeline çš„ä»»åŠ¡åˆ—è¡¨ä¸­ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)niosocketchannelä¸­pipelineçš„åˆå§‹åŒ–.png</p> <p>åé¢çš„æµç¨‹å¤§å®¶åº”è¯¥å¾ˆç†Ÿæ‚‰äº†ï¼Œå’Œæˆ‘ä»¬åœ¨7.1å°èŠ‚ä¸­ä»‹ç»çš„ä¸€æ¨¡ä¸€æ ·ï¼Œå½“ NioSocketChannel å†å‘ sub reactor æ³¨å†ŒæˆåŠŸä¹‹åï¼Œä¼šæ‰§è¡Œ pipeline ä¸­çš„ä»»åŠ¡åˆ—è¡¨ä¸­çš„ PendingHandlerAddedTask ä»»åŠ¡ï¼Œåœ¨ PendingHandlerAddedTask ä»»åŠ¡ä¸­ä¼šå›è°ƒç”¨æˆ·è‡ªå®šä¹‰ ChannelInitializer çš„ handelrAdded æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­æ‰§è¡Œ initChannel æ–¹æ³•ï¼Œç”¨æˆ·è‡ªå®šä¹‰çš„åˆå§‹åŒ–é€»è¾‘å°±å°è£…åœ¨è¿™é‡Œé¢ã€‚åœ¨åˆå§‹åŒ–å®Œ pipeline åï¼Œå°† ChannelInitializer ä» pipeline ä¸­åˆ é™¤ï¼Œå¹¶å›è°ƒå…¶ handlerRemoved æ–¹æ³•ã€‚</p> <p>è‡³æ­¤å®¢æˆ·ç«¯ NioSocketChannel ä¸­ pipeline åˆå§‹åŒ–å·¥ä½œå°±å…¨éƒ¨å®Œæˆäº†ã€‚</p> <h2 id="_8-äº‹ä»¶ä¼ æ’­"><a href="#_8-äº‹ä»¶ä¼ æ’­" class="header-anchor">#</a> 8. äº‹ä»¶ä¼ æ’­</h2> <p>åœ¨æœ¬æ–‡ç¬¬ä¸‰å°èŠ‚ã€Š3. pipelineä¸­çš„äº‹ä»¶åˆ†ç±»ã€‹ä¸­æˆ‘ä»¬ä»‹ç»äº† Netty äº‹ä»¶ç±»å‹å…±åˆ†ä¸ºä¸‰å¤§ç±»ï¼Œåˆ†åˆ«æ˜¯ Inboundç±»äº‹ä»¶ï¼ŒOutboundç±»äº‹ä»¶ï¼ŒExceptionCaughtäº‹ä»¶ã€‚å¹¶è¯¦ç»†ä»‹ç»äº†è¿™ä¸‰ç±»äº‹ä»¶çš„æ©ç è¡¨ç¤ºï¼Œå’Œè§¦å‘æ—¶æœºï¼Œä»¥åŠäº‹ä»¶ä¼ æ’­çš„æ–¹å‘ã€‚</p> <p>æœ¬å°èŠ‚æˆ‘ä»¬å°±æ¥æŒ‰ç…§ Netty ä¸­å¼‚æ­¥äº‹ä»¶çš„åˆ†ç±»ä»æºç è§’åº¦åˆ†æä¸‹äº‹ä»¶æ˜¯å¦‚ä½•åœ¨ pipeline ä¸­è¿›è¡Œä¼ æ’­çš„ã€‚</p> <h3 id="_8-1-inboundäº‹ä»¶çš„ä¼ æ’­"><a href="#_8-1-inboundäº‹ä»¶çš„ä¼ æ’­" class="header-anchor">#</a> 8.1 Inboundäº‹ä»¶çš„ä¼ æ’­</h3> <p>åœ¨ç¬¬ä¸‰å°èŠ‚ä¸­æˆ‘ä»¬ä»‹ç»äº†æ‰€æœ‰çš„ Inbound ç±»äº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶åœ¨ pipeline ä¸­çš„ä¼ æ’­é€»è¾‘å’Œä¼ æ’­æ–¹å‘éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯æ‰§è¡Œçš„å›è°ƒæ–¹æ³•ä¸åŒã€‚</p> <p>æœ¬å°èŠ‚æˆ‘ä»¬å°±ä»¥ ChannelRead äº‹ä»¶çš„ä¼ æ’­ä¸ºä¾‹ï¼Œæ¥è¯´æ˜ Inbound ç±»äº‹ä»¶æ˜¯å¦‚ä½•åœ¨ pipeline ä¸­è¿›è¡Œä¼ æ’­çš„ã€‚</p> <p>ç¬¬ä¸‰å°èŠ‚ä¸­æˆ‘ä»¬æåˆ°è¿‡ï¼Œåœ¨ NioSocketChannel ä¸­ï¼ŒChannelRead äº‹ä»¶çš„è§¦å‘æ—¶æœºæ˜¯åœ¨æ¯ä¸€æ¬¡ read loop è¯»å–æ•°æ®ä¹‹ååœ¨ pipeline ä¸­è§¦å‘çš„ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>               do {
                          ............               
                    allocHandle.lastBytesRead(doReadBytes(byteBuf));

                          ............
       
                    // åœ¨å®¢æˆ·ç«¯NioSocketChannelçš„pipelineä¸­è§¦å‘ChannelReadäº‹ä»¶
                    pipeline.fireChannelRead(byteBuf);
  
                } while (allocHandle.continueReading());
</code></pre></div><p>ä»è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œä»»ä½• Inbound ç±»äº‹ä»¶åœ¨ pipeline ä¸­çš„ä¼ æ’­èµ·ç‚¹éƒ½æ˜¯ä» HeadContext å¤´ç»“ç‚¹å¼€å§‹çš„ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class DefaultChannelPipeline implements ChannelPipeline {

    @Override
    public final ChannelPipeline fireChannelRead(Object msg) {
        AbstractChannelHandlerContext.invokeChannelRead(head, msg);
        return this;
    }
    
                    .........
}
</code></pre></div><p>ChannelRead äº‹ä»¶ä» HeadContext å¼€å§‹åœ¨ pipeline ä¸­ä¼ æ’­ï¼Œé¦–å…ˆå°±ä¼šå›è°ƒ HeadContext ä¸­çš„ channelRead æ–¹æ³•ã€‚</p> <blockquote><p>åœ¨æ‰§è¡Œ ChannelHandler ä¸­çš„ç›¸åº”äº‹ä»¶å›è°ƒæ–¹æ³•æ—¶ï¼Œéœ€è¦ç¡®ä¿å›è°ƒæ–¹æ³•çš„æ‰§è¡Œåœ¨æŒ‡å®šçš„ executor ä¸­è¿›è¡Œã€‚</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>    static void invokeChannelRead(final AbstractChannelHandlerContext next, Object msg) {
        final Object m = next.pipeline.touch(ObjectUtil.checkNotNull(msg, &quot;msg&quot;), next);
        EventExecutor executor = next.executor();
        //éœ€è¦ä¿è¯channelReadäº‹ä»¶å›è°ƒåœ¨channelHandleræŒ‡å®šçš„executorä¸­è¿›è¡Œ
        if (executor.inEventLoop()) {
            next.invokeChannelRead(m);
        } else {
            executor.execute(new Runnable() {
                @Override
                public void run() {
                    next.invokeChannelRead(m);
                }
            });
        }
    }

    private void invokeChannelRead(Object msg) {
        if (invokeHandler()) {
            try {
                ((ChannelInboundHandler) handler()).channelRead(this, msg);
            } catch (Throwable t) {
                invokeExceptionCaught(t);
            }
        } else {
            fireChannelRead(msg);
        }
    }
</code></pre></div><p>åœ¨æ‰§è¡Œ HeadContext çš„ channelRead æ–¹æ³•å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œå°±ä¼šå›è°ƒ HeadContext çš„ exceptionCaught æ–¹æ³•ã€‚å¹¶åœ¨ç›¸åº”çš„äº‹ä»¶å›è°ƒæ–¹æ³•ä¸­å†³å®šæ˜¯å¦å°†äº‹ä»¶ç»§ç»­åœ¨ pipeline ä¸­ä¼ æ’­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    final class HeadContext extends AbstractChannelHandlerContext
            implements ChannelOutboundHandler, ChannelInboundHandler {

        @Override
        public void channelRead(ChannelHandlerContext ctx, Object msg) {
            ctx.fireChannelRead(msg);
        }

       @Override
        public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) {
            ctx.fireExceptionCaught(cause);
        }
    }
</code></pre></div><p>åœ¨ HeadContext ä¸­é€šè¿‡ ctx.fireChannelRead(msg) ç»§ç»­å°† ChannelRead äº‹ä»¶åœ¨ pipeline ä¸­å‘åä¼ æ’­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>abstract class AbstractChannelHandlerContext implements ChannelHandlerContext, ResourceLeakHint {

    @Override
    public ChannelHandlerContext fireChannelRead(final Object msg) {
        invokeChannelRead(findContextInbound(MASK_CHANNEL_READ), msg);
        return this;
    }

}
</code></pre></div><p><strong>è¿™é‡Œçš„ findContextInbound æ–¹æ³•æ˜¯æ•´ä¸ª inbound ç±»äº‹ä»¶åœ¨ pipeline ä¸­ä¼ æ’­çš„æ ¸å¿ƒæ‰€åœ¨ã€‚</strong></p> <p>å› ä¸ºæˆ‘ä»¬ç°åœ¨éœ€è¦ç»§ç»­å°† ChannelRead äº‹ä»¶åœ¨ pipeline ä¸­ä¼ æ’­ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›®å‰çš„æ ¸å¿ƒé—®é¢˜å°±æ˜¯é€šè¿‡ findContextInbound æ–¹æ³•åœ¨ pipeline ä¸­æ‰¾åˆ°ä¸‹ä¸€ä¸ªå¯¹ ChannelRead äº‹ä»¶æ„Ÿå…´è¶£çš„ ChannelInboundHandler ã€‚ç„¶åæ‰§è¡Œè¯¥ ChannelInboundHandler çš„ ChannelRead äº‹ä»¶å›è°ƒã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    static void invokeChannelRead(final AbstractChannelHandlerContext next, Object msg) {
        final Object m = next.pipeline.touch(ObjectUtil.checkNotNull(msg, &quot;msg&quot;), next);
        EventExecutor executor = next.executor();
        //éœ€è¦ä¿è¯channelReadäº‹ä»¶å›è°ƒåœ¨channelHandleræŒ‡å®šçš„executorä¸­è¿›è¡Œ
        if (executor.inEventLoop()) {
            next.invokeChannelRead(m);
        } else {
            executor.execute(new Runnable() {
                @Override
                public void run() {
                    next.invokeChannelRead(m);
                }
            });
        }
    }
</code></pre></div><p>ChannelRead äº‹ä»¶å°±è¿™æ ·å¾ªç¯å¾€å¤çš„ä¸€ç›´åœ¨ pipeline ä¸­ä¼ æ’­ï¼Œåœ¨ä¼ æ’­çš„è¿‡ç¨‹ä¸­åªæœ‰å¯¹ ChannelRead äº‹ä»¶æ„Ÿå…´è¶£çš„ ChannelInboundHandler æ‰å¯ä»¥å“åº”ã€‚å…¶ä»–ç±»å‹çš„ ChannelHandler åˆ™ç›´æ¥è·³è¿‡ã€‚</p> <p>å¦‚æœ ChannelRead äº‹ä»¶åœ¨ pipeline ä¸­ä¼ æ’­çš„è¿‡ç¨‹ä¸­ï¼Œæ²¡æœ‰å¾—åˆ°å…¶ä»– ChannelInboundHandler çš„æœ‰æ•ˆå¤„ç†ï¼Œæœ€ç»ˆä¼šè¢«ä¼ æ’­åˆ° pipeline çš„æœ«å°¾ TailContext ä¸­ã€‚è€Œåœ¨æœ¬æ–‡ç¬¬äºŒå°èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿæåˆ°è¿‡ TailContext å¯¹äº inbound äº‹ä»¶å­˜åœ¨çš„æ„ä¹‰å°±æ˜¯åšä¸€ä¸ªå…œåº•çš„å¤„ç†ã€‚æ¯”å¦‚ï¼šæ‰“å°æ—¥å¿—ï¼Œé‡Šæ”¾ bytebuffer ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code> final class TailContext extends AbstractChannelHandlerContext implements ChannelInboundHandler {

    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) {
            onUnhandledInboundMessage(ctx, msg);
    }

    protected void onUnhandledInboundMessage(ChannelHandlerContext ctx, Object msg) {
        onUnhandledInboundMessage(msg);
        if (logger.isDebugEnabled()) {
            logger.debug(&quot;Discarded message pipeline : {}. Channel : {}.&quot;,
                         ctx.pipeline().names(), ctx.channel());
        }
    }

    protected void onUnhandledInboundMessage(Object msg) {
        try {
            logger.debug(
                    &quot;Discarded inbound message {} that reached at the tail of the pipeline. &quot; +
                            &quot;Please check your pipeline configuration.&quot;, msg);
        } finally {
            // é‡Šæ”¾DirectByteBuffer
            ReferenceCountUtil.release(msg);
        }
    }

}
</code></pre></div><h3 id="_8-2-findcontextinbound"><a href="#_8-2-findcontextinbound" class="header-anchor">#</a> 8.2 findContextInbound</h3> <p>æœ¬å°èŠ‚è¦ä»‹ç»çš„ findContextInbound æ–¹æ³•å’Œæˆ‘ä»¬åœ¨ä¸Šç¯‡æ–‡ç« <a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484532&amp;idx=1&amp;sn=c3a8b37a2eb09509d9914494ef108c68&amp;chksm=ce77c233f9004b25a29f9fdfb179e41646092d09bc89df2147a9fab66df13231e46dd6a5c26d&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">ã€Šä¸€æ–‡èŠé€ Netty å‘é€æ•°æ®å…¨æµç¨‹ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸­ä»‹ç»çš„ findContextOutbound æ–¹æ³•å‡æ˜¯ netty å¼‚æ­¥äº‹ä»¶åœ¨ pipeline ä¸­ä¼ æ’­çš„æ ¸å¿ƒæ‰€åœ¨ã€‚</p> <p>äº‹ä»¶ä¼ æ’­çš„æ ¸å¿ƒé—®é¢˜å°±æ˜¯éœ€è¦é«˜æ•ˆçš„åœ¨ pipeline ä¸­æŒ‰ç…§äº‹ä»¶çš„ä¼ æ’­æ–¹å‘ï¼Œæ‰¾åˆ°ä¸‹ä¸€ä¸ªå…·æœ‰å“åº”äº‹ä»¶èµ„æ ¼çš„ ChannelHandler ã€‚</p> <p>æ¯”å¦‚ï¼šè¿™é‡Œæˆ‘ä»¬åœ¨ pipeline ä¸­ä¼ æ’­çš„ ChannelRead äº‹ä»¶ï¼Œæˆ‘ä»¬å°±éœ€è¦åœ¨ pipeline ä¸­æ‰¾åˆ°ä¸‹ä¸€ä¸ªå¯¹ ChannelRead äº‹ä»¶æ„Ÿå…´è¶£çš„ ChannelInboundHandler ï¼Œå¹¶æ‰§è¡Œè¯¥ ChannelInboudnHandler çš„ ChannelRead äº‹ä»¶å›è°ƒï¼Œåœ¨ ChannelRead äº‹ä»¶å›è°ƒä¸­å¯¹äº‹ä»¶è¿›è¡Œä¸šåŠ¡å¤„ç†ï¼Œå¹¶å†³å®šæ˜¯å¦é€šè¿‡ ctx.fireChannelRead(msg) å°† ChannelRead äº‹ä»¶ç»§ç»­å‘åä¼ æ’­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private AbstractChannelHandlerContext findContextInbound(int mask) {
        AbstractChannelHandlerContext ctx = this;
        EventExecutor currentExecutor = executor();
        do {
            ctx = ctx.next;
        } while (skipContext(ctx, currentExecutor, mask, MASK_ONLY_INBOUND));

        return ctx;
    }
</code></pre></div><p>å‚æ•° mask è¡¨ç¤ºæˆ‘ä»¬æ­£åœ¨ä¼ æ’­çš„ ChannelRead äº‹ä»¶æ©ç  MASK_CHANNEL_READ ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    static final int MASK_EXCEPTION_CAUGHT = 1;
    static final int MASK_CHANNEL_REGISTERED = 1 &lt;&lt; 1;
    static final int MASK_CHANNEL_UNREGISTERED = 1 &lt;&lt; 2;
    static final int MASK_CHANNEL_ACTIVE = 1 &lt;&lt; 3;
    static final int MASK_CHANNEL_INACTIVE = 1 &lt;&lt; 4;
    static final int MASK_CHANNEL_READ = 1 &lt;&lt; 5;
    static final int MASK_CHANNEL_READ_COMPLETE = 1 &lt;&lt; 6;
    static final int MASK_USER_EVENT_TRIGGERED = 1 &lt;&lt; 7;
    static final int MASK_CHANNEL_WRITABILITY_CHANGED = 1 &lt;&lt; 8;
</code></pre></div><p>é€šè¿‡ ctx = ctx.next åœ¨ pipeline ä¸­æ‰¾åˆ°ä¸‹ä¸€ä¸ª ChannelHandler ï¼Œå¹¶é€šè¿‡ skipContext æ–¹æ³•åˆ¤æ–­ä¸‹ä¸€ä¸ª ChannelHandler æ˜¯å¦å…·æœ‰å“åº”äº‹ä»¶çš„èµ„æ ¼ã€‚å¦‚æœæ²¡æœ‰åˆ™è·³è¿‡ç»§ç»­å‘åæŸ¥æ‰¾ã€‚</p> <p>æ¯”å¦‚ï¼šä¸‹ä¸€ä¸ª ChannelHandler å¦‚æœæ˜¯ä¸€ä¸ª ChannelOutboundHandlerï¼Œæˆ–è€…ä¸‹ä¸€ä¸ª ChannelInboundHandler å¯¹ ChannelRead äº‹ä»¶ä¸æ„Ÿå…´è¶£ï¼Œé‚£ä¹ˆå°±ç›´æ¥è·³è¿‡ã€‚</p> <h3 id="_8-3-skipcontext"><a href="#_8-3-skipcontext" class="header-anchor">#</a> 8.3 skipContext</h3> <p>è¯¥æ–¹æ³•ä¸»è¦ç”¨æ¥åˆ¤æ–­ä¸‹ä¸€ä¸ª ChannelHandler æ˜¯å¦å…·æœ‰ mask ä»£è¡¨çš„äº‹ä»¶çš„å“åº”èµ„æ ¼ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private static boolean skipContext(
            AbstractChannelHandlerContext ctx, EventExecutor currentExecutor, int mask, int onlyMask) {

        return (ctx.executionMask &amp; (onlyMask | mask)) == 0 ||
                (ctx.executor() == currentExecutor &amp;&amp; (ctx.executionMask &amp; mask) == 0);
    }
</code></pre></div><ul><li>å‚æ•° onlyMask è¡¨ç¤ºæˆ‘ä»¬éœ€è¦æŸ¥æ‰¾çš„ ChannelHandler ç±»å‹ï¼Œæ¯”å¦‚è¿™é‡Œæˆ‘ä»¬æ­£åœ¨ä¼ æ’­ ChannelRead äº‹ä»¶ï¼Œå®ƒæ˜¯ä¸€ä¸ª inbound ç±»äº‹ä»¶ï¼Œé‚£ä¹ˆå¿…é¡»åªèƒ½ç”± ChannelInboundHandler æ¥å“åº”å¤„ç†ï¼Œæ‰€ä»¥è¿™é‡Œä¼ å…¥çš„ onlyMask ä¸º MASK_ONLY_INBOUND ï¼ˆ ChannelInboundHandler çš„æ©ç è¡¨ç¤ºï¼‰</li> <li>ctx.executionMask æˆ‘ä»¬å·²ç»åœ¨ã€Š5.3 ChanneHandlerContextã€‹å°èŠ‚ä¸­è¯¦ç»†ä»‹ç»è¿‡äº†ï¼Œå½“ ChannelHandler è¢«æ·»åŠ è¿› pipeline ä¸­æ—¶ï¼Œéœ€è¦è®¡ç®—å‡ºè¯¥ ChannelHandler æ„Ÿå…´è¶£çš„äº‹ä»¶é›†åˆæ©ç æ¥ï¼Œä¿å­˜åœ¨å¯¹åº” ChannelHandlerContext çš„ executionMask å­—æ®µä¸­ã€‚</li> <li>é¦–å…ˆä¼šé€šè¿‡ <code>ctx.executionMask &amp; (onlyMask | mask)) == 0</code> æ¥åˆ¤æ–­ä¸‹ä¸€ä¸ª ChannelHandler ç±»å‹æ˜¯å¦æ­£ç¡®ï¼Œæ¯”å¦‚æˆ‘ä»¬æ­£åœ¨ä¼ æ’­ inbound ç±»äº‹ä»¶ï¼Œä¸‹ä¸€ä¸ªå´æ˜¯ä¸€ä¸ª ChannelOutboundHandler ï¼Œé‚£ä¹ˆè‚¯å®šæ˜¯è¦è·³è¿‡çš„ï¼Œç»§ç»­å‘åæŸ¥æ‰¾ã€‚</li> <li>å¦‚æœä¸‹ä¸€ä¸ª ChannelHandler çš„ç±»å‹æ­£ç¡®ï¼Œé‚£ä¹ˆå°±ä¼šé€šè¿‡ <code>(ctx.executionMask &amp; mask) == 0</code> æ¥åˆ¤æ–­è¯¥ ChannelHandler æ˜¯å¦å¯¹æ­£åœ¨ä¼ æ’­çš„ mask äº‹ä»¶æ„Ÿå…´è¶£ã€‚å¦‚æœè¯¥  ChannelHandler ä¸­è¦†ç›–äº† ChannelRead å›è°ƒåˆ™æ‰§è¡Œï¼Œå¦‚æœæ²¡æœ‰è¦†ç›–å¯¹åº”çš„äº‹ä»¶å›è°ƒæ–¹æ³•åˆ™è·³è¿‡ï¼Œç»§ç»­å‘åæŸ¥æ‰¾ï¼Œç›´åˆ° TailContext ã€‚</li></ul> <p>ä»¥ä¸Šå°±æ˜¯ skipContext æ–¹æ³•çš„æ ¸å¿ƒé€»è¾‘ï¼Œè¿™é‡Œè¡¨è¾¾çš„æ ¸å¿ƒè¯­ä¹‰æ˜¯ï¼š</p> <ul><li>å¦‚æœ pipeline ä¸­ä¼ æ’­çš„æ˜¯ inbound ç±»äº‹ä»¶ï¼Œåˆ™å¿…é¡»ç”± ChannelInboundHandler æ¥å“åº”ï¼Œå¹¶ä¸”è¯¥ ChannelHandler å¿…é¡»è¦†ç›–å®ç°å¯¹åº”çš„ inbound äº‹ä»¶å›è°ƒã€‚</li> <li>å¦‚æœ pipeline ä¸­ä¼ æ’­çš„æ˜¯ outbound ç±»äº‹ä»¶ï¼Œåˆ™å¿…é¡»ç”± ChannelOutboundHandler æ¥å“åº”ï¼Œå¹¶ä¸”è¯¥ ChannelHandler å¿…é¡»è¦†ç›–å®ç°å¯¹åº”çš„ outbound äº‹ä»¶å›è°ƒã€‚</li></ul> <p>è¿™é‡Œå¤§éƒ¨åˆ†åŒå­¦å¯èƒ½ä¼šå¯¹ <code>ctx.executor() == currentExecutor</code>è¿™ä¸ªæ¡ä»¶æ„Ÿåˆ°å¾ˆç–‘æƒ‘ã€‚åŠ ä¸Šè¿™ä¸ªæ¡ä»¶ï¼Œå…¶å®å¯¹æˆ‘ä»¬è¿™é‡Œçš„æ ¸å¿ƒè¯­ä¹‰å¹¶æ²¡æœ‰å¤šå¤§å½±å“ã€‚</p> <ul><li>å½“ ctx.executor() == currentExecutor ä¹Ÿå°±æ˜¯è¯´å‰åä¸¤ä¸ª ChannelHandler æŒ‡å®šçš„ executor ç›¸åŒæ—¶ï¼Œæˆ‘ä»¬æ ¸å¿ƒè¯­ä¹‰ä¿æŒä¸å˜ã€‚</li> <li>å½“ <code>ctx.executor() != currentExecutor</code>ä¹Ÿå°±æ˜¯å‰åä¸¤ä¸ª ChannelHandler æŒ‡å®šçš„ executor ä¸åŒæ—¶ï¼Œ<strong>è¯­ä¹‰å˜ä¸ºï¼šåªè¦å‰åä¸¤ä¸ª ChannelHandler æŒ‡å®šçš„ executor ä¸åŒï¼Œä¸ç®¡ä¸‹ä¸€ä¸ªChannelHandleræœ‰æ²¡æœ‰è¦†ç›–å®ç°æŒ‡å®šäº‹ä»¶çš„å›è°ƒæ–¹æ³•ï¼Œå‡ä¸èƒ½è·³è¿‡ã€‚</strong> åœ¨è¿™ç§æƒ…å†µä¸‹ä¼šæ‰§è¡Œåˆ° ChannelHandler çš„é»˜è®¤äº‹ä»¶å›è°ƒæ–¹æ³•ï¼Œç»§ç»­åœ¨ pipeline ä¸­ä¼ é€’äº‹ä»¶ã€‚æˆ‘ä»¬åœ¨ã€Š5.3 ChanneHandlerContextã€‹å°èŠ‚æåˆ°è¿‡ ChannelInboundHandlerAdapter å’Œ ChannelOutboundHandlerAdapter ä¼šåˆ†åˆ«å¯¹ inbound ç±»äº‹ä»¶å›è°ƒæ–¹æ³•å’Œ outbound ç±»äº‹ä»¶å›è°ƒæ–¹æ³•è¿›è¡Œé»˜è®¤çš„å®ç°ã€‚</li></ul> <div class="language- extra-class"><pre class="language-text"><code>public class ChannelOutboundHandlerAdapter extends ChannelHandlerAdapter implements ChannelOutboundHandler {

    @Skip
    @Override
    public void bind(ChannelHandlerContext ctx, SocketAddress localAddress,
            ChannelPromise promise) throws Exception {
        ctx.bind(localAddress, promise);
    }

    @Skip
    @Override
    public void connect(ChannelHandlerContext ctx, SocketAddress remoteAddress,
            SocketAddress localAddress, ChannelPromise promise) throws Exception {
        ctx.connect(remoteAddress, localAddress, promise);
    }

    @Skip
    @Override
    public void disconnect(ChannelHandlerContext ctx, ChannelPromise promise)
            throws Exception {
        ctx.disconnect(promise);
    }

    @Skip
    @Override
    public void close(ChannelHandlerContext ctx, ChannelPromise promise)
            throws Exception {
        ctx.close(promise);
    }

    @Skip
    @Override
    public void deregister(ChannelHandlerContext ctx, ChannelPromise promise) throws Exception {
        ctx.deregister(promise);
    }

    @Skip
    @Override
    public void read(ChannelHandlerContext ctx) throws Exception {
        ctx.read();
    }

    @Skip
    @Override
    public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) throws Exception {
        ctx.write(msg, promise);
    }

    @Skip
    @Override
    public void flush(ChannelHandlerContext ctx) throws Exception {
        ctx.flush();
    }
}
</code></pre></div><p>è€Œè¿™é‡Œä¹‹æ‰€ä»¥éœ€è¦åŠ å…¥ <code>ctx.executor() == currentExecutor</code> æ¡ä»¶çš„åˆ¤æ–­ï¼Œæ˜¯ä¸ºäº†é˜²æ­¢ HttpContentCompressor åœ¨è¢«æŒ‡å®šä¸åŒçš„ executor æƒ…å†µä¸‹æ— æ³•æ­£ç¡®çš„åˆ›å»ºå‹ç¼©å†…å®¹ï¼Œå¯¼è‡´çš„ä¸€äº›å¼‚å¸¸ã€‚ä½†è¿™ä¸ªä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼Œå¤§å®¶åªéœ€è¦ç†è§£è¿™é‡Œçš„æ ¸å¿ƒè¯­ä¹‰å°±å¥½ï¼Œè¿™ç§ç‰¹æ®Šæƒ…å†µçš„ç‰¹æ®Šå¤„ç†äº†è§£ä¸€ä¸‹å°±å¥½ã€‚</p> <h3 id="_8-4-outboundäº‹ä»¶çš„ä¼ æ’­"><a href="#_8-4-outboundäº‹ä»¶çš„ä¼ æ’­" class="header-anchor">#</a> 8.4 Outboundäº‹ä»¶çš„ä¼ æ’­</h3> <p>å…³äº Outbound ç±»äº‹ä»¶çš„ä¼ æ’­ï¼Œç¬”è€…åœ¨ä¸Šç¯‡æ–‡ç« <a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247484532&amp;idx=1&amp;sn=c3a8b37a2eb09509d9914494ef108c68&amp;chksm=ce77c233f9004b25a29f9fdfb179e41646092d09bc89df2147a9fab66df13231e46dd6a5c26d&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">ã€Šä¸€æ–‡ææ‡‚ Netty å‘é€æ•°æ®å…¨æµç¨‹ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸­å·²ç»è¿›è¡Œäº†è¯¦ç»†çš„ä»‹ç»ï¼Œæœ¬å°èŠ‚å°±ä¸åœ¨èµ˜è¿°ã€‚</p> <h3 id="_8-5-exceptioncaughtäº‹ä»¶çš„ä¼ æ’­"><a href="#_8-5-exceptioncaughtäº‹ä»¶çš„ä¼ æ’­" class="header-anchor">#</a> 8.5 ExceptionCaughtäº‹ä»¶çš„ä¼ æ’­</h3> <p>åœ¨æœ€åæˆ‘ä»¬æ¥ä»‹ç»ä¸‹å¼‚å¸¸äº‹ä»¶åœ¨ pipeline ä¸­çš„ä¼ æ’­ï¼ŒExceptionCaught äº‹ä»¶å’Œ Inbound ç±»äº‹ä»¶ä¸€æ ·éƒ½æ˜¯åœ¨ pipeline ä¸­ä»å‰å¾€åå¼€å§‹ä¼ æ’­ã€‚</p> <p>ExceptionCaught äº‹ä»¶çš„è§¦å‘æœ‰ä¸¤ç§æƒ…å†µï¼šä¸€ç§æ˜¯ netty æ¡†æ¶å†…éƒ¨äº§ç”Ÿçš„å¼‚å¸¸ï¼Œè¿™æ—¶ netty ä¼šç›´æ¥åœ¨ pipeline ä¸­è§¦å‘ ExceptionCaught äº‹ä»¶çš„ä¼ æ’­ã€‚å¼‚å¸¸äº‹ä»¶ä¼šåœ¨ pipeline ä¸­ä» HeadContext å¼€å§‹ä¸€ç›´å‘åä¼ æ’­ç›´åˆ° TailContextã€‚</p> <p>æ¯”å¦‚ netty åœ¨ read loop ä¸­è¯»å–æ•°æ®æ—¶å‘ç”Ÿå¼‚å¸¸ï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>     try {
               ...........

               do {
                          ............               
                    allocHandle.lastBytesRead(doReadBytes(byteBuf));

                          ............
       
                    //å®¢æˆ·ç«¯NioSocketChannelçš„pipelineä¸­è§¦å‘ChannelReadäº‹ä»¶
                    pipeline.fireChannelRead(byteBuf);
  
                } while (allocHandle.continueReading());

                         ...........
        }  catch (Throwable t) {
                handleReadException(pipeline, byteBuf, t, close, allocHandle);
       } 
</code></pre></div><p>è¿™æ—¶ä¼š netty ä¼šç›´æ¥ä» pipeline ä¸­è§¦å‘ ExceptionCaught äº‹ä»¶çš„ä¼ æ’­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>       private void handleReadException(ChannelPipeline pipeline, ByteBuf byteBuf, Throwable cause, boolean close,
                RecvByteBufAllocator.Handle allocHandle) {
             
                    .............

            pipeline.fireExceptionCaught(cause);

                    .............

        }
</code></pre></div><p>å’Œ Inbound ç±»äº‹ä»¶ä¸€æ ·ï¼ŒExceptionCaught äº‹ä»¶ä¼šåœ¨ pipeline ä¸­ä» HeadContext å¼€å§‹ä¸€ç›´å‘åä¼ æ’­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public final ChannelPipeline fireExceptionCaught(Throwable cause) {
        AbstractChannelHandlerContext.invokeExceptionCaught(head, cause);
        return this;
    }
</code></pre></div><p>ç¬¬äºŒç§è§¦å‘ ExceptionCaught äº‹ä»¶çš„æƒ…å†µæ˜¯ï¼Œå½“ Inbound ç±»äº‹ä»¶æˆ–è€… flush äº‹ä»¶åœ¨ pipeline ä¸­ä¼ æ’­çš„è¿‡ç¨‹ä¸­ï¼Œåœ¨æŸä¸ª ChannelHandler ä¸­çš„äº‹ä»¶å›è°ƒæ–¹æ³•å¤„ç†ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œè¿™æ—¶è¯¥ ChannelHandler çš„ exceptionCaught æ–¹æ³•ä¼šè¢«å›è°ƒã€‚ç”¨æˆ·å¯ä»¥åœ¨è¿™é‡Œå¤„ç†å¼‚å¸¸äº‹ä»¶ï¼Œå¹¶å†³å®šæ˜¯å¦é€šè¿‡ ctx.fireExceptionCaught(cause) ç»§ç»­å‘åä¼ æ’­å¼‚å¸¸äº‹ä»¶ã€‚</p> <p>æ¯”å¦‚æˆ‘ä»¬åœ¨ ChannelInboundHandler ä¸­çš„ ChannelRead å›è°ƒä¸­å¤„ç†ä¸šåŠ¡è¯·æ±‚æ—¶å‘ç”Ÿå¼‚å¸¸ï¼Œå°±ä¼šè§¦å‘è¯¥ ChannelInboundHandler çš„ exceptionCaught æ–¹æ³•ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private void invokeChannelRead(Object msg) {
        if (invokeHandler()) {
            try {
                ((ChannelInboundHandler) handler()).channelRead(this, msg);
            } catch (Throwable t) {
                invokeExceptionCaught(t);
            }
        } else {
            fireChannelRead(msg);
        }
    }
    private void invokeExceptionCaught(final Throwable cause) {
        if (invokeHandler()) {
            try {
                //è§¦å‘channelHandlerçš„exceptionCaughtå›è°ƒ
                handler().exceptionCaught(this, cause);
            } catch (Throwable error) {
                  ........
        } else {
                  ........
        }
    }
</code></pre></div><p>å†æ¯”å¦‚ï¼šå½“æˆ‘ä»¬åœ¨ ChannelOutboundHandler ä¸­çš„ flush å›è°ƒä¸­å¤„ç†ä¸šåŠ¡ç»“æœå‘é€çš„æ—¶å€™å‘ç”Ÿå¼‚å¸¸ï¼Œä¹Ÿä¼šè§¦å‘è¯¥ ChannelOutboundHandler çš„ exceptionCaught æ–¹æ³•ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>   private void invokeFlush0() {
        try {
            ((ChannelOutboundHandler) handler()).flush(this);
        } catch (Throwable t) {
            invokeExceptionCaught(t);
        }
    }
</code></pre></div><p>æˆ‘ä»¬å¯ä»¥åœ¨ ChannelHandler çš„ exceptionCaught å›è°ƒä¸­è¿›è¡Œå¼‚å¸¸å¤„ç†ï¼Œå¹¶å†³å®šæ˜¯å¦é€šè¿‡ ctx.fireExceptionCaught(cause) ç»§ç»­å‘åä¼ æ’­å¼‚å¸¸äº‹ä»¶ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause)
            throws Exception {

        .........å¼‚å¸¸å¤„ç†.......

        ctx.fireExceptionCaught(cause);
    }
    @Override
    public ChannelHandlerContext fireExceptionCaught(final Throwable cause) {
        invokeExceptionCaught(findContextInbound(MASK_EXCEPTION_CAUGHT), cause);
        return this;
    }

   static void invokeExceptionCaught(final AbstractChannelHandlerContext next, final Throwable cause) {
        ObjectUtil.checkNotNull(cause, &quot;cause&quot;);
        EventExecutor executor = next.executor();
        if (executor.inEventLoop()) {
            next.invokeExceptionCaught(cause);
        } else {
            try {
                executor.execute(new Runnable() {
                    @Override
                    public void run() {
                        next.invokeExceptionCaught(cause);
                    }
                });
            } catch (Throwable t) {
                if (logger.isWarnEnabled()) {
                    logger.warn(&quot;Failed to submit an exceptionCaught() event.&quot;, t);
                    logger.warn(&quot;The exceptionCaught() event that was failed to submit was:&quot;, cause);
                }
            }
        }
    }
</code></pre></div><h3 id="_8-6-exceptioncaught-äº‹ä»¶å’Œ-inbound-ç±»äº‹ä»¶çš„åŒºåˆ«"><a href="#_8-6-exceptioncaught-äº‹ä»¶å’Œ-inbound-ç±»äº‹ä»¶çš„åŒºåˆ«" class="header-anchor">#</a> 8.6 ExceptionCaught äº‹ä»¶å’Œ Inbound ç±»äº‹ä»¶çš„åŒºåˆ«</h3> <p>è™½ç„¶ ExceptionCaught äº‹ä»¶å’Œ Inbound ç±»äº‹ä»¶åœ¨ä¼ æ’­æ–¹å‘éƒ½æ˜¯åœ¨ pipeline ä¸­ä»å‰å‘åä¼ æ’­ã€‚ä½†æ˜¯å¤§å®¶è¿™é‡Œæ³¨æ„åŒºåˆ†è¿™ä¸¤ä¸ªäº‹ä»¶çš„åŒºåˆ«ã€‚</p> <p><strong>åœ¨ Inbound ç±»äº‹ä»¶ä¼ æ’­è¿‡ç¨‹ä¸­æ˜¯ä¼šæŸ¥æ‰¾ä¸‹ä¸€ä¸ªå…·æœ‰äº‹ä»¶å“åº”èµ„æ ¼çš„ ChannelInboundHandler ã€‚é‡åˆ° ChannelOutboundHandler ä¼šç›´æ¥è·³è¿‡ã€‚</strong></p> <p><strong>è€Œ ExceptionCaught äº‹ä»¶æ— è®ºæ˜¯åœ¨å“ªç§ç±»å‹çš„ channelHandler ä¸­è§¦å‘çš„ï¼Œéƒ½ä¼šä»å½“å‰å¼‚å¸¸ ChannelHandler å¼€å§‹ä¸€ç›´å‘åä¼ æ’­ï¼ŒChannelInboundHandler å¯ä»¥å“åº”è¯¥å¼‚å¸¸äº‹ä»¶ï¼ŒChannelOutboundHandler ä¹Ÿå¯ä»¥å“åº”è¯¥å¼‚å¸¸äº‹ä»¶ã€‚</strong></p> <p>ç”±äºæ— è®ºå¼‚å¸¸æ˜¯åœ¨ ChannelInboundHandler ä¸­äº§ç”Ÿçš„è¿˜æ˜¯åœ¨ ChannelOutboundHandler ä¸­äº§ç”Ÿçš„ï¼Œ exceptionCaught äº‹ä»¶éƒ½ä¼šåœ¨ pipeline ä¸­æ˜¯ä»å‰å‘åä¼ æ’­ï¼Œå¹¶ä¸”ä¸å…³å¿ƒ ChannelHandler çš„ç±»å‹ã€‚<strong>æ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬å°†è´Ÿè´£ç»Ÿä¸€å¼‚å¸¸å¤„ç†çš„ ChannelHandler æ”¾åœ¨ pipeline çš„æœ€å</strong>ï¼Œè¿™æ ·å®ƒå¯¹äº inbound ç±»å¼‚å¸¸å’Œ outbound ç±»å¼‚å¸¸å‡å¯ä»¥æ•è·å¾—åˆ°ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191116438.webp" alt="å›¾ç‰‡">å¼‚å¸¸äº‹ä»¶çš„ä¼ æ’­.png</p> <hr> <h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="header-anchor">#</a> æ€»ç»“</h2> <p>æœ¬æ–‡æ¶‰åŠåˆ°çš„å†…å®¹æ¯”è¾ƒå¤šï¼Œé€šè¿‡ netty å¼‚æ­¥äº‹ä»¶åœ¨ pipeline ä¸­çš„ç¼–æ’å’Œä¼ æ’­è¿™æ¡ä¸»çº¿ï¼Œæˆ‘ä»¬ç›¸å½“äºå°†ä¹‹å‰çš„æ–‡ç« å†…å®¹é‡æ–°åˆå›é¡¾æ€»ç»“äº†ä¸€éã€‚</p> <p>æœ¬æ–‡ä¸­æˆ‘ä»¬è¯¦ç»†ä»‹ç»äº† pipeline çš„ç»„æˆç»“æ„ï¼Œå®ƒä¸»è¦æ˜¯ç”± ChannelHandlerContext ç±»å‹èŠ‚ç‚¹ç»„æˆçš„åŒå‘é“¾è¡¨ã€‚ChannelHandlerContext åŒ…å«äº† ChannelHandler æ‰§è¡Œä¸Šä¸‹æ–‡çš„ä¿¡æ¯ï¼Œä»è€Œå¯ä»¥ä½¿ ChannelHandler åªå…³æ³¨äº IO äº‹ä»¶çš„å¤„ç†ï¼Œéµå¾ªäº†å•ä¸€åŸåˆ™å’Œå¼€é—­åŸåˆ™ã€‚</p> <p>æ­¤å¤– pipeline ç»“æ„ä¸­è¿˜åŒ…å«äº†ä¸€ä¸ªä»»åŠ¡é“¾è¡¨ï¼Œç”¨æ¥å­˜æ”¾æ‰§è¡Œ ChannelHandler ä¸­çš„ handlerAdded å›è°ƒå’Œ handlerRemoved å›è°ƒã€‚pipeline è¿˜æŒæœ‰äº†æ‰€å± channel çš„å¼•ç”¨ã€‚</p> <p>æˆ‘ä»¬è¿˜è¯¦ç»†ä»‹ç»äº† Netty ä¸­å¼‚æ­¥äº‹ä»¶çš„åˆ†ç±»ï¼šInbound ç±»äº‹ä»¶ï¼ŒOutbound ç±»äº‹ä»¶ï¼ŒExceptionCaught äº‹ä»¶ã€‚å¹¶è¯¦ç»†ä»‹ç»äº†æ¯ç§åˆ†ç±»ä¸‹çš„æ‰€æœ‰äº‹ä»¶çš„è§¦å‘æ—¶æœºå’Œåœ¨ pipeline ä¸­çš„ä¼ æ’­è·¯å¾„ã€‚</p> <p>æœ€åä»‹ç»äº† pipeline çš„ç»“æ„ä»¥åŠåˆ›å»ºå’Œåˆå§‹åŒ–è¿‡ç¨‹ï¼Œä»¥åŠå¯¹ pipeline ç›¸å…³æ“ä½œçš„æºç å®ç°ã€‚</p> <p>ä¸­é—´æˆ‘ä»¬åˆç©¿æ’ä»‹ç»äº† ChannelHanderContext çš„ç»“æ„ï¼Œä»‹ç»äº† ChannelHandlerContext å…·ä½“å°è£…äº†å“ªäº›å…³äº ChannelHandler æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p> <p>æœ¬æ–‡çš„å†…å®¹åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œæ„Ÿè°¢å¤§å®¶çš„è§‚çœ‹ï¼Œæˆ‘ä»¬ä¸‹ç¯‡æ–‡ç« è§~~~</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/echo-lxy/echo-system-design/edit/master/docs/Netty ç³»ç»Ÿè®¾è®¡/25.å››ã€æ·±å…¥ Netty æ ¸å¿ƒ/25.ç¬¬ä¸ƒè¯¾ï¼šè¯¦è§£ Netty ä¸­æ‰€æœ‰IOäº‹ä»¶çš„è§¦å‘æ—¶æœºå’Œä¼ æ’­æµç¨‹.md" target="_blank" rel="noopener noreferrer">ç¼–è¾‘</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°äº:</span> <span class="time">2024/09/19, 03:26:41</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        â†
        <a href="/pages/cfe9ff/" class="prev">ç¬¬å…­è¯¾ï¼šNetty å¦‚ä½•é«˜æ•ˆå‘é€ç½‘ç»œæ•°æ®.md</a></span> <span class="next"><a href="/pages/b7c744/">ç¬¬ä¸€è¯¾ï¼šByteBuf ä½“ç³»çš„è®¾è®¡ä¸å®ç°</a>â†’
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:lixinyang2002@163.com" title="å‘é‚®ä»¶" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/echo-lxy" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="å¬éŸ³ä¹" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="æœ¬ç«™ä¸»é¢˜">Vdoing</a> 
    | Copyright Â© 2024-2024
    <span>Xinyang Li | MIT License</span></div> <div class="buttons"><div title="è¿”å›é¡¶éƒ¨" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="å»è¯„è®º" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ä¸»é¢˜æ¨¡å¼" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          è·Ÿéšç³»ç»Ÿ
        </li><li class="iconfont icon-rijianmoshi">
          æµ…è‰²æ¨¡å¼
        </li><li class="iconfont icon-yejianmoshi">
          æ·±è‰²æ¨¡å¼
        </li><li class="iconfont icon-yuedu">
          é˜…è¯»æ¨¡å¼
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.6c7acbd0.js" defer></script><script src="/assets/js/2.933750c6.js" defer></script><script src="/assets/js/57.72ba41a6.js" defer></script><script src="/assets/js/7.7eb70372.js" defer></script>
  </body>
</html>
