<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RecordAccumulator æºç åˆ†æ | EchoDesign</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="ç³»ç»Ÿè®¾è®¡ä¹‹ã€Œè®²è§£ + é¢è¯•æŒ‡å—ã€ï¼Œæ°´æ»´çŸ³ç©¿ï¼Œè®¾è®¡æ— é“¶å¼¹ï¼">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.c76c3453.css" as="style"><link rel="preload" href="/assets/js/app.902083d3.js" as="script"><link rel="preload" href="/assets/js/2.933750c6.js" as="script"><link rel="preload" href="/assets/js/23.4f896de4.js" as="script"><link rel="preload" href="/assets/js/7.7eb70372.js" as="script"><link rel="prefetch" href="/assets/js/10.2cc95be8.js"><link rel="prefetch" href="/assets/js/100.2b21dce5.js"><link rel="prefetch" href="/assets/js/101.96ca71f6.js"><link rel="prefetch" href="/assets/js/11.c7521a10.js"><link rel="prefetch" href="/assets/js/12.38d1989d.js"><link rel="prefetch" href="/assets/js/13.850793b0.js"><link rel="prefetch" href="/assets/js/14.1141ec27.js"><link rel="prefetch" href="/assets/js/15.12d1dea8.js"><link rel="prefetch" href="/assets/js/16.60cde607.js"><link rel="prefetch" href="/assets/js/17.acb3bf3d.js"><link rel="prefetch" href="/assets/js/18.e491edb6.js"><link rel="prefetch" href="/assets/js/19.daf31819.js"><link rel="prefetch" href="/assets/js/20.cb4a5c13.js"><link rel="prefetch" href="/assets/js/21.24c0f101.js"><link rel="prefetch" href="/assets/js/22.dd779f94.js"><link rel="prefetch" href="/assets/js/24.6ba53300.js"><link rel="prefetch" href="/assets/js/25.41dca26b.js"><link rel="prefetch" href="/assets/js/26.6337eac0.js"><link rel="prefetch" href="/assets/js/27.de80589e.js"><link rel="prefetch" href="/assets/js/28.95a1fb6b.js"><link rel="prefetch" href="/assets/js/29.371a40e1.js"><link rel="prefetch" href="/assets/js/3.5c09ac9d.js"><link rel="prefetch" href="/assets/js/30.e32f6b31.js"><link rel="prefetch" href="/assets/js/31.a532917f.js"><link rel="prefetch" href="/assets/js/32.13b70e91.js"><link rel="prefetch" href="/assets/js/33.64ab8d0c.js"><link rel="prefetch" href="/assets/js/34.6d3cc288.js"><link rel="prefetch" href="/assets/js/35.98e20e9a.js"><link rel="prefetch" href="/assets/js/36.be98cc35.js"><link rel="prefetch" href="/assets/js/37.82be3556.js"><link rel="prefetch" href="/assets/js/38.40fe2658.js"><link rel="prefetch" href="/assets/js/39.84b6e82e.js"><link rel="prefetch" href="/assets/js/4.73518a0f.js"><link rel="prefetch" href="/assets/js/40.591baf2a.js"><link rel="prefetch" href="/assets/js/41.f961e422.js"><link rel="prefetch" href="/assets/js/42.b34f1599.js"><link rel="prefetch" href="/assets/js/43.5a509601.js"><link rel="prefetch" href="/assets/js/44.64fd3383.js"><link rel="prefetch" href="/assets/js/45.685623ac.js"><link rel="prefetch" href="/assets/js/46.7624d38c.js"><link rel="prefetch" href="/assets/js/47.5646b068.js"><link rel="prefetch" href="/assets/js/48.a1b270df.js"><link rel="prefetch" href="/assets/js/49.ee9681bc.js"><link rel="prefetch" href="/assets/js/5.94727770.js"><link rel="prefetch" href="/assets/js/50.b424b2c0.js"><link rel="prefetch" href="/assets/js/51.ef213b56.js"><link rel="prefetch" href="/assets/js/52.18c75eba.js"><link rel="prefetch" href="/assets/js/53.f76e624c.js"><link rel="prefetch" href="/assets/js/54.3098ec9f.js"><link rel="prefetch" href="/assets/js/55.4c46841d.js"><link rel="prefetch" href="/assets/js/56.26c4fd80.js"><link rel="prefetch" href="/assets/js/57.36581a94.js"><link rel="prefetch" href="/assets/js/58.e5a83b70.js"><link rel="prefetch" href="/assets/js/59.7b7e3faf.js"><link rel="prefetch" href="/assets/js/6.0b558b79.js"><link rel="prefetch" href="/assets/js/60.66a7f41d.js"><link rel="prefetch" href="/assets/js/61.52ab8e4e.js"><link rel="prefetch" href="/assets/js/62.82fff0c9.js"><link rel="prefetch" href="/assets/js/63.392eea42.js"><link rel="prefetch" href="/assets/js/64.f22c5bcd.js"><link rel="prefetch" href="/assets/js/65.1c5bfacf.js"><link rel="prefetch" href="/assets/js/66.e67fcc68.js"><link rel="prefetch" href="/assets/js/67.b666ce97.js"><link rel="prefetch" href="/assets/js/68.1b76c178.js"><link rel="prefetch" href="/assets/js/69.7ac52a2f.js"><link rel="prefetch" href="/assets/js/70.7279b1df.js"><link rel="prefetch" href="/assets/js/71.4f744076.js"><link rel="prefetch" href="/assets/js/72.44c999da.js"><link rel="prefetch" href="/assets/js/73.526febf1.js"><link rel="prefetch" href="/assets/js/74.26f8d9a5.js"><link rel="prefetch" href="/assets/js/75.dc7fdd0f.js"><link rel="prefetch" href="/assets/js/76.32858593.js"><link rel="prefetch" href="/assets/js/77.7b3f6980.js"><link rel="prefetch" href="/assets/js/78.31a353ef.js"><link rel="prefetch" href="/assets/js/79.e59dfac4.js"><link rel="prefetch" href="/assets/js/8.0ec7f6e8.js"><link rel="prefetch" href="/assets/js/80.fdcb5fa1.js"><link rel="prefetch" href="/assets/js/81.d124398a.js"><link rel="prefetch" href="/assets/js/82.6d0d2919.js"><link rel="prefetch" href="/assets/js/83.65db62ac.js"><link rel="prefetch" href="/assets/js/84.e5207e82.js"><link rel="prefetch" href="/assets/js/85.f69467b2.js"><link rel="prefetch" href="/assets/js/86.31709d48.js"><link rel="prefetch" href="/assets/js/87.67fcabb9.js"><link rel="prefetch" href="/assets/js/88.93192130.js"><link rel="prefetch" href="/assets/js/89.e6cb2516.js"><link rel="prefetch" href="/assets/js/9.6e274fca.js"><link rel="prefetch" href="/assets/js/90.cdc8eb8f.js"><link rel="prefetch" href="/assets/js/91.8ad18b18.js"><link rel="prefetch" href="/assets/js/92.b554f1c7.js"><link rel="prefetch" href="/assets/js/93.fb2397b7.js"><link rel="prefetch" href="/assets/js/94.1eade7f0.js"><link rel="prefetch" href="/assets/js/95.96f5db04.js"><link rel="prefetch" href="/assets/js/96.fc68b295.js"><link rel="prefetch" href="/assets/js/97.0a9a6187.js"><link rel="prefetch" href="/assets/js/98.10f4b27a.js"><link rel="prefetch" href="/assets/js/99.4a895015.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c76c3453.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="ç›®å½•" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="EchoDesign" class="logo"> <span class="site-name can-hide">EchoDesign</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">ğŸ é¦–é¡µ</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">âœ’ï¸çƒ­é—¨ç®—æ³•</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ğŸ–ï¸èµæç»å…¸è®¾è®¡" class="dropdown-title"><!----> <span class="title" style="display:;">ğŸ–ï¸èµæç»å…¸è®¾è®¡</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis æ·±åº¦å‰–æ</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka æ·±åº¦å‰–æ</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty æ·±åº¦å‰–æ</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx æ·±åº¦å‰–æ</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ğŸ§‘â€ğŸ’»å®æˆ˜ç³»ç»Ÿè®¾è®¡</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">â“é—®ç­”</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ğŸ‘€åŠ¨æ€</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">ğŸ é¦–é¡µ</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">âœ’ï¸çƒ­é—¨ç®—æ³•</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ğŸ–ï¸èµæç»å…¸è®¾è®¡" class="dropdown-title"><!----> <span class="title" style="display:;">ğŸ–ï¸èµæç»å…¸è®¾è®¡</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis æ·±åº¦å‰–æ</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka æ·±åº¦å‰–æ</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty æ·±åº¦å‰–æ</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx æ·±åº¦å‰–æ</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ğŸ§‘â€ğŸ’»å®æˆ˜ç³»ç»Ÿè®¾è®¡</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">â“é—®ç­”</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ğŸ‘€åŠ¨æ€</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ä¸€ã€å‰è¨€</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>ä¸‰ã€ä¸»çº¿ä»»åŠ¡</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/46a58a/" class="sidebar-link">Kafka æ•´ä½“æ¶æ„</a></li><li><a href="/pages/bb1005/" class="sidebar-link">ç”Ÿäº§è€…</a></li><li><a href="/pages/aa0392/" class="sidebar-link">Broker</a></li><li><a href="/pages/ca141b/" class="sidebar-link">æ¶ˆè´¹è€…</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>ã€Œç”Ÿäº§è€…ã€æºç åˆ†æ</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/19bf78/" class="sidebar-link">Kafka Producer è®¾è®¡åˆ†æ</a></li><li><a href="/pages/32a8ff/" class="sidebar-link">Kafka Producer æºç åˆ†æ</a></li><li><a href="/pages/b77953/" aria-current="page" class="active sidebar-link">RecordAccumulator æºç åˆ†æ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/b77953/#å‰è¨€" class="sidebar-link">å‰è¨€</a></li><li class="sidebar-sub-header level2"><a href="/pages/b77953/#recordaccumulatorè®¾è®¡" class="sidebar-link">RecordAccumulatorè®¾è®¡</a></li><li class="sidebar-sub-header level2"><a href="/pages/b77953/#recordaccumulator-ä»£ç åˆ†æ" class="sidebar-link">RecordAccumulator ä»£ç åˆ†æ</a></li><li class="sidebar-sub-header level2"><a href="/pages/b77953/#producerbatchç±»åˆ†æ" class="sidebar-link">ProducerBatchç±»åˆ†æ</a></li><li class="sidebar-sub-header level2"><a href="/pages/b77953/#memoryrecordsbuilderç±»åˆ†æ" class="sidebar-link">MemoryRecordsBuilderç±»åˆ†æ</a></li><li class="sidebar-sub-header level2"><a href="/pages/b77953/#æ€»ç»“" class="sidebar-link">æ€»ç»“</a></li><li class="sidebar-sub-header level2"><a href="/pages/b77953/#å‚è€ƒèµ„æ–™" class="sidebar-link">å‚è€ƒèµ„æ–™</a></li></ul></li><li><a href="/pages/bf1d55/" class="sidebar-link">Sender ç±»ä»£ç åˆ†æ</a></li><li><a href="/pages/b2caf1/" class="sidebar-link">NetworkClient ç±»ä»£ç åˆ†æ</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>ã€Œæ¶ˆè´¹è€…ã€æºç åˆ†æ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>ã€ŒBrokerã€åŸç†åˆ†æ</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>å››ã€è®¾è®¡ç›®æ ‡</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="é¦–é¡µ" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>Kafka  ç³»ç»Ÿè®¾è®¡</span></li><li data-v-06225672><span data-v-06225672>ä¸‰ã€ä¸»çº¿ä»»åŠ¡</span></li><li data-v-06225672><span data-v-06225672>ã€Œç”Ÿäº§è€…ã€æºç åˆ†æ</span></li></ul> <div class="info" data-v-06225672><div title="ä½œè€…" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/brother-one" target="_blank" title="ä½œè€…" class="beLink" data-v-06225672>echo</a></div> <div title="åˆ›å»ºæ—¶é—´" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-09-18</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">ç›®å½•</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">RecordAccumulator æºç åˆ†æ<!----></h1> <div class="page-slot page-slot-top">
    <div class="wwads-cn wwads-horizontal page-wwads" data-id="136"></div>
    <style>
      .page-wwads{
        width:100%!important;
        min-height: 0;
        margin: 0;
      }
      .page-wwads .wwads-img img{
        width:80px!important;
      }
      .page-wwads .wwads-poweredby{
        width: 40px;
        position: absolute;
        right: 25px;
        bottom: 3px;
      }
      .wwads-content .wwads-text, .page-wwads .wwads-text{
        height: 100%;
        padding-top: 5px;
        display: block;
      }
  </style>
  </div> <div class="theme-vdoing-content content__default"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="header-anchor">#</a> å‰è¨€</h2> <p>æˆ‘ä»¬çŸ¥é“RecordAccumulatoræ˜¯ç¼“å­˜å¾…å‘é€æ¶ˆæ¯çš„åœ°æ–¹ï¼ŒKafkaProduceræŠŠæ¶ˆæ¯æ”¾è¿›æ¥ï¼Œå½“æ¶ˆæ¯æ»¡äº†çš„æ—¶å€™ï¼Œé€šçŸ¥senderæ¥æŠŠæ¶ˆæ¯å‘å‡ºå»ï¼Œé‡Šæ”¾ç©ºé—´ã€‚RecordAccumulatorå°±ç›¸å½“äºè´§è¿ç«™çš„ä»“å‚¨ï¼Œè´§ç‰©ä¸æ–­çš„å¾€é‡Œæ”¾ï¼Œæ¯è£…æ»¡ä¸€ç®±å°±ä¼šé€šçŸ¥å‘è´§è€…æ¥å–è´§è¿èµ°ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
<img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409181547327.png" alt="image-20240918154629526"></p> <p>ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œè‡³å°‘æœ‰ä¸€ä¸ªä¸šåŠ¡ä¸»çº¿ç¨‹å’Œä¸€ä¸ªsenderçº¿ç¨‹åŒæ—¶æ“ä½œRecordAccumulatorï¼Œæ‰€ä»¥ä»–å¿…é¡»æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p> <p>ä¸‹é¢æˆ‘ä»¬æ¥è¯¦ç»†åˆ†æ RecordAccumulator</p> <h2 id="recordaccumulatorè®¾è®¡"><a href="#recordaccumulatorè®¾è®¡" class="header-anchor">#</a> RecordAccumulatorè®¾è®¡</h2> <p>æˆ‘ä»¬ç›´æ¥ä¸€å¤´æ‰å…¥ç¨‹åºçš„è®¾è®¡å’Œä»£ç ï¼Œä¼šæœ‰ä¸€å®šçš„ç†è§£éš¾åº¦ã€‚æˆ‘è¿˜æ˜¯å…ˆä»¥çœŸå®ä¸–ç•Œçš„æŸä¸ªäº‹ç‰©åšç±»æ¯”æ¥å…¥æ‰‹ã€‚</p> <p>å‰æ–‡è¯´RecordAccumulatoræ˜¯ä¸€ä¸ªç´¯ç§¯æ¶ˆæ¯çš„ä»“åº“ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ‹¿å¿«é€’ä»“åº“æ¥ç±»æ¯”ï¼Œçœ‹çœ‹RecordAccumulatoræ˜¯ä¸ªæ€æ ·çš„ä»“åº“ï¼Œçœ‹ä¸‹å›¾ï¼š</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409181547580.png" alt="image-20240918154725508"></p> <p>ä¸Šå›¾æ˜¯ä¸€ä¸ªå¿«é€’ç«™çš„ä»“åº“ï¼Œå †æ»¡äº†è´§ç‰©ã€‚åˆ†æ‹£å‘˜åœ¨è¿™é‡Œå·¥ä½œã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å‘å¾€ä¸åŒç›®çš„åœ°çš„å¤§è´§ç®±æ”¾ç½®åœ¨å„è‡ªå¯¹åº”çš„åŒºåŸŸï¼Œåˆ†æ‹£å‘˜æŠŠä¸åŒç›®çš„åœ°çš„åŒ…è£¹æ”¾å…¥å¯¹åº”ç›®çš„åœ°çš„å¤§è´§ç®±ï¼Œæ¯è£…æ»¡ä¸€ç®±å°±æ”¾ç½®åœ¨å¯¹åº”çš„å †æ”¾åŒºåŸŸã€‚</p> <p>åˆ†æ‹£å‘˜å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š</p> <ol><li>åˆ†æ‹£å‘˜æ”¶åˆ°ä¸€ä¸ªåŒ…è£¹ï¼Œå…ˆæŸ¥çœ‹ç›®çš„åœ°æ˜¯å“ªé‡Œã€‚å‡è®¾æ˜¯åŒ—äº¬æœé˜³ï¼Œä»–éœ€è¦æ‰¾åˆ°ç›®çš„åœ°ä¸ºåŒ—äº¬æœé˜³çš„å¤§è´§ç®±è£…è¿›å»ã€‚</li> <li>å½“è¿™ä¸ªå¤§ç®±å­è£…æ»¡åï¼Œåˆ†æ‹£å‘˜ä¼šæŠŠå®ƒå°ç®±ï¼Œç„¶åæ¬è¿åˆ°æŒ‚æœ‰åŒ—äº¬æœé˜³ç‰Œå­çš„åŒºåŸŸï¼Œå †æ”¾èµ·æ¥ã€‚</li> <li>å½“åˆ†æ‹£å‘˜å†æ‹¿åˆ°åŒ—äº¬æœé˜³çš„åŒ…è£¹æ—¶ï¼Œç”±äºæ²¡æœ‰å¯ç”¨çš„åŒ—äº¬æœé˜³å¤§è´§ç®±ï¼Œä»–éœ€è¦å†æ‹¿æ¥ä¸€ä¸ªåŒ—äº¬æœé˜³çš„å¤§è´§ç®±æ¥æ”¾ç½®åŒ…è£¹ã€‚</li></ol> <p>ä»¥ä¸Šå°±æ˜¯åˆ†æ‹£å‘˜æ‰€åšçš„å·¥ä½œï¼Œåˆ†æ‹£å‘˜æ˜¯è°å‘¢ï¼Ÿåˆ†æ‹£å‘˜å°±æ˜¯ RecordAccumulatorï¼è€Œé‚£äº›å¤§è´§ç®±ä»¥åŠå„è‡ªæ‰€å±çš„å †æ”¾åŒºåŸŸï¼Œå°±æ˜¯RecordAccumulator ä¸­ç¼“å­˜æ¶ˆæ¯çš„åœ°æ–¹ã€‚æ‰€æœ‰å°ç®±çš„å¤§è´§ç®±éƒ½ä¼šç­‰å¾… sender æ¥å–è´§å‘é€å‡ºå»ã€‚</p> <p>å¦‚æœä½ çœ‹æ‡‚äº†ä¸Šé¢è¿™å¼ å›¾ï¼Œé‚£ä¹ˆä½ å·²ç»å……åˆ†ç†è§£äº† RecordAccumulator çš„è®¾è®¡</p> <p><strong>æˆ‘ä»¬æ€»ç»“ä¸‹ä»“åº“é‡Œæœ‰ä»€ä¹ˆï¼š</strong></p> <ol><li>åˆ†æ‹£å‘˜</li> <li>è´§ç‰©</li> <li>ç›®çš„åœ°</li> <li>è´§ç®±</li> <li>è´§ç®±å †æ”¾åŒºåŸŸ</li></ol> <p>è®°ä½è¿™äº›æ¦‚å¿µï¼Œè¿™äº›ä»“åº“é‡Œçš„ä¸œè¥¿æœ€ç»ˆéƒ½ä¼šä½“ç°åœ¨ä»£ç é‡Œã€‚</p> <p>ä¸‹é¢æˆ‘ä»¬æ¥çœŸæ­£è®²è§£ RecordAccumulator çš„è®¾è®¡</p> <p>RecordAccumulator å®ç°äº†æ¥æ”¶æ¶ˆæ¯ï¼Œç„¶åä»¥ä¸»é¢˜åˆ†åŒºä¸ºå•å…ƒï¼ŒæŠŠæ¶ˆæ¯ä»¥ ProducerBatch ä¸ºå•ä½ç´¯ç§¯ç¼“å­˜ã€‚å¤šä¸ª ProducerBatch ä¿å­˜åœ¨ Deque é˜Ÿåˆ—ä¸­ã€‚å½“ Deque ä¸­æœ€æ–°çš„ batch å·²ä¸èƒ½å®¹çº³æ¶ˆæ¯æ—¶ï¼Œå°±ä¼šåˆ›å»ºæ–°çš„ batch æ¥ç»§ç»­ç¼“å­˜ï¼Œå¹¶å°†å…¶åŠ å…¥ Deque</p> <p>RecordAccumulatorç¼“å­˜æ¶ˆæ¯çš„å­˜å‚¨ç»“æ„å¦‚ä¸‹ï¼š</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409181549396.png" alt="image-20240918154916325"></p> <p>RecordAccumulatorå†…éƒ¨å­˜å‚¨æ¶ˆæ¯ä½¿ç”¨çš„å®¹å™¨æ˜¯<code>ConcurrentMap&lt;TopicPartition, Deque&lt;ProducerBatch&gt;&gt;</code>ï¼Œé€šè¿‡ä¸Šå›¾å¯ä»¥çœ‹åˆ°æ¶ˆæ¯ä»¥ä¸»é¢˜åˆ†åŒºåˆ’åˆ†å­˜å‚¨å•å…ƒã€‚æ¶ˆæ¯å®é™…æ˜¯æ”¾åœ¨ProducerBatchä¸­ã€‚ProducerBatchç›¸å½“äºä¸€ä¸ªä¸ªç®±å­ï¼Œç®±å­ä¸Šå†™ç€æ”¶ä»¶åœ°å€ï¼šxxä¸»é¢˜xxåˆ†åŒºã€‚å½“ä¸€ä¸ªProducerBatchç®±å­è£…æ»¡æ—¶ï¼Œå°±ä¼šå°ç®±è´´ä¸Šå°æ¡ï¼Œç„¶ååœ¨å¯¹åº”çš„é˜Ÿåˆ—é‡Œç”Ÿæˆä¸€ä¸ªæ–°çš„ProducerBatchï¼Œæ¥æ”¾ç½®æœ¬ä¸»é¢˜åˆ†åŒºæ–°çš„æ¶ˆæ¯ã€‚</p> <p>ç”±æ­¤å¯è§ï¼ŒRecordAccumulatorç´¯ç§¯æ¶ˆæ¯çš„è¿‡ç¨‹ï¼Œå°±æ˜¯æŠŠæ¶ˆæ¯è£…è¿›ä¸åŒæ”¶ä»¶åœ°å€ç®±å­ï¼ˆProducerBatchï¼‰ï¼Œè£…æ»¡å°ç®±ï¼Œå †æ”¾èµ·æ¥ï¼ˆåŠ å…¥<code>Deque&lt;ProducerBatch&gt;</code>ï¼‰ï¼Œç„¶åç»§ç»­äº§ç”Ÿæ–°ç®±å­è£…æ¶ˆæ¯çš„è¿‡ç¨‹ã€‚</p> <p>æ¯æ¬¡å°ç®±æ“ä½œåéƒ½ä¼šè¿”å› <em>å¯ä»¥å‘è´§</em> çš„ç»“æœç»™è°ƒç”¨è€…ï¼Œè°ƒç”¨è€… KafkaProducer å†å”¤é†’ sender æŠŠå·²ç»å°ç®±çš„ ProducerBatch å‘é€å‡ºå»</p> <p>å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ¶ˆæ¯çœŸå®å­˜å‚¨çš„åœ°æ–¹æ˜¯ DataOutputStreamã€‚ProducerBatch å†…éƒ¨æœ‰ä¸€ä¸ª MemoryRecordsBuilder å¯¹è±¡ï¼Œå›¾ä¸­æœªç”»ï¼Œè€ŒDataOutputStream åœ¨ MemoryRecordsBuilderä¸­ã€‚ä¸‰è€…å…³ç³»ï¼šProducerBatch--&gt;MemoryRecordsBuilder--&gt;DataOutputStreamã€‚</p> <p>æ¥ä¸‹æ¥å¯¹RecordAccumulatorçš„ä»£ç åˆ†æï¼Œä¸»è¦å›´ç»•ä»¥ä¸‹ä¸‰ä¸ªç±»ï¼š</p> <ul><li><p>RecordAccumulatorï¼šæ¶ˆæ¯ç´¯ç§¯å™¨çš„é¡¶å±‚é€»è¾‘ï¼Œç»´æŠ¤å­˜æ”¾æ¶ˆæ¯çš„å®¹å™¨</p></li> <li><p>ProducerBatchï¼šå°è£… MemoryRecordsBuilderï¼Œå¹¶ä¸”æœ‰å¾ˆå¤šæ§åˆ¶ç”¨çš„ä¿¡æ¯åŠç»Ÿè®¡ä¿¡æ¯</p></li> <li><p>MemoryRecordsBuilderï¼šæ¶ˆæ¯çœŸæ­£ç´¯ç§¯å­˜æ”¾çš„åœ°æ–¹</p></li></ul> <h2 id="recordaccumulator-ä»£ç åˆ†æ"><a href="#recordaccumulator-ä»£ç åˆ†æ" class="header-anchor">#</a> RecordAccumulator ä»£ç åˆ†æ</h2> <p>append()æ–¹æ³•æ˜¯ RecordAccumulator æš´éœ²çš„ç´¯ç§¯æ¶ˆæ¯å…¥å£ï¼ŒKafkaProducer é€šè¿‡æ­¤æ¥å£ç´¯ç§¯æ¶ˆæ¯ã€‚æˆ‘ä»¬ä¹Ÿå…ˆä»æ­¤æ–¹æ³•å¼€å§‹å±‚å±‚é€’è¿›ï¼Œåˆ†æç´¯ç§¯æ¶ˆæ¯çš„é€»è¾‘ã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">RecordAppendResult</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">TopicPartition</span> tp<span class="token punctuation">,</span>
                                 <span class="token keyword">long</span> timestamp<span class="token punctuation">,</span>
                                 <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span>
                                 <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value<span class="token punctuation">,</span>
                                 <span class="token class-name">Header</span><span class="token punctuation">[</span><span class="token punctuation">]</span> headers<span class="token punctuation">,</span>
                                 <span class="token class-name">Callback</span> callback<span class="token punctuation">,</span>
                                 <span class="token keyword">long</span> maxTimeToBlock<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token comment">// We keep track of the number of appending thread to make sure we do not miss batches in</span>
    <span class="token comment">// abortIncompleteBatches().</span>
    appendsInProgress<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>headers <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> headers <span class="token operator">=</span> <span class="token class-name">Record</span><span class="token punctuation">.</span><span class="token constant">EMPTY_HEADERS</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// check if we have an in-progress batch</span>
        <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProducerBatch</span><span class="token punctuation">&gt;</span></span> dq <span class="token operator">=</span> <span class="token function">getOrCreateDeque</span><span class="token punctuation">(</span>tp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">KafkaException</span><span class="token punctuation">(</span><span class="token string">&quot;Producer closed while send in progress&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">RecordAppendResult</span> appendResult <span class="token operator">=</span> <span class="token function">tryAppend</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> dq<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>appendResult <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> appendResult<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
        <span class="token comment">// we don't have an in-progress record batch try to allocate a new batch</span>
        <span class="token keyword">byte</span> maxUsableMagic <span class="token operator">=</span> apiVersions<span class="token punctuation">.</span><span class="token function">maxUsableProduceMagic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>batchSize<span class="token punctuation">,</span> <span class="token class-name">AbstractRecords</span><span class="token punctuation">.</span><span class="token function">estimateSizeInBytesUpperBound</span><span class="token punctuation">(</span>maxUsableMagic<span class="token punctuation">,</span> compression<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Allocating a new {} byte message buffer for topic {} partition {}&quot;</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> tp<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tp<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        buffer <span class="token operator">=</span> free<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> maxTimeToBlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Need to check if producer is closed again after grabbing the dequeue lock.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">KafkaException</span><span class="token punctuation">(</span><span class="token string">&quot;Producer closed while send in progress&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
            <span class="token class-name">RecordAppendResult</span> appendResult <span class="token operator">=</span> <span class="token function">tryAppend</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> dq<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>appendResult <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Somebody else found us a batch, return the one we waited for! Hopefully this doesn't happen often...</span>
                <span class="token keyword">return</span> appendResult<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
 
            <span class="token class-name">MemoryRecordsBuilder</span> recordsBuilder <span class="token operator">=</span> <span class="token function">recordsBuilder</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> maxUsableMagic<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ProducerBatch</span> batch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProducerBatch</span><span class="token punctuation">(</span>tp<span class="token punctuation">,</span> recordsBuilder<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">FutureRecordMetadata</span> future <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>batch<span class="token punctuation">.</span><span class="token function">tryAppend</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
            dq<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
            incomplete<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
            <span class="token comment">// Don't deallocate this buffer in the finally block as it's being used in the record batch</span>
            buffer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RecordAppendResult</span><span class="token punctuation">(</span>future<span class="token punctuation">,</span> dq<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">||</span> batch<span class="token punctuation">.</span><span class="token function">isFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            free<span class="token punctuation">.</span><span class="token function">deallocate</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        appendsInProgress<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li><code>appendsInProgress.incrementAndGet()</code>ï¼šé¦–å…ˆé€šè¿‡åŸå­æ“ä½œï¼ŒæŠŠè¿½åŠ æ¶ˆæ¯çš„çº¿ç¨‹è®¡æ•°å™¨+1</li> <li><code>Deque&lt;ProducerBatch&gt; dq = getOrCreateDeque(tp)</code>ï¼šè·å–ä¸»é¢˜åˆ†åŒºå¯¹åº”çš„ProducerBatché˜Ÿåˆ—ã€‚getOrCreateDequeæ–¹æ³•ä¸­åˆ¤æ–­å¦‚æœæ²¡æœ‰é˜Ÿåˆ—ï¼Œåˆ™æ–°å»ºé˜Ÿåˆ—ã€‚</li> <li><code>RecordAppendResult appendResult = tryAppend(timestamp, key, value, headers, callback, dq)</code>ï¼šåŒæ­¥ä»£ç å—ä¸­å°è¯•å»åšä¸€æ¬¡è¿½åŠ æ“ä½œ<code>tryAppend()</code>,å¦‚æœæˆåŠŸå°±ç›´æ¥è¿”å›è¿½åŠ çš„ç»“æœå¯¹è±¡ã€‚tryAppendæ–¹æ³•ä¸­é€»è¾‘æ˜¯ï¼š
<ol><li>å¦‚æœ dq ä¸­æœ‰ProducerBatch åˆ™å¾€æ–°ä¸€ä¸ªbatchä¸­è¿½åŠ 
<ol><li>è¿½åŠ ä¸æˆåŠŸï¼Œè¯´æ˜æœ€æ–°çš„batchç©ºé—´ä¸è¶³ï¼Œè¿”å›nullã€‚éœ€è¦å¤–å±‚é€»è¾‘åˆ›å»ºæ–°çš„batch</li> <li>è¿½åŠ æˆåŠŸï¼Œè¿”å›RecordAppendResult</li></ol></li> <li>dq ä¸­æ—  producerBatchï¼Œè¿”å›nullï¼Œä»£è¡¨æ²¡æœ‰èƒ½è¿½åŠ æˆåŠŸï¼šç¬¬ä¸€ä¸ªåˆ°è¾¾æ­¤æ–¹æ³•çš„çº¿ç¨‹è‚¯å®šæ˜¯è¿”å›äº†nullï¼Œå› ä¸ºè¿˜æ²¡æœ‰æ¶ˆæ¯ç´¯ç§¯è¿›æ¥ï¼Œä¹Ÿä¸å­˜åœ¨ProducerBatchå¯¹è±¡ã€‚å¦‚æœtryAppendè¿”å›nullï¼Œè¯´æ˜æ²¡èƒ½ç›´æ¥åœ¨ç°æœ‰çš„batchä¸Šè¿½åŠ æˆåŠŸï¼ˆä¹Ÿå¯èƒ½è¿˜æ²¡æœ‰batchï¼‰ï¼Œæ­¤æ—¶éœ€è¦åˆå§‹åŒ–æ–°çš„ProducerBatch</li></ol></li> <li>é¢„ä¼°sizeå¤§å°ï¼Œä» BufferPool ç”³è¯· ByteBufferï¼šå¦‚æœBufferPoolç©ºé—´ä¸è¶³å°±è½®è¯¢ç­‰å¾…ã€‚å¤§å®¶å¯ä»¥è‡ªå·±çœ‹ä¸€ä¸‹ BufferPool çš„ä»£ç ï¼Œè¿™é‡Œå°±ä¸å±•å¼€è®²äº†ï¼Œä»–çš„ç›®çš„æ˜¯æ§åˆ¶æ€»çš„å†…å­˜æ¶ˆè€—ä»¥åŠå®ç° ByteBuffer å¤ç”¨ã€‚</li> <li>å†æ¬¡tryAppendï¼šç”±äºç¬¬4æ­¥ä»£ç ä¸åœ¨åŒæ­¥ä»£ç å—ä¸­ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥çš„åŒæ­¥ä»£ç å—ä¸­ï¼Œé¦–å…ˆéœ€è¦å†æ¬¡è°ƒç”¨tryAppendï¼Œå› ä¸ºå¯èƒ½åˆ«çš„çº¿ç¨‹å·²ç»åˆ›å»ºäº†æœ¬ä¸»é¢˜åˆ†åŒºæ–°çš„ProducerBatchï¼Œé‚£ä¹ˆæ¶ˆæ¯ç›´æ¥è¿½åŠ æˆåŠŸ</li> <li>åˆ›å»ºProducerBatchï¼šå¦‚æœä¸Šä¸€æ­¥è¿”å›nullï¼Œè¯´æ˜è¿˜æ˜¯æ²¡æœ‰å¯ç”¨çš„ProducerBatchï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºæ–°çš„ProducerBatchã€‚é¦–å…ˆæ„å»ºMemoryRecordsBuilderå¯¹è±¡ï¼ŒçœŸæ­£åšæ¶ˆæ¯ç´¯åŠ çš„å°±æ˜¯è¿™ä¸ªå¯¹è±¡ï¼Œæ¯ä¸ª ProducerBatch éƒ½æœ‰ä¸€ä¸ª MemoryRecordsBuilder çš„å¼•ç”¨ã€‚</li> <li>çœŸæ­£å»è¿½åŠ æ¶ˆæ¯ï¼š
<ol><li>é¦–å…ˆè°ƒç”¨ProducerBatchçš„tryAppend()æ–¹æ³•ï¼Œè¿™æ˜¯çœŸæ­£åšæ¶ˆæ¯è¿½åŠ çš„åœ°æ–¹ï¼Œå†…éƒ¨é€šè¿‡MemoryRecordsBuilderå®ç°ã€‚åç»­å†è¯¦ç»†åˆ†æã€‚</li> <li>ç„¶åæŠŠæ–°çš„ProducerBatchæ”¾å…¥é˜Ÿåˆ—ä¸­</li></ol></li> <li>æŠŠbatchæ”¾å…¥incompleteé›†åˆï¼šincompleteæœ¬è´¨æ˜¯ä¸ªå­˜æ”¾æœªå®Œæˆå‘é€batchçš„Set</li> <li>é‡Šæ”¾BufferPoolç©ºé—´</li> <li>ç´¯ç§¯æ¶ˆæ¯å®Œæˆåçš„å¤„ç†ï¼šfinally ä»£ç å—ä¸­å†æœ€ç»ˆç¡®ä¿é‡Šæ”¾ BufferPool ç©ºé—´ï¼Œç„¶åé€šè¿‡åŸå­æ“ä½œæŠŠè¿½åŠ æ¶ˆæ¯çš„çº¿ç¨‹è®¡æ•°å™¨ -1</li></ol> <h3 id="tryappend"><a href="#tryappend" class="header-anchor">#</a> tryAppend</h3> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">RecordAppendResult</span> <span class="token function">tryAppend</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value<span class="token punctuation">,</span> <span class="token class-name">Header</span><span class="token punctuation">[</span><span class="token punctuation">]</span> headers<span class="token punctuation">,</span>
                                     <span class="token class-name">Callback</span> callback<span class="token punctuation">,</span> <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProducerBatch</span><span class="token punctuation">&gt;</span></span> deque<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ProducerBatch</span> last <span class="token operator">=</span> deque<span class="token punctuation">.</span><span class="token function">peekLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>last <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">FutureRecordMetadata</span> future <span class="token operator">=</span> last<span class="token punctuation">.</span><span class="token function">tryAppend</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>future <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            last<span class="token punctuation">.</span><span class="token function">closeForRecordAppends</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RecordAppendResult</span><span class="token punctuation">(</span>future<span class="token punctuation">,</span> deque<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">||</span> last<span class="token punctuation">.</span><span class="token function">isFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>é€»è¾‘ä¸Šæ–‡å·²ç»è®²è¿‡ï¼Œè¿™é‡Œå†å¯¹ç…§ä»£ç å¤šè¯´ä¸¤å¥ï¼š</p> <p>æ–¹æ³•å¦‚æœè¿”å›nullï¼Œè¯´æ˜æ²¡æœ‰å¯ä»¥æˆåŠŸè¿½åŠ æ­¤æ¶ˆæ¯çš„ProducerBatchï¼Œæœ‰ä¸¤ç§æƒ…å†µï¼š</p> <ol><li>dequeæ˜¯ç©ºçš„ï¼Œå¯èƒ½æ˜¯ç¬¬ä¸€æ¬¡è¢«è¿›å…¥ï¼Œä¹Ÿå¯èƒ½æ˜¯batchéƒ½è¢«å‘é€å®Œäº†ã€‚</li> <li>dequeå­˜åœ¨batchï¼Œä½†æ˜¯æ‰€å‰©ç©ºé—´å·²ç»ä¸è¶³ä»¥å®¹çº³æ­¤æ¶ˆæ¯ã€‚</li></ol> <p>å¦‚æœèƒ½å–å¾—é˜Ÿåˆ—ä¸­æœ€æ–°çš„batchï¼Œå¹¶ä¸”èƒ½å¤ŸæˆåŠŸè¿½åŠ æ¶ˆæ¯ï¼Œé‚£ä¹ˆå°±ä¼šè¿”å› RecordAppendResultã€‚</p> <p>appendæ–¹æ³•è¿”å›å¯¹è±¡RecordAppendResultï¼Œä»£ç å¦‚ä¸‹ï¼š</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">RecordAppendResult</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">FutureRecordMetadata</span> future<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> batchIsFull<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> newBatchCreated<span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token class-name">RecordAppendResult</span><span class="token punctuation">(</span><span class="token class-name">FutureRecordMetadata</span> future<span class="token punctuation">,</span> <span class="token keyword">boolean</span> batchIsFull<span class="token punctuation">,</span> <span class="token keyword">boolean</span> newBatchCreated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>future <span class="token operator">=</span> future<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>batchIsFull <span class="token operator">=</span> batchIsFull<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>newBatchCreated <span class="token operator">=</span> newBatchCreated<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°é‡Œé¢æœ‰å¼‚æ­¥å‘é€çš„Futureå¯¹è±¡ï¼Œæ­¤å¤–è¿˜æœ‰ä¸¤ä¸ªæ ‡è¯†ï¼ŒbatchIsFullä»£è¡¨batchæ˜¯å¦æ»¡äº†ï¼ŒnewBatchCreatedä»£è¡¨æ˜¯å¦æœ¬æ¬¡appendå¢åŠ äº†æ–°çš„batch</p> <p>å¤§å®¶æ˜¯å¦è¿˜è®°å¾—KafkaProducerè°ƒç”¨accumulatorçš„apendæ–¹æ³•åçš„é€»è¾‘æ˜¯ä»€ä¹ˆå—ï¼Ÿä¸è®°å¾—ä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œä»£ç å¦‚ä¸‹ï¼š</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>batchIsFull <span class="token operator">||</span> result<span class="token punctuation">.</span>newBatchCreated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Waking up the sender since topic {} partition {} is either full or getting a new batch&quot;</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>KafkaProduceré€šè¿‡è¿™ä¸¤ä¸ªæ ‡è¯†ä½æ¥å†³å®šæ˜¯å¦å”¤é†’senderã€‚ç¿»è¯‘è¿‡æ¥å°±æ˜¯ï¼Œâ€œå·²ç»æœ‰å°ç®±çš„æ¶ˆæ¯äº†ï¼senderå¿«ç‚¹æŠŠæ¶ˆæ¯å‘èµ°å§ï¼ä¸è¦å†ç¡äº†â€</p> <p>è®²åˆ°è¿™é‡Œï¼Œå…¶å®æ•´ä¸ªæ¶ˆæ¯è¿½åŠ çš„æµç¨‹å·²ç»è®²é€šäº†ã€‚ä¸è¿‡æ¶ˆæ¯è¿½åŠ çš„å…·ä½“å®ç°æˆ‘ä»¬è¿˜æ²¡æœ‰è®²è§£ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬è®²è§£å‘ç”Ÿæ¶ˆæ¯è¿½åŠ çš„çœŸæ­£åœ°æ–¹ï¼šProducerBatchå’ŒMemoryRecordsBuilderã€‚</p> <h2 id="producerbatchç±»åˆ†æ"><a href="#producerbatchç±»åˆ†æ" class="header-anchor">#</a> ProducerBatchç±»åˆ†æ</h2> <p>å‰æ–‡è¯´è¿‡ProducerBatchå¯ä»¥ç†è§£ä¸ºå­˜æ”¾æ¶ˆæ¯çš„å¤§è´§ç®±ã€‚æ­¤ç±»ä¸­çš„ä¸»è¦æ–¹æ³•æ˜¯ tryAppendï¼Œä¹Ÿå°±æ˜¯æŠŠæ¶ˆæ¯æ”¾å…¥ç®±å­çš„æ“ä½œï¼Œå®ƒæ˜¯æ¶ˆæ¯è¿½åŠ çš„é¡¶å±‚é€»è¾‘ï¼Œä»£ç å¦‚ä¸‹ï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">FutureRecordMetadata</span> <span class="token function">tryAppend</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value<span class="token punctuation">,</span> <span class="token class-name">Header</span><span class="token punctuation">[</span><span class="token punctuation">]</span> headers<span class="token punctuation">,</span> <span class="token class-name">Callback</span> callback<span class="token punctuation">,</span> <span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>recordsBuilder<span class="token punctuation">.</span><span class="token function">hasRoomFor</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> checksum <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>recordsBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maxRecordSize <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>maxRecordSize<span class="token punctuation">,</span> <span class="token class-name">AbstractRecords</span><span class="token punctuation">.</span><span class="token function">estimateSizeInBytesUpperBound</span><span class="token punctuation">(</span><span class="token function">magic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                recordsBuilder<span class="token punctuation">.</span><span class="token function">compressionType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>lastAppendTime <span class="token operator">=</span> now<span class="token punctuation">;</span>
        <span class="token class-name">FutureRecordMetadata</span> future <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureRecordMetadata</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>produceFuture<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>recordCount<span class="token punctuation">,</span>
                                                               timestamp<span class="token punctuation">,</span> checksum<span class="token punctuation">,</span>
                                                               key <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> key<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
                                                               value <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> value<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
                                                               <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token constant">SYSTEM</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// we have to keep every future returned to the users in case the batch needs to be</span>
        <span class="token comment">// split to several new batches and resent.</span>
        thunks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Thunk</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> future<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>recordCount<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> future<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸»è¦åšäº†ä¸‰ä»¶äº‹</p> <ol><li>æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿç©ºé—´å®¹çº³æ¶ˆæ¯ï¼Œè¿™æ˜¯é€šè¿‡è°ƒç”¨MemoryRecordsBuilderçš„hasRoomFor()æ–¹æ³•ã€‚</li> <li>è¿½åŠ æ¶ˆæ¯ï¼Œé€šè¿‡è°ƒç”¨MemoryRecordsBuilderçš„append()æ–¹æ³•</li> <li>ä¿å­˜å­˜æ”¾äº†callbackå’Œå¯¹åº”FutureRecordMetadataå¯¹è±¡çš„thunkåˆ°List<Thunk> thunksä¸­ã€‚</Thunk></li></ol> <p>å¦å¤–è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„æ–¹æ³•å°±æ˜¯closeForRecordAppends()ï¼Œå½“batchæ— ç©ºé—´å®¹çº³æ–°çš„æ¶ˆæ¯çš„æ—¶å€™ä¼šè°ƒç”¨æ­¤æ–¹æ³•å°ç®±ï¼Œè¿™é‡Œä¸å±•å¼€æ¥è®²ã€‚</p> <h2 id="memoryrecordsbuilderç±»åˆ†æ"><a href="#memoryrecordsbuilderç±»åˆ†æ" class="header-anchor">#</a> MemoryRecordsBuilderç±»åˆ†æ</h2> <p>è®²åˆ°è¿™é‡Œï¼Œç»ˆäºè®²åˆ°æ¶ˆæ¯è¿½åŠ çœŸæ­£è½åœ°çš„åœ°æ–¹äº†ã€‚æ¯ä¸ªProducerBatchéƒ½ç»´æŠ¤äº†ä¸€ä¸ªMemoryRecordsBuilderã€‚ProducerBatchè¿½åŠ æ¶ˆæ¯ï¼Œå®é™…æ˜¯è°ƒç”¨MemoryRecordsBuilderå®Œæˆçš„ã€‚</p> <p>æ¶ˆæ¯æœ€ç»ˆé€šè¿‡MemoryRecordsBuilderçš„appendæ–¹æ³•ï¼Œè¿½åŠ åˆ°MemoryRecordsBuilderçš„DataOutputStreamä¸­ã€‚</p> <p>ä¸Šä¸€èŠ‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒæœ‰ä¸¤ä¸ªä¸»è¦çš„æ–¹æ³•hasRoomFor()å’Œappend()ã€‚</p> <ol><li><p>hasRoomFor()ï¼šè¿™ä¸ªæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œé€šè¿‡è®¡ç®—æ¶ˆæ¯çš„é¢„ä¼°å¤§å°ï¼Œä»¥åŠå‰©ä½™ç©ºé—´ï¼Œè¿”å›trueæˆ–è€…falseã€‚ä»£ç å°±ä¸è´´äº†ï¼Œæ„Ÿå…´è¶£çš„è¯è‡ªè¡ŒæŸ¥çœ‹</p></li> <li><p>append()ï¼šè¿™ä¸ªæ–¹æ³•æˆ‘ä»¬éœ€è¦ä»”ç»†åˆ†æä¸€ä¸‹ï¼Œæ¶ˆæ¯çš„è¿½åŠ æœ€ç»ˆå‘ç”Ÿåœ¨è¿™é‡Œã€‚æˆ‘å…ˆç®€è¿°ä¸‹é€»è¾‘ï¼š</p> <ul><li>æŠŠå­—èŠ‚æ•°ç»„å½¢å¼çš„keyå’Œvalueè½¬ä¸ºHeapByteBuffer</li> <li>è®¡ç®—å†™å…¥çš„offsetï¼Œå¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡å†™å…¥ï¼Œé‚£ä¹ˆlastOffset+1ï¼Œå¦åˆ™æ˜¯ baseOffset</li> <li>å¦‚æœmagicå·å¤§äº1ï¼Œé‚£ä¹ˆè°ƒç”¨appendDefaultRecord()ï¼Œå¦åˆ™è°ƒç”¨ appendLegacyRecord()</li></ul></li></ol> <p>æˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹appendDefaultRecord()æ–¹æ³•ï¼Œåœ¨æ­¤æ–¹æ³•ä¸­æœ€ç»ˆè°ƒç”¨äº†DefaultRecord.writeTo()æ¥å†™å…¥appendStream</p> <p>æœ€ååšæ£€æŸ¥ï¼Œæ›´æ–°ä¸€äº›ç»Ÿè®¡çŠ¶æ€ï¼Œå¦‚æ¶ˆæ¯çš„æ•°é‡ã€lastOffsetç­‰ã€‚</p> <p>åœ¨DefaultRecord.writeTo()æ–¹æ³•ä¸­ï¼Œé€šè¿‡è°ƒç”¨Utils.writeTo(DataOutput out, ByteBuffer buffer, int length)ï¼Œå¾€appendStreamå†™å…¥keyï¼Œvalueï¼Œheaderã€‚</p> <p>Utils.writeTo()ä»£ç å¦‚ä¸‹ï¼š</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">hasArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> buffer<span class="token punctuation">.</span><span class="token function">arrayOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> pos <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> pos<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length <span class="token operator">+</span> pos<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        out<span class="token punctuation">.</span><span class="token function">writeByte</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹MemoryRecordsBuilderï¼š</p> <ul><li>å®ƒå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªbufferï¼Œå¹¶è®°å½•èƒ½å†™å…¥çš„å¤§å°ï¼Œä»¥åŠå†™å…¥çš„ä½ç½®åœ¨å“ªé‡Œ</li> <li>è€Œæ¯æ¡æ¶ˆæ¯éƒ½è¢«è¿½åŠ åˆ°DataOutputå¯¹è±¡appendStreamä¸­</li> <li>appendStreamæ˜¯æ¶ˆæ¯åœ¨RecordAccumulatorä¸­æœ€ç»ˆçš„å»å¤„</li></ul> <h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="header-anchor">#</a> æ€»ç»“</h2> <p>è‡³æ­¤ï¼Œå¯¹RecordAccumulatorçš„è®²è§£å°±ç»“æŸäº†ï¼Œå…¶å®åªæ˜¯ç»“æŸäº†è¿½åŠ æ¶ˆæ¯éƒ¨åˆ†ï¼Œæœ¬ç‰‡åšå®¢çš„è®²è§£èŒƒå›´é™äºæ­¤ã€‚åœ¨senderè®²è§£ä¸­æˆ‘ä»¬å†ç»§ç»­è®²è§£RecordAccumulatorå¦å¤–çš„å†…å®¹ã€‚</p> <p>æœ€åæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ï¼š</p> <ol><li><p>RecordAccumulatorä½¿ç”¨ProducerBatchç¼“å­˜æ¶ˆæ¯ã€‚æ¯ä¸ªä¸»é¢˜åˆ†åŒºæ‹¥æœ‰ä¸€ä¸ªProducerBatchçš„é˜Ÿåˆ—ã€‚</p></li> <li><p>å½“ProducerBatché˜Ÿåˆ—çš„é˜Ÿå°¾batchä¸èƒ½å†å®¹çº³æ–°æ¶ˆæ¯æ—¶ï¼Œå¯¹å…¶è¿›è¡Œå°ç®±æ“ä½œï¼ŒåŒæ—¶æ–°å»ºProducerBatchæ”¾å…¥é˜Ÿå°¾æ¥å­˜æ”¾æ–°æ¶ˆæ¯ã€‚</p></li> <li><p>ProducerBatchå¯¹æ¶ˆæ¯è¿½åŠ çš„æ“ä½œéƒ½æ˜¯é€šè¿‡MemoryRecordsBuilderè¿›è¡Œçš„ã€‚æ¶ˆæ¯æœ€ç»ˆè¢«è¿½åŠ åˆ°MemoryRecordsBuilderä¸­çš„DataOutputStream appendStreamä¸­</p></li></ol> <h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="header-anchor">#</a> å‚è€ƒèµ„æ–™</h2> <ul><li><a href="https://blog.csdn.net/liyiming2017/article/details/88976535" target="_blank" rel="noopener noreferrer">ä½ ç»å¯¹èƒ½çœ‹æ‡‚çš„Kafkaæºä»£ç åˆ†æ-RecordAccumulatorç±»ä»£ç åˆ†æ_kafka listenablefuturecallback-CSDNåšå®¢<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/echo-lxy/echo-system-design/edit/master/docs/02.Kafka  ç³»ç»Ÿè®¾è®¡/06.ä¸‰ã€ä¸»çº¿ä»»åŠ¡/500.ã€Œç”Ÿäº§è€…ã€æºç åˆ†æ/20.RecordAccumulator æºç åˆ†æ.md" target="_blank" rel="noopener noreferrer">ç¼–è¾‘</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°äº:</span> <span class="time">2024/09/18, 11:29:27</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        â†
        <a href="/pages/32a8ff/" class="prev">Kafka Producer æºç åˆ†æ</a></span> <span class="next"><a href="/pages/bf1d55/">Sender ç±»ä»£ç åˆ†æ</a>â†’
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:lixinyang2002@163.com" title="å‘é‚®ä»¶" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/echo-lxy" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="å¬éŸ³ä¹" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="æœ¬ç«™ä¸»é¢˜">Vdoing</a> 
    | Copyright Â© 2024-2024
    <span>Xinyang Li | MIT License</span></div> <div class="buttons"><div title="è¿”å›é¡¶éƒ¨" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="å»è¯„è®º" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ä¸»é¢˜æ¨¡å¼" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          è·Ÿéšç³»ç»Ÿ
        </li><li class="iconfont icon-rijianmoshi">
          æµ…è‰²æ¨¡å¼
        </li><li class="iconfont icon-yejianmoshi">
          æ·±è‰²æ¨¡å¼
        </li><li class="iconfont icon-yuedu">
          é˜…è¯»æ¨¡å¼
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.902083d3.js" defer></script><script src="/assets/js/2.933750c6.js" defer></script><script src="/assets/js/23.4f896de4.js" defer></script><script src="/assets/js/7.7eb70372.js" defer></script>
  </body>
</html>
