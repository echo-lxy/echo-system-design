<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>AOF цМБф╣ЕхМЦ | Echo ч│╗ч╗Яшо╛шобф╣Лч╛О</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="ц░┤ц╗┤чЯ│чй┐я╝Мшо╛шобцЧащУ╢х╝╣">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.d5131fc0.css" as="style"><link rel="preload" href="/assets/js/app.f2d21572.js" as="script"><link rel="preload" href="/assets/js/2.933750c6.js" as="script"><link rel="preload" href="/assets/js/55.0b3f6288.js" as="script"><link rel="preload" href="/assets/js/7.7eb70372.js" as="script"><link rel="prefetch" href="/assets/js/10.2cc95be8.js"><link rel="prefetch" href="/assets/js/11.c7521a10.js"><link rel="prefetch" href="/assets/js/12.38d1989d.js"><link rel="prefetch" href="/assets/js/13.850793b0.js"><link rel="prefetch" href="/assets/js/14.1141ec27.js"><link rel="prefetch" href="/assets/js/15.13af8159.js"><link rel="prefetch" href="/assets/js/16.ad3bea63.js"><link rel="prefetch" href="/assets/js/17.5a68d813.js"><link rel="prefetch" href="/assets/js/18.84260b8a.js"><link rel="prefetch" href="/assets/js/19.028e1bb1.js"><link rel="prefetch" href="/assets/js/20.955beaf3.js"><link rel="prefetch" href="/assets/js/21.a4ec6789.js"><link rel="prefetch" href="/assets/js/22.464f596d.js"><link rel="prefetch" href="/assets/js/23.97c2ce00.js"><link rel="prefetch" href="/assets/js/24.3a2179f2.js"><link rel="prefetch" href="/assets/js/25.075fd9bb.js"><link rel="prefetch" href="/assets/js/26.ef7c5123.js"><link rel="prefetch" href="/assets/js/27.1f8b0123.js"><link rel="prefetch" href="/assets/js/28.d08a522a.js"><link rel="prefetch" href="/assets/js/29.18c8678e.js"><link rel="prefetch" href="/assets/js/3.d9533589.js"><link rel="prefetch" href="/assets/js/30.3f433e84.js"><link rel="prefetch" href="/assets/js/31.15ca8a18.js"><link rel="prefetch" href="/assets/js/32.74b84122.js"><link rel="prefetch" href="/assets/js/33.666ec040.js"><link rel="prefetch" href="/assets/js/34.23b5a54e.js"><link rel="prefetch" href="/assets/js/35.a1d45756.js"><link rel="prefetch" href="/assets/js/36.fb32ac6c.js"><link rel="prefetch" href="/assets/js/37.5fa53855.js"><link rel="prefetch" href="/assets/js/38.7ef093e6.js"><link rel="prefetch" href="/assets/js/39.adc3da8c.js"><link rel="prefetch" href="/assets/js/4.73518a0f.js"><link rel="prefetch" href="/assets/js/40.9297d7be.js"><link rel="prefetch" href="/assets/js/41.f854da14.js"><link rel="prefetch" href="/assets/js/42.a3dec7b1.js"><link rel="prefetch" href="/assets/js/43.11adcd97.js"><link rel="prefetch" href="/assets/js/44.08548d28.js"><link rel="prefetch" href="/assets/js/45.06bf6ea9.js"><link rel="prefetch" href="/assets/js/46.30106f5c.js"><link rel="prefetch" href="/assets/js/47.a1e84b31.js"><link rel="prefetch" href="/assets/js/48.3df6ec9e.js"><link rel="prefetch" href="/assets/js/49.79cca35e.js"><link rel="prefetch" href="/assets/js/5.dd198b3d.js"><link rel="prefetch" href="/assets/js/50.f367f440.js"><link rel="prefetch" href="/assets/js/51.05b538b7.js"><link rel="prefetch" href="/assets/js/52.778a3aa1.js"><link rel="prefetch" href="/assets/js/53.40c564d3.js"><link rel="prefetch" href="/assets/js/54.22dee2f4.js"><link rel="prefetch" href="/assets/js/56.68c3da57.js"><link rel="prefetch" href="/assets/js/57.d650dc6d.js"><link rel="prefetch" href="/assets/js/58.114af48b.js"><link rel="prefetch" href="/assets/js/59.902987aa.js"><link rel="prefetch" href="/assets/js/6.0b558b79.js"><link rel="prefetch" href="/assets/js/8.0ec7f6e8.js"><link rel="prefetch" href="/assets/js/9.6e274fca.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d5131fc0.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="чЫох╜Х" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="Echo ч│╗ч╗Яшо╛шобф╣Лч╛О" class="logo"> <span class="site-name can-hide">Echo ч│╗ч╗Яшо╛шобф╣Лч╛О</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">ЁЯПащжЦщб╡</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">тЬТя╕ПчГнщЧичоЧц│Х</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ч│╗ч╗Яшо╛шоб</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/84cb49/" class="nav-link">шо╛шобхЯ║чбАшо╛цЦ╜</a></li><li class="dropdown-item"><!----> <a href="/pages/a95d7d/" class="nav-link">шо╛шобчГнщЧих║ФчФи</a></li><li class="dropdown-item"><!----> <a href="/pages/def08a/" class="nav-link">хЬ║цЩпшо╛шоб</a></li></ul></div></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">тЭУщЧочнФ</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ЁЯСАхКицАБ</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">ЁЯПащжЦщб╡</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">тЬТя╕ПчГнщЧичоЧц│Х</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯОЦя╕Пш╡ПцЮРч╗ПхЕ╕</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka ч│╗ч╗Яшо╛шоб</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx ч│╗ч╗Яшо╛шоб</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб" class="dropdown-title"><!----> <span class="title" style="display:;">ЁЯзСтАНЁЯТ╗хоЮцИШч│╗ч╗Яшо╛шоб</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/84cb49/" class="nav-link">шо╛шобхЯ║чбАшо╛цЦ╜</a></li><li class="dropdown-item"><!----> <a href="/pages/a95d7d/" class="nav-link">шо╛шобчГнщЧих║ФчФи</a></li><li class="dropdown-item"><!----> <a href="/pages/def08a/" class="nav-link">хЬ║цЩпшо╛шоб</a></li></ul></div></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">тЭУщЧочнФ</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ЁЯСАхКицАБ</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>хЙНшиА</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>хЯ║чбА</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ф╕╗ч║┐</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>цФпч║┐</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/b43a19/" class="sidebar-link">LRU чнЦчХе</a></li><li><a href="/pages/b43a89/" class="sidebar-link">LFU чнЦчХе</a></li><li><a href="/pages/f44fbe/" class="sidebar-link">Redis ш┐ЗцЬЯчнЦчХе</a></li><li><a href="/pages/9b17a6/" class="sidebar-link">RDB цМБф╣ЕхМЦ</a></li><li><a href="/pages/9b17a7/" aria-current="page" class="active sidebar-link">AOF цМБф╣ЕхМЦ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/9b17a7/#хЙНшиА" class="sidebar-link">хЙНшиА</a></li><li class="sidebar-sub-header level2"><a href="/pages/9b17a7/#aof-ца╕х┐Гц╡БчиЛ" class="sidebar-link">AOF ца╕х┐Гц╡БчиЛ</a></li><li class="sidebar-sub-header level2"><a href="/pages/9b17a7/#aof-щЗНхЖЩ" class="sidebar-link">AOF щЗНхЖЩ</a></li><li class="sidebar-sub-header level2"><a href="/pages/9b17a7/#ц╖▒хЕещЗНхЖЩч╝УхЖ▓хМ║" class="sidebar-link">ц╖▒хЕещЗНхЖЩч╝УхЖ▓хМ║</a></li><li class="sidebar-sub-header level2"><a href="/pages/9b17a7/#цА╗ч╗У" class="sidebar-link">цА╗ч╗У</a></li></ul></li><li><a href="/pages/aa75e9/" class="sidebar-link">Redis ф╕нчЪДх╗╢ш┐ЯчЫСцОз</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>щЫЖч╛д</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="щжЦщб╡" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>Redis ч│╗ч╗Яшо╛шоб</span></li><li data-v-06225672><span data-v-06225672>цФпч║┐</span></li></ul> <div class="info" data-v-06225672><div title="ф╜ЬшАЕ" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/brother-one" target="_blank" title="ф╜ЬшАЕ" class="beLink" data-v-06225672>echo</a></div> <div title="хИЫх╗║цЧ╢щЧ┤" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-09-16</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">чЫох╜Х</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">AOF цМБф╣ЕхМЦ<!----></h1> <div class="page-slot page-slot-top">
    <div class="wwads-cn wwads-horizontal page-wwads" data-id="136"></div>
    <style>
      .page-wwads{
        width:100%!important;
        min-height: 0;
        margin: 0;
      }
      .page-wwads .wwads-img img{
        width:80px!important;
      }
      .page-wwads .wwads-poweredby{
        width: 40px;
        position: absolute;
        right: 25px;
        bottom: 3px;
      }
      .wwads-content .wwads-text, .page-wwads .wwads-text{
        height: 100%;
        padding-top: 5px;
        display: block;
      }
  </style>
  </div> <div class="theme-vdoing-content content__default"><div class="custom-block note"><p class="custom-block-title">цПРхЗ║щЧощвШцШпф╕АхИЗцЩ║цЕзчЪДх╝Ачлп</p> <ol><li>AOF щЗНхЖЩф╝ЪхЬиф╗Аф╣ИцЭбф╗╢ф╕ЛшзжхПСя╝Яш┐Щф║ЫцЭбф╗╢хжВф╜Хх╜▒хУН Redis цАзшГ╜я╝Я</li> <li>хЬи AOF щЗНхЖЩцЧ╢я╝МRedis хжВф╜Хчбоф┐ЭцЦ░чЪДхЖЩцУНф╜Ьф╕Нф╝Ъф╕вхд▒я╝Я</li> <li>ф╕║ф╗Аф╣И Redis шжБхЬи AOF щЗНхЖЩф╕нф╜┐чФичобщБУщАЪф┐бя╝Яш┐Щф╕кцЬ║хИ╢шзгхЖ│ф║ЖхУкф║ЫщЧощвШя╝Я</li> <li>хН│ф╜┐цУНф╜Ьч│╗ч╗Яц▓бхоХцЬ║я╝Мф╕║ф╗Аф╣ИхЬи AOF цибх╝Пф╕Лф╗НхПпшГ╜хнШхЬицХ░цНоф╕вхд▒щгОщЩйя╝Я</li> <li>AOF щЗНхЖЩхжВф╜Хчбоф┐ЭхЖЩхЕецЧех┐ЧчЪДхоМцХ┤цАзя╝ЯхнРш┐ЫчиЛцШпцАОф╣ИхдДчРЖцЦ░чЪДхЖЩцУНф╜ЬчЪДя╝Я</li> <li>хЬиф╗Аф╣ИцГЕхЖ╡ф╕Ля╝МAOF щЗНхЖЩхПпшГ╜ф╝Ъхп╝шЗ┤ Redis цАзшГ╜хПШцЕвя╝Я</li> <li><code>always</code> цибх╝Пф╕Ля╝МцХ░цНоф╕║ф╗Аф╣Иш┐ШхПпшГ╜ф╕вхд▒я╝ЯхжВф╜Хх╣│шбб AOF чЪДцАзшГ╜ф╕ОхоЙхЕия╝Я</li> <li>х╜У Redis хПШцЕвцЧ╢я╝МхжВф╜ХхИдцЦнцШпхРжцШп AOF щЗНхЖЩхп╝шЗ┤чЪДя╝Я</li></ol></div> <h2 id="хЙНшиА"><a href="#хЙНшиА" class="header-anchor">#</a> хЙНшиА</h2> <p>цИСф╗мчЯещБУя╝МRedis щЩдф║Жф╜┐чФихЖЕхнШх┐лчЕз RDB цЭеф┐ЭшпБцХ░цНохПпщЭацАзф╣ЛхдЦя╝Мш┐ШхПпф╗еф╜┐чФи AOF цЧех┐ЧуАВф╕Нш┐Зя╝МRDB цЦЗф╗╢цШпх░ЖцЯРф╕АцЧ╢хИ╗чЪДхЖЕхнШцХ░цНоф┐ЭхнШцИРф╕Аф╕кцЦЗф╗╢я╝МшАМ AOF цЧех┐ЧхИЩф╝Ъшо░х╜ХцОецФ╢хИ░чЪДцЙАцЬЙхЖЩцУНф╜ЬуАВхжВцЮЬ Redis server чЪДхЖЩшп╖ц▒Вх╛ИхдЪя╝МщВгф╣И AOF цЧех┐Чф╕ншо░х╜ХчЪДцУНф╜Ьф╣Яф╝Ъш╢КцЭеш╢КхдЪя╝Мш┐ЫшАМх░▒хп╝шЗ┤ AOF цЧех┐ЧцЦЗф╗╢ш╢КцЭеш╢КхдзуАВ</p> <p>чД╢хРОя╝Мф╕║ф║ЖщБ┐хЕНф║зчФЯш┐ЗхдзчЪД AOF цЧех┐ЧцЦЗф╗╢я╝МRedis ф╝Ъхп╣ AOF цЦЗф╗╢ш┐ЫшбМщЗНхЖЩя╝Мф╣Ях░▒цШпщТИхп╣х╜УхЙНцХ░цНох║Уф╕нцпПф╕кщФохА╝хп╣чЪДцЬАцЦ░хЖЕхо╣я╝Мшо░х╜ХхоГчЪДцПТхЕецУНф╜Ья╝МшАМф╕НхЖНшо░х╜ХхоГчЪДхОЖхП▓хЖЩцУНф╜Ьф║ЖуАВш┐Щца╖ф╕АцЭея╝МщЗНхЖЩхРОчЪД AOF цЧех┐ЧцЦЗф╗╢х░▒шГ╜хПШх░Пф║ЖуАВ</p> <p><strong>щВгф╣Ия╝МAOF щЗНхЖЩхЬихУкф║ЫцЧ╢хАЩф╝ЪшвлшзжхПСхСвя╝Яф╗ехПК AOF щЗНхЖЩщЬАшжБхЖЩцЦЗф╗╢я╝Мш┐Щф╕кш┐ЗчиЛф╝ЪщШ╗хбЮ Redis чЪДф╕╗ч║┐чиЛя╝Мш┐ЫшАМх╜▒хУН Redis чЪДцАзшГ╜хРЧя╝Я</strong></p> <p>echo цОеф╕ЛцЭех░▒ч╗Щф╜аф╗Лч╗Нф╕Л AOF ца╕х┐Гц╡БчиЛф╗ехПКщЗНхЖЩчЪДхоЮчО░ш┐ЗчиЛя╝МщАЪш┐Зф║ЖшзгхоГчЪДхоЮчО░я╝МцИСф╗мх░▒хПпф╗ец╕ЕцеЪхЬ░ф║ЖшзгхИ░ AOF щЗНхЖЩш┐ЗчиЛчЪДшбичО░я╝Мф╗ехПКхоГхп╣ Redis server чЪДх╜▒хУНуАВш┐Щца╖я╝Мх╜Уф╜ахЖНщБЗхИ░ Redis server цАзшГ╜хПШцЕвчЪДщЧощвШцЧ╢я╝Мф╜ах░▒хПпф╗ецОТцЯецШпхРжцШп AOF щЗНхЖЩхп╝шЗ┤чЪДф║ЖуАВ</p> <p>хе╜я╝МцОеф╕ЛцЭея╝МцИСф╗мхЕИцЭечЬЛф╕Л AOF ца╕х┐Гц╡БчиЛ</p> <h2 id="aof-ца╕х┐Гц╡БчиЛ"><a href="#aof-ца╕х┐Гц╡БчиЛ" class="header-anchor">#</a> AOF ца╕х┐Гц╡БчиЛ</h2> <p>AOF цМБф╣ЕхМЦхИЖф╕║ф╕Йф╕кцнещкд</p> <ul><li>хС╜ф╗дш┐╜хКа</li> <li>цЦЗф╗╢хЖЩхЕе</li> <li>цЦЗф╗╢хРМцне</li></ul> <h3 id="хС╜ф╗дш┐╜хКа"><a href="#хС╜ф╗дш┐╜хКа" class="header-anchor">#</a> хС╜ф╗дш┐╜хКа</h3> <p>х╜У AOF цМБф╣ЕхМЦхКЯшГ╜хдДф║ОцЙУх╝АчК╢цАБцЧ╢я╝МцЬНхКбхЩихЬицЙзшбМхоМф╕Аф╕кхЖЩхС╜ф╗дф╣ЛхРОя╝Мф╝Ъф╗ехНПшооца╝х╝Пх░ЖшвлцЙзшбМчЪДхЖЩхС╜ф╗дш┐╜хКахИ░цЬНхКбхЩичК╢цАБчЪД aof buf ч╝УхЖ▓хМ║чЪДцЬлх░╛</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisServer</span><span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token comment">//AOF ч╝УхЖ▓хМ║</span>
	SDS aof_buf<span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="хЖЩхЕеф╕ОхРМцне"><a href="#хЖЩхЕеф╕ОхРМцне" class="header-anchor">#</a> хЖЩхЕеф╕ОхРМцне</h3> <p>Redis чЪДцЬНхКбхЩиш┐ЫчиЛх░▒цШпф╕Аф╕кф║Лф╗╢х╛кчОпя╝Мш┐Щф╕кх╛кчОпф╕нчЪДцЦЗф╗╢ф║Лф╗╢ш┤Яш┤гцОецФ╢ховцИ╖члпчЪДхС╜ф╗дшп╖ц▒Вя╝Мф╗ехПКхРСховцИ╖члпхПСщАБхС╜ф╗дхЫЮхдНя╝МшАМцЧ╢щЧ┤ф║Лф╗╢хИЩш┤Яш┤гцЙзшбМхГП servercron хЗ╜цХ░ш┐Щца╖щЬАшжБхоЪцЧ╢ш┐РшбМчЪДхЗ╜цХ░</p> <p>хЫаф╕║цЬНхКбхЩихЬихдДчРЖцЦЗф╗╢ф║Лф╗╢цЧ╢хПпшГ╜ф╝ЪцЙзшбМхЖЩхС╜ф╗дя╝Мф╜┐х╛Чф╕Аф║ЫхЖЕхо╣швлш┐╜хКахИ░ aof buf ч╝УхЖ▓хМ║щЗМщЭвя╝МцЙАф╗ехЬицЬНхКбхЩицпПцмбч╗УцЭЯф╕Аф╕кф║Лф╗╢х╛кчОпф╣ЛхЙНя╝МхоГщГ╜ф╝Ъш░ГчФи flushAppendonlyFile хЗ╜цХ░я╝МшАГшЩСцШпхРжщЬАшжБх░Ж aof buf ч╝УхЖ▓хМ║ф╕нчЪДхЖЕхо╣хЖЩхЕехТМф┐ЭхнШхИ░ AOF цЦЗф╗╢щЗМщЭвя╝Мш┐Щф╕кш┐ЗчиЛчЪДф╝кф╗гчаБхжВф╕Л</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">eventloop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token comment"># хЬихдДчРЖхС╜ф╗дшп╖ц▒ВцЧ╢хПпшГ╜ф╝ЪцЬЙцЦ░хЖЕхо╣швлш┐╜хКахИ░ aof_buf ч╝УхЖ▓хМ║ф╕н</span>
		processFileEvents<span class="token punctuation">(</span><span class="token punctuation">)</span>
		pricessTimeEvents<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># шАГшЩСцШпхРжх░Ж aof_buf ф╕нчЪДхЖЕхо╣хЖЩхЕехТМф┐ЭхнШхИ░ AOF цЦЗф╗╢щЗМ</span>
		flushAppendOnlyFile<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>flushAppendOnlyFile чЪДшбМф╕║чФ▒хЬи redis.conf ф╕нчЪД <code>appendfsync</code>щАЙщб╣чЪДхА╝цЭехЖ│хоЪ</p> <table><thead><tr><th><code>appendfsync</code> щАЙщб╣чЪДхА╝</th> <th><code>flushAppendOnlyFile</code> хЗ╜цХ░шбМф╕║</th></tr></thead> <tbody><tr><td><code>always</code></td> <td>х░Ж AOF ч╝УхЖ▓хМ║ф╕нчЪДцЙАцЬЙхЖЕхо╣хЖЩхЕех╣╢хРМцнехИ░ AOF цЦЗф╗╢уАВ</td></tr> <tr><td><code>everysec</code></td> <td>х░Ж AOF ч╝УхЖ▓хМ║ф╕нчЪДцЙАцЬЙхЖЕхо╣хЖЩхЕехИ░ AOF цЦЗф╗╢я╝МхжВцЮЬф╕КцмбхРМцне AOF цЦЗф╗╢чЪДцЧ╢щЧ┤ш╖Эчж╗чО░хЬиш╢Еш┐Зф╕АчзТщТЯя╝МщВгф╣ИхЖНцмбхп╣ AOF цЦЗф╗╢ш┐ЫшбМхРМцнея╝Мх╣╢ф╕Фш┐Щф╕кхРМцнецУНф╜ЬцШпчФ▒ф╕Аф╕кч║┐чиЛф╕УщЧиш┤Яш┤гцЙзшбМчЪДуАВ</td></tr> <tr><td><code>no</code></td> <td>х░Ж AOF ч╝УхЖ▓хМ║ф╕нчЪДцЙАцЬЙхЖЕхо╣хЖЩхЕехИ░ AOF цЦЗф╗╢я╝Мф╜Жх╣╢ф╕Нхп╣ AOF цЦЗф╗╢ш┐ЫшбМхРМцнея╝Мф╜ХцЧ╢хРМцнечФ▒цУНф╜Ьч│╗ч╗ЯцЭехЖ│хоЪуАВ</td></tr></tbody></table> <p>щ╗ШшодхА╝цШп everysec</p> <div class="custom-block tip"><p class="custom-block-title">цЦЗф╗╢чЪДхЖЩхЕехТМхРМцне</p> <p>ф╕║ф║ЖцПРщлШцЦЗф╗╢чЪДхЖЩхЕецХИчОЗя╝МхЬичО░ф╗гцУНф╜Ьч│╗ч╗Яф╕ня╝Мх╜УчФицИ╖ш░ГчФи write хЗ╜цХ░я╝Мх░Жф╕Аф║ЫцХ░цНохЖЩхЕехИ░цЦЗф╗╢чЪДцЧ╢хАЩя╝МцУНф╜Ьч│╗ч╗ЯщАЪх╕╕ф╝Ъх░ЖхЖЩхЕецХ░цНоцЪВцЧ╢ф┐ЭхнШхЬиф╕Аф╕кхЖЕхнШч╝УхЖ▓хМ║щЗМщЭвчнЙхИ░ч╝УхЖ▓хМ║чЪДчй║щЧ┤швлхблц╗буАБцИЦшАЕш╢Еш┐Зф║ЖцМЗхоЪчЪДцЧ╢щЩРф╣ЛхРОя╝МцЙНчЬЯцнгхЬ░х░Жч╝УхЖ▓хМ║ф╕нчЪДцХ░цНохЖЩхЕехИ░чгБчЫШщЗМщЭвуАВ
ш┐ЩчзНхБЪц│ХшЩ╜чД╢цПРщлШф║ЖцХИчОЗя╝Мф╜Жф╣Яф╕║хЖЩхЕецХ░цНох╕жцЭеф║ЖхоЙхЕищЧощвШя╝МхЫаф╕║хжВцЮЬшобчоЧцЬ║хПСчФЯхБЬцЬ║я╝МщВгф╣Иф┐ЭхнШхЬихЖЕхнШч╝УхЖ▓хМ║щЗМщЭвчЪДхЖЩхЕецХ░цНох░Жф╝Ъф╕вхд▒уАВ
ф╕║цндя╝Мч│╗ч╗ЯцПРф╛Ыф║Ж fsync хТМ fdatasync ф╕дф╕кхРМцнехЗ╜цХ░я╝МхоГф╗мхПпф╗ех╝║хИ╢шойцУНф╜Ьч│╗ч╗ЯчлЛхН│х░Жч╝УхЖ▓хМ║ф╕нчЪДцХ░цНохЖЩхЕехИ░чбмчЫШщЗМщЭвя╝Мф╗ОшАМчбоф┐ЭхЖЩхЕецХ░цНочЪДхоЙхЕицАз</p></div> <p>хжВцЮЬш┐ЩцЧ╢ flushAppendonlyFile хЗ╜цХ░швлш░ГчФия╝МхБЗшо╛цЬНхКбхЩих╜УхЙН appendfsyne щАЙщб╣чЪДхА╝ф╕║ everysecя╝Мх╣╢ф╕Фш╖Эчж╗ф╕КцмбхРМцне AOF цЦЗф╗╢х╖▓ч╗Пш╢Еш┐Зф╕АчзТщТЯя╝МщВгф╣ИцЬНхКбхЩиф╝ЪхЕИх░Ж aof buf ф╕нчЪДхЖЕхо╣хЖЩф║║хИ░ AOF цЦЗф╗╢ф╕ня╝МчД╢хРОхЖНхп╣ AOF цЦЗф╗╢ш┐ЫшбМхРМцнеуАВ</p> <h3 id="цМБф╣ЕхМЦчЪДцХИчОЗхТМхоЙхЕицАз"><a href="#цМБф╣ЕхМЦчЪДцХИчОЗхТМхоЙхЕицАз" class="header-anchor">#</a> цМБф╣ЕхМЦчЪДцХИчОЗхТМхоЙхЕицАз</h3> <p>цЬНхКбхЩищЕНч╜о appendfsync щАЙщб╣чЪДхА╝чЫ┤цОехЖ│хоЪ AOF цМБф╣ЕхМЦхКЯшГ╜чЪДцХИчОЗхТМхоЙхЕицАзуАВ</p> <ul><li>х╜У appendfsync чЪДхА╝ф╕║ always цЧ╢я╝МцЬНхКбхЩихЬицпПф╕кф║Лф╗╢х╛кчОпщГ╜шжБх░Ж aof buf ч╝УхЖ▓хМ║ф╕нчЪДцЙАцЬЙхЖЕхо╣хЖЩхЕехИ░ AOF цЦЗф╗╢я╝Мх╣╢ф╕ФхРМцне AOF цЦЗф╗╢я╝МцЙАф╗е always чЪДцХИчОЗцШп appendfsync щАЙщб╣ф╕Йф╕кхА╝х╜Уф╕нцЬАцЕвчЪДф╕Аф╕кя╝Мф╜Жф╗ОхоЙхЕицАзцЭешп┤я╝Мalways ф╣ЯцШпцЬАхоЙхЕичЪДя╝МхЫаф╕║хН│ф╜┐хЗ║чО░цХЕщЪЬхБЬцЬ║я╝МAOF цМБф╣ЕхМЦф╣Я<strong>хПкф╝Ъф╕вхд▒ф╕Аф╕кф║Лф╗╢х╛кчОпф╕нцЙАф║зчФЯчЪДхС╜ф╗дцХ░цНо</strong></li> <li>х╜У appendfsync чЪДхА╝ф╕║ everysec цЧ╢я╝МцЬНхКбхЩихЬицпПф╕кф║Лф╗╢х╛кчОпщГ╜шжБх░Ж aof buf ч╝УхЖ▓хМ║ф╕нчЪДцЙАцЬЙхЖЕхо╣хЖЩхЕехИ░ AOF цЦЗф╗╢я╝Мх╣╢ф╕ФцпПщЪФф╕АчзТх░▒шжБхЬихнРч║┐чиЛф╕нхп╣ AOF цЦЗф╗╢ш┐ЫшбМф╕АцмбхРМцнеуАВф╗ОцХИчОЗф╕КцЭешо▓я╝Мeverysec цибх╝Пш╢│хдЯх┐ля╝Мх╣╢ф╕Фх░▒чоЧхЗ║чО░цХЕщЪЬхБЬцЬ║я╝МцХ░цНох║Уф╣ЯхПкф╕вхд▒ф╕АчзТщТЯчЪДхС╜ф╗дцХ░цНоуАВ</li> <li>х╜У appendfsync чЪДхА╝ф╕║ no цЧ╢я╝МцЬНхКбхЩихЬицпПф╕кф║Лф╗╢х╛кчОпщГ╜шжБх░Ж aof buf ч╝УхЖ▓хМ║ф╕нчЪДцЙАцЬЙхЖЕхо╣хЖЩхЕехИ░ AOF цЦЗф╗╢я╝МшЗ│ф║Оф╜ХцЧ╢хп╣ AOF цЦЗф╗╢ш┐ЫшбМхРМцнея╝МхИЩчФ▒цУНф╜Ьч│╗ч╗ЯцОзхИ╢уАВхЫаф╕║хдДф║О no цибх╝Пф╕ЛчЪД flushappendOnlyFile ш░ГчФицЧащб╗цЙзшбМхРМцнецУНф╜Ья╝МцЙАф╗ешпецибх╝Пф╕ЛчЪД AOF цЦЗф╗╢хЖЩхЕещАЯх║жцА╗цШпцЬАх┐лчЪДя╝Мф╕Нш┐ЗхЫаф╕║ш┐ЩчзНцибх╝Пф╝ЪхЬич│╗ч╗Яч╝УхнШф╕нчзпч┤пф╕Ацо╡цЧ╢щЧ┤чЪДхЖЩхЕецХ░цНоя╝МцЙАф╗ешпецибх╝ПчЪДхНХцмбхРМцнецЧ╢щХ┐щАЪх╕╕цШпф╕ЙчзНцибх╝Пф╕нцЧ╢щЧ┤цЬАщХ┐чЪДуАВф╗Ох╣│цСКцУНф╜ЬчЪДшзТх║жцЭечЬЛя╝Мno цибх╝ПхТМ everysec цибх╝ПчЪДцХИчОЗч▒╗ф╝╝я╝Мх╜УхЗ║чО░цХЕщЪЬхБЬцЬ║цЧ╢я╝Мф╜┐чФи no цибх╝ПчЪДцЬНхКбхЩих░Жф╕вхд▒ф╕КцмбхРМцне AOF цЦЗф╗╢ф╣ЛхРОчЪДцЙАцЬЙхЖЩхС╜ф╗дцХ░цНо</li></ul> <h4 id="хжВцЮЬ-redis-хоХцЬ║ф║Ж-цУНф╜Ьч│╗ч╗Яц▓бцЬЙхоХцЬ║-ф╝ЪцЬЙцХ░цНоф╕вхд▒хРЧ"><a href="#хжВцЮЬ-redis-хоХцЬ║ф║Ж-цУНф╜Ьч│╗ч╗Яц▓бцЬЙхоХцЬ║-ф╝ЪцЬЙцХ░цНоф╕вхд▒хРЧ" class="header-anchor">#</a> хжВцЮЬ Redis хоХцЬ║ф║Жя╝МцУНф╜Ьч│╗ч╗Яц▓бцЬЙхоХцЬ║я╝Мф╝ЪцЬЙцХ░цНоф╕вхд▒хРЧя╝Я</h4> <p>ф╕Нф╕АхоЪ хЫаф╕║хЖЩхЕеф║Ж ч│╗ч╗Яч╝УхнШ цУНф╜Ьч│╗ч╗ЯхжВцЮЬхИ╖чЫШцИРхКЯ х░▒ф╕Нф╝ЪцЬЙф╕вхд▒я╝Мredis хоХцЬ║ф╕Нх╜▒хУНцУНф╜Ьч│╗ч╗ЯхИ╖чЫШ</p> <h4 id="ф╕║ф╗Аф╣ИхЬи-always-ф╕Лф╣ЯхПпшГ╜ф╝Ъф╕вхд▒ф╕Аф╕кф║Лф╗╢х╛кчОпф╕нцЙАф║зчФЯчЪДцХ░цНо"><a href="#ф╕║ф╗Аф╣ИхЬи-always-ф╕Лф╣ЯхПпшГ╜ф╝Ъф╕вхд▒ф╕Аф╕кф║Лф╗╢х╛кчОпф╕нцЙАф║зчФЯчЪДцХ░цНо" class="header-anchor">#</a> ф╕║ф╗Аф╣ИхЬи always ф╕Лф╣ЯхПпшГ╜ф╝Ъф╕вхд▒ф╕Аф╕кф║Лф╗╢х╛кчОпф╕нцЙАф║зчФЯчЪДцХ░цНоя╝Я</h4> <p>хжВцЮЬховцИ╖члпц▓бцЬЙцФ╢хИ░ OK хУНх║Фя╝МхПпшГ╜ф╝Ъф╕вхд▒ф╕АцЭбцХ░цНо</p> <p><strong>ф╜ЖцШп</strong></p> <p>хЬи <code>appendfsync</code> ф╕║ <code>always</code> цибх╝Пф╕Ля╝МхжВцЮЬховцИ╖члпцФ╢хИ░ Redis ш┐ФхЫЮчЪД <code>OK</code> хУНх║Фя╝МцДПхС│чЭАшпехС╜ф╗дчЪДч╗УцЮЬх╖▓ч╗П<strong>цИРхКЯхЖЩхЕехИ░ AOF цЦЗф╗╢х╣╢хРМцнехИ░чгБчЫШ</strong></p> <ul><li>хЬи <code>always</code> цибх╝Пф╕Ля╝МRedis хЬицпПф╕кхС╜ф╗дцЙзшбМхРОщГ╜ф╝ЪчлЛхИ╗х░ЖшпехС╜ф╗дш┐╜хКахИ░ <code>aof_buf</code> ч╝УхЖ▓хМ║я╝МчД╢хРОчлЛхН│х░Жч╝УхЖ▓хМ║ф╕нчЪДхЖЕхо╣хЖЩхЕе AOF цЦЗф╗╢я╝Мх╣╢цЙзшбМ <code>fsync</code> цУНф╜Ья╝ИхН│х░ЖцХ░цНохРМцнехИ░чгБчЫШя╝Й</li> <li>х╜У <code>fsync</code> цИРхКЯхоМцИРхРОя╝МRedis цЙНф╝Ъш┐ФхЫЮ <code>OK</code> хУНх║Фч╗ЩховцИ╖члп</li></ul> <p><strong>хЫацнд</strong>я╝МхЬи <code>always</code> цибх╝Пф╕Ля╝МхжВцЮЬховцИ╖члпцФ╢хИ░ <code>OK</code> хУНх║Фя╝МцДПхС│чЭАя╝Ъ</p> <ol><li>хС╜ф╗дх╖▓ч╗ПшвлцЙзшбМуАВ</li> <li>хС╜ф╗дчЪДч╗УцЮЬх╖▓ч╗ПцИРхКЯш┐╜хКахИ░ AOF цЦЗф╗╢уАВ</li> <li>AOF цЦЗф╗╢х╖▓ч╗ПщАЪш┐З <code>fsync</code> цУНф╜Ьх░ЖцХ░цНохРМцнехИ░ф║ЖчгБчЫШуАВ</li></ol> <p>цнгхЫаф╕║ <code>always</code> цибх╝Пчбоф┐ЭцпПцЭбхС╜ф╗дхЬиш┐ФхЫЮ <code>OK</code> ф╣ЛхЙНщГ╜х╖▓ч╗ПшвлхРМцнехИ░чгБчЫШя╝МцЙАф╗еф╗ОховцИ╖члпчЪДшзЖшзТцЭечЬЛя╝МхПкшжБцФ╢хИ░ф║Ж <code>OK</code>я╝Мх░▒хПпф╗ешодф╕║шпецХ░цНох╖▓ч╗ПшвлцМБф╣ЕхМЦхИ░чгБчЫШя╝Мф╕Нф╝ЪхЫаф╕║ Redis х┤йц║ГцИЦцЬНхКбхЩицЦнчФ╡чнЙхОЯхЫаф╕вхд▒</p> <h3 id="aof-цЦЗф╗╢ш╜╜хЕе"><a href="#aof-цЦЗф╗╢ш╜╜хЕе" class="header-anchor">#</a> AOF цЦЗф╗╢ш╜╜хЕе</h3> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409161649221.png" alt="image-20240916164942177"></p> <ol><li>хИЫх╗║ф╕Аф╕кф╕Нх╕жч╜Сч╗Ьш┐ЮцОечЪДф╝кховцИ╖члп</li> <li>ф╗О AOF цЦЗф╗╢ф╕нхИЖцЮРх╣╢шп╗хПЦхЗ║ф╕АцЭбхЖЩхС╜ф╗д</li> <li>ф╜┐чФиф╝кховцИ╖члпцЙзшбМшвлшп╗хЗ║чЪДхЖЩхС╜ф╗д</li> <li>щЗНхдН 2 3я╝МчЯещБУцЙАцЬЙхЖЩхС╜ф╗дшвлхдДчРЖхоМцпХф╕║цнв</li></ol> <h2 id="aof-щЗНхЖЩ"><a href="#aof-щЗНхЖЩ" class="header-anchor">#</a> AOF щЗНхЖЩ</h2> <h3 id="aof-щЗНхЖЩхЗ╜цХ░ф╕ОшзжхПСцЧ╢цЬ║"><a href="#aof-щЗНхЖЩхЗ╜цХ░ф╕ОшзжхПСцЧ╢цЬ║" class="header-anchor">#</a> AOF щЗНхЖЩхЗ╜цХ░ф╕ОшзжхПСцЧ╢цЬ║</h3> <p>щжЦхЕИя╝МхоЮчО░ AOF щЗНхЖЩчЪДхЗ╜цХ░цШп <strong>rewriteAppendOnlyFileBackground</strong>я╝МхоГцШпхЬи<a href="https://github.com/redis/redis/tree/5.0/src/aof.c" target="_blank" rel="noopener noreferrer">aof.c<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>цЦЗф╗╢ф╕нхоЮчО░чЪДуАВхЬиш┐Щф╕кхЗ╜цХ░ф╕ня╝Мф╝Ъш░ГчФи fork хЗ╜цХ░хИЫх╗║ф╕Аф╕к AOF щЗНхЖЩхнРш┐ЫчиЛя╝МцЭехоЮщЩЕцЙзшбМщЗНхЖЩцУНф╜ЬуАВхЕ│ф║Ош┐Щф╕кхЗ╜цХ░чЪДхЕ╖ф╜УхоЮчО░я╝МцИСчиНхРОф╝Ъч╗Щф╜ашпжч╗Жф╗Лч╗НуАВш┐ЩщЗМхСвя╝МцИСф╗мхЕИцЭечЬЛчЬЛя╝Мш┐Щф╕кхЗ╜цХ░ф╝ЪшвлхУкф║ЫхЗ╜цХ░ш░ГчФия╝Мш┐Щца╖цИСф╗мх░▒хПпф╗еф║Жшзг AOF щЗНхЖЩчЪДшзжхПСцЧ╢цЬ║ф║ЖуАВ</p> <p>хоЮщЩЕф╕Кя╝МrewriteAppendOnlyFileBackground хЗ╜цХ░ф╕АхЕ▒ф╝ЪхЬиф╕Йф╕кхЗ╜цХ░ф╕ншвлш░ГчФиуАВ</p> <p>**чммф╕Аф╕кцШп bgrewriteaofCommand хЗ╜цХ░уАВ**ш┐Щф╕кхЗ╜цХ░цШпхЬи aof.c цЦЗф╗╢ф╕нхоЮчО░чЪДя╝Мхп╣х║Фф║ЖцИСф╗мхЬи Redis server ф╕КцЙзшбМ bgrewriteaof хС╜ф╗дя╝Мф╣Ях░▒цШпшп┤я╝МцИСф╗мцЙЛхКишзжхПСф║Ж AOF rewrite чЪДцЙзшбМуАВ</p> <p>ф╕Нш┐Зя╝МхН│ф╜┐цИСф╗мцЙЛхКицЙзшбМф║Ж bgrewriteaof хС╜ф╗дя╝МbgrewriteaofCommand хЗ╜цХ░ф╣Яф╝Ъца╣цНоф╗еф╕Лф╕дф╕кцЭбф╗╢я╝МцЭехИдцЦнцШпхРжхоЮщЩЕцЙзшбМ AOF щЗНхЖЩуАВ</p> <ul><li>**цЭбф╗╢ф╕Ая╝Ъх╜УхЙНцШпхРжх╖▓ч╗ПцЬЙ AOF щЗНхЖЩчЪДхнРш┐ЫчиЛцнгхЬицЙзшбМуАВ**хжВцЮЬцЬЙчЪДшпЭя╝МщВгф╣И bgrewriteaofCommand хЗ╜цХ░х░▒ф╕НхЖНцЙзшбМ AOF щЗНхЖЩф║ЖуАВ</li> <li>**цЭбф╗╢ф║Мя╝Ъх╜УхЙНцШпхРжцЬЙхИЫх╗║ RDB чЪДхнРш┐ЫчиЛцнгхЬицЙзшбМуАВ**хжВцЮЬцЬЙчЪДшпЭя╝МbgrewriteaofCommand хЗ╜цХ░ф╝ЪцККхЕих▒АхПШщЗП server чЪД aof_rewrite_scheduled цИРхСШхПШщЗПшо╛ч╜оф╕║ 1я╝Мш┐Щф╕кцаЗх┐ЧшбицШО Redis server х╖▓ч╗Пх░Ж AOF щЗНхЖЩшо╛ф╕║х╛Еш░Гх║жш┐РшбМя╝МчнЙхРОч╗нцЭбф╗╢ц╗бш╢│цЧ╢я╝МхоГх░▒ф╝ЪхоЮщЩЕцЙзшбМ AOF щЗНхЖЩя╝ИцИСф╗мф╕Аф╝ЪхД┐х░▒ф╝ЪчЬЛхИ░я╝Мх╜У aof_rewrite_scheduled шо╛ч╜оф╕║ 1 ф╗ехРОя╝МRedis server ф╝ЪхЬихУкф║ЫцЭбф╗╢ф╕ЛхоЮщЩЕцЙзшбМщЗНхЖЩцУНф╜Ья╝ЙуАВ</li></ul> <p>цЙАф╗еш┐Щф╣Ях░▒цШпшп┤я╝МхПкцЬЙх╜УхЙНцЧвц▓бцЬЙ AOF щЗНхЖЩхнРш┐ЫчиЛф╣Яц▓бцЬЙ RDB хнРш┐ЫчиЛя╝МbgrewriteaofCommand хЗ╜цХ░цЙНф╝ЪчлЛхН│ш░ГчФи rewriteAppendOnlyFileBackground хЗ╜цХ░я╝МхоЮщЩЕцЙзшбМ AOF щЗНхЖЩуАВ</p> <p>ф╗еф╕Лф╗гчаБх▒Хчд║ф║Ж bgrewriteaofCommand хЗ╜цХ░чЪДхЯ║цЬмцЙзшбМщА╗ш╛Ся╝Мф╜ахПпф╗ечЬЛф╕ЛуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">bgrewriteaofCommand</span><span class="token punctuation">(</span>client <span class="token operator">*</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_child_pid <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">//цЬЙAOFщЗНхЖЩхнРш┐ЫчиЛя╝МхЫацндф╕НцЙзшбМщЗНхЖЩ</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>rdb_child_pid <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        server<span class="token punctuation">.</span>aof_rewrite_scheduled <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//цЬЙRDBхнРш┐ЫчиЛя╝Мх░ЖAOFщЗНхЖЩшо╛ч╜оф╕║х╛Еш░Гх║жш┐РшбМ</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rewriteAppendOnlyFileBackground</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> C_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//хоЮщЩЕцЙзшбМAOFщЗНхЖЩ</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>**чммф║Мф╕кцШп startAppendOnly хЗ╜цХ░уАВ**ш┐Щф╕кхЗ╜цХ░ф╣ЯцШпхЬи aof.c цЦЗф╗╢ф╕нхоЮчО░чЪДя╝МхоГцЬмш║лф╝Ъшвл configSetCommand хЗ╜цХ░я╝ИхЬи<a href="https://github.com/redis/redis/blob/5.0/src/config.c" target="_blank" rel="noopener noreferrer">config.c<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>цЦЗф╗╢ф╕ня╝ЙхТМ restartAOFAfterSYNC хЗ╜цХ░я╝ИхЬи<a href="https://github.com/redis/redis/tree/5.0/src/replication.c" target="_blank" rel="noopener noreferrer">replication.c<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>цЦЗф╗╢ф╕ня╝Йш░ГчФиуАВ</p> <p>щжЦхЕИя╝Мхп╣ф║О configSetCommand хЗ╜цХ░цЭешп┤я╝МхоГхп╣х║Фф║ЖцИСф╗мхЬи Redis ф╕нцЙзшбМ config хС╜ф╗дхРпчФи AOF хКЯшГ╜я╝МхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code>config set appendonly yes
</code></pre></div><p>ш┐Щца╖я╝Мф╕АцЧж AOF хКЯшГ╜хРпчФихРОя╝МconfigSetCommand хЗ╜цХ░х░▒ф╝Ъш░ГчФи startAppendOnly хЗ╜цХ░я╝МцЙзшбМф╕Ацмб AOF щЗНхЖЩуАВ</p> <p>шАМхп╣ф║О restartAOFAfterSYNC хЗ╜цХ░цЭешп┤я╝МхоГф╝ЪхЬиф╕╗ф╗ОшКВчВ╣чЪДхдНхИ╢ш┐ЗчиЛф╕ншвлш░ГчФиуАВчоАхНХцЭешп┤я╝Мх░▒цШпх╜Уф╕╗ф╗ОшКВчВ╣хЬиш┐ЫшбМхдНхИ╢цЧ╢я╝МхжВцЮЬф╗ОшКВчВ╣чЪД AOF щАЙщб╣швлцЙУх╝Ая╝МщВгф╣ИхЬихКаш╜╜шзгцЮР RDB цЦЗф╗╢цЧ╢я╝МAOF щАЙщб╣х░▒ф╝ЪшвлхЕ│щЧнуАВчД╢хРОя╝МцЧашо║ф╗ОшКВчВ╣цШпхРжцИРхКЯхКаш╜╜ф║Ж RDB цЦЗф╗╢я╝МrestartAOFAfterSYNC хЗ╜цХ░щГ╜ф╝Ъшвлш░ГчФия╝МчФицЭецБвхдНшвлхЕ│щЧнчЪД AOF хКЯшГ╜уАВ</p> <p>щВгф╣ИхЬиш┐Щф╕кш┐ЗчиЛф╕ня╝МrestartAOFAfterSYNC хЗ╜цХ░х░▒ф╝Ъш░ГчФи startAppendOnly хЗ╜цХ░я╝Мх╣╢ш┐Ыф╕Ацнеш░ГчФи rewriteAppendOnlyFileBackground хЗ╜цХ░я╝МцЭецЙзшбМф╕Ацмб AOF щЗНхЖЩуАВ</p> <p>ш┐ЩщЗМф╜ашжБц│ицДПя╝МхТМ bgrewriteaofCommand хЗ╜цХ░ч▒╗ф╝╝я╝М<strong>startAppendOnly хЗ╜цХ░ф╣Яф╝ЪхИдцЦнх╜УхЙНцШпхРжцЬЙ RDB хнРш┐ЫчиЛхЬицЙзшбМ</strong>я╝МхжВцЮЬцЬЙчЪДшпЭя╝МхоГф╝Ъх░Ж AOF щЗНхЖЩшо╛ч╜оф╕║х╛Еш░Гх║жцЙзшбМуАВщЩдцндф╣ЛхдЦя╝МхжВцЮЬ startAppendOnly хЗ╜цХ░цгАц╡ЛхИ░цЬЙ AOF щЗНхЖЩхнРш┐ЫчиЛхЬицЙзшбМя╝МщВгф╣ИхоГх░▒ф╝ЪцККшпехнРш┐ЫчиЛхЕИ kill цОЙя╝МчД╢хРОхЖНш░ГчФи rewriteAppendOnlyFileBackground хЗ╜цХ░ш┐ЫшбМ AOF щЗНхЖЩуАВ</p> <p>цЙАф╗ехИ░ш┐ЩщЗМя╝МцИСф╗мхЕ╢хоЮхПпф╗ехПСчО░я╝МцЧашо║цШп bgrewriteaofCommand хЗ╜цХ░ш┐ШцШп startAppendOnly хЗ╜цХ░я╝Мх╜УхоГф╗мцгАц╡ЛхИ░цЬЙ RDB хнРш┐ЫчиЛхЬицЙзшбМчЪДцЧ╢хАЩя╝Мх░▒ф╝ЪцКК aof_rewrite_scheduled хПШщЗПшо╛ч╜оф╕║ 1я╝Мш┐Щшбичд║ AOF щЗНхЖЩцУНф╜Ьх░ЖхЬицЭбф╗╢ц╗бш╢│цЧ╢хЖНшвлцЙзшбМуАВ</p> <p>**щВгф╣Ия╝МRedis server ф╗Аф╣ИцЧ╢хАЩф╝ЪхЖНцгАцЯе AOF щЗНхЖЩцУНф╜ЬчЪДцЭбф╗╢цШпхРжц╗бш╢│хСвя╝Я**ш┐Щх░▒хТМ rewriteAppendOnlyFileBackground хЗ╜цХ░швлш░ГчФичЪДчммф╕Йф╕кхЗ╜цХ░я╝МserverCron хЗ╜цХ░чЫ╕хЕ│ф║ЖуАВ</p> <p>**чммф╕Йф╕кцШп serverCron хЗ╜цХ░уАВ**хЬи Redis server ш┐РшбМцЧ╢я╝МserverCron хЗ╜цХ░цШпф╝ЪшвлхСицЬЯцАзцЙзшбМчЪДуАВчД╢хРОхоГхЬицЙзшбМчЪДш┐ЗчиЛф╕ня╝Мф╝ЪхБЪф╕дцмбхИдцЦнцЭехЖ│хоЪцШпхРжцЙзшбМ AOF щЗНхЖЩуАВ</p> <p>щжЦхЕИя╝МserverCron хЗ╜цХ░ф╝ЪцгАц╡Лх╜УхЙНцШпхРж<strong>ц▓бцЬЙ RDB хнРш┐ЫчиЛхТМ AOF щЗНхЖЩхнРш┐ЫчиЛхЬицЙзшбМ</strong>я╝Мх╣╢цгАц╡ЛцШпхРж<strong>цЬЙ AOF щЗНхЖЩцУНф╜Ьшвлшо╛ч╜оф╕║ф║Жх╛Еш░Гх║жцЙзшбМ</strong>я╝Мф╣Ях░▒цШп aof_rewrite_scheduled хПШщЗПхА╝ф╕║ 1уАВ</p> <p>хжВцЮЬш┐Щф╕Йф╕кцЭбф╗╢щГ╜ц╗бш╢│я╝МщВгф╣И serverCron хЗ╜цХ░х░▒ф╝Ъш░ГчФи rewriteAppendOnlyFileBackground хЗ╜цХ░цЭецЙзшбМ AOF щЗНхЖЩуАВserverCron хЗ╜цХ░щЗМщЭвчЪДш┐ЩщГихИЖцЙзшбМщА╗ш╛СхжВф╕ЛцЙАчд║я╝Ъ</p> <p>//хжВцЮЬц▓бцЬЙ RDB хнРш┐ЫчиЛя╝Мф╣Яц▓бцЬЙ AOF щЗНхЖЩхнРш┐ЫчиЛя╝Мх╣╢ф╕Ф AOF щЗНхЖЩшвлшо╛ч╜оф╕║х╛Еш░Гх║жцЙзшбМя╝МщВгф╣Иш░ГчФи rewriteAppendOnlyFileBackground хЗ╜цХ░ш┐ЫшбМ AOF щЗНхЖЩ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">//хжВцЮЬц▓бцЬЙRDBхнРш┐ЫчиЛя╝Мф╣Яц▓бцЬЙAOFщЗНхЖЩхнРш┐ЫчиЛя╝Мх╣╢ф╕ФAOFщЗНхЖЩшвлшо╛ч╜оф╕║х╛Еш░Гх║жцЙзшбМя╝МщВгф╣Иш░ГчФиrewriteAppendOnlyFileBackgroundхЗ╜цХ░ш┐ЫшбМAOFщЗНхЖЩ</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>rdb_child_pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> server<span class="token punctuation">.</span>aof_child_pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
        server<span class="token punctuation">.</span>aof_rewrite_scheduled<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token function">rewriteAppendOnlyFileBackground</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ф║ЛхоЮф╕Кя╝Мш┐ЩщЗМчЪДф╗гчаБф╣ЯхЫЮчнФф║ЖцИСф╗мхИЪцЙНцПРхИ░чЪДщЧощвШя╝Ъх╛Еш░Гх║жцЙзшбМчЪД AOF щЗНхЖЩф╝ЪхЬиф╗Аф╣ИцЧ╢хАЩцЙзшбМя╝Я</p> <p>хЕ╢хоЮя╝МхжВцЮЬ AOF щЗНхЖЩц▓бц│ХчлЛхН│цЙзшбМчЪДшпЭя╝МцИСф╗мф╣Яф╕НчФицЛЕх┐ГуАВхЫаф╕║<strong>хПкшжБ aof_rewrite_scheduled хПШщЗПшвлшо╛ч╜оф╕║ 1 ф║Жя╝МщВгф╣И serverCron хЗ╜цХ░х░▒щ╗Шшодф╝ЪцпП 100 цплчзТцЙзшбМх╣╢цгАц╡Лш┐Щф╕кхПШщЗПхА╝</strong>уАВцЙАф╗ея╝МхжВцЮЬцнгхЬицЙзшбМчЪД RDB хнРш┐ЫчиЛхТМ AOF щЗНхЖЩхнРш┐ЫчиЛч╗УцЭЯф║Жф╣ЛхРОя╝Мшвлш░Гх║жцЙзшбМчЪД AOF щЗНхЖЩх░▒хПпф╗ех╛Их┐лх╛ЧхИ░цЙзшбМуАВ</p> <p>хЕ╢цмбя╝МхН│ф╜┐ AOF щЗНхЖЩцУНф╜Ьц▓бцЬЙшвлшо╛ч╜оф╕║х╛Еш░Гх║жцЙзшбМя╝МserverCron хЗ╜цХ░ф╣Яф╝Ъ<strong>хСицЬЯцАзхИдцЦнцШпхРжщЬАшжБцЙзшбМ AOF щЗНхЖЩ</strong>уАВш┐ЩщЗМчЪДхИдцЦнцЭбф╗╢ф╕╗шжБцЬЙф╕Йф╕кя╝МхИЖхИлцШп AOF хКЯшГ╜х╖▓хРпчФиуАБAOF цЦЗф╗╢хдзх░ПцпФф╛Лш╢ЕхЗ║щШИхА╝я╝Мф╗ехПК AOF цЦЗф╗╢хдзх░Пч╗Эхп╣хА╝ш╢ЕхЗ║щШИхА╝уАВ</p> <p>ш┐Щца╖ф╕АцЭея╝Мх╜Уш┐Щф╕Йф╕кцЭбф╗╢щГ╜ц╗бш╢│цЧ╢я╝Мх╣╢ф╕Фф╣Яц▓бцЬЙ RDB хнРш┐ЫчиЛхТМ AOF хнРш┐ЫчиЛхЬиш┐РшбМчЪДшпЭя╝МцндцЧ╢я╝МserverCron хЗ╜цХ░х░▒ф╝Ъш░ГчФи rewriteAppendOnlyFileBackground хЗ╜цХ░цЙзшбМ AOF щЗНхЖЩуАВш┐ЩщГихИЖчЪДф╗гчаБщА╗ш╛СхжВф╕ЛцЙАчд║я╝Ъ</p> <p>//хжВцЮЬ AOF хКЯшГ╜хРпчФиуАБц▓бцЬЙ RDB хнРш┐ЫчиЛхТМ AOF щЗНхЖЩхнРш┐ЫчиЛхЬицЙзшбМуАБAOF цЦЗф╗╢хдзх░ПцпФф╛Лшо╛хоЪф║ЖщШИхА╝я╝Мф╗ехПК AOF цЦЗф╗╢хдзх░Пч╗Эхп╣хА╝ш╢ЕхЗ║ф║ЖщШИхА╝я╝МщВгф╣Ия╝Мш┐Ыф╕АцнехИдцЦн AOF цЦЗф╗╢хдзх░ПцпФф╛ЛцШпхРжш╢ЕхЗ║щШИхА╝</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">//хжВцЮЬAOFхКЯшГ╜хРпчФиуАБц▓бцЬЙRDBхнРш┐ЫчиЛхТМAOFщЗНхЖЩхнРш┐ЫчиЛхЬицЙзшбМуАБAOFцЦЗф╗╢хдзх░ПцпФф╛Лшо╛хоЪф║ЖщШИхА╝я╝Мф╗ехПКAOFцЦЗф╗╢хдзх░Пч╗Эхп╣хА╝ш╢ЕхЗ║ф║ЖщШИхА╝я╝МщВгф╣Ия╝Мш┐Ыф╕АцнехИдцЦнAOFцЦЗф╗╢хдзх░ПцпФф╛ЛцШпхРжш╢ЕхЗ║щШИхА╝</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_state <span class="token operator">==</span> AOF_ON <span class="token operator">&amp;&amp;</span> server<span class="token punctuation">.</span>rdb_child_pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> server<span class="token punctuation">.</span>aof_child_pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> server<span class="token punctuation">.</span>aof_rewrite_perc <span class="token operator">&amp;&amp;</span> server<span class="token punctuation">.</span>aof_current_size <span class="token operator">&gt;</span> server<span class="token punctuation">.</span>aof_rewrite_min_size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">//шобчоЧAOFцЦЗф╗╢х╜УхЙНхдзх░Пш╢ЕхЗ║хЯ║чбАхдзх░ПчЪДцпФф╛Л</span>
   <span class="token keyword">long</span> <span class="token keyword">long</span> base <span class="token operator">=</span> server<span class="token punctuation">.</span>aof_rewrite_base_size <span class="token operator">?</span> server<span class="token punctuation">.</span>aof_rewrite_base_size <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token keyword">long</span> <span class="token keyword">long</span> growth <span class="token operator">=</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_current_size<span class="token operator">*</span><span class="token number">100</span><span class="token operator">/</span>base<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">100</span><span class="token punctuation">;</span>
   <span class="token comment">//хжВцЮЬAOFцЦЗф╗╢х╜УхЙНхдзх░Пш╢ЕхЗ║хЯ║чбАхдзх░ПчЪДцпФф╛Лх╖▓ч╗Пш╢ЕхЗ║щвДшо╛щШИхА╝я╝МщВгф╣ИцЙзшбМAOFщЗНхЖЩ</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>growth <span class="token operator">&gt;=</span> server<span class="token punctuation">.</span>aof_rewrite_perc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token function">rewriteAppendOnlyFileBackground</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>щВгф╣Ия╝Мф╗Ош┐ЩщЗМчЪДф╗гчаБф╕ня╝Мф╜аф╝ЪчЬЛхИ░я╝Мф╕║ф║ЖщБ┐хЕН AOF цЦЗф╗╢ш┐Зхдзхп╝шЗ┤хНачФиш┐ЗхдЪчЪДчгБчЫШчй║щЧ┤я╝Мф╗ехПКхвЮхКацБвхдНцЧ╢щХ┐я╝Мф╜ахЕ╢хоЮхПпф╗ещАЪш┐Зшо╛ч╜о redis.conf цЦЗф╗╢ф╕нчЪДф╗еф╕Лф╕дф╕кщШИхА╝я╝МцЭешой Redis server шЗкхКищЗНхЖЩ AOF цЦЗф╗╢уАВ</p> <ul><li><strong>auto-aof-rewrite-percentage</strong>я╝ЪAOF цЦЗф╗╢хдзх░Пш╢ЕхЗ║хЯ║чбАхдзх░ПчЪДцпФф╛Ля╝Мщ╗ШшодхА╝ф╕║ 100%я╝МхН│ш╢ЕхЗ║ 1 хАНхдзх░ПуАВ</li> <li><strong>auto-aof-rewrite-min-size</strong>я╝ЪAOF цЦЗф╗╢хдзх░Пч╗Эхп╣хА╝чЪДцЬАх░ПхА╝я╝Мщ╗Шшодф╕║ 64MBуАВ</li></ul> <p>хе╜ф║Жя╝МхИ░ш┐ЩщЗМя╝МцИСф╗мх░▒ф║Жшзгф║Ж AOF щЗНхЖЩчЪДхЫЫф╕кшзжхПСцЧ╢цЬ║я╝Мш┐ЩщЗМцИСф╣Яч╗Щф╜ацА╗ч╗Уф╕Ля╝МцЦ╣ф╛┐ф╜ахЫЮщб╛хдНф╣ауАВ</p> <ul><li>цЧ╢цЬ║ф╕Ая╝Ъbgrewriteaof хС╜ф╗дшвлцЙзшбМуАВ</li> <li>цЧ╢цЬ║ф║Мя╝Ъф╕╗ф╗ОхдНхИ╢хоМцИР RDB цЦЗф╗╢шзгцЮРхТМхКаш╜╜я╝ИцЧашо║цШпхРжцИРхКЯя╝ЙуАВ</li> <li>цЧ╢цЬ║ф╕Йя╝ЪAOF щЗНхЖЩшвлшо╛ч╜оф╕║х╛Еш░Гх║жцЙзшбМуАВ</li> <li>цЧ╢цЬ║хЫЫя╝ЪAOF швлхРпчФия╝МхРМцЧ╢ AOF цЦЗф╗╢чЪДхдзх░ПцпФф╛Лш╢ЕхЗ║щШИхА╝я╝Мф╗ехПК AOF цЦЗф╗╢чЪДхдзх░Пч╗Эхп╣хА╝ш╢ЕхЗ║щШИхА╝уАВ</li></ul> <p>хПжхдЦя╝Мш┐ЩщЗМф╜аш┐ШщЬАшжБц│ицДПя╝МхЬиш┐ЩхЫЫф╕кцЧ╢цЬ║ф╕Ля╝МхЕ╢хоЮщГ╜ф╕НшГ╜цЬЙцнгхЬицЙзшбМчЪД RDB хнРш┐ЫчиЛхТМ AOF щЗНхЖЩхнРш┐ЫчиЛя╝МхРжхИЩчЪДшпЭя╝МAOF щЗНхЖЩх░▒цЧац│ХцЙзшбМф║ЖуАВ</p> <p>цЙАф╗ецОеф╕ЛцЭея╝МцИСф╗мх░▒цЭехнжф╣аф╕Л AOF щЗНхЖЩчЪДхЯ║цЬмцЙзшбМш┐ЗчиЛуАВ</p> <h3 id="aof-щЗНхЖЩчЪДхЯ║цЬмш┐ЗчиЛ"><a href="#aof-щЗНхЖЩчЪДхЯ║цЬмш┐ЗчиЛ" class="header-anchor">#</a> AOF щЗНхЖЩчЪДхЯ║цЬмш┐ЗчиЛ</h3> <p>щжЦхЕИя╝МцИСф╗мхЖНцЭечЬЛф╕ЛхИЪцЙНф╗Лч╗НчЪД rewriteAppendOnlyFileBackground хЗ╜цХ░уАВш┐Щф╕кхЗ╜цХ░чЪДф╕╗ф╜УщА╗ш╛СцпФш╛ГчоАхНХя╝Мф╕АцЦ╣щЭвя╝МхоГф╝ЪщАЪш┐Зш░ГчФи fork хЗ╜цХ░хИЫх╗║ф╕Аф╕кхнРш┐ЫчиЛя╝МчД╢хРОхЬихнРш┐ЫчиЛф╕нш░ГчФи rewriteAppendOnlyFile хЗ╜цХ░ш┐ЫшбМ AOF цЦЗф╗╢щЗНхЖЩуАВ</p> <p>rewriteAppendOnlyFile хЗ╜цХ░цШпхЬи aof.c цЦЗф╗╢ф╕нхоЮчО░чЪДуАВхоГф╕╗шжБф╝Ъш░ГчФи <strong>rewriteAppendOnlyFileRio хЗ╜цХ░</strong>я╝ИхЬи aof.c цЦЗф╗╢ф╕ня╝ЙцЭехоМцИР AOF цЧех┐ЧцЦЗф╗╢чЪДщЗНхЖЩуАВхЕ╖ф╜УцЭешп┤я╝Мх░▒цШп rewriteAppendOnlyFileRio хЗ╜цХ░ф╝ЪщБНхОЖ Redis server чЪДцпПф╕Аф╕кцХ░цНох║Уя╝МцККхЕ╢ф╕нчЪДцпПф╕кщФохА╝хп╣шп╗хПЦхЗ║цЭея╝МчД╢хРОшо░х╜ХшпещФохА╝хп╣ч▒╗хЮЛхп╣х║ФчЪДцПТхЕехС╜ф╗дя╝Мф╗ехПКщФохА╝хп╣цЬмш║лчЪДхЖЕхо╣уАВ</p> <p>цпФхжВя╝МхжВцЮЬшп╗хПЦчЪДцШпф╕Аф╕к String ч▒╗хЮЛчЪДщФохА╝хп╣я╝МщВгф╣И rewriteAppendOnlyFileRio хЗ╜цХ░я╝Мх░▒ф╝Ъшо░х╜Х SET хС╜ф╗дхТМщФохА╝хп╣цЬмш║лхЖЕхо╣я╝ЫшАМхжВцЮЬшп╗хПЦчЪДцШп Set ч▒╗хЮЛщФохА╝хп╣я╝МщВгф╣ИхоГф╝Ъшо░х╜Х SADD хС╜ф╗дхТМщФохА╝хп╣хЖЕхо╣уАВш┐Щца╖ф╕АцЭея╝Мх╜УщЬАшжБцБвхдН Redis цХ░цНох║УцЧ╢я╝МцИСф╗мщЗНцЦ░цЙзшбМф╕АщБН AOF щЗНхЖЩцЧех┐Чф╕ншо░х╜ХчЪДхС╜ф╗дцУНф╜Ья╝Мх░▒хПпф╗еф╛ЭцмбцПТхЕецЙАцЬЙщФохА╝хп╣ф║ЖуАВ</p> <p>хПжф╕АцЦ╣щЭвя╝МхЬичИ╢ш┐ЫчиЛф╕ня╝Мш┐Щф╕к rewriteAppendOnlyFileBackground хЗ╜цХ░ф╝Ъ<strong>цКК aof_rewrite_scheduled хПШщЗПшо╛ч╜оф╕║ 0</strong>я╝МхРМцЧ╢шо░х╜Х AOF щЗНхЖЩх╝АхзЛчЪДцЧ╢щЧ┤я╝Мф╗ехПКшо░х╜Х AOF хнРш┐ЫчиЛчЪДш┐ЫчиЛхП╖уАВ</p> <p>цндхдЦя╝МrewriteAppendOnlyFileBackground хЗ╜цХ░ш┐Шф╝Ъш░ГчФи <strong>updateDictResizePolicy хЗ╜цХ░</strong>я╝МчжБцнвхЬи AOF щЗНхЖЩцЬЯщЧ┤ш┐ЫшбМ rehash цУНф╜ЬуАВш┐ЩцШпхЫаф╕║ rehash цУНф╜Ьф╝Ъх╕жцЭеш╛ГхдЪчЪДцХ░цНочз╗хКицУНф╜Ья╝Мхп╣ф║О AOF щЗНхЖЩхнРш┐ЫчиЛцЭешп┤я╝Мш┐Щх░▒цДПхС│чЭАчИ╢ш┐ЫчиЛф╕нчЪДхЖЕхнШф┐оцФ╣ф╝ЪцпФш╛ГхдЪуАВхЫацндя╝МAOF щЗНхЖЩхнРш┐ЫчиЛх░▒щЬАшжБцЙзшбМцЫ┤хдЪчЪДхЖЩцЧ╢хдНхИ╢я╝Мш┐ЫшАМхоМцИР AOF цЦЗф╗╢чЪДхЖЩхЕея╝Мш┐Щх░▒ф╝Ъч╗Щ Redis ч│╗ч╗ЯчЪДцАзшГ╜щАацИРш┤ЯщЭвх╜▒хУНуАВ</p> <p>ф╗еф╕Лф╗гчаБх░▒х▒Хчд║ф║Ж rewriteAppendOnlyFileBackground хЗ╜цХ░чЪДхЯ║цЬмцЙзшбМщА╗ш╛Ся╝Мф╜ахПпф╗ечЬЛф╕ЛуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">rewriteAppendOnlyFileBackground</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>childpid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//хИЫх╗║хнРш┐ЫчиЛ</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token comment">//хнРш┐ЫчиЛш░ГчФиrewriteAppendOnlyFileш┐ЫшбМAOFщЗНхЖЩ</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rewriteAppendOnlyFile</span><span class="token punctuation">(</span>tmpfile<span class="token punctuation">)</span> <span class="token operator">==</span> C_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">size_t</span> private_dirty <span class="token operator">=</span> <span class="token function">zmalloc_get_private_dirty</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token function">exitFromChild</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">exitFromChild</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">else</span><span class="token punctuation">{</span> <span class="token comment">//чИ╢ш┐ЫчиЛцЙзшбМчЪДщА╗ш╛С</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      server<span class="token punctuation">.</span>aof_rewrite_scheduled <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      server<span class="token punctuation">.</span>aof_rewrite_time_start <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      server<span class="token punctuation">.</span>aof_child_pid <span class="token operator">=</span> childpid<span class="token punctuation">;</span> <span class="token comment">//шо░х╜ХщЗНхЖЩхнРш┐ЫчиЛчЪДш┐ЫчиЛхП╖</span>
      <span class="token function">updateDictResizePolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//хЕ│щЧнrehashхКЯшГ╜</span>
<span class="token punctuation">}</span>
</code></pre></div><p>шАМф╗Ош┐ЩщЗМя╝Мф╜ахПпф╗ечЬЛхИ░я╝МAOF щЗНхЖЩхТМ RDB хИЫх╗║цШпцпФш╛Гч▒╗ф╝╝чЪДя╝МхоГф╗мщГ╜ф╝ЪхИЫх╗║ф╕Аф╕кхнРш┐ЫчиЛцЭещБНхОЖцЙАцЬЙчЪДцХ░цНох║Уя╝Мх╣╢цККцХ░цНох║Уф╕нчЪДцпПф╕кщФохА╝хп╣шо░х╜ХхИ░цЦЗф╗╢ф╕нуАВф╕Нш┐Зя╝МAOF щЗНхЖЩхТМ RDB цЦЗф╗╢хПИцЬЙф╕дф╕кф╕НхРМчЪДхЬ░цЦ╣я╝Ъ</p> <ul><li>ф╕АцШпя╝МAOF цЦЗф╗╢ф╕нцШпф╗етАЬхС╜ф╗д + щФохА╝хп╣тАЭчЪДх╜вх╝Пя╝МцЭешо░х╜ХцпПф╕кщФохА╝хп╣чЪДцПТхЕецУНф╜Ья╝МшАМ RDB цЦЗф╗╢шо░х╜ХчЪДцШпщФохА╝хп╣цХ░цНоцЬмш║ля╝Ы</li> <li>ф║МцШпя╝МхЬи AOF щЗНхЖЩцИЦцШпхИЫх╗║ RDB чЪДш┐ЗчиЛф╕ня╝Мф╕╗ш┐ЫчиЛф╗НчД╢хПпф╗ецОецФ╢ховцИ╖члпхЖЩшп╖ц▒ВуАВф╕Нш┐Зя╝МхЫаф╕║ RDB цЦЗф╗╢хПкщЬАшжБшо░х╜ХцЯРф╕кцЧ╢хИ╗ф╕ЛцХ░цНох║УчЪДцЙАцЬЙцХ░цНох░▒шбМя╝МшАМ AOF щЗНхЖЩхИЩщЬАшжБх░╜хПпшГ╜хЬ░цККф╕╗ш┐ЫчиЛцФ╢хИ░чЪДхЖЩцУНф╜Ья╝Мф╣Яшо░х╜ХхИ░щЗНхЖЩчЪДцЧех┐ЧцЦЗф╗╢ф╕нуАВцЙАф╗ея╝МAOF щЗНхЖЩхнРш┐ЫчиЛх░▒щЬАшжБцЬЙчЫ╕х║ФчЪДцЬ║хИ╢цЭехТМф╕╗ш┐ЫчиЛш┐ЫшбМщАЪф┐бя╝Мф╗ецндцЭецОецФ╢ф╕╗ш┐ЫчиЛцФ╢хИ░чЪДхЖЩцУНф╜ЬуАВ</li></ul> <p>ф╕ЛхЫ╛х░▒х▒Хчд║ф║Ж rewriteAppendOnlyFileBackground хЗ╜цХ░цЙзшбМчЪДхЯ║цЬмщА╗ш╛СуАБф╕╗ш┐ЫчиЛхТМ AOF щЗНхЖЩхнРш┐ЫчиЛхРДшЗкцЙзшбМчЪДхЖЕхо╣я╝Мф╗ехПКф╕╗ш┐ЫчиЛхТМхнРш┐ЫчиЛщЧ┤чЪДщАЪф┐бш┐ЗчиЛя╝Мф╜ахПпф╗ехЖНцЭецХ┤ф╜УхЫЮщб╛ф╕ЛуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409161655216.png" alt="image-20240916165535141"></p> <p>хИ░ш┐ЩщЗМя╝МцИСф╗мх░▒хдзцжВцОМцПбф║Ж AOF щЗНхЖЩчЪДхЯ║цЬмцЙзшбМш┐ЗчиЛуАВф╜ЖцШпхЬиш┐ЩщЗМя╝Мф╜ахПпшГ╜ш┐Шф╝ЪцЬЙчЦСщЧоя╝МцпФхжВшп┤я╝МAOF щЗНхЖЩчЪДхнРш┐ЫчиЛхТМчИ╢ш┐ЫчиЛя╝МхоГф╗мф╣ЛщЧ┤чЪДщАЪф┐бш┐ЗчиЛцШпцАОф╣Ица╖чЪДхСвя╝Я</p> <p>хЕ╢хоЮя╝Мш┐Щф╕кщАЪф┐бш┐ЗчиЛцШпщАЪш┐ЗцУНф╜Ьч│╗ч╗ЯчЪД<strong>чобщБУцЬ║хИ╢</strong>я╝Иpipeя╝ЙцЭехоЮчО░чЪД</p> <p>хЬи AOF щЗНхЖЩцЧ╢я╝Мф╕╗ш┐ЫчиЛф╗НчД╢хЬицОецФ╢ховцИ╖члпхЖЩцУНф╜Ья╝М<strong>щВгф╣Иш┐Щф║ЫцЦ░хЖЩцУНф╜Ьф╝Ъшо░х╜ХхИ░ AOF щЗНхЖЩцЧех┐Чф╕нхРЧя╝ЯхжВцЮЬщЬАшжБшо░х╜ХчЪДшпЭя╝МщЗНхЖЩхнРш┐ЫчиЛхПИцШпщАЪш┐Зф╗Аф╣ИцЦ╣х╝ПхРСф╕╗ш┐ЫчиЛшО╖хПЦш┐Щф║ЫхЖЩцУНф╜ЬчЪДхСвя╝Я</strong></p> <p>echo цОеф╕ЛцЭех░▒х╕жф╜аф║Жшзгф╕Л AOF щЗНхЖЩш┐ЗчиЛф╕нцЙАф╜┐чФичЪДчобщБУцЬ║хИ╢я╝Мф╗ехПКф╕╗ш┐ЫчиЛхТМщЗНхЖЩхнРш┐ЫчиЛчЪДф║дф║Тш┐ЗчиЛ</p> <ul><li>ф╕АцЦ╣щЭвя╝Мф╜ах░▒хПпф╗еф║Жшзг AOF щЗНхЖЩцЧех┐ЧхМЕхРлчЪДхЖЩцУНф╜ЬчЪДхоМцХ┤чиЛх║жя╝Мх╜Уф╜ашжБф╜┐чФи AOF цЧех┐ЧцБвхдН Redis цХ░цНох║УцЧ╢я╝Мх░▒чЯещБУ AOF шГ╜цБвхдНхИ░чЪДчиЛх║жцШпцАОца╖чЪД</li> <li>ф╕АцЦ╣щЭвя╝МхЫаф╕║ AOF щЗНхЖЩхнРш┐ЫчиЛх░▒цШпщАЪш┐ЗцУНф╜Ьч│╗ч╗ЯцПРф╛ЫчЪДчобщБУцЬ║хИ╢я╝МцЭехТМ Redis ф╕╗ш┐ЫчиЛф║дф║ТчЪДя╝МцЙАф╗ехнжхоМш┐ЩшКВшп╛ф╣ЛхРОя╝Мф╜аш┐ШхПпф╗ецОМцПбчобщБУцКАцЬпя╝Мф╗ОшАМчФицЭехоЮчО░ш┐ЫчиЛщЧ┤чЪДщАЪф┐б</li></ul> <p>хе╜ф║Жя╝МцОеф╕ЛцЭея╝МцИСф╗мх░▒хЕИцЭеф║Жшзгф╕ЛчобщБУцЬ║хИ╢</p> <h2 id="ц╖▒хЕещЗНхЖЩч╝УхЖ▓хМ║"><a href="#ц╖▒хЕещЗНхЖЩч╝УхЖ▓хМ║" class="header-anchor">#</a> ц╖▒хЕещЗНхЖЩч╝УхЖ▓хМ║</h2> <h3 id="хжВф╜Хф╜┐чФичобщБУш┐ЫшбМчИ╢хнРш┐ЫчиЛщЧ┤щАЪф┐б"><a href="#хжВф╜Хф╜┐чФичобщБУш┐ЫшбМчИ╢хнРш┐ЫчиЛщЧ┤щАЪф┐б" class="header-anchor">#</a> хжВф╜Хф╜┐чФичобщБУш┐ЫшбМчИ╢хнРш┐ЫчиЛщЧ┤щАЪф┐бя╝Я</h3> <p>щжЦхЕИцИСф╗мшжБчЯещБУя╝Мх╜Уш┐ЫчиЛ A щАЪш┐Зш░ГчФи fork хЗ╜цХ░хИЫх╗║ф╕Аф╕кхнРш┐ЫчиЛ Bя╝МчД╢хРОш┐ЫчиЛ A хТМ B шжБш┐ЫшбМщАЪф┐бцЧ╢я╝МцИСф╗мщАЪх╕╕щГ╜щЬАшжБф╛Эш╡ЦцУНф╜Ьч│╗ч╗ЯцПРф╛ЫчЪДщАЪф┐бцЬ║хИ╢я╝МшАМ<strong>чобщБУ</strong>я╝Иpipeя╝Йх░▒цШпф╕АчзНчФиф║ОчИ╢хнРш┐ЫчиЛщЧ┤щАЪф┐бчЪДх╕╕чФицЬ║хИ╢уАВ</p> <p>хЕ╖ф╜УцЭешп┤я╝МчобщБУцЬ║хИ╢хЬицУНф╜Ьч│╗ч╗ЯхЖЕца╕ф╕нхИЫх╗║ф║Жф╕АхЭЧч╝УхЖ▓хМ║я╝МчИ╢ш┐ЫчиЛ A хПпф╗ецЙУх╝АчобщБУя╝Мх╣╢х╛Аш┐ЩхЭЧч╝УхЖ▓хМ║ф╕нхЖЩхЕецХ░цНоуАВхРМцЧ╢я╝МхнРш┐ЫчиЛ B ф╣ЯхПпф╗ецЙУх╝АчобщБУя╝Мф╗Ош┐ЩхЭЧч╝УхЖ▓хМ║ф╕ншп╗хПЦцХ░цНоуАВш┐ЩщЗМя╝Мф╜ащЬАшжБц│ицДПчЪДцШпя╝Мш┐ЫчиЛцпПцмбх╛АчобщБУф╕нхЖЩхЕецХ░цНоцЧ╢я╝МхПкшГ╜ш┐╜хКахЖЩхИ░ч╝УхЖ▓хМ║ф╕нх╜УхЙНцХ░цНоцЙАхЬичЪДх░╛щГия╝МшАМш┐ЫчиЛцпПцмбф╗ОчобщБУф╕ншп╗хПЦцХ░цНоцЧ╢я╝МхПкшГ╜ф╗Оч╝УхЖ▓хМ║чЪДхд┤щГишп╗хПЦцХ░цНоуАВ</p> <p>хЕ╢хоЮя╝МчобщБУхИЫх╗║чЪДш┐ЩхЭЧч╝УхЖ▓хМ║х░▒хГПф╕Аф╕к<strong>хЕИш┐ЫхЕИхЗ║</strong>чЪДщШЯхИЧф╕Аца╖я╝МхЖЩцХ░цНочЪДш┐ЫчиЛхЖЩхИ░щШЯхИЧх░╛щГия╝МшАМшп╗цХ░цНочЪДш┐ЫчиЛхИЩф╗ОщШЯхИЧхд┤шп╗хПЦуАВф╕ЛхЫ╛х░▒х▒Хчд║ф║Жф╕дф╕кш┐ЫчиЛф╜┐чФичобщБУш┐ЫшбМцХ░цНощАЪф┐бчЪДш┐ЗчиЛя╝Мф╜ахПпф╗ечЬЛф╕ЛуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409161655259.png" alt="image-20240916165526206"></p> <p>хе╜ф║Жя╝Мф║Жшзгф║ЖчобщБУчЪДхЯ║цЬмхКЯшГ╜хРОя╝МцИСф╗мхЖНцЭечЬЛф╕Лф╜┐чФичобщБУцЧ╢щЬАшжБц│ицДПчЪДф╕Аф╕кхЕ│щФочВ╣уАВ<strong>чобщБУф╕нчЪДцХ░цНохЬиф╕Аф╕кцЧ╢хИ╗хПкшГ╜хРСф╕Аф╕кцЦ╣хРСц╡БхКи</strong>я╝Мш┐Щф╣Ях░▒цШпшп┤я╝МхжВцЮЬчИ╢ш┐ЫчиЛ A х╛АчобщБУф╕нхЖЩхЕеф║ЖцХ░цНоя╝МщВгф╣ИцндцЧ╢хнРш┐ЫчиЛ B хПкшГ╜ф╗ОчобщБУф╕ншп╗хПЦцХ░цНоуАВч▒╗ф╝╝чЪДя╝МхжВцЮЬхнРш┐ЫчиЛ B х╛АчобщБУф╕нхЖЩхЕеф║ЖцХ░цНоя╝МщВгф╣ИцндцЧ╢чИ╢ш┐ЫчиЛ A хПкшГ╜ф╗ОчобщБУф╕ншп╗хПЦцХ░цНоуАВшАМхжВцЮЬчИ╢хнРш┐ЫчиЛщЧ┤щЬАшжБхРМцЧ╢ш┐ЫшбМцХ░цНоф╝аш╛УщАЪф┐бя╝МцИСф╗мх░▒щЬАшжБхИЫх╗║ф╕дф╕кчобщБУф║ЖуАВ</p> <p>ф╕ЛщЭвя╝МцИСф╗мх░▒цЭечЬЛф╕ЛцАОф╣ИчФиф╗гчаБхоЮчО░чобщБУщАЪф┐буАВш┐ЩхЕ╢хоЮцШпхТМцУНф╜Ьч│╗ч╗ЯцПРф╛ЫчЪДчобщБУчЪДч│╗ч╗Яш░ГчФи pipe цЬЙхЕ│я╝Мpipe чЪДхЗ╜цХ░хОЯхЮЛхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">pipe</span><span class="token punctuation">(</span><span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ф╜ахПпф╗ечЬЛхИ░я╝Мpipe чЪДхПВцХ░цШпф╕Аф╕к<strong>цХ░ч╗Д pipefd</strong>я╝Мшбичд║чЪДцШпчобщБУчЪДцЦЗф╗╢цППш┐░чмжуАВш┐ЩцШпхЫаф╕║ш┐ЫчиЛхЬих╛АчобщБУф╕нхЖЩхЕецИЦшп╗хПЦцХ░цНоцЧ╢я╝МхЕ╢хоЮцШпф╜┐чФи write цИЦ read хЗ╜цХ░чЪДя╝МшАМ write хТМ read хЗ╜цХ░щЬАшжБщАЪш┐З<strong>цЦЗф╗╢цППш┐░чмж</strong>цЙНшГ╜ш┐ЫшбМхЖЩцХ░цНохТМшп╗цХ░цНоцУНф╜ЬуАВ</p> <p>цХ░ч╗Д pipefd цЬЙф╕дф╕кхЕГч┤а pipefd[0]хТМ pipefd[1]я╝МхИЖхИлхп╣х║Фф║ЖчобщБУчЪДшп╗цППш┐░чмжхТМхЖЩцППш┐░чмжуАВш┐Щф╣Ях░▒цШпшп┤я╝Мх╜Уш┐ЫчиЛщЬАшжБф╗ОчобщБУф╕ншп╗цХ░цНоцЧ╢я╝Мх░▒щЬАшжБчФихИ░ pipefd[0]я╝МшАМх╛АчобщБУф╕нхЖЩхЕецХ░цНоцЧ╢я╝Мх░▒ф╜┐чФи pipefd[1]уАВ</p> <p>ш┐ЩщЗМцИСхЖЩф║Жф╕Аф╗╜чд║ф╛Лф╗гчаБя╝Мх▒Хчд║ф║ЖчИ╢хнРш┐ЫчиЛхжВф╜Хф╜┐чФичобщБУщАЪф┐бя╝Мф╜ахПпф╗ечЬЛф╕ЛуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> fd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> nr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> nw <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">pipe</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//хнРш┐ЫчиЛш░ГчФиreadф╗Оfd[0]цППш┐░чмжф╕ншп╗хПЦцХ░цНо</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;child process wait for message\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nr <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;child process receive %s\n&quot;</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
       <span class="token comment">//чИ╢ш┐ЫчиЛш░ГчФиwriteх╛Аfd[1]цППш┐░чмжф╕нхЖЩхЕецХ░цНо</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;parent process send message\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">&quot;Hello from parent&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nw <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;parent process send %d bytes to child.\n&quot;</span><span class="token punctuation">,</span> nw<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ф╗Оф╗гчаБф╕ня╝Мф╜ахПпф╗ечЬЛхИ░я╝МхЬичИ╢хнРш┐ЫчиЛш┐ЫшбМчобщБУщАЪф┐бхЙНя╝МцИСф╗мщЬАшжБхЬиф╗гчаБф╕нхоЪф╣ЙчФиф║Оф┐ЭхнШшп╗хЖЩцППш┐░чмжчЪД<strong>цХ░ч╗Д fd</strong>я╝МчД╢хРОш░ГчФи pipe ч│╗ч╗ЯхИЫх╗║чобщБУя╝Мх╣╢цККцХ░ч╗Д fd ф╜Ьф╕║хПВцХ░ф╝ач╗Щ pipe хЗ╜цХ░уАВч┤зцОечЭАя╝МхЬичИ╢ш┐ЫчиЛчЪДф╗гчаБф╕ня╝МчИ╢ш┐ЫчиЛф╝Ъш░ГчФи write хЗ╜цХ░х╛АчобщБУцЦЗф╗╢цППш┐░чмж fd[1]ф╕нхЖЩхЕецХ░цНоя╝МхПжф╕АцЦ╣щЭвя╝МхнРш┐ЫчиЛш░ГчФи read хЗ╜цХ░ф╗ОчобщБУцЦЗф╗╢цППш┐░чмж fd[0]ф╕ншп╗хПЦцХ░цНоуАВ</p> <p>ш┐ЩщЗМя╝Мф╕║ф║Жф╛┐ф║Оф╜ачРЖшзгя╝МцИСф╣ЯчФ╗ф║Жф╕Ах╝ахЫ╛я╝Мф╜ахПпф╗ехПВшАГуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409161655878.png" alt="image-20240916165516802"></p> <p>хе╜ф║Жя╝МчО░хЬиф╜ах░▒ф║Жшзгф║ЖхжВф╜Хф╜┐чФичобщБУцЭеш┐ЫшбМчИ╢хнРш┐ЫчиЛчЪДщАЪф┐бф║ЖуАВщВгф╣Иф╕ЛщЭвя╝МцИСф╗мх░▒цЭечЬЛф╕ЛхЬи AOF щЗНхЖЩш┐ЗчиЛф╕ня╝МщЗНхЖЩхнРш┐ЫчиЛцШпхжВф╜ХчФичобщБУхТМф╕╗ш┐ЫчиЛя╝Иф╣Ях░▒цШпхоГчЪДчИ╢ш┐ЫчиЛя╝Йш┐ЫшбМщАЪф┐бчЪДуАВ</p> <h3 id="aof-щЗНхЖЩхнРш┐ЫчиЛхжВф╜Хф╜┐чФичобщБУхТМчИ╢ш┐ЫчиЛф║дф║Т"><a href="#aof-щЗНхЖЩхнРш┐ЫчиЛхжВф╜Хф╜┐чФичобщБУхТМчИ╢ш┐ЫчиЛф║дф║Т" class="header-anchor">#</a> AOF щЗНхЖЩхнРш┐ЫчиЛхжВф╜Хф╜┐чФичобщБУхТМчИ╢ш┐ЫчиЛф║дф║Тя╝Я</h3> <p>цИСф╗мхЕИцЭечЬЛф╕ЛхЬи AOF щЗНхЖЩш┐ЗчиЛф╕ня╝МщГ╜хИЫх╗║ф║ЖхЗаф╕кчобщБУуАВ</p> <p>ш┐ЩхоЮщЩЕф╕КцШп AOF щЗНхЖЩхЗ╜цХ░ rewriteAppendOnlyFileBackground хЬицЙзшбМш┐ЗчиЛф╕ня╝МщАЪш┐Зш░ГчФи <strong>aofCreatePipes хЗ╜цХ░</strong>цЭехоМцИРчЪДя╝МхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">rewriteAppendOnlyFileBackground</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
тАж
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">aofCreatePipes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> C_OK<span class="token punctuation">)</span> <span class="token keyword">return</span> C_ERR<span class="token punctuation">;</span>
тАж
<span class="token punctuation">}</span>
</code></pre></div><p>ш┐Щф╕к aofCreatePipes хЗ╜цХ░цШпхЬи<a href="https://github.com/redis/redis/tree/5.0/src/aof.c" target="_blank" rel="noopener noreferrer">aof.c<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>цЦЗф╗╢ф╕нхоЮчО░чЪДя╝МхоГчЪДщА╗ш╛СцпФш╛ГчоАхНХя╝МхПпф╗ехИЖцИРф╕ЙцнеуАВ</p> <p><strong>чммф╕Ацне</strong>я╝МaofCreatePipes хЗ╜цХ░хИЫх╗║ф║ЖхМЕхРл 6 ф╕кцЦЗф╗╢цППш┐░чмжхЕГч┤ачЪД<strong>цХ░ч╗Д fds</strong>уАВх░▒хГПцИСхИЪцЙНч╗Щф╜аф╗Лч╗НчЪДя╝МцпПф╕Аф╕кчобщБУф╝Ъхп╣х║Фф╕дф╕кцЦЗф╗╢цППш┐░чмжя╝МцЙАф╗ея╝МцХ░ч╗Д fds хЕ╢хоЮхп╣х║Фф║Ж AOF щЗНхЖЩш┐ЗчиЛф╕ншжБчФихИ░чЪДф╕Йф╕кчобщБУуАВч┤зцОечЭАя╝МaofCreatePipes хЗ╜цХ░х░▒ш░ГчФи pipe ч│╗ч╗Яш░ГчФихЗ╜цХ░я╝МхИЖхИлхИЫх╗║ф╕Йф╕кчобщБУуАВ</p> <p>ш┐ЩщГихИЖф╗гчаБхжВф╕ЛцЙАчд║я╝Мф╜ахПпф╗ечЬЛф╕ЛуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">aofCreatePipes</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> fds<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> j<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pipe</span><span class="token punctuation">(</span>fds<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> error<span class="token punctuation">;</span> <span class="token comment">/* parent -&gt; children data. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pipe</span><span class="token punctuation">(</span>fds<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> error<span class="token punctuation">;</span> <span class="token comment">/* children -&gt; parent ack. */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pipe</span><span class="token punctuation">(</span>fds<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
  тАж<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>чммф║Мцне</strong>я╝МaofCreatePipes хЗ╜цХ░ф╝Ъш░ГчФи <strong>anetNonBlock хЗ╜цХ░</strong>я╝ИхЬи<a href="https://github.com/redis/redis/tree/5.0/src/anet.c" target="_blank" rel="noopener noreferrer">anet.c<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>цЦЗф╗╢ф╕ня╝Йя╝Мх░Ж fds</p> <p>цХ░ч╗ДчЪДчммф╕АхТМчммф║Мф╕кцППш┐░чмжя╝Иfds[0]хТМ fds[1]я╝Йхп╣х║ФчЪДчобщБУшо╛ч╜оф╕║щЭЮщШ╗хбЮуАВчД╢хРОя╝МaofCreatePipes хЗ╜цХ░ф╝Ъш░ГчФи <strong>aeCreateFileEvent хЗ╜цХ░</strong>я╝МхЬицХ░ч╗Д fds чЪДчммф╕Йф╕кцППш┐░чмж (fds[2]) ф╕Кц│ихЖМф║Жшп╗ф║Лф╗╢чЪДчЫСхРмя╝Мхп╣х║ФчЪДхЫЮш░ГхЗ╜цХ░цШп aofChildPipeReadableуАВaofChildPipeReadable хЗ╜цХ░ф╣ЯцШпхЬи aof.c цЦЗф╗╢ф╕нхоЮчО░чЪДя╝МцИСчиНхРОф╝Ъч╗Щф╜ашпжч╗Жф╗Лч╗НхоГуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">aofCreatePipes</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
тАж
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">anetNonBlock</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>fds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> ANET_OK<span class="token punctuation">)</span> <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">anetNonBlock</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>fds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> ANET_OK<span class="token punctuation">)</span> <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">aeCreateFileEvent</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">,</span> fds<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> AE_READABLE<span class="token punctuation">,</span> aofChildPipeReadable<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> AE_ERR<span class="token punctuation">)</span> <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
тАж
<span class="token punctuation">}</span>
</code></pre></div><p>ш┐Щца╖я╝МхЬихоМцИРф║ЖчобщБУхИЫх╗║уАБчобщБУшо╛ч╜охТМшп╗ф║Лф╗╢ц│ихЖМхРОя╝МцЬАхРОф╕Ацнея╝МaofCreatePipes хЗ╜цХ░ф╝Ъх░ЖцХ░ч╗Д fds ф╕нчЪДхЕнф╕кцЦЗф╗╢цППш┐░чмжя╝МхИЖхИлхдНхИ╢ч╗Щ server хПШщЗПчЪДцИРхСШхПШщЗПя╝МхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">aofCreatePipes</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
тАж
server<span class="token punctuation">.</span>aof_pipe_write_data_to_child <span class="token operator">=</span> fds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span>aof_pipe_read_data_from_parent <span class="token operator">=</span> fds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span>aof_pipe_write_ack_to_parent <span class="token operator">=</span> fds<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span>aof_pipe_read_ack_from_child <span class="token operator">=</span> fds<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span>aof_pipe_write_ack_to_child <span class="token operator">=</span> fds<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span>aof_pipe_read_ack_from_parent <span class="token operator">=</span> fds<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
тАж
<span class="token punctuation">}</span>
</code></pre></div><p>хЬиш┐Щф╕Ацнеф╕ня╝МцИСф╗мх░▒хПпф╗еф╗О server хПШщЗПчЪДцИРхСШхПШщЗПхРНф╕ня╝МчЬЛхИ░ aofCreatePipes хЗ╜цХ░хИЫх╗║чЪДф╕Йф╕кчобщБУя╝Мф╗ехПКхоГф╗мхРДшЗкчЪДчФищАФуАВ</p> <ul><li><strong>fds[0]хТМ fds[1]</strong>я╝Ъхп╣х║Фф║Жф╕╗ш┐ЫчиЛхТМщЗНхЖЩхнРш┐ЫчиЛщЧ┤чФиф║Оф╝ащАТцУНф╜ЬхС╜ф╗дчЪДчобщБУя╝МхоГф╗мхИЖхИлхп╣х║Фшп╗цППш┐░чмжхТМхЖЩцППш┐░чмжуАВ</li> <li><strong>fds[2]хТМ fds[3]</strong>я╝Ъхп╣х║Фф║ЖщЗНхЖЩхнРш┐ЫчиЛхРСчИ╢ш┐ЫчиЛхПСщАБ ACK ф┐бцБпчЪДчобщБУя╝МхоГф╗мхИЖхИлхп╣х║Фшп╗цППш┐░чмжхТМхЖЩцППш┐░чмжуАВ</li> <li><strong>fds[4]хТМ fds[5]</strong>я╝Ъхп╣х║Фф║ЖчИ╢ш┐ЫчиЛхРСщЗНхЖЩхнРш┐ЫчиЛхПСщАБ ACK ф┐бцБпчЪДчобщБУя╝МхоГф╗мхИЖхИлхп╣х║Фшп╗цППш┐░чмжхТМхЖЩцППш┐░чмжуАВ</li></ul> <p>ф╕ЛхЫ╛ф╣Ях▒Хчд║ф║Ж aofCreatePipes хЗ╜цХ░чЪДхЯ║цЬмцЙзшбМц╡БчиЛя╝Мф╜ахПпф╗ехЖНхЫЮщб╛ф╕ЛуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409161655945.png" alt="image-20240916165506872"></p> <p>хе╜ф║Жя╝Мф║Жшзгф║Ж AOF щЗНхЖЩш┐ЗчиЛф╕нчЪДчобщБУф╕кцХ░хТМчФищАФхРОя╝Мф╕ЛщЭвцИСф╗мхЖНцЭечЬЛф╕Лш┐Щф║ЫчобщБУхЕ╖ф╜УцШпхжВф╜Хф╜┐чФичЪДуАВ</p> <h4 id="цУНф╜ЬхС╜ф╗дф╝аш╛УчобщБУчЪДф╜┐чФи"><a href="#цУНф╜ЬхС╜ф╗дф╝аш╛УчобщБУчЪДф╜┐чФи" class="header-anchor">#</a> цУНф╜ЬхС╜ф╗дф╝аш╛УчобщБУчЪДф╜┐чФи</h4> <p>хоЮщЩЕф╕Кя╝Мх╜У AOF щЗНхЖЩхнРш┐ЫчиЛхЬицЙзшбМцЧ╢я╝Мф╕╗ш┐ЫчиЛш┐Шф╝Ъч╗зч╗нцОецФ╢хТМхдДчРЖховцИ╖члпхЖЩшп╖ц▒ВуАВш┐Щф║ЫхЖЩцУНф╜Ьф╝Ъшвлф╕╗ш┐ЫчиЛцнгх╕╕хЖЩхЕе AOF цЧех┐ЧцЦЗф╗╢я╝Мш┐Щф╕кш┐ЗчиЛцШпчФ▒ <strong>feedAppendOnlyFile хЗ╜цХ░</strong>я╝ИхЬи aof.c цЦЗф╗╢ф╕ня╝ЙцЭехоМцИРуАВ</p> <p>feedAppendOnlyFile хЗ╜цХ░хЬицЙзшбМчЪДцЬАхРОф╕Ацнея╝Мф╝ЪхИдцЦнх╜УхЙНцШпхРжцЬЙ AOF щЗНхЖЩхнРш┐ЫчиЛхЬиш┐РшбМуАВхжВцЮЬцЬЙчЪДшпЭя╝МхоГх░▒ф╝Ъш░ГчФи <strong>aofRewriteBufferAppend хЗ╜цХ░</strong>я╝ИхЬи aof.c цЦЗф╗╢ф╕ня╝Йя╝МхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_child_pid <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">aofRewriteBufferAppend</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">,</span><span class="token function">sdslen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>aofRewriteBufferAppend хЗ╜цХ░чЪДф╜ЬчФицШпх░ЖхПВцХ░ bufя╝Мш┐╜хКахЖЩхИ░хЕих▒АхПШщЗП server чЪД aof_rewrite_buf_blocks ш┐Щф╕кхИЧшбиф╕нуАВ</p> <p>ш┐ЩщЗМя╝Мф╜ащЬАшжБц│ицДПчЪДцШпя╝М<strong>хПВцХ░ buf цШпф╕Аф╕кхнЧшКВцХ░ч╗Д</strong>я╝МfeedAppendOnlyFile хЗ╜цХ░ф╝Ъх░Жф╕╗ш┐ЫчиЛцФ╢хИ░чЪДхС╜ф╗дцУНф╜ЬхЖЩхЕехИ░ buf ф╕нуАВшАМ aof_rewrite_buf_blocks хИЧшбиф╕нчЪДцпПф╕кхЕГч┤ацШп <strong>aofrwblock ч╗УцЮДф╜Уч▒╗хЮЛ</strong>я╝Мш┐Щф╕кч╗УцЮДф╜Уф╕нхМЕцЛмф║Жф╕Аф╕кхнЧшКВцХ░ч╗Дя╝Мхдзх░ПцШп AOF_RW_BUF_BLOCK_SIZEя╝Мщ╗ШшодхА╝цШп 10MBуАВцндхдЦя╝Мaofrwblock ч╗УцЮДф╜Уш┐Шшо░х╜Хф║ЖхнЧшКВцХ░ч╗Дх╖▓ч╗Пф╜┐чФичЪДчй║щЧ┤хТМхЙйф╜ЩхПпчФичЪДчй║щЧ┤уАВ</p> <p>ф╗еф╕Лф╗гчаБх▒Хчд║ф║Ж aofrwblock ч╗УцЮДф╜УчЪДхоЪф╣Йя╝Мф╜ахПпф╗ечЬЛф╕ЛуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">aofrwblock</span> <span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> used<span class="token punctuation">,</span> free<span class="token punctuation">;</span> <span class="token comment">//bufцХ░ч╗Дх╖▓чФичй║щЧ┤хТМхЙйф╜ЩхПпчФичй║щЧ┤</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>AOF_RW_BUF_BLOCK_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//хоПхоЪф╣ЙAOF_RW_BUF_BLOCK_SIZEщ╗Шшодф╕║10MB</span>
<span class="token punctuation">}</span> aofrwblock<span class="token punctuation">;</span>
</code></pre></div><p>ш┐Щца╖ф╕АцЭея╝Мaofrwblock ч╗УцЮДф╜Ух░▒чЫ╕х╜Уф║ОцШпф╕Аф╕к 10MB чЪДцХ░цНохЭЧя╝Мшо░х╜Хф║Ж AOF щЗНхЖЩцЬЯщЧ┤ф╕╗ш┐ЫчиЛцФ╢хИ░чЪДхС╜ф╗дя╝МшАМ aof_rewrite_buf_blocks хИЧшбиш┤Яш┤гх░Жш┐Щф║ЫцХ░цНохЭЧш┐ЮцОеш╡╖цЭеуАВх╜У aofRewriteBufferAppend хЗ╜цХ░цЙзшбМцЧ╢я╝МхоГф╝Ъф╗О aof_rewrite_buf_blocks хИЧшбиф╕нхПЦхЗ║ф╕Аф╕к aofrwblock ч▒╗хЮЛчЪДцХ░цНохЭЧя╝МчФицЭешо░х╜ХхС╜ф╗дцУНф╜ЬуАВ</p> <p>х╜УчД╢я╝МхжВцЮЬх╜УхЙНцХ░цНохЭЧф╕нчЪДчй║щЧ┤ф╕НхдЯф┐ЭхнШхПВцХ░ buf ф╕ншо░х╜ХчЪДхС╜ф╗дцУНф╜Ья╝МщВгф╣И aofRewriteBufferAppend хЗ╜цХ░х░▒ф╝ЪхЖНхИЖщЕНф╕Аф╕к aofrwblock цХ░цНохЭЧуАВ</p> <p>хе╜ф║Жя╝Мх╜У aofRewriteBufferAppend хЗ╜цХ░х░ЖхС╜ф╗дцУНф╜Ьшо░х╜ХхИ░ aof_rewrite_buf_blocks хИЧшбиф╕нф╣ЛхРОя╝МхоГш┐Шф╝Ъ<strong>цгАцЯе aof_pipe_write_data_to_child чобщБУцППш┐░чмжф╕КцШпхРжц│ихЖМф║ЖхЖЩф║Лф╗╢</strong>я╝Мш┐Щф╕кчобщБУцППш┐░чмжх░▒хп╣х║Фф║ЖцИСхИЪцЙНч╗Щф╜аф╗Лч╗НчЪД fds[1]уАВ</p> <p>хжВцЮЬц▓бцЬЙц│ихЖМхЖЩф║Лф╗╢я╝МщВгф╣И aofRewriteBufferAppend хЗ╜цХ░х░▒ф╝Ъш░ГчФи <strong>aeCreateFileEvent хЗ╜цХ░</strong>я╝Мц│ихЖМф╕Аф╕кхЖЩф║Лф╗╢я╝Мш┐Щф╕кхЖЩф║Лф╗╢ф╝ЪчЫСхРм aof_pipe_write_data_to_child ш┐Щф╕кчобщБУцППш┐░чмжя╝Мф╣Ях░▒цШпф╕╗ш┐ЫчиЛхТМщЗНхЖЩхнРш┐ЫчиЛщЧ┤чЪДцУНф╜ЬхС╜ф╗дф╝аш╛УчобщБУуАВ</p> <p>х╜Уш┐Щф╕кчобщБУхПпф╗ехЖЩхЕецХ░цНоцЧ╢я╝МхЖЩф║Лф╗╢хп╣х║ФчЪДхЫЮш░ГхЗ╜цХ░ aofChildWriteDiffDataя╝ИхЬи aof.c цЦЗф╗╢ф╕ня╝Йх░▒ф╝Ъшвлш░ГчФицЙзшбМуАВш┐Щф╕кш┐ЗчиЛф╜ахПпф╗ехПВшАГф╕ЛщЭвчЪДф╗гчаБя╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">aofRewriteBufferAppend</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">//цгАцЯеaof_pipe_write_data_to_childцППш┐░чмжф╕КцШпхРжцЬЙф║Лф╗╢</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">aeGetFileEvents</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">,</span>server<span class="token punctuation">.</span>aof_pipe_write_data_to_child<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">//хжВцЮЬц▓бцЬЙц│ихЖМф║Лф╗╢я╝МщВгф╣Иц│ихЖМф╕Аф╕кхЖЩф║Лф╗╢я╝МхЫЮш░ГхЗ╜цХ░цШпaofChildWriteDiffData</span>
     <span class="token function">aeCreateFileEvent</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">,</span> server<span class="token punctuation">.</span>aof_pipe_write_data_to_child<span class="token punctuation">,</span>
            AE_WRITABLE<span class="token punctuation">,</span> aofChildWriteDiffData<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
</code></pre></div><p>хЕ╢хоЮя╝МхИЪцЙНцИСф╗Лч╗НчЪДхЖЩф║Лф╗╢хЫЮш░ГхЗ╜цХ░ aofChildWriteDiffDataя╝МхоГчЪД<strong>ф╕╗шжБф╜ЬчФи</strong>цШпф╗О aof_rewrite_buf_blocks хИЧшбиф╕нщАРф╕кхПЦхЗ║цХ░цНохЭЧя╝МчД╢хРОщАЪш┐З aof_pipe_write_data_to_child чобщБУцППш┐░чмжя╝Мх░ЖцХ░цНохЭЧф╕нчЪДхС╜ф╗дцУНф╜ЬщАЪш┐ЗчобщБУхПСч╗ЩщЗНхЖЩхнРш┐ЫчиЛя╝Мш┐Щф╕кш┐ЗчиЛхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">aofChildWriteDiffData</span><span class="token punctuation">(</span>aeEventLoop <span class="token operator">*</span>el<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">,</span> <span class="token keyword">int</span> mask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">//ф╗Оaof_rewrite_buf_blocksхИЧшбиф╕нхПЦхЗ║цХ░цНохЭЧ</span>
   ln <span class="token operator">=</span> <span class="token function">listFirst</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_rewrite_buf_blocks<span class="token punctuation">)</span><span class="token punctuation">;</span>
   block <span class="token operator">=</span> ln <span class="token operator">?</span> ln<span class="token operator">-&gt;</span>value <span class="token operator">:</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>block<span class="token operator">-&gt;</span>used <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//ш░ГчФиwriteх░ЖцХ░цНохЭЧхЖЩхЕеф╕╗ш┐ЫчиЛхТМщЗНхЖЩхнРш┐ЫчиЛщЧ┤чЪДчобщБУ</span>
      nwritten <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_pipe_write_data_to_child<span class="token punctuation">,</span>
                             block<span class="token operator">-&gt;</span>buf<span class="token punctuation">,</span>block<span class="token operator">-&gt;</span>used<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>nwritten <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre></div><p>хе╜ф║Жя╝Мш┐Щца╖ф╕АцЭея╝Мф╜ах░▒ф║Жшзгф║Жф╕╗ш┐ЫчиЛхЕ╢хоЮцШпхЬицнгх╕╕шо░х╜Х AOF цЧех┐ЧцЧ╢я╝Мх░ЖцФ╢хИ░чЪДхС╜ф╗дцУНф╜ЬхЖЩхЕе aof_rewrite_buf_blocks хИЧшбиф╕нчЪДцХ░цНохЭЧя╝МчД╢хРОхЖНщАЪш┐З aofChildWriteDiffData хЗ╜цХ░х░Жшо░х╜ХчЪДхС╜ф╗дцУНф╜ЬщАЪш┐Зф╕╗ш┐ЫчиЛхТМщЗНхЖЩхнРш┐ЫчиЛщЧ┤чЪДчобщБУхПСч╗ЩхнРш┐ЫчиЛуАВ</p> <p>ф╕ЛхЫ╛ф╣Ях▒Хчд║ф║Жш┐Щф╕кш┐ЗчиЛя╝Мф╜ахПпф╗ехЖНцЭехЫЮщб╛ф╕ЛуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409161654611.png" alt="image-20240916165457519"></p> <p>чД╢хРОя╝МцИСф╗мцОечЭАцЭечЬЛф╕ЛщЗНхЖЩхнРш┐ЫчиЛя╝МцШпхжВф╜Хф╗ОчобщБУф╕ншп╗хПЦчИ╢ш┐ЫчиЛхПСщАБчЪДхС╜ф╗дцУНф╜ЬчЪДуАВ</p> <p>ш┐ЩхоЮщЩЕф╕КцШпчФ▒ <strong>aofReadDiffFromParent хЗ╜цХ░</strong>я╝ИхЬи aof.c цЦЗф╗╢ф╕ня╝ЙцЭехоМцИРчЪДуАВш┐Щф╕кхЗ╜цХ░ф╝Ъф╜┐чФиф╕Аф╕к 64KB хдзх░ПчЪДч╝УхЖ▓хМ║я╝МчД╢хРОш░ГчФи read хЗ╜цХ░я╝Мшп╗хПЦчИ╢ш┐ЫчиЛхТМщЗНхЖЩхнРш┐ЫчиЛщЧ┤чЪДцУНф╜ЬхС╜ф╗дф╝аш╛УчобщБУф╕нчЪДцХ░цНоуАВф╗еф╕Лф╗гчаБф╣Ях▒Хчд║ф║Ж aofReadDiffFromParent хЗ╜цХ░чЪДхЯ║цЬмцЙзшбМц╡БчиЛя╝Мф╜ахПпф╗ечЬЛф╕ЛуАВ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token class-name">ssize_t</span> <span class="token function">aofReadDiffFromParent</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">65536</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//чобщБУщ╗ШшодчЪДч╝УхЖ▓хМ║хдзх░П</span>
    <span class="token class-name">ssize_t</span> nread<span class="token punctuation">,</span> total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">//ш░ГчФиreadхЗ╜цХ░ф╗Оaof_pipe_read_data_from_parentф╕ншп╗хПЦцХ░цНо</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nread <span class="token operator">=</span>
      <span class="token function">read</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_pipe_read_data_from_parent<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        server<span class="token punctuation">.</span>aof_child_diff <span class="token operator">=</span> <span class="token function">sdscatlen</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_child_diff<span class="token punctuation">,</span>buf<span class="token punctuation">,</span>nread<span class="token punctuation">)</span><span class="token punctuation">;</span>
        total <span class="token operator">+=</span> nread<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> total<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>щВгф╣Ия╝Мф╗Оф╗гчаБф╕ня╝Мф╜ахПпф╗ечЬЛхИ░ aofReadDiffFromParent хЗ╜цХ░ф╝ЪщАЪш┐З <strong>aof_pipe_read_data_from_parent цППш┐░чмж</strong>шп╗хПЦцХ░цНоуАВчД╢хРОя╝МхоГф╝Ъх░Жшп╗хПЦчЪДцУНф╜ЬхС╜ф╗дш┐╜хКахИ░хЕих▒АхПШщЗП server чЪД aof_child_diff хнЧчмжф╕▓ф╕нуАВшАМхЬи AOF щЗНхЖЩхЗ╜цХ░ rewriteAppendOnlyFile чЪДцЙзшбМш┐ЗчиЛцЬАхРОя╝М<strong>aof_child_diff хнЧчмжф╕▓</strong>ф╝ЪшвлхЖЩхЕе AOF щЗНхЖЩцЧех┐ЧцЦЗф╗╢я╝Мф╗еф╛┐цИСф╗мхЬиф╜┐чФи AOF щЗНхЖЩцЧех┐ЧцЧ╢я╝МшГ╜х░╜хПпшГ╜хЬ░цБвхдНщЗНхЖЩцЬЯщЧ┤цФ╢хИ░чЪДцУНф╜ЬуАВ</p> <p>ш┐Щф╕к aof_child_diff хнЧчмжф╕▓хЖЩхЕещЗНхЖЩцЧех┐ЧцЦЗф╗╢чЪДш┐ЗчиЛя╝Мф╜ахПпф╗ехПВшАГф╕ЛщЭвч╗ЩхЗ║чЪДф╗гчаБя╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">rewriteAppendOnlyFile</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">//х░Жaof_child_diffф╕нч┤пчзпчЪДцУНф╜ЬхС╜ф╗дхЖЩхЕеAOFщЗНхЖЩцЧех┐ЧцЦЗф╗╢</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rioWrite</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>aof<span class="token punctuation">,</span>server<span class="token punctuation">.</span>aof_child_diff<span class="token punctuation">,</span><span class="token function">sdslen</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_child_diff<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>цЙАф╗еф╣Ях░▒цШпшп┤я╝МaofReadDiffFromParent хЗ╜цХ░хоЮчО░ф║ЖщЗНхЖЩхнРш┐ЫчиЛхРСф╕╗ш┐ЫчиЛшп╗хПЦцУНф╜ЬхС╜ф╗дуАВщВгф╣ИхЬиш┐ЩщЗМя╝МцИСф╗мш┐ШщЬАшжБцРЮц╕ЕцеЪчЪДщЧощвШцШпя╝ЪaofReadDiffFromParent хЗ╜цХ░ф╝ЪхЬихУкщЗМшвлш░ГчФия╝Мф╣Ях░▒цШпщЗНхЖЩхнРш┐ЫчиЛф╝ЪхЬиф╗Аф╣ИцЧ╢хАЩф╗ОчобщБУф╕ншп╗хПЦф╕╗ш┐ЫчиЛцФ╢хИ░чЪДцУНф╜ЬуАВ</p> <p>хЕ╢хоЮя╝МaofReadDiffFromParent хЗ╜цХ░ф╕АхЕ▒ф╝Ъшвлф╗еф╕Лф╕Йф╕кхЗ╜цХ░ш░ГчФиуАВ</p> <ul><li><strong>rewriteAppendOnlyFileRio хЗ╜цХ░</strong>я╝Ъш┐Щф╕кхЗ╜цХ░цШпчФ▒щЗНхЖЩхнРш┐ЫчиЛцЙзшбМчЪДя╝МхоГш┤Яш┤гщБНхОЖ Redis цпПф╕кцХ░цНох║Уя╝МчФЯцИР AOF щЗНхЖЩцЧех┐Чя╝МхЬиш┐Щф╕кш┐ЗчиЛф╕ня╝МхоГф╝Ъф╕НцЧ╢хЬ░ш░ГчФи aofReadDiffFromParent хЗ╜цХ░уАВ</li> <li><strong>rewriteAppendOnlyFile хЗ╜цХ░</strong>я╝Ъш┐Щф╕кхЗ╜цХ░цШпщЗНхЖЩцЧех┐ЧчЪДф╕╗ф╜УхЗ╜цХ░я╝Мф╣ЯцШпчФ▒щЗНхЖЩхнРш┐ЫчиЛцЙзшбМчЪДя╝МхоГцЬмш║лф╝Ъш░ГчФи rewriteAppendOnlyFileRio хЗ╜цХ░уАВцндхдЦя╝МхоГхЬиш░ГчФихоМ rewriteAppendOnlyFileRio хЗ╜цХ░хРОя╝Мш┐Шф╝ЪхдЪцмбш░ГчФи aofReadDiffFromParent хЗ╜цХ░я╝Мф╗ех░╜хПпшГ╜хдЪхЬ░шп╗хПЦф╕╗ш┐ЫчиЛхЬищЗНхЖЩцЧех┐ЧцЬЯщЧ┤цФ╢хИ░чЪДцУНф╜ЬхС╜ф╗дуАВ</li> <li><strong>rdbSaveRio хЗ╜цХ░</strong>я╝Ъш┐Щф╕кхЗ╜цХ░цШпхИЫх╗║ RDB цЦЗф╗╢чЪДф╕╗ф╜УхЗ╜цХ░уАВх╜УцИСф╗мф╜┐чФи AOF хТМ RDB ц╖╖хРИцМБф╣ЕхМЦцЬ║хИ╢цЧ╢я╝Мш┐Щф╕кхЗ╜цХ░ф╣Яф╝Ъш░ГчФи aofReadDiffFromParent хЗ╜цХ░уАВ</li></ul> <p>ф╗Ош┐ЩщЗМя╝МцИСф╗мхПпф╗ечЬЛхИ░я╝МRedis ц║РчаБхЬихоЮчО░ AOF щЗНхЖЩш┐ЗчиЛф╕ня╝МхЕ╢хоЮф╝ЪхдЪцмбшойщЗНхЖЩхнРш┐ЫчиЛхРСф╕╗ш┐ЫчиЛшп╗хПЦцЦ░цФ╢хИ░чЪДцУНф╜ЬхС╜ф╗дя╝Мш┐Щф╣ЯцШпф╕║ф║ЖшойщЗНхЖЩцЧех┐Чх░╜хПпшГ╜хдЪхЬ░шо░х╜ХцЬАцЦ░чЪДцУНф╜Ья╝МцПРф╛ЫцЫ┤хКахоМцХ┤чЪДцУНф╜Ьшо░х╜ХуАВ</p> <p>цЬАхРОя╝МцИСф╗мхЖНцЭечЬЛф╕ЛщЗНхЖЩхнРш┐ЫчиЛхТМф╕╗ш┐ЫчиЛщЧ┤чФицЭеф╝ащАТ ACK ф┐бцБпчЪДф╕дф╕кчобщБУчЪДф╜┐чФиуАВ</p> <h4 id="ack-чобщБУчЪДф╜┐чФи"><a href="#ack-чобщБУчЪДф╜┐чФи" class="header-anchor">#</a> ACK чобщБУчЪДф╜┐чФи</h4> <p>хИЪцЙНхЬиф╗Лч╗Нф╕╗ш┐ЫчиЛш░ГчФи aofCreatePipes хЗ╜цХ░хИЫх╗║чобщБУцЧ╢я╝Мф╜ах░▒ф║ЖшзгхИ░ф║Жя╝Мф╕╗ш┐ЫчиЛф╝ЪхЬи aof_pipe_read_ack_from_child чобщБУцППш┐░чмжф╕Кц│ихЖМшп╗ф║Лф╗╢уАВш┐Щф╕кцППш┐░чмжхп╣х║Фф║ЖщЗНхЖЩхнРш┐ЫчиЛхРСф╕╗ш┐ЫчиЛхПСщАБ ACK ф┐бцБпчЪДчобщБУуАВхРМцЧ╢я╝Мш┐Щф╕кцППш┐░чмжцШпф╕Аф╕к<strong>шп╗цППш┐░чмж</strong>я╝Мшбичд║ф╕╗ш┐ЫчиЛф╗ОчобщБУф╕ншп╗хПЦ ACK ф┐бцБпуАВ</p> <p>хЕ╢хоЮя╝МщЗНхЖЩхнРш┐ЫчиЛхЬицЙзшбМ rewriteAppendOnlyFile хЗ╜цХ░цЧ╢я╝Мш┐Щф╕кхЗ╜цХ░хЬихоМцИРцЧех┐ЧщЗНхЖЩя╝Мф╗ехПКхдЪцмбхРСчИ╢ш┐ЫчиЛшп╗хПЦцУНф╜ЬхС╜ф╗дхРОя╝Мх░▒ф╝Ъш░ГчФи write хЗ╜цХ░я╝МхРС aof_pipe_write_ack_to_parent цППш┐░чмжхп╣х║ФчЪДчобщБУф╕н<strong>хЖЩхЕетАЬя╝БтАЭ</strong>я╝Мш┐Щх░▒цШпщЗНхЖЩхнРш┐ЫчиЛхРСф╕╗ш┐ЫчиЛхПСщАБ ACK ф┐бхП╖я╝Мшойф╕╗ш┐ЫчиЛхБЬцнвхПСщАБцФ╢хИ░чЪДцЦ░хЖЩцУНф╜ЬуАВш┐Щф╕кш┐ЗчиЛхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">rewriteAppendOnlyFile</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_pipe_write_ack_to_parent<span class="token punctuation">,</span><span class="token string">&quot;!&quot;</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
</code></pre></div><p>ф╕АцЧжщЗНхЖЩхнРш┐ЫчиЛхРСф╕╗ш┐ЫчиЛхПСщАБ ACK ф┐бцБпчЪДчобщБУф╕нцЬЙф║ЖцХ░цНоя╝Мaof_pipe_read_ack_from_child чобщБУцППш┐░чмжф╕Кц│ихЖМчЪДшп╗ф║Лф╗╢х░▒ф╝ЪшвлшзжхПСя╝Мф╣Ях░▒цШпшп┤я╝Мш┐Щф╕кчобщБУф╕нцЬЙцХ░цНохПпф╗ешп╗хПЦф║ЖуАВщВгф╣Ия╝Мaof_pipe_read_ack_from_child чобщБУцППш┐░чмжф╕Кя╝Мц│ихЖМчЪД<strong>хЫЮш░ГхЗ╜цХ░ aofChildPipeReadable</strong>я╝ИхЬи aof.c цЦЗф╗╢ф╕ня╝Йх░▒ф╝ЪцЙзшбМуАВ</p> <p>ш┐Щф╕кхЗ╜цХ░ф╝ЪхИдцЦнф╗О aof_pipe_read_ack_from_child чобщБУцППш┐░чмжшп╗хПЦчЪДцХ░цНоцШпхРжцШптАЬя╝БтАЭя╝МхжВцЮЬцШпчЪДшпЭя╝МщВгхоГх░▒ф╝Ъш░ГчФи write хЗ╜цХ░я╝Мх╛А aof_pipe_write_ack_to_child чобщБУцППш┐░чмжф╕КхЖЩхЕетАЬя╝БтАЭя╝Мшбичд║ф╕╗ш┐ЫчиЛх╖▓ч╗ПцФ╢хИ░щЗНхЖЩхнРш┐ЫчиЛхПСщАБчЪД ACK ф┐бцБпя╝МхРМцЧ╢хоГф╝Ъч╗ЩщЗНхЖЩхнРш┐ЫчиЛхЫЮхдНф╕Аф╕к ACK ф┐бцБпуАВш┐Щф╕кш┐ЗчиЛхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">aofChildPipeReadable</span><span class="token punctuation">(</span>aeEventLoop <span class="token operator">*</span>el<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">,</span> <span class="token keyword">int</span> mask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span><span class="token operator">&amp;</span>byte<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> byte <span class="token operator">==</span> <span class="token char">'!'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_pipe_write_ack_to_child<span class="token punctuation">,</span><span class="token string">&quot;!&quot;</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>хе╜ф║Жя╝МхИ░ш┐ЩщЗМя╝МцИСф╗мх░▒ф║Жшзгф║Жя╝МщЗНхЖЩхнРш┐ЫчиЛхЬихоМцИРцЧех┐ЧщЗНхЖЩхРОя╝МцШпхЕИч╗Щф╕╗ш┐ЫчиЛхПСщАБ ACK ф┐бцБпуАВчД╢хРОф╕╗ш┐ЫчиЛхЬи aof_pipe_read_ack_from_child цППш┐░чмжф╕КчЫСхРмшп╗ф║Лф╗╢хПСчФЯя╝Мх╣╢ш░ГчФи aofChildPipeReadable хЗ╜цХ░хРСхнРш┐ЫчиЛхПСщАБ ACK ф┐бцБпуАВ</p> <p>цЬАхРОя╝МщЗНхЖЩхнРш┐ЫчиЛцЙзшбМчЪД rewriteAppendOnlyFile хЗ╜цХ░я╝Мф╝Ъш░ГчФи <strong>syncRead хЗ╜цХ░</strong>я╝Мф╗О aof_pipe_read_ack_from_parent чобщБУцППш┐░чмжф╕Кя╝Мшп╗хПЦф╕╗ш┐ЫчиЛхПСщАБч╗ЩхоГчЪД ACK ф┐бцБпя╝МхжВф╕ЛцЙАчд║я╝Ъ</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">rewriteAppendOnlyFile</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">syncRead</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_pipe_read_ack_from_parent<span class="token punctuation">,</span><span class="token operator">&amp;</span>byte<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5000</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span>  <span class="token operator">||</span> byte <span class="token operator">!=</span> <span class="token char">'!'</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> werr
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ф╕ЛхЫ╛ф╣Ях▒Хчд║ф║Ж ACK чобщБУчЪДф╜┐чФиш┐ЗчиЛя╝Мф╜ахПпф╗ехЖНхЫЮщб╛ф╕ЛуАВ</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409161654433.png" alt="image-20240916165439319"></p> <p>ш┐Щца╖ф╕АцЭея╝МщЗНхЖЩхнРш┐ЫчиЛхТМф╕╗ш┐ЫчиЛф╣ЛщЧ┤х░▒щАЪш┐Зф╕дф╕к ACK чобщБУя╝МчЫ╕ф║ТчбошодщЗНхЖЩш┐ЗчиЛч╗УцЭЯф║ЖуАВ</p> <h2 id="цА╗ч╗У"><a href="#цА╗ч╗У" class="header-anchor">#</a> цА╗ч╗У</h2> <ol><li><p><strong>AOF щЗНхЖЩчЪДшзжхПСцЧ╢цЬ║</strong>уАВш┐ЩцЧвхМЕцЛмф║ЖцИСф╗мф╕╗хКицЙзшбМ bgrewriteaof хС╜ф╗дя╝Мф╣ЯхМЕцЛмф║Ж Redis server ца╣цНо AOF цЦЗф╗╢хдзх░ПшАМшЗкхКишзжхПСчЪДщЗНхЖЩуАВцндхдЦя╝МхЬиф╕╗ф╗ОхдНхИ╢чЪДш┐ЗчиЛф╕ня╝Мф╗ОшКВчВ╣ф╣Яф╝ЪхРпхКи AOF щЗНхЖЩя╝Мх╜вцИРф╕Аф╗╜хоМцХ┤чЪД AOF цЧех┐Чя╝Мф╗еф╛┐хРОч╗нш┐ЫшбМцБвхдНуАВх╜УчД╢ф╜аф╣ЯшжБчЯещБУя╝Мх╜УшжБшзжхПС AOF щЗНхЖЩцЧ╢я╝МRedis server цШпф╕НшГ╜ш┐РшбМ RDB хнРш┐ЫчиЛхТМ AOF щЗНхЖЩхнРш┐ЫчиЛчЪДуАВ</p></li> <li><p><strong>AOF щЗНхЖЩчЪДхЯ║цЬмцЙзшбМш┐ЗчиЛ</strong>уАВAOF щЗНхЖЩхТМ RDB хИЫх╗║чЪДш┐ЗчиЛч▒╗ф╝╝я╝МхоГф╣ЯцШпхИЫх╗║ф║Жф╕Аф╕кхнРш┐ЫчиЛцЭехоМцИРщЗНхЖЩх╖еф╜ЬуАВш┐ЩцШпхЫаф╕║ AOF щЗНхЖЩцУНф╜Ья╝МхоЮщЩЕф╕КщЬАшжБщБНхОЖ Redis server ф╕КчЪДцЙАцЬЙцХ░цНох║Уя╝МцККцпПф╕кщФохА╝хп╣ф╗ецПТхЕецУНф╜ЬчЪДх╜вх╝ПхЖЩхЕецЧех┐ЧцЦЗф╗╢я╝МшАМцЧех┐ЧцЦЗф╗╢хПИшжБш┐ЫшбМхЖЩчЫШцУНф╜ЬуАВцЙАф╗ея╝МRedis ц║РчаБф╜┐чФихнРш┐ЫчиЛцЭехоЮчО░ AOF щЗНхЖЩя╝Мш┐Щх░▒щБ┐хЕНф║ЖщШ╗хбЮф╕╗ч║┐чиЛя╝Мф╣ЯхЗПх░Сф║Жхп╣ Redis цХ┤ф╜УцАзшГ╜чЪДх╜▒хУНуАВ</p></li> <li><p>ц│ичобщБУцЬ║хИ╢чЪДф╜┐чФи</p></li> <li><p>ф╕╗ш┐ЫчиЛхТМщЗНхЖЩхнРш┐ЫчиЛф╜┐чФичобщБУщАЪф┐бчЪДш┐ЗчиЛ</p></li></ol> <p>хЬиш┐Щф╕кш┐ЗчиЛф╕ня╝МAOF щЗНхЖЩхнРш┐ЫчиЛхТМф╕╗ш┐ЫчиЛцШпф╜┐чФиф║Жф╕Аф╕кцУНф╜ЬхС╜ф╗дф╝аш╛УчобщБУхТМф╕дф╕к ACK ф┐бцБпхПСщАБчобщБУуАВ<strong>цУНф╜ЬхС╜ф╗дф╝аш╛УчобщБУ</strong>цШпчФиф║Оф╕╗ш┐ЫчиЛхЖЩхЕецФ╢хИ░чЪДцЦ░цУНф╜ЬхС╜ф╗дя╝Мф╗ехПКчФиф║ОщЗНхЖЩхнРш┐ЫчиЛшп╗хПЦцУНф╜ЬхС╜ф╗дя╝МшАМ <strong>ACK ф┐бцБпхПСщАБчобщБУ</strong>цШпхЬищЗНхЖЩч╗УцЭЯцЧ╢я╝МщЗНхЖЩхнРш┐ЫчиЛхТМф╕╗ш┐ЫчиЛчФицЭечЫ╕ф║ТчбошодщЗНхЖЩш┐ЗчиЛчЪДч╗УцЭЯуАВцЬАхРОя╝МщЗНхЖЩхнРш┐ЫчиЛф╝Ъш┐Ыф╕Ацнех░ЖцФ╢хИ░чЪДцУНф╜ЬхС╜ф╗дшо░х╜ХхИ░щЗНхЖЩцЧех┐ЧцЦЗф╗╢ф╕нуАВ</p> <p>ш┐Щца╖ф╕АцЭея╝МAOF щЗНхЖЩш┐ЗчиЛф╕нф╕╗ш┐ЫчиЛцФ╢хИ░чЪДцЦ░хЖЩцУНф╜Ья╝Мх░▒ф╕Нф╝ЪшвлщБЧц╝Пф║Ж</p> <ul><li>ф╕АцЦ╣щЭвя╝Мш┐Щф║ЫцЦ░хЖЩцУНф╜Ьф╝Ъшвлшо░х╜ХхЬицнгх╕╕чЪД AOF цЧех┐Чф╕н</li> <li>ф╕АцЦ╣щЭвя╝Мф╕╗ш┐ЫчиЛф╝Ъх░ЖцЦ░хЖЩцУНф╜Ьч╝УхнШхЬи aof_rewrite_buf_blocks цХ░цНохЭЧхИЧшбиф╕ня╝Мх╣╢щАЪш┐ЗчобщБУхПСщАБч╗ЩщЗНхЖЩхнРш┐ЫчиЛуАВш┐Щца╖я╝Мх░▒шГ╜х░╜хПпшГ╜хЬ░ф┐ЭшпБщЗНхЖЩцЧех┐ЧхЕ╖цЬЙцЬАцЦ░уАБцЬАхоМцХ┤чЪДхЖЩцУНф╜Ьф║Ж</li></ul></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/echo-lxy/echo-system-design/edit/master/docs/Redis ч│╗ч╗Яшо╛шоб/04.цФпч║┐/17.AOF цМБф╣ЕхМЦ.md" target="_blank" rel="noopener noreferrer">ч╝Цш╛С</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">ф╕КцмбцЫ┤цЦ░ф║О:</span> <span class="time">2024/09/17, 10:37:22</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        тЖР
        <a href="/pages/9b17a6/" class="prev">RDB цМБф╣ЕхМЦ</a></span> <span class="next"><a href="/pages/aa75e9/">Redis ф╕нчЪДх╗╢ш┐ЯчЫСцОз</a>тЖТ
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:lixinyang2002@163.com" title="хПСщВоф╗╢" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/echo-lxy" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="хРмщЯ│ф╣Р" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="цЬмчлЩф╕╗щвШ">Vdoing</a> 
    | Copyright ┬й 2024-2024
    <span>Xinyang Li | MIT License</span></div> <div class="buttons"><div title="ш┐ФхЫЮщб╢щГи" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="хО╗шпДшо║" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ф╕╗щвШцибх╝П" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          ш╖ЯщЪПч│╗ч╗Я
        </li><li class="iconfont icon-rijianmoshi">
          ц╡ЕшЙ▓цибх╝П
        </li><li class="iconfont icon-yejianmoshi">
          ц╖▒шЙ▓цибх╝П
        </li><li class="iconfont icon-yuedu">
          щШЕшп╗цибх╝П
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.f2d21572.js" defer></script><script src="/assets/js/2.933750c6.js" defer></script><script src="/assets/js/55.0b3f6288.js" defer></script><script src="/assets/js/7.7eb70372.js" defer></script>
  </body>
</html>
