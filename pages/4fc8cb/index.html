<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>幂等&amp;防重 | Echo 系统设计之美</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="将系统设计技能提升到一个新水平所需的一切">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.ec223d34.css" as="style"><link rel="preload" href="/assets/js/app.3d2aa628.js" as="script"><link rel="preload" href="/assets/js/2.81691b95.js" as="script"><link rel="preload" href="/assets/js/22.7f6b341e.js" as="script"><link rel="prefetch" href="/assets/js/10.10f57c8c.js"><link rel="prefetch" href="/assets/js/11.0011448e.js"><link rel="prefetch" href="/assets/js/12.952650dc.js"><link rel="prefetch" href="/assets/js/13.3e99a433.js"><link rel="prefetch" href="/assets/js/14.aaaaced5.js"><link rel="prefetch" href="/assets/js/15.761f4c16.js"><link rel="prefetch" href="/assets/js/16.cc3581e2.js"><link rel="prefetch" href="/assets/js/17.a103e4a2.js"><link rel="prefetch" href="/assets/js/18.2f83e0d3.js"><link rel="prefetch" href="/assets/js/19.db1b977d.js"><link rel="prefetch" href="/assets/js/20.081600b4.js"><link rel="prefetch" href="/assets/js/21.4b6ff9ba.js"><link rel="prefetch" href="/assets/js/23.60ac2de5.js"><link rel="prefetch" href="/assets/js/24.f905ac0e.js"><link rel="prefetch" href="/assets/js/25.0a985889.js"><link rel="prefetch" href="/assets/js/26.3370bf71.js"><link rel="prefetch" href="/assets/js/27.2b3c56ad.js"><link rel="prefetch" href="/assets/js/28.880645d2.js"><link rel="prefetch" href="/assets/js/29.e6132d8a.js"><link rel="prefetch" href="/assets/js/3.5c823049.js"><link rel="prefetch" href="/assets/js/30.40950d3d.js"><link rel="prefetch" href="/assets/js/31.b06252b8.js"><link rel="prefetch" href="/assets/js/32.66bfa164.js"><link rel="prefetch" href="/assets/js/33.c360fa8c.js"><link rel="prefetch" href="/assets/js/34.a632c0e9.js"><link rel="prefetch" href="/assets/js/4.d012670c.js"><link rel="prefetch" href="/assets/js/5.ae7e13e5.js"><link rel="prefetch" href="/assets/js/6.f85123d8.js"><link rel="prefetch" href="/assets/js/7.efb9ad0b.js"><link rel="prefetch" href="/assets/js/8.8872a494.js"><link rel="prefetch" href="/assets/js/9.a9437c17.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ec223d34.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="Echo 系统设计之美" class="logo"> <span class="site-name can-hide">Echo 系统设计之美</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">系统设计算法</a></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">设计基础设施</a></div><div class="nav-item"><a href="/pages/264b06/" class="nav-link">系统设计鉴赏</a></div><div class="nav-item"><a href="/pages/a95d7d/" class="nav-link">设计热门应用</a></div><div class="nav-item"><a href="/pages/def08a/" class="nav-link">经典场景设计</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">问答归档</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">我的动态</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">系统设计算法</a></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">设计基础设施</a></div><div class="nav-item"><a href="/pages/264b06/" class="nav-link">系统设计鉴赏</a></div><div class="nav-item"><a href="/pages/a95d7d/" class="nav-link">设计热门应用</a></div><div class="nav-item"><a href="/pages/def08a/" class="nav-link">经典场景设计</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">问答归档</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">我的动态</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>热门场景设计</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/def08a/" class="sidebar-link">双写一致性</a></li><li><a href="/pages/1e9e8e/" class="sidebar-link">缓存穿透</a></li><li><a href="/pages/1d96b2/" class="sidebar-link">缓存击穿</a></li><li><a href="/pages/24abe0/" class="sidebar-link">任务补偿</a></li><li><a href="/pages/a72629/" class="sidebar-link">秒杀</a></li><li><a href="/pages/8a57f2/" class="sidebar-link">超卖</a></li><li><a href="/pages/51aa8b/" class="sidebar-link">多级缓存</a></li><li><a href="/pages/0dfb49/" class="sidebar-link">超时&amp;重试</a></li><li><a href="/pages/4fc8cb/" aria-current="page" class="active sidebar-link">幂等&amp;防重</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/4fc8cb/#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header level2"><a href="/pages/4fc8cb/#_1-insert-前先-select" class="sidebar-link">1. insert 前先 select</a></li><li class="sidebar-sub-header level2"><a href="/pages/4fc8cb/#_2-加悲观锁" class="sidebar-link">2. 加悲观锁</a></li><li class="sidebar-sub-header level2"><a href="/pages/4fc8cb/#_3-加乐观锁" class="sidebar-link">3. 加乐观锁</a></li><li class="sidebar-sub-header level2"><a href="/pages/4fc8cb/#_4-加唯一索引" class="sidebar-link">4. 加唯一索引</a></li><li class="sidebar-sub-header level2"><a href="/pages/4fc8cb/#_5-建防重表" class="sidebar-link">5. 建防重表</a></li><li class="sidebar-sub-header level2"><a href="/pages/4fc8cb/#_6-根据状态机" class="sidebar-link">6. 根据状态机</a></li><li class="sidebar-sub-header level2"><a href="/pages/4fc8cb/#_7-加分布式锁" class="sidebar-link">7. 加分布式锁</a></li><li class="sidebar-sub-header level2"><a href="/pages/4fc8cb/#_8-获取token" class="sidebar-link">8. 获取token</a></li><li class="sidebar-sub-header level2"><a href="/pages/4fc8cb/#总结" class="sidebar-link">总结</a></li><li class="sidebar-sub-header level2"><a href="/pages/4fc8cb/#参考文献" class="sidebar-link">参考文献</a></li></ul></li><li><a href="/pages/f3295f/" class="sidebar-link">海量数据计数</a></li><li><a href="/pages/6b9d68/" class="sidebar-link">消息未读数系统</a></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>经典场景设计</span></li><li data-v-06225672><span data-v-06225672>热门场景设计</span></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/brother-one" target="_blank" title="作者" class="beLink" data-v-06225672>echo</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-09-14</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">幂等&amp;防重<!----></h1> <div class="page-slot page-slot-top">
    <div class="wwads-cn wwads-horizontal page-wwads" data-id="136"></div>
    <style>
      .page-wwads{
        width:100%!important;
        min-height: 0;
        margin: 0;
      }
      .page-wwads .wwads-img img{
        width:80px!important;
      }
      .page-wwads .wwads-poweredby{
        width: 40px;
        position: absolute;
        right: 25px;
        bottom: 3px;
      }
      .wwads-content .wwads-text, .page-wwads .wwads-text{
        height: 100%;
        padding-top: 5px;
        display: block;
      }
  </style>
  </div> <div class="theme-vdoing-content content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p><code>接口幂等性</code>问题，对于开发人员来说，是一个跟语言无关的公共问题。本文分享了一些解决这类问题非常实用的办法，绝大部分内容我在项目中实践过的，给有需要的小伙伴一个参考。</p> <p>不知道你有没有遇到过这些场景：</p> <ol><li>有时我们在填写某些<code>form表单</code>时，保存按钮不小心快速点了两次，表中竟然产生了两条重复的数据，只是id不一样。</li> <li>我们在项目中为了解决<code>接口超时</code>问题，通常会引入了<code>重试机制</code>。第一次请求接口超时了，请求方没能及时获取返回结果（此时有可能已经成功了），为了避免返回错误的结果（这种情况不可能直接返回失败吧？），于是会对该请求重试几次，这样也会产生重复的数据。</li> <li>mq消费者在读取消息时，有时候会读取到<code>重复消息</code>（至于什么原因这里先不说，有兴趣的小伙伴，可以找我私聊），如果处理不好，也会产生重复的数据。</li></ol> <p>没错，这些都是幂等性问题。</p> <p><code>接口幂等性</code>是指用户对于同一操作发起的一次请求或者多次请求的结果是一致的，不会因为多次点击而产生了副作用。</p> <p>这类问题多发于接口的：</p> <ul><li><code>insert</code>操作，这种情况下多次请求，可能会产生重复数据。</li> <li><code>update</code>操作，如果只是单纯的更新数据，比如：<code>update user set status=1 where id=1</code>，是没有问题的。如果还有计算，比如：<code>update user set status=status+1 where id=1</code>，这种情况下多次请求，可能会导致数据错误。</li></ul> <p>那么我们要如何保证接口幂等性？本文将会告诉你答案。</p> <h2 id="_1-insert-前先-select"><a href="#_1-insert-前先-select" class="header-anchor">#</a> 1. insert 前先 select</h2> <p>通常情况下，在保存数据的接口中，我们为了防止产生重复数据，一般会在<code>insert</code>前，先根据<code>name</code>或<code>code</code>字段<code>select</code>一下数据。如果该数据已存在，则执行<code>update</code>操作，如果不存在，才执行  <code>insert</code>操作。</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409150104118.png" alt="img"></p> <p>该方案可能是我们平时在防止产生重复数据时，使用最多的方案。但是该方案不适用于并发场景，在并发场景中，要配合其他方案一起使用，否则同样会产生重复数据。我在这里提一下，是为了避免大家踩坑。</p> <h2 id="_2-加悲观锁"><a href="#_2-加悲观锁" class="header-anchor">#</a> 2. 加悲观锁</h2> <p>在支付场景中，用户A的账号余额有150元，想转出100元，正常情况下用户A的余额只剩50元。一般情况下，sql是这样的：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">update</span> <span class="token keyword">user</span> amount <span class="token operator">=</span> amount<span class="token operator">-</span><span class="token number">100</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">123</span><span class="token punctuation">;</span>
</code></pre></div><p>如果出现多次相同的请求，可能会导致用户A的余额变成负数。这种情况，用户A来可能要哭了。于此同时，系统开发人员可能也要哭了，因为这是很严重的系统bug。</p> <p>为了解决这个问题，可以加悲观锁，将用户A的那行数据锁住，在同一时刻只允许一个请求获得锁，更新数据，其他的请求则等待。</p> <p>通常情况下通过如下sql锁住单行数据：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> id<span class="token operator">=</span><span class="token number">123</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span>
</code></pre></div><p>具体流程如下：</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409150104151.png" alt="img"></p> <p>具体步骤：</p> <ol><li>多个请求同时根据id查询用户信息。</li> <li>判断余额是否不足100，如果余额不足，则直接返回余额不足。</li> <li>如果余额充足，则通过for update再次查询用户信息，并且尝试获取锁。</li> <li>只有第一个请求能获取到行锁，其余没有获取锁的请求，则等待下一次获取锁的机会。</li> <li>第一个请求获取到锁之后，判断余额是否不足100，如果余额足够，则进行update操作。</li> <li>如果余额不足，说明是重复请求，则直接返回成功。</li></ol> <blockquote><p>需要特别注意的是：如果使用的是mysql数据库，存储引擎必须用innodb，因为它才支持事务。此外，这里id字段一定要是主键或者唯一索引，不然会锁住整张表。</p></blockquote> <p>悲观锁需要在同一个事务操作过程中锁住一行数据，如果事务耗时比较长，会造成大量的请求等待，影响接口性能。此外，每次请求接口很难保证都有相同的返回值，所以不适合幂等性设计场景，但是在防重场景中是可以的使用的。在这里顺便说一下，<code>防重设计</code> 和 <code>幂等设计</code>，其实是有区别的。防重设计主要为了避免产生重复数据，对接口返回没有太多要求。而幂等设计除了避免产生重复数据之外，还要求每次请求都返回一样的结果。</p> <h2 id="_3-加乐观锁"><a href="#_3-加乐观锁" class="header-anchor">#</a> 3. 加乐观锁</h2> <p>既然悲观锁有性能问题，为了提升接口性能，我们可以使用乐观锁。需要在表中增加一个<code>timestamp</code>或者<code>version</code>字段，这里以<code>version</code>字段为例。</p> <p>在更新数据之前先查询一下数据：</p> <div class="language-python extra-class"><pre class="language-python"><code>select <span class="token builtin">id</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span>version <span class="token keyword">from</span> user <span class="token builtin">id</span><span class="token operator">=</span><span class="token number">123</span><span class="token punctuation">;</span>
</code></pre></div><p>如果数据存在，假设查到的<code>version</code>等于<code>1</code>，再使用<code>id</code>和<code>version</code>字段作为查询条件更新数据：</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">update</span> user set amount=amount+100,version=version+1
where id=123 and version=1</span><span class="token punctuation">;</span>
</code></pre></div><p>更新数据的同时<code>version+1</code>，然后判断本次<code>update</code>操作的影响行数，如果大于0，则说明本次更新成功，如果等于0，则说明本次更新没有让数据变更。</p> <p>由于第一次请求<code>version</code>等于<code>1</code>是可以成功的，操作成功后<code>version</code>变成<code>2</code>了。这时如果并发的请求过来，再执行相同的sql：</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">update</span> user set amount=amount+100,version=version+1
where id=123 and version=1</span><span class="token punctuation">;</span>
</code></pre></div><p>该<code>update</code>操作不会真正更新数据，最终sql的执行结果影响行数是<code>0</code>，因为<code>version</code>已经变成<code>2</code>了，<code>where</code>中的<code>version=1</code>肯定无法满足条件。但为了保证接口幂等性，接口可以直接返回成功，因为<code>version</code>值已经修改了，那么前面必定已经成功过一次，后面都是重复的请求。</p> <p>具体流程如下：<img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="图片"></p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409150104171.png" alt="img"></p> <p>具体步骤：</p> <ol><li>先根据id查询用户信息，包含version字段</li> <li>根据id和version字段值作为where条件的参数，更新用户信息，同时version+1</li> <li>判断操作影响行数，如果影响1行，则说明是一次请求，可以做其他数据操作。</li> <li>如果影响0行，说明是重复请求，则直接返回成功。</li></ol> <h2 id="_4-加唯一索引"><a href="#_4-加唯一索引" class="header-anchor">#</a> 4. 加唯一索引</h2> <p>绝大数情况下，为了防止重复数据的产生，我们都会在表中加唯一索引，这是一个非常简单，并且有效的方案。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">alter</span> <span class="token keyword">table</span> <span class="token identifier"><span class="token punctuation">`</span>order<span class="token punctuation">`</span></span> <span class="token keyword">add</span> <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>un_code<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>code<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>加了唯一索引之后，第一次请求数据可以插入成功。但后面的相同请求，插入数据时会报<code>Duplicate entry '002' for key 'order.un_code</code>异常，表示唯一索引有冲突。</p> <p>虽说抛异常对数据来说没有影响，不会造成错误数据。但是为了保证接口幂等性，我们需要对该异常进行捕获，然后返回成功。</p> <p>如果是<code>java</code>程序需要捕获：<code>DuplicateKeyException</code>异常，如果使用了<code>spring</code>框架还需要捕获：<code>MySQLIntegrityConstraintViolationException</code>异常。</p> <p>具体流程图如下：</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409150104138.png" alt="img"></p> <p>具体步骤：</p> <ol><li>用户通过浏览器发起请求，服务端收集数据。</li> <li>将该数据插入mysql</li> <li>判断是否执行成功，如果成功，则操作其他数据（可能还有其他的业务逻辑）。</li> <li>如果执行失败，捕获唯一索引冲突异常，直接返回成功。</li></ol> <h2 id="_5-建防重表"><a href="#_5-建防重表" class="header-anchor">#</a> 5. 建防重表</h2> <p>有时候表中并非所有的场景都不允许产生重复的数据，只有某些特定场景才不允许。这时候，直接在表中加唯一索引，显然是不太合适的。</p> <p>针对这种情况，我们可以通过<code>建防重表</code>来解决问题。</p> <p>该表可以只包含两个字段：<code>id</code> 和 <code>唯一索引</code>，唯一索引可以是多个字段比如：name、code等组合起来的唯一标识，例如：susan_0001。</p> <p>具体流程图如下：</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409150104181.png" alt="img"></p> <p>具体步骤：</p> <ol><li>用户通过浏览器发起请求，服务端收集数据。</li> <li>将该数据插入mysql防重表</li> <li>判断是否执行成功，如果成功，则做mysql其他的数据操作（可能还有其他的业务逻辑）。</li> <li>如果执行失败，捕获唯一索引冲突异常，直接返回成功。</li></ol> <blockquote><p>需要特别注意的是：防重表和业务表必须在同一个数据库中，并且操作要在同一个事务中。</p></blockquote> <h2 id="_6-根据状态机"><a href="#_6-根据状态机" class="header-anchor">#</a> 6. 根据状态机</h2> <p>很多时候业务表是有状态的，比如订单表中有：1-下单、2-已支付、3-完成、4-撤销等状态。如果这些状态的值是有规律的，按照业务节点正好是从小到大，我们就能通过它来保证接口的幂等性。</p> <p>假如id=123的订单状态是<code>已支付</code>，现在要变成<code>完成</code>状态。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">update</span> <span class="token identifier"><span class="token punctuation">`</span>order<span class="token punctuation">`</span></span> <span class="token keyword">set</span> <span class="token keyword">status</span><span class="token operator">=</span><span class="token number">3</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">123</span> <span class="token operator">and</span> <span class="token keyword">status</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
</code></pre></div><p>第一次请求时，该订单的状态是<code>已支付</code>，值是<code>2</code>，所以该<code>update</code>语句可以正常更新数据，sql执行结果的影响行数是<code>1</code>，订单状态变成了<code>3</code>。</p> <p>后面有相同的请求过来，再执行相同的sql时，由于订单状态变成了<code>3</code>，再用<code>status=2</code>作为条件，无法查询出需要更新的数据，所以最终sql执行结果的影响行数是<code>0</code>，即不会真正的更新数据。但为了保证接口幂等性，影响行数是<code>0</code>时，接口也可以直接返回成功。</p> <p>具体流程图如下：</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409150104128.png" alt="img"></p> <p>具体步骤：</p> <ol><li>用户通过浏览器发起请求，服务端收集数据。</li> <li>根据id和当前状态作为条件，更新成下一个状态</li> <li>判断操作影响行数，如果影响了1行，说明当前操作成功，可以进行其他数据操作。</li> <li>如果影响了0行，说明是重复请求，直接返回成功。</li></ol> <blockquote><p>主要特别注意的是，该方案仅限于要更新的<code>表有状态字段</code>，并且刚好要更新<code>状态字段</code>的这种特殊情况，并非所有场景都适用。</p></blockquote> <h2 id="_7-加分布式锁"><a href="#_7-加分布式锁" class="header-anchor">#</a> 7. 加分布式锁</h2> <p>其实前面介绍过的<code>加唯一索引</code>或者<code>加防重表</code>，本质是使用了<code>数据库</code>的<code>分布式锁</code>，也属于分布式锁的一种。但由于<code>数据库分布式锁</code>的性能不太好，我们可以改用：<code>redis</code>或<code>zookeeper</code>。</p> <p>鉴于现在很多公司分布式配置中心改用<code>apollo</code>或<code>nacos</code>，已经很少用<code>zookeeper</code>了，我们以<code>redis</code>为例介绍分布式锁。</p> <p>目前主要有三种方式实现redis的分布式锁：</p> <ol><li>setNx命令</li> <li>set命令</li> <li>Redission框架</li></ol> <p>每种方案各有利弊，具体实现细节我就不说了，有兴趣的朋友可以加我微信找我私聊。</p> <p>具体流程图如下：</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409150104951.png" alt="img"></p> <p>具体步骤：</p> <ol><li>用户通过浏览器发起请求，服务端会收集数据，并且生成订单号code作为唯一业务字段。</li> <li>使用redis的set命令，将该订单code设置到redis中，同时设置超时时间。</li> <li>判断是否设置成功，如果设置成功，说明是第一次请求，则进行数据操作。</li> <li>如果设置失败，说明是重复请求，则直接返回成功。</li></ol> <blockquote><p>需要特别注意的是：分布式锁一定要设置一个合理的过期时间，如果设置过短，无法有效的防止重复请求。如果设置过长，可能会浪费<code>redis</code>的存储空间，需要根据实际业务情况而定。</p></blockquote> <h2 id="_8-获取token"><a href="#_8-获取token" class="header-anchor">#</a> 8. 获取token</h2> <p>除了上述方案之外，还有最后一种使用<code>token</code>的方案。该方案跟之前的所有方案都有点不一样，需要两次请求才能完成一次业务操作。</p> <ol><li>第一次请求获取<code>token</code></li> <li>第二次请求带着这个<code>token</code>，完成业务操作。</li></ol> <p>具体流程图如下：</p> <p>第一步，先获取token。</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409150104050.png" alt="img"></p> <p>第二步，做具体业务操作。</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409150104176.png" alt="img"></p> <p>具体步骤：</p> <ol><li>用户访问页面时，浏览器自动发起获取token请求。</li> <li>服务端生成token，保存到redis中，然后返回给浏览器。</li> <li>用户通过浏览器发起请求时，携带该token。</li> <li>在redis中查询该token是否存在，如果不存在，说明是第一次请求，做则后续的数据操作。</li> <li>如果存在，说明是重复请求，则直接返回成功。</li> <li>在redis中token会在过期时间之后，被自动删除。</li></ol> <p>以上方案是针对幂等设计的。</p> <p>如果是防重设计，流程图要改改：</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409150104400.png" alt="img"></p> <blockquote><p>需要特别注意的是：token必须是全局唯一的</p></blockquote> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <ol><li>insert 前先 select</li> <li>加悲观锁</li> <li>加乐观锁</li> <li>加唯一索引</li> <li>建防重表</li> <li>根据状态机</li> <li>加分布式锁</li> <li>获取token</li></ol> <h2 id="参考文献"><a href="#参考文献" class="header-anchor">#</a> 参考文献</h2> <p><a href="https://www.cnblogs.com/12lisu/p/14639651.html" target="_blank" rel="noopener noreferrer">高并发下如何保证接口的幂等性？ - 苏三说技术 - 博客园 (cnblogs.com)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/echo-lxy/echo-system-design/edit/master/docs/03.经典场景设计/01.热门场景设计/09.幂等&amp;防重.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2024/09/14, 17:38:31</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/0dfb49/" class="prev">超时&amp;重试</a></span> <span class="next"><a href="/pages/f3295f/">海量数据计数</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:lixinyang2002@163.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/echo-lxy" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2024-2024
    <span>Xinyang Li | MIT License</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3d2aa628.js" defer></script><script src="/assets/js/2.81691b95.js" defer></script><script src="/assets/js/22.7f6b341e.js" defer></script>
  </body>
</html>
