<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>高可用探究 | EchoDesign</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="系统设计之「讲解 + 面试指南」，水滴石穿，设计无银弹！">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.f82a82e9.css" as="style"><link rel="preload" href="/assets/js/app.78f2b9cc.js" as="script"><link rel="preload" href="/assets/js/2.933750c6.js" as="script"><link rel="preload" href="/assets/js/31.21bd2de1.js" as="script"><link rel="preload" href="/assets/js/7.7eb70372.js" as="script"><link rel="prefetch" href="/assets/js/10.b313d17c.js"><link rel="prefetch" href="/assets/js/100.a9558091.js"><link rel="prefetch" href="/assets/js/101.007aa479.js"><link rel="prefetch" href="/assets/js/102.57bca734.js"><link rel="prefetch" href="/assets/js/11.c7521a10.js"><link rel="prefetch" href="/assets/js/12.f57a12da.js"><link rel="prefetch" href="/assets/js/13.d9d26d25.js"><link rel="prefetch" href="/assets/js/14.09cf8a64.js"><link rel="prefetch" href="/assets/js/15.d5a34c66.js"><link rel="prefetch" href="/assets/js/16.8cea924c.js"><link rel="prefetch" href="/assets/js/17.8d94c5e8.js"><link rel="prefetch" href="/assets/js/18.baad837c.js"><link rel="prefetch" href="/assets/js/19.571eaed1.js"><link rel="prefetch" href="/assets/js/20.d70e5281.js"><link rel="prefetch" href="/assets/js/21.0e0ed140.js"><link rel="prefetch" href="/assets/js/22.1ccaa6f3.js"><link rel="prefetch" href="/assets/js/23.623f0b5d.js"><link rel="prefetch" href="/assets/js/24.891fe6fb.js"><link rel="prefetch" href="/assets/js/25.41dca26b.js"><link rel="prefetch" href="/assets/js/26.6337eac0.js"><link rel="prefetch" href="/assets/js/27.de80589e.js"><link rel="prefetch" href="/assets/js/28.95a1fb6b.js"><link rel="prefetch" href="/assets/js/29.371a40e1.js"><link rel="prefetch" href="/assets/js/3.e62a71e4.js"><link rel="prefetch" href="/assets/js/30.e32f6b31.js"><link rel="prefetch" href="/assets/js/32.f1174703.js"><link rel="prefetch" href="/assets/js/33.eab858f3.js"><link rel="prefetch" href="/assets/js/34.4ba0e53e.js"><link rel="prefetch" href="/assets/js/35.8287c9dc.js"><link rel="prefetch" href="/assets/js/36.b5f133ca.js"><link rel="prefetch" href="/assets/js/37.82be3556.js"><link rel="prefetch" href="/assets/js/38.40fe2658.js"><link rel="prefetch" href="/assets/js/39.6450065f.js"><link rel="prefetch" href="/assets/js/4.73518a0f.js"><link rel="prefetch" href="/assets/js/40.591baf2a.js"><link rel="prefetch" href="/assets/js/41.f961e422.js"><link rel="prefetch" href="/assets/js/42.b34f1599.js"><link rel="prefetch" href="/assets/js/43.5a509601.js"><link rel="prefetch" href="/assets/js/44.64fd3383.js"><link rel="prefetch" href="/assets/js/45.685623ac.js"><link rel="prefetch" href="/assets/js/46.b7523f9c.js"><link rel="prefetch" href="/assets/js/47.9bed4c1b.js"><link rel="prefetch" href="/assets/js/48.a1b270df.js"><link rel="prefetch" href="/assets/js/49.ee9681bc.js"><link rel="prefetch" href="/assets/js/5.b472a9bb.js"><link rel="prefetch" href="/assets/js/50.b424b2c0.js"><link rel="prefetch" href="/assets/js/51.53684c6e.js"><link rel="prefetch" href="/assets/js/52.a45a9bb1.js"><link rel="prefetch" href="/assets/js/53.6f165300.js"><link rel="prefetch" href="/assets/js/54.61a6a81b.js"><link rel="prefetch" href="/assets/js/55.5391018d.js"><link rel="prefetch" href="/assets/js/56.e0b862ae.js"><link rel="prefetch" href="/assets/js/57.374534af.js"><link rel="prefetch" href="/assets/js/58.bb9706ba.js"><link rel="prefetch" href="/assets/js/59.6d5a538f.js"><link rel="prefetch" href="/assets/js/6.0b558b79.js"><link rel="prefetch" href="/assets/js/60.99b51260.js"><link rel="prefetch" href="/assets/js/61.33893dab.js"><link rel="prefetch" href="/assets/js/62.e6604fa3.js"><link rel="prefetch" href="/assets/js/63.e753bb13.js"><link rel="prefetch" href="/assets/js/64.59e76eda.js"><link rel="prefetch" href="/assets/js/65.66728f4b.js"><link rel="prefetch" href="/assets/js/66.30cbe3ea.js"><link rel="prefetch" href="/assets/js/67.9aea7c9b.js"><link rel="prefetch" href="/assets/js/68.79ee7ba7.js"><link rel="prefetch" href="/assets/js/69.a776cc2e.js"><link rel="prefetch" href="/assets/js/70.13d90b76.js"><link rel="prefetch" href="/assets/js/71.4f4c7733.js"><link rel="prefetch" href="/assets/js/72.b0948cb0.js"><link rel="prefetch" href="/assets/js/73.d7ed15dc.js"><link rel="prefetch" href="/assets/js/74.6884119c.js"><link rel="prefetch" href="/assets/js/75.b70b8a0c.js"><link rel="prefetch" href="/assets/js/76.2766fd7c.js"><link rel="prefetch" href="/assets/js/77.c9b76e03.js"><link rel="prefetch" href="/assets/js/78.9aa9da2e.js"><link rel="prefetch" href="/assets/js/79.ea5b4888.js"><link rel="prefetch" href="/assets/js/8.77b795dd.js"><link rel="prefetch" href="/assets/js/80.3c3f7534.js"><link rel="prefetch" href="/assets/js/81.76b7b1ed.js"><link rel="prefetch" href="/assets/js/82.7b7a2f1c.js"><link rel="prefetch" href="/assets/js/83.44c820ac.js"><link rel="prefetch" href="/assets/js/84.f53c8839.js"><link rel="prefetch" href="/assets/js/85.8c526118.js"><link rel="prefetch" href="/assets/js/86.e17eab25.js"><link rel="prefetch" href="/assets/js/87.a09f72d3.js"><link rel="prefetch" href="/assets/js/88.0f27b036.js"><link rel="prefetch" href="/assets/js/89.2fd11d59.js"><link rel="prefetch" href="/assets/js/9.36f81190.js"><link rel="prefetch" href="/assets/js/90.e60814ad.js"><link rel="prefetch" href="/assets/js/91.08cfa575.js"><link rel="prefetch" href="/assets/js/92.81c822a0.js"><link rel="prefetch" href="/assets/js/93.5f199263.js"><link rel="prefetch" href="/assets/js/94.266b7d71.js"><link rel="prefetch" href="/assets/js/95.0899dfb4.js"><link rel="prefetch" href="/assets/js/96.c1156914.js"><link rel="prefetch" href="/assets/js/97.18525931.js"><link rel="prefetch" href="/assets/js/98.ee554b1a.js"><link rel="prefetch" href="/assets/js/99.f0fb67c2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f82a82e9.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="EchoDesign" class="logo"> <span class="site-name can-hide">EchoDesign</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">🏠首页</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">✒️热门算法</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🎖️赏析经典设计" class="dropdown-title"><!----> <span class="title" style="display:;">🎖️赏析经典设计</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">JUC 系统设计</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty 系统设计</a></li><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis 系统设计</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka 系统设计</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx 系统设计</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">🧑‍💻实战系统设计</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">❓问答</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">👀动态</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">🏠首页</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">✒️热门算法</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🎖️赏析经典设计" class="dropdown-title"><!----> <span class="title" style="display:;">🎖️赏析经典设计</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">JUC 系统设计</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty 系统设计</a></li><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis 系统设计</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka 系统设计</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx 系统设计</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">🧑‍💻实战系统设计</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">❓问答</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">👀动态</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>一、前言</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>三、主线任务</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>四、设计目标</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/2dec11/" aria-current="page" class="active sidebar-link">高可用探究</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/2dec11/#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header level2"><a href="/pages/2dec11/#集群架构" class="sidebar-link">集群架构</a></li><li class="sidebar-sub-header level2"><a href="/pages/2dec11/#kafka集群选举" class="sidebar-link">Kafka集群选举</a></li><li class="sidebar-sub-header level2"><a href="/pages/2dec11/#副本机制-replication" class="sidebar-link">副本机制(Replication）</a></li><li class="sidebar-sub-header level2"><a href="/pages/2dec11/#消费者组和再均衡" class="sidebar-link">消费者组和再均衡</a></li><li class="sidebar-sub-header level2"><a href="/pages/2dec11/#参考资料" class="sidebar-link">参考资料</a></li></ul></li><li><a href="/pages/168766/" class="sidebar-link">高扩展探究</a></li><li><a href="/pages/dd50fc/" class="sidebar-link">高并发探究</a></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>Kafka  系统设计</span></li><li data-v-06225672><span data-v-06225672>四、设计目标</span></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/brother-one" target="_blank" title="作者" class="beLink" data-v-06225672>echo</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-09-18</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><!---->高可用探究<!----></h1> <div class="page-slot page-slot-top">
    <div class="wwads-cn wwads-horizontal page-wwads" data-id="136"></div>
    <style>
      .page-wwads{
        width:100%!important;
        min-height: 0;
        margin: 0;
      }
      .page-wwads .wwads-img img{
        width:80px!important;
      }
      .page-wwads .wwads-poweredby{
        width: 40px;
        position: absolute;
        right: 25px;
        bottom: 3px;
      }
      .wwads-content .wwads-text, .page-wwads .wwads-text{
        height: 100%;
        padding-top: 5px;
        display: block;
      }
  </style>
  </div> <div class="theme-vdoing-content content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>Apache Kafka 的高可用设计主要通过以下几个方面来实现：</p> <ul><li>副本机制（Replication）：在 Kafka 中，每个 partition 都有多个副本，其中一个作为 leader，其他的作为follower。所有的读写操作都是通过 leader 来进行的，follower 则负责从 leader 同步数据。当 leader出现故障时，会从 follower 中选举出新的 leader，以保证服务的可用性。</li> <li>分区机制（Partitioning）：Kafka 的 topic 可以分为多个 partition，每个 partition可以在不同的服务器上，这样即使某个服务器出现故障，也不会影响到其他 partition 的正常服务。</li> <li>消费者组（Consumer Groups）：Kafka 允许多个消费者组同时消费同一个 topic，每个消费者组都会维护自己的offset，这样即使某个消费者组出现故障，也不会影响到其他消费者组的消费</li> <li>ZooKeeper 集群：Kafka 使用 ZooKeeper 来管理集群的元数据信息，如 broker、topic 和
partition 的信息等。ZooKeeper 本身也是一个分布式服务，可以通过多个节点组成集群，提供高可用性。</li> <li>ISR（In-Sync Replicas）机制：Kafka 通过 ISR 机制来保证数据的一致性。只有在 ISR 列表中的
follower 才有资格被选为新的 leader，这样可以保证新的 leader 拥有所有的数据副本。</li></ul> <p>通过以上的设计，Kafka 能够在面对故障时，仍能保证服务的可用性和数据的一致性。</p> <h2 id="集群架构"><a href="#集群架构" class="header-anchor">#</a> 集群架构</h2> <p>Kafka 的服务器端由被称为 Broker 的服务进程构成，即一个 Kafka 集群由多个 Broker 组成
这样如果集群中某一台机器宕机，其他机器上的 Broker 也依然能够对外提供服务。这其实就是 Kafka 提供高可用的基础</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409181832683.png" alt="img"></p> <h2 id="kafka集群选举"><a href="#kafka集群选举" class="header-anchor">#</a> Kafka集群选举</h2> <h3 id="isr-与-osr"><a href="#isr-与-osr" class="header-anchor">#</a> ISR 与 OSR</h3> <p>Kafka为了对消息进行分类，引入了Topic（主题）的概念。生产者在发送消息的时候，需要指定发送到某个Topic，然后消息者订阅这个Topic并进行消费消息。</p> <p>Kafka为了提升性能，又在Topic的基础上，引入了Partition（分区）的概念。Topic是逻辑概念，而Partition是物理分组。一个Topic可以包含多个Partition，生产者在发送消息的时候，需要指定发送到某个Topic的某个Partition，然后消息者订阅这个Topic并消费这个Partition中的消息。</p> <p>Kafka为了提高系统的吞吐量和可扩展性，把一个Topic的不同Partition放到多个Broker节点上，充分利用机器资源，也便于扩展Partition。</p> <p>Kafka为了保证数据的安全性和服务的高可用，又在Partition的基础上，引入Replica（副本）的概念。一个Partition包含多个Replica，Replica之间是一主多从的关系，有两种类型Leader Replica（领导者副本）和Follower Replica（跟随者副本），Replica分布在不同的Broker节点上。</p> <p>Leader Replica负责读写请求，Follower Replica只负责同步Leader Replica数据，不对外提供服务。当Leader Replica发生故障，就从Follower Replica选举出一个新的Leader Replica继续对外提供服务，实现了故障自动转移。</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409181833354.png" alt="image.png"></p> <p>Kafka为了提升Replica的同步效率和数据写入效率，又对Replica进行分类。针对一个Partition的所有Replica集合统称为AR（Assigned Replicas，已分配的副本），包含Leader Replica和Follower Replica。与Leader Replica保持同步的Replica集合称为ISR（In-Sync Replicas，同步副本），与Leader Replica保持失去同步的Replica集合称为OSR（Out-of-Sync Replicas，失去同步的副本），AR = ISR + OSR。
Leader Replica将消息写入磁盘前，需要等ISR中的所有副本同步完成。如果ISR中某个Follower Replica同步数据落后Leader Replica过多，会被转移到OSR中。如果OSR中的某个Follower Replica同步数据追上了Leader Replica，会被转移到ISR中。当Leader Replica发生故障的时候，只会从ISR中选举出新的Leader Replica</p> <h3 id="leo和hw"><a href="#leo和hw" class="header-anchor">#</a> LEO和HW</h3> <p>Kafka为了记录副本的同步状态，以及控制消费者消费消息的范围，于是引入了LEO（Log End Offset，日志结束偏移量）和HW（High Watermark，高水位）。
LEO表示分区中的下一个被写入消息的偏移量，也是分区中的最大偏移量。LEO用于记录Leader Replica和Follower Replica之间的数据同步进度，每个副本中各有一份。</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">Leader</span> <span class="token operator">:</span> <span class="token constant">LEO</span> <span class="token number">1000</span> <span class="token constant">HW</span> <span class="token operator">:</span> <span class="token number">950</span>
<span class="token class-name">Follower1</span> <span class="token operator">:</span> <span class="token constant">LEO</span> <span class="token number">980</span>
<span class="token class-name">Follower2</span> <span class="token operator">:</span> <span class="token constant">LEO</span> <span class="token number">1000</span>
<span class="token class-name">Follower3</span> <span class="token operator">:</span> <span class="token constant">LEO</span> <span class="token number">950</span>
</code></pre></div><p>HW表示所有副本（Leader和Follower）都已成功复制的最小偏移量，是所有副本共享的数据值。换句话说，HW之前的消息都被视为已提交，消费者可以消费这些消息。用于确保消息的一致性和只读一次。</p> <p>LEO和HW的更新流程：</p> <ol><li><p>初始状态，三个副本中各有0和1两条消息，LEO都是2，位置2是空的，表示是即将被写入消息的位置。HW也都是2，表示Leader Replica中的所有消息已经全部同步到Follower Replica中，消费者可以消费0和1两条消息。</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409181835723.png" alt="image.png"></p></li> <li><p>生产者往Leader Replica中发送两条消息，此时Leader Replica的LEO的值增加2，变成4。由于还没有开始往Follower Replica同步消息，所以HW值和Follower Replica中LEO值都没有变。由于消费者只能消费HW之前的消息，也就是0和1两条消息</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409181835548.png" alt="image.png"></p></li> <li><p>Leader Replica开始向Follower Replica同步消息，同步速率不同，Follower1的两条消息2和3已经同步完成，而Follower2只同步了一条消息2。此时，Leader和Follower1的LEO都是4，而Follower2的LEO是3，HW表示已成功同步的最小偏移量，值是3，表示此时消费者只能读到0、1、2，三条消息</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409181835749.png" alt="image.png"></p></li> <li><p>所有消息都同步完成，三个副本的LEO都是4，HW也是4，消费者可以读到0、1、2、3，四条消息</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409181835749.png" alt=""></p></li></ol> <h3 id="kafka分区leader选举"><a href="#kafka分区leader选举" class="header-anchor">#</a> Kafka分区Leader选举</h3> <p>常见的有以下几种情况会触发Partition的Leader Replica选举：</p> <ol><li>Leader Replica 失效：当 Leader Replica 出现故障或者失去连接时，Kafka 会触发 Leader Replica 选举。</li> <li>Broker 宕机：当 Leader Replica 所在的 Broker 节点发生故障或者宕机时，Kafka 也会触发 Leader Replica 选举。</li> <li>新增 Broker：当集群中新增 Broker 节点时，Kafka 还会触发 Leader Replica 选举，以重新分配 Partition 的 Leader。</li> <li>新建分区：当一个新的分区被创建时，需要选举一个 Leader Replica。</li> <li>SR 列表数量减少：当 Partition 的 ISR 列表数量减少时，可能会触发 Leader Replica 选举。当 ISR 列表中副本数量小于Replication Factor（副本因子）时，为了保证数据的安全性，就会触发 Leader Replica 选举。</li> <li>手动触发：通过 Kafka 管理工具（kafka-preferred-replica-election.sh），可以手动触发选举，以平衡负载或实现集群维护</li></ol> <h4 id="leader-replica选举策略"><a href="#leader-replica选举策略" class="header-anchor">#</a> Leader Replica选举策略</h4> <p>在 Kafka 集群中，常见的 Leader Replica 选举策略有以下三种：</p> <ol><li>ISR 选举策略：默认情况下，Kafka 只会从 ISR 集合的副本中选举出新的 Leader Replica，OSR 集合中的副本不具备参选资格。</li> <li>不干净副本选举策略（Unclean Leader Election）：在某些情况下，ISR 选举策略可能会失败，例如当所有 ISR 副本都不可用时。在这种情况下，可以使用 Unclean Leader 选举策略。Unclean Leader 选举策略会从所有副本中（包含OSR集合）选择一个副本作为新的 Leader 副本，即使这个副本与当前 Leader 副本不同步。这种选举策略可能会导致数据丢失，默认关闭</li> <li>首选副本选举策略（Preferred Replica Election）：首选副本选举策略也是 Kafka 默认的选举策略。在这种策略下，每个分区都有一个首选副本（Preferred Replica），通常是副本集合中的第一个副本。当触发选举时，控制器会优先选择该首选副本作为新的 Leader Replica，只有在首选副本不可用的情况下，才会考虑其他副本。
当然，可以使用命令手动指定每个分区的首选副本：</li></ol> <blockquote><p>bin/kafka-topics.sh --zookeeper localhost:2181 --topic my-topic-name --replica-assignment 0:1,1:2,2:0 --partitions 3
意思是：my-topic-name有3个partition，partition0的首选副本是Broker1，partition1首选副本是Broker2，partition2的首选副本是Broker0</p></blockquote> <h4 id="leader-replica选举过程"><a href="#leader-replica选举过程" class="header-anchor">#</a> Leader Replica选举过程</h4> <p>谁来主持选举？</p> <p>kafka先在brokers里面选一个broker作为Controller主持选举。Controller是使用zookeeper选举出来的，每个broker都往zk里面写一个/controller节点，谁先写成功，谁就成为Controller。如果Controller失去连接，zk上的临时节点就会消失。其它的broker通过watcher监听到Controller下线的消息后，开始选举新的Controller。</p> <blockquote><p>一个Broker节点相当于一台机器，多个Broker节点组成一个Kafka集群。Controller节点也叫控制器节点 , 他负责直接与zookeeper进行通信，并负责管理整个集群的状态和元数据信息</p></blockquote> <p><strong>Controller的责任</strong></p> <ul><li>监听Broker的变化</li> <li>监听Topic变化</li> <li>监听Partition变化</li> <li>获取和管理Broker、Topic、Partition的信息</li> <li>管理Partition的主从信息</li></ul> <p>当Leader Replica宕机或失效时，就会触发 Leader Replica 选举，分为两个阶段，第一个阶段是候选人的提名和投票阶段，第二个阶段是Leader的确认阶段。具体过程如下：</p> <blockquote><p>lag(滞后）是kafka消费队列性能监控的重要指标，lag的值越大，表示kafka的消息堆积越严重</p></blockquote> <ol><li>候选人提名和投票阶段
在Leader Replica失效时，ISR集合中所有Follower Replica都可以成为新的Leader Replica候选人。每个Follower Replica会在选举开始时向其他Follower Replica发送成为候选人的请求，并附带自己的元数据信息，包括自己的当前状态和Lag值。而Preferred replica优先成为候选人。
其他Follower Replica在收到候选人请求后，会根据请求中的元数据信息，计算每个候选人的Lag值，并将自己的选票投给Lag最小的候选人。如果多个候选人的Lag值相同，则随机选择一个候选人。</li> <li>Leader确认阶段
在第一阶段结束后，所有的Follower Replica会重新计算每位候选人的Lag值，并投票给Lag值最小的候选人。此时，选举的结果并不一定出现对候选人的全局共识。为了避免出现这种情况，Kafka中使用了ZooKeeper来实现分布式锁，确保只有一个候选人能够成为新的Leader Replica。
当ZooKeeper确认有一个候选人已经获得了分布式锁时，该候选人就成为了新的Leader Replica，并向所有的Follower Replica发送一个LeaderAndIsrRequest请求，更新Partition的元数据信息。其他Follower Replica接收到请求后，会更新自己的Partition元数据信息，将新的Leader Replica的ID添加到ISR列表中</li></ol> <h2 id="副本机制-replication"><a href="#副本机制-replication" class="header-anchor">#</a> 副本机制(Replication）</h2> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409181839286.jpeg" alt="img"></p> <p>Kafka 中消息的备份又叫做 副本（Replica）</p> <p>Kafka 定义了两类副本：</p> <ul><li>领导者副本（Leader Replica）: 负责数据读写</li> <li>追随者副本（Follower Replica）: 只负责数据备份</li> <li>当领导者副本所在节点宕机之后, 会从追随者副本中选举一个节点, 升级为领导者副本 , 对外提供数据读写服务, 保证数据安全</li></ul> <h2 id="消费者组和再均衡"><a href="#消费者组和再均衡" class="header-anchor">#</a> 消费者组和再均衡</h2> <h3 id="消费者组"><a href="#消费者组" class="header-anchor">#</a> 消费者组</h3> <p>消费者组（Consumer Group）是由一个或多个消费者实例（Consumer Instance）组成的群组，具有可扩展性和可容错性的一种机制。消费者组内的消费者共享一个消费者组ID，这个ID 也叫做 Group ID，组内的消费者共同对一个主题进行订阅和消费，同一个组中只能够由一个消费者去消费某一个分区的数据，多余的消费者会闲置，派不上用场。</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409181839132.jpeg" alt="img"></p> <blockquote><p>同一个分区只能被一个消费者组中的一个消费者消费 , 一个消费者组中的某一个消费者, 可以消费多个分区</p></blockquote> <p><strong>一个生产者发送一条消息只能被一个消费者消费 : 让消费者处于同一个组中即可</strong> <strong>一个生产者发送一条消息需要被多个消费者消费 : 让消费者处于不同的组中</strong></p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaConsumerListener</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>topics <span class="token operator">=</span> <span class="token string">&quot;kafka.topic.my-topic1&quot;</span><span class="token punctuation">,</span>groupId <span class="token operator">=</span> <span class="token string">&quot;group1&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenTopic1group1</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> value <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;group1中的消费者接收到消息:&quot;</span><span class="token operator">+</span>key <span class="token operator">+</span> <span class="token string">&quot; : &quot;</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>topics <span class="token operator">=</span> <span class="token string">&quot;kafka.topic.my-topic1&quot;</span><span class="token punctuation">,</span>groupId <span class="token operator">=</span> <span class="token string">&quot;group2&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenTopic1group2</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> value <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;group2中的消费者接收到消息:&quot;</span><span class="token operator">+</span>key <span class="token operator">+</span> <span class="token string">&quot; : &quot;</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="再均衡-重平衡"><a href="#再均衡-重平衡" class="header-anchor">#</a> 再均衡(重平衡)</h3> <blockquote><p>再均衡就是指 当消费者组中的消费者发生变更的时候(新增消费者, 消费者宕机) , 重新为消费者分配消费分区的过程</p></blockquote> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409181840102.jpeg" alt="img"></p> <p>当消费者组中重新加入消费者 , 或者消费者组中有消费者宕机 , 这个时候Kafka会为消费者组中的消费者从新分配消费分区的过程就是再均衡</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409181841753.jpeg" alt=""></p> <p>重平衡(再均衡)非常重要，它为消费者群组带来了<code>高可用性</code> 和 <code>伸缩性</code>，我们可以放心的添加消费者或移除消费者，不过在正常情况下我们并不希望发生这样的行为。<strong>在重平衡期间，消费者无法读取消息，造成整个消费者组在重平衡的期间都不可用 , 并且在发生再均衡的时候有可能导致消息的丢失和重复消费</strong></p> <h2 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h2> <p><a href="https://blog.csdn.net/Aaaaaaatwl/article/details/139859673" target="_blank" rel="noopener noreferrer">kafka-高可用设计详解（集群架构、备份机制、消费者组、重平衡）_kafka高可用-CSDN博客<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/echo-lxy/echo-system-design/edit/master/docs/02.Kafka  系统设计/08.四、设计目标/20.高可用探究.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新于:</span> <span class="time">2024/09/18, 11:29:27</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/f57330/" class="prev">副本管理器</a></span> <span class="next"><a href="/pages/168766/">高扩展探究</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:lixinyang2002@163.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/echo-lxy" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2024-2024
    <span>Xinyang Li | MIT License</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.78f2b9cc.js" defer></script><script src="/assets/js/2.933750c6.js" defer></script><script src="/assets/js/31.21bd2de1.js" defer></script><script src="/assets/js/7.7eb70372.js" defer></script>
  </body>
</html>
