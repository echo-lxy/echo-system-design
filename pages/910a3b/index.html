<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ç¬¬ä¸€è¯¾ï¼šByteBuf ä½“ç³»çš„è®¾è®¡ä¸å®ç° | EchoDesign</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="ç³»ç»Ÿè®¾è®¡ä¹‹ã€Œè®²è§£ + é¢è¯•æŒ‡å—ã€ï¼Œæ°´æ»´çŸ³ç©¿ï¼Œè®¾è®¡æ— é“¶å¼¹ï¼">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.c76c3453.css" as="style"><link rel="preload" href="/assets/js/app.9445bb42.js" as="script"><link rel="preload" href="/assets/js/2.933750c6.js" as="script"><link rel="preload" href="/assets/js/58.905475ec.js" as="script"><link rel="preload" href="/assets/js/7.7eb70372.js" as="script"><link rel="prefetch" href="/assets/js/10.2cc95be8.js"><link rel="prefetch" href="/assets/js/100.46e695d9.js"><link rel="prefetch" href="/assets/js/101.99b73fec.js"><link rel="prefetch" href="/assets/js/11.c7521a10.js"><link rel="prefetch" href="/assets/js/12.38d1989d.js"><link rel="prefetch" href="/assets/js/13.850793b0.js"><link rel="prefetch" href="/assets/js/14.1141ec27.js"><link rel="prefetch" href="/assets/js/15.12d1dea8.js"><link rel="prefetch" href="/assets/js/16.92e5eca1.js"><link rel="prefetch" href="/assets/js/17.00b123bb.js"><link rel="prefetch" href="/assets/js/18.e491edb6.js"><link rel="prefetch" href="/assets/js/19.daf31819.js"><link rel="prefetch" href="/assets/js/20.cb4a5c13.js"><link rel="prefetch" href="/assets/js/21.24c0f101.js"><link rel="prefetch" href="/assets/js/22.dd779f94.js"><link rel="prefetch" href="/assets/js/23.4d814163.js"><link rel="prefetch" href="/assets/js/24.891fe6fb.js"><link rel="prefetch" href="/assets/js/25.41dca26b.js"><link rel="prefetch" href="/assets/js/26.6337eac0.js"><link rel="prefetch" href="/assets/js/27.de80589e.js"><link rel="prefetch" href="/assets/js/28.95a1fb6b.js"><link rel="prefetch" href="/assets/js/29.371a40e1.js"><link rel="prefetch" href="/assets/js/3.e62a71e4.js"><link rel="prefetch" href="/assets/js/30.e32f6b31.js"><link rel="prefetch" href="/assets/js/31.a532917f.js"><link rel="prefetch" href="/assets/js/32.13b70e91.js"><link rel="prefetch" href="/assets/js/33.64ab8d0c.js"><link rel="prefetch" href="/assets/js/34.6d3cc288.js"><link rel="prefetch" href="/assets/js/35.98e20e9a.js"><link rel="prefetch" href="/assets/js/36.be98cc35.js"><link rel="prefetch" href="/assets/js/37.82be3556.js"><link rel="prefetch" href="/assets/js/38.40fe2658.js"><link rel="prefetch" href="/assets/js/39.84b6e82e.js"><link rel="prefetch" href="/assets/js/4.73518a0f.js"><link rel="prefetch" href="/assets/js/40.591baf2a.js"><link rel="prefetch" href="/assets/js/41.f961e422.js"><link rel="prefetch" href="/assets/js/42.b34f1599.js"><link rel="prefetch" href="/assets/js/43.5a509601.js"><link rel="prefetch" href="/assets/js/44.64fd3383.js"><link rel="prefetch" href="/assets/js/45.685623ac.js"><link rel="prefetch" href="/assets/js/46.7624d38c.js"><link rel="prefetch" href="/assets/js/47.5646b068.js"><link rel="prefetch" href="/assets/js/48.a1b270df.js"><link rel="prefetch" href="/assets/js/49.ee9681bc.js"><link rel="prefetch" href="/assets/js/5.94727770.js"><link rel="prefetch" href="/assets/js/50.b424b2c0.js"><link rel="prefetch" href="/assets/js/51.ef213b56.js"><link rel="prefetch" href="/assets/js/52.08ad747c.js"><link rel="prefetch" href="/assets/js/53.8a9d9343.js"><link rel="prefetch" href="/assets/js/54.ce49b891.js"><link rel="prefetch" href="/assets/js/55.0edcba5d.js"><link rel="prefetch" href="/assets/js/56.20ad56e8.js"><link rel="prefetch" href="/assets/js/57.0ed5bea6.js"><link rel="prefetch" href="/assets/js/59.d2d9d842.js"><link rel="prefetch" href="/assets/js/6.0b558b79.js"><link rel="prefetch" href="/assets/js/60.96815912.js"><link rel="prefetch" href="/assets/js/61.08b4acf0.js"><link rel="prefetch" href="/assets/js/62.cc8fdced.js"><link rel="prefetch" href="/assets/js/63.41ff19e4.js"><link rel="prefetch" href="/assets/js/64.9b3def35.js"><link rel="prefetch" href="/assets/js/65.0b2ab47d.js"><link rel="prefetch" href="/assets/js/66.2ae7a107.js"><link rel="prefetch" href="/assets/js/67.79dd6daf.js"><link rel="prefetch" href="/assets/js/68.1b76c178.js"><link rel="prefetch" href="/assets/js/69.7ac52a2f.js"><link rel="prefetch" href="/assets/js/70.7279b1df.js"><link rel="prefetch" href="/assets/js/71.4f744076.js"><link rel="prefetch" href="/assets/js/72.44c999da.js"><link rel="prefetch" href="/assets/js/73.526febf1.js"><link rel="prefetch" href="/assets/js/74.26f8d9a5.js"><link rel="prefetch" href="/assets/js/75.dc7fdd0f.js"><link rel="prefetch" href="/assets/js/76.32858593.js"><link rel="prefetch" href="/assets/js/77.7b3f6980.js"><link rel="prefetch" href="/assets/js/78.31a353ef.js"><link rel="prefetch" href="/assets/js/79.173bbc8c.js"><link rel="prefetch" href="/assets/js/8.0ec7f6e8.js"><link rel="prefetch" href="/assets/js/80.78a31e84.js"><link rel="prefetch" href="/assets/js/81.8d6c43d2.js"><link rel="prefetch" href="/assets/js/82.3b90a7cc.js"><link rel="prefetch" href="/assets/js/83.f3a9ee0c.js"><link rel="prefetch" href="/assets/js/84.eeb423e8.js"><link rel="prefetch" href="/assets/js/85.4cd3a775.js"><link rel="prefetch" href="/assets/js/86.931cbb70.js"><link rel="prefetch" href="/assets/js/87.78b2eebd.js"><link rel="prefetch" href="/assets/js/88.605444aa.js"><link rel="prefetch" href="/assets/js/89.b5690031.js"><link rel="prefetch" href="/assets/js/9.6e274fca.js"><link rel="prefetch" href="/assets/js/90.cdc8eb8f.js"><link rel="prefetch" href="/assets/js/91.8ad18b18.js"><link rel="prefetch" href="/assets/js/92.b554f1c7.js"><link rel="prefetch" href="/assets/js/93.fb2397b7.js"><link rel="prefetch" href="/assets/js/94.3086e412.js"><link rel="prefetch" href="/assets/js/95.342f5a9b.js"><link rel="prefetch" href="/assets/js/96.15d8e4f1.js"><link rel="prefetch" href="/assets/js/97.0a9a6187.js"><link rel="prefetch" href="/assets/js/98.b46fd254.js"><link rel="prefetch" href="/assets/js/99.d1ca4fc0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c76c3453.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="ç›®å½•" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="EchoDesign" class="logo"> <span class="site-name can-hide">EchoDesign</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">ğŸ é¦–é¡µ</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">âœ’ï¸çƒ­é—¨ç®—æ³•</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ğŸ–ï¸èµæç»å…¸è®¾è®¡" class="dropdown-title"><!----> <span class="title" style="display:;">ğŸ–ï¸èµæç»å…¸è®¾è®¡</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis æ·±åº¦å‰–æ</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka æ·±åº¦å‰–æ</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty æ·±åº¦å‰–æ</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx æ·±åº¦å‰–æ</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ğŸ§‘â€ğŸ’»å®æˆ˜ç³»ç»Ÿè®¾è®¡</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">â“é—®ç­”</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ğŸ‘€åŠ¨æ€</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">ğŸ é¦–é¡µ</a></div><div class="nav-item"><a href="/pages/fccd91/" class="nav-link">âœ’ï¸çƒ­é—¨ç®—æ³•</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ğŸ–ï¸èµæç»å…¸è®¾è®¡" class="dropdown-title"><!----> <span class="title" style="display:;">ğŸ–ï¸èµæç»å…¸è®¾è®¡</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/252196/" class="nav-link">Redis æ·±åº¦å‰–æ</a></li><li class="dropdown-item"><!----> <a href="/pages/b9733b/" class="nav-link">Kafka æ·±åº¦å‰–æ</a></li><li class="dropdown-item"><!----> <a href="/pages/bfab10/" class="nav-link">Netty æ·±åº¦å‰–æ</a></li><li class="dropdown-item"><!----> <a href="/pages/4601ca/" class="nav-link">Nginx æ·±åº¦å‰–æ</a></li></ul></div></div><div class="nav-item"><a href="/pages/84cb49/" class="nav-link">ğŸ§‘â€ğŸ’»å®æˆ˜ç³»ç»Ÿè®¾è®¡</a></div><div class="nav-item"><a href="/pages/92b2ee/" class="nav-link">â“é—®ç­”</a></div><div class="nav-item"><a href="/pages/52ebd8/" class="nav-link">ğŸ‘€åŠ¨æ€</a></div> <a href="https://github.com/echo-lxy/echo-system-design" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ä¸€ã€å‰è¨€</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>äºŒã€åŸºç¡€çŸ¥è¯†</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ä¸‰ã€ä¸»çº¿ä»»åŠ¡</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>å››ã€æ·±å…¥ Netty æ ¸å¿ƒ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>äº”ã€æ·±å…¥ Netty å†…å­˜ç®¡ç†</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/910a3b/" aria-current="page" class="active sidebar-link">ç¬¬ä¸€è¯¾ï¼šByteBuf ä½“ç³»çš„è®¾è®¡ä¸å®ç°</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/910a3b/#_1-jdk-ä¸­çš„-bytebuffer-è®¾è®¡æœ‰ä½•ä¸å¦¥" class="sidebar-link">1. JDK ä¸­çš„ ByteBuffer è®¾è®¡æœ‰ä½•ä¸å¦¥</a></li><li class="sidebar-sub-header level2"><a href="/pages/910a3b/#_2-netty-å¯¹äº-bytebuf-çš„è®¾è®¡ä¸å®ç°" class="sidebar-link">2. Netty  å¯¹äº ByteBuf çš„è®¾è®¡ä¸å®ç°</a></li><li class="sidebar-sub-header level2"><a href="/pages/910a3b/#_3-heap-or-direct" class="sidebar-link">3. Heap or Direct</a></li><li class="sidebar-sub-header level2"><a href="/pages/910a3b/#_4-cleaner-or-nocleaner" class="sidebar-link">4. Cleaner or NoCleaner</a></li><li class="sidebar-sub-header level2"><a href="/pages/910a3b/#_5-unsafe-or-nounsafe" class="sidebar-link">5. Unsafe or NoUnsafe</a></li><li class="sidebar-sub-header level2"><a href="/pages/910a3b/#_6-pooled-or-unpooled" class="sidebar-link">6. Pooled or Unpooled</a></li><li class="sidebar-sub-header level2"><a href="/pages/910a3b/#_7-metric" class="sidebar-link">7. Metric</a></li><li class="sidebar-sub-header level2"><a href="/pages/910a3b/#_8-bytebufallocator" class="sidebar-link">8. ByteBufAllocator</a></li><li class="sidebar-sub-header level2"><a href="/pages/910a3b/#æ€»ç»“" class="sidebar-link">æ€»ç»“</a></li></ul></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="é¦–é¡µ" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>Netty ç³»ç»Ÿè®¾è®¡</span></li><li data-v-06225672><span data-v-06225672>äº”ã€æ·±å…¥ Netty å†…å­˜ç®¡ç†</span></li></ul> <div class="info" data-v-06225672><div title="ä½œè€…" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/brother-one" target="_blank" title="ä½œè€…" class="beLink" data-v-06225672>echo</a></div> <div title="åˆ›å»ºæ—¶é—´" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-09-19</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">ç›®å½•</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">ç¬¬ä¸€è¯¾ï¼šByteBuf ä½“ç³»çš„è®¾è®¡ä¸å®ç°<!----></h1> <div class="page-slot page-slot-top">
    <div class="wwads-cn wwads-horizontal page-wwads" data-id="136"></div>
    <style>
      .page-wwads{
        width:100%!important;
        min-height: 0;
        margin: 0;
      }
      .page-wwads .wwads-img img{
        width:80px!important;
      }
      .page-wwads .wwads-poweredby{
        width: 40px;
        position: absolute;
        right: 25px;
        bottom: 3px;
      }
      .wwads-content .wwads-text, .page-wwads .wwads-text{
        height: 100%;
        padding-top: 5px;
        display: block;
      }
  </style>
  </div> <div class="theme-vdoing-content content__default"><p>æ—¶å…‰èŠ¿è‹’ï¼Œå²æœˆå¦‚æ¢­ï¼Œå¥½ä¹…æ²¡æœ‰ç»™å¤§å®¶æ›´æ–° Netty ç›¸å…³çš„æ–‡ç« äº†ï¼Œåœ¨æ–­æ›´ Netty çš„è¿™æ®µæ—¥å­é‡Œï¼Œç¬”è€…ä¸€ç›´åœ¨æŒç»­æ›´æ–°  <a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg2MzU3Mjc3Ng==&amp;action=getalbum&amp;album_id=2559805446807928833&amp;scene=173&amp;from_msgid=&amp;from_itemidx=&amp;count=3&amp;nolastread=1&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">Linux å†…å­˜ç®¡ç†ç›¸å…³çš„æ–‡ç« <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ï¼Œç›®å‰ä¸ºæ­¢ï¼Œç®—æ˜¯å°† Linux å†…å­˜ç®¡ç†å­ç³»ç»Ÿç›¸å…³çš„ä¸»å¹²æºç è¾ƒä¸ºå®Œæ•´çš„ç»™å¤§å®¶å‘ˆç°äº†å‡ºæ¥ï¼ŒåŒæ—¶ä¹Ÿç»“è¯†äº†å¾ˆå¤šå–œæ¬¢å†…æ ¸çš„è¯»è€…ï¼Œç»å¸¸åœ¨åå°ç•™è¨€è®¨è®ºä¸€äº›ä»£ç çš„è®¾è®¡ç»†èŠ‚ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç›¸äº’åˆ†äº«ï¼Œç›¸äº’å­¦ä¹ ï¼Œæµ“æµ“çš„æ„Ÿå—åˆ°äº†å¤§å®¶å¯¹æŠ€æœ¯é‚£ä»½çº¯ç²¹çš„çƒ­çˆ±ï¼Œå¯¹äºæˆ‘è‡ªå·±æ¥è¯´ï¼Œä¹Ÿæ˜¯ä¸€ç§æ¿€åŠ±ï¼Œå­¦ä¹ ï¼Œæé«˜çš„æœºä¼šã€‚</p> <p>ä¹‹å‰ç³»åˆ—æ–‡ç« çš„è§†è§’ä¸€ç›´æ˜¯åœç•™åœ¨å†…æ ¸æ€ï¼Œç¬”è€…è¯•å›¾ä» Linux å†…æ ¸çš„è§’åº¦æ¥ä¸ºå¤§å®¶æ­ç§˜å†…å­˜ç®¡ç†çš„æœ¬è´¨ï¼Œé‚£ä¹ˆä»ä»Šå¤©å¼€å§‹ï¼Œæˆ‘ä»¬æŠŠè§†è§’åœ¨å¾€ä¸ŠæŒªä¸€æŒªï¼Œä»å†…æ ¸æ€è½¬æ¢åˆ°ç”¨æˆ·æ€ï¼Œç»§ç»­æ²¿ç€å†…å­˜ç®¡ç†è¿™æ¡ä¸»çº¿ï¼Œæ¥çœ‹ä¸€çœ‹ç”¨æˆ·æ€çš„å†…å­˜ç®¡ç†æ˜¯å¦‚ä½•è¿›è¡Œçš„ã€‚</p> <p>æ¥ä¸‹æ¥ç¬”è€…è®¡åˆ’ç”¨ä¸‰ç¯‡æ–‡ç« çš„ç¯‡å¹…ä¸ºå¤§å®¶å‰–æä¸€ä¸‹ Netty çš„å†…å­˜ç®¡ç†æ¨¡å—ï¼Œæœ¬æ–‡æ˜¯ç¬¬ä¸€ç¯‡ï¼Œä¸»è¦æ˜¯å›´ç»• Netty å†…å­˜ç®¡ç†çš„å¤–å›´ä»‹ç»ä¸€ä¸‹  ByteBuf çš„æ€»ä½“è®¾è®¡ã€‚</p> <p><img src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/sOIZXFW0vUZFdNJKVEk1X07SFzmQ63xFDO9aZqF2Mw3JOmgJYRcyzVGlaXvjUGeQ4SgpZnplT5QaXfLSBQialhg/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡"></p> <p>åˆ«çœ‹ ByteBuf ä½“ç³»æ¶‰åŠåˆ°çš„ç±»æ¯”è¾ƒå¤šï¼Œä¸€çœ¼æœ›è¿‡å»æ¯”è¾ƒå¤´å¤§ï¼Œä½†æ˜¯æˆ‘ä»¬æŒ‰ç…§ä¸åŒçš„è§†è§’ï¼Œå°†å®ƒä»¬ä¸€ä¸€åˆ†ç±»ï¼Œæ•´ä¸ªä½“ç³»è„‰ç»œå°±å˜å¾—å¾ˆæ¸…æ™°äº†ï¼š</p> <ul><li>ä» JVM å†…å­˜åŒºåŸŸå¸ƒå±€çš„è§’åº¦æ¥çœ‹ï¼ŒNetty çš„ ByteBuf ä¸»è¦åˆ†ä¸º HeapByteBufï¼ˆå †å†…ï¼‰ å’Œ DirectByteBufï¼ˆå †å¤–ï¼‰è¿™ä¸¤ç§ç±»å‹ã€‚</li> <li>ä»å†…å­˜ç®¡ç†çš„è§’åº¦æ¥çœ‹ï¼ŒNetty çš„ ByteBuf  åˆåˆ†ä¸º PooledByteBuf ï¼ˆæ± åŒ–ï¼‰å’Œ UnpooledByteBufï¼ˆéæ± åŒ–ï¼‰ä¸¤ç§å­ç±»å‹ã€‚ä¸€ç§æ˜¯è¢«å†…å­˜æ± ç»Ÿä¸€ç®¡ç†ï¼Œå¦ä¸€ç§åˆ™å’Œæ™®é€šçš„ ByteBuf ä¸€æ ·ï¼Œç”¨çš„æ—¶å€™ä¸´æ—¶åˆ›å»ºï¼Œä¸ç”¨çš„æ—¶å€™é‡Šæ”¾ã€‚</li> <li>ä»å†…å­˜è®¿é—®çš„è§’åº¦æ¥çœ‹ï¼ŒNetty åˆå°† ByteBuf åˆ†ä¸ºäº† UnsafeByteBuf å’Œæ™®é€šçš„ ByteBufã€‚UnsafeByteBuf ä¸»è¦æ˜¯ä¾èµ– Unsafe ç±»æä¾›çš„åº•å±‚ API æ¥ç›´æ¥å¯¹å†…å­˜åœ°å€è¿›è¡Œæ“ä½œã€‚è€Œæ™®é€š ByteBuf å¯¹å†…å­˜çš„æ“ä½œä¸»è¦æ˜¯ä¾èµ– NIO ä¸­çš„ ByteBufferã€‚</li> <li>ä»å†…å­˜å›æ”¶çš„è§’åº¦æ¥çœ‹ï¼ŒByteBuf åˆåˆ†ä¸ºäº†å¸¦ Cleaner çš„ ByteBuf ä»¥åŠä¸å¸¦ Cleaner çš„ NoCleanerByteBufï¼ŒCleaner åœ¨ JDK ä¸­æ˜¯ç”¨æ¥é‡Šæ”¾ NIO ByteBuffer èƒŒåæ‰€å¼•ç”¨çš„ Native Memory çš„ï¼Œå†…å­˜çš„é‡Šæ”¾ç”± JVM ç»Ÿä¸€ç®¡ç†ã€‚è€Œ NoCleanerByteBuf èƒŒåçš„ Native Memory åˆ™éœ€è¦æˆ‘ä»¬è¿›è¡Œæ‰‹åŠ¨é‡Šæ”¾ã€‚</li> <li>ä»å†…å­˜å ç”¨ç»Ÿè®¡çš„è§’åº¦æ¥è¯´ï¼ŒNetty åˆè¿‘ä¸€æ­¥å°† ByteBuf åˆ†ä¸ºäº† InstrumentedByteBuf å’Œæ™®é€šçš„ ByteBufï¼Œå…¶ä¸­ InstrumentedByteBuf ä¼šå¸¦æœ‰å†…å­˜å ç”¨ç›¸å…³ Metrics çš„ç»Ÿè®¡ä¾›æˆ‘ä»¬è¿›è¡Œç›‘æ§ï¼Œè€Œæ™®é€šçš„ ByteBuf åˆ™ä¸å¸¦æœ‰çƒ­ä»»ä½• Metricsã€‚</li> <li>ä»é›¶æ‹·è´çš„è§’åº¦æ¥çœ‹ï¼ŒNetty åˆå¼•å…¥äº† CompositeByteBufï¼Œç›®çš„æ˜¯ä¸ºå¤šä¸ª ByteBuf åœ¨èšåˆçš„æ—¶å€™æä¾›ä¸€ä¸ªç»Ÿä¸€çš„é€»è¾‘è§†å›¾ï¼Œå°†å¤šä¸ª ByteBuf èšåˆæˆä¸€ä¸ªé€»è¾‘ä¸Šçš„ CompositeByteBufï¼Œè€Œä¼ ç»Ÿçš„èšåˆæ“ä½œåˆ™æ˜¯é¦–å…ˆè¦åˆ†é…ä¸€ä¸ªå¤§çš„ ByteBufï¼Œç„¶åå°†éœ€è¦èšåˆçš„å¤šä¸ª ByteBuf ä¸­çš„å†…å®¹åœ¨æ‹·è´åˆ°æ–°çš„ ByteBuf ä¸­ã€‚CompositeByteBuf é¿å…äº†åˆ†é…å¤§æ®µå†…å­˜ä»¥åŠå†…å­˜æ‹·è´çš„å¼€é”€ã€‚æ³¨æ„è¿™é‡Œçš„é›¶æ‹·è´æŒ‡çš„æ˜¯ Netty åœ¨ç”¨æˆ·æ€å±‚é¢è‡ªå·±å®ç°çš„é¿å…å†…å­˜æ‹·è´çš„è®¾è®¡ï¼Œè€Œä¸æ˜¯ OS å±‚é¢ä¸Šçš„é›¶æ‹·è´ã€‚</li> <li>å¦å¤– Netty çš„ ByteBuf æ”¯æŒå¼•ç”¨è®¡æ•°ä»¥åŠè‡ªåŠ¨åœ°å†…å­˜æ³„éœ²æ¢æµ‹ï¼Œå¦‚æœæœ‰å†…å­˜æ³„éœ²çš„æƒ…å†µï¼ŒNetty ä¼šå°†å…·ä½“å‘ç”Ÿæ³„éœ²çš„ä½ç½®æŠ¥å‘Šå‡ºæ¥ã€‚</li> <li>Netty çš„ ByteBuf æ”¯æŒæ‰©å®¹ï¼Œè€Œ NIO çš„ ByteBuffer åˆ™ä¸æ”¯æŒæ‰©å®¹ï¼Œ</li></ul> <p>åœ¨å°† Netty çš„ ByteBuf è®¾è®¡ä½“ç³»æ¢³ç†å®Œæ•´ä¹‹åï¼Œæˆ‘ä»¬å°±ä¼šå‘ç°ï¼ŒNetty çš„ ByteBuf å…¶å®æ˜¯å¯¹ JDK  ByteBuffer çš„ä¸€ç§æ‰©å±•å’Œå®Œå–„ï¼Œæ‰€ä»¥ä¸‹é¢ç¬”è€…çš„è¡Œæ–‡æ€è·¯æ˜¯ä¸ JDK  ByteBuffer å¯¹æ¯”ç€è¿›è¡Œä»‹ç» Netty çš„ ByteBuf ï¼Œæœ‰äº†å¯¹æ¯”ï¼Œæˆ‘ä»¬æ‰èƒ½æ›´åŠ æ·±åˆ»çš„ä½“ä¼šåˆ° Netty è®¾è®¡çš„ç²¾å¦™ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)æœ¬æ–‡æ¦‚è¦.png</p> <h2 id="_1-jdk-ä¸­çš„-bytebuffer-è®¾è®¡æœ‰ä½•ä¸å¦¥"><a href="#_1-jdk-ä¸­çš„-bytebuffer-è®¾è®¡æœ‰ä½•ä¸å¦¥" class="header-anchor">#</a> <strong>1. JDK ä¸­çš„ ByteBuffer è®¾è®¡æœ‰ä½•ä¸å¦¥</strong></h2> <p>ç¬”è€…æ›¾åœ¨ <a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247485497&amp;idx=1&amp;sn=eb4afe6764b2b976fb80f6dc5c6fd68a&amp;chksm=ce77ce7ef900476865864e09bb6f0688ca784afc396084ecc90a894bfd733692049c332edd11&amp;token=927203489&amp;lang=zh_CN&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">ã€Šä¸€æ­¥ä¸€å›¾å¸¦ä½ æ·±å…¥å‰–æ JDK NIO ByteBuffer åœ¨ä¸åŒå­—èŠ‚åºä¸‹çš„è®¾è®¡ä¸å®ç°ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ä¸€æ–‡ä¸­å®Œæ•´çš„ä»‹ç»è¿‡ JDK ByteBuffer çš„æ•´ä¸ªè®¾è®¡ä½“ç³»ï¼Œä¸‹é¢æˆ‘ä»¬æ¥ç®€çŸ­å›å¿†ä¸€ä¸‹ ByteBuffer çš„å‡ ä¸ªæ ¸å¿ƒè¦ç´ ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public abstract class Buffer {
    private int mark = -1;
    private int position = 0;
    private int limit;
    private int capacity;
}
</code></pre></div><p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <ul><li>capacity è§„å®šäº†æ•´ä¸ª Buffer çš„å®¹é‡ï¼Œå…·ä½“å¯ä»¥å®¹çº³å¤šå°‘ä¸ªå…ƒç´ ã€‚capacity ä¹‹å‰çš„å…ƒç´ å‡æ˜¯ Buffer å¯æ“ä½œçš„ç©ºé—´ï¼ŒJDK ä¸­çš„ ByteBuffer æ˜¯ä¸å¯æ‰©å®¹çš„ã€‚</li> <li>position ç”¨äºæŒ‡å‘ Buffer ä¸­ä¸‹ä¸€ä¸ªå¯æ“ä½œæ€§çš„å…ƒç´ ï¼Œåˆå§‹å€¼ä¸º 0ã€‚å¯¹äº Buffer çš„è¯»å†™æ“ä½œå…¨éƒ¨éƒ½å…±ç”¨è¿™ä¸€ä¸ª position æŒ‡é’ˆï¼Œåœ¨ Buffer çš„å†™æ¨¡å¼ä¸‹ï¼Œposition æŒ‡é’ˆç”¨äºæŒ‡å‘ä¸‹ä¸€ä¸ªå¯å†™ä½ç½®ã€‚åœ¨è¯»æ¨¡å¼ä¸‹ï¼Œposition æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªå¯è¯»ä½ç½®ã€‚</li> <li>limit ç”¨äºé™å®š Buffer å¯æ“ä½œå…ƒç´ çš„ä¸Šé™ï¼Œposition æŒ‡é’ˆä¸èƒ½è¶…è¿‡ limitã€‚</li></ul> <p>ç”±äº JDK ByteBuffer åªè®¾è®¡äº†ä¸€ä¸ª position æŒ‡é’ˆï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è¯»å†™ ByteBuffer çš„æ—¶å€™éœ€è¦ä¸æ–­çš„è°ƒæ•´ position çš„ä½ç½®ã€‚æ¯”å¦‚ï¼Œåˆ©ç”¨ flip() ï¼Œrewind()ï¼Œcompact()ï¼Œclear() ç­‰æ–¹æ³•ä¸æ–­çš„è¿›è¡Œè¯»å†™æ¨¡å¼çš„åˆ‡æ¢ã€‚</p> <p>ä¸€äº›å…·ä½“çš„åœºæ™¯ä½“ç°å°±æ˜¯ï¼Œå½“æˆ‘ä»¬å¯¹ä¸€ä¸ª ByteBuffer è¿›è¡Œå†™å…¥çš„æ—¶å€™ï¼Œéšç€æ•°æ®ä¸æ–­çš„å‘ ByteBuffer å†™å…¥ï¼Œposition æŒ‡é’ˆä¼šä¸æ–­çš„å‘åç§»åŠ¨ã€‚åœ¨å†™å…¥æ“ä½œå®Œæˆä¹‹åï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦ä» ByteBuffer è¯»å–åˆšåˆšå†™å…¥çš„æ•°æ®å°±éº»çƒ¦äº†ã€‚</p> <p>ç”±äº JDK åœ¨å¯¹ ByteBuffer çš„è®¾è®¡ä¸­è¯»å†™æ“ä½œéƒ½æ˜¯æ··ç”¨ä¸€ä¸ª position æŒ‡é’ˆï¼Œæ‰€ä»¥åœ¨è¯»å– ByteBuffer ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦é€šè¿‡  flip() è°ƒæ•´ position çš„ä½ç½®ï¼Œè¿›è¡Œè¯»æ¨¡å¼çš„åˆ‡æ¢ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191121428.webp" alt="å›¾ç‰‡">flipåˆ‡æ¢è¯»æ¨¡å¼.png</p> <div class="language- extra-class"><pre class="language-text"><code>    public final Buffer flip() {
        limit = position;
        position = 0;
        mark = -1;
        return this;
    }
</code></pre></div><p>å½“æˆ‘ä»¬å°† ByteBuffer ä¸­çš„æ•°æ®å…¨éƒ¨è¯»å–å®Œä¹‹åï¼Œå¦‚æœå†æ¬¡å‘ ByteBuffer å†™å…¥æ•°æ®ï¼Œé‚£ä¹ˆè¿˜éœ€è¦é‡æ–°è°ƒæ•´ position çš„ä½ç½®ï¼Œé€šè¿‡ clear()  æ¥è¿›è¡Œå†™æ¨¡å¼çš„åˆ‡æ¢ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)clearåˆ‡æ¢å†™æ¨¡å¼.png</p> <div class="language- extra-class"><pre class="language-text"><code>    public final Buffer clear() {
        position = 0;
        limit = capacity;
        mark = -1;
        return this;
    }
</code></pre></div><p>å¦‚æœæˆ‘ä»¬åªæ˜¯éƒ¨åˆ†è¯»å–äº† ByteBuffer ä¸­çš„æ•°æ®è€Œä¸æ˜¯å…¨éƒ¨è¯»å–ï¼Œé‚£ä¹ˆåœ¨å†™å…¥çš„æ—¶å€™ï¼Œä¸ºäº†é¿å…æœªè¢«è¯»å–çš„éƒ¨åˆ†è¢«æ¥ä¸‹æ¥çš„å†™å…¥æ“ä½œè¦†ç›–ï¼Œæˆ‘ä»¬åˆ™éœ€è¦é€šè¿‡ compact() æ–¹æ³•æ¥åˆ‡æ¢å†™æ¨¡å¼ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191121389.webp" alt="å›¾ç‰‡">comapctåˆ‡æ¢å†™æ¨¡å¼.png</p> <div class="language- extra-class"><pre class="language-text"><code>class HeapByteBuffer extends ByteBuffer {

    //HeapBufferä¸­åº•å±‚è´Ÿè´£å­˜å‚¨æ•°æ®çš„æ•°ç»„
    final byte[] hb; 

    public ByteBuffer compact() {
        System.arraycopy(hb, ix(position()), hb, ix(0), remaining());
        position(remaining());
        limit(capacity());
        discardMark();
        return this;
    }

    public final int remaining() {
        return limit - position;
    }

   final void discardMark() {                          
        mark = -1;
    }
}
</code></pre></div><p>ä»ä¸Šé¢åˆ—ä¸¾çš„è¿™äº›è¯»å†™ ByteBuffer åœºæ™¯å¯ä»¥çœ‹å‡ºï¼Œå½“æˆ‘ä»¬åœ¨æ“ä½œ ByteBuffer çš„æ—¶å€™ï¼Œéœ€è¦æ—¶åˆ»ä¿æŒå¤´è„‘æ¸…é†’ï¼Œå¯¹ ByteBuffer ä¸­å“ªäº›éƒ¨åˆ†æ˜¯å¯è¯»çš„ï¼Œå“ªäº›éƒ¨åˆ†æ˜¯å¯å†™çš„è¦æœ‰ä¸€ä¸ªæ¸…é†’çš„è®¤è¯†ï¼Œç¨ä¸ç•™ç¥å°±ä¼šå‡ºé”™ã€‚åœ¨å¤æ‚çš„ç¼–è§£ç é€»è¾‘ä¸­ï¼Œå¦‚æœä½¿ç”¨ ByteBuffer çš„è¯ï¼Œå°±éœ€è¦ä¸æ–­çš„è¿›è¡Œè¯»å†™æ¨¡å¼çš„åˆ‡æ¢ï¼Œåˆ‡çš„åˆ‡çš„äººå°±å‚»äº†ã€‚</p> <p>é™¤äº†å¯¹ ByteBuffer çš„ç›¸å…³æ“ä½œæ¯”è¾ƒéº»çƒ¦ä¹‹å¤–ï¼ŒJDK å¯¹äº ByteBuffer æ²¡æœ‰è®¾è®¡æ± åŒ–ç®¡ç†æœºåˆ¶ï¼Œè€Œé¢å¯¹å¤§é‡éœ€è¦ä½¿ç”¨å †å¤–å†…å­˜çš„åœºæ™¯ï¼Œæˆ‘ä»¬å°±éœ€è¦ä¸æ–­çš„åˆ›å»º DirectBufferï¼ŒDirectBuffer åœ¨ä½¿ç”¨å®Œä¹‹åï¼Œå›æ”¶åˆæ˜¯ä¸ªé—®é¢˜ã€‚</p> <p>JDK è‡ªèº«å¯¹äº DirectBuffer çš„å›æ”¶æ˜¯æœ‰å»¶è¿Ÿçš„ï¼Œæˆ‘ä»¬éœ€è¦ç­‰åˆ°ä¸€æ¬¡ FullGc ï¼Œè¿™äº› DirectBuffer èƒŒåå¼•ç”¨çš„ Native Memory æ‰èƒ½è¢« JVM è‡ªåŠ¨å›æ”¶ã€‚æ‰€ä»¥ä¸ºäº†åŠæ—¶å›æ”¶è¿™äº› Native Memory ï¼Œæˆ‘ä»¬åˆéœ€è¦æ“å¿ƒ DirectBuffer çš„æ‰‹åŠ¨é‡Šæ”¾ã€‚</p> <p>JDK çš„ ByteBuffer ä¸æ”¯æŒå¼•ç”¨è®¡æ•°ï¼Œæ²¡æœ‰å¼•ç”¨è®¡æ•°çš„è®¾è®¡ï¼Œæˆ‘ä»¬å°±æ— ä»å¾—çŸ¥ä¸€ä¸ª DirectBuffer è¢«å¼•ç”¨äº†å¤šå°‘æ¬¡ï¼Œåˆè¢«é‡Šæ”¾äº†å¤šå°‘æ¬¡ï¼Œé¢å¯¹ DirectBuffer å¼•èµ·çš„å†…å­˜æ³„éœ²é—®é¢˜ï¼Œä¹Ÿå°±æ— æ³•è¿›è¡Œè‡ªåŠ¨æ¢æµ‹ã€‚</p> <p>å¦å¤– JDK çš„ ByteBuffer ä¸æ”¯æŒåŠ¨æ€æŒ‰éœ€è‡ªé€‚åº”æ‰©å®¹ï¼Œå½“ä¸€ä¸ª ByteBuffer è¢«åˆ›å»ºå‡ºæ¥ä¹‹åï¼Œå®ƒçš„å®¹é‡å°±å›ºå®šäº†ã€‚ä½†å®é™…ä¸Šï¼Œæˆ‘ä»¬å¾ˆéš¾åœ¨ä¸€å¼€å§‹å°±èƒ½å‡†ç¡®çš„è¯„ä¼°å‡ºåˆ°åº•éœ€è¦å¤šå¤§çš„ ByteBufferã€‚åˆ†é…çš„å®¹é‡å¤§äº†ï¼Œä¼šé€ æˆæµªè´¹ã€‚åˆ†é…çš„å®¹é‡å°äº†ï¼Œæˆ‘ä»¬åˆéœ€è¦æ¯æ¬¡åœ¨å†™å…¥çš„æ—¶å€™åˆ¤æ–­å‰©ä½™å®¹é‡æ˜¯å¦è¶³å¤Ÿï¼Œå¦‚æœä¸è¶³ï¼Œåˆéœ€è¦æ‰‹åŠ¨å»ç”³è¯·ä¸€ä¸ªæ›´å¤§çš„ ByteBufferï¼Œç„¶ååœ¨å°†åŸæœ‰ ByteBuffer ä¸­çš„æ•°æ®è¿ç§»åˆ°æ–°çš„ ByteBuffer ä¸­ï¼Œæƒ³æƒ³éƒ½éº»çƒ¦ã€‚</p> <p>è¿˜æœ‰å°±æ˜¯å½“å¤šä¸ª JDK çš„ ByteBuffer åœ¨é¢å¯¹åˆå¹¶èšåˆçš„åœºæ™¯ï¼Œæ€»æ˜¯è¦å…ˆåˆ›å»ºä¸€ä¸ªæ›´å¤§çš„ ByteBufferï¼Œç„¶åå°†åŸæœ‰çš„å¤šä¸ª ByteBuffer ä¸­çš„å†…å®¹åœ¨æ‹·è´åˆ°æ–°çš„ ByteBuffer ä¸­ã€‚è¿™å°±æ¶‰åŠåˆ°äº†å†…å­˜åˆ†é…å’Œæ‹·è´çš„å¼€é”€ã€‚</p> <p>é‚£ä¸ºä»€ä¹ˆä¸èƒ½åˆ©ç”¨åŸæœ‰çš„è¿™äº› ByteBuffer æ‰€å ç”¨çš„å†…å­˜ç©ºé—´ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šåªåˆ›å»ºä¸€ä¸ªé€»è¾‘ä¸Šçš„è§†å›¾ ByteBufferï¼Œå°†å¯¹è§†å›¾ ByteBuffer çš„é€»è¾‘æ“ä½œå…¨éƒ¨è½¬ç§»åˆ°åŸæœ‰çš„å†…å­˜ç©ºé—´ä¸Šï¼Œè¿™æ ·ä¸€æ¥ä¸å°±å¯ä»¥çœå»é‡æ–°åˆ†é…å†…å­˜ä»¥åŠå†…å­˜æ‹·è´çš„å¼€é”€äº†ä¹ˆ ï¼Ÿ</p> <p>ä¸‹é¢æˆ‘ä»¬å°±æ¥ä¸€èµ·çœ‹ä¸‹ï¼ŒNetty ä¸­çš„ ByteBuf æ˜¯å¦‚ä½•è§£å†³å¹¶å®Œå–„ä¸Šè¿°é—®é¢˜çš„~~~</p> <h2 id="_2-netty-å¯¹äº-bytebuf-çš„è®¾è®¡ä¸å®ç°"><a href="#_2-netty-å¯¹äº-bytebuf-çš„è®¾è®¡ä¸å®ç°" class="header-anchor">#</a> <strong>2. Netty  å¯¹äº ByteBuf çš„è®¾è®¡ä¸å®ç°</strong></h2> <p>åœ¨ä¹‹å‰ä»‹ç» JDK ByteBuffer æ•´ä½“è®¾è®¡çš„æ—¶å€™ï¼Œç¬”è€…æ˜¯ä»¥ HeapByteBuffer ä¸ºä¾‹å°† ByteBuffer çš„æ•´ä¸ªè®¾è®¡ä½“ç³»ä¸²è”èµ·æ¥çš„ï¼Œé‚£ä¹ˆæœ¬æ–‡ç¬”è€…å°†ä¼šç”¨ DirectByteBuf ä¸ºå¤§å®¶ä¸²è” Netty ByteBuf çš„è®¾è®¡ä½“ç³»ã€‚</p> <h3 id="_2-1-bytebuf-çš„åŸºæœ¬ç»“æ„"><a href="#_2-1-bytebuf-çš„åŸºæœ¬ç»“æ„" class="header-anchor">#</a> <strong>2.1 ByteBuf çš„åŸºæœ¬ç»“æ„</strong></h3> <div class="language- extra-class"><pre class="language-text"><code>public abstract class AbstractByteBuf extends ByteBuf {
    int readerIndex;
    int writerIndex;
    private int markedReaderIndex;
    private int markedWriterIndex;
    private int maxCapacity;
}

public class UnpooledDirectByteBuf extends AbstractReferenceCountedByteBuf {
    private int capacity;
}
</code></pre></div><p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>ä¸ºäº†é¿å… JDK ByteBuffer åœ¨è¯»å†™æ¨¡å¼ä¸‹å…±ç”¨ä¸€ä¸ª position æŒ‡é’ˆæ‰€å¼•èµ·çš„ç¹çæ“ä½œï¼ŒNetty ä¸º ByteBuf å¼•å…¥äº†ä¸¤ä¸ªæŒ‡é’ˆï¼ŒreaderIndex ç”¨äºæŒ‡å‘ ByteBuf ä¸­ç¬¬ä¸€ä¸ªå¯è¯»å­—èŠ‚ä½ç½®ï¼ŒwriterIndex ç”¨äºæŒ‡å‘ ByteBuf ä¸­ç¬¬ä¸€ä¸ªå¯å†™çš„å­—èŠ‚ä½ç½®ã€‚æœ‰äº†è¿™ä¸¤ä¸ªç‹¬ç«‹çš„æŒ‡é’ˆä¹‹åï¼Œæˆ‘ä»¬åœ¨å¯¹ Netty ByteBuf è¿›è¡Œè¯»å†™æ“ä½œçš„æ—¶å€™ï¼Œå°±ä¸éœ€è¦è¿›è¡Œç¹ççš„è¯»å†™æ¨¡å¼åˆ‡æ¢äº†ã€‚ä¸ä¹‹å¯¹åº”çš„ markedReaderIndexï¼ŒmarkedWriterIndex ç”¨äºæ”¯æŒ ByteBuf ç›¸å…³çš„ mark å’Œ reset æ“ä½œï¼Œè¿™ä¸€ç‚¹å’Œ JDK  ä¸­çš„è®¾è®¡ä¿æŒä¸€è‡´ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public ByteBuf markReaderIndex() {
        markedReaderIndex = readerIndex;
        return this;
    }

    @Override
    public ByteBuf resetReaderIndex() {
        readerIndex(markedReaderIndex);
        return this;
    }

    @Override
    public ByteBuf markWriterIndex() {
        markedWriterIndex = writerIndex;
        return this;
    }

    @Override
    public ByteBuf resetWriterIndex() {
        writerIndex(markedWriterIndex);
        return this;
    }
</code></pre></div><p>ç”±äº JDK ByteBuffer åœ¨è®¾è®¡ä¸Šä¸æ”¯æŒæ‰©å®¹æœºåˆ¶ï¼Œæ‰€ä»¥ Netty ä¸º ByteBuf é¢å¤–å¼•å…¥äº†ä¸€ä¸ªæ–°çš„å­—æ®µ maxCapacityï¼Œç”¨äºè¡¨ç¤º ByteBuf å®¹é‡æœ€å¤šåªèƒ½æ‰©å®¹è‡³ maxCapacityã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public int calculateNewCapacity(int minNewCapacity, int maxCapacity) {
        if (minNewCapacity &gt; maxCapacity) {
            throw new IllegalArgumentException(String.format(
                    &quot;minNewCapacity: %d (expected: not greater than maxCapacity(%d)&quot;,
                    minNewCapacity, maxCapacity));
        }
    }
</code></pre></div><p>Netty ByteBuf çš„ capacity ä¸ JDK ByteBuffer ä¸­çš„ capacity å«ä¹‰ä¿æŒä¸€è‡´ï¼Œç”¨äºè¡¨ç¤º ByteBuf çš„åˆå§‹å®¹é‡å¤§å°ï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢åœ¨åˆ›å»º UnpooledDirectByteBuf çš„æ—¶å€™ä¼ å…¥çš„ initialCapacity å‚æ•°ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class UnpooledDirectByteBuf extends AbstractReferenceCountedByteBuf {
      // Netty ByteBuf åº•å±‚ä¾èµ–çš„ JDK ByteBuffer
      ByteBuffer buffer;
      // ByteBuf åˆå§‹çš„å®¹é‡ï¼Œä¹Ÿæ˜¯çœŸæ­£çš„å†…å­˜å ç”¨
      private int capacity;

      public UnpooledDirectByteBuf(ByteBufAllocator alloc, int initialCapacity, int maxCapacity) {
        // è®¾ç½®æœ€å¤§å¯æ‰©å®¹çš„å®¹é‡
        super(maxCapacity);
        this.alloc = alloc;
        // æŒ‰ç…§ initialCapacity æŒ‡å®šçš„åˆå§‹å®¹é‡ï¼Œåˆ›å»º JDK ByteBuffer
        setByteBuffer(allocateDirect(initialCapacity), false);
    }

    void setByteBuffer(ByteBuffer buffer, boolean tryFree) {
        // UnpooledDirectByteBuf åº•å±‚ä¼šä¾èµ–ä¸€ä¸ª JDK çš„ ByteBuffer
        // åç»­å¯¹ UnpooledDirectByteBuf çš„æ“ä½œï¼Œ Netty å…¨éƒ¨ä¼šä»£ç†åˆ° JDK ByteBuffer ä¸­
        this.buffer = buffer;
        // åˆå§‹æŒ‡å®šçš„ ByteBuf å®¹é‡ initialCapacity
        capacity = buffer.remaining();    
    }
}
</code></pre></div><p>ç”±æ­¤ä¸€æ¥ï¼ŒNetty ä¸­çš„ ByteBuf å°±ä¼šè¢« readerIndexï¼ŒwriterIndexï¼Œcapacityï¼ŒmaxCapacity è¿™å››ä¸ªæŒ‡é’ˆåˆ†å‰²æˆå››ä¸ªéƒ¨åˆ†ï¼Œä¸Šå›¾ä¸­ç¬”è€…ä»¥æŒ‰ç…§ä¸åŒçš„é¢œè‰²è¿›è¡Œäº†åŒºåˆ†ã€‚</p> <ul><li>å…¶ä¸­ <code>[0 , capacity)</code> è¿™éƒ¨åˆ†æ˜¯åˆ›å»º ByteBuf çš„æ—¶å€™åˆ†é…çš„åˆå§‹å®¹é‡ï¼Œè¿™éƒ¨åˆ†æ˜¯çœŸæ­£å ç”¨å†…å­˜çš„ï¼Œè€Œ <code>[capacity , maxCapacity)</code>è¿™éƒ¨åˆ†è¡¨ç¤º ByteBuf å¯æ‰©å®¹çš„å®¹é‡ï¼Œè¿™éƒ¨åˆ†è¿˜æœªåˆ†é…å†…å­˜ã€‚</li> <li><code>[0 , readerIndex)</code> è¿™éƒ¨åˆ†å­—èŠ‚æ˜¯å·²ç»è¢«è¯»å–è¿‡çš„å­—èŠ‚ï¼Œæ˜¯å¯ä»¥è¢«ä¸¢å¼ƒçš„èŒƒå›´ã€‚</li> <li><code>[readerIndex , writerIndex)</code> è¿™éƒ¨åˆ†å­—èŠ‚è¡¨ç¤º ByteBuf ä¸­å¯ä»¥è¢«è¯»å–çš„å­—èŠ‚ã€‚</li> <li><code>[writerIndex , capacity)</code> è¿™éƒ¨åˆ†è¡¨ç¤º ByteBuf çš„å‰©ä½™å®¹é‡ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å†™å…¥çš„å­—èŠ‚èŒƒå›´ã€‚</li></ul> <p>è¿™å››ä¸ªæŒ‡é’ˆä»–ä»¬ä¹‹é—´çš„å…³ç³»ä¸º ï¼š<code>0 &lt;= readerIndex &lt;= writerIndex &lt;= capacity &lt;= maxCapacity</code>ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>  private static void checkIndexBounds(final int readerIndex, final int writerIndex, final int capacity) {
        if (readerIndex &lt; 0 || readerIndex &gt; writerIndex || writerIndex &gt; capacity) {
            throw new IndexOutOfBoundsException(String.format(
                    &quot;readerIndex: %d, writerIndex: %d (expected: 0 &lt;= readerIndex &lt;= writerIndex &lt;= capacity(%d))&quot;,
                    readerIndex, writerIndex, capacity));
        }
    }
</code></pre></div><p>å½“æˆ‘ä»¬å¯¹ ByteBuf è¿›è¡Œè¯»å–æ“ä½œçš„æ—¶å€™ï¼Œéœ€è¦é€šè¿‡ <code>isReadable</code> åˆ¤æ–­ ByteBuf æ˜¯å¦å¯è¯»ã€‚ä»¥åŠé€šè¿‡ <code>readableBytes</code> åˆ¤æ–­ ByteBuf å…·ä½“è¿˜æœ‰å¤šå°‘å­—èŠ‚å¯è¯»ã€‚å½“ readerIndex ç­‰äº writerIndex çš„æ—¶å€™ï¼ŒByteBuf å°±ä¸å¯è¯»äº†ã€‚ <code>[0 , readerIndex)</code> è¿™éƒ¨åˆ†å­—èŠ‚å°±å¯ä»¥è¢«ä¸¢å¼ƒäº†ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public boolean isReadable() {
        return writerIndex &gt; readerIndex;
    }

    @Override
    public int readableBytes() {
        return writerIndex - readerIndex;
    }
</code></pre></div><p>å½“æˆ‘ä»¬å¯¹ ByteBuf è¿›è¡Œå†™å…¥æ“ä½œçš„æ—¶å€™ï¼Œéœ€è¦é€šè¿‡ <code>isWritable</code> åˆ¤æ–­ ByteBuf æ˜¯å¦å¯å†™ã€‚ä»¥åŠé€šè¿‡ <code>writableBytes</code> åˆ¤æ–­ ByteBuf å…·ä½“è¿˜å¯ä»¥å†™å¤šå°‘å­—èŠ‚ã€‚å½“ writerIndex ç­‰äº capacity çš„æ—¶å€™ï¼ŒByteBuf å°±ä¸å¯å†™äº†ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>   @Override
    public boolean isWritable() {
        return capacity() &gt; writerIndex;
    }

    @Override
    public int writableBytes() {
        return capacity() - writerIndex;
    }
</code></pre></div><p>å½“ ByteBuf çš„å®¹é‡å·²ç»è¢«å†™æ»¡ï¼Œå˜ä¸ºä¸å¯å†™çš„æ—¶å€™ï¼Œå¦‚æœç»§ç»­å¯¹ ByteBuf è¿›è¡Œå†™å…¥ï¼Œé‚£ä¹ˆå°±éœ€è¦æ‰©å®¹äº†ï¼Œä½†æ‰©å®¹åçš„ capacity æœ€å¤§ä¸èƒ½è¶…è¿‡ maxCapacityã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    final void ensureWritable0(int minWritableBytes) {
        // minWritableBytes è¡¨ç¤ºæœ¬æ¬¡è¦å†™å…¥çš„å­—èŠ‚æ•°
        // è·å–å½“å‰ writerIndex çš„ä½ç½®
        final int writerIndex = writerIndex();
        // ä¸ºæ»¡è¶³æœ¬æ¬¡çš„å†™å…¥æ“ä½œï¼Œé¢„æœŸçš„ ByteBuf å®¹é‡å¤§å°
        final int targetCapacity = writerIndex + minWritableBytes;
        // å¦‚æœ targetCapacity åœ¨ï¼ˆcapacity , maxCapacity] ä¹‹é—´ï¼Œåˆ™è¿›è¡Œæ‰©å®¹
        if (targetCapacity &gt;= 0 &amp; targetCapacity &lt;= capacity()) {
            // targetCapacity åœ¨ [0 , capacity] ä¹‹é—´ï¼Œåˆ™æ— éœ€æ‰©å®¹ï¼Œæœ¬æ¥å°±å¯ä»¥æ»¡è¶³
            return;
        }
        // æ‰©å®¹åçš„ capacity æœ€å¤§ä¸èƒ½è¶…è¿‡ maxCapacity
        if (checkBounds &amp;&amp; (targetCapacity &lt; 0 || targetCapacity &gt; maxCapacity)) {
            throw new IndexOutOfBoundsException(String.format(
                    &quot;writerIndex(%d) + minWritableBytes(%d) exceeds maxCapacity(%d): %s&quot;,
                    writerIndex, minWritableBytes, maxCapacity, this));
        }

        ..... æ‰©å®¹ ByteBuf ......
    }
</code></pre></div><h3 id="_2-2-bytebuf-çš„è¯»å–æ“ä½œ"><a href="#_2-2-bytebuf-çš„è¯»å–æ“ä½œ" class="header-anchor">#</a> <strong>2.2 ByteBuf çš„è¯»å–æ“ä½œ</strong></h3> <p>æ˜ç™½äº† ByteBuf åŸºæœ¬ç»“æ„ä¹‹åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹é’ˆå¯¹ ByteBuf çš„è¯»å†™ç­‰åŸºæœ¬æ“ä½œæ˜¯å¦‚ä½•è¿›è¡Œçš„ã€‚Netty æ”¯æŒä»¥å¤šç§åŸºæœ¬ç±»å‹ä¸ºç²’åº¦å¯¹ ByteBuf è¿›è¡Œè¯»å†™ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æ”¯æŒ <code>Unsigned</code> åŸºæœ¬ç±»å‹çš„è½¬æ¢ä»¥åŠå¤§å°ç«¯çš„è½¬æ¢ã€‚ä¸‹é¢ç¬”è€…ä»¥ Byte å’Œ Int è¿™ä¸¤ç§åŸºæœ¬ç±»å‹ä¸ºä¾‹å¯¹ ByteBuf çš„è¯»å–æ“ä½œè¿›è¡Œè¯´æ˜ã€‚</p> <p>ByteBuf ä¸­çš„ get æ–¹æ³•åªæ˜¯å•çº¯åœ°ä» ByteBuf ä¸­è¯»å–æ•°æ®ï¼Œå¹¶ä¸æ”¹å˜å…¶ readerIndex çš„ä½ç½®ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>getByte</code> ä» ByteBuf ä¸­çš„æŒ‡å®šä½ç½® index è¯»å–ä¸€ä¸ª Byte å‡ºæ¥ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ <code>getUnsignedByte</code> ä» ByteBuf è¯»å–ä¸€ä¸ª Byte å¹¶è½¬æ¢æˆ <code>UnsignedByte</code> ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public abstract class AbstractByteBuf extends ByteBuf {
    @Override
    public byte getByte(int index) {
        // æ£€æŸ¥ index çš„è¾¹ç•Œï¼Œindex ä¸èƒ½è¶…è¿‡ capacityï¼ˆindex &lt; capacityï¼‰
        checkIndex(index);
        return _getByte(index);
    }

    @Override
    public short getUnsignedByte(int index) {
        // å°†è·å–åˆ°çš„ Byte è½¬æ¢ä¸º UnsignedByte
        return (short) (getByte(index) &amp; 0xFF);
    }   

    protected abstract byte _getByte(int index);
}
</code></pre></div><p>å…¶åº•å±‚ä¾èµ–çš„æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³• <code>_getByte</code>ï¼Œç”± AbstractByteBuf å…·ä½“çš„å­ç±»è´Ÿè´£å®ç°ã€‚æ¯”å¦‚ï¼Œåœ¨ UnpooledDirectByteBuf ç±»çš„å®ç°ä¸­ï¼Œç›´æ¥å°† _getByte æ“ä½œä»£ç†ç»™å…¶åº•å±‚ä¾èµ–çš„ JDK DirectByteBufferã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class UnpooledDirectByteBuf  {
    // åº•å±‚ä¾èµ– JDK çš„ DirectByteBuffer
    ByteBuffer buffer;

    @Override
    protected byte _getByte(int index) {
        return buffer.get(index);
    }
}
</code></pre></div><p>è€Œåœ¨ UnpooledUnsafeDirectByteBuf ç±»çš„å®ç°ä¸­ï¼Œåˆ™æ˜¯é€šè¿‡ <code>sun.misc.Unsafe</code> ç›´æ¥ä»å¯¹åº”çš„å†…å­˜åœ°å€ä¸­è¯»å–ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class UnpooledUnsafeDirectByteBuf {
    // ç›´æ¥æ“ä½œ OS çš„å†…å­˜åœ°å€
    long memoryAddress;
    @Override
    protected byte _getByte(int index) {
        // åº•å±‚ä¾èµ– PlatformDependent0ï¼Œç›´æ¥é€šè¿‡å†…å­˜åœ°å€è¯»å– byte
        return UnsafeByteBufUtil.getByte(addr(index));
    }

    final long addr(int index) {
        // è·å–åç§» index å¯¹åº”çš„å†…å­˜åœ°å€
        return memoryAddress + index;
    }
}

final class PlatformDependent0 {
  // sun.misc.Unsafe
  static final Unsafe UNSAFE;
  static byte getByte(long address) {
        return UNSAFE.getByte(address);
    }
}
</code></pre></div><p>Netty å¦å¤–è¿˜æä¾›äº†æ‰¹é‡è¯»å– Bytes çš„æ“ä½œï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>getBytes</code> æ–¹æ³•å°† ByteBuf ä¸­çš„æ•°æ®è¯»å–åˆ°ä¸€ä¸ªå­—èŠ‚æ•°ç»„ <code>byte[]</code> ä¸­ï¼Œä¹Ÿå¯ä»¥è¯»å–åˆ°å¦ä¸€ä¸ª ByteBuf ä¸­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public ByteBuf getBytes(int index, byte[] dst) {
        getBytes(index, dst, 0, dst.length);
        return this;
    }

    public abstract ByteBuf getBytes(int index, byte[] dst, int dstIndex, int length);

    @Override
    public ByteBuf getBytes(int index, ByteBuf dst, int length) {
        getBytes(index, dst, dst.writerIndex(), length);
        // è°ƒæ•´ dst çš„  writerIndex
        dst.writerIndex(dst.writerIndex() + length);
        return this;
    }
    
    // æ³¨æ„è¿™é‡Œçš„ getBytes æ–¹æ³•æ—¢ä¸ä¼šæ”¹å˜åŸæ¥ ByteBuf çš„ readerIndex å’Œ writerIndex
    // ä¹Ÿä¸ä¼šæ”¹å˜ç›®çš„ ByteBuf çš„ readerIndex å’Œ writerIndex
    public abstract ByteBuf getBytes(int index, ByteBuf dst, int dstIndex, int length);
</code></pre></div><p>é€šè¿‡ getBytes æ–¹æ³•å°†åŸæ¥ ByteBuf çš„æ•°æ®è¯»å–åˆ°ç›®çš„ ByteBuf ä¹‹åï¼ŒåŸæ¥ ByteBuf çš„ readerIndex ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œä½†æ˜¯ç›®çš„ ByteBuf çš„ writerIndex ä¼šé‡æ–°è°ƒæ•´ã€‚</p> <p>å¯¹äº UnpooledDirectByteBuf ç±»çš„å…·ä½“å®ç°æ¥è¯´è‡ªç„¶æ˜¯å°† getBytes çš„æ“ä½œç›´æ¥ä»£ç†ç»™å…¶åº•å±‚ä¾èµ–çš„ JDK DirectByteBufferã€‚å¯¹äº UnpooledUnsafeDirectByteBuf ç±»çš„å…·ä½“å®ç°æ¥è¯´ï¼Œåˆ™æ˜¯é€šè¿‡ <code>UNSAFE.copyMemory</code> ç›´æ¥æ ¹æ®å†…å­˜åœ°å€è¿›è¡Œæ‹·è´ã€‚</p> <p>è€Œ ByteBuf ä¸­çš„ read æ–¹æ³•åˆ™ä¸ä»…ä¼šä» ByteBuf ä¸­è¯»å–æ•°æ®ï¼Œè€Œä¸”ä¼šæ”¹å˜å…¶ readerIndex çš„ä½ç½®ã€‚æ¯”å¦‚ï¼Œ<code>readByte</code> æ–¹æ³•é¦–å…ˆä¼šé€šè¿‡å‰é¢ä»‹ç»çš„ <code>_getByte</code> ä» ByteBuf ä¸­è¯»å–ä¸€ä¸ªå­—èŠ‚ï¼Œç„¶åå°† readerIndex å‘åç§»åŠ¨ä¸€ä½ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>   @Override
    public byte readByte() {
        checkReadableBytes0(1);
        int i = readerIndex;
        byte b = _getByte(i);
        readerIndex = i + 1;
        return b;
    }
</code></pre></div><p>åŒæ · Netty ä¹Ÿæä¾›äº†ä» ByteBuf ä¸­æ‰¹é‡è¯»å–æ•°æ®çš„æ–¹æ³• readBytesï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸€ä¸ª ByteBuf ä¸­çš„æ•°æ®é€šè¿‡ readBytes æ–¹æ³•è¯»å–åˆ°å¦ä¸€ä¸ª ByteBuf ä¸­ã€‚ä½†æ˜¯è¿™é‡Œï¼ŒNetty å°†ä¼šæ”¹å˜åŸæ¥ ByteBuf çš„ readerIndex ä»¥åŠç›®çš„ ByteBuf çš„ writerIndexã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>   @Override
    public ByteBuf readBytes(ByteBuf dst, int length) {
        readBytes(dst, dst.writerIndex(), length);
        // æ”¹å˜ dst çš„ writerIndex
        dst.writerIndex(dst.writerIndex() + length);
        return this;
    }
</code></pre></div><p>å¦å¤–æˆ‘ä»¬è¿˜å¯ä»¥æ˜ç¡®æŒ‡å®š dstIndexï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥ä»ç›®çš„ ByteBuf ä¸­çš„æŸä¸€ä¸ªä½ç½®å¤„å¼€å§‹æ‹·è´åŸæ¥ ByteBuf ä¸­çš„æ•°æ®ï¼Œä½†è¿™é‡Œåªä¼šæ”¹å˜åŸæ¥ ByteBuf çš„ readerIndexï¼Œå¹¶ä¸ä¼šæ”¹å˜ç›®çš„ ByteBuf çš„ writerIndexã€‚è¿™ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨å†™å…¥ç›®çš„ ByteBuf  çš„æ—¶å€™å·²ç»æ˜ç¡®æŒ‡å®šäº† writerIndexï¼ˆdstIndexï¼‰ï¼Œè‡ªç„¶åœ¨å†™å…¥å®Œæˆä¹‹åï¼ŒwriterIndex çš„ä½ç½®å¹¶ä¸éœ€è¦æ”¹å˜ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public ByteBuf readBytes(ByteBuf dst, int dstIndex, int length) {
        checkReadableBytes(length);
        getBytes(readerIndex, dst, dstIndex, length);
        // æ”¹å˜åŸæ¥ ByteBuf çš„ readerIndex
        readerIndex += length;
        return this;
    }
</code></pre></div><p>é™¤æ­¤ä¹‹å¤–ï¼ŒNetty è¿˜æ”¯æŒå°† ByteBuf ä¸­çš„æ•°æ®è¯»å–åˆ°ä¸åŒçš„ç›®çš„åœ°ï¼Œæ¯”å¦‚ï¼Œè¯»å–åˆ° JDK ByteBuffer ä¸­ï¼Œè¯»å–åˆ° FileChannel ä¸­ï¼Œè¯»å–åˆ° OutputStream ä¸­ï¼Œä»¥åŠè¯»å–åˆ° GatheringByteChannel ä¸­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public abstract ByteBuf readBytes(ByteBuffer dst);
public abstract ByteBuf readBytes(OutputStream out, int length) throws IOException;
public abstract int readBytes(GatheringByteChannel out, int length) throws IOException;
public abstract int readBytes(FileChannel out, long position, int length) throws IOException;
</code></pre></div><p>Netty é™¤äº†æ”¯æŒä»¥  Byte ä¸ºç²’åº¦å¯¹ ByteBuf è¿›è¡Œè¯»å†™ä¹‹å¤–ï¼Œè¿˜åŒæ—¶æ”¯æŒä»¥å¤šç§åŸºæœ¬ç±»å‹å¯¹ ByteBuf è¿›è¡Œè¯»å†™ï¼Œè¿™é‡Œç¬”è€…ä»¥ Int ç±»å‹ä¸ºä¾‹è¿›è¡Œè¯´æ˜ã€‚</p> <p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>readInt()</code> ä» ByteBuf ä¸­è¯»å–ä¸€ä¸ª Int ç±»å‹çš„æ•°æ®å‡ºæ¥ï¼Œéšå ByteBuf çš„ readerIndex å‘åç§»åŠ¨ 4 ä¸ªä½ç½®ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>   @Override
    public int readInt() {
        checkReadableBytes0(4);
        int v = _getInt(readerIndex);
        readerIndex += 4;
        return v;
    }

    protected abstract int _getInt(int index);
</code></pre></div><p>åŒç†ï¼ŒçœŸæ­£è´Ÿè´£è¯»å–æ•°æ®çš„æ–¹æ³• _getInt æ–¹æ³•éœ€è¦ç”± AbstractByteBuf å…·ä½“çš„å­ç±»å®ç°ï¼Œä½†è¿™é‡Œå’Œ _getByte ä¸åŒçš„æ˜¯ï¼Œ_getInt éœ€è¦è€ƒè™‘å­—èŠ‚åºçš„é—®é¢˜ï¼Œ<strong>ç”±äºç½‘ç»œåè®®é‡‡ç”¨çš„æ˜¯å¤§ç«¯å­—èŠ‚åºä¼ è¾“ï¼Œæ‰€ä»¥ Netty çš„ ByteBuf é»˜è®¤ä¹Ÿæ˜¯å¤§ç«¯å­—èŠ‚åº</strong>ã€‚</p> <p>åœ¨ UnpooledDirectByteBuf çš„å®ç°ä¸­ï¼ŒåŒæ ·ä¹Ÿæ˜¯å°† getInt çš„æ“ä½œç›´æ¥ä»£ç†ç»™å…¶åº•å±‚ä¾èµ–çš„ JDK DirectByteBufferã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class UnpooledDirectByteBuf  {
    @Override
    protected int _getInt(int index) {
        // ä»£ç†ç»™å…¶åº•å±‚ä¾èµ–çš„ JDK DirectByteBuffer
        return buffer.getInt(index);
    }
}
</code></pre></div><p>åœ¨ UnpooledUnsafeDirectByteBuf çš„å®ç°ä¸­ï¼Œç”±äºæ˜¯é€šè¿‡ <code>sun.misc.Unsafe</code> ç›´æ¥å¯¹å†…å­˜åœ°å€è¿›è¡Œæ“ä½œï¼Œæ‰€ä»¥éœ€è¦è€ƒè™‘å­—èŠ‚åºè½¬æ¢çš„ç»†èŠ‚ã€‚Netty çš„ ByteBuf é»˜è®¤æ˜¯å¤§ç«¯å­—èŠ‚åºï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥ä¾æ¬¡å°†ä½åœ°å€çš„å­—èŠ‚æ”¾åˆ° Int æ•°æ®çš„é«˜ä½å°±å¯ä»¥äº†ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class UnpooledUnsafeDirectByteBuf {
    @Override
    protected int _getInt(int index) {
        return UnsafeByteBufUtil.getInt(addr(index));
    }
}

final class UnsafeByteBufUtil {
    static int getInt(long address) {    
        return PlatformDependent.getByte(address) &lt;&lt; 24 |
               (PlatformDependent.getByte(address + 1) &amp; 0xff) &lt;&lt; 16 |
               (PlatformDependent.getByte(address + 2) &amp; 0xff) &lt;&lt;  8 |
               PlatformDependent.getByte(address + 3)  &amp; 0xff;
    }
}
</code></pre></div><p>åŒæ—¶ Netty ä¹Ÿæ”¯æŒä»¥å°ç«¯å­—èŠ‚åºæ¥ä» ByteBuf ä¸­è¯»å– Int æ•°æ®ï¼Œè¿™é‡Œå°±æ¶‰åŠåˆ°å­—èŠ‚åºçš„è½¬æ¢äº†ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public int readIntLE() {
        checkReadableBytes0(4);
        int v = _getIntLE(readerIndex);
        readerIndex += 4;
        return v;
    }

 protected abstract int _getIntLE(int index);
</code></pre></div><p>åœ¨ UnpooledDirectByteBuf çš„å®ç°ä¸­ï¼Œé¦–å…ˆé€šè¿‡å…¶ä¾èµ–çš„ JDK DirectByteBuffer   ä»¥å¤§ç«¯åºè¯»å–ä¸€ä¸ª Int æ•°æ®ï¼Œç„¶åé€šè¿‡ <code>ByteBufUtil.swapInt</code> åˆ‡æ¢æˆå°ç«¯åºè¿”å›ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class UnpooledDirectByteBuf  {
    @Override
    protected int _getIntLE(int index) {
        // åˆ‡æ¢å­—èŠ‚åºï¼Œä»å¤§ç«¯å˜å°ç«¯
        return ByteBufUtil.swapInt(buffer.getInt(index));
    }
}
</code></pre></div><p>åœ¨ UnpooledUnsafeDirectByteBuf çš„å®ç°ä¸­ï¼Œåˆ™æ˜¯ç›´æ¥å°†ä½åœ°å€ä¸Šçš„å­—èŠ‚ä¾æ¬¡æ”¾åˆ° Int æ•°æ®çš„ä½ä½ä¸Šå°±å¯ä»¥äº†ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class UnpooledUnsafeDirectByteBuf {
    @Override
    protected int _getIntLE(int index) {
        return UnsafeByteBufUtil.getIntLE(addr(index));
    }
}

final class UnsafeByteBufUtil {
    static int getIntLE(long address) {
        return PlatformDependent.getByte(address) &amp; 0xff |
               (PlatformDependent.getByte(address + 1) &amp; 0xff) &lt;&lt;  8 |
               (PlatformDependent.getByte(address + 2) &amp; 0xff) &lt;&lt; 16 |
               PlatformDependent.getByte(address + 3) &lt;&lt; 24;
    }
}
</code></pre></div><p>å¦å¤– Netty ä¹Ÿæ”¯æŒä» ByteBuf ä¸­è¯»å–åŸºæœ¬ç±»å‹çš„ <code>Unsigned ç±»å‹</code>ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public long readUnsignedInt() {
        return readInt() &amp; 0xFFFFFFFFL;
    }

    @Override
    public long readUnsignedIntLE() {
        return readIntLE() &amp; 0xFFFFFFFFL;
    }
</code></pre></div><p>å…¶ä»–åŸºæœ¬ç±»å‹çš„ç›¸å…³è¯»å–æ“ä½œå®ç°çš„é€»è¾‘éƒ½æ˜¯å¤§åŒå°å¼‚ï¼Œç¬”è€…å°±ä¸ä¸€ä¸€åˆ—ä¸¾äº†ã€‚</p> <h3 id="_2-3-discardreadbytes"><a href="#_2-3-discardreadbytes" class="header-anchor">#</a> <strong>2.3 discardReadBytes</strong></h3> <p>éšç€ readBytes æ–¹æ³•çš„ä¸æ–­è°ƒç”¨ï¼Œ ByteBuf ä¸­çš„ readerIndex ä¹Ÿä¼šä¸æ–­çš„å‘åç§»åŠ¨ï¼ŒNetty å¯¹ readerIndex çš„è®¾è®¡æœ‰ä¸¤å±‚è¯­ä¹‰ï¼š</p> <ol><li>ç¬¬ä¸€å±‚çš„è¯­ä¹‰æ¯”è¾ƒæ˜æ˜¾ï¼Œå°±æ˜¯ç”¨æ¥è¡¨ç¤ºå½“å‰ ByteBuf çš„è¯»å–ä½ç½®ï¼Œå½“æˆ‘ä»¬è°ƒç”¨ readBytes æ–¹æ³•çš„æ—¶å€™å°±æ˜¯ä» readerIndex å¼€å§‹è¯»å–æ•°æ®ï¼Œå½“ readerIndex ç­‰äº writerIndex çš„æ—¶å€™ï¼ŒByteBuf å°±ä¸å¯è¯»å–äº†ã€‚</li> <li>ç¬¬äºŒå±‚è¯­ä¹‰æ¯”è¾ƒå«è“„ï¼Œå®ƒæ˜¯ç”¨æ¥è¡¨ç¤ºå½“å‰ ByteBuf å¯ä»¥è¢«ä¸¢å¼ƒçš„å­—èŠ‚æ•°ï¼Œå› ä¸º readerIndex ç”¨æ¥æŒ‡ç¤ºå½“å‰çš„è¯»å–ä½ç½®ï¼Œé‚£ä¹ˆä½äº readerIndex ä¹‹å‰çš„å­—èŠ‚è‚¯å®šæ˜¯å·²ç»è¢«è¯»å–å®Œæ¯•äº†ï¼Œå·²ç»è¢«è¯»å–çš„å­—èŠ‚ç»§ç»­é©»ç•™åœ¨ ByteBuf ä¸­å°±æ²¡æœ‰å¿…è¦äº†ï¼Œè¿˜ä¸å¦‚æŠŠç©ºé—´è…¾å‡ºæ¥ï¼Œè¿˜èƒ½åœ¨å¤šå†™å…¥äº›æ•°æ®ã€‚</li></ol> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191121413.webp" alt="å›¾ç‰‡">image.png</p> <p>æ‰€ä»¥ä¸€ä¸ª ByteBuf çœŸæ­£çš„å‰©ä½™å¯å†™å®¹é‡çš„è®¡ç®—æ–¹å¼é™¤äº†ä¸Šå°èŠ‚ä¸­ä»‹ç»çš„ <code>writableBytes()</code> æ–¹æ³•è¿”å›çš„å­—èŠ‚æ•°ä¹‹å¤–è¿˜éœ€è¦åœ¨åŠ ä¸Š readerIndexã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public int writableBytes() {
        return capacity() - writerIndex;
    }
</code></pre></div><p>ä¸¾ä¸ªå…·ä½“ç‚¹çš„ä¾‹å­å°±æ˜¯ï¼Œå½“æˆ‘ä»¬å‡†å¤‡å‘ä¸€ä¸ª ByteBuf å†™å…¥ n ä¸ªå­—èŠ‚æ—¶ï¼Œå¦‚æœ <code>writableBytes()</code> å°äº nï¼Œé‚£ä¹ˆå°±è¡¨ç¤ºå½“å‰ ByteBuf çš„å‰©ä½™å®¹é‡ä¸èƒ½æ»¡è¶³æœ¬æ¬¡å†™å…¥çš„å­—èŠ‚æ•°ã€‚</p> <p>ä½†æ˜¯ <code>readerIndex + writableBytes()</code>å¤§äºç­‰äº n ï¼Œ åˆ™è¡¨ç¤ºå¦‚æœæˆ‘ä»¬å°† ByteBuf ä¸­å·²ç»è¯»å–çš„å­—èŠ‚æ•°ä¸¢å¼ƒçš„è¯ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ»¡è¶³æœ¬æ¬¡å†™å…¥çš„è¯·æ±‚ã€‚</p> <p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ <code>discardReadBytes()</code> æ–¹æ³•å°† readerIndex ä¹‹å‰çš„å­—èŠ‚ä¸¢å¼ƒæ‰ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå¯å†™çš„å­—èŠ‚å®¹å°±å¯ä»¥æ»¡è¶³æœ¬æ¬¡å†™å…¥è¦æ±‚äº†ï¼Œé‚£ä¹ˆå¦‚æœä¸¢å¼ƒå‘¢ ï¼Ÿ</p> <p>æˆ‘ä»¬å…ˆæ¥çœ‹ <code>readerIndex &lt; writerIndex</code> çš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µä¸‹è¡¨ç¤º ByteBuf ä¸­è¿˜æœ‰æœªè¯»å–çš„å­—èŠ‚ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>ByteBuf ç›®å‰å¯è¯»å–çš„å­—èŠ‚èŒƒå›´ä¸ºï¼š<code>[readerIndex, writerIndex)</code>ï¼Œä½äº readerIndex ä¹‹å‰çš„å­—èŠ‚å‡å¯ä»¥è¢«ä¸¢å¼ƒï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±éœ€è¦å°† <code>[readerIndex, writerIndex)</code> è¿™æ®µèŒƒå›´çš„å­—èŠ‚å…¨éƒ¨æ‹·è´åˆ° ByteBuf æœ€å‰é¢ï¼Œç›´æ¥è¦†ç›– readerIndex ä¹‹å‰çš„å­—èŠ‚ã€‚</p> <p>ç„¶åè°ƒæ•´ readerIndex å’Œ writerIndex çš„ä½ç½®ï¼Œå› ä¸º readerIndex ä¹‹å‰çš„å­—èŠ‚ç°åœ¨å·²ç»å…¨éƒ¨è¢«å¯è¯»å­—èŠ‚è¦†ç›–äº†ï¼Œæ‰€ä»¥ readerIndex é‡æ–°è°ƒæ•´ä¸º 0 ï¼ŒwriterIndex å‘å‰ç§»åŠ¨ readerIndex å¤§å°ã€‚è¿™æ ·ä¸€æ¥ï¼Œå½“å‰ ByteBuf çš„å¯å†™å®¹é‡å°±å¤šå‡ºäº† readerIndex å¤§å°ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>å¦å¤–ä¸€ç§æƒ…å†µæ˜¯ <code>readerIndex = writerIndex</code> çš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µä¸‹è¡¨ç¤º ByteBuf ä¸­å·²ç»æ²¡æœ‰å¯è¯»å­—èŠ‚äº†ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>æ—¢ç„¶ ByteBuf ä¸­å·²ç»æ²¡æœ‰ä»»ä½•å¯è¯»å­—èŠ‚äº†ï¼Œè‡ªç„¶ä¹Ÿå°±ä¸éœ€è¦å°†å¯è¯»å­—èŠ‚æ‹·è´åˆ° ByteBuf çš„å¼€å¤´äº†ï¼Œç›´æ¥å°† readerIndex å’Œ writerIndex é‡æ–°è°ƒæ•´ä¸º 0 å³å¯ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <div class="language- extra-class"><pre class="language-text"><code>public abstract class AbstractByteBuf extends ByteBuf {
    @Override
    public ByteBuf discardReadBytes() {
        // readerIndex ä¸º 0 è¡¨ç¤ºæ²¡æœ‰å¯ä»¥ä¸¢å¼ƒçš„å­—èŠ‚
        if (readerIndex == 0) {
            return this;
        }

        if (readerIndex != writerIndex) {
            // å°† [readerIndex, writerIndex) è¿™æ®µå­—èŠ‚èŒƒå›´ç§»åŠ¨åˆ° ByteBuf çš„å¼€å¤´
            // ä¹Ÿå°±æ˜¯ä¸¢å¼ƒ readerIndex ä¹‹å‰çš„å­—èŠ‚
            setBytes(0, this, readerIndex, writerIndex - readerIndex);
            // writerIndex å’Œ readerIndex éƒ½å‘å‰ç§»åŠ¨ readerIndex å¤§å°
            writerIndex -= readerIndex;
            // é‡æ–°è°ƒæ•´ markedReaderIndex å’Œ markedWriterIndex çš„ä½ç½®
            // éƒ½å¯¹åº”å‘å‰ç§»åŠ¨ readerIndex å¤§å°ã€‚
            adjustMarkers(readerIndex);
            readerIndex = 0;
        } else {
            // readerIndex = writerIndex è¡¨ç¤ºå½“å‰ ByteBuf å·²ç»ä¸å¯è¯»äº†
            // å°† readerIndex ä¹‹å‰çš„å­—èŠ‚å…¨éƒ¨ä¸¢å¼ƒï¼ŒByteBuf æ¢å¤åˆ°æœ€åˆçš„çŠ¶æ€
            // æ•´ä¸ª ByteBuf çš„å®¹é‡éƒ½å¯ä»¥è¢«å†™å…¥
            ensureAccessible();
            adjustMarkers(readerIndex);
            writerIndex = readerIndex = 0;
        }
        return this;
    }
}
</code></pre></div><p>å¦‚æœ ByteBuf å­˜åœ¨å¯ä»¥è¢«ä¸¢å¼ƒçš„å­—èŠ‚çš„æ—¶å€™ï¼ˆreaderIndex &gt; 0ï¼‰ï¼Œåªè¦æˆ‘ä»¬è°ƒç”¨ <code>discardReadBytes()</code> å°±ä¼šæ— æ¡ä»¶ä¸¢å¼ƒ readerIndex ä¹‹å‰çš„å­—èŠ‚ã€‚</p> <p>Netty è¿˜å¦å¤–æä¾›äº† <code>discardSomeReadBytes()</code> æ–¹æ³•è¿›è¡Œæœ‰æ¡ä»¶ä¸¢å¼ƒå­—èŠ‚ï¼Œä¸¢å¼ƒæ¡ä»¶æœ‰å¦‚ä¸‹ä¸¤ç§ï¼š</p> <ol><li>å½“ ByteBuf å·²ç»ä¸å¯è¯»çš„æ—¶å€™ï¼Œåˆ™æ— æ¡ä»¶ä¸¢å¼ƒå·²è¯»å­—èŠ‚ã€‚</li> <li>å½“å·²è¯»çš„å­—èŠ‚æ•°è¶…è¿‡æ•´ä¸ª ByteBuf ä¸€åŠå®¹é‡æ—¶æ‰ä¼šä¸¢å¼ƒå·²è¯»å­—èŠ‚ã€‚å¦åˆ™æ— æ¡ä»¶ä¸¢å¼ƒçš„è¯ï¼Œæ”¶ç›Šå°±ä¸é«˜äº†ã€‚</li></ol> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public ByteBuf discardSomeReadBytes() {
        if (readerIndex &gt; 0) {
            // å½“ ByteBuf å·²ç»ä¸å¯è¯»äº†ï¼Œåˆ™æ— æ¡ä»¶ä¸¢å¼ƒå·²è¯»å­—èŠ‚
            if (readerIndex == writerIndex) {
                adjustMarkers(readerIndex);
                writerIndex = readerIndex = 0;
                return this;
            }
            // å½“å·²è¯»çš„å­—èŠ‚æ•°è¶…è¿‡æ•´ä¸ª ByteBuf çš„ä¸€åŠå®¹é‡æ—¶æ‰ä¼šä¸¢å¼ƒå·²è¯»å­—èŠ‚
            if (readerIndex &gt;= capacity() &gt;&gt;&gt; 1) {
                setBytes(0, this, readerIndex, writerIndex - readerIndex);
                writerIndex -= readerIndex;
                adjustMarkers(readerIndex);
                readerIndex = 0;
                return this;
            }
        }
        return this;
    }
</code></pre></div><p>Netty è®¾è®¡çš„è¿™ä¸ªä¸¢å¼ƒå­—èŠ‚çš„æ–¹æ³•åœ¨è§£ç çš„åœºæ™¯éå¸¸æœ‰ç”¨ï¼Œç”±äº TCP æ˜¯ä¸€ä¸ªé¢å‘æµçš„ç½‘ç»œåè®®ï¼Œå®ƒåªä¼šæ ¹æ®æ»‘åŠ¨çª—å£çš„å¤§å°è¿›è¡Œå­—èŠ‚æµçš„å‘é€ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨åº”ç”¨å±‚æ¥æ”¶åˆ°çš„æ•°æ®å¯èƒ½æ˜¯ä¸€ä¸ªåŠåŒ…ä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªç²˜åŒ…ï¼Œåæ­£ä¸ä¼šæ˜¯ä¸€ä¸ªå®Œæ•´çš„æ•°æ®åŒ…ã€‚</p> <p>è¿™å°±è¦æ±‚æˆ‘ä»¬åœ¨è§£ç çš„æ—¶å€™ï¼Œé¦–å…ˆè¦åˆ¤æ–­ ByteBuf ä¸­çš„æ•°æ®æ˜¯å¦æ„æˆä¸€ä¸ªå®Œæˆçš„æ•°æ®åŒ…ï¼Œå¦‚æœæ„æˆä¸€ä¸ªæ•°æ®åŒ…ï¼Œæ‰ä¼šå»è¯»å– ByteBuf ä¸­çš„å­—èŠ‚ï¼Œç„¶åè§£ç ï¼Œéšå readerIndex å‘åç§»åŠ¨ã€‚</p> <p>å¦‚æœä¸å¤Ÿä¸€ä¸ªæ•°æ®åŒ…ï¼Œé‚£å°±éœ€è¦å°† ByteBuf ç´¯ç§¯ç¼“å­˜èµ·æ¥ï¼Œä¸€ç›´ç­‰åˆ°ä¸€ä¸ªå®Œæ•´çš„æ•°æ®åŒ…åˆ°æ¥ã€‚ä¸€ç§æç«¯çš„æƒ…å†µæ˜¯ï¼Œå³ä½¿æˆ‘ä»¬å·²ç»è§£ç å¾ˆå¤šæ¬¡äº†ï¼Œä½†æ˜¯ç¼“å­˜çš„ ByteBuf ä¸­ä»ç„¶è¿˜æœ‰åŠåŒ…ï¼Œç”±äºä¸æ–­çš„ä¼šæœ‰ç²˜åŒ…è¿‡æ¥ï¼Œè¿™å°±å¯¼è‡´ ByteBuf ä¼šè¶Šæ¥è¶Šå¤§ã€‚ç”±äºå·²ç»è§£ç äº†å¾ˆå¤šæ¬¡ï¼Œæ‰€ä»¥ ByteBuf ä¸­å¯ä»¥è¢«ä¸¢å¼ƒçš„å­—èŠ‚å æ®äº†å¾ˆå¤§çš„å†…å­˜ç©ºé—´ï¼Œå¦‚æœåŠåŒ…æƒ…å†µæŒç»­å­˜åœ¨ï¼Œå°†ä¼šå¯¼è‡´ OutOfMemoryã€‚</p> <p>æ‰€ä»¥ Netty è§„å®šï¼Œå¦‚æœå·²ç»è§£ç äº† 16 æ¬¡ä¹‹åï¼ŒByteBuf ä¸­ä»ç„¶æœ‰åŠåŒ…çš„æƒ…å†µï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨è¿™é‡Œçš„ <code>discardSomeReadBytes()</code> å°†å·²ç»è§£ç è¿‡çš„å­—èŠ‚å…¨éƒ¨ä¸¢å¼ƒï¼ŒèŠ‚çœä¸å¿…è¦çš„å†…å­˜å¼€é”€ã€‚</p> <h3 id="_2-4-bytebuf-çš„å†™å…¥æ“ä½œ"><a href="#_2-4-bytebuf-çš„å†™å…¥æ“ä½œ" class="header-anchor">#</a> <strong>2.4 ByteBuf çš„å†™å…¥æ“ä½œ</strong></h3> <p>ByteBuf çš„å†™å…¥æ“ä½œä¸è¯»å–æ“ä½œäº’ä¸ºç›¸åçš„æ“ä½œï¼Œæ¯ä¸€ä¸ªè¯»å–æ–¹æ³• getBytes , readBytes , readInt ç­‰éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ setBytes , writeBytes , writeInt ç­‰åŸºç¡€ç±»å‹çš„å†™å…¥æ“ä½œã€‚</p> <p>å’Œ get æ–¹æ³•ä¸€æ ·ï¼Œset ç›¸å…³çš„æ–¹æ³•ä¹Ÿåªæ˜¯å•çº¯çš„å‘ ByteBuf ä¸­å†™å…¥æ•°æ®ï¼Œå¹¶ä¸ä¼šæ”¹å˜å…¶ writerIndex çš„ä½ç½®ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>setByte</code> å‘ ByteBuf ä¸­çš„æŸä¸€ä¸ªæŒ‡å®šä½ç½® index å†™å…¥æ•°æ® valueã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public ByteBuf setByte(int index, int value) {
        checkIndex(index);
        _setByte(index, value);
        return this;
    }

    protected abstract void _setByte(int index, int value);
</code></pre></div><p>æ‰§è¡Œå…·ä½“çš„å†™å…¥æ“ä½œåŒæ ·ä¹Ÿæ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå…¶å…·ä½“çš„å®ç°ç”± AbstractByteBuf å…·ä½“çš„å­ç±»è´Ÿè´£ã€‚å¯¹äº UnpooledDirectByteBuf çš„å®ç°æ¥è¯´ï¼Œ_setByte æ“ä½œç›´æ¥ä¼šä»£ç†ç»™å…¶åº•å±‚ä¾èµ–çš„ JDK  DirectByteBufferã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class UnpooledDirectByteBuf  {
    // åº•å±‚ä¾èµ– JDK çš„ DirectByteBuffer
    ByteBuffer buffer;

    @Override
    protected void _setByte(int index, int value) {
        buffer.put(index, (byte) value);
    }
}
</code></pre></div><p>å¯¹äº UnpooledUnsafeDirectByteBuf çš„å®ç°æ¥è¯´ï¼Œåˆ™æ˜¯ç›´æ¥é€šè¿‡ <code>sun.misc.Unsafe</code> å‘å¯¹åº”çš„å†…å­˜åœ°å€ï¼ˆmemoryAddress + indexï¼‰å†™å…¥ Byteã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class UnpooledUnsafeDirectByteBuf {
    // ç›´æ¥æ“ä½œ OS çš„å†…å­˜åœ°å€ï¼Œä¸ä¾èµ– JDK çš„ buffer
    long memoryAddress;

   @Override
    protected void _setByte(int index, int value) {
        // åº•å±‚ä¾èµ– PlatformDependent0ï¼Œç›´æ¥å‘å†…å­˜åœ°å€å†™å…¥ byte
        UnsafeByteBufUtil.setByte(addr(index), value);
    }

    final long addr(int index) {
        // è·å–åç§» index å¯¹åº”çš„å†…å­˜åœ°å€
        return memoryAddress + index;
    }
}

final class PlatformDependent0 {
  // sun.misc.Unsafe
  static final Unsafe UNSAFE;
  static void putByte(long address, byte value) {
        UNSAFE.putByte(address, value);
  }
}
</code></pre></div><p>Netty å¦å¤–ä¹Ÿæä¾›äº†å‘ ByteBuf æ‰¹é‡å†™å…¥ Bytes çš„æ“ä½œï¼ŒsetBytes æ–¹æ³•ç”¨äºå‘ ByteBuf çš„æŒ‡å®šä½ç½® index æ‰¹é‡å†™å…¥ä¸€ä¸ªå­—èŠ‚æ•°ç»„ byte[] ä¸­çš„æ•°æ®ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>   @Override
    public ByteBuf setBytes(int index, byte[] src) {
        setBytes(index, src, 0, src.length);
        return this;
    }

    public abstract ByteBuf setBytes(int index, byte[] src, int srcIndex, int length);
</code></pre></div><p>å¯¹äº UnpooledDirectByteBuf çš„å®ç°æ¥è¯´ï¼ŒåŒæ ·ä¹Ÿæ˜¯å°† setBytes çš„æ“ä½œç›´æ¥ä»£ç†ç»™ JDK DirectByteBufferï¼Œå°†å­—èŠ‚æ•°ç»„ byte[] ä¸­çš„å­—èŠ‚ç›´æ¥å†™å…¥ DirectByteBuffer ä¸­ã€‚</p> <p>å¯¹äº UnpooledUnsafeDirectByteBuf  çš„å®ç°æ¥è¯´ï¼Œåˆ™æ˜¯ç›´æ¥æ“ä½œå­—èŠ‚æ•°ç»„å’Œ ByteBuf çš„å†…å­˜åœ°å€ï¼Œé€šè¿‡ <code>UNSAFE.copyMemory</code> å°†å­—èŠ‚æ•°ç»„å¯¹åº”å†…å­˜åœ°å€ä¸­çš„æ•°æ®æ‹·è´åˆ° ByteBuf ç›¸åº”çš„å†…å­˜åœ°å€ä¸Šã€‚</p> <p>æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ setBytes æ–¹æ³•å°†å…¶ä»– ByteBuf ä¸­çš„å­—èŠ‚æ•°æ®å†™å…¥åˆ° ByteBuf ä¸­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public ByteBuf setBytes(int index, ByteBuf src, int length) {
        setBytes(index, src, src.readerIndex(), length);
        // è°ƒæ•´ src çš„  readerIndex
        src.readerIndex(src.readerIndex() + length);
        return this;
    }

    // æ³¨æ„è¿™é‡Œçš„ setBytes æ–¹æ³•æ—¢ä¸ä¼šæ”¹å˜åŸæ¥ ByteBuf çš„ readerIndex å’Œ writerIndex
    // ä¹Ÿä¸ä¼šæ”¹å˜ç›®çš„ ByteBuf çš„ readerIndex å’Œ writerIndex
    public abstract ByteBuf setBytes(int index, ByteBuf src, int srcIndex, int length);
</code></pre></div><p><strong>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯è¢«å†™å…¥ ByteBuf çš„ writerIndex å¹¶ä¸ä¼šæ”¹å˜ï¼Œä½†æ˜¯åŸæ¥ ByteBuf çš„ readerIndex ä¼šé‡æ–°è°ƒæ•´</strong>ã€‚</p> <p>ByteBuf ä¸­çš„ write æ–¹æ³•åº•å±‚ä¾èµ–çš„æ˜¯ç›¸å…³çš„ set æ–¹æ³•ï¼Œä¸åŒçš„æ˜¯ write æ–¹æ³•ä¼šæ”¹å˜ ByteBuf ä¸­ writerIndex çš„ä½ç½®ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬é€šè¿‡ <code>writeByte</code> æ–¹æ³•å‘ ByteBuf ä¸­å†™å…¥ä¸€ä¸ªå­—èŠ‚ä¹‹åï¼ŒwriterIndex å°±ä¼šå‘åç§»åŠ¨ä¸€ä½ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public ByteBuf writeByte(int value) {
        ensureWritable0(1);
        _setByte(writerIndex++, value);
        return this;
    }
</code></pre></div><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ writeBytes å‘ ByteBuf ä¸­æ‰¹é‡å†™å…¥æ•°æ®ï¼Œå°†ä¸€ä¸ªå­—èŠ‚æ•°ç»„ä¸­çš„æ•°æ®æˆ–è€…å¦ä¸€ä¸ª ByteBuf ä¸­çš„æ•°æ®å†™å…¥åˆ° ByteBuf ä¸­ï¼Œä½†æ˜¯è¿™é‡Œï¼ŒNetty å°†ä¼šæ”¹å˜è¢«å†™å…¥ ByteBuf çš„ writerIndex ä»¥åŠæ•°æ®æ¥æº ByteBuf  çš„ readerIndexã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public ByteBuf writeBytes(ByteBuf src, int length) {
        writeBytes(src, src.readerIndex(), length);
        // è°ƒæ•´æ•°æ®æ¥æº ByteBuf çš„ readerIndex
        src.readerIndex(src.readerIndex() + length);
        return this;
    }
</code></pre></div><p>å¦‚æœæˆ‘ä»¬æ˜ç¡®æŒ‡å®šäº†ä»æ•°æ®æ¥æº ByteBuf ä¸­çš„å“ªä¸€ä¸ªä½ç½®ï¼ˆsrcIndexï¼‰å¼€å§‹è¯»å–æ•°æ®ï¼Œé‚£ä¹ˆæ•°æ®æ¥æº ByteBuf ä¸­çš„ readerIndex å°†ä¸ä¼šè¢«æ”¹å˜ï¼Œåªä¼šæ”¹å˜è¢«å†™å…¥ ByteBuf çš„ writerIndexã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public ByteBuf writeBytes(ByteBuf src, int srcIndex, int length) {
        ensureWritable(length);
        setBytes(writerIndex, src, srcIndex, length);
        // è°ƒæ•´è¢«å†™å…¥ ByteBuf çš„ writerIndex
        writerIndex += length;
        return this;
    }
</code></pre></div><p>é™¤æ­¤ä¹‹å¤–ï¼ŒNetty è¿˜æ”¯æŒä»ä¸åŒçš„æ•°æ®æ¥æºå‘ ByteBuf æ‰¹é‡å†™å…¥æ•°æ®ï¼Œæ¯”å¦‚ï¼Œä» JDK ByteBuffer ï¼Œä» FileChannel ï¼Œä» InputStream ï¼Œä»¥åŠä» ScatteringByteChannel ä¸­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public ByteBuf writeBytes(ByteBuffer src) 
public int writeBytes(InputStream in, int length)
public int writeBytes(ScatteringByteChannel in, int length) throws IOException
public int writeBytes(FileChannel in, long position, int length) throws IOException
</code></pre></div><p>Netty é™¤äº†æ”¯æŒä»¥ Byte ä¸ºç²’åº¦å‘ ByteBuf ä¸­å†™å…¥æ•°æ®ä¹‹å¤–ï¼Œè¿˜åŒæ—¶æ”¯æŒä»¥å¤šç§åŸºæœ¬ç±»å‹ä¸ºç²’åº¦å‘å†™å…¥ ByteBuf ï¼Œè¿™é‡Œç¬”è€…ä»¥ Int ç±»å‹ä¸ºä¾‹è¿›è¡Œè¯´æ˜ã€‚</p> <p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ writeInt() å‘ ByteBuf å†™å…¥ä¸€ä¸ª Int ç±»å‹çš„æ•°æ®ï¼Œéšå ByteBuf çš„ writerIndex å‘åç§»åŠ¨ 4 ä¸ªä½ç½®ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public ByteBuf writeInt(int value) {
        ensureWritable0(4);
        _setInt(writerIndex, value);
        writerIndex += 4;
        return this;
    }

   protected abstract void _setInt(int index, int value);
</code></pre></div><p>å’Œå†™å…¥ Byte æ•°æ®ä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œéœ€è¦è€ƒè™‘å­—èŠ‚åºï¼ŒNetty  ByteBuf é»˜è®¤æ˜¯å¤§ç«¯å­—èŠ‚åºï¼Œå’Œç½‘ç»œåè®®ä¼ è¾“ä½¿ç”¨çš„å­—èŠ‚åºä¿æŒä¸€è‡´ã€‚è¿™é‡Œæˆ‘ä»¬éœ€è¦å°†å¾…å†™å…¥æ•°æ® value çš„é«˜ä½ä¾æ¬¡æ”¾å…¥åˆ° ByteBuf çš„ä½åœ°å€ä¸Šã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class UnpooledUnsafeDirectByteBuf {
   @Override
    protected void _setInt(int index, int value) {
        // ä»¥å¤§ç«¯å­—èŠ‚åºå†™å…¥ ByteBuf 
        UnsafeByteBufUtil.setInt(addr(index), value);
    }
}

final class UnsafeByteBufUtil {
   static void setInt(long address, int value) {
            PlatformDependent.putByte(address, (byte) (value &gt;&gt;&gt; 24));
            PlatformDependent.putByte(address + 1, (byte) (value &gt;&gt;&gt; 16));
            PlatformDependent.putByte(address + 2, (byte) (value &gt;&gt;&gt; 8));
            PlatformDependent.putByte(address + 3, (byte) value);   
    }
}
</code></pre></div><p>åŒæ—¶ Netty ä¹Ÿæ”¯æŒä»¥å°ç«¯å­—èŠ‚åºå‘ ByteBuf å†™å…¥æ•°æ®ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public ByteBuf writeIntLE(int value) {
        ensureWritable0(4);
        _setIntLE(writerIndex, value);
        writerIndex += 4;
        return this;
    }

   protected abstract void _setIntLE(int index, int value);
</code></pre></div><p>è¿™é‡Œéœ€è¦å°†å¾…å†™å…¥æ•°æ® value çš„ä½ä½ä¾æ¬¡æ”¾åˆ° ByteBuf çš„ä½åœ°å€ä¸Šã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class UnpooledUnsafeDirectByteBuf {
    @Override
    protected void _setIntLE(int index, int value) {
        // // ä»¥å°ç«¯å­—èŠ‚åºå†™å…¥ ByteBuf 
        UnsafeByteBufUtil.setIntLE(addr(index), value);
    }
}

final class UnsafeByteBufUtil {
   static void setIntLE(long address, int value) {
            PlatformDependent.putByte(address, (byte) value);
            PlatformDependent.putByte(address + 1, (byte) (value &gt;&gt;&gt; 8));
            PlatformDependent.putByte(address + 2, (byte) (value &gt;&gt;&gt; 16));
            PlatformDependent.putByte(address + 3, (byte) (value &gt;&gt;&gt; 24));
    }
}
</code></pre></div><h3 id="_2-5-bytebuf-çš„æ‰©å®¹æœºåˆ¶"><a href="#_2-5-bytebuf-çš„æ‰©å®¹æœºåˆ¶" class="header-anchor">#</a> <strong>2.5 ByteBuf çš„æ‰©å®¹æœºåˆ¶</strong></h3> <p>åœ¨æ¯æ¬¡å‘ ByteBuf å†™å…¥æ•°æ®çš„æ—¶å€™ï¼ŒNetty éƒ½ä¼šè°ƒç”¨ <code>ensureWritable0</code> æ–¹æ³•æ¥åˆ¤æ–­å½“å‰ ByteBuf å‰©ä½™å¯å†™å®¹é‡ï¼ˆcapacity - writerIndexï¼‰æ˜¯å¦èƒ½å¤Ÿæ»¡è¶³æœ¬æ¬¡éœ€è¦å†™å…¥çš„æ•°æ®å¤§å° minWritableBytesã€‚å¦‚æœå‰©ä½™å®¹é‡ä¸è¶³ï¼Œé‚£ä¹ˆå°±éœ€è¦å¯¹ ByteBuf è¿›è¡Œæ‰©å®¹ï¼Œä½†æ‰©å®¹åçš„å®¹é‡ä¸èƒ½è¶…è¿‡ maxCapacity çš„å¤§å°ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <div class="language- extra-class"><pre class="language-text"><code>    final void ensureWritable0(int minWritableBytes) {
        final int writerIndex = writerIndex();
        // ä¸ºæ»¡è¶³æœ¬æ¬¡çš„å†™å…¥æ“ä½œï¼Œé¢„æœŸçš„ ByteBuf å®¹é‡å¤§å°
        final int targetCapacity = writerIndex + minWritableBytes;
        // å‰©ä½™å®¹é‡å¯ä»¥æ»¡è¶³æœ¬æ¬¡å†™å…¥è¦æ±‚ï¼Œç›´æ¥è¿”å›ï¼Œä¸éœ€è¦æ‰©å®¹
        if (targetCapacity &gt;= 0 &amp; targetCapacity &lt;= capacity()) {
            return;
        }
        // æ‰©å®¹åçš„å®¹é‡ä¸èƒ½è¶…è¿‡ maxCapacity
        if (checkBounds &amp;&amp; (targetCapacity &lt; 0 || targetCapacity &gt; maxCapacity)) {
            ensureAccessible();
            throw new IndexOutOfBoundsException(String.format(
                    &quot;writerIndex(%d) + minWritableBytes(%d) exceeds maxCapacity(%d): %s&quot;,
                    writerIndex, minWritableBytes, maxCapacity, this));
        }

        // å¦‚æœ targetCapacity åœ¨ï¼ˆcapacity , maxCapacity] ä¹‹é—´ï¼Œåˆ™è¿›è¡Œæ‰©å®¹
        // fastWritable è¡¨ç¤ºåœ¨ä¸æ¶‰åŠåˆ° memory reallocation or data-copy çš„æƒ…å†µä¸‹ï¼Œå½“å‰ ByteBuf å¯ä»¥ç›´æ¥å†™å…¥çš„å®¹é‡
        // å¯¹äº UnpooledDirectBuffer è¿™é‡Œçš„ fastWritable = capacity - writerIndex
        // PooledDirectBuffer æœ‰å¦å¤–çš„å®ç°ï¼Œè¿™é‡Œå…ˆæš‚æ—¶ä¸éœ€è¦å…³æ³¨
        final int fastWritable = maxFastWritableBytes();
        // è®¡ç®—æ‰©å®¹åçš„å®¹é‡ newCapacity
        // å¯¹äº UnpooledDirectBuffer æ¥è¯´è¿™é‡Œç›´æ¥é€šè¿‡ calculateNewCapacity è®¡ç®—æ‰©å®¹åçš„å®¹é‡ã€‚
        int newCapacity = fastWritable &gt;= minWritableBytes ? writerIndex + fastWritable
                : alloc().calculateNewCapacity(targetCapacity, maxCapacity);

        // æ ¹æ® new capacity å¯¹ ByteBuf è¿›è¡Œæ‰©å®¹
        capacity(newCapacity);
    }
</code></pre></div><h4 id="_2-5-1-newcapacity-çš„è®¡ç®—é€»è¾‘"><a href="#_2-5-1-newcapacity-çš„è®¡ç®—é€»è¾‘" class="header-anchor">#</a> <strong>2.5.1 newCapacity çš„è®¡ç®—é€»è¾‘</strong></h4> <p>ByteBuf çš„åˆå§‹é»˜è®¤ capacity ä¸º 256 ä¸ªå­—èŠ‚ï¼Œåˆå§‹é»˜è®¤ maxCapacity ä¸º <code>Integer.MAX_VALUE</code> ä¹Ÿå°±æ˜¯ 2G å¤§å°ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public abstract class AbstractByteBufAllocator implements ByteBufAllocator {
    // ByteBuf çš„åˆå§‹é»˜è®¤ CAPACITY
    static final int DEFAULT_INITIAL_CAPACITY = 256;
    // ByteBuf çš„åˆå§‹é»˜è®¤ MAX_CAPACITY 
    static final int DEFAULT_MAX_CAPACITY = Integer.MAX_VALUE;

    @Override
    public ByteBuf directBuffer() {
        return directBuffer(DEFAULT_INITIAL_CAPACITY, DEFAULT_MAX_CAPACITY);
    }
}
</code></pre></div><p>ä¸ºæ»¡è¶³æœ¬æ¬¡å†™å…¥æ“ä½œï¼Œå¯¹ ByteBuf çš„æœ€å°å®¹é‡è¦æ±‚ä¸º minNewCapacityï¼Œå®ƒçš„å€¼å°±æ˜¯åœ¨ <code>ensureWritable0</code> æ–¹æ³•ä¸­è®¡ç®—å‡ºæ¥çš„ <code>targetCapacity</code>, è®¡ç®—æ–¹å¼ä¸ºï¼š <code>minNewCapacity = writerIndex + minWritableBytesï¼ˆæœ¬æ¬¡å°†è¦å†™å…¥çš„å­—èŠ‚æ•°ï¼‰</code>ã€‚</p> <p>åœ¨ ByteBuf çš„æ‰©å®¹é€»è¾‘ä¸­ï¼ŒNetty è®¾ç½®äº†ä¸€ä¸ªé‡è¦çš„é˜ˆå€¼ <code>CALCULATE_THRESHOLD</code>, å¤§å°ä¸º 4Mï¼Œå®ƒå†³å®šäº† ByteBuf æ‰©å®¹çš„å°ºåº¦ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    // æ‰©å®¹çš„å°ºåº¦
    static final int CALCULATE_THRESHOLD = 1048576 * 4; // 4 MiB page
</code></pre></div><p>å¦‚æœ minNewCapacity æ°å¥½ç­‰äº CALCULATE_THRESHOLDï¼Œé‚£ä¹ˆæ‰©å®¹åçš„å®¹é‡ newCapacity å°±æ˜¯ 4Mã€‚</p> <p>å¦‚æœ minNewCapacity å¤§äº CALCULATE_THRESHOLDï¼Œé‚£ä¹ˆ newCapacity å°±ä¼šæŒ‰ç…§ 4M çš„å°ºåº¦è¿›è¡Œæ‰©å®¹ï¼Œå…·ä½“çš„æ‰©å®¹é€»è¾‘å¦‚ä¸‹ï¼š</p> <p>é¦–å…ˆé€šè¿‡ <code>minNewCapacity / threshold * threshold</code> è®¡ç®—å‡ºä¸€ä¸ªå‡†å¤‡æ‰©å®¹ä¹‹å‰çš„åŸºå‡†çº¿ï¼Œåé¢å°±ä¼šä»¥æ­¤åŸºå‡†çº¿ä¸ºåŸºç¡€ï¼ŒæŒ‰ç…§ CALCULATE_THRESHOLD çš„ç²’åº¦è¿›è¡Œæ‰©å®¹ã€‚</p> <p>è¯¥åŸºå‡†çº¿çš„è¦æ±‚å¿…é¡»æ˜¯ CALCULATE_THRESHOLD çš„æœ€å°å€æ•°ï¼Œè€Œä¸”å¿…é¡»è¦å°äºç­‰äº minNewCapacityã€‚</p> <p>ä»€ä¹ˆæ„æ€å‘¢ ï¼Ÿ å‡è®¾ minNewCapacity ä¸º 5Mï¼Œé‚£ä¹ˆå®ƒçš„æ‰©å®¹åŸºå‡†çº¿å°±æ˜¯ 4M ï¼Œ è¿™ç§æƒ…å†µä¸‹æ‰©å®¹ä¹‹åçš„å®¹é‡ <code>newCapacity = 4M + CALCULATE_THRESHOLD = 8M</code> ã€‚</p> <p>å¦‚æœè®¡ç®—å‡ºæ¥çš„åŸºå‡†çº¿è¶…è¿‡äº† <code>maxCapacity - 4M</code> , é‚£ä¹ˆ newCapacity ç›´æ¥å°±æ‰©å®¹åˆ° maxCapacity ã€‚</p> <p>å¦‚æœ minNewCapacity å°äº CALCULATE_THRESHOLDï¼Œé‚£ä¹ˆ newCapacity å°±ä¼šä» 64 å¼€å§‹ï¼Œä¸€ç›´å¾ªç¯ double , ä¹Ÿå°±æ˜¯æŒ‰ç…§ 64 çš„å€æ•°è¿›è¡Œæ‰©å®¹ã€‚ç›´åˆ° newCapacity å¤§äºç­‰äº minNewCapacityã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>        int newCapacity = 64;
        while (newCapacity &lt; minNewCapacity) {
            newCapacity &lt;&lt;= 1;
        }
</code></pre></div><ul><li>å¦‚æœ minNewCapacity åœ¨ <code>[0 , 64]</code> è¿™æ®µèŒƒå›´å†… ï¼Œ é‚£ä¹ˆæ‰©å®¹åçš„ newCapacity å°±æ˜¯ 64</li> <li>å¦‚æœ minNewCapacity åœ¨ <code>[65 , 128]</code> è¿™æ®µèŒƒå›´å†… ï¼Œ é‚£ä¹ˆæ‰©å®¹åçš„ newCapacity å°±æ˜¯ 128 ã€‚</li> <li>å¦‚æœ minNewCapacity åœ¨ <code>[129 , 256]</code> è¿™æ®µèŒƒå›´å†… ï¼Œ é‚£ä¹ˆæ‰©å®¹åçš„ newCapacity å°±æ˜¯ 256 ã€‚</li></ul> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <div class="language- extra-class"><pre class="language-text"><code>public abstract class AbstractByteBufAllocator implements ByteBufAllocator {

    @Override
    public int calculateNewCapacity(int minNewCapacity, int maxCapacity) {
        // æ»¡è¶³æœ¬æ¬¡å†™å…¥æ“ä½œçš„æœ€å°å®¹é‡ minNewCapacity ä¸èƒ½è¶…è¿‡ maxCapacity
        if (minNewCapacity &gt; maxCapacity) {
            throw new IllegalArgumentException(String.format(
                    &quot;minNewCapacity: %d (expected: not greater than maxCapacity(%d)&quot;,
                    minNewCapacity, maxCapacity));
        }
        // ç”¨äºå†³å®šæ‰©å®¹çš„å°ºåº¦
        final int threshold = CALCULATE_THRESHOLD; // 4 MiB page

        if (minNewCapacity == threshold) {
            return threshold;
        }

        // If over threshold, do not double but just increase by threshold.
        if (minNewCapacity &gt; threshold) {
            // è®¡ç®—æ‰©å®¹åŸºå‡†çº¿ã€‚
            // è¦æ±‚å¿…é¡»æ˜¯ CALCULATE_THRESHOLD çš„æœ€å°å€æ•°ï¼Œè€Œä¸”å¿…é¡»è¦å°äºç­‰äº minNewCapacity
            int newCapacity = minNewCapacity / threshold * threshold;
            if (newCapacity &gt; maxCapacity - threshold) {
                newCapacity = maxCapacity;
            } else {
                // æŒ‰ç…§ threshold (4M)æ‰©å®¹
                newCapacity += threshold;
            }
            return newCapacity;
        }

        // Not over threshold. Double up to 4 MiB, starting from 64.
        // æŒ‰ç…§ 64 çš„å€æ•°è¿›è¡Œæ‰©å®¹ã€‚ä½† newCapacity éœ€è¦å¤§äºç­‰äº minNewCapacityã€‚
        int newCapacity = 64;
        while (newCapacity &lt; minNewCapacity) {
            newCapacity &lt;&lt;= 1;
        }

        return Math.min(newCapacity, maxCapacity);
    }
}
</code></pre></div><h4 id="_2-5-2-bytebuf-çš„æ‰©å®¹é€»è¾‘"><a href="#_2-5-2-bytebuf-çš„æ‰©å®¹é€»è¾‘" class="header-anchor">#</a> <strong>2.5.2 ByteBuf çš„æ‰©å®¹é€»è¾‘</strong></h4> <div class="language- extra-class"><pre class="language-text"><code>public class UnpooledDirectByteBuf  {
    // åº•å±‚ä¾èµ– JDK çš„ DirectByteBuffer
    ByteBuffer buffer;
}
</code></pre></div><p>å¯¹äº UnpooledDirectByteBuf æ¥è¯´ï¼Œå…¶åº•å±‚çœŸæ­£å­˜å‚¨æ•°æ®çš„åœ°æ–¹å…¶å®æ˜¯ä¾èµ– JDK  ä¸­çš„ DirectByteBufferï¼Œæ‰©å®¹çš„é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯é¦–å…ˆæ ¹æ®ä¸Šä¸€å°èŠ‚è®¡ç®—å‡ºçš„ newCapacity é‡æ–°åˆ†é…ä¸€ä¸ªæ–°çš„ JDK  DirectByteBuffer ï¼Œ ç„¶åå°†åŸæ¥ DirectByteBuffer ä¸­çš„æ•°æ®æ‹·è´åˆ°æ–°çš„ DirectByteBuffer ä¸­ï¼Œæœ€åé‡Šæ”¾åŸæ¥çš„ DirectByteBufferï¼Œå°†æ–°çš„ DirectByteBuffer è®¾ç½®åˆ° UnpooledDirectByteBuf ä¸­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class UnpooledDirectByteBuf  {
    void setByteBuffer(ByteBuffer buffer, boolean tryFree) {
        if (tryFree) {
            ByteBuffer oldBuffer = this.buffer;
            // é‡Šæ”¾åŸæ¥çš„ buffer
            freeDirect(oldBuffer);
        }
        // é‡æ–°è®¾ç½®æ–°çš„ buffer
        this.buffer = buffer;
        capacity = buffer.remaining();
    }
}
</code></pre></div><p>å¯¹äº UnpooledUnsafeDirectByteBuf æ¥è¯´ï¼Œç”±äºå®ƒç›´æ¥ä¾èµ–çš„æ˜¯ OS å†…å­˜åœ°å€ï¼Œå¯¹ ByteBuf çš„ç›¸å…³æ“ä½œéƒ½æ˜¯ç›´æ¥æ“ä½œå†…å­˜åœ°å€è¿›è¡Œï¼Œæ‰€ä»¥ UnpooledUnsafeDirectByteBuf çš„æ‰©å®¹é€»è¾‘é™¤äº†è¦æ‰§è¡Œä¸Šé¢çš„å†…å®¹ä¹‹å¤–ï¼Œè¿˜éœ€è¦å°†æ–° DirectByteBuffer çš„å†…å­˜åœ°å€è®¾ç½®åˆ° memoryAddress ä¸­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class UnpooledUnsafeDirectByteBuf extends UnpooledDirectByteBuf {
    // ByteBuf çš„å†…å­˜åœ°å€
    long memoryAddress;

    @Override
    final void setByteBuffer(ByteBuffer buffer, boolean tryFree) {
        super.setByteBuffer(buffer, tryFree);
        // è®¾ç½®æˆæ–° buffer çš„å†…å­˜åœ°å€
        memoryAddress = PlatformDependent.directBufferAddress(buffer);
    }
}
</code></pre></div><p>ä¸‹é¢æ˜¯å®Œæ•´çš„æ‰©å®¹æ“ä½œé€»è¾‘ï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>public class UnpooledDirectByteBuf  {
    // åº•å±‚ä¾èµ– JDK çš„ DirectByteBuffer
    ByteBuffer buffer;

    @Override
    public ByteBuf capacity(int newCapacity) {
        // newCapacity ä¸èƒ½è¶…è¿‡ maxCapacity
        checkNewCapacity(newCapacity);
        int oldCapacity = capacity;
        if (newCapacity == oldCapacity) {
            return this;
        }
        // è®¡ç®—æ‰©å®¹ä¹‹åéœ€è¦æ‹·è´çš„å­—èŠ‚æ•°
        int bytesToCopy;
        if (newCapacity &gt; oldCapacity) {
            bytesToCopy = oldCapacity;
        } else {
            ........ ç¼©å®¹ .......
        }
        ByteBuffer oldBuffer = buffer;
        // æ ¹æ® newCapacity åˆ†é…ä¸€ä¸ªæ–°çš„ ByteBufferï¼ˆJDKï¼‰
        ByteBuffer newBuffer = allocateDirect(newCapacity);
        oldBuffer.position(0).limit(bytesToCopy);
        newBuffer.position(0).limit(bytesToCopy);
        // å°†åŸæ¥ oldBuffer ä¸­çš„æ•°æ®æ‹·è´åˆ° newBuffer ä¸­
        newBuffer.put(oldBuffer).clear();
        // é‡Šæ”¾ oldBufferï¼Œè®¾ç½® newBuffer
        // å¯¹äº UnpooledUnsafeDirectByteBuf æ¥è¯´å°±æ˜¯å°† newBuffer çš„åœ°å€è®¾ç½®åˆ° memoryAddress ä¸­
        setByteBuffer(newBuffer, true);
        return this;
    }
}
</code></pre></div><h4 id="_2-5-3-å¼ºåˆ¶æ‰©å®¹"><a href="#_2-5-3-å¼ºåˆ¶æ‰©å®¹" class="header-anchor">#</a> <strong>2.5.3 å¼ºåˆ¶æ‰©å®¹</strong></h4> <p>å‰é¢ä»‹ç»çš„ ensureWritable æ–¹æ³•ä¼šæ£€æŸ¥æœ¬æ¬¡å†™å…¥çš„æ•°æ®å¤§å° minWritableBytes æ˜¯å¦è¶…è¿‡ ByteBuf çš„æœ€å¤§å¯å†™å®¹é‡ï¼š<code>maxCapacity - writerIndex</code>ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public ByteBuf ensureWritable(int minWritableBytes) 
</code></pre></div><p>å¦‚æœè¶…è¿‡ï¼Œåˆ™ä¼šæŠ›å‡º <code>IndexOutOfBoundsException</code> å¼‚å¸¸åœæ­¢æ‰©å®¹ï¼ŒNetty æä¾›äº†å¦å¤–ä¸€ä¸ªå¸¦æœ‰ force å‚æ•°çš„æ‰©å®¹æ–¹æ³•ï¼Œç”¨æ¥å†³å®šåœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯å¦å¼ºåˆ¶è¿›è¡Œæ‰©å®¹ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code> public int ensureWritable(int minWritableBytes, boolean force) 
</code></pre></div><p>å½“ minWritableBytes å·²ç»è¶…è¿‡ ByteBuf çš„æœ€å¤§å¯å†™å®¹é‡å¾—æ—¶å€™ï¼š</p> <ul><li><code>force = false</code> ï¼Œ é‚£ä¹ˆåœæ­¢æ‰©å®¹ï¼Œç›´æ¥è¿”å›ï¼Œä¸æŠ›å¼‚å¸¸ã€‚</li> <li><code>force = true</code> , åˆ™è¿›è¡Œå¼ºåˆ¶æ‰©å®¹ï¼Œå°† ByteBuf æ‰©å®¹è‡³ maxCapacityï¼Œä½†æ˜¯å¦‚æœå½“å‰å®¹é‡å·²ç»è¾¾åˆ°äº† maxCapacityï¼Œåˆ™åœæ­¢æ‰©å®¹ ã€‚</li></ul> <p>å¸¦ force å‚æ•°çš„ ensureWritable å¹¶ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯é€šè¿‡è¿”å›çŠ¶æ€ç æ¥é€šçŸ¥è°ƒç”¨è€… ByteBuf çš„å®¹é‡æƒ…å†µã€‚</p> <ol><li>è¿”å› 0 è¡¨ç¤ºï¼ŒByteBuf å½“å‰å¯å†™å®¹é‡å¯ä»¥æ»¡è¶³æœ¬æ¬¡å†™å…¥æ“ä½œçš„éœ€æ±‚ï¼Œä¸éœ€è¦æ‰©å®¹</li> <li>è¿”å› 1 è¡¨ç¤ºï¼Œæœ¬æ¬¡å†™å…¥çš„æ•°æ®å¤§å°å·²ç»è¶…è¿‡äº† ByteBuf çš„æœ€å¤§å¯å†™å®¹é‡ï¼Œä½† ByteBuf çš„å®¹é‡å·²ç»è¾¾åˆ°äº† maxCapacityï¼Œæ— æ³•è¿›è¡Œæ‰©å®¹ã€‚</li> <li>è¿”å› 3 è¡¨ç¤ºï¼Œæœ¬æ¬¡å†™å…¥çš„æ•°æ®å¤§å°å·²ç»è¶…è¿‡äº† ByteBuf çš„æœ€å¤§å¯å†™å®¹é‡ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå¼ºåˆ¶å°†å®¹é‡æ‰©å®¹è‡³ maxCapacityã€‚</li> <li>è¿”å› 2 è¡¨ç¤ºï¼Œæ‰§è¡Œæ­£å¸¸çš„æ‰©å®¹é€»è¾‘ã€‚</li></ol> <p>è¿”å›å€¼ 0 å’Œ 2 å‡è¡¨ç¤º ByteBuf å®¹é‡ï¼ˆæ‰©å®¹å‰æˆ–è€…æ‰©å®¹åï¼‰å¯ä»¥æ»¡è¶³æœ¬æ¬¡å†™å…¥çš„æ•°æ®å¤§å°ï¼Œè€Œè¿”å›å€¼ 1 å’Œ 3 è¡¨ç¤º ByteBuf å®¹é‡ï¼ˆæ‰©å®¹å‰æˆ–è€…æ‰©å®¹åï¼‰éƒ½æ— æ³•æ»¡è¶³æœ¬æ¬¡å†™å…¥çš„æ•°æ®å¤§å°ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public int ensureWritable(int minWritableBytes, boolean force) {
        // å¦‚æœå‰©ä½™å®¹é‡å¯ä»¥æ»¡è¶³æœ¬æ¬¡å†™å…¥æ“ä½œï¼Œåˆ™ä¸ä¼šæ‰©å®¹ï¼Œç›´æ¥è¿”å›
        if (minWritableBytes &lt;= writableBytes()) {
            return 0;
        }

        final int maxCapacity = maxCapacity();
        final int writerIndex = writerIndex();
        // å¦‚æœæœ¬æ¬¡å†™å…¥çš„æ•°æ®å¤§å°å·²ç»è¶…è¿‡äº† ByteBuf çš„æœ€å¤§å¯å†™å®¹é‡ maxCapacity - writerIndex
        if (minWritableBytes &gt; maxCapacity - writerIndex) {
            // force = false ï¼Œ é‚£ä¹ˆåœæ­¢æ‰©å®¹ï¼Œç›´æ¥è¿”å›
            // force = true, ç›´æ¥æ‰©å®¹åˆ° maxCapacityï¼Œå¦‚æœå½“å‰ capacity å·²ç»ç­‰äº maxCapacity äº†åˆ™åœæ­¢æ‰©å®¹
            if (!force || capacity() == maxCapacity) {
                return 1;
            }
            // è™½ç„¶æ‰©å®¹ä¹‹åè¿˜æ˜¯æ— æ³•æ»¡è¶³å†™å…¥éœ€æ±‚ï¼Œä½†è¿˜æ˜¯å¼ºåˆ¶æ‰©å®¹è‡³ maxCapacity
            capacity(maxCapacity);
            return 3;
        }
        // ä¸‹é¢å°±æ˜¯æ™®é€šçš„æ‰©å®¹é€»è¾‘
        int fastWritable = maxFastWritableBytes();
        int newCapacity = fastWritable &gt;= minWritableBytes ? writerIndex + fastWritable
                : alloc().calculateNewCapacity(writerIndex + minWritableBytes, maxCapacity);

        // Adjust to the new capacity.
        capacity(newCapacity);
        return 2;
    }
</code></pre></div><h4 id="_2-5-4-è‡ªé€‚åº”åŠ¨æ€æ‰©å®¹"><a href="#_2-5-4-è‡ªé€‚åº”åŠ¨æ€æ‰©å®¹" class="header-anchor">#</a> <strong>2.5.4 è‡ªé€‚åº”åŠ¨æ€æ‰©å®¹</strong></h4> <p>Netty åœ¨æ¥æ”¶ç½‘ç»œæ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œå…¶å®ä¸€å¼€å§‹æ˜¯å¾ˆéš¾ç¡®å®šå‡ºè¯¥ç”¨å¤šå¤§å®¹é‡çš„ ByteBuf å»æ¥æ”¶çš„ï¼Œæ‰€ä»¥ Netty åœ¨ä¸€å¼€å§‹ä¼šé¦–å…ˆé¢„ä¼°ä¸€ä¸ªåˆå§‹å®¹é‡ <code>DEFAULT_INITIAL (2048)</code>ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class AdaptiveRecvByteBufAllocator {
    static final int DEFAULT_INITIAL = 2048;
}
</code></pre></div><p>ç”¨åˆå§‹å®¹é‡ä¸º 2048 å¤§å°çš„ ByteBuf å»è¯»å– socket ä¸­çš„æ•°æ®ï¼Œåœ¨æ¯ä¸€æ¬¡è¯»å–å®Œ socket ä¹‹åï¼ŒNetty éƒ½ä¼šè¯„ä¼° ByteBuf çš„å®¹é‡å¤§å°æ˜¯å¦åˆé€‚ã€‚å¦‚æœæ¯ä¸€æ¬¡éƒ½èƒ½æŠŠ ByteBuf è£…æ»¡ï¼Œé‚£è¯´æ˜æˆ‘ä»¬é¢„ä¼°çš„å®¹é‡å¤ªå°äº†ï¼Œsocket ä¸­è¿˜æœ‰æ›´å¤šçš„æ•°æ®ï¼Œé‚£ä¹ˆå°±éœ€è¦å¯¹ ByteBuf è¿›è¡Œæ‰©å®¹ï¼Œä¸‹ä¸€æ¬¡è¯»å– socket çš„æ—¶å€™å°±æ¢ä¸€ä¸ªå®¹é‡æ›´å¤§çš„ ByteBufã€‚</p> <div class="language- extra-class"><pre class="language-text"><code> private final class HandleImpl extends MaxMessageHandle {
        @Override
        public void lastBytesRead(int bytes) {
            // bytes ä¸ºæœ¬æ¬¡ä» socket ä¸­çœŸå®è¯»å–çš„æ•°æ®å¤§å°
            // attemptedBytesRead ä¸º ByteBuf å¯å†™çš„å®¹é‡å¤§å°ï¼Œåˆå§‹ä¸º 2048
            if (bytes == attemptedBytesRead()) {
                // å¦‚æœæœ¬æ¬¡è¯»å– socket ä¸­çš„æ•°æ®å°† ByteBuf è£…æ»¡äº†
                // é‚£ä¹ˆå°±å¯¹ ByteBuf è¿›è¡Œæ‰©å®¹ï¼Œåœ¨ä¸‹ä¸€æ¬¡è¯»å–çš„æ—¶å€™ç”¨æ›´å¤§çš„ ByteBuf å»è¯»
                record(bytes);
            }
            // è®°å½•æœ¬æ¬¡ä» socket ä¸­è¯»å–çš„æ•°æ®å¤§å°
            super.lastBytesRead(bytes);
        }
 }
</code></pre></div><p>Netty ä¼šåœ¨ä¸€ä¸ª read loop ä¸­ä¸åœçš„è¯»å– socket ä¸­çš„æ•°æ®ç›´åˆ°æ•°æ®è¢«è¯»å–å®Œæ¯•æˆ–è€…è¯»æ»¡ 16 æ¬¡ï¼Œç»“æŸ read loop åœæ­¢è¯»å–ã€‚ByteBuf è¶Šå¤§é‚£ä¹ˆ Netty è¯»å–çš„æ¬¡æ•°å°±è¶Šå°‘ï¼ŒByteBuf è¶Šå°é‚£ä¹ˆ Netty è¯»å–çš„æ¬¡æ•°å°±è¶Šå¤šï¼Œæ‰€ä»¥éœ€è¦ä¸€ç§æœºåˆ¶å°† ByteBuf çš„å®¹é‡æ§åˆ¶åœ¨ä¸€ä¸ªåˆç†çš„èŒƒå›´å†…ã€‚</p> <p>Netty ä¼šç»Ÿè®¡æ¯ä¸€è½® read loop æ€»å…±è¯»å–äº†å¤šå°‘æ•°æ® â€”â€” totalBytesReadã€‚</p> <div class="language- extra-class"><pre class="language-text"><code> public abstract class MaxMessageHandle implements ExtendedHandle {
        // ç”¨äºç»Ÿè®¡åœ¨ä¸€è½® read loop ä¸­æ€»å…±æ¥æ”¶åˆ°å®¢æˆ·ç«¯è¿æ¥ä¸Šçš„æ•°æ®å¤§å°
        private int totalBytesRead;
 }
</code></pre></div><p>åœ¨æ¯ä¸€è½®çš„ read loop ç»“æŸä¹‹åï¼ŒNetty éƒ½ä¼šæ ¹æ®è¿™ä¸ª totalBytesRead æ¥åˆ¤æ–­æ˜¯å¦åº”è¯¥å¯¹ ByteBuf è¿›è¡Œæ‰©å®¹æˆ–è€…ç¼©å®¹ï¼Œè¿™æ ·åœ¨ä¸‹ä¸€è½® read loop å¼€å§‹çš„æ—¶å€™ï¼ŒNetty å°±å¯ä»¥ç”¨ä¸€ä¸ªç›¸å¯¹åˆç†çš„å®¹é‡å»æ¥æ”¶ socket ä¸­çš„æ•°æ®ï¼Œå°½é‡å‡å°‘è¯»å– socket çš„æ¬¡æ•°ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>private final class HandleImpl extends MaxMessageHandle {
        @Override
        public void readComplete() {
                // æ˜¯å¦å¯¹ ByteBuf è¿›è¡Œæ‰©å®¹æˆ–è€…ç¼©å®¹
                record(totalBytesRead());
        }
}
</code></pre></div><p><strong>é‚£ä¹ˆåœ¨ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å¯¹ ByteBuf æ‰©å®¹ï¼Œæ¯æ¬¡æ‰©å®¹å¤šå°‘ ï¼Ÿ ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å¯¹ ByteBuf è¿›è¡Œç¼©å®¹ï¼Œæ¯æ¬¡ç¼©å®¹å¤šå°‘å‘¢</strong> ï¼Ÿ</p> <p>è¿™å°±ç”¨åˆ°äº†ä¸€ä¸ªé‡è¦çš„å®¹é‡ç´¢å¼•ç»“æ„ â€”â€”  SIZE_TABLEï¼Œå®ƒé‡Œè¾¹å®šä¹‰ç´¢å¼•äº† ByteBuf çš„æ¯ä¸€ç§å®¹é‡å¤§å°ã€‚ç›¸å½“äºæ˜¯æ‰©ç¼©å®¹çš„å®¹é‡ç´¢å¼•è¡¨ã€‚æ¯æ¬¡æ‰©å®¹å¤šå°‘ï¼Œç¼©å®¹å¤šå°‘å…¨éƒ¨è®°å½•åœ¨è¿™ä¸ªå®¹é‡ç´¢å¼•è¡¨ä¸­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class AdaptiveRecvByteBufAllocator {
    // æ‰©å®¹æ­¥é•¿
    private static final int INDEX_INCREMENT = 4;
    // ç¼©å®¹æ­¥é•¿
    private static final int INDEX_DECREMENT = 1;

    // ByteBufåˆ†é…å®¹é‡è¡¨ï¼ˆæ‰©ç¼©å®¹ç´¢å¼•è¡¨ï¼‰æŒ‰ç…§è¡¨ä¸­è®°å½•çš„å®¹é‡å¤§å°è¿›è¡Œæ‰©ç¼©å®¹
    private static final int[] SIZE_TABLE;
}
</code></pre></div><p>å½“ç´¢å¼•å®¹é‡<code>å°äº 512</code> æ—¶ï¼Œ<code>SIZE_TABLE</code> ä¸­å®šä¹‰çš„å®¹é‡æ˜¯ä» <code>16</code> å¼€å§‹æŒ‰ç…§ <code>16</code> é€’å¢ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>å½“ç´¢å¼•å®¹é‡<code>å¤§äº 512</code> æ—¶ï¼ŒSIZE_TABLE ä¸­å®šä¹‰çš„å®¹é‡æ˜¯æŒ‰å‰ä¸€ä¸ªç´¢å¼•å®¹é‡çš„ <code>2 å€</code>é€’å¢ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>é‚£ä¹ˆå½“å‰ ByteBuf çš„åˆå§‹å®¹é‡ä¸º 2048 ï¼Œ å®ƒåœ¨ SIZE_TABLE ä¸­çš„ index ä¸º 33 ã€‚å½“ä¸€è½® read loop è¯»å–å®Œæ¯•ä¹‹åï¼Œå¦‚æœå‘ç° totalBytesRead åœ¨<code>SIZE_TABLE[index - INDEX_DECREMENT]</code> ä¸ <code>SIZE_TABLE[index]</code> ä¹‹é—´çš„è¯ï¼Œä¹Ÿå°±æ˜¯å¦‚æœæœ¬è½® read loop ç»“æŸä¹‹åæ€»å…±è¯»å–çš„å­—èŠ‚æ•°åœ¨ [1024 , 2048] ä¹‹é—´ã€‚è¯´æ˜æ­¤æ—¶åˆ†é…çš„ ByteBuf å®¹é‡æ­£å¥½ï¼Œä¸éœ€è¦è¿›è¡Œç¼©å®¹ä¹Ÿä¸éœ€è¦è¿›è¡Œæ‰©å®¹ã€‚æ¯”å¦‚æœ¬æ¬¡ totalBytesRead = 2000ï¼Œæ­£å¥½å¤„åœ¨ 1024 ä¸ 2048 ä¹‹é—´ã€‚è¯´æ˜ 2048 çš„å®¹é‡æ­£å¥½ã€‚</p> <p>å¦‚æœ totalBytesRead å°äºç­‰äº <code>SIZE_TABLE[index - INDEX_DECREMENT]</code>ï¼Œä¹Ÿå°±æ˜¯å¦‚æœæœ¬è½® read loop ç»“æŸä¹‹åæ€»å…±è¯»å–çš„å­—èŠ‚æ•°å°äºç­‰äº1024ã€‚è¡¨ç¤ºæœ¬æ¬¡è¯»å–åˆ°çš„å­—èŠ‚æ•°æ¯”å½“å‰ ByteBuf å®¹é‡çš„ä¸‹ä¸€çº§å®¹é‡è¿˜è¦å°ï¼Œè¯´æ˜å½“å‰ ByteBuf çš„å®¹é‡åˆ†é…çš„æœ‰äº›å¤§äº†ï¼Œè®¾ç½®ç¼©å®¹æ ‡è¯†<code>decreaseNow = true</code>ã€‚å½“ä¸‹æ¬¡ read loop çš„æ—¶å€™å¦‚æœç»§ç»­æ»¡è¶³ç¼©å®¹æ¡ä»¶ï¼Œé‚£ä¹ˆå°±å¼€å§‹è¿›è¡Œç¼©å®¹ã€‚ç¼©å®¹åçš„å®¹é‡ä¸º SIZE_TABLE[index - INDEX_DECREMENT]ï¼Œä½†ä¸èƒ½å°äºSIZE_TABLE[minIndex]ï¼ˆ16ï¼‰ã€‚</p> <blockquote><p>æ³¨æ„ï¼Œè¿™é‡Œéœ€è¦æ»¡è¶³ä¸¤æ¬¡ç¼©å®¹æ¡ä»¶æ‰ä¼šè¿›è¡Œç¼©å®¹ï¼Œä¸”ç¼©å®¹æ­¥é•¿ä¸º 1 (INDEX_DECREMENT)ï¼Œç¼©å®¹æ¯”è¾ƒè°¨æ…ã€‚</p></blockquote> <p>å¦‚æœ totalBytesRead  å¤§äºç­‰äºå½“å‰ ByteBuf å®¹é‡â€”â€” nextReceiveBufferSize æ—¶ï¼Œè¯´æ˜ ByteBuf çš„å®¹é‡æœ‰ç‚¹å°äº†ï¼Œéœ€è¦è¿›è¡Œæ‰©å®¹ã€‚æ‰©å®¹åçš„å®¹é‡ä¸º <code>SIZE_TABLE[index + INDEX_INCREMENT]</code>ï¼Œä½†ä¸èƒ½è¶…è¿‡ SIZE_TABLE[maxIndex]ï¼ˆ65535ï¼‰ã€‚</p> <blockquote><p>æ»¡è¶³ä¸€æ¬¡æ‰©å®¹æ¡ä»¶å°±è¿›è¡Œæ‰©å®¹ï¼Œå¹¶ä¸”æ‰©å®¹æ­¥é•¿ä¸º 4 (INDEX_INCREMENT)ï¼Œ æ‰©å®¹æ¯”è¾ƒå¥”æ”¾ã€‚</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>        private void record(int actualReadBytes) {
            if (actualReadBytes &lt;= SIZE_TABLE[max(0, index - INDEX_DECREMENT)]) {
                // ç¼©å®¹æ¡ä»¶è§¦å‘ä¸¤æ¬¡ä¹‹åå°±è¿›è¡Œç¼©å®¹
                if (decreaseNow) {
                    index = max(index - INDEX_DECREMENT, minIndex);
                    nextReceiveBufferSize = SIZE_TABLE[index];
                    decreaseNow = false;
                } else {
                    decreaseNow = true;
                }
            } else if (actualReadBytes &gt;= nextReceiveBufferSize) {
                // æ‰©å®¹æ¡ä»¶æ»¡è¶³ä¸€æ¬¡ä¹‹åå°±è¿›è¡Œæ‰©å®¹
                index = min(index + INDEX_INCREMENT, maxIndex);
                nextReceiveBufferSize = SIZE_TABLE[index];
                decreaseNow = false;
            }
        }
</code></pre></div><h3 id="_2-6-bytebuf-çš„å¼•ç”¨è®¡æ•°è®¾è®¡"><a href="#_2-6-bytebuf-çš„å¼•ç”¨è®¡æ•°è®¾è®¡" class="header-anchor">#</a> <strong>2.6 ByteBuf çš„å¼•ç”¨è®¡æ•°è®¾è®¡</strong></h3> <p>Netty ä¸º ByteBuf å¼•å…¥äº†å¼•ç”¨è®¡æ•°çš„æœºåˆ¶ï¼Œåœ¨ ByteBuf çš„æ•´ä¸ªè®¾è®¡ä½“ç³»ä¸­ï¼Œæ‰€æœ‰çš„ ByteBuf éƒ½ä¼šç»§æ‰¿ä¸€ä¸ªæŠ½è±¡ç±» AbstractReferenceCountedByteBuf ï¼Œ å®ƒæ˜¯å¯¹æ¥å£ ReferenceCounted çš„å®ç°ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <div class="language- extra-class"><pre class="language-text"><code>public interface ReferenceCounted {
     int refCnt();
     ReferenceCounted retain();
     ReferenceCounted retain(int increment);
     boolean release();
     boolean release(int decrement);
}
</code></pre></div><p>æ¯ä¸ª ByteBuf çš„å†…éƒ¨éƒ½ç»´æŠ¤äº†ä¸€ä¸ªå«åš refCnt çš„å¼•ç”¨è®¡æ•°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>refCnt()</code> æ–¹æ³•æ¥è·å– ByteBuf å½“å‰çš„å¼•ç”¨è®¡æ•° refCntã€‚å½“ ByteBuf åœ¨å…¶ä»–ä¸Šä¸‹æ–‡ä¸­è¢«å¼•ç”¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ <code>retain()</code> æ–¹æ³•å°† ByteBuf çš„å¼•ç”¨è®¡æ•°åŠ  1ã€‚å¦å¤–æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ <code>retain(int increment)</code> æ–¹æ³•æ¥æŒ‡å®š refCnt å¢åŠ çš„å¤§å°ï¼ˆincrementï¼‰ã€‚</p> <p>æœ‰å¯¹ ByteBuf çš„å¼•ç”¨é‚£ä¹ˆå°±æœ‰å¯¹ ByteBuf çš„é‡Šæ”¾ï¼Œæ¯å½“æˆ‘ä»¬ä½¿ç”¨å®Œ ByteBuf çš„æ—¶å€™å°±éœ€è¦æ‰‹åŠ¨è°ƒç”¨ <code>release()</code> æ–¹æ³•å°† ByteBuf çš„å¼•ç”¨è®¡æ•°å‡ 1 ã€‚å½“å¼•ç”¨è®¡æ•° refCnt å˜æˆ 0 çš„æ—¶å€™ï¼ŒNetty å°±ä¼šé€šè¿‡ <code>deallocate</code> æ–¹æ³•æ¥é‡Šæ”¾ ByteBuf æ‰€å¼•ç”¨çš„å†…å­˜èµ„æºã€‚è¿™æ—¶ <code>release()</code> æ–¹æ³•ä¼šè¿”å› true , å¦‚æœ refCnt è¿˜ä¸ä¸º 0 ï¼Œé‚£ä¹ˆå°±è¿”å› false ã€‚åŒæ ·æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ <code>release(int decrement)</code> æ–¹æ³•æ¥æŒ‡å®š refCnt å‡å°‘å¤šå°‘ï¼ˆdecrementï¼‰ã€‚</p> <h4 id="_2-6-1-ä¸ºä»€ä¹ˆè¦å¼•å…¥å¼•ç”¨è®¡æ•°"><a href="#_2-6-1-ä¸ºä»€ä¹ˆè¦å¼•å…¥å¼•ç”¨è®¡æ•°" class="header-anchor">#</a> <strong>2.6.1 ä¸ºä»€ä¹ˆè¦å¼•å…¥å¼•ç”¨è®¡æ•°</strong></h4> <p>â€åœ¨å…¶ä»–ä¸Šä¸‹æ–‡ä¸­å¼•ç”¨ ByteBuf â€œ æ˜¯ä»€ä¹ˆæ„æ€å‘¢ ï¼Ÿ æ¯”å¦‚æˆ‘ä»¬åœ¨çº¿ç¨‹ 1 ä¸­åˆ›å»ºäº†ä¸€ä¸ª  ByteBufï¼Œç„¶åå°†è¿™ä¸ª ByteBuf ä¸¢ç»™çº¿ç¨‹ 2 è¿›è¡Œå¤„ç†ï¼Œçº¿ç¨‹ 2 åˆå¯èƒ½ä¸¢ç»™çº¿ç¨‹ 3ï¼Œ è€Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ä¸Šä¸‹æ–‡å¤„ç†é€»è¾‘ï¼Œæ¯”å¦‚å¯¹ ByteBuf çš„å¤„ç†ï¼Œé‡Šæ”¾ç­‰æ“ä½œã€‚è¿™æ ·å°±ä½¿å¾— ByteBuf åœ¨äº‹å®ä¸Šå½¢æˆäº†åœ¨å¤šä¸ªçº¿ç¨‹ä¸Šä¸‹æ–‡ä¸­è¢«å…±äº«çš„æƒ…å†µã€‚</p> <p>é¢å¯¹è¿™ç§æƒ…å†µæˆ‘ä»¬å°±å¾ˆéš¾åœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸Šä¸‹æ–‡ä¸­åˆ¤æ–­ä¸€ä¸ª ByteBuf è¯¥ä¸è¯¥è¢«é‡Šæ”¾ï¼Œæ¯”å¦‚çº¿ç¨‹  1 å‡†å¤‡é‡Šæ”¾ ByteBuf äº†ï¼Œä½†æ˜¯å®ƒå¯èƒ½æ­£åœ¨è¢«å…¶ä»–çº¿ç¨‹ä½¿ç”¨ã€‚æ‰€ä»¥è¿™ä¹Ÿæ˜¯ Netty ä¸º ByteBuf å¼•å…¥å¼•ç”¨è®¡æ•°çš„é‡è¦åŸå› ï¼Œæ¯å½“å¼•ç”¨ä¸€æ¬¡ ByteBuf çš„æ—¶å€™å°±éœ€è¦é€šè¿‡ <code>retain()</code> æ–¹æ³•å°†å¼•ç”¨è®¡æ•°åŠ  1ï¼Œ <code>release()</code> é‡Šæ”¾çš„æ—¶å€™å°†å¼•ç”¨è®¡æ•°å‡ 1 ï¼Œå½“å¼•ç”¨è®¡æ•°ä¸º 0 äº†ï¼Œè¯´æ˜å·²ç»æ²¡æœ‰å…¶ä»–ä¸Šä¸‹æ–‡å¼•ç”¨ ByteBuf äº†ï¼Œè¿™æ—¶ Netty å°±å¯ä»¥é‡Šæ”¾å®ƒäº†ã€‚</p> <p>å¦å¤–ç›¸æ¯”äº JDK DirectByteBuffer éœ€è¦ä¾èµ– GC æœºåˆ¶æ¥é‡Šæ”¾å…¶èƒŒåå¼•ç”¨çš„ Native Memory , Netty æ›´å€¾å‘äºæ‰‹åŠ¨åŠæ—¶é‡Šæ”¾ DirectByteBuf ã€‚å› ä¸º JDK DirectByteBuffer çš„é‡Šæ”¾éœ€è¦ç­‰åˆ° GC å‘ç”Ÿï¼Œç”±äº DirectByteBuffer çš„å¯¹è±¡å®ä¾‹æ‰€å çš„ JVM å †å†…å­˜å¤ªå°äº†ï¼Œæ‰€ä»¥ä¸€æ—¶å¾ˆéš¾è§¦å‘ GC , è¿™å°±å¯¼è‡´è¢«å¼•ç”¨çš„ Native Memory çš„é‡Šæ”¾æœ‰äº†ä¸€å®šçš„å»¶è¿Ÿï¼Œä¸¥é‡çš„æƒ…å†µä¼šè¶Šç§¯è¶Šå¤šï¼Œå¯¼è‡´ OOM ã€‚è€Œä¸”ä¹Ÿä¼šå¯¼è‡´è¿›ç¨‹ä¸­å¯¹ DirectByteBuffer çš„ç”³è¯·æ“ä½œæœ‰éå¸¸å¤§çš„å»¶è¿Ÿã€‚</p> <p>è€Œ Netty ä¸ºäº†é¿å…è¿™äº›æƒ…å†µçš„å‡ºç°ï¼Œé€‰æ‹©åœ¨æ¯æ¬¡ä½¿ç”¨å®Œæ¯•ä¹‹åæ‰‹åŠ¨é‡Šæ”¾ Native Memory ï¼Œä½†æ˜¯ä¸ä¾èµ– JVM çš„è¯ï¼Œæ€»ä¼šæœ‰å†…å­˜æ³„éœ²çš„æƒ…å†µï¼Œæ¯”å¦‚åœ¨ä½¿ç”¨å®Œäº† ByteBuf å´å¿˜è®°è°ƒç”¨ <code>release()</code> æ–¹æ³•æ¥é‡Šæ”¾ã€‚</p> <p>æ‰€ä»¥ä¸ºäº†æ£€æµ‹å†…å­˜æ³„éœ²çš„å‘ç”Ÿï¼Œè¿™ä¹Ÿæ˜¯ Netty ä¸º ByteBuf å¼•å…¥äº†å¼•ç”¨è®¡æ•°çš„å¦ä¸€ä¸ªåŸå› ï¼Œå½“ ByteBuf ä¸å†è¢«å¼•ç”¨çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰ä»»ä½•å¼ºå¼•ç”¨æˆ–è€…è½¯å¼•ç”¨çš„æ—¶å€™ï¼Œå¦‚æœæ­¤æ—¶å‘ç”Ÿ GC , é‚£ä¹ˆè¿™ä¸ª ByteBuf å®ä¾‹ï¼ˆä½äº JVM å †ä¸­ï¼‰å°±éœ€è¦è¢«å›æ”¶äº†ï¼Œè¿™æ—¶ Netty å°±ä¼šæ£€æŸ¥è¿™ä¸ª ByteBuf çš„å¼•ç”¨è®¡æ•°æ˜¯å¦ä¸º 0 ï¼Œ å¦‚æœä¸ä¸º 0 ï¼Œè¯´æ˜æˆ‘ä»¬å¿˜è®°è°ƒç”¨ <code>release()</code> é‡Šæ”¾äº†ï¼Œè¿‘è€Œåˆ¤æ–­å‡ºè¿™ä¸ª ByteBuf å‘ç”Ÿäº†å†…å­˜æ³„éœ²ã€‚</p> <p>åœ¨æ¢æµ‹åˆ°å†…å­˜æ³„éœ²å‘ç”Ÿä¹‹åï¼Œåç»­ Netty å°±ä¼šé€šè¿‡ <code>reportLeak()</code> å°†å†…å­˜æ³„éœ²çš„ç›¸å…³ä¿¡æ¯ä»¥ <code>error</code> çš„æ—¥å¿—çº§åˆ«è¾“å‡ºåˆ°æ—¥å¿—ä¸­ã€‚</p> <p>çœ‹åˆ°è¿™é‡Œï¼Œå¤§å®¶å¯èƒ½ä¸ç¦è¦é—®ï¼Œä¸å°±æ˜¯å¼•å…¥äº†ä¸€ä¸ªå°å°çš„å¼•ç”¨è®¡æ•°å˜›ï¼Œè¿™æœ‰ä½•éš¾ ï¼Ÿ å€¼å¾—è¿™é‡Œå¤§ä¹¦ç‰¹ä¹¦å— ï¼Ÿ ä¸å°±æ˜¯åœ¨åˆ›å»º ByteBuf çš„æ—¶å€™å°†å¼•ç”¨è®¡æ•° refCnt åˆå§‹åŒ–ä¸º 1 ï¼Œ æ¯æ¬¡åœ¨å…¶ä»–ä¸Šä¸‹æ–‡å¼•ç”¨çš„æ—¶å€™å°† refCnt åŠ  1ï¼Œ æ¯æ¬¡é‡Šæ”¾çš„æ—¶å€™å†å°† refCnt å‡ 1 å— ï¼Ÿå‡åˆ° 0 çš„æ—¶å€™å°±é‡Šæ”¾ Native Memory  ï¼Œå¤ªç®€å•äº†å§~~</p> <p>äº‹å®ä¸Š Netty å¯¹å¼•ç”¨è®¡æ•°çš„è®¾è®¡éå¸¸è®²ç©¶ï¼Œç»éå¦‚æ­¤ç®€å•ï¼Œç”šè‡³æœ‰äº›å¤æ‚ï¼Œå…¶èƒŒåéšè—ç€å¤§å¤§çš„æ€§èƒ½è€ƒç©¶ä»¥åŠå¯¹å¤æ‚å¹¶å‘é—®é¢˜çš„å…¨é¢è€ƒè™‘ï¼Œåœ¨æ€§èƒ½ä¸çº¿ç¨‹å®‰å…¨é—®é¢˜ä¹‹é—´çš„åå¤æƒè¡¡ã€‚</p> <h4 id="_2-6-2-å¼•ç”¨è®¡æ•°çš„æœ€åˆè®¾è®¡"><a href="#_2-6-2-å¼•ç”¨è®¡æ•°çš„æœ€åˆè®¾è®¡" class="header-anchor">#</a> <strong>2.6.2 å¼•ç”¨è®¡æ•°çš„æœ€åˆè®¾è®¡</strong></h4> <p>æ‰€ä»¥ä¸ºäº†ç†æ¸…å…³äºå¼•ç”¨è®¡æ•°çš„æ•´ä¸ªè®¾è®¡è„‰ç»œï¼Œæˆ‘ä»¬éœ€è¦å°†ç‰ˆæœ¬å›é€€åˆ°æœ€åˆçš„èµ·ç‚¹ â€”â€” 4.1.16.Final ç‰ˆæœ¬ï¼Œæ¥çœ‹ä¸€ä¸‹åŸå§‹çš„è®¾è®¡ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public abstract class AbstractReferenceCountedByteBuf extends AbstractByteBuf {
    // åŸå­æ›´æ–° refCnt çš„ Updater
    private static final AtomicIntegerFieldUpdater&lt;AbstractReferenceCountedByteBuf&gt; refCntUpdater =
            AtomicIntegerFieldUpdater.newUpdater(AbstractReferenceCountedByteBuf.class, &quot;refCnt&quot;);
    // å¼•ç”¨è®¡æ•°ï¼Œåˆå§‹åŒ–ä¸º 1
    private volatile int refCnt;

    protected AbstractReferenceCountedByteBuf(int maxCapacity) {
        super(maxCapacity);
        // å¼•ç”¨è®¡æ•°åˆå§‹åŒ–ä¸º 1
        refCntUpdater.set(this, 1);
    }

    // å¼•ç”¨è®¡æ•°å¢åŠ  increment
    private ByteBuf retain0(int increment) {
        for (;;) {
            int refCnt = this.refCnt;
            // æ¯æ¬¡ retain çš„æ—¶å€™å¯¹å¼•ç”¨è®¡æ•°åŠ  1
            final int nextCnt = refCnt + increment;

            // Ensure we not resurrect (which means the refCnt was 0) and also that we encountered an overflow.
            if (nextCnt &lt;= increment) {
                // å¦‚æœ refCnt å·²ç»ä¸º 0 æˆ–è€…å‘ç”Ÿæº¢å‡ºï¼Œåˆ™æŠ›å¼‚å¸¸
                throw new IllegalReferenceCountException(refCnt, increment);
            }
            // CAS æ›´æ–° refCnt
            if (refCntUpdater.compareAndSet(this, refCnt, nextCnt)) {
                break;
            }
        }
        return this;
    }

    // å¼•ç”¨è®¡æ•°å‡å°‘ decrement
    private boolean release0(int decrement) {
        for (;;) {
            int refCnt = this.refCnt;
            if (refCnt &lt; decrement) {
                // å¼•ç”¨çš„æ¬¡æ•°å¿…é¡»å’Œé‡Šæ”¾çš„æ¬¡æ•°ç›¸ç­‰å¯¹åº”
                throw new IllegalReferenceCountException(refCnt, -decrement);
            }
            // æ¯æ¬¡ release å¼•ç”¨è®¡æ•°å‡ 1 
            // CAS æ›´æ–° refCnt
            if (refCntUpdater.compareAndSet(this, refCnt, refCnt - decrement)) {
                if (refCnt == decrement) {
                    // å¦‚æœå¼•ç”¨è®¡æ•°ä¸º 0 ï¼Œåˆ™é‡Šæ”¾ Native Memoryï¼Œå¹¶è¿”å› true
                    deallocate();
                    return true;
                }
                // å¼•ç”¨è®¡æ•°ä¸ä¸º 0 ï¼Œè¿”å› false
                return false;
            }
        }
    }
}
</code></pre></div><p>åœ¨ 4.1.16.Final ä¹‹å‰çš„ç‰ˆæœ¬è®¾è®¡ä¸­ï¼Œç¡®å®å’Œæˆ‘ä»¬å½“åˆæƒ³è±¡çš„ä¸€æ ·ï¼Œéå¸¸ç®€å•ï¼Œåˆ›å»º ByteBuf çš„æ—¶å€™å°† refCnt åˆå§‹åŒ–ä¸º 1ã€‚ æ¯æ¬¡å¼•ç”¨ retain çš„æ—¶å€™å°†å¼•ç”¨è®¡æ•°åŠ  1 ï¼Œæ¯æ¬¡é‡Šæ”¾ release çš„æ—¶å€™å°†å¼•ç”¨è®¡æ•°å‡ 1ï¼Œåœ¨ä¸€ä¸ª for å¾ªç¯ä¸­é€šè¿‡ CAS æ›¿æ¢ã€‚å½“å¼•ç”¨è®¡æ•°ä¸º 0 çš„æ—¶å€™ï¼Œé€šè¿‡ <code>deallocate()</code> é‡Šæ”¾ Native Memoryã€‚</p> <h4 id="_2-6-3-å¼•å…¥æŒ‡ä»¤çº§åˆ«ä¸Šçš„ä¼˜åŒ–"><a href="#_2-6-3-å¼•å…¥æŒ‡ä»¤çº§åˆ«ä¸Šçš„ä¼˜åŒ–" class="header-anchor">#</a> <strong>2.6.3 å¼•å…¥æŒ‡ä»¤çº§åˆ«ä¸Šçš„ä¼˜åŒ–</strong></h4> <p>4.1.16.Final çš„è®¾è®¡ç®€æ´æ¸…æ™°ï¼Œåœ¨æˆ‘ä»¬çœ‹æ¥å®Œå…¨æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä½† Netty å¯¹æ€§èƒ½çš„è€ƒç©¶å®Œå…¨æ²¡æœ‰å› æ­¤æ­¢æ­¥ï¼Œç”±äºåœ¨ x86 æ¶æ„ä¸‹ XADD æŒ‡ä»¤çš„æ€§èƒ½è¦é«˜äº CMPXCHG æŒ‡ä»¤ï¼Œ compareAndSet æ–¹æ³•åº•å±‚æ˜¯é€šè¿‡ CMPXCHG æŒ‡ä»¤å®ç°çš„ï¼Œè€Œ getAndAdd æ–¹æ³•åº•å±‚æ˜¯ XADD æŒ‡ä»¤ã€‚</p> <p>æ‰€ä»¥åœ¨å¯¹æ€§èƒ½æè‡´çš„è¿½æ±‚ä¸‹ï¼ŒNetty åœ¨ 4.1.17.Final ç‰ˆæœ¬ä¸­ç”¨ getAndAdd æ–¹æ³•æ¥æ›¿æ¢ compareAndSet æ–¹æ³•ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public abstract class AbstractReferenceCountedByteBuf extends AbstractByteBuf {

    private volatile int refCnt;

    protected AbstractReferenceCountedByteBuf(int maxCapacity) {
        super(maxCapacity);
        // å¼•ç”¨è®¡æ•°åœ¨åˆå§‹çš„æ—¶å€™è¿˜æ˜¯ä¸º 1 
        refCntUpdater.set(this, 1);
    }

    private ByteBuf retain0(final int increment) {
        // ç›¸æ¯”äº compareAndSet çš„å®ç°ï¼Œè¿™é‡Œå°† for å¾ªç¯å»æ‰
        // å¹¶ä¸”æ¯æ¬¡æ˜¯å…ˆå¯¹ refCnt å¢åŠ è®¡æ•° increment
        int oldRef = refCntUpdater.getAndAdd(this, increment);
        // å¢åŠ å®Œ refCnt è®¡æ•°ä¹‹åæ‰å»åˆ¤æ–­å¼‚å¸¸æƒ…å†µ
        if (oldRef &lt;= 0 || oldRef + increment &lt; oldRef) {
            // Ensure we don't resurrect (which means the refCnt was 0) and also that we encountered an overflow.
            // å¦‚æœåŸæ¥çš„ refCnt å·²ç»ä¸º 0 æˆ–è€… refCnt æº¢å‡ºï¼Œåˆ™å¯¹ refCnt è¿›è¡Œå›é€€ï¼Œå¹¶æŠ›å‡ºå¼‚å¸¸
            refCntUpdater.getAndAdd(this, -increment);
            throw new IllegalReferenceCountException(oldRef, increment);
        }
        return this;
    }

    private boolean release0(int decrement) {
        // å…ˆå¯¹ refCnt å‡å°‘è®¡æ•° decrement
        int oldRef = refCntUpdater.getAndAdd(this, -decrement);
        // å¦‚æœ refCnt å·²ç»ä¸º 0 åˆ™è¿›è¡Œ Native Memory çš„é‡Šæ”¾
        if (oldRef == decrement) {
            deallocate();
            return true;
        } else if (oldRef &lt; decrement || oldRef - decrement &gt; oldRef) {
            // å¦‚æœé‡Šæ”¾æ¬¡æ•°å¤§äº retain æ¬¡æ•° æˆ–è€… refCnt å‡ºç°ä¸‹æº¢
            // åˆ™å¯¹ refCnt è¿›è¡Œå›é€€ï¼Œå¹¶æŠ›å‡ºå¼‚å¸¸
            refCntUpdater.getAndAdd(this, decrement);
            throw new IllegalReferenceCountException(oldRef, decrement);
        }
        return false;
    }
}
</code></pre></div><p>åœ¨ 4.1.16.Final ç‰ˆæœ¬çš„å®ç°ä¸­ï¼ŒNetty æ˜¯åœ¨ä¸€ä¸ª for å¾ªç¯ä¸­ï¼Œå…ˆå¯¹ retain å’Œ release çš„å¼‚å¸¸æƒ…å†µè¿›è¡Œæ ¡éªŒï¼Œä¹‹åå†é€šè¿‡ CAS æ›´æ–° refCntã€‚å¦åˆ™ç›´æ¥æŠ›å‡º IllegalReferenceCountExceptionã€‚é‡‡ç”¨çš„æ˜¯ä¸€ç§æ‚²è§‚æ›´æ–°å¼•ç”¨è®¡æ•°çš„ç­–ç•¥ã€‚</p> <p>è€Œåœ¨ 4.1.17.Final ç‰ˆæœ¬çš„å®ç°ä¸­ ï¼Œ Netty å»æ‰äº† for å¾ªç¯ï¼Œæ­£å¥½å’Œ compareAndSet çš„å®ç°ç›¸åï¼Œè€Œæ˜¯å…ˆé€šè¿‡ getAndAdd æ›´æ–° refCntï¼Œæ›´æ–°ä¹‹åå†æ¥åˆ¤æ–­ç›¸å…³çš„å¼‚å¸¸æƒ…å†µï¼Œå¦‚æœå‘ç°æœ‰å¼‚å¸¸ï¼Œåˆ™è¿›è¡Œå›é€€ï¼Œå¹¶æŠ›å‡º IllegalReferenceCountExceptionã€‚é‡‡ç”¨çš„æ˜¯ä¸€ç§ä¹è§‚æ›´æ–°å¼•ç”¨è®¡æ•°çš„ç­–ç•¥ã€‚</p> <p>æ¯”å¦‚åœ¨ retain å¢åŠ å¼•ç”¨è®¡æ•°çš„æ—¶å€™ï¼Œå…ˆå¯¹ refCnt å¢åŠ è®¡æ•° incrementï¼Œç„¶ååˆ¤æ–­åŸæ¥çš„å¼•ç”¨è®¡æ•° oldRef æ˜¯å¦å·²ç»ä¸º 0 æˆ–è€… refCnt æ˜¯å¦å‘ç”Ÿæº¢å‡ºï¼Œå¦‚æœæ˜¯ï¼Œåˆ™éœ€è¦å¯¹ refCnt çš„å€¼è¿›è¡Œå›é€€ï¼Œå¹¶æŠ›å¼‚å¸¸ã€‚</p> <p>åœ¨ release å‡å°‘å¼•ç”¨è®¡æ•°çš„æ—¶å€™ï¼Œå…ˆå¯¹ refCnt å‡å°‘è®¡æ•° decrementï¼Œç„¶ååˆ¤æ–­ release çš„æ¬¡æ•°æ˜¯å¦å¤§äº retain çš„æ¬¡æ•°é˜²æ­¢ over-release ï¼Œä»¥åŠ refCnt æ˜¯å¦å‘ç”Ÿä¸‹æº¢ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å¯¹  refCnt çš„å€¼è¿›è¡Œå›é€€ï¼Œå¹¶æŠ›å¼‚å¸¸ã€‚</p> <h4 id="_2-6-4-å¹¶å‘å®‰å…¨é—®é¢˜çš„å¼•å…¥"><a href="#_2-6-4-å¹¶å‘å®‰å…¨é—®é¢˜çš„å¼•å…¥" class="header-anchor">#</a> <strong>2.6.4 å¹¶å‘å®‰å…¨é—®é¢˜çš„å¼•å…¥</strong></h4> <p>åœ¨ 4.1.17.Final ç‰ˆæœ¬çš„è®¾è®¡ä¸­ï¼Œæˆ‘ä»¬å¯¹å¼•ç”¨è®¡æ•°çš„ retain ä»¥åŠ release æ“ä½œéƒ½è¦æ¯” 4.1.16.Final ç‰ˆæœ¬çš„æ€§èƒ½è¦é«˜ï¼Œè™½ç„¶ç°åœ¨æ€§èƒ½æ˜¯é«˜äº†ï¼Œä½†æ˜¯åŒæ—¶å¼•å…¥äº†æ–°çš„å¹¶å‘é—®é¢˜ã€‚</p> <p>è®©æˆ‘ä»¬å…ˆå‡è®¾ä¸€ä¸ªè¿™æ ·çš„åœºæ™¯ï¼Œç°åœ¨æœ‰ä¸€ä¸ª ByteBufï¼Œå®ƒå½“å‰çš„ refCnt = 1 ï¼Œçº¿ç¨‹ 1 å¯¹è¿™ä¸ª ByteBuf æ‰§è¡Œ <code>release()</code> æ“ä½œã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>åœ¨ 4.1.17.Final çš„å®ç°ä¸­ï¼ŒNetty ä¼šé¦–å…ˆé€šè¿‡ getAndAdd å°† refCnt æ›´æ–°ä¸º 0 ï¼Œç„¶åæ¥ç€è°ƒç”¨ <code>deallocate()</code> æ–¹æ³•é‡Šæ”¾ Native Memory ï¼Œå¾ˆç®€å•ä¹Ÿå¾ˆæ¸…æ™°æ˜¯å§ï¼Œè®©æˆ‘ä»¬å†åŠ ç‚¹å¹¶å‘å¤æ‚åº¦ä¸Šå»ã€‚</p> <p>ç°åœ¨æˆ‘ä»¬åœ¨ä¸Šå›¾æ­¥éª¤ä¸€ä¸æ­¥éª¤äºŒä¹‹é—´æ’å…¥ä¸€ä¸ªçº¿ç¨‹ 2 ï¼Œ çº¿ç¨‹ 2 å¯¹è¿™ä¸ª ByteBuf å¹¶å‘æ‰§è¡Œ <code>retain()</code> æ–¹æ³•ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>åœ¨ 4.1.17.Final çš„å®ç°ä¸­ï¼Œçº¿ç¨‹ 2 é¦–å…ˆé€šè¿‡ getAndAdd å°† refCnt ä» 0 æ›´æ–°ä¸º 1ï¼Œç´§æ¥ç€çº¿ç¨‹ 2 å°±ä¼šå‘ç° refCnt åŸæ¥çš„å€¼ oldRef æ˜¯ç­‰äº 0 çš„ï¼Œä¹Ÿå°±æ˜¯è¯´çº¿ç¨‹ 2 åœ¨è°ƒç”¨  <code>retain()</code> çš„æ—¶å€™ï¼ŒByteBuf çš„å¼•ç”¨è®¡æ•°å·²ç»ä¸º 0 äº†ï¼Œå¹¶ä¸”çº¿ç¨‹ 1 å·²ç»å¼€å§‹å‡†å¤‡é‡Šæ”¾ Native Memory äº†ã€‚</p> <p>æ‰€ä»¥çº¿ç¨‹ 2 éœ€è¦å†æ¬¡è°ƒç”¨ getAndAdd æ–¹æ³•å°† refCnt çš„å€¼è¿›è¡Œå›é€€ï¼Œä» 1 å†æ¬¡å›é€€åˆ° 0 ï¼Œæœ€åæŠ›å‡º IllegalReferenceCountExceptionã€‚è¿™æ ·çš„ç»“æœæ˜¾ç„¶æ˜¯æ­£ç¡®çš„ï¼Œä¹Ÿæ˜¯ç¬¦åˆè¯­ä¹‰çš„ã€‚æ¯•ç«Ÿä¸èƒ½å¯¹ä¸€ä¸ªå¼•ç”¨è®¡æ•°ä¸º 0  çš„ ByteBuf è°ƒç”¨ <code>retain()</code> ã€‚</p> <p>ç°åœ¨çœ‹æ¥ä¸€åˆ‡é£å¹³æµªé™ï¼Œéƒ½æ˜¯æŒ‰ç…§æˆ‘ä»¬çš„è®¾æƒ³æœ‰æ¡ä¸ç´Šçš„è¿›è¡Œï¼Œæˆ‘ä»¬ä¸å¦¨å†åŠ ç‚¹å¹¶å‘å¤æ‚åº¦ä¸Šå»ã€‚åœ¨ä¸Šå›¾æ­¥éª¤ 1.1 ä¸æ­¥éª¤ 1.2 ä¹‹é—´åœ¨æ’å…¥ä¸€ä¸ªçº¿ç¨‹ 3 ï¼Œ çº¿ç¨‹ 3 å¯¹è¿™ä¸ª ByteBuf å†æ¬¡å¹¶å‘æ‰§è¡Œ <code>retain()</code> æ–¹æ³•ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>ç”±äºå¼•ç”¨è®¡æ•°çš„æ›´æ–°ï¼ˆæ­¥éª¤ 1.1ï¼‰ä¸å¼•ç”¨è®¡æ•°çš„å›é€€ï¼ˆæ­¥éª¤ 1.2ï¼‰è¿™ä¸¤ä¸ªæ“ä½œå¹¶ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œå¦‚æœåœ¨è¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´ä¸å·§æ’å…¥äº†ä¸€ä¸ªçº¿ç¨‹ 3 ï¼Œçº¿ç¨‹ 3 åœ¨å¹¶å‘æ‰§è¡Œ <code>retain()</code> æ–¹æ³•çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šé€šè¿‡ getAndAdd å°†å¼•ç”¨è®¡æ•° refCnt ä» 1 å¢åŠ åˆ° 2 ã€‚</p> <blockquote><p><strong>æ³¨æ„ï¼Œæ­¤æ—¶çº¿ç¨‹ 2 è¿˜æ²¡æ¥å¾—åŠå›é€€ refCnt ï¼Œ æ‰€ä»¥çº¿ç¨‹ 3 æ­¤æ—¶çœ‹åˆ°çš„ refCnt æ˜¯ 1 è€Œä¸æ˜¯ 0</strong> ã€‚</p></blockquote> <p>ç”±äºæ­¤æ—¶çº¿ç¨‹ 3 çœ‹åˆ°çš„ oldRef æ˜¯ 1 ï¼Œæ‰€ä»¥çº¿ç¨‹ 3 æˆåŠŸè°ƒç”¨ <code>retain()</code> æ–¹æ³•å°† ByteBuf çš„å¼•ç”¨è®¡æ•°å¢åŠ åˆ°äº† 2 ï¼Œå¹¶ä¸”ä¸ä¼šå›é€€ä¹Ÿä¸ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚åœ¨çº¿ç¨‹ 3 çœ‹æ¥æ­¤æ—¶çš„ ByteBuf å®Œå®Œå…¨å…¨æ˜¯ä¸€ä¸ªæ­£å¸¸å¯ä»¥è¢«ä½¿ç”¨çš„ ByteBufã€‚</p> <p>ç´§æ¥ç€çº¿ç¨‹ 1 å¼€å§‹æ‰§è¡Œæ­¥éª¤ 2 â€”â€” <code>deallocate()</code> æ–¹æ³•é‡Šæ”¾ Native Memoryï¼Œæ­¤åçº¿ç¨‹ 3 åœ¨è®¿é—®è¿™ä¸ª ByteBuf çš„æ—¶å€™å°±æœ‰é—®é¢˜äº†ï¼Œå› ä¸º  Native Memory å·²ç»è¢«çº¿ç¨‹1 é‡Šæ”¾äº†ã€‚</p> <h4 id="_2-6-5-åœ¨æ€§èƒ½ä¸å¹¶å‘å®‰å…¨ä¹‹é—´çš„æƒè¡¡"><a href="#_2-6-5-åœ¨æ€§èƒ½ä¸å¹¶å‘å®‰å…¨ä¹‹é—´çš„æƒè¡¡" class="header-anchor">#</a> <strong>2.6.5 åœ¨æ€§èƒ½ä¸å¹¶å‘å®‰å…¨ä¹‹é—´çš„æƒè¡¡</strong></h4> <p>æ¥ä¸‹æ¥ Netty å°±éœ€è¦åœ¨æ€§èƒ½ä¸å¹¶å‘å®‰å…¨ä¹‹é—´è¿›è¡Œæƒè¡¡äº†ï¼Œç°åœ¨æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼Œç¬¬ä¸€ä¸ªé€‰æ‹©æ˜¯ç›´æ¥å›æ»šåˆ° 4.1.16.Final ç‰ˆæœ¬ï¼Œæ”¾å¼ƒ XADD æŒ‡ä»¤å¸¦æ¥çš„æ€§èƒ½æå‡ï¼Œä¹‹å‰çš„è®¾è®¡ä¸­é‡‡ç”¨çš„ CMPXCHG æŒ‡ä»¤è™½ç„¶æ€§èƒ½ç›¸å¯¹å·®ä¸€äº›ï¼Œä½†æ˜¯ä¸ä¼šå‡ºç°ä¸Šè¿°çš„å¹¶å‘å®‰å…¨é—®é¢˜ã€‚</p> <p>å› ä¸º Netty æ˜¯åœ¨ä¸€ä¸ª for å¾ªç¯ä¸­é‡‡ç”¨æ‚²è§‚çš„ç­–ç•¥æ¥æ›´æ–°å¼•ç”¨è®¡æ•°ï¼Œå…ˆæ˜¯åˆ¤æ–­å¼‚å¸¸æƒ…å†µï¼Œç„¶ååœ¨é€šè¿‡ CAS æ¥æ›´æ–° refCntã€‚å³ä½¿å¤šä¸ªçº¿ç¨‹çœ‹åˆ°äº† refCnt çš„ä¸­é—´çŠ¶æ€ä¹Ÿæ²¡å…³ç³»ï¼Œå› ä¸ºæ¥ä¸‹æ¥è¿›è¡Œçš„ CAS ä¹Ÿä¼šè·Ÿç€å¤±è´¥ã€‚</p> <p>æ¯”å¦‚ä¸Šè¾¹ä¾‹å­ä¸­çš„çº¿ç¨‹ 1 å¯¹ ByteBuf è¿›è¡Œ release çš„æ—¶å€™ï¼Œåœ¨çº¿ç¨‹ 1 æ‰§è¡Œ CAS å°† refCnt æ›¿æ¢ä¸º 0 ä¹‹å‰çš„è¿™ä¸ªé—´éš™ä¸­ï¼ŒrefCnt æ˜¯ 1 ï¼Œå¦‚æœåœ¨è¿™ä¸ªé—´éš™ä¸­ï¼Œçº¿ç¨‹ 2 å¹¶å‘æ‰§è¡Œ retain æ–¹æ³•ï¼Œæ­¤æ—¶çº¿ç¨‹ 2 çœ‹åˆ°çš„ refCnt ç¡®å®ä¸º 1 ï¼Œå®ƒæ˜¯ä¸€ä¸ªä¸­é—´çŠ¶æ€ï¼Œçº¿ç¨‹ 2 æ‰§è¡Œ CAS å°† refCnt æ›¿æ¢ä¸º 2ã€‚</p> <p>æ­¤æ—¶çº¿ç¨‹ 1 æ‰§è¡Œ CAS å°±ä¼šå¤±è´¥ï¼Œä½†ä¼šåœ¨ä¸‹ä¸€è½® for å¾ªç¯ä¸­å°† refCnt æ›¿æ¢ä¸º 1ï¼Œè¿™æ˜¯å®Œå…¨ç¬¦åˆå¼•ç”¨è®¡æ•°è¯­ä¹‰çš„ã€‚</p> <p>å¦å¤–ä¸€ç§æƒ…å†µæ˜¯çº¿ç¨‹ 1 å·²ç»æ‰§è¡Œå®Œ CAS å°† refCnt æ›¿æ¢ä¸º 0 ï¼Œè¿™æ—¶å€™çº¿ç¨‹ 2 å» retain  ï¼Œç”±äº 4.1.16.Final ç‰ˆæœ¬ä¸­çš„è®¾è®¡æ˜¯å…ˆæ£€æŸ¥å¼‚å¸¸å CAS æ›¿æ¢ï¼Œæ‰€ä»¥çº¿ç¨‹ 2 é¦–å…ˆä¼šåœ¨ retain æ–¹æ³•ä¸­æ£€æŸ¥åˆ° ByteBuf çš„ refCnt å·²ç»ä¸º 0 ï¼Œç›´æ¥æŠ›å‡º IllegalReferenceCountExceptionï¼Œå¹¶ä¸ä¼šæ‰§è¡Œ CAS ã€‚è¿™åŒæ ·ç¬¦åˆå¼•ç”¨è®¡æ•°çš„è¯­ä¹‰ï¼Œæ¯•ç«Ÿä¸èƒ½å¯¹ä¸€ä¸ªå¼•ç”¨è®¡æ•°å·²ç»ä¸º 0 çš„ ByteBuf æ‰§è¡Œä»»ä½•è®¿é—®æ“ä½œã€‚</p> <p>ç¬¬äºŒä¸ªé€‰æ‹©æ˜¯æ—¢è¦ä¿ç•™ XADD æŒ‡ä»¤å¸¦æ¥çš„æ€§èƒ½æå‡ï¼Œä¹Ÿè¦è§£å†³ 4.1.17.Final ç‰ˆæœ¬ä¸­å¼•å…¥çš„å¹¶å‘å®‰å…¨é—®é¢˜ã€‚æ¯«æ— ç–‘é—®ï¼ŒNetty æœ€ç»ˆé€‰æ‹©çš„æ˜¯è¿™ç§æ–¹æ¡ˆã€‚</p> <p>åœ¨ä»‹ç» Netty çš„ç²¾å½©è®¾è®¡ä¹‹å‰ï¼Œæˆ‘æƒ³æˆ‘ä»¬è¿˜æ˜¯åº”è¯¥åœ¨å›é¡¾ä¸‹è¿™ä¸ªå¹¶å‘å®‰å…¨é—®é¢˜å‡ºç°çš„æ ¹æœ¬åŸå› æ˜¯ä»€ä¹ˆ ï¼Ÿ</p> <p>åœ¨ 4.1.17.Final ç‰ˆæœ¬çš„è®¾è®¡ä¸­ï¼ŒNetty é¦–å…ˆæ˜¯é€šè¿‡ getAndAdd æ–¹æ³•å…ˆå¯¹ refCnt çš„å€¼è¿›è¡Œæ›´æ–°ï¼Œå¦‚æœå‡ºç°å¼‚å¸¸æƒ…å†µï¼Œåœ¨è¿›è¡Œå›æ»šã€‚è€Œæ›´æ–°ï¼Œå›æ»šçš„è¿™ä¸¤ä¸ªæ“ä½œå¹¶ä¸æ˜¯åŸå­çš„ï¼Œä¹‹é—´çš„ä¸­é—´çŠ¶æ€ä¼šè¢«å…¶ä»–çº¿ç¨‹çœ‹åˆ°ã€‚</p> <p>æ¯”å¦‚ï¼Œçº¿ç¨‹ 2 çœ‹åˆ°äº†çº¿ç¨‹ 1 çš„ä¸­é—´çŠ¶æ€ï¼ˆrefCnt = 0ï¼‰ï¼Œäºæ˜¯å°†å¼•ç”¨è®¡æ•°åŠ åˆ° 1 , åœ¨çº¿ç¨‹ 2 è¿›è¡Œå›æ»šä¹‹å‰ï¼Œè¿™æœŸé—´çš„ä¸­é—´çŠ¶æ€ï¼ˆrefCnt = 1ï¼ŒoldRef = 0ï¼‰åˆè¢«çº¿ç¨‹ 3 çœ‹åˆ°äº†ï¼Œäºæ˜¯çº¿ç¨‹ 3 å°†å¼•ç”¨è®¡æ•°å¢åŠ åˆ°äº† 2 ï¼ˆrefCnt = 2ï¼ŒoldRef = 1ï¼‰ã€‚ æ­¤æ—¶çº¿ç¨‹ 3 è§‰å¾—è¿™æ˜¯ä¸€ç§æ­£å¸¸çš„çŠ¶æ€ï¼Œä½†åœ¨çº¿ç¨‹ 1 çœ‹æ¥ refCnt çš„å€¼å·²ç»æ˜¯ 0 äº†ï¼Œåç»­çº¿ç¨‹ 1 å°±ä¼šé‡Šæ”¾ Native Memory ï¼Œè¿™å°±å‡ºé—®é¢˜äº†ã€‚</p> <p>é—®é¢˜çš„æ ¹æœ¬åŸå› å…¶å®æ˜¯è¿™é‡Œçš„ refCnt ä¸åŒçš„å€¼å‡ä»£è¡¨ä¸åŒçš„è¯­ä¹‰ï¼Œæ¯”å¦‚å¯¹äºçº¿ç¨‹ 1 æ¥è¯´ï¼Œé€šè¿‡ release å°† refCnt å‡åˆ°äº† 0 ï¼Œè¿™é‡Œçš„è¯­ä¹‰æ˜¯ ByteBuf å·²ç»ä¸åœ¨è¢«å¼•ç”¨äº†ï¼Œå¯ä»¥é‡Šæ”¾ Native Memory ã€‚</p> <p>éšåçº¿ç¨‹ 2 é€šè¿‡ retain å°† refCnt åŠ åˆ°äº† 1 ï¼Œè¿™å°±æŠŠ ByteBuf è¯­ä¹‰æ”¹å˜äº†ï¼Œè¡¨ç¤ºè¯¥ ByteBuf åœ¨çº¿ç¨‹ 2 ä¸­è¢«å¼•ç”¨äº†ä¸€æ¬¡ã€‚æœ€åçº¿ç¨‹ 3 åˆé€šè¿‡ retain å°† refCnt åŠ åˆ°äº† 2 ï¼Œå†ä¸€æ¬¡æ”¹å˜äº† ByteBuf çš„è¯­ä¹‰ã€‚</p> <p>åªè¦ç”¨åˆ° XADD æŒ‡ä»¤æ¥å®ç°å¼•ç”¨è®¡æ•°çš„æ›´æ–°ï¼Œé‚£ä¹ˆå°±ä¸å¯é¿å…çš„å‡ºç°ä¸Šè¿°å¹¶å‘æ›´æ–° refCnt çš„æƒ…å†µï¼Œå…³é”®æ˜¯ refCnt çš„å€¼æ¯ä¸€æ¬¡è¢«å…¶ä»–çº¿ç¨‹å¹¶å‘ä¿®æ”¹ä¹‹åï¼ŒByteBuf çš„è¯­ä¹‰å°±å˜äº†ã€‚è¿™æ‰æ˜¯ 4.1.17.Final ç‰ˆæœ¬ä¸­çš„å…³é”®é—®é¢˜æ‰€åœ¨ã€‚</p> <p>å¦‚æœ Netty æƒ³åœ¨åŒæ—¶äº«å— XADD æŒ‡ä»¤å¸¦æ¥çš„æ€§èƒ½æå‡ä¹‹å¤–ï¼Œåˆè¦è§£å†³ä¸Šè¿°æåˆ°çš„å¹¶å‘å®‰å…¨é—®é¢˜ï¼Œå°±è¦é‡æ–°å¯¹å¼•ç”¨è®¡æ•°è¿›è¡Œè®¾è®¡ã€‚é¦–å…ˆæˆ‘ä»¬çš„è¦æ±‚æ˜¯ç»§ç»­é‡‡ç”¨ XADD æŒ‡ä»¤æ¥å®ç°å¼•ç”¨è®¡æ•°çš„æ›´æ–°ï¼Œä½†è¿™å°±ä¼šå¸¦æ¥å¤šçº¿ç¨‹å¹¶å‘ä¿®æ”¹æ‰€å¼•èµ·çš„ ByteBuf è¯­ä¹‰æ”¹å˜ã€‚</p> <p>æ—¢ç„¶å¤šçº¿ç¨‹å¹¶å‘ä¿®æ”¹æ— æ³•é¿å…ï¼Œé‚£ä¹ˆæˆ‘ä»¬èƒ½ä¸èƒ½é‡æ–°è®¾è®¡ä¸€ä¸‹å¼•ç”¨è®¡æ•°ï¼Œè®©  ByteBuf è¯­ä¹‰æ— è®ºå¤šçº¿ç¨‹æ€ä¹ˆä¿®æ”¹ï¼Œå®ƒçš„è¯­ä¹‰å§‹ç»ˆä¿æŒä¸å˜ã€‚ä¹Ÿå°±æ˜¯è¯´åªè¦çº¿ç¨‹ 1 å°† refCnt å‡åˆ°äº† 0 ï¼Œé‚£ä¹ˆæ— è®ºçº¿ç¨‹ 2 å’Œçº¿ç¨‹ 3 æ€ä¹ˆå¹¶å‘ä¿®æ”¹ refCntï¼Œæ€ä¹ˆå¢åŠ  refCnt çš„å€¼ï¼ŒrefCnt ç­‰äº 0 çš„è¿™ä¸ªè¯­ä¹‰å§‹ç»ˆä¿æŒä¸å˜å‘¢ ï¼Ÿ</p> <h4 id="_2-6-6-å¥‡å¶è®¾è®¡çš„å¼•å…¥"><a href="#_2-6-6-å¥‡å¶è®¾è®¡çš„å¼•å…¥" class="header-anchor">#</a> <strong>2.6.6 å¥‡å¶è®¾è®¡çš„å¼•å…¥</strong></h4> <p>è¿™é‡Œ Netty æœ‰ä¸€ä¸ªæå¥‡å·§å¦™ç²¾å½©çš„è®¾è®¡ï¼Œå¼•ç”¨è®¡æ•°çš„è®¾è®¡ä¸å†æ˜¯é€»è¾‘æ„ä¹‰ä¸Šçš„ <code>0 , 1 , 2 , 3 .....</code>ï¼Œè€Œæ˜¯åˆ†ä¸ºäº†ä¸¤å¤§ç±»ï¼Œè¦ä¹ˆæ˜¯å¶æ•°ï¼Œè¦ä¹ˆæ˜¯å¥‡æ•°ã€‚</p> <ul><li>å¶æ•°ä»£è¡¨çš„è¯­ä¹‰æ˜¯ ByteBuf çš„ refCnt ä¸ä¸º 0 ï¼Œä¹Ÿå°±æ˜¯è¯´åªè¦ä¸€ä¸ª ByteBuf è¿˜åœ¨è¢«å¼•ç”¨ï¼Œé‚£ä¹ˆå®ƒçš„ refCnt å°±æ˜¯ä¸€ä¸ªå¶æ•°ï¼Œå…·ä½“è¢«å¼•ç”¨å¤šå°‘æ¬¡ï¼Œå¯ä»¥é€šè¿‡ <code>refCnt &gt;&gt;&gt; 1</code> æ¥è·å–ã€‚</li> <li>å¥‡æ•°ä»£è¡¨çš„è¯­ä¹‰æ˜¯ ByteBuf çš„ refCnt ç­‰äº 0 ï¼Œåªè¦ä¸€ä¸ª ByteBuf å·²ç»æ²¡æœ‰ä»»ä½•åœ°æ–¹å¼•ç”¨å®ƒäº†ï¼Œé‚£ä¹ˆå®ƒçš„ refCnt å°±æ˜¯ä¸€ä¸ªå¥‡æ•°ï¼Œå…¶èƒŒåå¼•ç”¨çš„ Native Memory éšåå°±ä¼šè¢«é‡Šæ”¾ã€‚</li></ul> <p>ByteBuf åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼ŒrefCnt ä¸åœ¨æ˜¯ 1 è€Œæ˜¯è¢«åˆå§‹åŒ–ä¸º 2 ï¼ˆå¶æ•°ï¼‰ï¼Œæ¯æ¬¡ retain çš„æ—¶å€™ä¸åœ¨æ˜¯å¯¹ refCnt åŠ  1 è€Œæ˜¯åŠ  2 ï¼ˆå¶æ•°æ­¥é•¿ï¼‰ï¼Œæ¯æ¬¡ release çš„æ—¶å€™ä¸å†æ˜¯å¯¹  refCnt å‡ 1 è€Œæ˜¯å‡ 2 ï¼ˆåŒæ ·æ˜¯å¶æ•°æ­¥é•¿ï¼‰ã€‚è¿™æ ·ä¸€æ¥ï¼Œåªè¦ä¸€ä¸ª ByteBuf çš„å¼•ç”¨è®¡æ•°ä¸ºå¶æ•°ï¼Œé‚£ä¹ˆå¤šçº¿ç¨‹æ— è®ºæ€ä¹ˆå¹¶å‘è°ƒç”¨ retain æ–¹æ³•ï¼Œå¼•ç”¨è®¡æ•°è¿˜æ˜¯ä¸€ä¸ªå¶æ•°ï¼Œè¯­ä¹‰ä»ç„¶ä¿æŒä¸å˜ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>   public final int initialValue() {
        return 2;
    }
</code></pre></div><p>å½“ä¸€ä¸ª ByteBuf è¢« release åˆ°æ²¡æœ‰ä»»ä½•å¼•ç”¨è®¡æ•°çš„æ—¶å€™ï¼ŒNetty ä¸åœ¨å°† refCnt è®¾ç½®ä¸º 0 è€Œæ˜¯è®¾ç½®ä¸º 1 ï¼ˆå¥‡æ•°ï¼‰ï¼Œå¯¹äºä¸€ä¸ªå€¼ä¸ºå¥‡æ•°çš„ refCntï¼Œæ— è®ºå¤šçº¿ç¨‹æ€ä¹ˆå¹¶å‘è°ƒç”¨ retain æ–¹æ³•å’Œ release æ–¹æ³•ï¼Œå¼•ç”¨è®¡æ•°è¿˜æ˜¯ä¸€ä¸ªå¥‡æ•°ï¼ŒByteBuf å¼•ç”¨è®¡æ•°ä¸º 0 çš„è¿™å±‚è¯­ä¹‰ä¸€ç›´ä¼šä¿æŒä¸å˜ã€‚</p> <p>æˆ‘ä»¬è¿˜æ˜¯ä»¥ä¸Šå›¾ä¸­æ‰€å±•ç¤ºçš„å¹¶å‘å®‰å…¨é—®é¢˜ä¸ºä¾‹ï¼Œåœ¨æ–°çš„å¼•ç”¨è®¡æ•°è®¾è®¡æ–¹æ¡ˆä¸­ï¼Œé¦–å…ˆçº¿ç¨‹ 1 å¯¹ ByteBuf æ‰§è¡Œ release æ–¹æ³•ï¼ŒNetty ä¼šå°† refCnt è®¾ç½®ä¸º 1 ï¼ˆå¥‡æ•°ï¼‰ã€‚</p> <p>çº¿ç¨‹ 2 å¹¶å‘è°ƒç”¨ retain æ–¹æ³•ï¼Œé€šè¿‡ getAndAdd å°† refCnt ä» 1 åŠ åˆ°äº† 3 ï¼ŒrefCnt ä»ç„¶æ˜¯ä¸€ä¸ªå¥‡æ•°ï¼ŒæŒ‰ç…§å¥‡æ•°æ‰€è¡¨ç¤ºçš„è¯­ä¹‰ â€”â€” ByteBuf å¼•ç”¨è®¡æ•°å·²ç»æ˜¯ 0  äº†ï¼Œé‚£ä¹ˆçº¿ç¨‹ 2 å°±ä¼šåœ¨ retain æ–¹æ³•ä¸­æŠ›å‡º IllegalReferenceCountExceptionã€‚</p> <p>çº¿ç¨‹ 3 å¹¶å‘è°ƒç”¨ retain æ–¹æ³•ï¼Œé€šè¿‡ getAndAdd å°† refCnt ä» 3 åŠ åˆ°äº† 5ï¼Œçœ‹åˆ°äº†æ²¡ ï¼Œåœ¨æ–°æ–¹æ¡ˆçš„è®¾è®¡ä¸­ï¼Œæ— è®ºå¤šçº¿ç¨‹æ€ä¹ˆå¹¶å‘æ‰§è¡Œ retain æ–¹æ³•ï¼ŒrefCnt çš„å€¼ä¸€ç›´éƒ½åªä¼šæ˜¯ä¸€ä¸ªå¥‡æ•°ï¼Œéšåçº¿ç¨‹ 3 åœ¨ retain æ–¹æ³•ä¸­æŠ›å‡º IllegalReferenceCountExceptionã€‚è¿™å®Œå…¨ç¬¦åˆå¼•ç”¨è®¡æ•°çš„å¹¶å‘è¯­ä¹‰ã€‚</p> <p>è¿™ä¸ªæ–°çš„å¼•ç”¨è®¡æ•°è®¾è®¡æ–¹æ¡ˆæ˜¯åœ¨ 4.1.32.Final ç‰ˆæœ¬å¼•å…¥è¿›æ¥çš„ï¼Œä»…ä»…é€šè¿‡ä¸€ä¸ªå¥‡å¶è®¾è®¡ï¼Œå°±éå¸¸å·§å¦™çš„è§£å†³äº† 4.1.17.Final ç‰ˆæœ¬ä¸­å­˜åœ¨çš„å¹¶å‘å®‰å…¨é—®é¢˜ã€‚ç°åœ¨æ–°æ–¹æ¡ˆçš„æ ¸å¿ƒè®¾è®¡è¦ç´ æˆ‘ä»¬å·²ç»æ¸…æ¥šäº†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥ç¬”è€…å°†ä»¥ 4.1.56.Final ç‰ˆæœ¬æ¥ä¸ºå¤§å®¶ç»§ç»­ä»‹ç»ä¸‹æ–°æ–¹æ¡ˆçš„å®ç°ç»†èŠ‚ã€‚</p> <p>Netty ä¸­çš„ ByteBuf å…¨éƒ¨ç»§æ‰¿äº AbstractReferenceCountedByteBufï¼Œåœ¨è¿™ä¸ªç±»ä¸­å®ç°äº†æ‰€æœ‰å¯¹ ByteBuf å¼•ç”¨è®¡æ•°çš„æ“ä½œï¼Œå¯¹äº ReferenceCounted æ¥å£çš„å®ç°å°±åœ¨è¿™é‡Œã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public abstract class AbstractReferenceCountedByteBuf extends AbstractByteBuf {
    // è·å– refCnt å­—æ®µåœ¨ ByteBuf å¯¹è±¡å†…å­˜ä¸­çš„åç§»
    // åç»­é€šè¿‡ Unsafe å¯¹ refCnt è¿›è¡Œæ“ä½œ
    private static final long REFCNT_FIELD_OFFSET =
            ReferenceCountUpdater.getUnsafeOffset(AbstractReferenceCountedByteBuf.class, &quot;refCnt&quot;);

    // è·å– refCnt å­—æ®µ çš„ AtomicFieldUpdater
    // åç»­é€šè¿‡ AtomicFieldUpdater æ¥æ“ä½œ refCnt å­—æ®µ
    private static final AtomicIntegerFieldUpdater&lt;AbstractReferenceCountedByteBuf&gt; AIF_UPDATER =
            AtomicIntegerFieldUpdater.newUpdater(AbstractReferenceCountedByteBuf.class, &quot;refCnt&quot;);

    // åˆ›å»º ReferenceCountUpdaterï¼Œå¯¹äºå¼•ç”¨è®¡æ•°çš„æ‰€æœ‰æ“ä½œæœ€ç»ˆéƒ½ä¼šä»£ç†åˆ°è¿™ä¸ªç±»ä¸­
    private static final ReferenceCountUpdater&lt;AbstractReferenceCountedByteBuf&gt; updater =
            new ReferenceCountUpdater&lt;AbstractReferenceCountedByteBuf&gt;() {
        @Override
        protected AtomicIntegerFieldUpdater&lt;AbstractReferenceCountedByteBuf&gt; updater() {
            // é€šè¿‡ AtomicIntegerFieldUpdater æ“ä½œ refCnt å­—æ®µ
            return AIF_UPDATER;
        }
        @Override
        protected long unsafeOffset() {
            // é€šè¿‡ Unsafe æ“ä½œ refCnt å­—æ®µ
            return REFCNT_FIELD_OFFSET;
        }
    };
    // ByteBuf ä¸­çš„å¼•ç”¨è®¡æ•°ï¼Œåˆå§‹ä¸º 2 ï¼ˆå¶æ•°ï¼‰
    private volatile int refCnt = updater.initialValue();
}
</code></pre></div><p>å…¶ä¸­å®šä¹‰äº†ä¸€ä¸ª refCnt å­—æ®µç”¨äºè®°å½• ByteBuf è¢«å¼•ç”¨çš„æ¬¡æ•°ï¼Œç”±äºé‡‡ç”¨äº†å¥‡å¶è®¾è®¡ï¼Œåœ¨åˆ›å»º ByteBuf çš„æ—¶å€™ï¼ŒNetty ä¼šå°† refCnt åˆå§‹åŒ–ä¸º 2 ï¼ˆå¶æ•°ï¼‰ï¼Œå®ƒçš„é€»è¾‘è¯­ä¹‰æ˜¯è¯¥ ByteBuf è¢«å¼•ç”¨ä¸€æ¬¡ã€‚åç»­å¯¹ ByteBuf æ‰§è¡Œ retain å°±ä¼šå¯¹ refCnt è¿›è¡ŒåŠ  2 ï¼Œæ‰§è¡Œ release å°±ä¼šå¯¹ refCnt è¿›è¡Œå‡ 2 ï¼Œå¯¹äºå¼•ç”¨è®¡æ•°çš„å•æ¬¡æ“ä½œéƒ½æ˜¯ä»¥ 2 ä¸ºæ­¥é•¿è¿›è¡Œã€‚</p> <p>ç”±äºåœ¨ Netty ä¸­é™¤äº† AbstractReferenceCountedByteBuf è¿™ä¸ªä¸“é—¨ç”¨äºå®ç° ByteBuf çš„å¼•ç”¨è®¡æ•°åŠŸèƒ½ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªæ›´åŠ é€šç”¨çš„å¼•ç”¨è®¡æ•°æŠ½è±¡ç±» AbstractReferenceCountedï¼Œå®ƒç”¨äºå®ç°æ‰€æœ‰ç³»ç»Ÿèµ„æºç±»çš„å¼•ç”¨è®¡æ•°åŠŸèƒ½ï¼ˆByteBuf åªæ˜¯å…¶ä¸­çš„ä¸€ç§å†…å­˜èµ„æºï¼‰ã€‚</p> <p>ç”±äºéƒ½æ˜¯å¯¹å¼•ç”¨è®¡æ•°çš„å®ç°ï¼Œæ‰€ä»¥åœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œè¿™ä¸¤ä¸ªç±»ä¸­åŒ…å«äº†å¾ˆå¤šé‡å¤çš„å¼•ç”¨è®¡æ•°ç›¸å…³æ“ä½œé€»è¾‘ï¼Œæ‰€ä»¥ Netty åœ¨ 4.1.35.Final  ç‰ˆæœ¬ä¸­ä¸“é—¨å¼•å…¥äº†ä¸€ä¸ª ReferenceCountUpdater ç±»ï¼Œå°†æ‰€æœ‰å¼•ç”¨è®¡æ•°çš„ç›¸å…³å®ç°èšåˆåœ¨è¿™é‡Œã€‚</p> <p>ReferenceCountUpdater å¯¹äºå¼•ç”¨è®¡æ•° refCnt çš„æ“ä½œæœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯é€šè¿‡ AtomicFieldUpdater æ¥å¯¹ refCnt è¿›è¡Œæ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>updater()</code> è·å–åˆ° refCnt å­—æ®µå¯¹åº”çš„ AtomicFieldUpdaterã€‚</p> <p>å¦ä¸€ç§åˆ™æ˜¯é€šè¿‡ Unsafe æ¥å¯¹ refCnt è¿›è¡Œæ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>unsafeOffset()</code> æ¥è·å–åˆ° refCnt å­—æ®µåœ¨ ByteBuf å®ä¾‹å¯¹è±¡å†…å­˜ä¸­çš„åç§»ã€‚</p> <p>æŒ‰ç†æ¥è¯´ï¼Œæˆ‘ä»¬é‡‡ç”¨ä¸€ç§æ–¹å¼å°±å¯ä»¥å¯¹ refCnt è¿›è¡Œè®¿é—®æˆ–è€…æ›´æ–°äº†ï¼Œé‚£ä¸ºä»€ä¹ˆ Netty æä¾›äº†ä¸¤ç§æ–¹å¼å‘¢ ï¼Ÿä¼šæ˜¾å¾—æœ‰ç‚¹å¤šä½™å— ï¼Ÿè¿™ä¸ªç‚¹å¤§å®¶å¯ä»¥å…ˆæ€è€ƒä¸‹ä¸ºä»€ä¹ˆ ï¼Œåç»­åœ¨æˆ‘ä»¬å‰–æåˆ°æºç ç»†èŠ‚çš„æ—¶å€™ç¬”è€…åœ¨ä¸ºå¤§å®¶è§£ç­”ã€‚</p> <p>å¥½äº†ï¼Œä¸‹é¢æˆ‘ä»¬æ­£å¼å¼€å§‹ä»‹ç»æ–°ç‰ˆå¼•ç”¨è®¡æ•°è®¾è®¡æ–¹æ¡ˆçš„å…·ä½“å®ç°ç»†èŠ‚ï¼Œç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨æ–°çš„è®¾è®¡æ–¹æ¡ˆä¸­ï¼Œæˆ‘ä»¬å¦‚ä½•è·å– ByteBuf çš„é€»è¾‘å¼•ç”¨è®¡æ•° ï¼Ÿ</p> <div class="language- extra-class"><pre class="language-text"><code>public abstract class ReferenceCountUpdater&lt;T extends ReferenceCounted&gt; {
    public final int initialValue() {
        // ByteBuf å¼•ç”¨è®¡æ•°åˆå§‹åŒ–ä¸º 2
        return 2;
    }

    public final int refCnt(T instance) {
        // é€šè¿‡ updater è·å– refCnt
        // æ ¹æ® refCnt åœ¨  realRefCnt ä¸­è·å–çœŸå®çš„å¼•ç”¨è®¡æ•°
        return realRefCnt(updater().get(instance));
    }
    // è·å– ByteBuf çš„é€»è¾‘å¼•ç”¨è®¡æ•°
    private static int realRefCnt(int rawCnt) {
        // å¥‡å¶åˆ¤æ–­
        return rawCnt != 2 &amp;&amp; rawCnt != 4 &amp;&amp; (rawCnt &amp; 1) != 0 ? 0 : rawCnt &gt;&gt;&gt; 1;
    }
}
</code></pre></div><p>ç”±äºé‡‡ç”¨äº†å¥‡å¶å¼•ç”¨è®¡æ•°çš„è®¾è®¡ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è·å–é€»è¾‘å¼•ç”¨è®¡æ•°çš„æ—¶å€™éœ€è¦åˆ¤æ–­å½“å‰ rawCntï¼ˆrefCntï¼‰æ˜¯å¥‡æ•°è¿˜æ˜¯å¶æ•°ï¼Œå®ƒä»¬åˆ†åˆ«ä»£è¡¨äº†ä¸åŒçš„è¯­ä¹‰ã€‚</p> <ul><li>å¦‚æœ rawCnt æ˜¯å¥‡æ•°ï¼Œåˆ™è¡¨ç¤ºå½“å‰ ByteBuf å·²ç»æ²¡æœ‰ä»»ä½•åœ°æ–¹å¼•ç”¨äº†ï¼Œé€»è¾‘å¼•ç”¨è®¡æ•°è¿”å› 0.</li> <li>å¦‚æœ rawCnt æ˜¯å¶æ•°ï¼Œåˆ™è¡¨ç¤ºå½“å‰ ByteBuf è¿˜æœ‰åœ°æ–¹åœ¨å¼•ç”¨ï¼Œé€»è¾‘å¼•ç”¨è®¡æ•°åˆ™ä¸º <code>rawCnt &gt;&gt;&gt; 1</code>ã€‚</li></ul> <p>realRefCnt å‡½æ•°å…¶å®å°±æ˜¯ç®€å•çš„ä¸€ä¸ªå¥‡å¶åˆ¤æ–­é€»è¾‘ï¼Œä½†åœ¨å®ƒçš„å®ç°ä¸­å´ä½“ç°å‡ºäº† Netty å¯¹æ€§èƒ½çš„æè‡´è¿½æ±‚ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬åˆ¤æ–­ä¸€ä¸ªæ•°æ˜¯å¥‡æ•°è¿˜æ˜¯å¶æ•°å…¶å®å¾ˆç®€å•ï¼Œç›´æ¥é€šè¿‡  <code>rawCnt &amp; 1</code> å°±å¯ä»¥åˆ¤æ–­ï¼Œå¦‚æœè¿”å› 0 è¡¨ç¤º rawCnt æ˜¯ä¸€ä¸ªå¶æ•°ï¼Œå¦‚æœè¿”å› 1 è¡¨ç¤º rawCnt æ˜¯ä¸€ä¸ªå¥‡æ•°ã€‚</p> <p>ä½†æ˜¯æˆ‘ä»¬çœ‹åˆ° Netty åœ¨å¥‡å¶åˆ¤æ–­æ¡ä»¶çš„å‰é¢åˆåŠ ä¸Šäº† <code>rawCnt != 2 &amp;&amp; rawCnt != 4</code>è¯­å¥ï¼Œè¿™æ˜¯å¹²å˜›çš„å‘¢ ï¼Ÿ</p> <p>å…¶å® Netty è¿™é‡Œæ˜¯ä¸ºäº†å°½é‡ç”¨æ€§èƒ½æ›´é«˜çš„ <code>==</code> è¿ç®—æ¥ä»£æ›¿ <code>&amp;</code> è¿ç®—ï¼Œä½†åˆä¸å¯èƒ½ç”¨ <code>==</code> è¿ç®—æ¥æšä¸¾å‡ºæ‰€æœ‰çš„å¶æ•°å€¼ï¼ˆä¹Ÿæ²¡è¿™å¿…è¦ï¼‰ï¼Œæ‰€ä»¥åªç”¨ <code>==</code> è¿ç®—æ¥åˆ¤æ–­åœ¨å®é™…åœºæ™¯ä¸­ç»å¸¸å‡ºç°çš„å¼•ç”¨è®¡æ•°ï¼Œä¸€èˆ¬ç»å¸¸å‡ºç°çš„å¼•ç”¨è®¡æ•°å€¼ä¸º 2 æˆ–è€… 4 ï¼Œ ä¹Ÿå°±æ˜¯è¯´ ByteBuf åœ¨å¤§éƒ¨åˆ†åœºæ™¯ä¸‹åªä¼šè¢«å¼•ç”¨ 1 æ¬¡æˆ–è€… 2 æ¬¡ï¼Œå¯¹äºè¿™ç§é«˜é¢‘å‡ºç°çš„åœºæ™¯ï¼ŒNetty ç”¨ <code>==</code> è¿ç®—æ¥é’ˆå¯¹æ€§ä¼˜åŒ–ï¼Œä½é¢‘å‡ºç°çš„åœºæ™¯å°±å›é€€åˆ° <code>&amp;</code> è¿ç®—ã€‚</p> <blockquote><p>å¤§éƒ¨åˆ†æ€§èƒ½ä¼˜åŒ–çš„å¥—è·¯éƒ½æ˜¯ç›¸åŒçš„ï¼Œæˆ‘ä»¬é€šå¸¸ä¸èƒ½ä¸€ä¸Šæ¥å°±å¥¢æ±‚ä¸€ä¸ªå¤§è€Œå…¨çš„é’ˆå¯¹å…¨å±€çš„ä¼˜åŒ–æ–¹æ¡ˆï¼Œè¿™æ˜¯ä¸å¯èƒ½çš„ï¼Œä¹Ÿæ˜¯ååˆ†ä½æ•ˆçš„ã€‚å¾€å¾€æœ€æœ‰æ•ˆçš„ï¼Œå¯ä»¥ç«‹ç«¿è§å½±çš„ä¼˜åŒ–æ–¹æ¡ˆéƒ½æ˜¯é’ˆå¯¹å±€éƒ¨çƒ­ç‚¹è¿›è¡Œä¸“é—¨ä¼˜åŒ–ã€‚</p></blockquote> <p>å¯¹å¼•ç”¨è®¡æ•°çš„è®¾ç½®ä¹Ÿæ˜¯ä¸€æ ·ï¼Œéƒ½éœ€è¦è€ƒè™‘å¥‡å¶çš„è½¬æ¢ï¼Œæˆ‘ä»¬åœ¨ <code>setRefCnt</code> æ–¹æ³•ä¸­æŒ‡å®šçš„å‚æ•° refCnt è¡¨ç¤ºé€»è¾‘ä¸Šçš„å¼•ç”¨è®¡æ•° â€”â€” <code>0, 1 , 2 , 3 ....</code>ï¼Œä½†è¦è®¾ç½®åˆ° ByteBuf æ—¶ï¼Œå°±éœ€è¦å¯¹é€»è¾‘å¼•ç”¨è®¡æ•°åœ¨ä¹˜ä»¥ 2 ï¼Œè®©å®ƒå§‹ç»ˆæ˜¯ä¸€ä¸ªå¶æ•°ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    public final void setRefCnt(T instance, int refCnt) {
        updater().set(instance, refCnt &gt; 0 ? refCnt &lt;&lt; 1 : 1); // overflow OK here
    }
</code></pre></div><p>æœ‰äº†è¿™äº›åŸºç¡€ä¹‹åï¼Œæˆ‘ä»¬ä¸‹é¢å°±æ¥çœ‹ä¸€ä¸‹åœ¨æ–°ç‰ˆæœ¬çš„ retain æ–¹æ³•è®¾è®¡ä¸­ï¼ŒNetty æ˜¯å¦‚ä½•è§£å†³ 4.1.17.Final ç‰ˆæœ¬å­˜åœ¨çš„å¹¶å‘å®‰å…¨é—®é¢˜ã€‚é¦–å…ˆ Netty å¯¹å¼•ç”¨è®¡æ•°çš„å¥‡å¶è®¾è®¡å¯¹äºç”¨æˆ·æ¥è¯´æ˜¯é€æ˜çš„ã€‚å¼•ç”¨è®¡æ•°å¯¹äºç”¨æˆ·æ¥è¯´ä»ç„¶æ˜¯æ™®é€šçš„è‡ªç„¶æ•° â€”â€” <code>0, 1 , 2 , 3 ....</code> ã€‚</p> <p>æ‰€ä»¥æ¯å½“ç”¨æˆ·è°ƒç”¨ retain æ–¹æ³•è¯•å›¾å¢åŠ  ByteBuf çš„å¼•ç”¨è®¡æ•°æ—¶ï¼Œé€šå¸¸æ˜¯æŒ‡å®šé€»è¾‘å¢åŠ æ­¥é•¿ â€”â€” incrementï¼ˆç”¨æˆ·è§†è§’ï¼‰ï¼Œè€Œåœ¨å…·ä½“çš„å®ç°è§’åº¦ï¼ŒNetty ä¼šå¢åŠ ä¸¤å€çš„ increment ï¼ˆrawIncrementï¼‰åˆ° refCnt å­—æ®µä¸­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    public final T retain(T instance) {
        // å¼•ç”¨è®¡æ•°é€»è¾‘ä¸Šæ˜¯åŠ  1 ï¼Œä½†å®é™…ä¸Šæ˜¯åŠ  2 ï¼ˆå®ç°è§’åº¦ï¼‰
        return retain0(instance, 1, 2);
    }

    public final T retain(T instance, int increment) {
        // all changes to the raw count are 2x the &quot;real&quot; change - overflow is OK
        // rawIncrement å§‹ç»ˆæ˜¯é€»è¾‘è®¡æ•° increment çš„ä¸¤å€
        int rawIncrement = checkPositive(increment, &quot;increment&quot;) &lt;&lt; 1;
        // å°† rawIncrement è®¾ç½®åˆ° ByteBuf çš„ refCnt å­—æ®µä¸­
        return retain0(instance, increment, rawIncrement);
    }

    // rawIncrement = increment &lt;&lt; 1
    // increment è¡¨ç¤ºå¼•ç”¨è®¡æ•°çš„é€»è¾‘å¢é•¿æ­¥é•¿
    // rawIncrement è¡¨ç¤ºå¼•ç”¨è®¡æ•°çš„å®é™…å¢é•¿æ­¥é•¿
    private T retain0(T instance, final int increment, final int rawIncrement) {
        // å…ˆé€šè¿‡ XADD æŒ‡ä»¤å°†  refCnt çš„å€¼åŠ èµ·æ¥
        int oldRef = updater().getAndAdd(instance, rawIncrement);
        // å¦‚æœ oldRef æ˜¯ä¸€ä¸ªå¥‡æ•°ï¼Œä¹Ÿå°±æ˜¯ ByteBuf å·²ç»æ²¡æœ‰å¼•ç”¨äº†ï¼ŒæŠ›å‡ºå¼‚å¸¸
        if (oldRef != 2 &amp;&amp; oldRef != 4 &amp;&amp; (oldRef &amp; 1) != 0) {
            // å¦‚æœ oldRef å·²ç»æ˜¯ä¸€ä¸ªå¥‡æ•°äº†ï¼Œæ— è®ºå¤šçº¿ç¨‹åœ¨è¿™é‡Œæ€ä¹ˆå¹¶å‘ retain ï¼Œéƒ½æ˜¯ä¸€ä¸ªå¥‡æ•°ï¼Œè¿™é‡Œéƒ½ä¼šæŠ›å‡ºå¼‚å¸¸
            throw new IllegalReferenceCountException(0, increment);
        }
        // don't pass 0! 
        // refCnt ä¸å¯èƒ½ä¸º 0 ï¼Œåªèƒ½æ˜¯ 1
        if ((oldRef &lt;= 0 &amp;&amp; oldRef + rawIncrement &gt;= 0)
                || (oldRef &gt;= 0 &amp;&amp; oldRef + rawIncrement &lt; oldRef)) {
            // å¦‚æœ refCnt å­—æ®µå·²ç»æº¢å‡ºï¼Œåˆ™è¿›è¡Œå›é€€ï¼Œå¹¶æŠ›å¼‚å¸¸
            updater().getAndAdd(instance, -rawIncrement);
            throw new IllegalReferenceCountException(realRefCnt(oldRef), increment);
        }
        return instance;
    }
</code></pre></div><p>é¦–å…ˆæ–°ç‰ˆæœ¬çš„ retain0 æ–¹æ³•ä»ç„¶ä¿ç•™äº† 4.1.17.Final ç‰ˆæœ¬å¼•å…¥çš„  XADD æŒ‡ä»¤å¸¦æ¥çš„æ€§èƒ½ä¼˜åŠ¿ï¼Œå¤§è‡´çš„å¤„ç†é€»è¾‘ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œä¸€ä¸Šæ¥å…ˆé€šè¿‡ getAndAdd æ–¹æ³•å°† refCnt å¢åŠ  rawIncrementï¼Œå¯¹äº <code>retain(T instance)</code> æ¥è¯´è¿™é‡Œç›´æ¥åŠ  2 ã€‚</p> <p>ç„¶ååˆ¤æ–­åŸæ¥çš„å¼•ç”¨è®¡æ•° oldRef æ˜¯å¦æ˜¯ä¸€ä¸ªå¥‡æ•°ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªå¥‡æ•°ï¼Œé‚£ä¹ˆå°±è¡¨ç¤º ByteBuf å·²ç»æ²¡æœ‰ä»»ä½•å¼•ç”¨äº†ï¼Œé€»è¾‘å¼•ç”¨è®¡æ•°æ—©å·²ç»ä¸º 0 äº†ï¼Œé‚£ä¹ˆå°±æŠ›å‡º IllegalReferenceCountExceptionã€‚</p> <p>åœ¨å¼•ç”¨è®¡æ•°ä¸ºå¥‡æ•°çš„æƒ…å†µä¸‹ï¼Œæ— è®ºå¤šçº¿ç¨‹æ€ä¹ˆå¯¹ refCnt å¹¶å‘åŠ  2 ï¼ŒrefCnt å§‹ç»ˆæ˜¯ä¸€ä¸ªå¥‡æ•°ï¼Œæœ€ç»ˆéƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚è§£å†³å¹¶å‘å®‰å…¨é—®é¢˜çš„è¦ç‚¹å°±åœ¨è¿™é‡Œï¼Œä¸€å®šè¦ä¿è¯ retain æ–¹æ³•çš„å¹¶å‘æ‰§è¡Œä¸èƒ½æ”¹å˜åŸæ¥çš„è¯­ä¹‰ã€‚</p> <p>æœ€åä¼šåˆ¤æ–­ä¸€ä¸‹ refCnt å­—æ®µæ˜¯å¦å‘ç”Ÿæº¢å‡ºï¼Œå¦‚æœæº¢å‡ºï¼Œåˆ™è¿›è¡Œå›é€€ï¼Œå¹¶æŠ›å‡ºå¼‚å¸¸ã€‚ä¸‹é¢æˆ‘ä»¬ä»ç„¶ä»¥ä¹‹å‰çš„å¹¶å‘åœºæ™¯ä¸ºä¾‹ï¼Œç”¨ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ï¼Œæ¥å›å‘³ä¸€ä¸‹å¥‡å¶è®¾è®¡çš„ç²¾å¦™ä¹‹å¤„ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>ç°åœ¨çº¿ç¨‹ 1 å¯¹ä¸€ä¸ª refCnt ä¸º 2 çš„ ByteBuf æ‰§è¡Œ release æ–¹æ³•ï¼Œè¿™æ—¶ ByteBuf çš„é€»è¾‘å¼•ç”¨è®¡æ•°å°±ä¸º 0 äº†ï¼Œå¯¹äºä¸€ä¸ªæ²¡æœ‰ä»»ä½•å¼•ç”¨çš„ ByteBuf æ¥è¯´ï¼Œæ–°ç‰ˆçš„è®¾è®¡ä¸­å®ƒçš„ refCnt åªèƒ½æ˜¯ä¸€ä¸ªå¥‡æ•°ï¼Œä¸èƒ½ä¸º 0 ï¼Œæ‰€ä»¥è¿™é‡Œ Netty ä¼šå°† refCnt è®¾ç½®ä¸º 1 ã€‚ç„¶ååœ¨æ­¥éª¤ 2 ä¸­è°ƒç”¨ deallocate æ–¹æ³•é‡Šæ”¾ Native Memoryã€‚</p> <p>çº¿ç¨‹ 2 åœ¨æ­¥éª¤ 1 å’Œæ­¥éª¤ 2 ä¹‹é—´æ’å…¥è¿›æ¥å¯¹  ByteBuf å¹¶å‘æ‰§è¡Œ retain æ–¹æ³•ï¼Œè¿™æ—¶çº¿ç¨‹ 2 çœ‹åˆ°çš„ refCnt æ˜¯ 1ï¼Œç„¶åé€šè¿‡ getAndAdd å°† refCnt åŠ åˆ°äº† 3 ï¼Œä»ç„¶æ˜¯ä¸€ä¸ªå¥‡æ•°ï¼ŒéšåæŠ›å‡º IllegalReferenceCountException å¼‚å¸¸ã€‚</p> <p>çº¿ç¨‹ 3 åœ¨æ­¥éª¤ 1.1 å’Œæ­¥éª¤ 1.2 ä¹‹é—´æ’å…¥è¿›æ¥å†æ¬¡å¯¹ ByteBuf å¹¶å‘æ‰§è¡Œ retain æ–¹æ³•ï¼Œè¿™æ—¶çº¿ç¨‹ 3 çœ‹åˆ°çš„ refCnt æ˜¯ 3ï¼Œç„¶åé€šè¿‡ getAndAdd å°† refCnt åŠ åˆ°äº† 5 ï¼Œè¿˜æ˜¯ä¸€ä¸ªå¥‡æ•°ï¼ŒéšåæŠ›å‡º IllegalReferenceCountException å¼‚å¸¸ã€‚</p> <p>è¿™æ ·ä¸€æ¥å°±ä¿è¯äº†å¼•ç”¨è®¡æ•°çš„å¹¶å‘è¯­ä¹‰ â€”â€” åªè¦ä¸€ä¸ª ByteBuf æ²¡æœ‰ä»»ä½•å¼•ç”¨çš„æ—¶å€™ï¼ˆrefCnt = 1ï¼‰ï¼Œå…¶ä»–çº¿ç¨‹æ— è®ºæ€ä¹ˆå¹¶å‘æ‰§è¡Œ  retain æ–¹æ³•éƒ½ä¼šå¾—åˆ°ä¸€ä¸ªå¼‚å¸¸ã€‚</p> <p>ä½†æ˜¯å¼•ç”¨è®¡æ•°å¹¶å‘è¯­ä¹‰çš„ä¿è¯ä¸èƒ½å•å•åªé  retain æ–¹æ³•ï¼Œå®ƒè¿˜éœ€è¦ä¸ release æ–¹æ³•ç›¸äº’é…åˆåä½œæ‰å¯ä»¥ï¼Œæ‰€ä»¥ä¸ºäº†å¹¶å‘è¯­ä¹‰çš„ä¿è¯ ï¼Œ release æ–¹æ³•çš„è®¾è®¡å°±ä¸èƒ½ä½¿ç”¨æ€§èƒ½æ›´é«˜çš„ XADD æŒ‡ä»¤ï¼Œè€Œæ˜¯è¦å›é€€åˆ°  CMPXCHG æŒ‡ä»¤æ¥å®ç°ã€‚</p> <p>ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ ï¼Ÿå› ä¸ºæ–°ç‰ˆå¼•ç”¨è®¡æ•°çš„è®¾è®¡é‡‡ç”¨çš„æ˜¯å¥‡å¶å®ç°ï¼ŒrefCnt ä¸ºå¶æ•°è¡¨ç¤º ByteBuf è¿˜æœ‰å¼•ç”¨ï¼ŒrefCnt ä¸ºå¥‡æ•°è¡¨ç¤º ByteBuf å·²ç»æ²¡æœ‰ä»»ä½•å¼•ç”¨äº†ï¼Œå¯ä»¥å®‰å…¨é‡Šæ”¾ Native Memory ã€‚å¯¹äºä¸€ä¸ª refCnt å·²ç»ä¸ºå¥‡æ•°çš„ ByteBuf æ¥è¯´ï¼Œæ— è®ºå¤šçº¿ç¨‹æ€ä¹ˆå¹¶å‘æ‰§è¡Œ retain æ–¹æ³•ï¼Œå¾—åˆ°çš„ refCnt ä»ç„¶æ˜¯ä¸€ä¸ªå¥‡æ•°ï¼Œæœ€ç»ˆéƒ½ä¼šæŠ›å‡º IllegalReferenceCountExceptionï¼Œè¿™å°±æ˜¯å¼•ç”¨è®¡æ•°çš„å¹¶å‘è¯­ä¹‰ ã€‚</p> <p>ä¸ºäº†ä¿è¯è¿™ä¸€ç‚¹ï¼Œå°±éœ€è¦åœ¨æ¯æ¬¡è°ƒç”¨ retain ï¼Œrelease æ–¹æ³•çš„æ—¶å€™ï¼Œä»¥å¶æ•°æ­¥é•¿æ¥æ›´æ–° refCntï¼Œæ¯”å¦‚æ¯ä¸€æ¬¡è°ƒç”¨ retain æ–¹æ³•å°±å¯¹ refCnt åŠ  2 ï¼Œæ¯ä¸€æ¬¡è°ƒç”¨ release æ–¹æ³•å°±å¯¹ refCnt å‡ 2 ã€‚</p> <p>ä½†æ€»æœ‰ä¸€ä¸ªæ—¶åˆ»ï¼ŒrefCnt ä¼šè¢«å‡åˆ° 0 çš„å¯¹å§ï¼Œåœ¨æ–°ç‰ˆçš„å¥‡å¶è®¾è®¡ä¸­ï¼ŒrefCnt æ˜¯ä¸å…è®¸ä¸º 0 çš„ï¼Œå› ä¸ºä¸€æ—¦ refCnt è¢«å‡åˆ°äº† 0 ï¼Œå¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œ retain ä¹‹åï¼Œå°±ä¼šå°† refCnt å†æ¬¡åŠ æˆäº†å¶æ•°ï¼Œè¿™åˆä¼šå‡ºç°å¹¶å‘é—®é¢˜ã€‚</p> <p>è€Œæ¯ä¸€æ¬¡è°ƒç”¨ release æ–¹æ³•æ˜¯å¯¹ refCnt å‡ 2 ï¼Œå¦‚æœæˆ‘ä»¬é‡‡ç”¨ XADD æŒ‡ä»¤å®ç° release çš„è¯ï¼Œå›æƒ³ä¸€ä¸‹ 4.1.17.Final ç‰ˆæœ¬ä¸­çš„è®¾è®¡ï¼Œå®ƒé¦–å…ˆè¿›æ¥æ˜¯é€šè¿‡ getAndAdd æ–¹æ³•å¯¹ refCnt å‡ 2 ï¼Œè¿™æ ·ä¸€æ¥ï¼ŒrefCnt å°±å˜æˆ 0 äº†ï¼Œå°±æœ‰å¹¶å‘å®‰å…¨é—®é¢˜äº†ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦é€šè¿‡ CMPXCHG æŒ‡ä»¤å°† refCnt æ›´æ–°ä¸º 1ã€‚</p> <p>è¿™é‡Œæœ‰çš„åŒå­¦å¯èƒ½è¦é—®äº†ï¼Œé‚£å¯ä¸å¯ä»¥å…ˆè¿›è¡Œä¸€ä¸‹ if åˆ¤æ–­ï¼Œå¦‚æœ refCnt å‡ 2 ä¹‹åå˜ä¸º 0 äº†ï¼Œæˆ‘ä»¬åœ¨é€šè¿‡ getAndAdd æ–¹æ³•å°† refCnt æ›´æ–°ä¸º 1 ï¼ˆå‡ä¸€ä¸ªå¥‡æ•°ï¼‰ï¼Œè¿™æ ·ä¸€æ¥ä¸ä¹Ÿå¯ä»¥åˆ©ç”¨ä¸Š XADD æŒ‡ä»¤çš„æ€§èƒ½ä¼˜åŠ¿å— ï¼Ÿ</p> <p>ç­”æ¡ˆæ˜¯ä¸è¡Œçš„ï¼Œå› ä¸º if åˆ¤æ–­ä¸ getAndAdd æ›´æ–°è¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´ä»ç„¶ä¸æ˜¯åŸå­çš„ï¼Œå¤šçº¿ç¨‹å¯ä»¥åœ¨è¿™ä¸ªé—´éš™ä»ç„¶æœ‰å¹¶å‘æ‰§è¡Œ retain æ–¹æ³•çš„å¯èƒ½ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>åœ¨çº¿ç¨‹ 1 æ‰§è¡Œ if åˆ¤æ–­å’Œ getAndAdd æ›´æ–°è¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´ï¼Œçº¿ç¨‹ 2 çœ‹åˆ°çš„ refCnt å…¶å® 2 ï¼Œç„¶åçº¿ç¨‹ 2 ä¼šå°† refCnt åŠ åˆ° 4 ï¼Œçº¿ç¨‹ 3 ç´§æ¥ç€ä¼šå°† refCnt å¢åŠ åˆ° 6 ï¼Œåœ¨çº¿ç¨‹ 2 å’Œçº¿ç¨‹ 3 çœ‹æ¥è¿™ä¸ª ByteBuf å®Œå…¨æ˜¯æ­£å¸¸çš„ï¼Œä½†æ˜¯çº¿ç¨‹ 1 é©¬ä¸Šå°±ä¼šé‡Šæ”¾ Native Memory äº†ã€‚</p> <p>è€Œä¸”é‡‡ç”¨è¿™ç§è®¾è®¡çš„è¯ï¼Œä¸€ä¼šé€šè¿‡ getAndAdd å¯¹ refCnt å‡ä¸€ä¸ªå¥‡æ•°ï¼Œä¸€ä¼šé€šè¿‡ getAndAdd å¯¹ refCnt åŠ ä¸€ä¸ªå¶æ•°ï¼Œè¿™æ ·å°±æŠŠåŸæœ¬çš„å¥‡å¶è®¾è®¡æä¹±æ‰äº†ã€‚</p> <p>æ‰€ä»¥æˆ‘ä»¬çš„è®¾è®¡ç›®æ ‡æ˜¯ä¸€å®šè¦ä¿è¯åœ¨ ByteBuf æ²¡æœ‰ä»»ä½•å¼•ç”¨è®¡æ•°çš„æ—¶å€™ï¼Œrelease æ–¹æ³•éœ€è¦åŸå­æ€§çš„å°† refCnt æ›´æ–°ä¸º 1 ã€‚ å› æ­¤å¿…é¡»é‡‡ç”¨ CMPXCHG æŒ‡ä»¤æ¥å®ç°è€Œä¸èƒ½ä½¿ç”¨ XADD æŒ‡ä»¤ã€‚</p> <p><strong>å†è€…è¯´ï¼Œ CMPXCHG æŒ‡ä»¤æ˜¯å¯ä»¥åŸå­æ€§çš„åˆ¤æ–­å½“å‰æ˜¯å¦æœ‰å¹¶å‘æƒ…å†µçš„ï¼Œå¦‚æœæœ‰å¹¶å‘æƒ…å†µå‡ºç°ï¼ŒCAS  å°±ä¼šå¤±è´¥ï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­é‡è¯•ã€‚ä½† XADD æŒ‡ä»¤å´æ— æ³•åŸå­æ€§çš„åˆ¤æ–­æ˜¯å¦æœ‰å¹¶å‘æƒ…å†µï¼Œå› ä¸ºå®ƒæ¯æ¬¡éƒ½æ˜¯å…ˆæ›´æ–°ï¼Œååˆ¤æ–­å¹¶å‘ï¼Œè¿™å°±ä¸æ˜¯åŸå­çš„äº†ã€‚è¿™ä¸€ç‚¹ï¼Œåœ¨ä¸‹é¢çš„æºç å®ç°ä¸­ä¼šä½“ç°çš„ç‰¹åˆ«æ˜æ˜¾</strong>ã€‚</p> <h4 id="_2-6-7-å°½é‡é¿å…å†…å­˜å±éšœçš„å¼€é”€"><a href="#_2-6-7-å°½é‡é¿å…å†…å­˜å±éšœçš„å¼€é”€" class="header-anchor">#</a> <strong>2.6.7 å°½é‡é¿å…å†…å­˜å±éšœçš„å¼€é”€</strong></h4> <div class="language- extra-class"><pre class="language-text"><code>    public final boolean release(T instance) {
        // ç¬¬ä¸€æ¬¡å°è¯•é‡‡ç”¨ unSafe nonVolatile çš„æ–¹å¼è¯»å– refCnf çš„å€¼
        int rawCnt = nonVolatileRawCnt(instance);
        // å¦‚æœé€»è¾‘å¼•ç”¨è®¡æ•°è¢«å‡åˆ° 0 äº†ï¼Œé‚£ä¹ˆå°±é€šè¿‡ tryFinalRelease0 ä½¿ç”¨ CAS å°† refCnf æ›´æ–°ä¸º 1
        // CAS å¤±è´¥çš„è¯ï¼Œåˆ™é€šè¿‡ retryRelease0 è¿›è¡Œé‡è¯•
        // å¦‚æœé€»è¾‘å¼•ç”¨è®¡æ•°ä¸ä¸º 0 ï¼Œåˆ™é€šè¿‡ nonFinalRelease0 å°† refCnf å‡ 2
        return rawCnt == 2 ? tryFinalRelease0(instance, 2) || retryRelease0(instance, 1)
                : nonFinalRelease0(instance, 1, rawCnt, toLiveRealRefCnt(rawCnt, 1));
    }
</code></pre></div><p>è¿™é‡Œæœ‰ä¸€ä¸ªå°çš„ç»†èŠ‚å†æ¬¡ä½“ç°å‡º Netty å¯¹äºæ€§èƒ½çš„æè‡´è¿½æ±‚ï¼ŒrefCnt å­—æ®µåœ¨ ByteBuf ä¸­è¢« Netty ç”³æ˜ä¸ºä¸€ä¸ª volatile å­—æ®µã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>private volatile int refCnt = updater.initialValue();
</code></pre></div><p>æˆ‘ä»¬å¯¹ refCnt çš„æ™®é€šè¯»å†™éƒ½æ˜¯è¦èµ°å†…å­˜å±éšœçš„ï¼Œä½† Netty åœ¨ release æ–¹æ³•ä¸­é¦–æ¬¡è¯»å– refCnt çš„å€¼æ˜¯é‡‡ç”¨ nonVolatile çš„æ–¹å¼ï¼Œä¸èµ°å†…å­˜å±éšœï¼Œç›´æ¥è¯»å– cache lineï¼Œé¿å…äº†å±éšœå¼€é”€ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private int nonVolatileRawCnt(T instance) {
        // è·å– REFCNT_FIELD_OFFSET
        final long offset = unsafeOffset();
        // é€šè¿‡ UnSafe çš„æ–¹å¼æ¥è®¿é—® refCnt ï¼Œ é¿å…å†…å­˜å±éšœçš„å¼€é”€
        return offset != -1 ? PlatformDependent.getInt(instance, offset) : updater().get(instance);
    }
</code></pre></div><p>é‚£æœ‰çš„åŒå­¦å¯èƒ½è¦é—®äº†ï¼Œå¦‚æœè¯»å– refCnt çš„æ—¶å€™ä¸èµ°å†…å­˜å±éšœçš„è¯ï¼Œè¯»å–åˆ°çš„ refCnt ä¸å°±å¯èƒ½æ˜¯ä¸€ä¸ªé”™è¯¯çš„å€¼å— ï¼Ÿ</p> <p>äº‹å®ä¸Šç¡®å®æ˜¯è¿™æ ·çš„ï¼Œä½† Netty ä¸ care , è¯»åˆ°ä¸€ä¸ªé”™è¯¯çš„å€¼ä¹Ÿæ— æ‰€è°“ï¼Œå› ä¸ºè¿™é‡Œçš„å¼•ç”¨è®¡æ•°é‡‡ç”¨äº†å¥‡å¶è®¾è®¡ï¼Œæˆ‘ä»¬åœ¨ç¬¬ä¸€æ¬¡è¯»å–å¼•ç”¨è®¡æ•°çš„æ—¶å€™å¹¶ä¸éœ€è¦è¯»å–åˆ°ä¸€ä¸ªç²¾ç¡®çš„å€¼ï¼Œæ—¢ç„¶è¿™æ ·æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ UnSafe æ¥è¯»å–ï¼Œè¿˜èƒ½å‰©ä¸‹ä¸€ç¬”å†…å­˜å±éšœçš„å¼€é”€ã€‚</p> <p>é‚£ä¸ºä»€ä¹ˆä¸éœ€è¦ä¸€ä¸ªç²¾ç¡®çš„å€¼å‘¢ ï¼Ÿå› ä¸ºå¦‚æœåŸæ¥çš„ refCnt æ˜¯ä¸€ä¸ªå¥‡æ•°ï¼Œé‚£æ— è®ºå¤šçº¿ç¨‹æ€ä¹ˆå¹¶å‘ retain ï¼Œæœ€ç»ˆå¾—åˆ°çš„è¿˜æ˜¯ä¸€ä¸ªå¥‡æ•°ï¼Œæˆ‘ä»¬è¿™é‡Œåªéœ€è¦çŸ¥é“ refCnt æ˜¯ä¸€ä¸ªå¥‡æ•°å°±å¯ä»¥ç›´æ¥æŠ› IllegalReferenceCountException äº†ã€‚å…·ä½“è¯»åˆ°çš„æ˜¯ä¸€ä¸ª 3 è¿˜æ˜¯ä¸€ä¸ª 5 å…¶å®éƒ½æ— æ‰€è°“ã€‚</p> <p>é‚£å¦‚æœåŸæ¥çš„ refCnt æ˜¯ä¸€ä¸ªå¶æ•°å‘¢ ï¼Ÿå…¶å®ä¹Ÿæ— æ‰€è°“ï¼Œæˆ‘ä»¬å¯èƒ½è¯»åˆ°ä¸€ä¸ªæ­£ç¡®çš„å€¼ä¹Ÿå¯èƒ½è¯»åˆ°ä¸€ä¸ªé”™è¯¯çš„å€¼ï¼Œå¦‚æœæ°å¥½è¯»åˆ°ä¸€ä¸ªæ­£ç¡®çš„å€¼ï¼Œé‚£æ›´å¥½ã€‚å¦‚æœè¯»å–åˆ°ä¸€ä¸ªé”™è¯¯çš„å€¼ï¼Œä¹Ÿæ— æ‰€è°“ï¼Œå› ä¸ºæˆ‘ä»¬åé¢æ˜¯ç”¨ CAS è¿›è¡Œæ›´æ–°ï¼Œè¿™æ ·çš„è¯ CAS å°±ä¼šæ›´æ–°å¤±è´¥ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ä¸€ä¸‹è½® for å¾ªç¯ä¸­æ›´æ–°æ­£ç¡®å°±å¯ä»¥äº†ã€‚</p> <p>å¦‚æœè¯»å–åˆ°çš„ refCnt æ°å¥½æ˜¯ 2 ï¼Œé‚£å°±æ„å‘³ç€æœ¬æ¬¡ release ä¹‹åï¼ŒByteBuf çš„é€»è¾‘å¼•ç”¨è®¡æ•°å°±ä¸º 0 äº†ï¼ŒNetty ä¼šé€šè¿‡ CAS å°† refCnt æ›´æ–°ä¸º 1 ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>   private boolean tryFinalRelease0(T instance, int expectRawCnt) {
        return updater().compareAndSet(instance, expectRawCnt, 1); // any odd number will work
    }
</code></pre></div><p>å¦‚æœ CAS æ›´æ–°å¤±è´¥ï¼Œåˆ™è¡¨ç¤ºæ­¤æ—¶æœ‰å¤šçº¿ç¨‹å¯èƒ½å¹¶å‘å¯¹ ByteBuf æ‰§è¡Œ retain æ–¹æ³•ï¼Œé€»è¾‘å¼•ç”¨è®¡æ•°æ­¤æ—¶å¯èƒ½å°±ä¸ä¸º 0 äº†ï¼Œé’ˆå¯¹è¿™ç§å¹¶å‘æƒ…å†µï¼ŒNetty ä¼šåœ¨ retryRelease0 æ–¹æ³•ä¸­è¿›è¡Œé‡è¯•ï¼Œå°† refCnt å‡ 2 ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private boolean retryRelease0(T instance, int decrement) {
        for (;;) {
            // é‡‡ç”¨ Volatile çš„æ–¹å¼è¯»å– refCnt
            int rawCnt = updater().get(instance), 
            // è·å–é€»è¾‘å¼•ç”¨è®¡æ•°ï¼Œå¦‚æœ refCnt å·²ç»å˜ä¸ºå¥‡æ•°ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
            realCnt = toLiveRealRefCnt(rawCnt, decrement);
            // å¦‚æœæ‰§è¡Œå®Œæœ¬æ¬¡ release , é€»è¾‘å¼•ç”¨è®¡æ•°ä¸º 0
            if (decrement == realCnt) {
                // CAS å°† refCnt æ›´æ–°ä¸º 1
                if (tryFinalRelease0(instance, rawCnt)) {
                    return true;
                }
            } else if (decrement &lt; realCnt) {
                // åŸæ¥çš„é€»è¾‘å¼•ç”¨è®¡æ•° realCnt å¤§äº 1ï¼ˆdecrementï¼‰
                // åˆ™é€šè¿‡ CAS å°† refCnt å‡ 2
                if (updater().compareAndSet(instance, rawCnt, rawCnt - (decrement &lt;&lt; 1))) {
                    return false;
                }
            } else {
                // refCnt å­—æ®µå¦‚æœå‘ç”Ÿæº¢å‡ºï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
                throw new IllegalReferenceCountException(realCnt, -decrement);
            }
            // CAS å¤±è´¥ä¹‹åè°ƒç”¨ yield
            // å‡å°‘æ— ç•çš„ç«äº‰ï¼Œå¦åˆ™æ‰€æœ‰çº¿ç¨‹åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹éƒ½åœ¨è¿™é‡Œ CAS å¤±è´¥
            Thread.yield(); 
        }
    }
</code></pre></div><p>ä» retryRelease0 æ–¹æ³•çš„å®ç°ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒCAS æ˜¯å¯ä»¥åŸå­æ€§çš„æ¢æµ‹åˆ°æ˜¯å¦æœ‰å¹¶å‘æƒ…å†µå‡ºç°çš„ï¼Œå¦‚æœæœ‰å¹¶å‘æƒ…å†µï¼Œè¿™é‡Œçš„æ‰€æœ‰ CAS éƒ½ä¼šå¤±è´¥ï¼Œéšåä¼šåœ¨ä¸‹ä¸€è½® for å¾ªç¯ä¸­å°†æ­£ç¡®çš„å€¼æ›´æ–°åˆ° refCnt ä¸­ã€‚è¿™ä¸€ç‚¹ ï¼ŒXADD æŒ‡ä»¤æ˜¯åšä¸åˆ°çš„ã€‚</p> <p>å¦‚æœåœ¨è¿›å…¥ release æ–¹æ³•åï¼Œç¬¬ä¸€æ¬¡è¯»å–çš„ refCnt ä¸æ˜¯ 2 ï¼Œé‚£ä¹ˆå°±ä¸èƒ½èµ°ä¸Šé¢çš„ tryFinalRelease0 é€»è¾‘ï¼Œè€Œæ˜¯åœ¨ nonFinalRelease0 ä¸­é€šè¿‡ CAS å°† refCnt çš„å€¼å‡ 2 ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>   private boolean nonFinalRelease0(T instance, int decrement, int rawCnt, int realCnt) {
        if (decrement &lt; realCnt
                &amp;&amp; updater().compareAndSet(instance, rawCnt, rawCnt - (decrement &lt;&lt; 1))) {
            // ByteBuf çš„ rawCnt å‡å°‘ 2 * decrement
            return false;
        }
        // CAS  å¤±è´¥åˆ™ä¸€ç›´é‡è¯•ï¼Œå¦‚æœå¼•ç”¨è®¡æ•°å·²ç»ä¸º 0 ï¼Œé‚£ä¹ˆæŠ›å‡ºå¼‚å¸¸ï¼Œä¸èƒ½å†æ¬¡ release
        return retryRelease0(instance, decrement);
    }
</code></pre></div><p>åˆ°è¿™é‡Œï¼ŒNetty å¯¹å¼•ç”¨è®¡æ•°çš„ç²¾å½©è®¾è®¡ï¼Œç¬”è€…å°±ä¸ºå¤§å®¶å®Œæ•´çš„å‰–æå®Œäº†ï¼Œä¸€å…±æœ‰å››å¤„éå¸¸ç²¾å½©çš„ä¼˜åŒ–è®¾è®¡ï¼Œæˆ‘ä»¬æ€»ç»“å¦‚ä¸‹ï¼š</p> <ol><li>ä½¿ç”¨æ€§èƒ½æ›´ä¼˜çš„  XADD æŒ‡ä»¤æ¥æ›¿æ¢ CMPXCHG æŒ‡ä»¤ã€‚</li> <li>å¼•ç”¨è®¡æ•°é‡‡ç”¨äº†å¥‡å¶è®¾è®¡ï¼Œä¿è¯äº†å¹¶å‘è¯­ä¹‰ã€‚</li> <li>é‡‡ç”¨æ€§èƒ½æ›´ä¼˜çš„ <code>==</code> è¿ç®—æ¥æ›¿æ¢ <code>&amp;</code> è¿ç®—ã€‚</li> <li>èƒ½ä¸èµ°å†…å­˜å±éšœå°±å°½é‡ä¸èµ°å†…å­˜å±éšœã€‚</li></ol> <h3 id="_2-7-bytebuf-çš„è§†å›¾è®¾è®¡"><a href="#_2-7-bytebuf-çš„è§†å›¾è®¾è®¡" class="header-anchor">#</a> <strong>2.7 ByteBuf çš„è§†å›¾è®¾è®¡</strong></h3> <p>å’Œ JDK çš„è®¾è®¡ä¸€æ ·ï¼ŒNetty ä¸­çš„ ByteBuf ä¹Ÿå¯ä»¥é€šè¿‡ <code>slice()</code> æ–¹æ³•ä»¥åŠ <code>duplicate()</code> æ–¹æ³•åˆ›å»ºä¸€ä¸ªè§†å›¾ ByteBuf å‡ºæ¥ï¼ŒåŸç”Ÿ ByteBuf å’Œå®ƒçš„è§†å›¾ ByteBuf åº•å±‚éƒ½æ˜¯å…±ç”¨åŒä¸€ç‰‡å†…å­˜åŒºåŸŸï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨è§†å›¾ ByteBuf ä¸Šåšçš„ä»»ä½•æ”¹åŠ¨éƒ½ä¼šååº”åˆ°åŸç”Ÿ ByteBuf ä¸Šã€‚åŒç†ï¼Œåœ¨åŸç”Ÿ ByteBuf ä¸Šåšçš„ä»»ä½•æ”¹åŠ¨ä¹Ÿä¼šååº”åˆ°å®ƒçš„è§†å›¾ ByteBuf ä¸Šã€‚æˆ‘ä»¬å¯ä»¥å°†è§†å›¾ ByteBuf çœ‹åšæ˜¯åŸç”Ÿ ByteBuf çš„ä¸€ä»½æµ…æ‹·è´ã€‚</p> <p>åŸç”Ÿ ByteBuf å’Œå®ƒçš„è§†å›¾ ByteBuf ä¸åŒçš„æ˜¯ï¼Œå®ƒä»¬éƒ½æœ‰å„è‡ªç‹¬ç«‹çš„ readerIndexï¼ŒwriterIndexï¼Œcapacityï¼ŒmaxCapacityã€‚</p> <p><code>slice()</code> æ–¹æ³•æ˜¯åœ¨åŸç”Ÿ ByteBuf çš„ <code>[readerIndex , writerIndex)</code> è¿™æ®µå†…å­˜åŒºåŸŸå†…åˆ›å»ºä¸€ä¸ªè§†å›¾ ByteBufã€‚ä¹Ÿå°±æ˜¯åŸç”Ÿ ByteBuf å’Œè§†å›¾ ByteBuf å…±ç”¨  <code>[readerIndex , writerIndex)</code> è¿™æ®µå†…å­˜åŒºåŸŸã€‚è§†å›¾ ByteBuf çš„æ•°æ®åŒºåŸŸå…¶å®å°±æ˜¯åŸç”Ÿ ByteBuf çš„å¯è¯»å­—èŠ‚åŒºåŸŸã€‚</p> <p>è§†å›¾ ByteBuf çš„ readerIndex = 0 ï¼Œ writerIndex = capacity = maxCapacity = åŸç”Ÿ ByteBuf çš„ <code>readableBytes()</code> ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>  @Override
    public int readableBytes() {
        // åŸç”Ÿ ByteBuf
        return writerIndex - readerIndex;
    }
</code></pre></div><p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ <code>slice()</code>æ–¹æ³•åˆ›å»ºè§†å›¾ ByteBuf çš„é€»è¾‘å®ç°ï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>public abstract class AbstractByteBuf extends ByteBuf {
    @Override
    public ByteBuf slice() {
        return slice(readerIndex, readableBytes());
    }

    @Override
    public ByteBuf slice(int index, int length) {
        // ç¡®ä¿ ByteBuf çš„å¼•ç”¨è®¡æ•°ä¸ä¸º 0 
        ensureAccessible();
        return new UnpooledSlicedByteBuf(this, index, length);
    }
}
</code></pre></div><p>Netty ä¼šå°† slice è§†å›¾ ByteBuf å°è£…åœ¨ UnpooledSlicedByteBuf ç±»ä¸­ï¼Œåœ¨è¿™é‡Œä¼šåˆå§‹åŒ– slice è§†å›¾ ByteBuf çš„ readerIndexï¼ŒwriterIndexï¼Œcapacityï¼ŒmaxCapacityã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>class UnpooledSlicedByteBuf extends AbstractUnpooledSlicedByteBuf {
    UnpooledSlicedByteBuf(AbstractByteBuf buffer, int index, int length) {
        // index = readerIndex
        // length = readableBytes()
        super(buffer, index, length);
    }

    @Override
    public int capacity() {
        // è§†å›¾ ByteBuf çš„ capacity å’Œ maxCapacity ç›¸ç­‰
        // å‡ä¸ºåŸç”Ÿ ByteBuf çš„ readableBytes() 
        return maxCapacity();
    }
}
</code></pre></div><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè¿™é‡Œçš„ index å°±æ˜¯åŸç”Ÿ ByteBuf çš„ readerIndex = 4 ï¼Œindex ç”¨äºè¡¨ç¤ºè§†å›¾ ByteBuf çš„å†…å­˜åŒºåŸŸç›¸å¯¹äºåŸç”Ÿ ByteBuf çš„åç§»ï¼Œå› ä¸ºè§†å›¾ ByteBuf ä¸åŸç”Ÿ ByteBuf å…±ç”¨çš„æ˜¯åŒä¸€ç‰‡å†…å­˜åŒºåŸŸï¼Œé’ˆå¯¹è§†å›¾ ByteBuf çš„æ“ä½œå…¶å®åº•å±‚æœ€ç»ˆæ˜¯è½¬æ¢ä¸ºå¯¹åŸç”Ÿ ByteBuf çš„æ“ä½œã€‚</p> <p>ä½†ç”±äºè§†å›¾ ByteBuf  å’ŒåŸç”Ÿ ByteBuf å„è‡ªéƒ½æœ‰ç‹¬ç«‹çš„ readerIndex å’Œ writerIndexï¼Œæ¯”å¦‚ä¸Šå›¾ä¸­ï¼Œè§†å›¾ ByteBuf ä¸­çš„ readerIndex = 0 å…¶å®æŒ‡å‘çš„æ˜¯åŸç”Ÿ ByteBuf ä¸­ readerIndex = 4 çš„ä½ç½®ã€‚æ‰€ä»¥æ¯æ¬¡åœ¨æˆ‘ä»¬å¯¹è§†å›¾ ByteBuf è¿›è¡Œè¯»å†™çš„æ—¶å€™éƒ½éœ€è¦å°†è§†å›¾ ByteBuf çš„ readerIndex åŠ ä¸Šä¸€ä¸ªåç§»ï¼ˆindexï¼‰è½¬æ¢æˆåŸç”Ÿ ByteBuf çš„ readerIndexï¼Œè¿‘è€Œä»åŸç”Ÿ ByteBuf ä¸­æ¥è¯»å†™æ•°æ®ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>   @Override
    protected byte _getByte(int index) {
        // åº•å±‚å…¶å®æ˜¯å¯¹åŸç”Ÿ ByteBuf çš„è®¿é—®
        return unwrap()._getByte(idx(index));
    }

    @Override
    protected void _setByte(int index, int value) {
        unwrap()._setByte(idx(index), value);
    }

   /**
     * Returns the index with the needed adjustment.
     */
    final int idx(int index) {
        // è½¬æ¢ä¸ºåŸç”Ÿ ByteBuf çš„ readerIndex æˆ–è€… writerIndex
        return index + adjustment;
    }
</code></pre></div><p><code>idx(int index)</code> æ–¹æ³•ä¸­çš„ adjustment å°±æ˜¯ä¸Šé¢ UnpooledSlicedByteBuf æ„é€ å‡½æ•°ä¸­çš„ index åç§»ï¼Œåˆå§‹åŒ–ä¸ºåŸç”Ÿ ByteBuf çš„ readerIndexã€‚</p> <p>length åˆ™åˆå§‹åŒ–ä¸ºåŸç”Ÿ ByteBuf çš„ <code>readableBytes()</code>ï¼Œè§†å›¾ ByteBuf ä¸­çš„ writerIndexï¼Œcapacityï¼ŒmaxCapacity éƒ½æ˜¯ç”¨ length æ¥åˆå§‹åŒ–ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>abstract class AbstractUnpooledSlicedByteBuf extends AbstractDerivedByteBuf {
    // åŸç”Ÿ ByteBuf
    private final ByteBuf buffer;
    // è§†å›¾ ByteBuf ç›¸å¯¹äºåŸç”Ÿ ByteBufçš„æ•°æ®åŒºåŸŸåç§»
    private final int adjustment;

    AbstractUnpooledSlicedByteBuf(ByteBuf buffer, int index, int length) {
        // è®¾ç½®è§†å›¾ ByteBuf çš„ maxCapacityï¼ŒreaderIndex ä¸º 0 
        super(length);
        // åŸç”Ÿ ByteBuf
        this.buffer = buffer;
        // æ•°æ®åç§»ä¸ºåŸç”Ÿ ByteBuf çš„ readerIndex
        adjustment = index;
        // è®¾ç½®è§†å›¾ ByteBuf çš„ writerIndex
        writerIndex(length);
    }
}
</code></pre></div><p>ä½†æ˜¯é€šè¿‡ <code>slice()</code> æ–¹æ³•åˆ›å»ºå‡ºæ¥çš„è§†å›¾ ByteBuf å¹¶ä¸ä¼šæ”¹å˜åŸç”Ÿ ByteBuf çš„å¼•ç”¨è®¡æ•°ï¼Œè¿™ä¼šå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ç”±äºè§†å›¾ ByteBuf å’ŒåŸç”Ÿ ByteBuf åº•å±‚å…±ç”¨çš„æ˜¯åŒä¸€ç‰‡å†…å­˜åŒºåŸŸï¼Œåœ¨åŸç”Ÿ ByteBuf æˆ–è€…è§†å›¾ ByteBuf å„è‡ªçš„åº”ç”¨ä¸Šä¸‹æ–‡ä¸­ä»–ä»¬å¯èƒ½å¹¶ä¸ä¼šæ„è¯†åˆ°å¯¹æ–¹çš„å­˜åœ¨ã€‚</p> <p>å¦‚æœå¯¹åŸç”Ÿ ByteBuf è°ƒç”¨ release æ–¹æ³•ï¼Œæ°å¥½å¼•ç”¨è®¡æ•°å°±ä¸º 0 äº†ï¼Œæ¥ç€å°±ä¼šé‡Šæ”¾åŸç”Ÿ ByteBuf çš„ Native Memory ã€‚æ­¤æ—¶å†å¯¹è§†å›¾ ByteBuf è¿›è¡Œè®¿é—®å°±æœ‰é—®é¢˜äº†ï¼Œå› ä¸º  Native Memory å·²ç»è¢«åŸç”Ÿ ByteBuf é‡Šæ”¾äº†ã€‚åŒæ ·çš„é“ç†ï¼Œå¯¹è§†å›¾ ByteBuf è°ƒç”¨ release æ–¹æ³• ï¼Œä¹Ÿä¼šå¯¹åŸç”Ÿ ByteBuf äº§ç”Ÿå½±å“ã€‚</p> <p>ä¸ºæ­¤ Netty æä¾›äº†ä¸€ä¸ª <code>retainedSlice()</code> æ–¹æ³•ï¼Œåœ¨åˆ›å»º slice è§†å›¾ ByteBuf çš„åŒæ—¶å¯¹åŸç”Ÿ ByteBuf çš„å¼•ç”¨è®¡æ•°åŠ  1 ï¼Œä¸¤è€…å…±ç”¨åŒä¸€ä¸ªå¼•ç”¨è®¡æ•°ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public ByteBuf retainedSlice() {
        // åŸç”Ÿ ByteBuf çš„å¼•ç”¨è®¡æ•°åŠ  1
        return slice().retain();
    }
</code></pre></div><p>é™¤äº† <code>slice()</code> ä¹‹å¤–ï¼ŒNetty ä¹Ÿæä¾›äº† <code>duplicate()</code> æ–¹æ³•æ¥åˆ›å»ºè§†å›¾ ByteBuf ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    @Override
    public ByteBuf duplicate() {
        // ç¡®ä¿ ByteBuf çš„å¼•ç”¨è®¡æ•°ä¸ä¸º 0 
        ensureAccessible();
        return new UnpooledDuplicatedByteBuf(this);
    }
</code></pre></div><p>ä½†å’Œ  <code>slice()</code> ä¸åŒçš„æ˜¯ï¼Œ <code>duplicate()</code> æ˜¯å®Œå…¨å¤åˆ»äº†åŸç”Ÿ ByteBufï¼Œå¤åˆ»å‡ºæ¥çš„è§†å›¾ ByteBuf è™½ç„¶ä¸åŸç”Ÿ ByteBuf éƒ½æœ‰å„è‡ªç‹¬ç«‹çš„  readerIndexï¼ŒwriterIndexï¼Œcapacityï¼ŒmaxCapacityã€‚ä½†ä»–ä»¬çš„å€¼éƒ½æ˜¯ç›¸åŒçš„ã€‚duplicate è§†å›¾  ByteBuf ä¹Ÿæ˜¯å’ŒåŸç”Ÿ ByteBuf å…±ç”¨åŒä¸€å— Native Memory ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <div class="language- extra-class"><pre class="language-text"><code>public class DuplicatedByteBuf extends AbstractDerivedByteBuf {
    // åŸç”Ÿ ByteBuf
    private final ByteBuf buffer;

    public DuplicatedByteBuf(ByteBuf buffer) {
        this(buffer, buffer.readerIndex(), buffer.writerIndex());
    }

    DuplicatedByteBuf(ByteBuf buffer, int readerIndex, int writerIndex) {
        // åˆå§‹åŒ–è§†å›¾ ByteBuf çš„ maxCapacity ä¸åŸç”Ÿçš„ç›¸åŒ
        super(buffer.maxCapacity());
        // åŸç”Ÿ ByteBuf
        this.buffer = buffer;
        // è§†å›¾ ByteBuf çš„ readerIndex ï¼Œ writerIndex ä¹Ÿä¸åŸç”Ÿç›¸åŒ
        setIndex(readerIndex, writerIndex);
        markReaderIndex();
        markWriterIndex();
    }

    @Override
    public int capacity() {
        // è§†å›¾ ByteBuf çš„ capacity ä¹Ÿä¸åŸç”Ÿç›¸åŒ
        return unwrap().capacity();
    }

}
</code></pre></div><p>Netty åŒæ ·ä¹Ÿæä¾›äº†å¯¹åº”çš„ <code>retainedDuplicate()</code> æ–¹æ³•ï¼Œç”¨äºåˆ›å»º duplicate è§†å›¾ ByteBuf  çš„åŒæ—¶å¢åŠ åŸç”Ÿ ByteBuf çš„å¼•ç”¨è®¡æ•°ã€‚è§†å›¾ ByteBuf ä¸åŸç”Ÿ ByteBuf ä¹‹é—´å…±ç”¨åŒä¸€ä¸ªå¼•ç”¨è®¡æ•°ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>   @Override
    public ByteBuf retainedDuplicate() {
        return duplicate().retain();
    }
</code></pre></div><p>ä¸Šé¢ä»‹ç»çš„ä¸¤ç§è§†å›¾ ByteBuf å¯ä»¥ç†è§£ä¸ºæ˜¯å¯¹åŸç”Ÿ ByteBuf çš„ä¸€å±‚æµ…æ‹·è´ï¼ŒNetty ä¹Ÿæä¾›äº† <code>copy()</code> æ–¹æ³•æ¥å®ç°å¯¹åŸç”Ÿ ByteBuf çš„æ·±æ‹·è´ï¼Œcopy å‡ºæ¥çš„ ByteBuf æ˜¯åŸç”Ÿ  ByteBuf çš„ä¸€ä¸ªå‰¯æœ¬ï¼Œä¸¤è€…åº•å±‚ä¾èµ–çš„ Native Memory æ˜¯ä¸åŒçš„ï¼Œå„è‡ªéƒ½æœ‰ç‹¬ç«‹çš„  readerIndexï¼ŒwriterIndexï¼Œcapacityï¼ŒmaxCapacity ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public abstract class AbstractByteBuf extends ByteBuf {
    @Override
    public ByteBuf copy() {
        // ä»åŸç”Ÿ ByteBuf ä¸­çš„ readerIndex å¼€å§‹ï¼Œæ‹·è´ readableBytes ä¸ªå­—èŠ‚åˆ°æ–°çš„ ByteBuf ä¸­
        return copy(readerIndex, readableBytes());
    }
}
</code></pre></div><p><code>copy()</code> æ–¹æ³•æ˜¯å¯¹åŸç”Ÿ ByteBuf çš„ <code>[readerIndex , writerIndex)</code>è¿™æ®µæ•°æ®èŒƒå›´å†…å®¹è¿›è¡Œæ‹·è´ã€‚copy å‡ºæ¥çš„ ByteBufï¼Œå®ƒçš„ readerIndex = 0 ï¼Œ writerIndex = capacity = åŸç”Ÿ ByteBuf çš„ <code>readableBytes()</code>ã€‚maxCapacity ä¸åŸç”Ÿ maxCapacity ç›¸åŒã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <div class="language- extra-class"><pre class="language-text"><code>public class UnpooledDirectByteBuf  {
  @Override
    public ByteBuf copy(int index, int length) {
        ensureAccessible();
        ByteBuffer src;
        try {
            // å°†åŸç”Ÿ ByteBuf ä¸­ [index , index + lengh) è¿™æ®µèŒƒå›´çš„æ•°æ®æ‹·è´åˆ°æ–°çš„ ByteBuf ä¸­
            src = (ByteBuffer) buffer.duplicate().clear().position(index).limit(index + length);
        } catch (IllegalArgumentException ignored) {
            throw new IndexOutOfBoundsException(&quot;Too many bytes to read - Need &quot; + (index + length));
        }
        // é¦–å…ˆæ–°ç”³è¯·ä¸€æ®µ native memory , æ–°çš„ ByteBuf åˆå§‹å®¹é‡ä¸º length (çœŸå®å®¹é‡)ï¼Œæœ€å¤§å®¹é‡ä¸åŸç”Ÿ ByteBuf çš„ maxCapacity ç›¸ç­‰
        // readerIndex = 0 , writerIndex = length
        return alloc().directBuffer(length, maxCapacity()).writeBytes(src);
    }
}
</code></pre></div><h3 id="_2-8-compositebytebuf-çš„é›¶æ‹·è´è®¾è®¡"><a href="#_2-8-compositebytebuf-çš„é›¶æ‹·è´è®¾è®¡" class="header-anchor">#</a> <strong>2.8 CompositeByteBuf çš„é›¶æ‹·è´è®¾è®¡</strong></h3> <p>è¿™é‡Œçš„é›¶æ‹·è´å¹¶ä¸æ˜¯æˆ‘ä»¬ç»å¸¸æåˆ°çš„é‚£ç§ OS å±‚é¢ä¸Šçš„é›¶æ‹·è´ï¼Œè€Œæ˜¯ Netty åœ¨ç”¨æˆ·æ€å±‚é¢è‡ªå·±å®ç°çš„é¿å…å†…å­˜æ‹·è´çš„è®¾è®¡ã€‚æ¯”å¦‚åœ¨ä¼ ç»Ÿæ„ä¹‰ä¸Šï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦å°†å¤šä¸ªç‹¬ç«‹çš„ ByteBuf  èšåˆæˆä¸€ä¸ª ByteBuf çš„æ—¶å€™ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å‘ OS ç”³è¯·ä¸€æ®µæ›´å¤§çš„å†…å­˜ï¼Œç„¶åä¾æ¬¡å°†å¤šä¸ª ByteBuf ä¸­çš„å†…å®¹æ‹·è´åˆ°è¿™æ®µæ–°ç”³è¯·çš„å†…å­˜ä¸Šï¼Œæœ€ååœ¨é‡Šæ”¾è¿™äº› ByteBuf çš„å†…å­˜ã€‚</p> <p>è¿™æ ·ä¸€æ¥å°±æ¶‰åŠåˆ°ä¸¤ä¸ªæ€§èƒ½å¼€é”€ç‚¹ï¼Œä¸€ä¸ªæ˜¯æˆ‘ä»¬éœ€è¦å‘ OS é‡æ–°ç”³è¯·æ›´å¤§çš„å†…å­˜ï¼Œå¦ä¸€ä¸ªæ˜¯å†…å­˜çš„æ‹·è´ã€‚Netty å¼•å…¥ CompositeByteBuf çš„ç›®çš„å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜ã€‚å·§å¦™åœ°åˆ©ç”¨åŸæœ‰ ByteBuf æ‰€å çš„å†…å­˜ï¼Œåœ¨æ­¤åŸºç¡€ä¹‹ä¸Šï¼Œå°†å®ƒä»¬ç»„åˆæˆä¸€ä¸ªé€»è¾‘æ„ä¹‰ä¸Šçš„ CompositeByteBuf ï¼Œæä¾›ä¸€ä¸ªç»Ÿä¸€çš„é€»è¾‘è§†å›¾ã€‚</p> <p>CompositeByteBuf å…¶å®ä¹Ÿæ˜¯ä¸€ç§è§†å›¾ ByteBuf ï¼Œè¿™ä¸€ç‚¹å’Œä¸Šå°èŠ‚ä¸­æˆ‘ä»¬ä»‹ç»çš„ SlicedByteBuf ï¼Œ DuplicatedByteBuf ä¸€æ ·ï¼Œå®ƒä»¬æœ¬èº«å¹¶ä¸ä¼šå ç”¨ Native Memoryï¼Œåº•å±‚æ•°æ®çš„å­˜å‚¨å…¨éƒ¨ä¾èµ–äºåŸç”Ÿçš„ ByteBufã€‚</p> <p>ä¸åŒç‚¹åœ¨äºï¼ŒSlicedByteBufï¼ŒDuplicatedByteBuf å®ƒä»¬æ˜¯åœ¨å•ä¸€çš„åŸç”Ÿ ByteBuf åŸºç¡€ä¹‹ä¸Šåˆ›å»ºå‡ºçš„è§†å›¾ ByteBufã€‚è€Œ CompositeByteBuf æ˜¯åŸºäºå¤šä¸ªåŸç”Ÿ ByteBuf åˆ›å»ºå‡ºçš„ç»Ÿä¸€é€»è¾‘è§†å›¾  ByteBufã€‚</p> <p>CompositeByteBuf å¯¹äºæˆ‘ä»¬ç”¨æˆ·æ¥è¯´å’Œå…¶ä»–çš„æ™®é€š ByteBuf æ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œæœ‰è‡ªå·±ç‹¬ç«‹çš„ readerIndexï¼ŒwriterIndexï¼Œcapacityï¼ŒmaxCapacityï¼Œå‰é¢å‡ ä¸ªå°èŠ‚ä¸­ä»‹ç»çš„å„ç§ ByteBuf çš„è®¾è®¡è¦ç´ ï¼Œåœ¨ CompositeByteBuf èº«ä¸Šä¹Ÿéƒ½ä¼šä½“ç°ã€‚</p> <p>ä½†ä»å®ç°çš„è§’åº¦æ¥è¯´ï¼ŒCompositeByteBuf åªæ˜¯ä¸€ä¸ªé€»è¾‘ä¸Šçš„ ByteBufï¼Œå…¶æœ¬èº«å¹¶ä¸ä¼šå ç”¨ä»»ä½•çš„ Native Memory ï¼Œå¯¹äº CompositeByteBuf çš„ä»»ä½•æ“ä½œï¼Œæœ€ç»ˆéƒ½éœ€è¦è½¬æ¢åˆ°å…¶å†…éƒ¨å…·ä½“çš„ ByteBuf ä¸Šã€‚æœ¬å°èŠ‚æˆ‘ä»¬å°±æ¥æ·±å…¥åˆ° CompositeByteBuf çš„å†…éƒ¨ï¼Œæ¥çœ‹ä¸€ä¸‹ Netty çš„å·§å¦™è®¾è®¡ã€‚</p> <h4 id="_2-8-1-compositebytebuf-çš„æ€»ä½“æ¶æ„"><a href="#_2-8-1-compositebytebuf-çš„æ€»ä½“æ¶æ„" class="header-anchor">#</a> <strong>2.8.1 CompositeByteBuf çš„æ€»ä½“æ¶æ„</strong></h4> <p>ä»æ€»ä½“è®¾è®¡ä¸Šæ¥è®²ï¼ŒCompositeByteBuf åŒ…å«å¦‚ä¸‹äº”ä¸ªé‡è¦å±æ€§ï¼Œå…¶ä¸­æœ€ä¸ºæ ¸å¿ƒçš„å°±æ˜¯ components æ•°ç»„ï¼Œé‚£äº›éœ€è¦è¢«èšåˆçš„åŸç”Ÿ ByteBuf ä¼šè¢« Netty å°è£…åœ¨ Component ç±»ä¸­ï¼Œå¹¶ç»Ÿä¸€ç»„ç»‡åœ¨ components æ•°ç»„ä¸­ã€‚åç»­é’ˆå¯¹ CompositeByteBuf çš„æ‰€æœ‰æ“ä½œéƒ½éœ€è¦å’Œè¿™ä¸ªæ•°ç»„æ‰“äº¤é“ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class CompositeByteBuf extends AbstractReferenceCountedByteBuf implements Iterable&lt;ByteBuf&gt; {
    // å†…éƒ¨ ByteBuf çš„åˆ†é…å™¨ï¼Œç”¨äºåç»­æ‰©å®¹ï¼Œcopy , åˆå¹¶ç­‰æ“ä½œ
    private final ByteBufAllocator alloc;
    // compositeDirectBuffer è¿˜æ˜¯ compositeHeapBuffer ?
    private final boolean direct;
    // æœ€å¤§çš„ components æ•°ç»„å®¹é‡ï¼ˆ16ï¼‰
    private final int maxNumComponents;
    // å½“å‰ CompositeByteBuf ä¸­åŒ…å«çš„ components ä¸ªæ•°
    private int componentCount;
    // å­˜å‚¨ component çš„æ•°ç»„
    private Component[] components; // resized when needed
}
</code></pre></div><p>maxNumComponents è¡¨ç¤º components æ•°ç»„æœ€å¤§çš„å®¹é‡ï¼ŒCompositeByteBuf é»˜è®¤èƒ½å¤ŸåŒ…å« Component çš„æœ€å¤§ä¸ªæ•°ä¸º 16ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªæ•°é‡çš„è¯ï¼ŒNetty ä¼šå°†å½“å‰ CompositeByteBuf ä¸­åŒ…å«çš„æ‰€æœ‰ Components é‡æ–°åˆå¹¶æˆä¸€ä¸ªæ›´å¤§çš„ Componentã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public abstract class AbstractByteBufAllocator implements ByteBufAllocator {
    static final int DEFAULT_MAX_COMPONENTS = 16;
}
</code></pre></div><p>componentCount è¡¨ç¤ºå½“å‰ CompositeByteBuf ä¸­åŒ…å«çš„ Component ä¸ªæ•°ã€‚æ¯å½“æˆ‘ä»¬é€šè¿‡ <code>addComponent</code> æ–¹æ³•å‘ CompositeByteBuf æ·»åŠ ä¸€ä¸ªæ–°çš„ ByteBuf æ—¶ï¼ŒNetty éƒ½ä¼šç”¨ä¸€ä¸ªæ–°çš„ Component å®ä¾‹æ¥åŒ…è£…è¿™ä¸ª ByteBufï¼Œç„¶åå­˜æ”¾åœ¨  components æ•°ç»„ä¸­ï¼Œæœ€å componentCount çš„ä¸ªæ•°åŠ  1 ã€‚</p> <p>CompositeByteBuf ä¸å…¶åº•å±‚èšåˆçš„çœŸå® ByteBuf æ¶æ„è®¾è®¡å…³ç³»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>è€Œåˆ›å»ºä¸€ä¸ª CompositeByteBuf çš„æ ¸å¿ƒå…¶å®å°±æ˜¯åˆ›å»ºåº•å±‚çš„ components æ•°ç»„ï¼Œåç»­æ·»åŠ åˆ°è¯¥ CompositeByteBuf çš„æ‰€æœ‰åŸç”Ÿ ByteBuf éƒ½ä¼šè¢«ç»„ç»‡åœ¨è¿™é‡Œã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>   private CompositeByteBuf(ByteBufAllocator alloc, boolean direct, int maxNumComponents, int initSize) {
        // è®¾ç½® maxCapacity
        super(AbstractByteBufAllocator.DEFAULT_MAX_CAPACITY);

        this.alloc = ObjectUtil.checkNotNull(alloc, &quot;alloc&quot;);
        this.direct = direct;
        this.maxNumComponents = maxNumComponents;
        // åˆå§‹ Component æ•°ç»„çš„å®¹é‡ä¸º maxNumComponents
        components = newCompArray(initSize, maxNumComponents);
    }
</code></pre></div><p>è¿™é‡Œçš„å‚æ•°  <code>initSize</code> è¡¨ç¤ºçš„å¹¶ä¸æ˜¯ CompositeByteBuf æ‰€åŒ…å«çš„å­—èŠ‚æ•°ï¼Œè€Œæ˜¯åˆå§‹åŒ…è£…çš„åŸç”Ÿ ByteBuf ä¸ªæ•°ï¼Œä¹Ÿå°±æ˜¯åˆå§‹  Component çš„ä¸ªæ•°ã€‚components æ•°ç»„çš„æ€»ä½“å¤§å°ç”±å‚æ•° maxNumComponents å†³å®šï¼Œä½†ä¸èƒ½è¶…è¿‡ 16 ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>   private static Component[] newCompArray(int initComponents, int maxNumComponents) {
        // MAX_COMPONENT
        int capacityGuess = Math.min(AbstractByteBufAllocator.DEFAULT_MAX_COMPONENTS, maxNumComponents);
        // åˆå§‹ Component æ•°ç»„çš„å®¹é‡ä¸º maxNumComponents
        return new Component[Math.max(initComponents, capacityGuess)];
    }
</code></pre></div><p>ç°åœ¨æˆ‘ä»¬åªæ˜¯æ¸…æ¥šäº† CompositeByteBuf çš„ä¸€ä¸ªåŸºæœ¬éª¨æ¶ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥ Netty å¦‚ä½•æ ¹æ®è¿™ä¸ªåŸºæœ¬çš„éª¨æ¶å°†å¤šä¸ªåŸç”Ÿ ByteBuf ç»„è£…æˆä¸€ä¸ªé€»è¾‘ä¸Šçš„ç»Ÿä¸€è§†å›¾ ByteBuf å‘¢ ï¼Ÿ</p> <p>ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¾æ® CompositeByteBuf ä¸­çš„ readerIndex ä»¥åŠ writerIndex è¿›è¡Œçš„è¯»å†™æ“ä½œé€»è¾‘å¦‚ä½•è½¬æ¢åˆ°å¯¹åº”çš„åº•å±‚åŸç”Ÿ ByteBuf ä¹‹ä¸Šå‘¢ ï¼Ÿ è¿™ä¸ªæ˜¯æ•´ä¸ªè®¾è®¡çš„æ ¸å¿ƒæ‰€åœ¨ã€‚</p> <p>ä¸‹é¢ç¬”è€…å°±å¸¦ç€å¤§å®¶ä»å¤–åˆ°å†…ï¼Œä»æ˜“åˆ°éš¾åœ°ä¸€ä¸€æ‹†è§£ CompositeByteBuf ä¸­çš„é‚£äº›æ ¸å¿ƒè®¾è®¡è¦ç´ ã€‚ä» CompositeByteBuf çš„æœ€å¤–å±‚æ¥çœ‹ï¼Œå…¶å®æˆ‘ä»¬å¹¶ä¸é™Œç”Ÿï¼Œå¯¹äºç”¨æˆ·æ¥è¯´å®ƒå°±æ˜¯ä¸€ä¸ªæ™®é€šçš„ ByteBufï¼Œæ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„ readerIndex ï¼ŒwriterIndex ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191121420.webp" alt="å›¾ç‰‡">image.png</p> <p>ä½† CompositeByteBuf ä¸­é‚£äº›é€»è¾‘ä¸Šçœ‹èµ·æ¥è¿ç»­çš„å­—èŠ‚ï¼ŒèƒŒåå…¶å®å­˜å‚¨åœ¨ä¸åŒçš„åŸç”Ÿ ByteBuf ä¸­ã€‚ä¸åŒ ByteBuf çš„å†…å­˜ä¹‹é—´å…¶å®æ˜¯ä¸è¿ç»­çš„ã€‚</p> <p><img src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/sOIZXFW0vUZFdNJKVEk1X07SFzmQ63xFPaTicNCcEx4ibZrlnPf2JXMsIGn8UTHiaxEH5QJKpbJd7Mziba115XFhDw/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡">image.png</p> <p>é‚£ä¹ˆç°åœ¨é—®é¢˜çš„å…³é”®å°±æ˜¯æˆ‘ä»¬å¦‚ä½•åˆ¤æ–­ CompositeByteBuf ä¸­çš„æŸä¸€æ®µé€»è¾‘æ•°æ®èƒŒåå¯¹åº”çš„ç©¶ç«Ÿæ˜¯å“ªä¸€ä¸ªçœŸå®çš„ ByteBufï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿé€šè¿‡ CompositeByteBuf çš„ç›¸å…³ Index , æ‰¾åˆ°è¿™ä¸ª Index èƒŒåå¯¹åº”çš„ ByteBufï¼Œè¿‘è€Œå¯ä»¥æ‰¾åˆ° ByteBuf çš„ Index ï¼Œè¿™æ ·æ˜¯ä¸æ˜¯å°±å¯ä»¥å°† CompositeByteBuf çš„é€»è¾‘æ“ä½œè½¬æ¢æˆå¯¹çœŸå®å†…å­˜çš„è¯»å†™æ“ä½œäº†ã€‚</p> <p>CompositeByteBuf åˆ°åŸç”Ÿ ByteBuf çš„è½¬æ¢å…³ç³»ï¼ŒNetty å°è£…åœ¨ Component ç±»ä¸­ï¼Œæ¯ä¸€ä¸ªè¢«åŒ…è£…åœ¨ CompositeByteBuf ä¸­çš„åŸç”Ÿ ByteBuf éƒ½å¯¹åº”ä¸€ä¸ª Component å®ä¾‹ã€‚å®ƒä»¬ä¼šæŒ‰ç…§é¡ºåºç»Ÿä¸€ç»„ç»‡åœ¨ components æ•°ç»„ä¸­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private static final class Component {
        // åŸç”Ÿ ByteBuf
        final ByteBuf srcBuf; 
        // CompositeByteBuf çš„ index åŠ ä¸Š srcAdjustment å°±å¾—åˆ°äº†srcBuf çš„ç›¸å…³ index
        int srcAdjustment; 
        // srcBuf å¯èƒ½æ˜¯ä¸€ä¸ªè¢«åŒ…è£…è¿‡çš„ ByteBufï¼Œæ¯”å¦‚ SlicedByteBuf ï¼Œ DuplicatedByteBuf
        // è¢« srcBuf åŒ…è£…çš„æœ€åº•å±‚çš„ ByteBuf å°±å­˜æ”¾åœ¨ buf å­—æ®µä¸­
        final ByteBuf buf;      
        // CompositeByteBuf çš„ index åŠ ä¸Š adjustment å°±å¾—åˆ°äº† buf çš„ç›¸å…³ index      
        int adjustment; 
 
        // è¯¥ Component åœ¨ CompositeByteBuf è§†è§’ä¸­è¡¨ç¤ºçš„æ•°æ®èŒƒå›´ [offset , endOffset)
        int offset; 
        int endOffset;        
    }
</code></pre></div><p>ä¸€ä¸ª Component åœ¨ CompositeByteBuf çš„è§†è§’ä¸­æ‰€èƒ½è¡¨ç¤ºçš„æ•°æ®é€»è¾‘èŒƒå›´æ˜¯ <code>[offset , endOffset)</code>ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>æ¯”å¦‚ä¸Šå›¾ä¸­ç¬¬ä¸€ä¸ªç»¿è‰²çš„ ByteBuf , å®ƒé‡Œè¾¹å­˜å‚¨çš„æ•°æ®ç»„æˆäº† CompositeByteBuf ä¸­ <code>[0 , 4)</code> è¿™æ®µé€»è¾‘æ•°æ®èŒƒå›´ã€‚ç¬¬äºŒä¸ªé»„è‰²çš„ ByteBufï¼Œå®ƒé‡Œè¾¹å­˜å‚¨çš„æ•°æ®ç»„æˆäº† CompositeByteBuf ä¸­ <code>[4 , 8)</code> è¿™æ®µé€»è¾‘æ•°æ®èŒƒå›´ã€‚ç¬¬ä¸‰ä¸ªè“è‰²çš„ ByteBufï¼Œå®ƒé‡Œè¾¹å­˜å‚¨çš„æ•°æ®ç»„æˆäº† CompositeByteBuf ä¸­ <code>[8 , 12)</code> è¿™æ®µé€»è¾‘æ•°æ®èŒƒå›´ã€‚ ä¸Šä¸€ä¸ª Component çš„ endOffset æ°å¥½æ˜¯ä¸‹ä¸€ä¸ª Component çš„ offset ã€‚</p> <p>è€Œè¿™äº›çœŸå®å­˜å‚¨æ•°æ®çš„ ByteBuf åˆ™å­˜å‚¨åœ¨å¯¹åº” Component ä¸­çš„ srcBuf å­—æ®µä¸­ï¼Œå½“æˆ‘ä»¬é€šè¿‡ CompositeByteBuf çš„ readerIndex æˆ–è€… writerIndex è¿›è¡Œè¯»å†™æ“ä½œçš„æ—¶å€™ï¼Œé¦–å…ˆéœ€è¦ç¡®å®šç›¸å…³ index æ‰€å¯¹åº”çš„ srcBufï¼Œç„¶åå°† CompositeByteBuf çš„ index è½¬æ¢ä¸º srcBuf çš„ srcIndexï¼Œè¿‘è€Œé€šè¿‡ srcIndex å¯¹ srcBuf è¿›è¡Œè¯»å†™ã€‚</p> <p>è¿™ä¸ª index çš„è½¬æ¢å°±æ˜¯é€šè¿‡ srcAdjustment æ¥è¿›è¡Œçš„ï¼Œæ¯”å¦‚ï¼Œå½“å‰ CompositeByteBuf çš„ readerIndex ä¸º 5 ï¼Œå®ƒå¯¹åº”çš„æ˜¯ç¬¬äºŒä¸ªé»„è‰²çš„ ByteBufã€‚è€Œ ByteBuf çš„ readerIndex å´æ˜¯ 1 ã€‚</p> <p>æ‰€ä»¥ç¬¬äºŒä¸ª Component çš„ srcAdjustment å°±æ˜¯ -4 ï¼Œ è¿™æ ·æˆ‘ä»¬è¯»å– CompositeByteBuf çš„æ—¶å€™ï¼Œé¦–å…ˆå°†å®ƒçš„ readerIndex åŠ ä¸Š srcAdjustment å°±å¾—åˆ°äº† ByteBuf çš„ readerIndex ï¼Œåé¢å°±æ˜¯æ™®é€šçš„ ByteBuf è¯»å–æ“ä½œäº†ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>åœ¨æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬è¦å¯¹ CompositeByteBuf è¿›è¡Œå†™æ“ä½œï¼Œå½“å‰çš„ writerIndex ä¸º 10 ï¼Œå¯¹åº”çš„æ˜¯ç¬¬ä¸‰ä¸ªè“è‰²çš„ ByteBufï¼Œå®ƒçš„ writerIndex ä¸º 2 ã€‚</p> <p>æ‰€ä»¥ç¬¬ä¸‰ä¸ª Component çš„ srcAdjustment å°±æ˜¯ -8 ï¼ŒCompositeByteBuf çš„ writerIndex åŠ ä¸Š srcAdjustment å°±å¾—åˆ°äº† ByteBuf çš„ writerIndexï¼Œåç»­å°±æ˜¯æ™®é€šçš„ ByteBuf å†™å…¥æ“ä½œã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>       int srcIdx(int index) {
            // CompositeByteBuf ç›¸å…³çš„ index è½¬æ¢æˆ srcBuf çš„ç›¸å…³ index
            return index + srcAdjustment;
        }
</code></pre></div><p>é™¤äº† srcBuf ä¹‹å¤–ï¼ŒComponent å®ä¾‹ä¸­è¿˜æœ‰ä¸€ä¸ª buf å­—æ®µï¼Œè¿™é‡Œå¤§å®¶å¯èƒ½ä¼šæ¯”è¾ƒå¥½å¥‡ï¼Œä¸ºä»€ä¹ˆè®¾è®¡äº†ä¸¤ä¸ª ByteBuf å­—æ®µå‘¢ ï¼ŸComponent å®ä¾‹ä¸ ByteBuf ä¸æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»å— ï¼Ÿ</p> <p>srcBuf æ˜¯æŒ‡æˆ‘ä»¬é€šè¿‡ <code>addComponent</code> æ–¹æ³•æ·»åŠ åˆ° CompositeByteBuf ä¸­çš„åŸå§‹ ByteBufã€‚è€Œè¿™ä¸ª srcBuf å¯èƒ½æ˜¯ä¸€ä¸ªè§†å›¾ ByteBufï¼Œæ¯”å¦‚ä¸Šä¸€å°èŠ‚ä¸­ä»‹ç»åˆ°çš„ SlicedByteBuf å’Œ DuplicatedByteBufã€‚srcBuf è¿˜å¯èƒ½æ˜¯ä¸€ä¸ªè¢«åŒ…è£…è¿‡çš„ ByteBufï¼Œæ¯”å¦‚ WrappedByteBuf , SwappedByteBufã€‚</p> <p>å‡å¦‚ srcBuf æ˜¯ä¸€ä¸ª SlicedByteBuf çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦å°†å®ƒçš„åŸç”Ÿ ByteBuf æ‹†è§£å‡ºæ¥å¹¶ä¿å­˜åœ¨ Component å®ä¾‹çš„ buf å­—æ®µä¸­ã€‚äº‹å®ä¸Š Component ä¸­çš„ buf æ‰æ˜¯çœŸæ­£å­˜å‚¨æ•°æ®çš„åœ°æ–¹ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>abstract class AbstractUnpooledSlicedByteBuf {
    // åŸç”Ÿ ByteBuf
    private final ByteBuf buffer;
}
</code></pre></div><p>ä¸ buf å¯¹åº”çš„å°±æ˜¯ adjustment ï¼Œ å®ƒç”¨äºå°† CompositeByteBuf çš„ç›¸å…³ index è½¬æ¢æˆ buf ç›¸å…³çš„ index ï¼Œå‡å¦‚æˆ‘ä»¬åœ¨å‘ä¸€ä¸ª CompositeByteBuf æ‰§è¡Œ read æ“ä½œï¼Œå®ƒçš„å½“å‰ readerIndex æ˜¯ 5ï¼Œè€Œ buf çš„ readerIndex æ˜¯ 6 ã€‚</p> <p>æ‰€ä»¥åœ¨è¯»å–æ“ä½œä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å°† CompositeByteBuf çš„ readerIndex åŠ ä¸Š adjustment å¾—åˆ° buf çš„ readerIndexï¼Œè¿‘è€Œå°†è¯»å–æ“ä½œè½¬ç§»åˆ° buf ä¸­ã€‚å…¶å®å°±å’Œä¸Šå°èŠ‚ä¸­ä»‹ç»çš„è§†å›¾ ByteBuf æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œåœ¨è¯»å†™ä¹‹å‰éƒ½éœ€è¦ä¿®æ­£ç›¸å…³çš„ index ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <div class="language- extra-class"><pre class="language-text"><code>   @Override
    public byte getByte(int index) {
        // é€šè¿‡ CompositeByteBuf çš„ index , æ‰¾åˆ°æ•°æ®æ‰€å±çš„ component
        Component c = findComponent(index);
        // é¦–å…ˆé€šè¿‡ idx è½¬æ¢ä¸º buf ç›¸å…³çš„ index
        // å°†å¯¹ CompositeByteBuf çš„è¯»å†™æ“ä½œè½¬æ¢ä¸º buf çš„è¯»å†™æ“ä½œ
        return c.buf.getByte(c.idx(index));
    }

    int idx(int index) {
        // å°† CompositeByteBuf çš„ç›¸å…³ index è½¬æ¢ä¸º buf çš„ç›¸å…³ index
        return index + adjustment;
     }
</code></pre></div><p>é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•æ ¹æ®æŒ‡å®šçš„ CompositeByteBuf çš„ index æ¥æŸ¥æ‰¾å…¶å¯¹åº”çš„åº•å±‚æ•°æ®ç©¶ç«Ÿå­˜å‚¨åœ¨å“ªä¸ª Component ä¸­å‘¢ ï¼Ÿ</p> <p>æ ¸å¿ƒæ€æƒ³å…¶å®å¾ˆç®€å•ï¼Œå› ä¸ºæ¯ä¸ª Component éƒ½ä¼šæè¿°è‡ªå·±è¡¨ç¤º CompositeByteBuf ä¸­çš„å“ªä¸€æ®µæ•°æ®èŒƒå›´ â€”â€” <code>[offset , endOffset)</code>ã€‚æ‰€æœ‰çš„ Components éƒ½è¢«æœ‰åºçš„ç»„ç»‡åœ¨ components æ•°ç»„ä¸­ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡äºŒåˆ†æŸ¥æ‰¾çš„æ–¹æ³•æ¥å¯»æ‰¾è¿™ä¸ª index åˆ°åº•æ˜¯è½åœ¨äº†å“ªä¸ª Component è¡¨ç¤ºçš„èŒƒå›´ä¸­ã€‚</p> <p>è¿™ä¸ªæŸ¥æ‰¾çš„è¿‡ç¨‹æ˜¯åœ¨ <code>findComponent</code>æ–¹æ³•ä¸­å®ç°çš„ï¼ŒNetty ä¼šå°†æœ€è¿‘ä¸€æ¬¡è®¿é—®åˆ°çš„  Component ç¼“å­˜åœ¨ CompositeByteBuf çš„ lastAccessed å­—æ®µä¸­ï¼Œæ¯æ¬¡è¿›è¡ŒæŸ¥æ‰¾çš„æ—¶å€™é¦–å…ˆä¼šåˆ¤æ–­ index æ˜¯å¦è½åœ¨äº† lastAccessed æ‰€è¡¨ç¤ºçš„æ•°æ®èŒƒå›´å†… â€”â€” <code>[ la.offset , la.endOffset)</code> ã€‚</p> <p>å¦‚æœ index æ°å¥½è¢«ç¼“å­˜çš„ Componentï¼ˆlastAccessedï¼‰æ‰€åŒ…å«ï¼Œé‚£ä¹ˆå°±ç›´æ¥è¿”å› lastAccessed ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    // ç¼“å­˜æœ€è¿‘ä¸€æ¬¡æŸ¥æ‰¾åˆ°çš„ Component
    private Component lastAccessed;

    private Component findComponent(int offset) {
        Component la = lastAccessed;
        // é¦–å…ˆæŸ¥æ‰¾ offset æ˜¯å¦æ°å¥½è½åœ¨ lastAccessed çš„åŒºé—´ä¸­
        if (la != null &amp;&amp; offset &gt;= la.offset &amp;&amp; offset &lt; la.endOffset) {
           return la;
        }
        // åœ¨æ‰€æœ‰ Components ä¸­è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾
        return findIt(offset);
    }
</code></pre></div><p>å¦‚æœ index ä¸å·§æ²¡æœ‰å‘½ä¸­ç¼“å­˜ï¼Œé‚£ä¹ˆå°±åœ¨æ•´ä¸ª components æ•°ç»„ä¸­è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾ ï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>    private Component findIt(int offset) {
        for (int low = 0, high = componentCount; low &lt;= high;) {
            int mid = low + high &gt;&gt;&gt; 1;
            Component c = components[mid];
            if (offset &gt;= c.endOffset) {
                low = mid + 1;
            } else if (offset &lt; c.offset) {
                high = mid - 1;
            } else {
                lastAccessed = c;
                return c;
            }
        }

        throw new Error(&quot;should not reach here&quot;);
    }
</code></pre></div><h4 id="_2-8-2-compositebytebuf-çš„åˆ›å»º"><a href="#_2-8-2-compositebytebuf-çš„åˆ›å»º" class="header-anchor">#</a> <strong>2.8.2 CompositeByteBuf çš„åˆ›å»º</strong></h4> <p>å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬å·²ç»ç†Ÿæ‚‰äº† CompositeByteBuf çš„æ€»ä½“æ¶æ„ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥çœ‹ä¸€ä¸‹ Netty æ˜¯å¦‚ä½•å°†å¤šä¸ª ByteBuf é€»è¾‘èšåˆæˆä¸€ä¸ª CompositeByteBuf çš„ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public final class Unpooled {
   public static ByteBuf wrappedBuffer(ByteBuf... buffers) {
        return wrappedBuffer(buffers.length, buffers);
    }
}
</code></pre></div><p>CompositeByteBuf çš„åˆå§‹ maxNumComponents ä¸º buffers æ•°ç»„çš„é•¿åº¦ï¼Œå¦‚æœæˆ‘ä»¬åªæ˜¯ä¼ å…¥ä¸€ä¸ª ByteBuf çš„è¯ï¼Œé‚£ä¹ˆå°±æ— éœ€åˆ›å»º CompositeByteBufï¼Œè€Œæ˜¯ç›´æ¥è¿”å›è¯¥ ByteBuf çš„ slice è§†å›¾ã€‚</p> <p>å¦‚æœæˆ‘ä»¬ä¼ å…¥çš„æ˜¯å¤šä¸ª ByteBuf çš„è¯ï¼Œåˆ™å°†è¿™å¤šä¸ª ByteBuf åŒ…è£…æˆ CompositeByteBuf è¿”å›ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public final class Unpooled {
    public static ByteBuf wrappedBuffer(int maxNumComponents, ByteBuf... buffers) {
        switch (buffers.length) {
        case 0:
            break;
        case 1:
            ByteBuf buffer = buffers[0];
            if (buffer.isReadable()) {
                // ç›´æ¥è¿”å› buffer.slice() è§†å›¾
                return wrappedBuffer(buffer.order(BIG_ENDIAN));
            } else {
                buffer.release();
            }
            break;
        default:
            for (int i = 0; i &lt; buffers.length; i++) {
                ByteBuf buf = buffers[i];
                if (buf.isReadable()) {
                    // ä»ç¬¬ä¸€ä¸ªå¯è¯»çš„ ByteBuf â€”â€” buffers[i] å¼€å§‹åˆ›å»º CompositeByteBuf
                    return new CompositeByteBuf(ALLOC, false, maxNumComponents, buffers, i);
                }
                // buf ä¸å¯è¯»åˆ™ release
                buf.release();
            }
            break;
        }
        return EMPTY_BUFFER;
    }
}
</code></pre></div><p>åœ¨è¿›å…¥ CompositeByteBuf çš„åˆ›å»ºæµç¨‹ä¹‹åï¼Œé¦–å…ˆæ˜¯åˆ›å»ºå‡ºä¸€ä¸ªç©ºçš„ CompositeByteBufï¼Œä¹Ÿå°±æ˜¯å…ˆæŠŠ CompositeByteBuf çš„éª¨æ¶æ­å»ºèµ·æ¥ï¼Œè¿™æ—¶å®ƒçš„ initSize ä¸º <code>buffers.length - offset</code> ã€‚</p> <p>æ³¨æ„ initSize è¡¨ç¤ºçš„å¹¶ä¸æ˜¯ CompositeByteBuf åˆå§‹åŒ…å«çš„å­—èŠ‚ä¸ªæ•°ï¼Œè€Œæ˜¯è¡¨ç¤ºåˆå§‹ Component çš„ä¸ªæ•°ã€‚offset åˆ™è¡¨ç¤ºä» buffers æ•°ç»„ä¸­çš„å“ªä¸€ä¸ªç´¢å¼•å¼€å§‹åˆ›å»º CompositeByteBufï¼Œå°±æ˜¯ä¸Šé¢ CompositeByteBuf æ„é€ å‡½æ•°ä¸­æœ€åä¸€ä¸ªå‚æ•° i ã€‚</p> <p>éšåé€šè¿‡ <code>addComponents0</code> æ–¹æ³•ä¸º buffers æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ª ByteBuf åˆ›å»ºåˆå§‹åŒ– Component å®ä¾‹ï¼Œå¹¶å°†ä»–ä»¬æœ‰åºçš„æ·»åŠ åˆ° CompositeByteBuf çš„ components æ•°ç»„ä¸­ã€‚</p> <p>ä½†è¿™æ—¶ Component å®ä¾‹çš„ä¸ªæ•°å¯èƒ½å·²ç»è¶…è¿‡ maxNumComponents é™åˆ¶çš„ä¸ªæ•°ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±ä¼šåœ¨ <code>consolidateIfNeeded()</code> æ–¹æ³•ä¸­å°†å½“å‰ CompositeByteBuf ä¸­çš„æ‰€æœ‰ Components åˆå¹¶æˆä¸€ä¸ªæ›´å¤§çš„ Componentã€‚CompositeByteBuf ä¸­çš„ components æ•°ç»„é•¿åº¦æ˜¯ä¸å¯ä»¥è¶…è¿‡ maxNumComponents é™åˆ¶çš„ï¼Œå¦‚æœè¶…è¿‡å°±éœ€è¦åœ¨è¿™é‡Œåˆå¹¶ã€‚</p> <p>æœ€åè®¾ç½®å½“å‰ CompositeByteBuf çš„ readerIndex å’Œ writerIndexï¼Œåœ¨åˆå§‹çŠ¶æ€ä¸‹ CompositeByteBuf çš„ readerIndex ä¼šè¢«è®¾ç½®ä¸º 0 ï¼ŒwriterIndex ä¼šè¢«è®¾ç½®ä¸ºæœ€åä¸€ä¸ª Component çš„ endOffset ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    CompositeByteBuf(ByteBufAllocator alloc, boolean direct, int maxNumComponents,
            ByteBuf[] buffers, int offset) {
        // å…ˆåˆå§‹åŒ–ä¸€ä¸ªç©ºçš„ CompositeByteBuf
        // initSize ä¸º buffers.length - offset
        this(alloc, direct, maxNumComponents, buffers.length - offset);
        // ä¸ºæ‰€æœ‰çš„ buffers åˆ›å»º  Component å®ä¾‹ï¼Œå¹¶æ·»åŠ åˆ° components æ•°ç»„ä¸­
        addComponents0(false, 0, buffers, offset);
        // å¦‚æœå½“å‰ component çš„ä¸ªæ•°å·²ç»è¶…è¿‡äº† maxNumComponentsï¼Œåˆ™å°†æ‰€æœ‰ component åˆå¹¶æˆä¸€ä¸ª
        consolidateIfNeeded();
        // è®¾ç½® CompositeByteBuf çš„ readerIndex = 0
        // writerIndex ä¸ºæœ€åä¸€ä¸ª component çš„ endOffset
        setIndex0(0, capacity());
    }
</code></pre></div><h4 id="_2-8-3-shiftcomps-ä¸ºæ–°çš„-bytebuf-è…¾æŒªç©ºé—´"><a href="#_2-8-3-shiftcomps-ä¸ºæ–°çš„-bytebuf-è…¾æŒªç©ºé—´" class="header-anchor">#</a> <strong>2.8.3 shiftComps ä¸ºæ–°çš„ ByteBuf è…¾æŒªç©ºé—´</strong></h4> <p>åœ¨æ•´ä¸ª CompositeByteBuf çš„æ„é€ è¿‡ç¨‹ä¸­ï¼Œæœ€æ ¸å¿ƒä¹Ÿæ˜¯æœ€å¤æ‚çš„æ­¥éª¤å…¶å®å°±æ˜¯ <code>addComponents0</code> æ–¹æ³•ï¼Œå°†å¤šä¸ª ByteBuf  æœ‰åºçš„æ·»åŠ åˆ° CompositeByteBuf çš„ components æ•°ç»„ä¸­çœ‹ä¼¼ç®€å•ï¼Œå…¶å®è¿˜æœ‰å¾ˆå¤šç§å¤æ‚çš„æƒ…å†µéœ€è¦è€ƒè™‘ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>å¤æ‚ä¹‹å¤„åœ¨äºè¿™äº› ByteBuf éœ€è¦æ’åœ¨ components æ•°ç»„çš„å“ªä¸ªä½ç½®ä¸Š ï¼Ÿ æ¯”è¾ƒç®€å•ç›´è§‚çš„æƒ…å†µæ˜¯æˆ‘ä»¬ç›´æ¥åœ¨ components æ•°ç»„çš„æœ«å°¾æ’å…¥ï¼Œä¹Ÿå°±æ˜¯è¯´è¦æ’å…¥çš„ä½ç½®ç´¢å¼• cIndex ç­‰äº componentCountã€‚è¿™é‡Œåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š</p> <ol><li><code>cIndex = componentCount = 0</code> ï¼Œè¿™ç§æƒ…å†µè¡¨ç¤ºæˆ‘ä»¬åœ¨å‘ä¸€ä¸ªç©ºçš„ CompositeByteBuf æ’å…¥ ByteBufs , å¾ˆç®€å•ï¼Œç›´æ¥æ’å…¥å³å¯ã€‚</li> <li><code>cIndex = componentCount &gt; 0</code> ï¼Œ è¿™ç§æƒ…å†µè¡¨ç¤ºæˆ‘ä»¬å†å‘ä¸€ä¸ªéç©ºçš„ CompositeByteBuf æ’å…¥ ByteBufsï¼Œæ­£å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚åŒæ ·ä¹Ÿå¾ˆç®€å•ï¼Œç›´æ¥åœ¨ componentCount çš„ä½ç½®å¤„æ’å…¥å³å¯ã€‚</li></ol> <p>ç¨å¾®å¤æ‚ä¸€ç‚¹çš„æƒ…å†µæ˜¯æˆ‘ä»¬åœ¨ components æ•°ç»„çš„ä¸­é—´ä½ç½®è¿›è¡Œæ’å…¥è€Œä¸æ˜¯åœ¨æœ«å°¾ï¼Œä¹Ÿå°±æ˜¯ <code>cIndex &lt; componentCount</code> çš„æƒ…å†µã€‚å¦‚ä¸‹å¦‚å›¾æ‰€ç¤ºï¼Œå‡è®¾æˆ‘ä»¬ç°åœ¨éœ€è¦åœ¨ <code>cIndex = 3</code>çš„ä½ç½®å¤„æ’å…¥ä¸¤ä¸ª ByteBuf è¿›æ¥ï¼Œä½†ç°åœ¨ components[3] ä»¥åŠ components[4] çš„ä½ç½®å·²ç»è¢«å ç”¨äº†ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†è¿™ä¸¤ä¸ªä½ç½®ä¸Šçš„åŸæœ‰ component å‘åç§»åŠ¨ä¸¤ä¸ªä½ç½®ï¼Œå°† components[3] å’Œ components[4] çš„ä½ç½®è…¾å‡ºæ¥ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>// i = 3 , count = 2 , size = 5
System.arraycopy(components, i, components, i + count, size - i);
</code></pre></div><p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191121207.webp" alt="å›¾ç‰‡">image.png</p> <p>åœ¨å¤æ‚ä¸€ç‚¹çš„æƒ…å†µå°±æ˜¯ components æ•°ç»„éœ€è¦æ‰©å®¹ï¼Œå½“ä¸€ä¸ª CompositeByteBuf åˆšåˆšè¢«åˆå§‹åŒ–å‡ºæ¥çš„æ—¶å€™ï¼Œå®ƒçš„ components æ•°ç»„é•¿åº¦ç­‰äº maxNumComponentsã€‚</p> <p>å¦‚æœå½“å‰ components æ•°ç»„ä¸­åŒ…å«çš„ component ä¸ªæ•° â€”â€” componentCount åŠ ä¸Šæœ¬æ¬¡éœ€è¦æ·»åŠ çš„ ByteBuf ä¸ªæ•° â€”â€” count å·²ç»è¶…è¿‡äº† maxNumComponents çš„æ—¶å€™ï¼Œå°±éœ€è¦å¯¹ components æ•°ç»„è¿›è¡Œæ‰©å®¹ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>        // åˆå§‹ä¸º 0ï¼Œå½“å‰ CompositeByteBuf ä¸­åŒ…å«çš„ component ä¸ªæ•°
        final int size = componentCount, 
        // æœ¬æ¬¡ addComponents0 æ“ä½œä¹‹åï¼Œæ–°çš„ component ä¸ªæ•°
        newSize = size + count;
       
        // newSize è¶…è¿‡äº† maxNumComponents åˆ™å¯¹ components æ•°ç»„è¿›è¡Œæ‰©å®¹
        if (newSize &gt; components.length) {
            ....... æ‰©å®¹ ....

            // æ‰©å®¹åçš„æ–°æ•°ç»„
            components = newArr;
        }
</code></pre></div><p>æ‰©å®¹ä¹‹åçš„ components æ•°ç»„é•¿åº¦æ˜¯åœ¨ newSize ä¸åŸæ¥é•¿åº¦çš„ <code>3 / 2</code>ä¹‹é—´å–ä¸€ä¸ªæœ€å¤§å€¼ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>int newArrSize = Math.max(size + (size &gt;&gt; 1), newSize);
</code></pre></div><p>å¦‚æœæˆ‘ä»¬åŸæ¥æ°å¥½æ˜¯å¸Œæœ›åœ¨ components æ•°ç»„çš„æœ«å°¾æ’å…¥ï¼Œä¹Ÿå°±æ˜¯ <code>cIndex = componentCount</code> çš„æƒ…å†µï¼Œé‚£ä¹ˆå°±éœ€è¦é€šè¿‡ <code>Arrays.copyOf</code> é¦–å…ˆç”³è¯·ä¸€æ®µé•¿åº¦ä¸º newArrSize çš„æ•°ç»„ï¼Œç„¶åå°†åŸæ¥çš„ components æ•°ç»„ä¸­çš„å†…å®¹åŸæ ·æ‹·è´è¿‡å»ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>newArr = Arrays.copyOf(components, newArrSize, Component[].class);
</code></pre></div><p>è¿™æ ·æ–°çš„ components æ•°ç»„å°±æœ‰ä½ç½®å¯ä»¥å®¹çº³æœ¬æ¬¡éœ€è¦åŠ å…¥çš„ ByteBuf äº†ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>å¦‚æœæˆ‘ä»¬å¸Œæœ›åœ¨åŸæ¥ components æ•°ç»„çš„ä¸­é—´æ’å…¥ï¼Œä¹Ÿå°±æ˜¯ <code>cIndex &lt; componentCount</code> çš„æƒ…å†µï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191121796.webp" alt="å›¾ç‰‡">image.png</p> <p>è¿™ç§æƒ…å†µåœ¨æ‰©å®¹çš„æ—¶å€™å°±ä¸èƒ½åŸæ ·æ‹·è´åŸ components æ•°ç»„äº†ï¼Œè€Œæ˜¯é¦–å…ˆé€šè¿‡ <code>System.arraycopy</code> å°† <code>[0 , cIndex)</code> è¿™æ®µèŒƒå›´çš„å†…å®¹æ‹·è´è¿‡å»ï¼Œåœ¨å°† <code>[cIndex , componentCount)</code>è¿™æ®µèŒƒå›´çš„å†…å®¹æ‹·è´åˆ°æ–°æ•°ç»„çš„ <code>cIndex + count</code> ä½ç½®å¤„ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191122454.webp" alt="å›¾ç‰‡">image.png</p> <p>è¿™æ ·ä¸€æ¥ï¼Œå°±åœ¨æ–° components æ•°ç»„çš„ cIndex ç´¢å¼•å¤„ï¼Œç©ºå‡ºäº†ä¸¤ä¸ªä½ç½®å‡ºæ¥ç”¨æ¥æ·»åŠ æœ¬æ¬¡è¿™ä¸¤ä¸ª ByteBufã€‚æœ€åæ›´æ–° componentCount çš„å€¼ã€‚ä»¥ä¸Šè…¾æŒªç©ºé—´çš„é€»è¾‘å°è£…åœ¨ shiftComps æ–¹æ³•ä¸­ï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>    private void shiftComps(int i, int count) {
        // åˆå§‹ä¸º 0ï¼Œå½“å‰ CompositeByteBuf ä¸­åŒ…å«çš„ component ä¸ªæ•°
        final int size = componentCount, 
        // æœ¬æ¬¡ addComponents0 æ“ä½œä¹‹åï¼Œæ–°çš„ component ä¸ªæ•°
        newSize = size + count;
       
        // newSize è¶…è¿‡äº† max componentsï¼ˆ16ï¼‰ åˆ™å¯¹ components æ•°ç»„è¿›è¡Œæ‰©å®¹
        if (newSize &gt; components.length) {
            // grow the arrayï¼Œæ‰©å®¹åˆ°åŸæ¥çš„ 3 / 2
            int newArrSize = Math.max(size + (size &gt;&gt; 1), newSize);
            Component[] newArr;
            if (i == size) {
                // åœ¨ Component[] æ•°ç»„çš„æœ«å°¾è¿›è¡Œæ’å…¥
                // åˆå§‹çŠ¶æ€ i = size = 0
                // size - 1 æ˜¯ Component[] æ•°ç»„çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼ŒæŒ‡å®šçš„ i æ°å¥½è¶Šç•Œ
                // åŸæ¥ Component[] æ•°ç»„ä¸­çš„å†…å®¹å…¨éƒ¨æ‹·è´åˆ° newArr ä¸­
                newArr = Arrays.copyOf(components, newArrSize, Component[].class);
            } else {
                // åœ¨ Component[] æ•°ç»„çš„ä¸­é—´è¿›è¡Œæ’å…¥
                newArr = new Component[newArrSize];
                if (i &gt; 0) {
                    // [0 , i) ä¹‹é—´çš„å†…å®¹æ‹·è´åˆ° newArr ä¸­
                    System.arraycopy(components, 0, newArr, 0, i);
                }
                if (i &lt; size) {
                    // å°†å‰©ä¸‹çš„ [i , size) å†…å®¹ä» newArr çš„ i + count ä½ç½®å¤„å¼€å§‹æ‹·è´ã€‚
                    // å› ä¸ºéœ€è¦å°†åŸæ¥çš„ [ i , i+count ï¼‰ è¿™äº›ä½ç½®è®©å‡ºæ¥ï¼Œæ·»åŠ æœ¬æ¬¡æ–°çš„ componentsï¼Œ
                    System.arraycopy(components, i, newArr, i + count, size - i);
                }
            }
            // æ‰©å®¹åçš„æ–°æ•°ç»„
            components = newArr;
        } else if (i &lt; size) {
            // i &lt; size æœ¬æ¬¡æ“ä½œè¦è¦†ç›–åŸæ¥çš„ [ i , i+count ï¼‰ ä¹‹é—´çš„ä½ç½®ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦å°†åŸæ¥ä½ç½®ä¸Šçš„ component å‘åç§»åŠ¨
            System.arraycopy(components, i, components, i + count, size - i);
        }
        // æ›´æ–° componentCount
        componentCount = newSize;
    }
</code></pre></div><h4 id="_2-8-4-component-å¦‚ä½•å°è£…-bytebuf"><a href="#_2-8-4-component-å¦‚ä½•å°è£…-bytebuf" class="header-anchor">#</a> <strong>2.8.4 Component å¦‚ä½•å°è£… ByteBuf</strong></h4> <p>ç»è¿‡ä¸Šä¸€å°èŠ‚ shiftComps æ–¹æ³•çš„è¾—è½¬è…¾æŒªä¹‹åï¼Œç°åœ¨ CompositeByteBuf ä¸­çš„ components æ•°ç»„ç»ˆäºæœ‰ä½ç½®å¯ä»¥å®¹çº³æœ¬æ¬¡éœ€è¦æ·»åŠ çš„ ByteBuf äº†ã€‚æ¥ä¸‹æ¥å°±éœ€è¦ä¸ºæ¯ä¸€ä¸ª ByteBuf åˆ›å»ºåˆå§‹åŒ–ä¸€ä¸ª Component å®ä¾‹ï¼Œæœ€åå°†è¿™äº› Component å®ä¾‹æ”¾åˆ° components æ•°ç»„å¯¹åº”çš„ä½ç½®ä¸Šã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private static final class Component {
        // åŸç”Ÿ ByteBuf
        final ByteBuf srcBuf; 
        // CompositeByteBuf çš„ index åŠ ä¸Š srcAdjustment å°±å¾—åˆ°äº†srcBuf çš„ç›¸å…³ index
        int srcAdjustment; 
        // srcBuf å¯èƒ½æ˜¯ä¸€ä¸ªè¢«åŒ…è£…è¿‡çš„ ByteBufï¼Œæ¯”å¦‚ SlicedByteBuf ï¼Œ DuplicatedByteBuf
        // è¢« srcBuf åŒ…è£…çš„æœ€åº•å±‚çš„ ByteBuf å°±å­˜æ”¾åœ¨ buf å­—æ®µä¸­
        final ByteBuf buf;      
        // CompositeByteBuf çš„ index åŠ ä¸Š adjustment å°±å¾—åˆ°äº† buf çš„ç›¸å…³ index      
        int adjustment; 
 
        // è¯¥ Component åœ¨ CompositeByteBuf è§†è§’ä¸­è¡¨ç¤ºçš„æ•°æ®èŒƒå›´ [offset , endOffset)
        int offset; 
        int endOffset;        
    }
</code></pre></div><p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>æˆ‘ä»¬é¦–å…ˆéœ€è¦åˆå§‹åŒ– Component å®ä¾‹çš„ offset ï¼Œ endOffset å±æ€§ï¼Œå‰é¢æˆ‘ä»¬å·²ç»ä»‹ç»äº†ï¼Œä¸€ä¸ª Component åœ¨ CompositeByteBuf çš„è§†è§’ä¸­æ‰€èƒ½è¡¨ç¤ºçš„æ•°æ®é€»è¾‘èŒƒå›´æ˜¯ <code>[offset , endOffset)</code>ã€‚åœ¨ components æ•°ç»„ä¸­ï¼Œä¸€èˆ¬å‰ä¸€ä¸ª Component çš„ endOffset å¾€å¾€æ˜¯åä¸€ä¸ª Component çš„ offsetã€‚</p> <p>å¦‚æœæˆ‘ä»¬æœŸæœ›ä» components æ•°ç»„çš„ç¬¬ä¸€ä¸ªä½ç½®å¤„å¼€å§‹æ’å…¥ï¼ˆcIndex = 0ï¼‰ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ª Component çš„ offset è‡ªç„¶æ˜¯ 0 ã€‚</p> <p>å¦‚æœ cIndex &gt; 0 , é‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦æ‰¾åˆ°å®ƒä¸Šä¸€ä¸ª Component â€”â€” components[cIndex - 1] ï¼Œ ä¸Šä¸€ä¸ª Component çš„ endOffset æ°å¥½å°±æ˜¯å½“å‰ Component çš„ offsetã€‚</p> <p>ç„¶åé€šè¿‡ <code>newComponent</code> æ–¹æ³•åˆ©ç”¨ ByteBuf ç›¸å…³å±æ€§ä»¥åŠ offset æ¥åˆå§‹åŒ– Component å®ä¾‹ã€‚éšåå°†åˆ›å»ºå‡ºæ¥çš„ Component å®ä¾‹æ”¾ç½®åœ¨å¯¹åº”çš„ä½ç½®ä¸Š â€”â€” components[cIndex] ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>           // è·å–å½“å‰æ­£åœ¨æ’å…¥ Component çš„ offset
           int nextOffset = cIndex &gt; 0 ? components[cIndex - 1].endOffset : 0;
            for (ci = cIndex; arrOffset &lt; len; arrOffset++, ci++) {
                // å¾…æ’å…¥ ByteBuf
                ByteBuf b = buffers[arrOffset];
                if (b == null) {
                    break;
                }
                // å°† ByteBuf å°è£…åœ¨ Component ä¸­
                Component c = newComponent(ensureAccessible(b), nextOffset);
                components[ci] = c;
                // ä¸‹ä¸€ä¸ª Component çš„ Offset æ˜¯ä¸Šä¸€ä¸ª Component çš„ endOffset
                nextOffset = c.endOffset;
            }
</code></pre></div><p>å‡è®¾ç°åœ¨æœ‰ä¸€ä¸ªç©ºçš„ CompositeByteBufï¼Œæˆ‘ä»¬éœ€è¦å°†ä¸€ä¸ªæ•°æ®èŒƒå›´ä¸º <code>[1 , 4]</code> , readerIndex = 1 çš„ srcBuf ï¼Œ æ’å…¥åˆ° CompositeByteBuf çš„ components æ•°ç»„ä¸­ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>ä½†æ˜¯å¦‚æœè¯¥ srcBuf æ˜¯ä¸€ä¸ªè§†å›¾ ByteBuf çš„è¯ï¼Œæ¯”å¦‚ï¼šSlicedByteBuf ï¼Œ DuplicatedByteBufã€‚æˆ–è€…æ˜¯ä¸€ä¸ªè¢«åŒ…è£…è¿‡çš„ ByteBuf ï¼Œæ¯”å¦‚ï¼šWrappedByteBuf ï¼Œ SwappedByteBufã€‚</p> <p>é‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦å¯¹ srcBuf ä¸æ–­çš„æ‰§è¡Œ <code>unwrap()</code>, å°†å…¶æœ€åº•å±‚çš„åŸç”Ÿ ByteBuf æå–å‡ºæ¥ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒåŸç”Ÿ buf çš„æ•°æ®èŒƒå›´ä¸º <code>[4 , 7]</code> , srcBuf ä¸ buf ä¹‹é—´ç›¸å…³ index çš„åç§» adjustment ç­‰äº 3  , åŸç”Ÿ buf çš„ readerIndex = 4 ã€‚</p> <p>æœ€åæˆ‘ä»¬ä¼šæ ¹æ® srcBuf ï¼Œ srcIndexï¼ˆsrcBuf çš„ readerIndexï¼‰ï¼ŒåŸç”Ÿ buf ï¼ŒunwrappedIndexï¼ˆbuf çš„ readerIndexï¼‰ï¼Œoffset ï¼Œ len ï¼ˆsrcBuf ä¸­çš„å¯è¯»å­—èŠ‚æ•°ï¼‰æ¥åˆå§‹åŒ– Component å®ä¾‹ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private Component newComponent(final ByteBuf buf, final int offset) {
        // srcBuf çš„ readerIndex = 1
        final int srcIndex = buf.readerIndex();
        // srcBuf ä¸­çš„å¯è¯»å­—èŠ‚æ•° = 4
        final int len = buf.readableBytes();

        // srcBuf å¯èƒ½æ˜¯ä¸€ä¸ªè¢«åŒ…è£…è¿‡çš„ ByteBufï¼Œæ¯”å¦‚ SlicedByteBufï¼ŒDuplicatedByteBuf
        // è·å– srcBuf åº•å±‚çš„åŸç”Ÿ ByteBuf
        ByteBuf unwrapped = buf;
        // åŸç”Ÿ ByteBuf çš„ readerIndex
        int unwrappedIndex = srcIndex;
        while (unwrapped instanceof WrappedByteBuf || unwrapped instanceof SwappedByteBuf) {
            unwrapped = unwrapped.unwrap();
        }

        // unwrap if already sliced
        if (unwrapped instanceof AbstractUnpooledSlicedByteBuf) {
            // è·å–è§†å›¾ ByteBuf  ç›¸å¯¹äº åŸç”Ÿ ByteBuf çš„ç›¸å…³ index åç§»
            // adjustment = 3
            // unwrappedIndex = srcIndex + adjustment = 4
            unwrappedIndex += ((AbstractUnpooledSlicedByteBuf) unwrapped).idx(0);
            // è·å–åŸç”Ÿ ByteBuf
            unwrapped = unwrapped.unwrap();
        } else if (unwrapped instanceof PooledSlicedByteBuf) {
            unwrappedIndex += ((PooledSlicedByteBuf) unwrapped).adjustment;
            unwrapped = unwrapped.unwrap();
        } else if (unwrapped instanceof DuplicatedByteBuf || unwrapped instanceof PooledDuplicatedByteBuf) {
            unwrapped = unwrapped.unwrap();
        }

        return new Component(buf.order(ByteOrder.BIG_ENDIAN), srcIndex,
                unwrapped.order(ByteOrder.BIG_ENDIAN), unwrappedIndex, offset, len, slice);
    }
</code></pre></div><p>ç”±äºå½“å‰çš„ CompositeByteBuf è¿˜æ˜¯ç©ºçš„ï¼Œé‡Œé¢æ²¡æœ‰åŒ…å«ä»»ä½•é€»è¾‘æ•°æ®ï¼Œå½“é•¿åº¦ä¸º 4 çš„ srcBuf åŠ å…¥ä¹‹åï¼ŒCompositeByteBuf å°±äº§ç”Ÿäº† <code>[0 , 3]</code> è¿™æ®µé€»è¾‘æ•°æ®èŒƒå›´ï¼Œæ‰€ä»¥ srcBuf æ‰€å± Component çš„ offset = 0 , endOffset = 4 ï¼ŒsrcAdjustment = 1 ï¼Œadjustment = 4ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191122367.webp" alt="å›¾ç‰‡">image.png</p> <div class="language- extra-class"><pre class="language-text"><code>        Component(ByteBuf srcBuf, int srcOffset, ByteBuf buf, int bufOffset,
                int offset, int len, ByteBuf slice) {
            this.srcBuf = srcBuf;
            // ç”¨äºå°† CompositeByteBuf çš„ index è½¬æ¢ä¸º srcBuf çš„index
            // 1 - 0 = 1
            this.srcAdjustment = srcOffset - offset;
            this.buf = buf;
            // ç”¨äºå°† CompositeByteBuf çš„ index è½¬æ¢ä¸º buf çš„index
            // 4 - 0 = 4
            this.adjustment = bufOffset - offset;
            // CompositeByteBuf [offset , endOffset) è¿™æ®µèŒƒå›´çš„å­—èŠ‚å­˜å‚¨åœ¨è¯¥ Component ä¸­
            //  0 
            this.offset = offset;
            // ä¸‹ä¸€ä¸ª Component çš„ offset
            // 4
            this.endOffset = offset + len;
        }
</code></pre></div><p>å½“æˆ‘ä»¬ç»§ç»­åˆå§‹åŒ–ä¸‹ä¸€ä¸ª Component çš„æ—¶å€™ï¼Œå®ƒçš„ Offset å…¶å®å°±æ˜¯è¿™ä¸ª Component çš„ endOffset ã€‚åé¢çš„æµç¨‹éƒ½æ˜¯ä¸€æ ·çš„äº†ã€‚</p> <h4 id="_2-8-5-addcomponents0"><a href="#_2-8-5-addcomponents0" class="header-anchor">#</a> <strong>2.8.5 addComponents0</strong></h4> <p>åœ¨æˆ‘ä»¬æ¸…æ¥šäº†ä»¥ä¸ŠèƒŒæ™¯çŸ¥è¯†ä¹‹åï¼Œåœ¨çœ‹ addComponents0 æ–¹æ³•çš„é€»è¾‘å°±å¾ˆæ¸…æ™°äº†ï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>    private CompositeByteBuf addComponents0(boolean increaseWriterIndex,
            final int cIndex, ByteBuf[] buffers, int arrOffset) {
        // buffers æ•°ç»„é•¿åº¦
        final int len = buffers.length, 
        // æœ¬æ¬¡æ‰¹é‡æ·»åŠ çš„ ByteBuf ä¸ªæ•°
        count = len - arrOffset;
        // ci è¡¨ç¤ºä» components æ•°ç»„çš„å“ªä¸ªç´¢å¼•ä½ç½®å¤„å¼€å§‹æ·»åŠ 
        // è¿™é‡Œå…ˆç»™ä¸€ä¸ªåˆå§‹å€¼ï¼Œåç»­ shiftComps å®Œæˆä¹‹åè¿˜ä¼šé‡æ–°è®¾ç½®
        int ci = Integer.MAX_VALUE;
        try {
            // cIndex &gt;= 0 &amp;&amp; cIndex &lt;= componentCount
            checkComponentIndex(cIndex);
            // ä¸ºæ–°æ·»åŠ è¿›æ¥çš„ ByteBuf è…¾æŒªä½ç½®ï¼Œä»¥åŠå¢åŠ  componentCount è®¡æ•°
            shiftComps(cIndex, count); // will increase componentCount
            // è·å–å½“å‰æ­£åœ¨æ’å…¥ Component çš„ offset
            int nextOffset = cIndex &gt; 0 ? components[cIndex - 1].endOffset : 0;
            for (ci = cIndex; arrOffset &lt; len; arrOffset++, ci++) {
                ByteBuf b = buffers[arrOffset];
                if (b == null) {
                    break;
                }
                // å°† ByteBuf å°è£…åœ¨ Component ä¸­
                Component c = newComponent(ensureAccessible(b), nextOffset);
                components[ci] = c;
                // ä¸‹ä¸€ä¸ª Component çš„ Offset æ˜¯ä¸Šä¸€ä¸ª Component çš„ endOffset
                nextOffset = c.endOffset;
            }
            return this;
        } finally {
            // ci is now the index following the last successfully added component
            // ci = componentCount è¯´æ˜æ˜¯ä¸€ç›´æŒ‰ç…§é¡ºåºå‘åè¿½åŠ  component
            // ci &lt; componentCount è¡¨ç¤ºåœ¨ components æ•°ç»„çš„ä¸­é—´æ’å…¥æ–°çš„ component
            if (ci &lt; componentCount) {
                // å¦‚æœä¸Šé¢ for å¾ªç¯å®Œæ•´çš„èµ°å®Œï¼Œci = cIndex + count
                if (ci &lt; cIndex + count) {
                    // ä¸Šé¢ for å¾ªç¯ä¸­æœ‰ break çš„æƒ…å†µå‡ºç°æˆ–è€…æœ‰å¼‚å¸¸å‘ç”Ÿ
                    // ci &lt; componentCount ï¼Œåœ¨ä¸Šé¢çš„ shiftComps ä¸­å°†ä¼šæ¶‰åŠåˆ° component ç§»åŠ¨ï¼Œå› ä¸ºè¦è…¾å‡ºä½ç½®
                    // å¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œåˆ™å°†åé¢æ²¡æœ‰åŠ å…¥ components æ•°ç»„çš„ component ä½ç½®åˆ é™¤æ‰
                    // [ci, cIndex + count) è¿™æ®µä½ç½®è¦åˆ é™¤ï¼Œå› ä¸ºåœ¨ ci-1 å¤„å·²ç»å‘ç”Ÿå¼‚å¸¸ï¼Œé‡æ–°è°ƒæ•´ components æ•°ç»„
                    removeCompRange(ci, cIndex + count);
                    for (; arrOffset &lt; len; ++arrOffset) {
                        ReferenceCountUtil.safeRelease(buffers[arrOffset]);
                    }
                }
                // ï¼ˆåœ¨ä¸­é—´æ’å…¥çš„æƒ…å†µä¸‹ï¼‰éœ€è¦è°ƒæ•´ ci åˆ° size -1 ä¹‹é—´çš„ component çš„ç›¸å…³ Offset
                updateComponentOffsets(ci); // only need to do this here for components after the added ones
            }
            if (increaseWriterIndex &amp;&amp; ci &gt; cIndex &amp;&amp; ci &lt;= componentCount) {
                // æœ¬æ¬¡æ·»åŠ çš„æœ€åä¸€ä¸ª components[ci - 1]
                // æœ¬æ¬¡æ·»åŠ çš„ç¬¬ä¸€ä¸ª components[cIndex]
                // æœ€åä¸€ä¸ª endOffset å‡å»ç¬¬ä¸€ä¸ªçš„ offset å°±æ˜¯æœ¬æ¬¡æ·»åŠ çš„å­—èŠ‚ä¸ªæ•°
                writerIndex += components[ci - 1].endOffset - components[cIndex].offset;
            }
        }
    }
</code></pre></div><p>è¿™é‡Œæˆ‘ä»¬é‡ç‚¹ä»‹ç»ä¸‹ <code>finally {}</code> ä»£ç å—ä¸­çš„é€»è¾‘ã€‚é¦–å…ˆ addComponents0 æ–¹æ³•ä¸­çš„æ ¸å¿ƒé€»è¾‘æ˜¯å…ˆé€šè¿‡ shiftComps æ–¹æ³•ä¸ºæ¥ä¸‹æ¥æ–°åˆ›å»ºå‡ºæ¥çš„ Component è…¾æŒªä½ç½®ï¼Œå› ä¸ºæˆ‘ä»¬æœ‰å¯èƒ½æ˜¯åœ¨åŸæœ‰ components æ•°ç»„çš„ä¸­é—´ä½ç½®æ’å…¥ã€‚</p> <p>ç„¶åä¼šåœ¨ä¸€ä¸ª <code>for ()</code> å¾ªç¯ä¸­ä¸åœçš„å°†æ–°åˆ›å»ºçš„ Component æ”¾ç½®åˆ° <code>components[ci]</code> ä½ç½®ä¸Šã€‚</p> <p>å½“è·³å‡º for å¾ªç¯è¿›å…¥ finally ä»£ç å—çš„æ—¶å€™ï¼Œci çš„å€¼æ°æ°å°±æ˜¯æœ€åä¸€ä¸ªæˆåŠŸåŠ å…¥ components æ•°ç»„çš„ Component ä¸‹ä¸€ä¸ªä½ç½®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå‡è®¾ components[0] ï¼Œ components[1] ï¼Œcomponents[2]  æ˜¯æˆ‘ä»¬åˆšåˆšåœ¨ for å¾ªç¯ä¸­æ’å…¥çš„æ–°å€¼ï¼Œé‚£ä¹ˆ for å¾ªç¯ç»“æŸä¹‹åï¼Œci çš„å€¼å°±æ˜¯ 3 ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>å¦‚æœ <code>ci = componentCount</code> è¿™æ°æ°è¯´æ˜æˆ‘ä»¬ä¸€ç›´æ˜¯åœ¨ components æ•°ç»„çš„æœ«å°¾è¿›è¡Œæ’å…¥ï¼Œè¿™ç§æƒ…å†µä¸‹å„ä¸ª Component å®ä¾‹ä¸­çš„ [offset , endOffset) éƒ½æ˜¯è¿ç»­çš„ä¸éœ€è¦åšä»»ä½•è°ƒæ•´ã€‚</p> <p>ä½†å¦‚æœ <code>ci &lt; componentCount</code> è¿™å°±è¯´æ˜äº†æˆ‘ä»¬æ˜¯åœ¨åŸæ¥ components æ•°ç»„çš„ä¸­é—´ä½ç½®å¤„å¼€å§‹æ’å…¥ï¼Œä¸‹å›¾ä¸­çš„ components[3] ï¼Œcomponents[4] æ˜¯æ’å…¥ä½ç½®ï¼Œå½“æ’å…¥å®Œæˆä¹‹å ci çš„å€¼ä¸º 5ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>è¿™æ—¶å€™å°±éœ€è¦é‡æ–°è°ƒæ•´ components[5]ï¼Œcomponents[6] ä¸­çš„  <code>[offset , endOffset)</code> èŒƒå›´ï¼Œå› ä¸º shiftComps æ–¹æ³•åªè´Ÿè´£å¸®ä½ è…¾æŒªä½ç½®ï¼Œä¸è´Ÿè´£é‡æ–°è°ƒæ•´ <code>[offset , endOffset)</code> èŒƒå›´ï¼Œå½“æ–°çš„ Component å®ä¾‹æ’å…¥ä¹‹åï¼ŒåŸæ¥å½¼æ­¤ç›¸é‚»çš„ Component å®ä¾‹ä¹‹é—´çš„ <code>[offset , endOffset)</code> å°±ä¸è¿ç»­äº†ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦é‡æ–°è°ƒæ•´ã€‚</p> <p>æ¯”å¦‚ä¸‹å›¾ä¸­æ‰€å±•ç¤ºçš„æƒ…å†µï¼ŒåŸæ¥çš„ components æ•°ç»„åŒ…å«äº”ä¸ª Component å®ä¾‹ï¼Œåˆ†åˆ«åœ¨ 0 - 4 ä½ç½®ï¼Œå®ƒä»¬ä¹‹é—´åŸæœ¬çš„æ˜¯è¿ç»­çš„ <code>[offset , endOffset)</code>ã€‚</p> <p>![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)image.png</p> <p>ç°åœ¨æˆ‘ä»¬è¦åœ¨ä½ç½® 3 ï¼Œ4 å¤„æ’å…¥ä¸¤ä¸ªæ–°çš„ Component å®ä¾‹ï¼Œæ‰€ä»¥åŸæ¥çš„  components[3] ï¼Œcomponents[4] éœ€è¦ç§»åŠ¨åˆ°  components[5] ï¼Œcomponents[6] çš„ä½ç½®ä¸Šï¼Œä½† shiftComps åªè´Ÿè´£ç§»åŠ¨è€Œä¸è´Ÿè´£é‡æ–°è°ƒæ•´å®ƒä»¬çš„ <code>[offset , endOffset)</code>ã€‚</p> <p>å½“æ–°çš„ Component å®ä¾‹æ’å…¥ä¹‹åï¼Œcomponents[4]ï¼Œcomponents[5] ï¼Œcomponents[6] ä¹‹é—´çš„  <code>[offset , endOffset)</code> å°±ä¸è¿ç»­äº†ã€‚æ‰€ä»¥éœ€è¦é€šè¿‡ <code>updateComponentOffsets</code> æ–¹æ³•é‡æ–°è°ƒæ•´ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private void updateComponentOffsets(int cIndex) {
        int size = componentCount;
        if (size &lt;= cIndex) {
            return;
        }
        // é‡æ–°è°ƒæ•´ components[5] ï¼Œcomponents[6] ä¹‹é—´çš„ [offset , endOffset)
        int nextIndex = cIndex &gt; 0 ? components[cIndex - 1].endOffset : 0;
        for (; cIndex &lt; size; cIndex++) {
            Component c = components[cIndex];
            // é‡æ–°è°ƒæ•´ Component çš„ offset ï¼Œ endOffset
            c.reposition(nextIndex);
            nextIndex = c.endOffset;
        }
    }

     void reposition(int newOffset) {
            int move = newOffset - offset;
            endOffset += move;
            srcAdjustment -= move;
            adjustment -= move;
            offset = newOffset;
      }
        
</code></pre></div><p>ä»¥ä¸Šä»‹ç»çš„æ˜¯æ­£å¸¸æƒ…å†µä¸‹çš„é€»è¾‘ï¼Œå¦‚æœåœ¨æ‰§è¡Œ for å¾ªç¯çš„è¿‡ç¨‹ä¸­å‡ºç°äº† break æˆ–è€…å‘ç”Ÿäº†å¼‚å¸¸ï¼Œé‚£ä¹ˆ ci çš„å€¼ä¸€å®šæ˜¯å°äº <code>cIndex + count</code> çš„ã€‚ä»€ä¹ˆæ„æ€å‘¢ ï¼Ÿ</p> <p>æ¯”å¦‚æˆ‘ä»¬è¦å‘ä¸€ä¸ª components æ•°ç»„ <code>cIndex = 0</code> çš„ä½ç½®æ’å…¥ <code>count = 5</code> ä¸ª Component å®ä¾‹ï¼Œä½†æ˜¯åœ¨æ’å…¥ç¬¬å››ä¸ª Component çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯åœ¨ components[3] çš„ä½ç½®å¤„å‡ºç°äº† break æˆ–è€…å¼‚å¸¸çš„æƒ…å†µï¼Œé‚£ä¹ˆå°±ä¼šé€€å‡º for å¾ªç¯æ¥åˆ°è¿™é‡Œçš„ finally ä»£ç å—ã€‚</p> <p>æ­¤æ—¶çš„ ci å€¼ä¸º 3 ï¼ŒcIndex + count çš„å€¼ä¸º 5ï¼Œé‚£ä¹ˆå°±è¯´æ˜å‡ºç°äº†å¼‚å¸¸æƒ…å†µã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191122096.webp" alt="å›¾ç‰‡">image.png</p> <p>å€¼å¾—æˆ‘ä»¬æ³¨æ„çš„æ˜¯ï¼Œcomponents[3] ä»¥åŠ components[4] è¿™ä¸¤ä¸ªä½ç½®æ˜¯ä¹‹å‰é€šè¿‡ shiftComps æ–¹æ³•è…¾æŒªå‡ºæ¥çš„ï¼Œç”±äºå¼‚å¸¸æƒ…å†µçš„å‘ç”Ÿï¼Œè¿™ä¸¤ä¸ªä½ç½®å°†ä¸ä¼šæ”¾ç½®ä»»ä½• Component å®ä¾‹ã€‚</p> <p>è¿™æ ·ä¸€æ¥ components æ•°ç»„å°±å‡ºç°äº†ç©ºæ´ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬è¿˜éœ€è¦å°† components[5] ï¼Œ components[6] ä½ç½®ä¸Šçš„ Component å®ä¾‹é‡æ–°ç§»åŠ¨å› components[3] ä»¥åŠ components[4] çš„ä½ç½®ä¸Šã€‚</p> <p>ç”±äºå¼‚å¸¸æƒ…å†µï¼Œé‚£äº› ByteBuf æ•°ç»„ä¸­æ²¡æœ‰è¢«æ·»åŠ è¿› CompositeByteBuf çš„  ByteBuf éœ€è¦æ‰§è¡Œ release ã€‚</p> <h4 id="_2-8-6-consolidateifneeded"><a href="#_2-8-6-consolidateifneeded" class="header-anchor">#</a> <strong>2.8.6 consolidateIfNeeded</strong></h4> <p>åˆ°ç°åœ¨ä¸ºæ­¢ä¸€ä¸ªç©ºçš„ CompositeByteBuf å°±ç®—è¢«å¡«å……å¥½äº†ï¼Œä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ CompositeByteBuf ä¸­æ‰€èƒ½åŒ…å«çš„ Component å®ä¾‹ä¸ªæ•°æ˜¯å—åˆ° maxNumComponents é™åˆ¶çš„ã€‚</p> <p>æˆ‘ä»¬å›é¡¾ä¸€ä¸‹æ•´ä¸ª addComponents çš„è¿‡ç¨‹ï¼Œå¥½åƒè¿˜æ²¡æœ‰ä¸€ä¸ªåœ°æ–¹å¯¹ Component çš„ä¸ªæ•°åšå‡ºé™åˆ¶ï¼Œç”šè‡³åœ¨ shiftComps æ–¹æ³•ä¸­è¿˜ä¼šå¯¹ components æ•°ç»„è¿›è¡Œæ‰©å®¹ã€‚</p> <p>é‚£ä¹ˆè¿™æ ·ä¸€æ¥ï¼ŒComponent çš„ä¸ªæ•°æœ‰å¾ˆå¤§å¯èƒ½ä¼šè¶…è¿‡ maxNumComponents çš„é™åˆ¶ï¼Œå¦‚æœå½“å‰ CompositeByteBuf ä¸­åŒ…å«çš„ component ä¸ªæ•°å·²ç»è¶…è¿‡äº† maxNumComponents ï¼Œé‚£ä¹ˆå°±éœ€è¦åœ¨ <code>consolidate0</code> æ–¹æ³•ä¸­ï¼Œå°†æ‰€æœ‰çš„ component åˆå¹¶ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private void consolidateIfNeeded() {
        int size = componentCount;
        // å¦‚æœå½“å‰ component çš„ä¸ªæ•°å·²ç»è¶…è¿‡äº† maxNumComponentsï¼Œåˆ™å°†æ‰€æœ‰ component åˆå¹¶æˆä¸€ä¸ª
        if (size &gt; maxNumComponents) {
            consolidate0(0, size);
        }
    }
</code></pre></div><p>åœ¨è¿™é‡Œï¼ŒNetty ä¼šå°†å½“å‰ CompositeByteBuf ä¸­åŒ…å«çš„æ‰€æœ‰ Component åˆå¹¶æˆä¸€ä¸ªæ›´å¤§çš„ Componentã€‚åˆå¹¶ä¹‹å ï¼ŒCompositeByteBuf ä¸­å°±åªåŒ…å«ä¸€ä¸ª Component äº†ã€‚åˆå¹¶çš„æ ¸å¿ƒé€»è¾‘å¦‚ä¸‹ï¼š</p> <ol><li>æ ¹æ®å½“å‰  CompositeByteBuf çš„ capacity é‡æ–°ç”³è¯·ä¸€ä¸ªæ›´å¤§çš„ ByteBuf ï¼Œè¯¥  ByteBuf éœ€è¦å®¹çº³ä¸‹ CompositeByteBuf æ‰€èƒ½è¡¨ç¤ºçš„æ‰€æœ‰å­—èŠ‚ã€‚</li> <li>å°†æ‰€æœ‰ Component åº•å±‚çš„ buf ä¸­å­˜å‚¨çš„å†…å®¹å…¨éƒ¨è½¬ç§»åˆ°æ–°çš„ ByteBuf ä¸­ï¼Œå¹¶é‡Šæ”¾åŸæœ‰ buf çš„å†…å­˜ã€‚</li> <li>åˆ é™¤ Component æ•°ç»„ä¸­æ‰€æœ‰çš„ Componentã€‚</li> <li>æ ¹æ®æ–°çš„ ByteBuf åˆ›å»ºä¸€ä¸ªæ–°çš„ Component å®ä¾‹ï¼Œå¹¶æ”¾ç½®åœ¨ components æ•°ç»„çš„ç¬¬ä¸€ä¸ªä½ç½®ä¸Šã€‚</li></ol> <div class="language- extra-class"><pre class="language-text"><code>    private void consolidate0(int cIndex, int numComponents) {
        if (numComponents &lt;= 1) {
            return;
        }
        // å°† [cIndex , endCIndex) ä¹‹é—´çš„ Components åˆå¹¶æˆä¸€ä¸ª
        final int endCIndex = cIndex + numComponents;
        final int startOffset = cIndex != 0 ? components[cIndex].offset : 0;
        // è®¡ç®—åˆå¹¶èŒƒå›´å†… Components çš„å­˜å‚¨çš„å­—èŠ‚æ€»æ•°
        final int capacity = components[endCIndex - 1].endOffset - startOffset;
        // é‡æ–°ç”³è¯·ä¸€ä¸ªæ–°çš„ ByteBuf
        final ByteBuf consolidated = allocBuffer(capacity);
        // å°†åˆå¹¶èŒƒå›´å†…çš„ Components ä¸­çš„æ•°æ®å…¨éƒ¨è½¬ç§»åˆ°æ–°çš„ ByteBuf ä¸­
        for (int i = cIndex; i &lt; endCIndex; i ++) {
            components[i].transferTo(consolidated);
        }
        lastAccessed = null;
        // æ•°æ®è½¬ç§»å®Œæˆä¹‹åï¼Œå°†åˆå¹¶ä¹‹å‰çš„è¿™äº› components åˆ é™¤
        removeCompRange(cIndex + 1, endCIndex);
        // å°†åˆå¹¶ä¹‹åçš„æ–° Component å­˜å‚¨åœ¨ cIndex ä½ç½®å¤„
        components[cIndex] = newComponent(consolidated, 0);
        if (cIndex != 0 || numComponents != componentCount) {
            // å¦‚æœ cIndex ä¸æ˜¯ä» 0 å¼€å§‹çš„ï¼Œé‚£ä¹ˆå°±æ›´æ–° newComponent çš„ç›¸å…³ offset
            updateComponentOffsets(cIndex);
        }
    }
</code></pre></div><h4 id="_2-8-7-compositebytebuf-çš„åº”ç”¨"><a href="#_2-8-7-compositebytebuf-çš„åº”ç”¨" class="header-anchor">#</a> <strong>2.8.7 CompositeByteBuf çš„åº”ç”¨</strong></h4> <p>å½“æˆ‘ä»¬åœ¨ä¼ è¾“å±‚é‡‡ç”¨ TCP åè®®è¿›è¡Œæ•°æ®ä¼ è¾“çš„æ—¶å€™ï¼Œç»å¸¸ä¼šé‡åˆ°åŠåŒ…æˆ–è€…ç²˜åŒ…çš„é—®é¢˜ï¼Œæˆ‘ä»¬ä» socket ä¸­è¯»å–å‡ºæ¥çš„ ByteBuf å¾ˆå¤§å¯èƒ½è¿˜æ„ä¸æˆä¸€ä¸ªå®Œæ•´çš„åŒ…ï¼Œè¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±éœ€è¦å°†æ¯æ¬¡ä» socket ä¸­è¯»å–å‡ºæ¥çš„ ByteBuf åœ¨ç”¨æˆ·æ€ç¼“å­˜ç´¯åŠ èµ·æ¥ã€‚</p> <p>å½“ç´¯åŠ èµ·æ¥çš„ ByteBuf è¾¾åˆ°ä¸€ä¸ªå®Œæ•´çš„æ•°æ®åŒ…ä¹‹åï¼Œæˆ‘ä»¬åœ¨ä»è¿™ä¸ªè¢«ç¼“å­˜çš„ ByteBuf ä¸­è¯»å–å­—èŠ‚ï¼Œç„¶åè¿›è¡Œè§£ç ï¼Œæœ€åå°†è§£ç å‡ºæ¥çš„å¯¹è±¡æ²¿ç€ pipeline å‘åä¼ é€’ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public abstract class ByteToMessageDecoder extends ChannelInboundHandlerAdapter {
    // ç¼“å­˜ç´¯åŠ èµ·æ¥çš„ ByteBuf
    ByteBuf cumulation;
    // ByteBuf çš„ç´¯åŠ èšåˆå™¨
    private Cumulator cumulator = MERGE_CUMULATOR;
    // æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡æ”¶åŒ…
    private boolean first;

    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {
        if (msg instanceof ByteBuf) {
            // ç”¨äºå­˜å‚¨è§£ç ä¹‹åçš„å¯¹è±¡
            CodecOutputList out = CodecOutputList.newInstance();
            try {
                // ç¬¬ä¸€æ¬¡æ”¶åŒ…
                first = cumulation == null;
                // å°†æ–°è¿›æ¥çš„ (ByteBuf) msg ä¸ä¹‹å‰ç¼“å­˜çš„ cumulation èšåˆç´¯åŠ èµ·æ¥
                cumulation = cumulator.cumulate(ctx.alloc(),
                        first ? Unpooled.EMPTY_BUFFER : cumulation, (ByteBuf) msg);
                // è§£ç 
                callDecode(ctx, cumulation, out);
            } catch (DecoderException e) {
                throw e;
            } catch (Exception e) {
                throw new DecoderException(e);
            } finally {
                    ........ çœç•¥ ........
                    // è§£ç æˆåŠŸä¹‹åï¼Œå°±å°†è§£ç å‡ºæ¥çš„å¯¹è±¡æ²¿ç€ pipeline å‘åä¼ æ’­
                    fireChannelRead(ctx, out, size); 
            }
        } else {
            ctx.fireChannelRead(msg);
        }
    }
}
</code></pre></div><p>Netty ä¸ºæ­¤ä¸“é—¨å®šä¹‰äº†ä¸€ä¸ª Cumulator æ¥å£ï¼Œç”¨äºå°†æ¯æ¬¡ä» socket ä¸­è¯»å–åˆ°çš„ ByteBuf èšåˆç´¯ç§¯èµ·æ¥ã€‚å‚æ•° alloc æ˜¯ä¸€ä¸ª ByteBuf åˆ†é…å™¨ï¼Œç”¨äºåœ¨èšåˆçš„è¿‡ç¨‹ä¸­å¦‚æœæ¶‰åŠåˆ°æ‰©å®¹ï¼Œåˆå¹¶ç­‰æ“ä½œå¯ä»¥ç”¨å®ƒæ¥ç”³è¯·å†…å­˜ã€‚</p> <p>å‚æ•° cumulation å°±æ˜¯ä¹‹å‰ç¼“å­˜èµ·æ¥çš„ ByteBufï¼Œå½“ç¬¬ä¸€æ¬¡æ”¶åŒ…çš„æ—¶å€™ï¼Œè¿™é‡Œçš„ cumulation å°±æ˜¯ä¸€ä¸ªç©ºçš„ ByteBuf â€”â€” Unpooled.EMPTY_BUFFER ã€‚</p> <p>å‚æ•° in åˆ™æ˜¯æœ¬æ¬¡åˆšåˆšä» socket ä¸­è¯»å–å‡ºæ¥çš„ ByteBufï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªåŠåŒ…ï¼ŒCumulator çš„ä½œç”¨å°±æ˜¯å°†æ–°è¯»å–å‡ºæ¥çš„ ByteBuf ï¼ˆinï¼‰ï¼Œç´¯åŠ åˆå¹¶åˆ°ä¹‹å‰ç¼“å­˜çš„ ByteBuf ï¼ˆcumulationï¼‰ä¸­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    public interface Cumulator {
        ByteBuf cumulate(ByteBufAllocator alloc, ByteBuf cumulation, ByteBuf in);
    }
</code></pre></div><p>Netty æä¾›äº† Cumulator æ¥å£çš„ä¸¤ä¸ªå®ç°ï¼Œä¸€ä¸ªæ˜¯ MERGE_CUMULATOR ï¼Œ å¦ä¸€ä¸ªæ˜¯ COMPOSITE_CUMULATOR ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public abstract class ByteToMessageDecoder extends ChannelInboundHandlerAdapter {

    public static final Cumulator MERGE_CUMULATOR

    public static final Cumulator COMPOSITE_CUMULATOR
}
</code></pre></div><p>MERGE_CUMULATOR æ˜¯ Netty é»˜è®¤çš„ Cumulator ï¼Œä¹Ÿæ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šæœ€ä¸ºæ™®éçš„ä¸€ç§èšåˆ ByteBuf çš„å®ç°ï¼Œå®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯åœ¨èšåˆå¤šä¸ª ByteBuf çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šç”³è¯·ä¸€å—æ›´å¤§çš„å†…å­˜ï¼Œç„¶åå°†è¿™äº›éœ€è¦è¢«èšåˆçš„ ByteBuf ä¸­çš„å†…å®¹å…¨éƒ¨æ‹·è´åˆ°æ–°çš„ ByteBuf ä¸­ã€‚ç„¶åé‡Šæ”¾æ‰åŸæ¥çš„ ByteBuf ã€‚</p> <p>æ•ˆæœå°±æ˜¯å°†å¤šä¸ª ByteBuf é‡æ–°èšåˆæˆä¸€ä¸ªæ›´å¤§çš„ ByteBuf ï¼Œä½†è¿™ç§æ–¹å¼æ¶‰åŠåˆ°å†…å­˜ç”³è¯·ä»¥åŠå†…å­˜æ‹·è´çš„å¼€é”€ï¼Œä¼˜åŠ¿å°±æ˜¯å†…å­˜éƒ½æ˜¯è¿ç»­çš„ï¼Œè¯»å–é€Ÿåº¦å¿«ã€‚</p> <p>å¦å¤–ä¸€ç§å®ç°å°±æ˜¯ COMPOSITE_CUMULATOR ï¼Œä¹Ÿæ˜¯æœ¬å°èŠ‚çš„ä¸»é¢˜ï¼Œå®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†å¤šä¸ª ByteBuf èšåˆåˆ°ä¸€ä¸ª CompositeByteBuf ä¸­ï¼Œä¸éœ€è¦é¢å¤–ç”³è¯·å†…å­˜ï¼Œæ›´ä¸éœ€è¦å†…å­˜çš„æ‹·è´ã€‚</p> <p>ä½†ç”±äº CompositeByteBuf åªæ˜¯é€»è¾‘ä¸Šçš„ä¸€ä¸ªè§†å›¾ ByteBufï¼Œå…¶åº•å±‚ä¾èµ–çš„å†…å­˜è¿˜æ˜¯åŸæ¥çš„é‚£äº› ByteBufï¼Œæ‰€ä»¥å°±å¯¼è‡´äº† CompositeByteBuf ä¸­çš„å†…å­˜ä¸æ˜¯è¿ç»­çš„ï¼Œåœ¨åŠ ä¸Š CompositeByteBuf çš„ç›¸å…³ index è®¾è®¡çš„æ¯”è¾ƒå¤æ‚ï¼Œæ‰€ä»¥åœ¨è¯»å–é€Ÿåº¦æ–¹é¢å¯èƒ½ä¼šæ¯” MERGE_CUMULATOR æ›´æ…¢ä¸€ç‚¹ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ ¹æ®è‡ªå·±çš„åœºæ™¯æ¥æƒè¡¡è€ƒè™‘ï¼Œçµæ´»é€‰æ‹©ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    public static final Cumulator COMPOSITE_CUMULATOR = new Cumulator() {
        @Override
        public ByteBuf cumulate(ByteBufAllocator alloc, ByteBuf cumulation, ByteBuf in) {
            if (!cumulation.isReadable()) {
                // ä¹‹å‰ç¼“å­˜çš„å·²ç»è§£ç å®Œæ¯•ï¼Œè¿™é‡Œå°†å®ƒé‡Šæ”¾ï¼Œå¹¶ä» in å¼€å§‹é‡æ–°ç´¯åŠ ã€‚
                cumulation.release();
                return in;
            }
            CompositeByteBuf composite = null;
            try {
                // cumulation æ˜¯ä¸€ä¸ª CompositeByteBufï¼Œè¯´æ˜ cumulation ä¹‹å‰æ˜¯ä¸€ä¸ªè¢«èšåˆè¿‡çš„ ByteBuf
                if (cumulation instanceof CompositeByteBuf &amp;&amp; cumulation.refCnt() == 1) {
                    composite = (CompositeByteBuf) cumulation;
                    // è¿™é‡Œéœ€è¦ä¿è¯ CompositeByteBuf çš„ writerIndex ä¸ capacity ç›¸ç­‰
                    // å› ä¸ºæˆ‘ä»¬éœ€è¦æ¯æ¬¡åœ¨ CompositeByteBuf çš„æœ«å°¾èšåˆæ·»åŠ æ–°çš„ ByteBuf
                    if (composite.writerIndex() != composite.capacity()) {
                        composite.capacity(composite.writerIndex());
                    }
                } else {
                    // å¦‚æœ cumulation ä¸æ˜¯ CompositeByteBufï¼Œåªæ˜¯ä¸€ä¸ªæ™®é€šçš„ ByteBuf
                    // è¯´æ˜ cumulation ä¹‹å‰è¿˜æ²¡æœ‰è¢«èšåˆè¿‡ï¼Œè¿™é‡Œæ˜¯ç¬¬ä¸€æ¬¡èšåˆï¼Œæ‰€ä»¥éœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªç©ºçš„ CompositeByteBuf
                    // ç„¶åå°† cumulation æ·»åŠ åˆ° CompositeByteBuf ä¸­
                    composite = alloc.compositeBuffer(Integer.MAX_VALUE).addFlattenedComponents(true, cumulation);
                }
                // å°†æœ¬æ¬¡æ–°æ¥æ”¶åˆ°çš„ ByteBufï¼ˆinï¼‰æ·»åŠ ç´¯ç§¯åˆ° CompositeByteBuf ä¸­
                composite.addFlattenedComponents(true, in);
                in = null;
                return composite;
            } finally {
                 ........ çœç•¥èšåˆå¤±è´¥çš„å¤„ç† ..........
            }
        }
    };
</code></pre></div><h2 id="_3-heap-or-direct"><a href="#_3-heap-or-direct" class="header-anchor">#</a> <strong>3. Heap or Direct</strong></h2> <p>åœ¨å‰é¢çš„å‡ ä¸ªå°èŠ‚ä¸­ï¼Œæˆ‘ä»¬è®¨è®ºäº†å¾ˆå¤š ByteBuf çš„è®¾è®¡ç»†èŠ‚ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬è·³å‡ºè¿™äº›ç»†èŠ‚ï¼Œé‡æ–°ç«™åœ¨å…¨å±€çš„è§†è§’ä¸‹æ¥çœ‹ä¸€ä¸‹ ByteBuf çš„æ€»ä½“è®¾è®¡ã€‚</p> <p><img src="https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409191121381.webp" alt="å›¾ç‰‡">image.png</p> <p>åœ¨ ByteBuf çš„æ•´ä¸ªè®¾è®¡ä½“ç³»ä¸­ï¼ŒNetty ä» ByteBuf å†…å­˜å¸ƒå±€çš„è§’åº¦ä¸Šï¼Œå°†æ•´ä¸ªä½“ç³»åˆ†ä¸ºäº† HeapByteBuf å’Œ DirectByteBuf ä¸¤ä¸ªå¤§ç±»ã€‚Netty æä¾›äº† <code>PlatformDependent.directBufferPreferred()</code>æ–¹æ³•æ¥æŒ‡å®šåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œæ˜¯å¦åå‘äºåˆ†é… Direct Memoryã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public final class PlatformDependent {
    // æ˜¯å¦åå‘äºåˆ†é… Direct Memory
    private static final boolean DIRECT_BUFFER_PREFERRED;

    public static boolean directBufferPreferred() {
        return DIRECT_BUFFER_PREFERRED;
    }
}
</code></pre></div><p>è¦æƒ³ä½¿å¾— DIRECT_BUFFER_PREFERRED ä¸º true ï¼Œå¿…é¡»åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼š</p> <ol><li><code>-Dio.netty.noPreferDirect</code> å‚æ•°å¿…é¡»æŒ‡å®šä¸º falseï¼ˆé»˜è®¤ï¼‰ã€‚</li> <li>CLEANER ä¸ä¸º NULL , ä¹Ÿå°±æ˜¯éœ€è¦ JDK ä¸­åŒ…å«æœ‰æ•ˆçš„ CLEANER æœºåˆ¶ã€‚</li></ol> <div class="language- extra-class"><pre class="language-text"><code> static {
        DIRECT_BUFFER_PREFERRED = CLEANER != NOOP
                                  &amp;&amp; !SystemPropertyUtil.getBoolean(&quot;io.netty.noPreferDirect&quot;, false);
        if (logger.isDebugEnabled()) {
            logger.debug(&quot;-Dio.netty.noPreferDirect: {}&quot;, !DIRECT_BUFFER_PREFERRED);
        }
 }
</code></pre></div><p>å¦‚æœæ˜¯å®‰å“å¹³å°ï¼Œé‚£ä¹ˆ CLEANER ç›´æ¥å°±æ˜¯ NOOPï¼Œä¸ä¼šåšä»»ä½•åˆ¤æ–­ï¼Œé»˜è®¤æƒ…å†µä¸‹ç›´æ¥èµ° Heap Memory , é™¤éç‰¹æ®ŠæŒ‡å®šè¦èµ° Direct Memoryã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>        if (!isAndroid()) {
            if (javaVersion() &gt;= 9) {
                // æ£€æŸ¥ sun.misc.Unsafe ç±»ä¸­æ˜¯å¦åŒ…å«æœ‰æ•ˆçš„ invokeCleaner æ–¹æ³•
                CLEANER = CleanerJava9.isSupported() ? new CleanerJava9() : NOOP;
            } else {
                // æ£€æŸ¥ java.nio.ByteBuffer ä¸­æ˜¯å¦åŒ…å«äº† cleaner å­—æ®µ
                CLEANER = CleanerJava6.isSupported() ? new CleanerJava6() : NOOP;
            }
        } else {
            CLEANER = NOOP;
        }
</code></pre></div><p>å¦‚æœæ˜¯ JDK 9 ä»¥ä¸Šçš„ç‰ˆæœ¬ï¼ŒNetty ä¼šæ£€æŸ¥æ˜¯å¦å¯ä»¥é€šè¿‡  <code>sun.misc.Unsafe</code> çš„ <code>invokeCleaner</code> æ–¹æ³•æ­£ç¡®æ‰§è¡Œ DirectBuffer çš„ Cleanerï¼Œå¦‚æœæ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œé‚£ä¹ˆ CLEANER å°±ä¸º NOOPï¼ŒNetty åœ¨é»˜è®¤æƒ…å†µä¸‹å°±ä¼šèµ° Heap Memoryã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public final class Unsafe {
    public void invokeCleaner(java.nio.ByteBuffer directBuffer) {
        if (!directBuffer.isDirect())
            throw new IllegalArgumentException(&quot;buffer is non-direct&quot;);

        theInternalUnsafe.invokeCleaner(directBuffer);
    }
}
</code></pre></div><p>å¦‚æœæ˜¯ JDK 9 ä»¥ä¸‹çš„ç‰ˆæœ¬ï¼ŒNetty å°±ä¼šé€šè¿‡åå°„çš„æ–¹å¼å…ˆå»è·å– DirectByteBuffer çš„ cleaner å­—æ®µï¼Œå¦‚æœ cleaner ä¸º null æˆ–è€…åœ¨æ‰§è¡Œ clean æ–¹æ³•çš„è¿‡ç¨‹ä¸­å‡ºç°äº†å¼‚å¸¸ï¼Œé‚£ä¹ˆ CLEANER å°±ä¸º NOOPï¼ŒNetty åœ¨é»˜è®¤æƒ…å†µä¸‹å°±ä¼šèµ° Heap Memoryã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>class DirectByteBuffer extends MappedByteBuffer implements DirectBuffer
{
    private final Cleaner cleaner;

    DirectByteBuffer(int cap) {                   // package-private

        ...... çœç•¥ .....   

        base = UNSAFE.allocateMemory(size);
        cleaner = Cleaner.create(this, new Deallocator(base, size, cap));
    }
}
</code></pre></div><p>å¦‚æœ <code>PlatformDependent.directBufferPreferred()</code> æ–¹æ³•è¿”å› true ,é‚£ä¹ˆ ByteBufAllocator æ¥ä¸‹æ¥åœ¨åˆ†é…å†…å­˜çš„æ—¶å€™ï¼Œé»˜è®¤æƒ…å†µä¸‹å°±ä¼šåˆ†é…  directBufferã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public final class UnpooledByteBufAllocator  extends AbstractByteBufAllocator {
    // ByteBuf åˆ†é…å™¨
    public static final UnpooledByteBufAllocator DEFAULT =
            new UnpooledByteBufAllocator(PlatformDependent.directBufferPreferred());
}

public abstract class AbstractByteBufAllocator implements ByteBufAllocator {
    // æ˜¯å¦é»˜è®¤åˆ†é… directBuffer
    private final boolean directByDefault;

    protected AbstractByteBufAllocator(boolean preferDirect) {
        directByDefault = preferDirect &amp;&amp; PlatformDependent.hasUnsafe();
    }

    @Override
    public ByteBuf buffer() {
        if (directByDefault) {
            return directBuffer();
        }
        return heapBuffer();
    }
}
</code></pre></div><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒJDK éƒ½ä¼šåŒ…å«æœ‰æ•ˆçš„ CLEANER æœºåˆ¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å®Œå…¨å¯ä»¥ä»…æ˜¯é€šè¿‡ <code>-Dio.netty.noPreferDirect</code> ï¼ˆé»˜è®¤ falseï¼‰æ¥æ§åˆ¶ Netty é»˜è®¤æƒ…å†µä¸‹èµ°  Direct Memoryã€‚</p> <p>ä½†å¦‚æœæ˜¯å®‰å“å¹³å°ï¼Œé‚£ä¹ˆæ— è®º  <code>-Dio.netty.noPreferDirect</code> å¦‚ä½•è®¾ç½®ï¼ŒNetty é»˜è®¤æƒ…å†µä¸‹éƒ½ä¼šèµ°  Heap Memory ã€‚</p> <h2 id="_4-cleaner-or-nocleaner"><a href="#_4-cleaner-or-nocleaner" class="header-anchor">#</a> <strong>4. Cleaner or NoCleaner</strong></h2> <p>ç«™åœ¨å†…å­˜å›æ”¶çš„è§’åº¦ï¼ŒNetty å°† ByteBuf åˆ†ä¸ºäº†å¸¦æœ‰ Cleaner çš„ DirectByteBuf å’Œæ²¡æœ‰ Cleaner çš„ DirectByteBuf ä¸¤ä¸ªå¤§ç±»ã€‚åœ¨ä¹‹å‰çš„æ–‡ç« <a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzU3Mjc3Ng==&amp;mid=2247489586&amp;idx=1&amp;sn=4306549c480f668458ab4df0d4b2ea47&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">ã€Šä»¥ ZGC ä¸ºä¾‹ï¼Œè°ˆä¸€è°ˆ JVM æ˜¯å¦‚ä½•å®ç° Reference è¯­ä¹‰çš„ã€‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ä¸­çš„ç¬¬ä¸‰å°èŠ‚ï¼Œç¬”è€…è¯¦ç»†çš„ä»‹ç»è¿‡ï¼ŒJVM  å¦‚ä½•åˆ©ç”¨ Cleaner æœºåˆ¶æ¥å›æ”¶ DirectByteBuffer èƒŒåçš„ Native Memory ã€‚</p> <p>è€Œ Cleaner å›æ”¶ DirectByteBuffer çš„ Native Memory éœ€è¦ä¾èµ– GC çš„å‘ç”Ÿï¼Œå½“ä¸€ä¸ª DirectByteBuffer æ²¡æœ‰ä»»ä½•å¼ºå¼•ç”¨æˆ–è€…è½¯å¼•ç”¨çš„æ—¶å€™ï¼Œå¦‚æœæ­¤æ—¶å‘ç”Ÿ GC , Cleaner æ‰ä¼šå»å›æ”¶ Native Memoryã€‚å¦‚æœå¾ˆä¹…éƒ½æ²¡å‘ç”Ÿ GC ,é‚£ä¹ˆè¿™äº› DirectByteBuffer æ‰€å¼•ç”¨çš„ Native Memory å°†ä¸€ç›´ä¸ä¼šé‡Šæ”¾ã€‚</p> <p>æ‰€ä»¥ä»…ä»…æ˜¯ä¾èµ– Cleaner æ¥é‡Šæ”¾ Native Memory æ˜¯æœ‰ä¸€å®šå»¶è¿Ÿçš„ï¼Œæç«¯æƒ…å†µä¸‹ï¼Œå¦‚æœä¸€ç›´ç­‰ä¸æ¥ GC ,å¾ˆæœ‰å¯èƒ½å°±ä¼šå‘ç”Ÿ OOM ã€‚</p> <p>è€Œ Netty çš„ ByteBuf è®¾è®¡ç›¸å½“äºæ˜¯å¯¹ NIO ByteBuffer çš„ä¸€ç§å®Œå–„æ‰©å±•ï¼Œå…¶åº•å±‚å…¶å®éƒ½ä¼šä¾èµ–ä¸€ä¸ª JDK çš„ ByteBufferã€‚æ¯”å¦‚ï¼Œå‰é¢ä»‹ç»çš„ UnpooledDirectByteBuf ï¼Œ UnpooledUnsafeDirectByteBuf å…¶åº•å±‚ä¾èµ–çš„å°±æ˜¯ JDK  DirectByteBuffer , è€Œè¿™ä¸ª DirectByteBuffer å°±æ˜¯å¸¦æœ‰ Cleaner çš„ ByteBuf ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class UnpooledDirectByteBuf extends AbstractReferenceCountedByteBuf {
    // åº•å±‚ä¾èµ–çš„ JDK DirectByteBuffer
    ByteBuffer buffer;

    public UnpooledDirectByteBuf(ByteBufAllocator alloc, int initialCapacity, int maxCapacity) {
        // åˆ›å»º DirectByteBuffer
        setByteBuffer(allocateDirect(initialCapacity), false);
    }

   protected ByteBuffer allocateDirect(int initialCapacity) {
        return ByteBuffer.allocateDirect(initialCapacity);
    }
public class UnpooledUnsafeDirectByteBuf extends UnpooledDirectByteBuf {
    // åº•å±‚ä¾èµ–çš„ JDK DirectByteBuffer çš„å†…å­˜åœ°å€
    long memoryAddress;


    public UnpooledUnsafeDirectByteBuf(ByteBufAllocator alloc, int initialCapacity, int maxCapacity) {
         // è°ƒç”¨çˆ¶ç±» UnpooledDirectByteBuf æ„å»ºå‡½æ•°åˆ›å»ºåº•å±‚ä¾èµ–çš„ JDK DirectByteBuffer 
        super(alloc, initialCapacity, maxCapacity);
    }

    @Override
    final void setByteBuffer(ByteBuffer buffer, boolean tryFree) {
        super.setByteBuffer(buffer, tryFree);
        // è·å– JDK DirectByteBuffer çš„å†…å­˜åœ°å€
        memoryAddress = PlatformDependent.directBufferAddress(buffer);
    }
</code></pre></div><p>åœ¨ JDK NIO  ä¸­ï¼Œå‡¡æ˜¯é€šè¿‡ <code>ByteBuffer.allocateDirect</code> æ–¹æ³•ç”³è¯·åˆ° DirectByteBuffer éƒ½æ˜¯å¸¦æœ‰ Cleaer çš„ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public abstract class ByteBuffer {
  public static ByteBuffer allocateDirect(int capacity) {
        return new DirectByteBuffer(capacity);
    }
}

class DirectByteBuffer extends MappedByteBuffer implements DirectBuffer
{
    private final Cleaner cleaner;

    DirectByteBuffer(int cap) {                   // package-private

        ...... çœç•¥ .....   
        // é€šè¿‡è¯¥æ„é€ å‡½æ•°ç”³è¯·åˆ°çš„ Direct Memory ä¼šå—åˆ° -XX:MaxDirectMemorySize å‚æ•°çš„é™åˆ¶
        Bits.reserveMemory(size, cap);   
        // åº•å±‚è°ƒç”¨ malloc ç”³è¯·å†…å­˜
        base = UNSAFE.allocateMemory(size);

        ...... çœç•¥ .....   
        // åˆ›å»º Cleaner
        cleaner = Cleaner.create(this, new Deallocator(base, size, cap));
    }
}
</code></pre></div><p><strong>è€Œå¸¦æœ‰ Cleaner çš„ DirectByteBuffer èƒŒåæ‰€èƒ½å¼•ç”¨çš„ Direct Memory æ˜¯å—åˆ° <code>-XX:MaxDirectMemorySize</code> JVM å‚æ•°é™åˆ¶çš„</strong>ã€‚ç”±äº UnpooledDirectByteBuf ä»¥åŠ UnpooledUnsafeDirectByteBuf éƒ½å¸¦æœ‰ Cleanerï¼Œæ‰€ä»¥å½“ä»–ä»¬åœ¨ç³»ç»Ÿä¸­æ²¡æœ‰ä»»ä½•å¼ºå¼•ç”¨æˆ–è€…è½¯å¼•ç”¨çš„æ—¶å€™ï¼Œå¦‚æœå‘ç”Ÿ GC , Cleaner å°±ä¼šé‡Šæ”¾ä»–ä»¬çš„ Direct Memory ã€‚</p> <p>ç”±äº Cleaner æ‰§è¡Œä¼šä¾èµ– GC , è€Œ GC çš„å‘ç”Ÿå¾€å¾€ä¸é‚£ä¹ˆåŠæ—¶ï¼Œä¼šæœ‰ä¸€å®šçš„å»¶æ—¶ï¼Œæ‰€ä»¥ Netty ä¸ºäº†å¯ä»¥åŠæ—¶çš„é‡Šæ”¾  Direct Memory ï¼Œå¾€å¾€é€‰æ‹©ä¸ä¾èµ– JDK çš„ Cleaner æœºåˆ¶ï¼Œæ‰‹åŠ¨è¿›è¡Œé‡Šæ”¾ã€‚æ‰€ä»¥å°±æœ‰äº† NoCleaner ç±»å‹çš„ DirectByteBuf â€”â€” UnpooledUnsafeNoCleanerDirectByteBuf ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>class UnpooledUnsafeNoCleanerDirectByteBuf extends UnpooledUnsafeDirectByteBuf {

    @Override
    protected ByteBuffer allocateDirect(int initialCapacity) {
        // åˆ›å»ºæ²¡æœ‰ Cleaner çš„ JDK DirectByteBuffer 
        return PlatformDependent.allocateDirectNoCleaner(initialCapacity);
    }

    @Override
    protected void freeDirect(ByteBuffer buffer) {
        // æ—¢ç„¶æ²¡æœ‰äº† Cleaner ï¼Œ æ‰€ä»¥ Netty è¦æ‰‹åŠ¨è¿›è¡Œé‡Šæ”¾
        PlatformDependent.freeDirectNoCleaner(buffer);
    }
}
</code></pre></div><p>UnpooledUnsafeNoCleanerDirectByteBuf çš„åº•å±‚åŒæ ·ä¹Ÿä¼šä¾èµ–ä¸€ä¸ª JDK  DirectByteBuffer , ä½†å’Œä¹‹å‰ä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œçš„ DirectByteBuffer æ˜¯ä¸å¸¦æœ‰ cleaner çš„ã€‚</p> <p>æˆ‘ä»¬é€šè¿‡ JNI æ¥è°ƒç”¨ <code>DirectByteBuffer(long addr, int cap)</code> æ„é€ å‡½æ•°åˆ›å»ºå‡ºæ¥çš„ JDK  DirectByteBuffer éƒ½æ˜¯æ²¡æœ‰ cleaner çš„ã€‚<strong>ä½†é€šè¿‡è¿™ç§æ–¹å¼åˆ›å»ºå‡ºæ¥çš„ DirectByteBuffer èƒŒåå¼•ç”¨çš„ Native Memory æ˜¯ä¸ä¼šå—åˆ° <code>-XX:MaxDirectMemorySize</code> JVM å‚æ•°é™åˆ¶çš„</strong>ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>class DirectByteBuffer {
    // Invoked only by JNI: NewDirectByteBuffer(void*, long)
    private DirectByteBuffer(long addr, int cap) {
        super(-1, 0, cap, cap, null);
        address = addr;
        // cleaner ä¸º null
        cleaner = null;
    }
}
</code></pre></div><p>æ—¢ç„¶æ²¡æœ‰äº† cleaner ï¼Œ æ‰€ä»¥ Netty å°±æ— æ³•ä¾èµ– GC æ¥é‡Šæ”¾ Direct Memory äº†ï¼Œè¿™å°±è¦æ±‚ Netty å¿…é¡»æ‰‹åŠ¨è°ƒç”¨ <code>freeDirect</code>æ–¹æ³•åŠæ—¶åœ°é‡Šæ”¾ Direct Memoryã€‚</p> <blockquote><p>äº‹å®ä¸Šï¼Œæ— è®º Netty ä¸­çš„ DirectByteBuf æœ‰æ²¡æœ‰ Cleanerï¼Œ Netty éƒ½ä¼šé€‰æ‹©æ‰‹åŠ¨çš„è¿›è¡Œé‡Šæ”¾ï¼Œç›®çš„å°±æ˜¯ä¸ºäº†é¿å… GC çš„å»¶è¿Ÿ ï¼Œ ä»è€ŒåŠæ—¶çš„é‡Šæ”¾ Direct Memoryã€‚</p></blockquote> <p>é‚£ä¹ˆ Netty ä¸­çš„ DirectByteBuf åœ¨ä»€ä¹ˆæƒ…å†µä¸‹å¸¦æœ‰ Cleanerï¼Œåˆåœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¸å¸¦ Cleaner å‘¢ ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>PlatformDependent.useDirectBufferNoCleaner</code> æ–¹æ³•çš„è¿”å›å€¼è¿›è¡Œåˆ¤æ–­ï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>public final class PlatformDependent {
    // Netty çš„ DirectByteBuf æ˜¯å¦å¸¦æœ‰ Cleaner
    private static final boolean USE_DIRECT_BUFFER_NO_CLEANER;
    public static boolean useDirectBufferNoCleaner() {
        return USE_DIRECT_BUFFER_NO_CLEANER;
    }
}
</code></pre></div><ul><li>USE_DIRECT_BUFFER_NO_CLEANER = TRUE è¡¨ç¤º Netty åˆ›å»ºå‡ºæ¥çš„ DirectByteBuf ä¸å¸¦æœ‰ Cleaner ã€‚  Direct Memory çš„ç”¨é‡ä¸ä¼šå—åˆ° JVM å‚æ•° -<code>XX:MaxDirectMemorySize</code> çš„é™åˆ¶ã€‚</li> <li>USE_DIRECT_BUFFER_NO_CLEANER = FALSE è¡¨ç¤º Netty åˆ›å»ºå‡ºæ¥çš„ DirectByteBuf å¸¦æœ‰ Cleaner ã€‚  Direct Memory çš„ç”¨é‡ä¼šå—åˆ° JVM å‚æ•° -<code>XX:MaxDirectMemorySize</code> çš„é™åˆ¶ã€‚</li></ul> <p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>-Dio.netty.maxDirectMemory</code> æ¥è®¾ç½® USE_DIRECT_BUFFER_NO_CLEANER çš„å€¼ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè¯¥å‚æ•°è¿˜å¯ä»¥æŒ‡å®šåœ¨ Netty å±‚é¢ä¸Šå¯ä»¥ä½¿ç”¨çš„æœ€å¤§ DirectMemory ç”¨é‡ã€‚</p> <p><code>io.netty.maxDirectMemory = 0</code> é‚£ä¹ˆ USE_DIRECT_BUFFER_NO_CLEANER å°±ä¸º FALSE , è¡¨ç¤ºåœ¨ Netty å±‚é¢åˆ›å»ºå‡ºæ¥çš„ DirectByteBuf éƒ½æ˜¯å¸¦æœ‰ Cleaner çš„ï¼Œ<strong>è¿™ç§æƒ…å†µä¸‹ Netty å¹¶ä¸ä¼šé™åˆ¶ maxDirectMemory çš„ç”¨é‡ï¼Œå› ä¸ºé™åˆ¶äº†ä¹Ÿæ²¡ç”¨ï¼Œå…·ä½“èƒ½ç”¨å¤šå°‘ maxDirectMemoryï¼Œè¿˜æ˜¯ç”± JVM å‚æ•° <code>-XX:MaxDirectMemorySize</code> å†³å®šçš„</strong>ã€‚</p> <p><code>io.netty.maxDirectMemory &lt; 0</code> ï¼Œé»˜è®¤ä¸º -1ï¼Œä¹Ÿå°±æ˜¯åœ¨é»˜è®¤æƒ…å†µä¸‹ USE_DIRECT_BUFFER_NO_CLEANER ä¸º TRUE , åˆ›å»ºå‡ºæ¥çš„ DirectByteBuf éƒ½æ˜¯ä¸å¸¦ Cleaner çš„ã€‚ç”±äºåœ¨è¿™ç§æƒ…å†µä¸‹ maxDirectMemory çš„ç”¨é‡å¹¶ä¸ä¼šå—åˆ° JVM å‚æ•° <code>-XX:MaxDirectMemorySize</code> çš„é™åˆ¶ï¼Œæ‰€ä»¥åœ¨ Netty å±‚é¢ä¸Šå¿…é¡»é™åˆ¶ maxDirectMemory çš„ç”¨é‡ï¼Œé»˜è®¤å€¼å°±æ˜¯  <code>-XX:MaxDirectMemorySize</code> æŒ‡å®šçš„å€¼ã€‚</p> <p><strong>è¿™é‡Œéœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯</strong>ï¼ŒNetty å±‚é¢å¯¹äº maxDirectMemory çš„å®¹é‡é™åˆ¶å’Œ JVM å±‚é¢å¯¹äº maxDirectMemory çš„å®¹é‡é™åˆ¶æ˜¯å•ç‹¬åˆ†åˆ«è®¡ç®—çš„ï¼Œäº’ä¸å½±å“ã€‚å› æ­¤ç«™åœ¨ JVM è¿›ç¨‹çš„è§’åº¦æ¥è¯´ï¼Œæ€»ä½“ maxDirectMemory çš„ç”¨é‡æ˜¯ <code>-XX:MaxDirectMemorySize</code> çš„ä¸¤å€ã€‚</p> <p><code>io.netty.maxDirectMemory &gt; 0</code> çš„æƒ…å†µå’Œå°äº 0 çš„æƒ…å†µä¸€æ ·ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯ Netty å±‚é¢çš„ maxDirectMemory ç”¨é‡æ˜¯ä¸“é—¨ç”±  <code>-Dio.netty.maxDirectMemory</code> å‚æ•°æŒ‡å®šï¼Œä»ç„¶ç‹¬ç«‹äº JVM å±‚é¢çš„ maxDirectMemory é™åˆ¶ä¹‹å¤–å•ç‹¬è®¡ç®—ã€‚</p> <p><strong>æ‰€ä»¥ä»è¿™ä¸ªå±‚é¢æ¥è¯´ï¼ŒNetty è®¾è®¡ NoCleaner ç±»å‹çš„ DirectByteBuf çš„å¦å¤–ä¸€ä¸ªç›®çš„å°±æ˜¯ä¸ºäº†çªç ´ JVM å¯¹äº maxDirectMemory ç”¨é‡çš„é™åˆ¶</strong>ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public final class PlatformDependent {
    // Netty å±‚é¢  Direct Memory çš„ç”¨é‡ç»Ÿè®¡
    // ä¸º NULL è¡¨ç¤ºåœ¨ Netty å±‚é¢ä¸è¿›è¡Œç‰¹æ®Šé™åˆ¶ï¼Œå®Œå…¨ç”± JVM è¿›è¡Œé™åˆ¶ Direct Memory çš„ç”¨é‡
    private static final AtomicLong DIRECT_MEMORY_COUNTER;
    // Netty å±‚é¢ Direct Memory çš„æœ€å¤§ç”¨é‡
    private static final long DIRECT_MEMORY_LIMIT;
    // JVM æŒ‡å®šçš„ -XX:MaxDirectMemorySize æœ€å¤§å †å¤–å†…å­˜
    private static final long MAX_DIRECT_MEMORY = maxDirectMemory0();

    static {
        long maxDirectMemory = SystemPropertyUtil.getLong(&quot;io.netty.maxDirectMemory&quot;, -1);

        if (maxDirectMemory == 0 || !hasUnsafe() || !PlatformDependent0.hasDirectBufferNoCleanerConstructor()) {
            // maxDirectMemory = 0 è¡¨ç¤ºåç»­åˆ›å»ºçš„ DirectBuffer æ˜¯å¸¦æœ‰ Cleaner çš„ï¼ŒNetty è‡ªå·±ä¸ä¼šå¼ºåˆ¶é™å®š maxDirectMemory çš„ç”¨é‡ï¼Œå®Œå…¨äº¤ç»™ JDK çš„ maxDirectMemory æ¥é™åˆ¶
            // å› ä¸º Netty é™åˆ¶äº†ä¹Ÿæ²¡ç”¨ï¼Œå…¶åº•å±‚ä¾ç„¶ä¾èµ–çš„æ˜¯ JDK  DirectBufferï¼ˆCleanerï¼‰ï¼ŒJDK ä¼šé™åˆ¶ maxDirectMemory çš„ç”¨é‡
            // åœ¨æ²¡æœ‰ Unsafe çš„æƒ…å†µä¸‹ï¼Œé‚£ä¹ˆå°±å¿…é¡»ä½¿ç”¨ Cleanerï¼Œå› ä¸ºå¦‚æœä¸ä½¿ç”¨ Cleaner çš„è¯ï¼Œåˆæ²¡æœ‰ Unsafeï¼Œæˆ‘ä»¬å°±æ— æ³•é‡Šæ”¾ Native Memory äº†
            // å¦‚æœ JDK æœ¬èº«ä¸åŒ…å«åˆ›å»º NoCleaner DirectBuffer çš„æ„é€ å‡½æ•° â€”â€” DirectByteBuffer(long, int)ï¼Œé‚£ä¹ˆè‡ªç„¶åªèƒ½ä½¿ç”¨ Cleaner
            USE_DIRECT_BUFFER_NO_CLEANER = false;
            // Netty è‡ªèº«ä¸ä¼šç»Ÿè®¡ Direct Memory çš„ç”¨é‡ï¼Œå®Œå…¨äº¤ç»™ JDK æ¥ç»Ÿè®¡
            DIRECT_MEMORY_COUNTER = null;
        } else {
            USE_DIRECT_BUFFER_NO_CLEANER = true;
            if (maxDirectMemory &lt; 0) {
                // maxDirectMemory &lt; 0 (é»˜è®¤ -1) åç»­åˆ›å»º NoCleaner DirectBuffer
                // Netty å±‚é¢ä¼šå•ç‹¬é™åˆ¶ maxDirectMemory ç”¨é‡ï¼ŒmaxDirectMemory çš„å€¼ä¸ -XX:MaxDirectMemorySize çš„å€¼ç›¸åŒ
                // å› ä¸º JDK ä¸ä¼šç»Ÿè®¡å’Œé™åˆ¶ NoCleaner DirectBuffer çš„ç”¨é‡
                // æ³¨æ„ï¼Œè¿™é‡Œ Netty çš„ maxDirectMemory å’Œ JDK çš„ maxDirectMemory æ˜¯åˆ†åˆ«å•ç‹¬ç»Ÿè®¡çš„
                // åœ¨ JVM è¿›ç¨‹çš„è§’åº¦æ¥è¯´ï¼Œæ•´ä½“ maxDirectMemory çš„ç”¨é‡æ˜¯ -XX:MaxDirectMemorySize çš„ä¸¤å€ï¼ˆNettyç”¨çš„å’Œ JDK ç”¨çš„ä¹‹å’Œï¼‰
                maxDirectMemory = MAX_DIRECT_MEMORY;
                if (maxDirectMemory &lt;= 0) {
                    DIRECT_MEMORY_COUNTER = null;
                } else {
                    // ç»Ÿè®¡ Netty DirectMemory çš„ç”¨é‡
                    DIRECT_MEMORY_COUNTER = new AtomicLong();
                }
            } else {
                // maxDirectMemory &gt; 0 åç»­åˆ›å»º NoCleaner DirectBuffer,Netty å±‚é¢çš„ maxDirectMemory å°±æ˜¯ io.netty.maxDirectMemory æŒ‡å®šçš„å€¼
                DIRECT_MEMORY_COUNTER = new AtomicLong();
            }
        }
        logger.debug(&quot;-Dio.netty.maxDirectMemory: {} bytes&quot;, maxDirectMemory);
        DIRECT_MEMORY_LIMIT = maxDirectMemory &gt;= 1 ? maxDirectMemory : MAX_DIRECT_MEMORY;
    }  
}
</code></pre></div><p>å½“ Netty å±‚é¢çš„ direct memory ç”¨é‡è¶…è¿‡äº† <code>-Dio.netty.maxDirectMemory</code> å‚æ•°æŒ‡å®šçš„å€¼æ—¶ï¼Œé‚£ä¹ˆå°±ä¼šæŠ›å‡º <code>OutOfDirectMemoryError</code> ï¼Œåˆ†é… DirectByteBuf å°†ä¼šå¤±è´¥ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private static void incrementMemoryCounter(int capacity) {
        if (DIRECT_MEMORY_COUNTER != null) {
            long newUsedMemory = DIRECT_MEMORY_COUNTER.addAndGet(capacity);
            if (newUsedMemory &gt; DIRECT_MEMORY_LIMIT) {
                DIRECT_MEMORY_COUNTER.addAndGet(-capacity);
                throw new OutOfDirectMemoryError(&quot;failed to allocate &quot; + capacity
                        + &quot; byte(s) of direct memory (used: &quot; + (newUsedMemory - capacity)
                        + &quot;, max: &quot; + DIRECT_MEMORY_LIMIT + ')');
            }
        }
    }
</code></pre></div><h2 id="_5-unsafe-or-nounsafe"><a href="#_5-unsafe-or-nounsafe" class="header-anchor">#</a> <strong>5. Unsafe or NoUnsafe</strong></h2> <p>ç«™åœ¨å†…å­˜è®¿é—®æ–¹å¼çš„è§’åº¦ä¸Šæ¥è¯´ ï¼Œ Netty åˆä¼šå°† ByteBuf åˆ†ä¸ºäº† Unsafe å’Œ NoUnsafe ä¸¤ä¸ªå¤§ç±»ï¼Œå…¶ä¸­ NoUnsafe çš„å†…å­˜è®¿é—®æ–¹å¼æ˜¯ä¾èµ–åº•å±‚çš„ JDK ByteBufferï¼Œå¯¹äº Netty ByteBuf çš„ä»»ä½•æ“ä½œæœ€ç»ˆéƒ½æ˜¯ä¼šä»£ç†ç»™åº•å±‚ JDK çš„ ByteBufferã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class UnpooledDirectByteBuf extends AbstractReferenceCountedByteBuf {
    // åº•å±‚ä¾èµ–çš„ JDK DirectByteBuffer
    ByteBuffer buffer;

   @Override
    protected byte _getByte(int index) {
        return buffer.get(index);
    }

    @Override
    protected void _setByte(int index, int value) {
        buffer.put(index, (byte) value);
    }
}
</code></pre></div><p>è€Œ Unsafe çš„å†…å­˜è®¿é—®æ–¹å¼åˆ™æ˜¯é€šè¿‡ <code>sun.misc.Unsafe</code> ç±»ä¸­æä¾›çš„ä¼—å¤š low-level direct buffer access API æ¥å¯¹å†…å­˜åœ°å€ç›´æ¥è¿›è¡Œè®¿é—®ï¼Œç”±äºæ˜¯è„±ç¦» JVM ç›¸å…³è§„èŒƒç›´æ¥å¯¹å†…å­˜åœ°å€è¿›è¡Œè®¿é—®ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è°ƒç”¨ Unsafe ç›¸å…³æ–¹æ³•çš„æ—¶å€™éœ€è¦è€ƒè™‘ JVM ä»¥åŠ OS çš„å„ç§ç»†èŠ‚ï¼Œä¸€ä¸å°å¿ƒå°±ä¼šè¸©å‘å‡ºé”™ï¼Œæ‰€ä»¥å®ƒæ˜¯ä¸€ç§ä¸å®‰å…¨çš„è®¿é—®æ–¹å¼ï¼Œä½†æ˜¯è¶³å¤Ÿçµæ´»ï¼Œé«˜æ•ˆã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public class UnpooledUnsafeDirectByteBuf extends UnpooledDirectByteBuf {
    // åº•å±‚ä¾èµ–çš„ JDK DirectByteBuffer çš„å†…å­˜åœ°å€
    long memoryAddress;

    @Override
    protected byte _getByte(int index) {
        return UnsafeByteBufUtil.getByte(addr(index));
    }

   final long addr(int index) {
        // ç›´æ¥é€šè¿‡å†…å­˜åœ°å€è¿›è¡Œè®¿é—®
        return memoryAddress + index;
    }

    @Override
    protected void _setByte(int index, int value) {
        UnsafeByteBufUtil.setByte(addr(index), value);
    }

}
</code></pre></div><p>Netty æä¾›äº† <code>-Dio.netty.noUnsafe</code> å‚æ•°æ¥è®©æˆ‘ä»¬å†³å®šæ˜¯å¦é‡‡ç”¨ Unsafe çš„å†…å­˜è®¿é—®æ–¹å¼ï¼Œé»˜è®¤å€¼æ˜¯ false , è¡¨ç¤º Netty é»˜è®¤å¼€å¯ Unsafe è®¿é—®æ–¹å¼ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>final class PlatformDependent0 {
    // æ˜¯å¦æ˜ç¡®ç¦ç”¨ Unsafeï¼Œnull è¡¨ç¤ºå¼€å¯  Unsafe
    private static final Throwable EXPLICIT_NO_UNSAFE_CAUSE = explicitNoUnsafeCause0();

    private static Throwable explicitNoUnsafeCause0() {
        final boolean noUnsafe = SystemPropertyUtil.getBoolean(&quot;io.netty.noUnsafe&quot;, false);
        logger.debug(&quot;-Dio.netty.noUnsafe: {}&quot;, noUnsafe);

        if (noUnsafe) {
            logger.debug(&quot;sun.misc.Unsafe: unavailable (io.netty.noUnsafe)&quot;);
            return new UnsupportedOperationException(&quot;sun.misc.Unsafe: unavailable (io.netty.noUnsafe)&quot;);
        }

        return null;
    }
}
</code></pre></div><p>åœ¨ç¡®è®¤å¼€å¯äº† Unsafe æ–¹å¼ä¹‹åï¼Œæˆ‘ä»¬å°±éœ€è¦è¿‘ä¸€æ­¥ç¡®è®¤åœ¨å½“å‰ JRE çš„ classpath ä¸‹æ˜¯å¦å­˜åœ¨ <code>sun.misc.Unsafe</code> ç±»ï¼Œæ˜¯å¦èƒ½é€šè¿‡åå°„çš„æ–¹å¼è·å–åˆ° Unsafe å®ä¾‹ â€”â€” theUnsafe ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public final class Unsafe {
    // Unsafe å®ä¾‹
    private static final Unsafe theUnsafe = new Unsafe();
}
final class PlatformDependent0 {
    // éªŒè¯ Unsafe æ˜¯å¦å¯ç”¨ï¼Œnull è¡¨ç¤º Unsafe æ˜¯å¯ç”¨çŠ¶æ€
    private static final Throwable UNSAFE_UNAVAILABILITY_CAUSE;
    static {
           // å°è¯•é€šè¿‡åå°„çš„æ–¹å¼æ‹¿åˆ° theUnsafe å®ä¾‹
           final Object maybeUnsafe = AccessController.doPrivileged(new PrivilegedAction&lt;Object&gt;() {
                @Override
                public Object run() {
                    try {
                        final Field unsafeField = Unsafe.class.getDeclaredField(&quot;theUnsafe&quot;);
                        Throwable cause = ReflectionUtil.trySetAccessible(unsafeField, false);
                        if (cause != null) {
                            return cause;
                        }
                        // the unsafe instance
                        return unsafeField.get(null);
                    } catch (NoSuchFieldException e) {
                        return e;
                    } catch (SecurityException e) {
                        return e;
                    } catch (IllegalAccessException e) {
                        return e;
                    } catch (NoClassDefFoundError e) {
                        // Also catch NoClassDefFoundError in case someone uses for example OSGI and it made
                        // Unsafe unloadable.
                        return e;
                    }
                }
            });
    }
}
</code></pre></div><p>åœ¨è·å–åˆ° Unsafe å®ä¾‹ä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ£€æŸ¥ Unsafe ä¸­æ˜¯å¦åŒ…å«æ‰€æœ‰ Netty ç”¨åˆ°çš„ low-level direct buffer access API ï¼Œç¡®ä¿è¿™äº› API å¯ä»¥æ­£å¸¸æœ‰æ•ˆçš„è¿è¡Œã€‚æ¯”å¦‚ï¼Œæ˜¯å¦åŒ…å« <code>copyMemory</code> æ–¹æ³•ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public final class Unsafe {
    @ForceInline
    public void copyMemory(Object srcBase, long srcOffset,
                           Object destBase, long destOffset,
                           long bytes) {
        theInternalUnsafe.copyMemory(srcBase, srcOffset, destBase, destOffset, bytes);
    }
}
</code></pre></div><p>æ˜¯å¦å¯ä»¥é€šè¿‡ Unsafe è®¿é—®åˆ° NIO Buffer çš„ address å­—æ®µï¼Œå› ä¸ºåç»­æˆ‘ä»¬éœ€è¦ç›´æ¥æ“ä½œå†…å­˜åœ°å€ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public abstract class Buffer {
    // å†…å­˜åœ°å€
    long address;
}
</code></pre></div><p>åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­å¦‚æœå‘ç”Ÿä»»ä½•å¼‚å¸¸ï¼Œåˆ™è¡¨ç¤ºåœ¨å½“å‰ classpath ä¸‹ï¼Œä¸å­˜åœ¨ <code>sun.misc.Unsafe</code> ç±»æˆ–è€…æ˜¯ç”±äºä¸åŒç‰ˆæœ¬ JDK çš„è®¾è®¡ï¼ŒUnsafe ä¸­æ²¡æœ‰ Netty æ‰€éœ€è¦çš„ä¸€äº›å¿…è¦çš„è®¿å­˜ API ã€‚è¿™æ ·ä¸€æ¥æˆ‘ä»¬å°±æ— æ³•ä½¿ç”¨ Unsafeï¼Œå†…å­˜çš„è®¿é—®æ–¹å¼å°±éœ€è¦å›é€€åˆ° NoUnsafeã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>            if (maybeUnsafe instanceof Throwable) {
                unsafe = null;
                unsafeUnavailabilityCause = (Throwable) maybeUnsafe;
                logger.debug(&quot;sun.misc.Unsafe.theUnsafe: unavailable&quot;, (Throwable) maybeUnsafe);
            } else {
                unsafe = (Unsafe) maybeUnsafe;
                logger.debug(&quot;sun.misc.Unsafe.theUnsafe: available&quot;);
            }
            // ä¸º null è¡¨ç¤º Unsafe å¯ç”¨
            UNSAFE_UNAVAILABILITY_CAUSE = unsafeUnavailabilityCause;
            UNSAFE = unsafe;
</code></pre></div><p>å¦‚æœåœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­æ²¡æœ‰å‘ç”Ÿä»»ä½•å¼‚å¸¸ï¼Œæˆ‘ä»¬è·å–åˆ°äº†ä¸€ä¸ªæœ‰æ•ˆçš„ UNSAFE å®ä¾‹ï¼Œé‚£ä¹ˆåç»­å°†æ­£å¼å¼€å¯ Unsafe çš„å†…å­˜è®¿é—®æ–¹å¼ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>final class PlatformDependent0 {
    static boolean hasUnsafe() {
        return UNSAFE != null;
    }
}
</code></pre></div><p>å®Œæ•´çš„ <code>hasUnsafe()</code> åˆ¤æ–­é€»è¾‘å¦‚ä¸‹ï¼š</p> <ol><li>å¦‚æœå½“å‰å¹³å°æ˜¯å®‰å“æˆ–è€… .NET ï¼Œåˆ™ä¸èƒ½å¼€å¯ Unsafeï¼Œå› ä¸ºè¿™äº›å¹³å°å¹¶ä¸åŒ…å« <code>sun.misc.Unsafe</code> ç±»ã€‚</li> <li><code>-Dio.netty.noUnsafe</code> å‚æ•°éœ€è¦è®¾ç½®ä¸º false ï¼ˆé»˜è®¤å¼€å¯ï¼‰ã€‚</li></ol> <p>3.. å½“å‰ classpath ä¸‹æ˜¯å¦åŒ…å«æœ‰æ•ˆçš„ <code>sun.misc.Unsafe</code> ç±»ã€‚</p> <ol><li>Unsafe å®ä¾‹éœ€è¦åŒ…å«å¿…è¦çš„è®¿å­˜ API ã€‚</li></ol> <div class="language- extra-class"><pre class="language-text"><code>public final class PlatformDependent {
    private static final Throwable UNSAFE_UNAVAILABILITY_CAUSE = unsafeUnavailabilityCause0();

    public static boolean hasUnsafe() {
        return UNSAFE_UNAVAILABILITY_CAUSE == null;
    }
    private static Throwable unsafeUnavailabilityCause0() {
        if (isAndroid()) {
            logger.debug(&quot;sun.misc.Unsafe: unavailable (Android)&quot;);
            return new UnsupportedOperationException(&quot;sun.misc.Unsafe: unavailable (Android)&quot;);
        }

        if (isIkvmDotNet()) {
            logger.debug(&quot;sun.misc.Unsafe: unavailable (IKVM.NET)&quot;);
            return new UnsupportedOperationException(&quot;sun.misc.Unsafe: unavailable (IKVM.NET)&quot;);
        }

        Throwable cause = PlatformDependent0.getUnsafeUnavailabilityCause();
        if (cause != null) {
            return cause;
        }

        try {
            boolean hasUnsafe = PlatformDependent0.hasUnsafe();
            logger.debug(&quot;sun.misc.Unsafe: {}&quot;, hasUnsafe ? &quot;available&quot; : &quot;unavailable&quot;);
            return hasUnsafe ? null : PlatformDependent0.getUnsafeUnavailabilityCause();
        } catch (Throwable t) {
            logger.trace(&quot;Could not determine if Unsafe is available&quot;, t);
            // Probably failed to initialize PlatformDependent0.
            return new UnsupportedOperationException(&quot;Could not determine if Unsafe is available&quot;, t);
        }
    }
}
</code></pre></div><p>å¦‚æœ <code>PlatformDependent.hasUnsafe()</code> æ–¹æ³•è¿”å› true , é‚£ä¹ˆåç»­ Netty éƒ½ä¼šåˆ›å»º Unsafe ç±»å‹çš„ ByteBufã€‚</p> <h2 id="_6-pooled-or-unpooled"><a href="#_6-pooled-or-unpooled" class="header-anchor">#</a> <strong>6. Pooled or Unpooled</strong></h2> <p>ç«™åœ¨å†…å­˜ç®¡ç†çš„è§’åº¦ä¸Šæ¥è®²ï¼ŒNetty å°† ByteBuf åˆ†ä¸ºäº† æ± åŒ–ï¼ˆPooledï¼‰ å’Œ éæ± åŒ–ï¼ˆUnpooledï¼‰ä¸¤ä¸ªå¤§ç±»ï¼Œå…¶ä¸­ Unpooled ç±»å‹çš„ ByteBuf  æ˜¯ç”¨åˆ°çš„æ—¶å€™æ‰å»ä¸´æ—¶åˆ›å»ºï¼Œä½¿ç”¨å®Œçš„æ—¶å€™å†å»é‡Šæ”¾ã€‚</p> <p>è€Œ Direct Memory çš„ç”³è¯·å’Œé‡Šæ”¾å¼€é”€ç›¸è¾ƒäº Heap Memory ä¼šå¤§å¾ˆå¤šï¼ŒNetty åœ¨é¢å¯¹é«˜å¹¶å‘ç½‘ç»œé€šä¿¡çš„åœºæ™¯ä¸‹ï¼ŒDirect Memory çš„ç”³è¯·å’Œé‡Šæ”¾æ˜¯ä¸€ä¸ªéå¸¸é¢‘ç¹çš„æ“ä½œï¼Œè¿™ç§å¤§é‡é¢‘ç¹åœ°å†…å­˜ç”³è¯·é‡Šæ”¾æ“ä½œå¯¹ç¨‹åºçš„æ€§èƒ½å½±å“æ˜¯å·¨å¤§çš„ï¼Œå› æ­¤ Netty å¼•å…¥äº†å†…å­˜æ± å°†è¿™äº› Direct Memory ç»Ÿä¸€æ± åŒ–ç®¡ç†èµ·æ¥ã€‚</p> <p>Netty æä¾›äº† <code>-Dio.netty.allocator.type</code> å‚æ•°æ¥è®©æˆ‘ä»¬å†³å®šæ˜¯å¦é‡‡ç”¨å†…å­˜æ± æ¥ç®¡ç† ByteBuf ï¼Œ é»˜è®¤å€¼æ˜¯ <code>pooled</code> , ä¹Ÿå°±æ˜¯è¯´ Netty é»˜è®¤æ˜¯é‡‡ç”¨æ± åŒ–çš„æ–¹å¼æ¥ç®¡ç† PooledByteBuf ã€‚å¦‚æœæ˜¯å®‰å“å¹³å°ï¼Œé‚£ä¹ˆé»˜è®¤æ˜¯ä½¿ç”¨éæ± åŒ–çš„ ByteBuf ï¼ˆunpooledï¼‰ã€‚</p> <ul><li>å½“å‚æ•° <code>io.netty.allocator.type</code> çš„å€¼ä¸º pooled æ—¶ï¼ŒNetty çš„é»˜è®¤ ByteBufAllocator æ˜¯ <code>PooledByteBufAllocator.DEFAULT</code> ã€‚</li> <li>å½“å‚æ•° <code>io.netty.allocator.type</code> çš„å€¼ä¸º unpooled æ—¶ï¼ŒNetty çš„é»˜è®¤ ByteBufAllocator æ˜¯ <code>UnpooledByteBufAllocator.DEFAULT</code> ã€‚</li></ul> <div class="language- extra-class"><pre class="language-text"><code>public final class ByteBufUtil {
    // é»˜è®¤ PooledByteBufAllocatorï¼Œæ± åŒ–ç®¡ç† ByteBuf
    static final ByteBufAllocator DEFAULT_ALLOCATOR;

    static {
        // é»˜è®¤ä¸º pooled
        String allocType = SystemPropertyUtil.get(
                &quot;io.netty.allocator.type&quot;, PlatformDependent.isAndroid() ? &quot;unpooled&quot; : &quot;pooled&quot;);
        allocType = allocType.toLowerCase(Locale.US).trim();

        ByteBufAllocator alloc;
        if (&quot;unpooled&quot;.equals(allocType)) {
            alloc = UnpooledByteBufAllocator.DEFAULT;
            logger.debug(&quot;-Dio.netty.allocator.type: {}&quot;, allocType);
        } else if (&quot;pooled&quot;.equals(allocType)) {
            alloc = PooledByteBufAllocator.DEFAULT;
            logger.debug(&quot;-Dio.netty.allocator.type: {}&quot;, allocType);
        } else {
            alloc = PooledByteBufAllocator.DEFAULT;
            logger.debug(&quot;-Dio.netty.allocator.type: pooled (unknown: {})&quot;, allocType);
        }

        DEFAULT_ALLOCATOR = alloc;
    }
}
</code></pre></div><p>åç»­ Netty åœ¨åˆ›å»º SocketChannel çš„æ—¶å€™ï¼Œåœ¨ SocketChannelConfig ä¸­æŒ‡å®šçš„ ByteBufAllocator å°±æ˜¯è¿™é‡Œçš„ <code>ByteBufUtil.DEFAULT_ALLOCATOR</code>ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸º PooledByteBufAllocatorã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public interface ByteBufAllocator {
    ByteBufAllocator DEFAULT = ByteBufUtil.DEFAULT_ALLOCATOR;
}

public class DefaultChannelConfig implements ChannelConfig {
    // PooledByteBufAllocator
    private volatile ByteBufAllocator allocator = ByteBufAllocator.DEFAULT;
}
</code></pre></div><p>å½“ Netty è¯»å– Socket ä¸­çš„ç½‘ç»œæ•°æ®æ—¶ï¼Œé¦–å…ˆä¼šä» DefaultChannelConfig ä¸­å°† ByteBufAllocator è·å–åˆ°ï¼Œç„¶ååˆ©ç”¨ ByteBufAllocator ä»å†…å­˜æ± ä¸­è·å–ä¸€ä¸ª DirectByteBuf ï¼Œæœ€åå°† Socket ä¸­çš„æ•°æ®è¯»å–åˆ° DirectByteBuf ä¸­ï¼Œéšåæ²¿ç€ pipeline å‘åä¼ æ’­ï¼Œè¿›è¡Œ IO å¤„ç†ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>protected class NioByteUnsafe extends AbstractNioUnsafe {
        @Override
        public final void read() {
            // è·å– SocketChannelConfig
            final ChannelConfig config = config();
            // è·å– ByteBufAllocator ï¼Œ é»˜è®¤ä¸º PooledByteBufAllocator
            final ByteBufAllocator allocator = config.getAllocator();
            // ä»å†…å­˜æ± ä¸­è·å– byteBuf
            byteBuf = allocHandle.allocate(allocator);
            // è¯»å– socket ä¸­çš„æ•°æ®åˆ° byteBuf
            allocHandle.lastBytesRead(doReadBytes(byteBuf));
            // å°† byteBuf æ²¿ç€ pipeline å‘åä¼ æ’­
            pipeline.fireChannelRead(byteBuf);

            ....... çœç•¥ .......
        }
}
</code></pre></div><p>é™¤æ­¤ä¹‹å¤–ï¼ŒNetty è¿˜æä¾›äº† <code>ChannelOption.ALLOCATOR</code> é€‰é¡¹ï¼Œè®©æˆ‘ä»¬å¯ä»¥åœ¨é…ç½® ServerBootstrap çš„æ—¶å€™ä¸º SocketChannel çµæ´»æŒ‡å®šè‡ªå®šä¹‰çš„ ByteBufAllocator ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>        EventLoopGroup bossGroup = new NioEventLoopGroup(1);
        EventLoopGroup workerGroup = new NioEventLoopGroup();

        ServerBootstrap b = new ServerBootstrap();
        b.group(bossGroup, workerGroup)
            // çµæ´»é…ç½® ByteBufAllocator
          .childOption(ChannelOption.ALLOCATOR, UnpooledByteBufAllocator.DEFAULT;);
</code></pre></div><p>è¿™é‡Œé€šè¿‡ ChannelOption æ¥é…ç½® Socket ç›¸å…³çš„å±æ€§æ˜¯æœ€é«˜ä¼˜å…ˆçº§çš„ï¼Œå®ƒä¼šè¦†ç›–æ‰ä¸€åˆ‡é»˜è®¤é…ç½®ã€‚</p> <h2 id="_7-metric"><a href="#_7-metric" class="header-anchor">#</a> <strong>7. Metric</strong></h2> <p>åœ¨ç¬¬å››å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº† Cleaner å’Œ NoCleaner è¿™ä¸¤ç§ DirectByteBufï¼Œå…¶ä¸­ CleanerDirectByteBuf  çš„æ•´ä½“ Direct Memory çš„ç”¨é‡æ˜¯å—åˆ° JVM å‚æ•° <code>-XX:MaxDirectMemorySize</code> é™åˆ¶çš„ï¼Œè€Œ NoCleanerDirectByteBuf çš„æ•´ä½“ Direct Memory  å¯ä»¥çªç ´è¯¥å‚æ•°çš„é™åˆ¶ï¼ŒJVM å¹¶ä¸ä¼šç»Ÿè®¡è¿™å— Direct Memory çš„ç”¨é‡ã€‚</p> <p>Netty ä¸ºäº†åŠæ—¶åœ°é‡Šæ”¾è¿™äº› Direct Memoryï¼Œé€šå¸¸é»˜è®¤é€‰æ‹© NoCleanerDirectByteBufï¼Œè¿™å°±è¦æ±‚ Netty éœ€è¦å¯¹è¿™éƒ¨åˆ† Direct Memory çš„ç”¨é‡è¿›è¡Œè‡ªè¡Œç»Ÿè®¡é™åˆ¶ã€‚NoCleanerDirectByteBuf çš„æœ€å¤§å¯ç”¨ Direct Memory æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>-Dio.netty.maxDirectMemory</code> æ¥æŒ‡å®šï¼Œé»˜è®¤æƒ…å†µä¸‹ç­‰äº <code>-XX:MaxDirectMemorySize</code> è®¾ç½®çš„å€¼ã€‚</p> <p>PlatformDependent ç±»ä¸­çš„ <code>DIRECT_MEMORY_COUNTER</code> å­—æ®µç”¨äºç»Ÿè®¡åœ¨ Netty å±‚é¢ä¸Šï¼Œæ‰€æœ‰ NoCleanerDirectByteBuf å ç”¨çš„ Direct Memory å¤§å°ã€‚æ³¨æ„è¿™é‡Œå¹¶ä¸ä¼šç»Ÿè®¡ CleanerDirectByteBuf çš„ Direct Memory å ç”¨ï¼Œè¿™éƒ¨åˆ†ç»Ÿè®¡ç”± JVM è´Ÿè´£ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public final class PlatformDependent { 
    // ç”¨äºç»Ÿè®¡ NoCleaner çš„ DirectByteBuf æ‰€å¼•ç”¨çš„ Native Memory å¤§å°
    private static final AtomicLong DIRECT_MEMORY_COUNTER;

    public static ByteBuffer allocateDirectNoCleaner(int capacity) {
        // å¢åŠ  Native Memory ç”¨é‡ç»Ÿè®¡
        incrementMemoryCounter(capacity);
        try {
            // åˆ†é… Native Memory
            // åˆå§‹åŒ– NoCleaner çš„ DirectByteBuffer
            return PlatformDependent0.allocateDirectNoCleaner(capacity);
        } catch (Throwable e) {
            decrementMemoryCounter(capacity);
            throwException(e);
            return null;
        }
    

    public static void freeDirectNoCleaner(ByteBuffer buffer) {
        int capacity = buffer.capacity();
        // é‡Šæ”¾ Native Memory
        PlatformDependent0.freeMemory(PlatformDependent0.directBufferAddress(buffer));
        // å‡å°‘ Native Memory ç”¨é‡ç»Ÿè®¡
        decrementMemoryCounter(capacity);
    }  
}
</code></pre></div><p>PlatformDependent ç±»æ˜¯ Netty æœ€åº•å±‚çš„ä¸€ä¸ªç±»ï¼Œæ‰€æœ‰å†…å­˜çš„åˆ†é…ï¼Œé‡Šæ”¾åŠ¨ä½œæœ€ç»ˆéƒ½æ˜¯åœ¨è¯¥ç±»ä¸­æ‰§è¡Œï¼Œå› æ­¤ DIRECT_MEMORY_COUNTER å­—æ®µç»Ÿè®¡çš„æ˜¯å…¨å±€çš„ Direct Memory å¤§å°ï¼ˆNetty å±‚é¢ï¼‰ã€‚</p> <p>æ¯ä¸€æ¬¡çš„å†…å­˜ç”³è¯· â€”â€” allocateDirectNoCleaner ï¼Œ éƒ½ä¼šå¢åŠ  DIRECT_MEMORY_COUNTER è®¡æ•°ï¼Œæ¯ä¸€æ¬¡çš„å†…å­˜é‡Šæ”¾ â€”â€” freeDirectNoCleanerï¼Œéƒ½ä¼šå‡å°‘ DIRECT_MEMORY_COUNTER è®¡æ•°ã€‚</p> <p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>PlatformDependent.usedDirectMemory()</code>æ–¹æ³•æ¥è·å– Netty å½“å‰æ‰€å ç”¨çš„ Direct Memory å¤§å°ã€‚ä½†å¦‚æœæˆ‘ä»¬ç‰¹æ®ŠæŒ‡å®šäº†éœ€è¦ä½¿ç”¨ CleanerDirectByteBuf ï¼Œ æ¯”å¦‚ï¼Œå°† <code>-Dio.netty.maxDirectMemory</code> å‚æ•°è®¾ç½®ä¸º <code>0</code> , é‚£ä¹ˆè¿™é‡Œå°†ä¼šè¿”å›  -1 ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private static void incrementMemoryCounter(int capacity) {
        // åªç»Ÿè®¡ NoCleaner çš„ DirectByteBuf æ‰€å¼•ç”¨çš„ Native Memory 
        if (DIRECT_MEMORY_COUNTER != null) {
            long newUsedMemory = DIRECT_MEMORY_COUNTER.addAndGet(capacity);
            if (newUsedMemory &gt; DIRECT_MEMORY_LIMIT) {
                DIRECT_MEMORY_COUNTER.addAndGet(-capacity);
                throw new OutOfDirectMemoryError(&quot;failed to allocate &quot; + capacity
                        + &quot; byte(s) of direct memory (used: &quot; + (newUsedMemory - capacity)
                        + &quot;, max: &quot; + DIRECT_MEMORY_LIMIT + ')');
            }
        }
    }

    private static void decrementMemoryCounter(int capacity) {
        if (DIRECT_MEMORY_COUNTER != null) {
            long usedMemory = DIRECT_MEMORY_COUNTER.addAndGet(-capacity);
            assert usedMemory &gt;= 0;
        }
    }

    public static long usedDirectMemory() {
        return DIRECT_MEMORY_COUNTER != null ? DIRECT_MEMORY_COUNTER.get() : -1;
    }
</code></pre></div><p>é™¤äº† PlatformDependent è¿™é‡Œçš„å…¨å±€ç»Ÿè®¡ä¹‹å¤–ï¼ŒNetty è¿˜æä¾›äº†ä»¥ ByteBufAllocator ä¸ºç²’åº¦çš„å†…å­˜å ç”¨ç»Ÿè®¡ï¼Œç»Ÿè®¡çš„ç»´åº¦åŒ…æ‹¬ Heap Memory çš„å ç”¨å’Œ Direct Memory çš„å ç”¨ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public final class UnpooledByteBufAllocator extends AbstractByteBufAllocator implements ByteBufAllocatorMetricProvider {
    // ä»è¯¥ ByteBufAllocator åˆ†é…å‡ºå»çš„å†…å­˜ç»Ÿè®¡
    private final UnpooledByteBufAllocatorMetric metric = new UnpooledByteBufAllocatorMetric();

    @Override
    public ByteBufAllocatorMetric metric() {
        return metric;
    }
    // ç»Ÿè®¡ Direct Memory çš„å ç”¨
    void incrementDirect(int amount) {
        metric.directCounter.add(amount);
    }

    void decrementDirect(int amount) {
        metric.directCounter.add(-amount);
    }
    // ç»Ÿè®¡ Heap Memory çš„å ç”¨
    void incrementHeap(int amount) {
        metric.heapCounter.add(amount);
    }

    void decrementHeap(int amount) {
        metric.heapCounter.add(-amount);
    }

}
</code></pre></div><p>Netty å®šä¹‰çš„æ¯ä¸€ä¸ª  ByteBufAllocator ä¸­ï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ª ByteBufAllocatorMetric ç±»å‹çš„å­—æ®µï¼Œè¯¥ç±»å®šä¹‰ä¸¤ä¸ªè®¡æ•°å­—æ®µï¼šdirectCounterï¼ŒheapCounterã€‚ åˆ†åˆ«ç”¨äºç»Ÿè®¡ Direct Memory  å’Œ Heap Memory çš„å ç”¨ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private static final class UnpooledByteBufAllocatorMetric implements ByteBufAllocatorMetric {
        final LongCounter directCounter = PlatformDependent.newLongCounter();
        final LongCounter heapCounter = PlatformDependent.newLongCounter();

        @Override
        public long usedHeapMemory() {
            return heapCounter.value();
        }

        @Override
        public long usedDirectMemory() {
            return directCounter.value();
        }

        @Override
        public String toString() {
            return StringUtil.simpleClassName(this) +
                    &quot;(usedHeapMemory: &quot; + usedHeapMemory() + &quot;; usedDirectMemory: &quot; + usedDirectMemory() + ')';
        }
    }
</code></pre></div><p>å› æ­¤ä»å†…å­˜å ç”¨ç»Ÿè®¡çš„è§’åº¦ä¸Šæ¥è¯´ï¼ŒNetty åˆä¼šå°†æ•´ä¸ª ByteBuf ä½“ç³»åˆ†ä¸º Instrumented å’Œ NoInstrumented ä¸¤å¤§ç±»ï¼Œå¸¦æœ‰ Instrumented å‰ç¼€çš„ ByteBuf ï¼Œæ— è®ºä½ æ˜¯ Heap or Direct ï¼Œ Cleaner or NoCleanerï¼ŒUnsafe or NoUnsafe ç±»å‹çš„ ByteBuf ï¼ŒNetty éƒ½ä¼šç»Ÿè®¡è¿™éƒ¨åˆ†å†…å­˜å ç”¨ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>    private static final class InstrumentedUnpooledUnsafeNoCleanerDirectByteBuf
            extends UnpooledUnsafeNoCleanerDirectByteBuf {
        InstrumentedUnpooledUnsafeNoCleanerDirectByteBuf(
                UnpooledByteBufAllocator alloc, int initialCapacity, int maxCapacity) {
            // æ„é€ æ™®é€šçš„ UnpooledUnsafeNoCleanerDirectByteBuf
            super(alloc, initialCapacity, maxCapacity);
        }
        
        // åˆ†é…ï¼Œé‡Šæ”¾ çš„æ—¶å€™æ›´æ–° Direct Memory 
        @Override
        protected ByteBuffer allocateDirect(int initialCapacity) {
            ByteBuffer buffer = super.allocateDirect(initialCapacity);
            ((UnpooledByteBufAllocator) alloc()).incrementDirect(buffer.capacity());
            return buffer;
        }

        @Override
        protected void freeDirect(ByteBuffer buffer) {
            int capacity = buffer.capacity();
            super.freeDirect(buffer);
            ((UnpooledByteBufAllocator) alloc()).decrementDirect(capacity);
        }
    }
    private static final class InstrumentedUnpooledUnsafeDirectByteBuf extends UnpooledUnsafeDirectByteBuf {
        InstrumentedUnpooledUnsafeDirectByteBuf(
                UnpooledByteBufAllocator alloc, int initialCapacity, int maxCapacity) {
            // æ„é€ æ™®é€šçš„ UnpooledUnsafeDirectByteBuf
            super(alloc, initialCapacity, maxCapacity);
        }

        // åˆ†é…ï¼Œé‡Šæ”¾ çš„æ—¶å€™æ›´æ–° Direct Memory 
        @Override
        protected ByteBuffer allocateDirect(int initialCapacity) {
            ByteBuffer buffer = super.allocateDirect(initialCapacity);
            ((UnpooledByteBufAllocator) alloc()).incrementDirect(buffer.capacity());
            return buffer;
        }

        @Override
        protected void freeDirect(ByteBuffer buffer) {
            int capacity = buffer.capacity();
            super.freeDirect(buffer);
            ((UnpooledByteBufAllocator) alloc()).decrementDirect(capacity);
        }
    }
</code></pre></div><h2 id="_8-bytebufallocator"><a href="#_8-bytebufallocator" class="header-anchor">#</a> <strong>8. ByteBufAllocator</strong></h2> <p>åœ¨ Netty ä¸­ï¼ŒByteBuf çš„åˆ›å»ºå¿…é¡»é€šè¿‡ ByteBufAllocator è¿›è¡Œï¼Œä¸èƒ½ç›´æ¥æ˜¾ç¤ºåœ°è°ƒç”¨ ByteBuf ç›¸å…³çš„æ„é€ å‡½æ•°è‡ªè¡Œåˆ›å»ºã€‚Netty å®šä¹‰äº†ä¸¤ç§ç±»å‹çš„ ByteBufAllocator  ï¼š</p> <ol><li>PooledByteBufAllocator è´Ÿè´£æ± åŒ– ByteBufï¼Œè¿™é‡Œæ­£æ˜¯ Netty å†…å­˜ç®¡ç†çš„æ ¸å¿ƒï¼Œåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œç¬”è€…ä¼šè¯¦ç»†çš„å’Œå¤§å®¶ä»‹ç»å®ƒã€‚</li> <li>UnpooledByteBufAllocator è´Ÿè´£åˆ†é…éæ± åŒ–çš„ ByteBufï¼Œåˆ›å»º ByteBuf çš„æ—¶å€™ä¸´æ—¶å‘ OS ç”³è¯· Native Memory ï¼Œä½¿ç”¨å®Œä¹‹åï¼Œéœ€è¦åŠæ—¶çš„æ‰‹åŠ¨è°ƒç”¨ release å°† Native Memory é‡Šæ”¾ç»™ OS ã€‚</li></ol> <p><code>-Dio.netty.allocator.type</code> å‚æ•°å¯ä»¥è®©æˆ‘ä»¬è‡ªè¡Œé€‰æ‹© ByteBufAllocator çš„ç±»å‹ï¼Œé»˜è®¤å€¼ä¸º <code>pooled</code>, Netty é»˜è®¤æ˜¯é‡‡ç”¨æ± åŒ–çš„æ–¹å¼æ¥ç®¡ç† ByteBuf ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public interface ByteBufAllocator {
    // é»˜è®¤ä¸º PooledByteBufAllocator
    ByteBufAllocator DEFAULT = ByteBufUtil.DEFAULT_ALLOCATOR;
}
</code></pre></div><p>é™¤äº†ä»¥ä¸Šä¸¤ç§å®˜æ–¹å®šä¹‰çš„ ByteBufAllocator ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æ ¹æ®è‡ªå·±å®é™…ä¸šåŠ¡åœºæ™¯æ¥è‡ªè¡Œå®šåˆ¶ ByteBufAllocator ï¼Œ ç„¶åé€šè¿‡ç¬¬å…­å°èŠ‚ä¸­ä»‹ç»çš„ <code>ChannelOption.ALLOCATOR</code> é€‰é¡¹ï¼Œå°† ByteBufAllocator çµæ´»æŒ‡å®šä¸ºæˆ‘ä»¬è‡ªè¡Œå®šåˆ¶çš„å®ç°ã€‚</p> <p>å¯¹äº UnpooledByteBuf æ¥è¯´ï¼ŒNetty è¿˜ä¸“é—¨æä¾›äº†ä¸€ä¸ªå·¥å…·ç±» <code>Unpooled</code>ï¼Œè¿™é‡Œå®šä¹‰å®ç°äº†å¾ˆå¤šé’ˆå¯¹ ByteBuf çš„å®ç”¨æ“ä½œï¼Œæ¯”å¦‚ï¼Œallocateï¼Œwrappedï¼Œcopied ç­‰ã€‚è¿™é‡Œç¬”è€…ä»¥ DirectByteBuf çš„åˆ›å»ºä¸ºä¾‹è¿›è¡Œè¯´æ˜ï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>public final class Unpooled {

    private static final ByteBufAllocator ALLOC = UnpooledByteBufAllocator.DEFAULT;

    public static ByteBuf directBuffer() {
        return ALLOC.directBuffer();
    }
}
</code></pre></div><p>Unpooled åº•å±‚ä¾èµ–äº† UnpooledByteBufAllocator ï¼Œ æ‰€æœ‰å¯¹ ByteBuf çš„åˆ›å»ºåŠ¨ä½œæœ€ç»ˆéƒ½ä¼šä»£ç†ç»™è¿™ä¸ª Allocator ã€‚åœ¨ DirectBuffer çš„åˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å‰é¢ä»‹ç»çš„æ‰€æœ‰ç±»å‹çš„ ByteBufã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>public final class UnpooledByteBufAllocator {
    @Override
    protected ByteBuf newDirectBuffer(int initialCapacity, int maxCapacity) {
        final ByteBuf buf;
        if (PlatformDependent.hasUnsafe()) {
            buf = noCleaner ? new InstrumentedUnpooledUnsafeNoCleanerDirectByteBuf(this, initialCapacity, maxCapacity) :
                    new InstrumentedUnpooledUnsafeDirectByteBuf(this, initialCapacity, maxCapacity);
        } else {
            buf = new InstrumentedUnpooledDirectByteBuf(this, initialCapacity, maxCapacity);
        }
        // æ˜¯å¦å¯åŠ¨å†…å­˜æ³„éœ²æ¢æµ‹ï¼Œå¦‚æœå¯åŠ¨åˆ™é¢å¤–ç”¨ LeakAwareByteBuf è¿›è¡ŒåŒ…è£…è¿”å›
        return disableLeakDetector ? buf : toLeakAwareBuffer(buf);
    }
}
</code></pre></div><ul><li>é¦–å…ˆ Netty åˆ›å»ºå‡ºæ¥çš„æ‰€æœ‰ ByteBuf éƒ½æ˜¯å¸¦æœ‰ Metric ç»Ÿè®¡çš„ï¼Œå…·ä½“çš„ ByteBuf ç±»å‹éƒ½ä¼šå¸¦æœ‰ Instrumented å‰ç¼€ã€‚</li> <li>å¦‚æœå½“å‰ JRE ç¯å¢ƒæ”¯æŒ Unsafe ï¼Œ é‚£ä¹ˆåç»­å°±ä¼šé€šè¿‡ Unsafe çš„æ–¹å¼æ¥å¯¹ ByteBuf è¿›è¡Œç›¸å…³æ“ä½œï¼ˆé»˜è®¤ï¼‰ï¼Œå…·ä½“çš„ ByteBuf ç±»å‹éƒ½ä¼šå¸¦æœ‰ Unsafe å‰ç¼€ã€‚</li> <li>å¦‚æœæˆ‘ä»¬æ˜ç¡®æŒ‡å®šäº† NoCleaner ç±»å‹çš„ DirectByteBufï¼ˆé»˜è®¤ï¼‰ï¼Œé‚£ä¹ˆåˆ›å»ºå‡ºæ¥çš„ ByteBuf ç±»å‹å°±ä¼šå¸¦æœ‰ NoCleaner å‰ç¼€ï¼Œç”±äºæ²¡æœ‰ Cleaner ï¼Œè¿™å°±è¦æ±‚æˆ‘ä»¬ä½¿ç”¨å®Œ ByteBuf çš„æ—¶å€™å¿…é¡»åŠæ—¶åœ°æ‰‹åŠ¨è¿›è¡Œé‡Šæ”¾ã€‚</li> <li>å¦‚æœæˆ‘ä»¬å¼€å¯äº†å†…å­˜æ³„éœ²æ¢æµ‹ï¼Œé‚£ä¹ˆåˆ›å»ºæµç¨‹çš„æœ€åï¼ŒNetty ä¼šç”¨ä¸€ä¸ª  LeakAwareByteBuf å»åŒ…è£…æ–°åˆ›å»ºå‡ºæ¥çš„ ByteBufï¼Œå½“è¿™ä¸ª ByteBuf è¢« GC çš„æ—¶å€™ï¼ŒNetty ä¼šé€šè¿‡ç›¸å…³å¼•ç”¨è®¡æ•°æ¥åˆ¤æ–­æ˜¯å¦å­˜åœ¨å¿˜è®° release çš„æƒ…å†µï¼Œä»è€Œç¡®å®šå‡ºæ˜¯å¦å‘ç”Ÿå†…å­˜æ³„éœ²ã€‚</li></ul> <h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="header-anchor">#</a> <strong>æ€»ç»“</strong></h2> <p>æœ¬æ–‡ç¬”è€…ä»å…«ä¸ªè§’åº¦ä¸ºå¤§å®¶è¯¦ç»†çš„å‰–æäº† ByteBuf çš„æ•´ä½“è®¾è®¡ï¼Œè¿™å…«ä¸ªè§’åº¦åˆ†åˆ«æ˜¯ï¼šå†…å­˜åŒºåŸŸåˆ†å¸ƒçš„è§’åº¦ï¼Œå†…å­˜ç®¡ç†çš„è§’åº¦ï¼Œå†…å­˜è®¿é—®çš„è§’åº¦ï¼Œå†…å­˜å›æ”¶çš„è§’åº¦ï¼Œå†…å­˜ç»Ÿè®¡ Metric çš„è§’åº¦ï¼Œé›¶æ‹·è´çš„è§’åº¦ï¼Œå¼•ç”¨è®¡æ•°çš„è§’åº¦ï¼Œæ‰©å®¹çš„è§’åº¦ã€‚</p> <p>åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œæˆ‘ä»¬åªæ˜¯æ‰«æ¸…äº† Netty å†…å­˜ç®¡ç†å¤–å›´çš„ä¸€äº›éšœç¢ï¼Œé‚£ä¹ˆä¸‹ä¸€ç¯‡æ–‡ç« ï¼Œç¬”è€…å°†å¸¦å¤§å®¶æ·±å…¥åˆ°å†…å­˜ç®¡ç†çš„æ ¸å¿ƒï¼Œå½»åº•è®©å¤§å®¶å¼„æ‡‚ Netty çš„å†…å­˜ç®¡ç†æœºåˆ¶ã€‚å¥½äº†ï¼Œæœ¬æ–‡çš„å†…å®¹å°±åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ä¸‹ç¯‡æ–‡ç« è§~~~</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/echo-lxy/echo-system-design/edit/master/docs/Netty ç³»ç»Ÿè®¾è®¡/30.äº”ã€æ·±å…¥ Netty å†…å­˜ç®¡ç†/05.ç¬¬ä¸€è¯¾ï¼šByteBuf ä½“ç³»çš„è®¾è®¡ä¸å®ç°.md" target="_blank" rel="noopener noreferrer">ç¼–è¾‘</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°äº:</span> <span class="time">2024/09/19, 03:26:41</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        â†
        <a href="/pages/566769/" class="prev">ç¬¬ä¸ƒè¯¾ï¼šè¯¦è§£ Netty ä¸­æ‰€æœ‰IOäº‹ä»¶çš„è§¦å‘æ—¶æœºå’Œä¼ æ’­æµç¨‹</a></span> <!----></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:lixinyang2002@163.com" title="å‘é‚®ä»¶" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/echo-lxy" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="å¬éŸ³ä¹" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="æœ¬ç«™ä¸»é¢˜">Vdoing</a> 
    | Copyright Â© 2024-2024
    <span>Xinyang Li | MIT License</span></div> <div class="buttons"><div title="è¿”å›é¡¶éƒ¨" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="å»è¯„è®º" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ä¸»é¢˜æ¨¡å¼" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          è·Ÿéšç³»ç»Ÿ
        </li><li class="iconfont icon-rijianmoshi">
          æµ…è‰²æ¨¡å¼
        </li><li class="iconfont icon-yejianmoshi">
          æ·±è‰²æ¨¡å¼
        </li><li class="iconfont icon-yuedu">
          é˜…è¯»æ¨¡å¼
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.9445bb42.js" defer></script><script src="/assets/js/2.933750c6.js" defer></script><script src="/assets/js/58.905475ec.js" defer></script><script src="/assets/js/7.7eb70372.js" defer></script>
  </body>
</html>
