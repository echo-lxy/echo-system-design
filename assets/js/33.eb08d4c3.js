(window.webpackJsonp=window.webpackJsonp||[]).push([[33],{365:function(_,v,t){"use strict";t.r(v);var s=t(4),r=Object(s.a)({},(function(){var _=this,v=_._self._c;return v("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[v("h2",{attrs:{id:"前言"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[_._v("#")]),_._v(" 前言")]),_._v(" "),v("p",[_._v("秒杀系统的架构图")]),_._v(" "),v("p",[v("img",{attrs:{src:"https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409142027114.jpeg",alt:"img"}})]),_._v(" "),v("h2",{attrs:{id:"秒杀会有哪些问题"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#秒杀会有哪些问题"}},[_._v("#")]),_._v(" 秒杀会有哪些问题")]),_._v(" "),v("p",[v("strong",[_._v("高并发")])]),_._v(" "),v("p",[_._v("是的高并发这个是我们想都不用想的一个点，一瞬间这么多人进来这不是高并发什么时候是呢？")]),_._v(" "),v("p",[_._v("是吧，秒杀的特点就是这样"),v("strong",[_._v("时间极短、 瞬间用户量大")]),_._v("。")]),_._v(" "),v("p",[_._v("正常的店铺营销都是用极低的价格配合上短信、APP的精准推送，吸引特别多的用户来参与这场秒杀，爽了商家苦了开发呀。")]),_._v(" "),v("p",[_._v("秒杀大家都知道如果真的营销到位，价格诱人，几十万的流量我觉得完全不是问题，那单机的Redis我感觉3-4W的QPS还是能顶得住的，但是再高了就没办法了，那这个数据随便搞个热销商品的秒杀可能都不止了。")]),_._v(" "),v("p",[_._v("大量的请求进来，我们需要考虑的点就很多了，"),v("strong",[_._v("缓存雪崩，缓存击穿，缓存穿透")]),_._v("这些我之前提到的点都是有可能发生的，出现问题打挂DB那就很难受了，活动失败用户体验差，活动人气没了，最后背锅的还是开发")]),_._v(" "),v("p",[v("strong",[_._v("超卖")])]),_._v(" "),v("p",[_._v("但凡是个秒杀，都怕超卖，如果卖的是尿不湿还好，要是换成100个MacBook Pro，商家的预算经费卖100个可以赚点还可以造势，结果你写错程序多卖出去200个，你不发货用户投诉你，平台封你店，你发货就血亏，你怎么办？")]),_._v(" "),v("p",[_._v("那最后只能杀个开发祭天解气了，秒杀的价格本来就低了，基本上都是不怎么赚钱的，超卖了就恐怖了呀，所以超卖也是很关键的一个点。")]),_._v(" "),v("p",[v("strong",[_._v("恶意请求")])]),_._v(" "),v("p",[_._v("你这么低的价格，假如我抢到了，我转手卖掉我不是血赚？就算我不卖我也不亏啊，那用户知道，你知道，别的别有用心的人（黑客、黄牛…）肯定也知道的。")]),_._v(" "),v("p",[_._v("那简单啊，我知道你什么时候抢，我搞个几十台机器搞点脚本，我也模拟出来十几万个人左右的请求，那我是不是意味着我基本上有80%的成功率了。")]),_._v(" "),v("p",[_._v("真实情况可能远远不止，因为机器请求的速度比人的手速往往快太多了，在贵州的敖丙我每年回家抢高铁票都是秒光的，我也不知道有没有黄牛的功劳，我要Diss你，黄牛。杰伦演唱会门票抢不到，我也Diss你。")]),_._v(" "),v("p",[_._v("Tip：科普下，小道消息了解到的，黄牛的抢票系统，比国内很多小公司的系统还吊很多，架构设计都是顶级的，我用顶配的服务加上顶配的架构设计，你还想看演唱会？还想回家？")]),_._v(" "),v("p",[_._v("不过不用黄牛我回家都难，我们云贵川跟我一样要回家过年的仔太多了555！")]),_._v(" "),v("p",[v("strong",[_._v("链接暴露")])]),_._v(" "),v("p",[_._v("前面几个问题大家可能都很好理解，一看到这个有的小伙伴可能会比较疑惑，啥是"),v("strong",[_._v("链接暴露")]),_._v("呀？")]),_._v(" "),v("p",[_._v("相信是个开发同学都对这个画面一点都不陌生吧，懂点行的仔都可以打开谷歌的开发者模式，然后看看你的网页代码，有的就有URL，但是我写VUE的时候是事件触发然后去调用文件里面的接口看源码看不到，但是我可以点击一下查看你的请求地址啊，不过你好像可以对按钮在秒杀前置灰。")]),_._v(" "),v("p",[_._v("不管怎么样子都有危险，撇开外面的所有的东西你都挡住了，你卖这个东西实在便宜得过分，有诱惑力，你能保证开发不动心？开发知道地址，在秒杀的时候自己提前请求。。。（开发：怎么TM又是我）")]),_._v(" "),v("p",[v("strong",[_._v("数据库")])]),_._v(" "),v("p",[_._v("每秒上万甚至十几万的QPS（每秒请求数）直接打到数据库，基本上都要把库打挂掉，而且你服务不单单是做秒杀的还涉及其他的业务，你没做降级、限流、熔断啥的，别的一起挂，小公司的话可能全站崩溃404。")]),_._v(" "),v("p",[_._v("反正不管你秒杀怎么挂，你别把别的搞挂了对吧，搞挂了就不是杀一个程序员能搞定的。")]),_._v(" "),v("p",[_._v("程序员：我TM好难啊！")]),_._v(" "),v("p",[_._v("问题都列出来了，那怎么设计，怎么解决这些问题就是接下去要考虑的了，我们对症下药。")]),_._v(" "),v("p",[_._v("我会从我设计的秒杀系统从上到下去给大家介绍我们正常电商秒杀系统在每一层做了些什么，每一层存在的问题，难点等。")]),_._v(" "),v("h2",{attrs:{id:"解决方案"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#解决方案"}},[_._v("#")]),_._v(" 解决方案")]),_._v(" "),v("h3",{attrs:{id:"前端"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#前端"}},[_._v("#")]),_._v(" 前端")]),_._v(" "),v("p",[_._v("秒杀系统普遍都是商城网页、H5、APP、小程序这几项。")]),_._v(" "),v("p",[_._v("在前端这一层其实我们可以做的事情有很多，如果用node去做，甚至能直接处理掉整个秒杀，但是node其实应该属于后端，所以我不讨论node Service了。")]),_._v(" "),v("p",[v("strong",[_._v("资源静态化")])]),_._v(" "),v("p",[_._v("秒杀一般都是特定的商品还有页面模板，现在一般都是前后端分离的，页面一般都是不会经过后端的，但是前端也要自己的服务器啊，那就把能提前放入cdn服务器的东西都放进去，反正把所有能提升效率的步骤都做一下，减少真正秒杀时候服务器的压力。")]),_._v(" "),v("p",[v("strong",[_._v("秒杀链接加盐")])]),_._v(" "),v("p",[_._v("我们上面说了链接要是提前暴露出去可能有人直接访问url就提前秒杀了，那又有小伙伴要说了我做个时间的校验就好了呀，那我告诉你，知道链接的地址比起页面人工点击的还是有很大优势。")]),_._v(" "),v("p",[_._v("我知道url了，那我通过程序不断获取最新的北京时间，可以达到毫秒级别的，我就在00毫秒的时候请求，我敢说绝对比你人工点的成功率大太多了，而且我可以一毫秒发送N次请求，搞不好你卖100个产品我全拿了。")]),_._v(" "),v("p",[v("strong",[_._v("那这种情况怎么避免？"),v("strong",[_._v("把")]),_._v("URL动态化")]),_._v("，就连写代码的人都不知道，你就通过MD5之类的摘要算法加密随机的字符串去做url，然后通过前端代码获取url后台校验才能通过。")]),_._v(" "),v("p",[_._v("这个只能防止一部分没耐心继续破解下去的黑客，有耐心的人研究出来还是能破解，在电商场景存在很多这样的羊毛党，那怎么做呢？后面我会说。")]),_._v(" "),v("p",[v("strong",[_._v("限流")])]),_._v(" "),v("p",[_._v("限流这里我觉得应该分为"),v("strong",[_._v("前端限流")]),_._v("和"),v("strong",[_._v("后端限流")]),_._v("。")]),_._v(" "),v("p",[v("strong",[_._v("物理控制")])]),_._v(" "),v("p",[_._v("大家有没有发现没到秒杀前，一般按钮都是置灰的，只有时间到了，才能点击。")]),_._v(" "),v("p",[_._v("这是因为怕大家在时间快到的最后几秒秒疯狂请求服务器，然后还没到秒杀的时候基本上服务器就挂了。")]),_._v(" "),v("p",[_._v("这个时候就需要前端的配合，定时去请求你的后端服务器，获取最新的北京时间，到时间点再给按钮可用状态。")]),_._v(" "),v("p",[_._v("按钮可以点击之后也得给他置灰几秒，不然他一样在开始之后一直点的。")]),_._v(" "),v("p",[_._v("你敢说你们秒杀的时候不是这样的？")]),_._v(" "),v("p",[v("strong",[_._v("前端限流")]),_._v("：这个很简单，一般秒杀不会让你一直点的，一般都是点击一下或者两下然后几秒之后才可以继续点击，这也是保护服务器的一种手段。")]),_._v(" "),v("p",[v("strong",[_._v("后端限流")]),_._v("：秒杀的时候肯定是涉及到后续的订单生成和支付等操作，但是都只是成功的幸运儿才会走到那一步，那一旦100个产品卖光了，return了一个false，前端直接秒杀结束，然后你后端也关闭后续无效请求的介入了。")]),_._v(" "),v("p",[_._v("Tip：真正的限流还会有限流组件的加入例如：阿里的Sentinel、Hystrix等。我这里就不展开了，就说一下物理的限流。")]),_._v(" "),v("p",[_._v("我们卖1000件商品，请求有10W，我们不需要把十万都放进来，你可以放1W请求进来，然后再进行操作，因为秒杀对于用户本身就是黑盒的，所以你怎么做的他们是没感知的，至于为啥放1W进来，而不是刚好1000，是因为会丢掉一些薅羊毛的用户，至于怎么判断，后面的风控阶段我会说。")]),_._v(" "),v("h3",{attrs:{id:"nginx"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#nginx"}},[_._v("#")]),_._v(" Nginx")]),_._v(" "),v("p",[_._v("Nginx大家想必都不陌生了吧，这玩意是高性能的web服务器，并发也随便顶几万不是梦，但是我们的Tomcat只能顶几百的并发呀，那简单呀负载均衡嘛，一台服务几百，那就多搞点，在秒杀的时候多租点流量机。")]),_._v(" "),v("p",[_._v("Tip：据我所知国内某大厂就是在去年春节活动期间租光了亚洲所有的服务器，小公司也很喜欢在双十一期间买流量机来顶住压力。")]),_._v(" "),v("p",[v("strong",[_._v("恶意请求拦截")]),_._v("也需要用到它，一般单个用户请求次数太夸张，不像人为的请求在网关那一层就得拦截掉了，不然请求多了他抢不抢得到是一回事，服务器压力上去了，可能占用网络带宽或者把"),v("strong",[_._v("服务器打崩、缓存击穿")]),_._v("等等")]),_._v(" "),v("h3",{attrs:{id:"风控"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#风控"}},[_._v("#")]),_._v(" 风控")]),_._v(" "),v("p",[_._v("我可以明确的告诉大家，前面的所有措施还是拦不住很多羊毛党，因为他们是专业的团队，他们可以注册很多账号来薅你的羊毛，而且不用机器请求，就用群控，操作几乎跟真实用户一模一样。")]),_._v(" "),v("p",[_._v("那怎么办，是不是无解了？")]),_._v(" "),v("p",[_._v("这个时候就需要风控同学的介入了，在请求到达后端之前，风控可以根据账号行为分析出这个账号机器人的概率大不大，我现在负责公司的某些特殊系统，每个用户的行为都是会送到我们大数据团队进行分析处理，给你打上对应标签的。")]),_._v(" "),v("p",[_._v("那黑客其实也有办法：养号")]),_._v(" "),v("p",[_._v("他们去黑市买真实用户有过很多记录的账号，买到了还不闲着，帮他们去购物啥的，让系统无法识别他们是黑号还是真实用户的号。")]),_._v(" "),v("p",[v("strong",[_._v("怎么办？")])]),_._v(" "),v("p",[_._v("通杀！是的没有办法，只能通杀了，通杀的意思就是，我们通过风管分析出来这个用户是真实用户的概率没有其他用户概率大，那就认为他是机器了，丢弃他的请求。")]),_._v(" "),v("p",[_._v("之前的限流我们放进来10000个请求，但是我们真正的库存只有1000个，那我们就算出最有可能是真实用户的1000人进行秒杀，丢弃其他请求，因为秒杀本来就是黑盒操作的，用户层面是无感知的，这样设计能让真实的用户买到东西，还可以减少自己被薅羊毛的概率。")]),_._v(" "),v("p",[_._v("风控可以说是流量进入的最后一道门槛了，所以很多公司的风控是很强的，蚂蚁金服的风控大家如果了解过就知道了，你的资金在支付宝被盗了，他们是能做到全款补偿是有原因的。")]),_._v(" "),v("h3",{attrs:{id:"后端"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#后端"}},[_._v("#")]),_._v(" 后端")]),_._v(" "),v("p",[v("strong",[_._v("服务单一职责")])]),_._v(" "),v("p",[_._v("设计个能抗住高并发的系统，我觉得还是得单一职责。")]),_._v(" "),v("p",[_._v("什么意思呢，大家都知道现在设计都是微服务的设计思想，然后再用分布式的部署方式。")]),_._v(" "),v("p",[_._v("也就是我们下单是有个订单服务，用户登录管理等有个用户服务等等，那为啥我们不给秒杀也开个服务，我们把秒杀的代码业务逻辑放一起。")]),_._v(" "),v("p",[_._v("单一职责的好处就是就算秒杀没抗住，秒杀库崩了，服务挂了，也不会影响到其他的服务。（高可用）")]),_._v(" "),v("p",[v("strong",[_._v("Redis 集群")])]),_._v(" "),v("p",[_._v("之前不是说单机的"),v("strong",[_._v("Redis")]),_._v("顶不住嘛，那简单多找几个兄弟啊，秒杀本来就是读多写少，那你们是不是瞬间想起来我之前跟你们提到过的，"),v("strong",[_._v("Redis集群")]),_._v("，"),v("strong",[_._v("主从同步")]),_._v("、"),v("strong",[_._v("读写分离")]),_._v("，我们还搞点"),v("strong",[_._v("哨兵")]),_._v("，开启"),v("strong",[_._v("持久化")]),_._v("直接无敌高可用！")]),_._v(" "),v("p",[v("strong",[_._v("库存预热")])]),_._v(" "),v("p",[v("strong",[_._v("秒杀的本质，就是对库存的抢夺")]),_._v("，每个秒杀的用户来你都去数据库查询库存校验库存，然后扣减库存，撇开性能因数，你不觉得这样好繁琐，对业务开发人员都不友好，而且数据库顶不住啊。")]),_._v(" "),v("p",[_._v("我们都知道数据库顶不住但是他的兄弟非关系型的数据库Redis能顶啊！")]),_._v(" "),v("p",[_._v("那不简单了，我们要开始秒杀前你通过定时任务或者运维同学提前把商品的库存加载到Redis中去，让整个流程都在Redis里面去做，然后等秒杀介绍了，再异步的去修改库存就好了。")]),_._v(" "),v("p",[_._v("但是用了Redis就有一个问题了，我们上面说了我们采用主从，就是我们会去读取库存然后再判断然后有库存才去减库存，正常情况没问题，但是高并发的情况问题就很大了。")]),_._v(" "),v("p",[_._v("**多品几遍！！！**就比如现在库存只剩下1个了，我们高并发嘛，4个服务器一起查询了发现都是还有1个，那大家都觉得是自己抢到了，就都去扣库存，那结果就变成了-3，是的只有一个是真的抢到了，别的都是超卖的。咋办？")]),_._v(" "),v("p",[v("strong",[_._v("事务")])]),_._v(" "),v("p",[_._v("Redis本身是支持事务的，而且他有很多原子命令的，大家也可以用LUA，还可以用他的管道，乐观锁他也知支持。")]),_._v(" "),v("p",[v("strong",[_._v("限流&降级&熔断&隔离")])]),_._v(" "),v("p",[_._v("这个为啥要做呢，不怕一万就怕万一，万一你真的顶不住了，"),v("strong",[_._v("限流")]),_._v("，顶不住就挡一部分出去但是不能说不行，"),v("strong",[_._v("降级")]),_._v("，降级了还是被打挂了，"),v("strong",[_._v("熔断")]),_._v("，至少不要影响别的系统，"),v("strong",[_._v("隔离")]),_._v("，你本身就独立的，但是你会调用其他的系统嘛，你快不行了你别拖累兄弟们啊。")]),_._v(" "),v("p",[v("strong",[_._v("消息队列（削峰填谷）")])]),_._v(" "),v("p",[_._v("一说到这个名词，很多小伙伴就知道了，对的"),v("strong",[_._v("MQ")]),_._v("，你买东西少了你直接100个请求改库我觉得没问题，但是万一秒杀一万个，10万个呢？服务器挂了，"),v("strong",[_._v("程序员又要背锅的")]),_._v("。")]),_._v(" "),v("p",[_._v("秒杀就是这种瞬间流量很高，但是平时又没有流量的场景，那消息队列完全契合这样的场景了呀，削峰填谷。")]),_._v(" "),v("p",[v("img",{attrs:{src:"https://echo798.oss-cn-shenzhen.aliyuncs.com/img/202409142039116.png",alt:"img"}})]),_._v(" "),v("p",[_._v("Tip："),v("strong",[_._v("可能小伙伴说我们业务达不到这个量级，没必要。但是我想说我们写代码，就不应该写出有逻辑漏洞的代码，至少以后公司体量上去了，别人一看居然不用改代码，一看代码作者是xxx？有点东西！")])]),_._v(" "),v("p",[_._v("你可以把它放消息队列，然后一点点消费去改库存就好了嘛，不过单个商品其实一次修改就够了，我这里说的是"),v("strong",[_._v("某个点多个商品")]),_._v("一起秒杀的场景，像极了双十一零点。")]),_._v(" "),v("h3",{attrs:{id:"数据库"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#数据库"}},[_._v("#")]),_._v(" 数据库")]),_._v(" "),v("p",[_._v("数据库用MySQL只要连接池设置合理一般问题是不大的，不过一般大公司不缺钱而且秒杀这样的活动十分频繁，我之前所在的公司就是这样秒杀特卖这样的场景一直都是不间断的。")]),_._v(" "),v("p",[_._v("单独给秒杀建立一个数据库，为秒杀服务，表的设计也是竟可能的简单点，现在的互联网架构部署都是"),v("strong",[_._v("分库")]),_._v("的。")]),_._v(" "),v("p",[_._v("至于表就看大家怎么设计了，该设置索引的地方还是要设置索引的，建完后记得用"),v("strong",[_._v("explain")]),_._v("看看"),v("strong",[_._v("SQL")]),_._v("的执行计划。（不了解的小伙伴也没事，MySQL章节去康康）")]),_._v(" "),v("h3",{attrs:{id:"分布式事务"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#分布式事务"}},[_._v("#")]),_._v(" 分布式事务")]),_._v(" "),v("p",[v("strong",[_._v("这为啥我不放在后端而放到最后来讲呢？")])]),_._v(" "),v("p",[_._v("因为上面的任何一步都是可能出错的，而且我们是在不同的服务里面出错的，那就涉及分布式事务了，但是分布式事务大家想的是一定要成功什么的那就不对了，还是那句话，几个请求丢了就丢了，要保证时效和服务的可用可靠。")]),_._v(" "),v("p",[_._v("所以TCC和最终一致性其实不是很适合，TCC开发成本很大，所有接口都要写三次，因为涉及TCC的三个阶段。")]),_._v(" "),v("p",[_._v("最终一致性基本上都是靠轮训的操作去保证一个操作一定成功，那时效性就大打折扣了。")]),_._v(" "),v("p",[_._v("大家觉得不那么可靠的**两段式（2PC）和三段式（3PC）**就派上用场了，他们不一定能保证数据最终一致，但是效率上还算ok。")]),_._v(" "),v("h3",{attrs:{id:"总结"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[_._v("#")]),_._v(" 总结")]),_._v(" "),v("p",[_._v("到这里我想我已经基本上把该考虑的点还有对应的解决方案也都说了一下，不知道还有没有没考虑到的，但是就算没考虑到我想我这个设计，应该也能撑住一个完整的秒杀流程。")]),_._v(" "),v("p",[_._v("最后大家再看看这个秒杀系统或许会有新的感悟，是不是一个系统真的没有大家想的那么简单，而且我还是有漏掉的细节，这是一定的。")]),_._v(" "),v("h2",{attrs:{id:"参考文献"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#参考文献"}},[_._v("#")]),_._v(" 参考文献")]),_._v(" "),v("p",[v("a",{attrs:{href:"https://blog.csdn.net/qq_35190492/article/details/107833096",target:"_blank",rel:"noopener noreferrer"}},[_._v("面试了十个应届生九个都是秒杀系统，你确定你们那是秒杀？_小公司的qps只有几十-CSDN博客"),v("OutboundLink")],1)])])}),[],!1,null,null,null);v.default=r.exports}}]);